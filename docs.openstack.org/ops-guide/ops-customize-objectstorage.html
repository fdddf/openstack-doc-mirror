<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Customizing Object Storage (Swift) Middleware</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="_static/css/font-awesome.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">
<link href="_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/security/">Security</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/telecoms-and-nfv/">Telecoms and NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers & ISVs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/coa/">Get Certified</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//ask.openstack.org">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/analysts/">Analyst Reports</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
      <h2>Customizing Object Storage (Swift) Middleware</h2>
    
  </div>
  <div class="docs-actions">
    
    <a href="ops-customize-development.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Create an OpenStack Development Environment"></i></a>
    
    
    <a href="ops-customize-compute.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Customizing the OpenStack Compute (nova) Scheduler"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2017-02-14 13:54</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="index.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Customizing Object Storage (Swift) Middleware</a></li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="customizing-object-storage-swift-middleware">
<h1>Customizing Object Storage (Swift) Middleware<a class="headerlink" href="#customizing-object-storage-swift-middleware" title="Permalink to this headline">¶</a></h1>
<p>OpenStack Object Storage, known as swift when reading the code, is based
on the Python <a class="reference external" href="http://pythonpaste.org/">Paste</a> framework. The best
introduction to its architecture is <a class="reference external" href="http://pythonpaste.org/do-it-yourself-framework.html">A Do-It-Yourself
Framework</a>.
Because of the swift project&#8217;s use of this framework, you are able to
add features to a project by placing some custom code in a project&#8217;s
pipeline without having to change any of the core code.</p>
<p>Imagine a scenario where you have public access to one of your
containers, but what you really want is to restrict access to that to a
set of IPs based on a whitelist. In this example, we&#8217;ll create a piece
of middleware for swift that allows access to a container from only a
set of IP addresses, as determined by the container&#8217;s metadata items.
Only those IP addresses that you explicitly whitelist using the
container&#8217;s metadata will be able to access the container.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This example is for illustrative purposes only. It should not be
used as a container IP whitelist solution without further
development and extensive security testing.</p>
</div>
<p>When you join the screen session that <code class="docutils literal"><span class="pre">stack.sh</span></code> starts with
<code class="docutils literal"><span class="pre">screen</span> <span class="pre">-r</span> <span class="pre">stack</span></code>, you see a screen for each service running, which
can be a few or several, depending on how many services you configured
DevStack to run.</p>
<p>The asterisk * indicates which screen window you are viewing. This
example shows we are viewing the key (for keystone) screen window:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">0$ shell  1$ key*  2$ horizon  3$ s-proxy  4$ s-object  5$ s-container  6$ s-account</span>
</pre></div>
</div>
<p>The purpose of the screen windows are as follows:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">shell</span></code></dt>
<dd>A shell where you can get some work done</dd>
<dt><code class="docutils literal"><span class="pre">key*</span></code></dt>
<dd>The keystone service</dd>
<dt><code class="docutils literal"><span class="pre">horizon</span></code></dt>
<dd>The horizon dashboard web application</dd>
<dt><code class="docutils literal"><span class="pre">s-{name}</span></code></dt>
<dd>The swift services</dd>
</dl>
<p><strong>To create the middleware and plug it in through Paste configuration:</strong></p>
<p>All of the code for OpenStack lives in <code class="docutils literal"><span class="pre">/opt/stack</span></code>. Go to the swift
directory in the <code class="docutils literal"><span class="pre">shell</span></code> screen and edit your middleware module.</p>
<ol class="arabic">
<li><p class="first">Change to the directory where Object Storage is installed:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /opt/stack/swift
</pre></div>
</div>
</li>
<li><p class="first">Create the <code class="docutils literal"><span class="pre">ip_whitelist.py</span></code> Python source code file:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> vim swift/common/middleware/ip_whitelist.py
</pre></div>
</div>
</li>
<li><p class="first">Copy the code as shown below into <code class="docutils literal"><span class="pre">ip_whitelist.py</span></code>.
The following code is a middleware example that
restricts access to a container based on IP address as explained at the
beginning of the section. Middleware passes the request on to another
application. This example uses the swift &#8220;swob&#8221; library to wrap Web
Server Gateway Interface (WSGI) requests and responses into objects for
swift to interact with. When you&#8217;re done, save and close the file.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># vim: tabstop=4 shiftwidth=4 softtabstop=4</span>
<span class="c1"># Copyright (c) 2014 OpenStack Foundation</span>
<span class="c1"># All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">swift.common.utils</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">swift.proxy.controllers.base</span> <span class="kn">import</span> <span class="n">get_container_info</span>
<span class="kn">from</span> <span class="nn">swift.common.swob</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">IPWhitelistMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    IP Whitelist Middleware</span>

<span class="sd">    Middleware that allows access to a container from only a set of IP</span>
<span class="sd">    addresses as determined by the container&#39;s metadata items that start</span>
<span class="sd">    with the prefix &#39;allow&#39;. E.G. allow-dev=192.168.0.20</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">log_route</span><span class="o">=</span><span class="s1">&#39;ip_whitelist&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deny_message</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deny_message&#39;</span><span class="p">,</span> <span class="s2">&quot;IP Denied&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WSGI entry point.</span>
<span class="sd">        Wraps env in swob.Request object and passes it down.</span>

<span class="sd">        :param env: WSGI environment dictionary</span>
<span class="sd">        :param start_response: WSGI callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">split_path</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="n">container_info</span> <span class="o">=</span> <span class="n">get_container_info</span><span class="p">(</span>
            <span class="n">req</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">swift_source</span><span class="o">=</span><span class="s1">&#39;IPWhitelistMiddleware&#39;</span><span class="p">)</span>

        <span class="n">remote_ip</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Remote IP: </span><span class="si">%(remote_ip)s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;remote_ip&#39;</span><span class="p">:</span> <span class="n">remote_ip</span><span class="p">})</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">container_info</span><span class="p">[</span><span class="s1">&#39;meta&#39;</span><span class="p">]</span>
        <span class="n">allow</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;allow&#39;</span><span class="p">)}</span>
        <span class="n">allow_ips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">allow</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">allow_ips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Allow IPs: </span><span class="si">%(allow_ips)s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="p">{</span><span class="s1">&#39;allow_ips&#39;</span><span class="p">:</span> <span class="n">allow_ips</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">remote_ip</span> <span class="ow">in</span> <span class="n">allow_ips</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;IP </span><span class="si">%(remote_ip)s</span><span class="s2"> denied access to Account=</span><span class="si">%(account)s</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;Container=</span><span class="si">%(container)s</span><span class="s2">. Not in </span><span class="si">%(allow_ips)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="n">status</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deny_message</span><span class="p">,</span>
                <span class="n">request</span><span class="o">=</span><span class="n">req</span><span class="p">)(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_factory</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="o">**</span><span class="n">local_conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    paste.deploy app factory for creating WSGI proxy apps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">global_conf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_conf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ip_whitelist</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IPWhitelistMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ip_whitelist</span>
</pre></div>
</div>
<p>There is a lot of useful information in <code class="docutils literal"><span class="pre">env</span></code> and <code class="docutils literal"><span class="pre">conf</span></code> that you
can use to decide what to do with the request. To find out more about
what properties are available, you can insert the following log
statement into the <code class="docutils literal"><span class="pre">__init__</span></code> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;conf = </span><span class="si">%(conf)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
</pre></div>
</div>
<p>and the following log statement into the <code class="docutils literal"><span class="pre">__call__</span></code> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;env = </span><span class="si">%(env)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>
</pre></div>
</div>
</li>
<li><p class="first">To plug this middleware into the swift Paste pipeline, you edit one
configuration file, <code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> vim /etc/swift/proxy-server.conf
</pre></div>
</div>
</li>
<li><p class="first">Find the <code class="docutils literal"><span class="pre">[filter:ratelimit]</span></code> section in
<code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code>, and copy in the following
configuration section after it:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[filter:ip_whitelist]</span>
<span class="na">paste.filter_factory</span> <span class="o">=</span> <span class="s">swift.common.middleware.ip_whitelist:filter_factory</span>
<span class="c1"># You can override the default log routing for this filter here:</span>
<span class="c1"># set log_name = ratelimit</span>
<span class="c1"># set log_facility = LOG_LOCAL0</span>
<span class="c1"># set log_level = INFO</span>
<span class="c1"># set log_headers = False</span>
<span class="c1"># set log_address = /dev/log</span>
<span class="na">deny_message</span> <span class="o">=</span> <span class="s">You shall not pass!</span>
</pre></div>
</div>
</li>
<li><p class="first">Find the <code class="docutils literal"><span class="pre">[pipeline:main]</span></code> section in
<code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code>, and add <code class="docutils literal"><span class="pre">ip_whitelist</span></code> after
ratelimit to the list like so. When you&#8217;re done, save and close the
file:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[pipeline:main]</span>
<span class="na">pipeline</span> <span class="o">=</span> <span class="s">catch_errors gatekeeper healthcheck proxy-logging cache bulk tempurl ratelimit ip_whitelist ...</span>
</pre></div>
</div>
</li>
<li><p class="first">Restart the <code class="docutils literal"><span class="pre">swift</span> <span class="pre">proxy</span></code> service to make swift use your middleware.
Start by switching to the <code class="docutils literal"><span class="pre">swift-proxy</span></code> screen:</p>
<ol class="arabic simple">
<li>Press <strong>Ctrl+A</strong> followed by <strong>3</strong>.</li>
<li>Press <strong>Ctrl+C</strong> to kill the service.</li>
<li>Press <strong>Up Arrow</strong> to bring up the last command.</li>
<li>Press Enter to run it.</li>
</ol>
</li>
<li><p class="first">Test your middleware with the <code class="docutils literal"><span class="pre">swift</span></code> CLI.&nbsp;Start by switching to the
shell screen and finish by switching back to the <code class="docutils literal"><span class="pre">swift-proxy</span></code> screen
to check the log output:</p>
<ol class="arabic">
<li><p class="first">Press&nbsp; <strong>Ctrl+A</strong> followed by <strong>0</strong>.</p>
</li>
<li><p class="first">Make sure you&#8217;re in the <code class="docutils literal"><span class="pre">devstack</span></code> directory:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /root/devstack
</pre></div>
</div>
</li>
<li><p class="first">Source openrc to set up your environment variables for the CLI:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> . openrc
</pre></div>
</div>
</li>
<li><p class="first">Create a container called <code class="docutils literal"><span class="pre">middleware-test</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> swift post middleware-test
</pre></div>
</div>
</li>
<li><p class="first">Press <strong>Ctrl+A</strong> followed by <strong>3</strong> to check the log output.</p>
</li>
</ol>
</li>
<li><p class="first">Among the log statements you&#8217;ll see the lines:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>proxy-server Remote IP: my.instance.ip.address (txn: ...)
proxy-server Allow IPs: set([&#39;my.instance.ip.address&#39;]) (txn: ...)
</pre></div>
</div>
<p>These two statements are produced by our middleware and show that the
request was sent from our DevStack instance and was allowed.</p>
</li>
<li><p class="first">Test the middleware from outside DevStack on a remote machine that has
access to your DevStack instance:</p>
<ol class="arabic">
<li><p class="first">Install the <code class="docutils literal"><span class="pre">keystone</span></code> and <code class="docutils literal"><span class="pre">swift</span></code> clients on your local machine:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> pip install python-keystoneclient python-swiftclient
</pre></div>
</div>
</li>
<li><p class="first">Attempt to list the objects in the <code class="docutils literal"><span class="pre">middleware-test</span></code> container:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> swift --os-auth-url<span class="o">=</span>http://my.instance.ip.address:5000/v2.0/ <span class="se">\</span>
  --os-region-name<span class="o">=</span>RegionOne --os-username<span class="o">=</span>demo:demo <span class="se">\</span>
  --os-password<span class="o">=</span>devstack list middleware-test
<span class="go">Container GET failed: http://my.instance.ip.address:8080/v1/AUTH_.../</span>
<span class="go">    middleware-test?format=json 403 Forbidden   You shall not pass!</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Press <strong>Ctrl+A</strong> followed by <strong>3</strong> to check the log output. Look at the
swift log statements again, and among the log statements, you&#8217;ll see the
lines:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">proxy-server Authorizing from an overriding middleware (i.e: tempurl) (txn: ...)</span>
<span class="go">proxy-server ... IPWhitelistMiddleware</span>
<span class="go">proxy-server Remote IP: my.local.ip.address (txn: ...)</span>
<span class="go">proxy-server Allow IPs: set([&#39;my.instance.ip.address&#39;]) (txn: ...)</span>
<span class="go">proxy-server IP my.local.ip.address denied access to Account=AUTH_... \</span>
<span class="go">   Container=None. Not in set([&#39;my.instance.ip.address&#39;]) (txn: ...)</span>
</pre></div>
</div>
<p>Here we can see that the request was denied because the remote IP
address wasn&#8217;t in the set of allowed IPs.</p>
</li>
<li><p class="first">Back in your DevStack instance on the shell screen, add some metadata to
your container to allow the request from the remote machine:</p>
<ol class="arabic">
<li><p class="first">Press <strong>Ctrl+A</strong> followed by <strong>0</strong>.</p>
</li>
<li><p class="first">Add metadata to the container to allow the IP:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> swift post --meta allow-dev:my.local.ip.address middleware-test
</pre></div>
</div>
</li>
<li><p class="first">Now try the command from Step 10 again and it succeeds. There are no
objects in the container, so there is nothing to list; however, there is
also no error to report.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Functional testing like this is not a replacement for proper unit
and integration testing, but it serves to get you started.</p>
</div>
</li>
</ol>
</li>
</ol>
<p>You can follow a similar pattern in other projects that use the Python
Paste framework. Simply create a middleware module and plug it in
through configuration. The middleware runs in sequence as part of that
project&#8217;s pipeline and can call out to other services as necessary. No
project core code is touched. Look for a <code class="docutils literal"><span class="pre">pipeline</span></code> value in the
project&#8217;s <code class="docutils literal"><span class="pre">conf</span></code> or <code class="docutils literal"><span class="pre">ini</span></code> configuration files in <code class="docutils literal"><span class="pre">/etc/&lt;project&gt;</span></code>
to identify projects that use Paste.</p>
<p>When your middleware is done, we encourage you to open source it and let
the community know on the OpenStack mailing list. Perhaps others need
the same functionality. They can use your code, provide feedback, and
possibly contribute. If enough support exists for it, perhaps you can
propose that it be added to the official swift
<a class="reference external" href="https://git.openstack.org/cgit/openstack/swift/tree/swift/common/middleware">middleware</a>.</p>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="ops-customize-development.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Create an OpenStack Development Environment"></i></a>
          
          
            <a href="ops-customize-compute.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Customizing the OpenStack Compute (nova) Scheduler"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2017-02-14 13:54</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="operations.html">Operations</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ops-lay-of-the-land.html">Lay of the Land</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-projects-users.html">Managing Projects and Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-user-facing-operations.html">User-Facing Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-maintenance.html">Maintenance, Failures, and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-network-troubleshooting.html">Network Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-logging-monitoring.html">Logging and Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-backup-recovery.html">Backup and Recovery</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="ops-customize.html">Customization</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-advanced-configuration.html">Advanced Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ops-upgrades.html">Upgrades</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="app-usecases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-crypt.html">Tales From the Cryp^H^H^H^H Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-roadmaps.html">Working with Roadmaps</a></li>
<li class="toctree-l1"><a class="reference internal" href="app-resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/app-support.html">Community support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-1.12.4.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "ops-customize-objectstorage" + ".rst";
        gitURL = "Source: https://git.openstack.org/cgit/openstack/openstack-manuals/tree/doc/ops-guide/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 3993c81360ea23a2e599faf5f3de0d288b10c20a";
        var bugProject = "openstack-manuals";
        var bugTitle = "Customizing Object Storage (Swift) Middleware in Operations Guide";
    var fieldTags = "ops-guide";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.0.1 on 2017-02-14 13:54";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>
</html>