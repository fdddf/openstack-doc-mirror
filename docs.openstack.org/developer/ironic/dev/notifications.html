<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Developing New Notifications &mdash; Ironic 6.3.0.dev823 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/toggle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.3.0.dev823',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/toggle.js"></script>
    <link rel="top" title="Ironic 6.3.0.dev823 documentation" href="../index.html" />
    <link rel="next" title="Releasing Ironic Projects" href="releasing.html" />
    <link rel="prev" title="Ironic’s State Machine" href="states.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="developing-new-notifications">
<span id="develop-notifications"></span><h1>Developing New Notifications<a class="headerlink" href="#developing-new-notifications" title="Permalink to this headline">¶</a></h1>
<p>Ironic notifications are events intended for consumption by external services.
Notifications are sent to these services over a message bus by
oslo.messaging&#8217;s Notifier class <a class="footnote-reference" href="#id3" id="id1">[1]</a>. For more information about configuring
notifications and available notifications, see <a class="reference internal" href="../deploy/notifications.html#deploy-notifications"><span>Notifications</span></a>.</p>
<p>Ironic also has a set of base classes that assist in clearly defining the
notification itself, the payload, and the other fields not auto-generated by
oslo (level, event_type and publisher_id). Below describes how to use these
base classes to add a new notification to ironic.</p>
<div class="section" id="adding-a-new-notification-to-ironic">
<h2>Adding a new notification to ironic<a class="headerlink" href="#adding-a-new-notification-to-ironic" title="Permalink to this headline">¶</a></h2>
<p>To add a new notification to ironic, a new versioned notification class should
be created by subclassing the NotificationBase class to define the notification
itself and the NotificationPayloadBase class to define which fields the new
notification will contain inside its payload. You may also define a schema to
allow the payload to be automatically populated by the fields of an ironic
object. Here&#8217;s an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># The ironic object whose fields you want to use in your schema</span>
<span class="nd">@base.IronicObjectRegistry.register</span>
<span class="k">class</span> <span class="nc">ExampleObject</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">IronicObject</span><span class="p">):</span>
    <span class="c1"># Version 1.0: Initial version</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(),</span>
        <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(),</span>
        <span class="s1">&#39;a_useful_field&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">(),</span>
        <span class="s1">&#39;not_useful_field&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># A class for your new notification</span>
<span class="nd">@base.IronicObjectRegistry.register</span>
<span class="k">class</span> <span class="nc">ExampleNotification</span><span class="p">(</span><span class="n">notification</span><span class="o">.</span><span class="n">NotificationBase</span><span class="p">):</span>
    <span class="c1"># Version 1.0: Initial version</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">ObjectField</span><span class="p">(</span><span class="s1">&#39;ExampleNotifPayload&#39;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># A class for your notification&#39;s payload</span>
<span class="nd">@base.IronicObjectRegistry.register</span>
<span class="k">class</span> <span class="nc">ExampleNotifPayload</span><span class="p">(</span><span class="n">notification</span><span class="o">.</span><span class="n">NotificationPayloadBase</span><span class="p">):</span>
    <span class="c1"># Schemas are optional. They just allow you to reuse other objects&#39;</span>
    <span class="c1"># fields by passing in that object and calling populate_schema with</span>
    <span class="c1"># a kwarg set to the other object.</span>
    <span class="n">SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a_useful_field&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;example_obj&#39;</span><span class="p">,</span> <span class="s1">&#39;a_useful_field&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Version 1.0: Initial version</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a_useful_field&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">(),</span>
        <span class="s1">&#39;an_extra_field&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>Note that both the payload and notification classes are oslo versioned
objects <a class="footnote-reference" href="#id4" id="id2">[2]</a>. Modifications to these require a version bump so that consumers
of notifications know when the notifications have changed.</p>
<p>SCHEMA defines how to populate the payload fields. It&#8217;s an optional
attribute that subclasses may use to easily populate notifications with
data from other objects.</p>
<p>It is a dictionary where every key value pair has the following format:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;payload_field_name&gt;: (&lt;data_source_name&gt;,
                       &lt;field_of_the_data_source&gt;)
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">&lt;payload_field_name&gt;</span></code> is the name where the data will be stored in the
payload object; this field has to be defined as a field of the payload.
The <code class="docutils literal"><span class="pre">&lt;data_source_name&gt;</span></code> shall refer to name of the parameter passed as
kwarg to the payload&#8217;s <code class="docutils literal"><span class="pre">populate_schema()</span></code> call and this object will be
used as the source of the data. The <code class="docutils literal"><span class="pre">&lt;field_of_the_data_source&gt;</span></code> shall be
a valid field of the passed argument.</p>
<p>The SCHEMA needs to be applied with the <code class="docutils literal"><span class="pre">populate_schema()</span></code> call before the
notification can be emitted.</p>
<p>The value of the <code class="docutils literal"><span class="pre">payload.&lt;payload_field_name&gt;</span></code> field will be set by the
<code class="docutils literal"><span class="pre">&lt;data_source_name&gt;.&lt;field_of_the_data_source&gt;</span></code> field. The
<code class="docutils literal"><span class="pre">&lt;data_source_name&gt;</span></code> will not be part of the payload object internal or
external representation.</p>
<p>Payload fields that are not set by the SCHEMA can be filled in the same
way as in any versioned object.</p>
<p>Then, to create a payload, you would do something like the following. Note
that if you choose to define a schema in the SCHEMA class variable, you must
populate the schema by calling <code class="docutils literal"><span class="pre">populate_schema(example_obj=my_example_obj)</span></code>
before emitting the notification is allowed:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">my_example_obj</span> <span class="o">=</span> <span class="n">ExampleObject</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">a_useful_field</span><span class="o">=</span><span class="s1">&#39;important&#39;</span><span class="p">,</span>
                               <span class="n">not_useful_field</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span>

<span class="c1"># an_extra_field is optional since it&#39;s not a part of the SCHEMA and is a</span>
<span class="c1"># nullable field in the class fields</span>
<span class="n">my_notify_payload</span> <span class="o">=</span> <span class="n">ExampleNotifyPayload</span><span class="p">(</span><span class="n">an_extra_field</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="c1"># populate the schema with the ExampleObject fields</span>
<span class="n">my_notify_payload</span><span class="o">.</span><span class="n">populate_schema</span><span class="p">(</span><span class="n">example_obj</span><span class="o">=</span><span class="n">my_example_obj</span><span class="p">)</span>
</pre></div>
</div>
<p>You then create the notification with the oslo required fields (event_type,
publisher_id, and level, all sender fields needed by oslo that are defined
in the ironic notification base classes) and emit it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">notify</span> <span class="o">=</span> <span class="n">ExampleNotification</span><span class="p">(</span>
    <span class="n">event_type</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">EventType</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="s1">&#39;example_obj&#39;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;do_something&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
    <span class="n">publisher</span><span class="o">=</span><span class="n">notification</span><span class="o">.</span><span class="n">NotificationPublisher</span><span class="p">(</span>
        <span class="n">service</span><span class="o">=</span><span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;hostname01&#39;</span><span class="p">),</span>
    <span class="n">level</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="n">my_notify_payload</span><span class="p">)</span>
<span class="n">notify</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>When specifying the event_type, <code class="docutils literal"><span class="pre">object</span></code> will specify the object being acted
on, <code class="docutils literal"><span class="pre">action</span></code> will be a string describing what action is being performed on
that object, and <code class="docutils literal"><span class="pre">status</span></code> will be one of &#8220;start&#8221;, &#8220;end&#8221;, &#8220;error&#8221;, or
&#8220;success&#8221;. &#8220;start&#8221; and &#8220;end&#8221; are used to indicate when actions that are not
immediate begin and succeed. &#8220;success&#8221; is used to indicate when actions that
are immediate succeed. &#8220;error&#8221; is used to indicate when any type of action
fails, regardless of whether it&#8217;s immediate or not. As a result of specifying
these parameters, event_type will be formatted as
<code class="docutils literal"><span class="pre">baremetal.&lt;object&gt;.&lt;action&gt;.&lt;status&gt;</span></code> on the message bus.</p>
<p>This example will send the following notification over the message bus:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
    <span class="s2">&quot;payload&quot;</span><span class="p">:{</span>
        <span class="s2">&quot;ironic_object.namespace&quot;</span><span class="p">:</span><span class="s2">&quot;ironic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ironic_object.name&quot;</span><span class="p">:</span><span class="s2">&quot;ExampleNotifyPayload&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ironic_object.version&quot;</span><span class="p">:</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ironic_object.data&quot;</span><span class="p">:{</span>
             <span class="s2">&quot;a_useful_field&quot;</span><span class="p">:</span><span class="s2">&quot;important&quot;</span><span class="p">,</span>
             <span class="s2">&quot;an_extra_field&quot;</span><span class="p">:</span><span class="s2">&quot;hello&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;event_type&quot;</span><span class="p">:</span><span class="s2">&quot;baremetal.example_obj.do_something.start&quot;</span><span class="p">,</span>
    <span class="s2">&quot;publisher_id&quot;</span><span class="p">:</span><span class="s2">&quot;ironic-conductor.hostname01&quot;</span>
 <span class="p">}</span>
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://docs.openstack.org/developer/oslo.messaging/notifier.html">http://docs.openstack.org/developer/oslo.messaging/notifier.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://docs.openstack.org/developer/oslo.versionedobjects">http://docs.openstack.org/developer/oslo.versionedobjects</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Developing New Notifications</a><ul>
<li><a class="reference internal" href="#adding-a-new-notification-to-ironic">Adding a new notification to ironic</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="states.html"
                                  title="previous chapter">Ironic&#8217;s State Machine</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="releasing.html"
                                  title="next chapter">Releasing Ironic Projects</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/ironic
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/dev/notifications.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="releasing.html" title="Releasing Ironic Projects"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="states.html" title="Ironic’s State Machine"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Ironic 6.3.0.dev823 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/Ironic");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>