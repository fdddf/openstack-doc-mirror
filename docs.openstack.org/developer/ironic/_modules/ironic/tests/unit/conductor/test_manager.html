<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ironic.tests.unit.conductor.test_manager &mdash; Ironic 7.0.1.dev7 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/toggle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '7.0.1.dev7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/toggle.js"></script>
    <link rel="top" title="Ironic 7.0.1.dev7 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ironic.tests.unit.conductor.test_manager</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding=utf-8</span>

<span class="c1"># Copyright 2013 Hewlett-Packard Development Company, L.P.</span>
<span class="c1"># Copyright 2013 International Business Machines Corporation</span>
<span class="c1"># All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="sd">&quot;&quot;&quot;Test class for Ironic ManagerService.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">eventlet</span>
<span class="kn">import</span> <span class="nn">mock</span>
<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">import</span> <span class="nn">oslo_messaging</span> <span class="kn">as</span> <span class="nn">messaging</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">from</span> <span class="nn">oslo_versionedobjects</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">ovo_base</span>
<span class="kn">from</span> <span class="nn">oslo_versionedobjects</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">queue</span>

<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">boot_devices</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">driver_factory</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">images</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">swift</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">manager</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">notification_utils</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">task_manager</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">conductor_utils</span>
<span class="kn">from</span> <span class="nn">ironic.db</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">dbapi</span>
<span class="kn">from</span> <span class="nn">ironic.drivers</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">drivers_base</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules</span> <span class="kn">import</span> <span class="n">fake</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules.network</span> <span class="kn">import</span> <span class="n">flat</span> <span class="k">as</span> <span class="n">n_flat</span>
<span class="kn">from</span> <span class="nn">ironic</span> <span class="kn">import</span> <span class="n">objects</span>
<span class="kn">from</span> <span class="nn">ironic.objects</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">obj_base</span>
<span class="kn">from</span> <span class="nn">ironic.objects</span> <span class="kn">import</span> <span class="n">fields</span> <span class="k">as</span> <span class="n">obj_fields</span>
<span class="kn">from</span> <span class="nn">ironic.tests</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">tests_base</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.conductor</span> <span class="kn">import</span> <span class="n">mgr_utils</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.db</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">tests_db_base</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.db</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.objects</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">obj_utils</span>

<span class="n">CONF</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase">[docs]</a><span class="k">class</span> <span class="nc">ChangeNodePowerStateTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                   <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_power_on"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_power_on">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_power_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state including integration with</span>
        <span class="c1"># conductor.utils.node_power_action and lower.</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;get_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_power_mock</span><span class="p">:</span>
            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                 <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify the reservation has been cleared by</span>
            <span class="c1"># background task&#39;s link callback.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_soft_power_off_timeout"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_soft_power_off_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_soft_power_off_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state with timeout optional parameter</span>
        <span class="c1"># including integration with conductor.utils.node_power_action and</span>
        <span class="c1"># lower.</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s2">&quot;fake_soft_power&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver_factory</span><span class="o">.</span><span class="n">get_driver</span><span class="p">(</span><span class="s2">&quot;fake_soft_power&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_soft_power&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;get_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_power_mock</span><span class="p">:</span>
            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                 <span class="n">states</span><span class="o">.</span><span class="n">SOFT_POWER_OFF</span><span class="p">,</span>
                                                 <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify the reservation has been cleared by</span>
            <span class="c1"># background task&#39;s link callback.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">conductor_utils</span><span class="p">,</span> <span class="s1">&#39;node_power_action&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_node_already_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_node_already_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_node_already_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                         <span class="n">pwr_act_mock</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state with mocked</span>
        <span class="c1"># conductor.utils.node_power_action.</span>
        <span class="n">fake_reservation</span> <span class="o">=</span> <span class="s1">&#39;fake-reserv&#39;</span>
        <span class="n">pwr_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">pwr_state</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="n">fake_reservation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># In this test worker should not be spawned, but waiting to make sure</span>
        <span class="c1"># the below perform_mock assertion is valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">pwr_act_mock</span><span class="o">.</span><span class="n">called</span><span class="p">,</span> <span class="s1">&#39;node_power_action has been &#39;</span>
                                              <span class="s1">&#39;unexpectedly called.&#39;</span><span class="p">)</span>
        <span class="c1"># Verify existing reservation wasn&#39;t broken.</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_reservation</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state including integration with</span>
        <span class="c1"># conductor.utils.node_power_action and lower.</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
                               <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spawn_mock</span><span class="p">:</span>
            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                               <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify the picked reservation has been cleared due to full pool.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_exception_in_background_task"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_exception_in_background_task">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_exception_in_background_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state including integration with</span>
        <span class="c1"># conductor.utils.node_power_action and lower.</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;get_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_power_mock</span><span class="p">:</span>
            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>

            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                                   <span class="s1">&#39;set_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">set_power_mock</span><span class="p">:</span>
                <span class="n">new_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>
                <span class="n">set_power_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">PowerStateFailure</span><span class="p">(</span>
                    <span class="n">pstate</span><span class="o">=</span><span class="n">new_state</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                     <span class="n">new_state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

                <span class="n">get_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
                <span class="n">set_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">new_state</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">initial_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
                <span class="c1"># Verify the reservation has been cleared by background task&#39;s</span>
                <span class="c1"># link callback despite exception in background task.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state where task.driver.power.validate</span>
        <span class="c1"># fails and raises an exception</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">validate_mock</span><span class="p">:</span>
            <span class="n">validate_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span>
                <span class="s1">&#39;wrong power driver info&#39;</span><span class="p">)</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="n">validate_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeSetPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_node_set_power_state_notif_success"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_node_set_power_state_notif_success">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_set_power_state_notif_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">):</span>
        <span class="c1"># Test that successfully changing a node&#39;s power state sends the</span>
        <span class="c1"># correct .start and .end notifications</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">notification_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;my-host&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeSetPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="c1"># Give async worker a chance to finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># 2 notifications should be sent: 1 .start and 1 .end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="n">first_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">second_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">first_notif_args</span><span class="p">,</span>
                                     <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                     <span class="s1">&#39;baremetal.node.power_set.start&#39;</span><span class="p">,</span>
                                     <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">second_notif_args</span><span class="p">,</span>
                                     <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                     <span class="s1">&#39;baremetal.node.power_set.end&#39;</span><span class="p">,</span>
                                     <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeSetPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_node_set_power_state_notif_get_power_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_node_set_power_state_notif_get_power_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_set_power_state_notif_get_power_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">):</span>
        <span class="c1"># Test that correct notifications are sent when changing node power</span>
        <span class="c1"># state and retrieving the node&#39;s current power state fails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">notification_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;my-host&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeSetPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;get_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_power_mock</span><span class="p">:</span>
            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I have failed&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                 <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
            <span class="c1"># Give async worker a chance to finish</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

            <span class="n">get_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

            <span class="c1"># 2 notifications should be sent: 1 .start and 1 .error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

            <span class="n">first_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">second_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">first_notif_args</span><span class="p">,</span>
                                         <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                         <span class="s1">&#39;baremetal.node.power_set.start&#39;</span><span class="p">,</span>
                                         <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">second_notif_args</span><span class="p">,</span>
                                         <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                         <span class="s1">&#39;baremetal.node.power_set.error&#39;</span><span class="p">,</span>
                                         <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeSetPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_node_set_power_state_notif_set_power_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_node_set_power_state_notif_set_power_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_set_power_state_notif_set_power_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">):</span>
        <span class="c1"># Test that correct notifications are sent when changing node power</span>
        <span class="c1"># state and setting the node&#39;s power state fails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">notification_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;my-host&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeSetPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;set_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">set_power_mock</span><span class="p">:</span>
            <span class="n">set_power_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I have failed&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                 <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
            <span class="c1"># Give async worker a chance to finish</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

            <span class="n">set_power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>

            <span class="c1"># 2 notifications should be sent: 1 .start and 1 .error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

            <span class="n">first_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">second_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">first_notif_args</span><span class="p">,</span>
                                         <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                         <span class="s1">&#39;baremetal.node.power_set.start&#39;</span><span class="p">,</span>
                                         <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">second_notif_args</span><span class="p">,</span>
                                         <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                         <span class="s1">&#39;baremetal.node.power_set.error&#39;</span><span class="p">,</span>
                                         <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeSetPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_node_set_power_state_notif_spawn_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_node_set_power_state_notif_spawn_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_set_power_state_notif_spawn_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">):</span>
        <span class="c1"># Test that failure notification is not sent when spawning the</span>
        <span class="c1"># background conductor worker fails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">notification_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;my-host&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeSetPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
                               <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spawn_mock</span><span class="p">:</span>
            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                              <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                              <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>

            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">conductor_utils</span><span class="o">.</span><span class="n">node_power_action</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_notif</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeSetPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_node_set_power_state_notif_no_state_change"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_node_set_power_state_notif_no_state_change">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_set_power_state_notif_no_state_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">):</span>
        <span class="c1"># Test that correct notifications are sent when changing node power</span>
        <span class="c1"># state and no state change is necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">notification_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;my-host&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeSetPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
        <span class="c1"># Give async worker a chance to finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># 2 notifications should be sent: 1 .start and 1 .end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="n">first_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">second_notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">first_notif_args</span><span class="p">,</span>
                                     <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                     <span class="s1">&#39;baremetal.node.power_set.start&#39;</span><span class="p">,</span>
                                     <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span><span class="n">second_notif_args</span><span class="p">,</span>
                                     <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                     <span class="s1">&#39;baremetal.node.power_set.end&#39;</span><span class="p">,</span>
                                     <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChangeNodePowerStateTestCase.test_change_node_power_state_unsupported_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ChangeNodePowerStateTestCase.test_change_node_power_state_unsupported_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_node_power_state_unsupported_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test change_node_power_state where unsupported power state raises</span>
        <span class="c1"># an exception</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;get_supported_power_states&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">supported_mock</span><span class="p">:</span>
            <span class="n">supported_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">REBOOT</span><span class="p">]</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">states</span><span class="o">.</span><span class="n">SOFT_POWER_OFF</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="n">supported_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_power_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="CreateNodeTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.CreateNodeTestCase">[docs]</a><span class="k">class</span> <span class="nc">CreateNodeTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                         <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="CreateNodeTestCase.test_create_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.CreateNodeTestCase.test_create_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">})</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">},</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">},</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_factory</span><span class="p">,</span> <span class="s1">&#39;check_and_update_node_interfaces&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="CreateNodeTestCase.test_create_node_validation_fails"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.CreateNodeTestCase.test_create_node_validation_fails">[docs]</a>    <span class="k">def</span> <span class="nf">test_create_node_validation_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">})</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InterfaceNotFoundInEntrypoint</span><span class="p">(</span>
            <span class="s1">&#39;boom&#39;</span><span class="p">)</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">create_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InterfaceNotFoundInEntrypoint</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">,</span>
                          <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="UpdateNodeTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdateNodeTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                         <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">})</span>

        <span class="c1"># check that ManagerService.update_node actually updates the node</span>
        <span class="n">node</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;two&#39;</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;two&#39;</span><span class="p">},</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node_clears_maintenance_reason"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node_clears_maintenance_reason">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node_clears_maintenance_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                          <span class="n">maintenance_reason</span><span class="o">=</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span>

        <span class="c1"># check that ManagerService.update_node actually updates the node</span>
        <span class="n">node</span><span class="o">.</span><span class="n">maintenance</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;maintenance&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;maintenance_reason&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node_already_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node_already_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node_already_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">})</span>

        <span class="c1"># check that it fails if something else has locked it already</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;two&#39;</span><span class="p">}</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                    <span class="n">node</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># verify change did not happen</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">},</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;extra&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node_already_associated"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node_already_associated">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node_already_associated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_instance</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="n">old_instance</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">instance_uuid</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                <span class="n">node</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeAssociated</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># verify change did not happen</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_uuid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_instance</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;instance_uuid&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.get_power_state&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_associate_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power_state</span><span class="p">,</span> <span class="n">mock_get_power_state</span><span class="p">):</span>
        <span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">power_state</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="n">uuid1</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">uuid2</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">instance_uuid</span> <span class="o">=</span> <span class="n">uuid1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="c1"># Check if the change was applied</span>
        <span class="n">node</span><span class="o">.</span><span class="n">instance_uuid</span> <span class="o">=</span> <span class="n">uuid2</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">uuid1</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_uuid</span><span class="p">)</span>

<div class="viewcode-block" id="UpdateNodeTestCase.test_associate_node_powered_off"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_associate_node_powered_off">[docs]</a>    <span class="k">def</span> <span class="nf">test_associate_node_powered_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_associate_node</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_associate_node_powered_on"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_associate_node_powered_on">[docs]</a>    <span class="k">def</span> <span class="nf">test_associate_node_powered_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_associate_node</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node_invalid_driver"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node_invalid_driver">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node_invalid_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">existing_driver</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span>
        <span class="n">wrong_driver</span> <span class="o">=</span> <span class="s1">&#39;wrong-driver&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="n">existing_driver</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">},</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># check that it fails because driver not found</span>
        <span class="n">node</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">wrong_driver</span>
        <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">DriverNotFound</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># verify change did not happen</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">existing_driver</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_network_node_deleting_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_network_node_deleting_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_network_node_deleting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DELETING</span><span class="p">,</span>
                                          <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">)</span>
        <span class="n">old_iface</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span>
        <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_iface</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_network_node_manageable_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_network_node_manageable_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_network_node_manageable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
                                          <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;noop&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_network_node_active_state_and_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_network_node_active_state_and_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_network_node_active_state_and_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                                          <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span>
                                          <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;noop&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateNodeTestCase.test_update_node_invalid_network_interface"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateNodeTestCase.test_update_node_invalid_network_interface">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_node_invalid_network_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
                                          <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">)</span>
        <span class="n">old_iface</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span>
        <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span> <span class="o">=</span> <span class="s1">&#39;cosci&#39;</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InterfaceNotFoundInEntrypoint</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_iface</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="VendorPassthruTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase">[docs]</a><span class="k">class</span> <span class="nc">VendorPassthruTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                             <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;upgrade_lock&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;spawn_after&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_vendor_passthru_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">vendor_iface</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span>
                                    <span class="n">mock_upgrade</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                                          <span class="n">vendor_interface</span><span class="o">=</span><span class="n">vendor_iface</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                <span class="s1">&#39;second_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                                                <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Waiting to make sure the below assertions are valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># Assert spawn_after was called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_spawn</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">])</span>

        <span class="c1"># Assert lock was upgraded to an exclusive one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_upgrade</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_async"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_async">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_vendor_passthru_async</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_async_hw_type"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_async_hw_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_async_hw_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_vendor_passthru_async</span><span class="p">(</span><span class="s1">&#39;fake-hardware&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;upgrade_lock&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;spawn_after&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_sync"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_sync">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span> <span class="n">mock_upgrade</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;meow&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                <span class="s1">&#39;third_method_sync&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Waiting to make sure the below assertions are valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># Assert no workers were used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_spawn</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">])</span>

        <span class="c1"># Assert lock was upgraded to an exclusive one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mock_upgrade</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;upgrade_lock&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;spawn_after&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_shared_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_shared_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_shared_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span> <span class="n">mock_upgrade</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;woof&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                <span class="s1">&#39;fourth_method_shared_lock&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Waiting to make sure the below assertions are valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># Assert spawn_after was called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_spawn</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">])</span>

        <span class="c1"># Assert lock was never upgraded to an exclusive one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_upgrade</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify there&#39;s no reservation on the node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_http_method_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_http_method_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_http_method_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="c1"># GET not supported by first_method</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="s1">&#39;first_method&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_node_already_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_node_already_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_node_already_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fake_reservation</span> <span class="o">=</span> <span class="s1">&#39;test_reserv&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="n">fake_reservation</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;first_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify the existing reservation is not broken.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_reservation</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_unsupported_method"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_unsupported_method">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_unsupported_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="s1">&#39;unsupported_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_missing_method_parameters"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_missing_method_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_missing_method_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;invalid_param&#39;</span><span class="p">:</span> <span class="s1">&#39;whatever&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="s1">&#39;first_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_vendor_interface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_vendor_interface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_vendor_interface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="s1">&#39;whatever_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_vendor_passthru_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_vendor_passthru_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_vendor_passthru_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
                               <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spawn_mock</span><span class="p">:</span>
            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="s1">&#39;first_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Waiting to make sure the below assertions are valid.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify reservation has been cleared.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_get_node_vendor_passthru_methods"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_node_vendor_passthru_methods">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_node_vendor_passthru_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">fake_routes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                       <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span><span class="o">.</span><span class="n">vendor_routes</span> <span class="o">=</span> <span class="n">fake_routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_node_vendor_passthru_methods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                             <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># The function reference should not be returned</span>
        <span class="k">del</span> <span class="n">fake_routes</span><span class="p">[</span><span class="s1">&#39;test_method&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_routes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_get_node_vendor_passthru_methods_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_node_vendor_passthru_methods_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_node_vendor_passthru_methods_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_node_vendor_passthru_methods</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_factory</span><span class="p">,</span> <span class="s1">&#39;get_interface&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_driver_vendor_passthru_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_hw_type</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span>
                                          <span class="n">mock_get_if</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
        <span class="n">vendor_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">VendorInterface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hw_type</span><span class="p">:</span>
            <span class="n">mock_get_if</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">vendor_mock</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake-hardware&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">vendor_mock</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">vendor_mock</span><span class="o">.</span><span class="n">driver_routes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">test_method</span><span class="p">,</span>
                            <span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                            <span class="s1">&#39;attach&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                            <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">]}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="c1"># init_host() called _spawn_worker because of the heartbeat</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
        <span class="c1"># init_host() called get_interface during driver loading</span>
        <span class="n">mock_get_if</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

        <span class="n">vendor_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;arg&#39;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">vendor_args</span><span class="p">)</span>

        <span class="c1"># Assert that the vendor interface has no custom</span>
        <span class="c1"># driver_vendor_passthru()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">vendor_mock</span><span class="p">,</span> <span class="s1">&#39;driver_vendor_passthru&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">])</span>
        <span class="n">test_method</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">vendor_args</span><span class="p">)</span>
        <span class="c1"># No worker was spawned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_spawn</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hw_type</span><span class="p">:</span>
            <span class="n">mock_get_if</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;vendor&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_sync"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_sync">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_driver_vendor_passthru_sync</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_sync_hw_type"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_sync_hw_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_sync_hw_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_driver_vendor_passthru_sync</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_async"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_async">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">VendorInterface</span><span class="p">)</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span><span class="o">.</span><span class="n">driver_routes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test_sync_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">test_method</span><span class="p">,</span>
                                 <span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                 <span class="s1">&#39;attach&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                 <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">]}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="c1"># init_host() called _spawn_worker because of the heartbeat</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

        <span class="n">vendor_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;arg&#39;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="s1">&#39;test_sync_method&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">vendor_args</span><span class="p">)</span>

        <span class="c1"># Assert that the vendor interface has no custom</span>
        <span class="c1"># driver_vendor_passthru()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span><span class="p">,</span> <span class="s1">&#39;driver_vendor_passthru&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">])</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">test_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                           <span class="o">**</span><span class="n">vendor_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_http_method_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_http_method_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_http_method_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">VendorInterface</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span><span class="o">.</span><span class="n">driver_routes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(),</span>
                            <span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                            <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">]}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="c1"># GET not supported by test_method</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_vendor_interface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_vendor_interface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_vendor_interface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test for when no vendor interface is set at all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_method_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_method_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_method_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test for when the vendor interface is set, but hasn&#39;t passed a</span>
        <span class="c1"># driver_passthru_mapping to MixinVendorInterface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_driver_not_found"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_driver_not_found">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_driver_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;does_not_exist&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="p">{})</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_factory</span><span class="p">,</span> <span class="s1">&#39;default_interface&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_no_default_interface"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_no_default_interface">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_no_default_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                         <span class="n">mock_def_iface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="c1"># NOTE(rloo): service.init_host() will call</span>
        <span class="c1">#             driver_factory.default_interface() and we want these to</span>
        <span class="c1">#             succeed, so we set the side effect *after* that call.</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidDefaultForInterface</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake-hardware&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;vendor&#39;</span><span class="p">,</span>
                                               <span class="n">driver_name</span><span class="o">=</span><span class="s1">&#39;fake-hardware&#39;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoValidDefaultForInterface</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_factory</span><span class="p">,</span> <span class="s1">&#39;get_interface&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_get_driver_vendor_passthru_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_hw_type</span><span class="p">,</span>
                                                 <span class="n">mock_get_if</span><span class="p">):</span>
        <span class="n">vendor_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">VendorInterface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_hw_type</span><span class="p">:</span>
            <span class="n">mock_get_if</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">vendor_mock</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake-hardware&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">vendor_mock</span>
            <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span>
        <span class="n">fake_routes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                                       <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">],</span>
                                       <span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}}</span>
        <span class="n">vendor_mock</span><span class="o">.</span><span class="n">driver_routes</span> <span class="o">=</span> <span class="n">fake_routes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>

        <span class="c1"># init_host() will call get_interface</span>
        <span class="n">mock_get_if</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_vendor_passthru_methods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                               <span class="n">driver_name</span><span class="p">)</span>
        <span class="c1"># The function reference should not be returned</span>
        <span class="k">del</span> <span class="n">fake_routes</span><span class="p">[</span><span class="s1">&#39;test_method&#39;</span><span class="p">][</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_routes</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_hw_type</span><span class="p">:</span>
            <span class="n">mock_get_if</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;vendor&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mock_get_if</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>

<div class="viewcode-block" id="VendorPassthruTestCase.test_get_driver_vendor_passthru_methods"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_driver_vendor_passthru_methods">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_driver_vendor_passthru_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_get_driver_vendor_passthru_methods</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_hw_type"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_hw_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_driver_vendor_passthru_methods_hw_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_get_driver_vendor_passthru_methods</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_driver_vendor_passthru_methods_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_vendor_passthru_methods</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_factory</span><span class="p">,</span> <span class="s1">&#39;default_interface&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_no_default_interface"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_get_driver_vendor_passthru_methods_no_default_interface">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_driver_vendor_passthru_methods_no_default_interface</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">mock_def_iface</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="c1"># NOTE(rloo): service.init_host() will call</span>
        <span class="c1">#             driver_factory.default_interface() and we want these to</span>
        <span class="c1">#             succeed, so we set the side effect *after* that call.</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidDefaultForInterface</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_vendor_passthru_methods</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake-hardware&#39;</span><span class="p">)</span>
        <span class="n">mock_def_iface</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;vendor&#39;</span><span class="p">,</span>
                                               <span class="n">driver_name</span><span class="o">=</span><span class="s1">&#39;fake-hardware&#39;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoValidDefaultForInterface</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">VendorInterface</span><span class="p">,</span> <span class="s1">&#39;driver_validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="VendorPassthruTestCase.test_driver_vendor_passthru_validation_failed"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VendorPassthruTestCase.test_driver_vendor_passthru_validation_failed">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_vendor_passthru_validation_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validate_mock</span><span class="p">):</span>
        <span class="n">validate_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">vendor</span><span class="o">.</span><span class="n">driver_routes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;test_method&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">test_method</span><span class="p">,</span>
                            <span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                            <span class="s1">&#39;http_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">]}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">driver_vendor_passthru</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="s1">&#39;test_method&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">test_method</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase">[docs]</a><span class="k">class</span> <span class="nc">ServiceDoNodeDeployTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                  <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_invalid_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_invalid_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_invalid_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test that node deploy fails if the node is already provisioned</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># This is a sync operation last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeInMaintenance</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># This is a sync operation last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_iwdi</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_test_do_node_deploy_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># InvalidParameterValue should be re-raised as InstanceDeployFailure</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Check the message of InstanceDeployFailure. In a</span>
        <span class="c1"># messaging.rpc.ExpectedException sys.exc_info() is stored in exc_info</span>
        <span class="c1"># in the exception object. So InstanceDeployFailure will be in</span>
        <span class="c1"># exc_info[1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;node 1be26c0b-03f2-4d2e-ae87-c02d7f33c123&#39;</span><span class="p">,</span>
                      <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># This is a sync operation last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_do_node_deploy_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_power_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_power_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_power_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                                <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_do_node_deploy_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_partial_ok"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_partial_ok">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_partial_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_spawn</span><span class="p">:</span>
            <span class="n">mock_spawn</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">thread</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                              <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
            <span class="c1"># This is a sync operation last_error should be None.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify reservation has been cleared.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
            <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                               <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_active_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="c1"># This tests manager.do_node_deploy(), the &#39;else&#39; path of</span>
        <span class="c1"># &#39;if new_state == states.DEPLOYDONE&#39;. The node&#39;s states</span>
        <span class="c1"># aren&#39;t changed in this case.</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
                           <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="s1">&#39;aaaa&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">:</span> <span class="s1">&#39;bbbb&#39;</span><span class="p">},</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="c1"># Verify instance_info values has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="c1"># Verify is_whole_disk_image reflects correct value on rebuild.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state_waiting"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state_waiting">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_active_state_waiting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span>
                                                         <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state_done"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_active_state_done">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_active_state_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span>
                                                      <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_deployfail_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_deployfail_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_deployfail_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span>
                                                     <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_error_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_error_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_error_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_from_available_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_rebuild_from_available_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_rebuild_from_available_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test node will not rebuild if state is AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="n">rebuild</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ServiceDoNodeDeployTestCase.test_do_node_deploy_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ServiceDoNodeDeployTestCase.test_do_node_deploy_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_deploy_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_spawn</span><span class="p">:</span>
            <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="c1"># Make sure things were rolled back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># Verify reservation has been cleared.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
            <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase">[docs]</a><span class="k">class</span> <span class="nc">DoNodeDeployTearDownTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                   <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_driver_raises_prepare_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_driver_raises_prepare_error">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_driver_raises_prepare_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prepare</span><span class="p">,</span>
                                                         <span class="n">mock_deploy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.prepare raises an exception</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="c1"># NOTE(deva): failing a deploy does not clear the target state</span>
        <span class="c1">#             any longer. Instead, it is cleared when the instance</span>
        <span class="c1">#             is deleted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_prepare</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_deploy</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_driver_raises_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_driver_raises_error">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_driver_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.deploy raises an exception</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="c1"># NOTE(deva): failing a deploy does not clear the target state</span>
        <span class="c1">#             any longer. Instead, it is cleared when the instance</span>
        <span class="c1">#             is deleted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;_store_configdrive&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_ok"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_ok">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span> <span class="n">mock_store</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.deploy returns DEPLOYDONE</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="c1"># assert _store_configdrive wasn&#39;t invoked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_store</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;_store_configdrive&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_ok_configdrive"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_ok_configdrive">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_ok_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span> <span class="n">mock_store</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.deploy returns DEPLOYDONE</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">configdrive</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                               <span class="n">configdrive</span><span class="o">=</span><span class="n">configdrive</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_store</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">configdrive</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">swift</span><span class="p">,</span> <span class="s1">&#39;SwiftAPI&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_configdrive_swift_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_configdrive_swift_error">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_configdrive_swift_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">,</span>
                                                     <span class="n">mock_swift</span><span class="p">):</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;configdrive_use_swift&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.deploy returns DEPLOYDONE</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">mock_swift</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">SwiftOperationError</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">SwiftOperationError</span><span class="p">,</span>
                          <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                          <span class="n">configdrive</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;fake config drive&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_deploy</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.deploy&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_deploy_ok_2"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_deploy_ok_2">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_deploy_ok_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy</span><span class="p">):</span>
        <span class="c1"># NOTE(rloo): a different way of testing for the same thing as in</span>
        <span class="c1"># test__do_node_deploy_ok()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test when driver.deploy.deploy returns DEPLOYDONE</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">)</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_deploy</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.clean_up&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__check_deploy_timeouts"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__check_deploy_timeouts">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_cleanup</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;deploy_callback_timeout&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">provision_updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_cleanup</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_cleanwait_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;clean_callback_timeout&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">provision_updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;erase_devices&#39;</span><span class="p">},</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;cleaning_reboot&#39;</span><span class="p">:</span> <span class="n">manual</span><span class="p">,</span>
                <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_cleanwait_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Test that cleaning parameters have been purged in order</span>
        <span class="c1"># to prevent looping of the cleaning sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;cleaning_reboot&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__check_cleanwait_timeouts_automated_clean"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__check_cleanwait_timeouts_automated_clean">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_cleanwait_timeouts_automated_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cleanwait_timeouts</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__check_cleanwait_timeouts_manual_clean"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__check_cleanwait_timeouts_manual_clean">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_cleanwait_timeouts_manual_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_cleanwait_timeouts</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_node_tear_down_invalid_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_node_tear_down_invalid_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_tear_down_invalid_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># test node.provision_state is incorrect for tear_down</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_tear_down</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_node_tear_down_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_node_tear_down_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_tear_down_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="c1"># InvalidParameterValue should be re-raised as InstanceDeployFailure</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_tear_down</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.tear_down&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_node_tear_down_driver_raises_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_node_tear_down_driver_raises_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_tear_down_driver_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_tear_down</span><span class="p">):</span>
        <span class="c1"># test when driver.deploy.tear_down raises exception</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DELETING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_tear_down</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_tear_down</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Assert instance_info was erased</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="n">mock_tear_down</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._do_node_clean&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.tear_down&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_tear_down_ok"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_tear_down_ok">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_tear_down_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_tear_down</span><span class="p">,</span> <span class="n">mock_clean</span><span class="p">):</span>
        <span class="c1"># test when driver.deploy.tear_down succeeds</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DELETING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">instance_uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                                  <span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}})</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_tear_down</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to AVAILABLE after cleaning, not tested here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">instance_uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="n">mock_tear_down</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_clean</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._do_node_clean&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.tear_down&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_do_node_tear_down_from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">mock_tear_down</span><span class="p">,</span>
                                           <span class="n">mock_clean</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">init_state</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_tear_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to AVAILABLE after cleaning, not tested here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="n">mock_tear_down</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_clean</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_tear_down_from_valid_states"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_tear_down_from_valid_states">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_tear_down_from_valid_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">valid_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYFAIL</span><span class="p">,</span>
                        <span class="n">states</span><span class="o">.</span><span class="n">ERROR</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">valid_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_do_node_tear_down_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

    <span class="c1"># NOTE(deva): partial tear-down was broken. A node left in a state of</span>
    <span class="c1">#             DELETING could not have tear_down called on it a second time</span>
    <span class="c1">#             Thus, I have removed the unit test, which faultily asserted</span>
    <span class="c1">#             only that a node could be left in a state of incomplete</span>
    <span class="c1">#             deletion -- not that such a node&#39;s deletion could later be</span>
    <span class="c1">#             completed.</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_node_tear_down_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_node_tear_down_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_tear_down_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span>
        <span class="n">fake_instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">fake_instance_info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">,</span> <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_tear_down</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Assert instance_info/driver_internal_info was not touched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_instance_info</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">driver_internal_info</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="c1"># Make sure things were rolled back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provisioning_action_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provisioning_action_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provisioning_action_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;provide&#39;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Make sure things were rolled back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provision_action_provide"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provision_action_provide">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provision_action_provide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="c1"># test when a node is cleaned going from manageable to available</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;provide&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to AVAILABLE after cleaning, not tested here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provision_action_manage"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provision_action_manage">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provision_action_manage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="c1"># test when a node is verified going from enroll to manageable</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ENROLL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;manage&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to MANAGEABLE after verification, not tested here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">VERIFYING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_verify</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_provision_action_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;abort&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to tgt_prov_state after cleaning, not tested here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean_abort</span><span class="p">,</span>
                                      <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provision_action_abort_automated_clean"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provision_action_abort_automated_clean">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provision_action_abort_automated_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_provision_action_abort</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provision_action_abort_manual_clean"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provision_action_abort_manual_clean">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provision_action_abort_manual_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_provision_action_abort</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test_do_provision_action_abort_clean_step_not_abortable"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test_do_provision_action_abort_clean_step_not_abortable">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provision_action_abort_clean_step_not_abortable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;abortable&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;abort&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Assert the current clean step was marked to be aborted later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;abort_after&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">[</span><span class="s1">&#39;abort_after&#39;</span><span class="p">])</span>
        <span class="c1"># Make sure things stays as it was before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeDeploy</span><span class="p">,</span> <span class="s1">&#39;tear_down_cleaning&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test__do_node_clean_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">tear_mock</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;abortable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean_abort</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="n">step_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="n">tear_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="c1"># assert node&#39;s clean_step was cleaned up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_clean_abort"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_clean_abort">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test__do_node_clean_abort</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_clean_abort_with_step_name"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_clean_abort_with_step_name">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_abort_with_step_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test__do_node_clean_abort</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeDeploy</span><span class="p">,</span> <span class="s1">&#39;tear_down_cleaning&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeDeployTearDownTestCase.test__do_node_clean_abort_tear_down_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeDeployTearDownTestCase.test__do_node_clean_abort_tear_down_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_abort_tear_down_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tear_mock</span><span class="p">):</span>
        <span class="n">tear_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Surprise&#39;</span><span class="p">)</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;abortable&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean_abort</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">tear_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance_reason</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DoNodeCleanTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase">[docs]</a><span class="k">class</span> <span class="nc">DoNodeCleanTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DoNodeCleanTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">automated_clean</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;update_firmware&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;power&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;update_firmware&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_erase</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;erase_disks&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">}</span>
        <span class="c1"># Automated cleaning should be executed in this order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_erase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_update</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">deploy_update</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_clean_step_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Manual clean step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;build_raid&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">}</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
            <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">maintenance_reason</span><span class="o">=</span><span class="s1">&#39;reason&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeInMaintenance</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.task_manager.TaskManager.process_event&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_do_node_clean_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_process</span><span class="p">):</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_process</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_power_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_power_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_power_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_network_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_network_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_network_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_invalid_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_invalid_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_invalid_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_power_valid</span><span class="p">,</span>
                                         <span class="n">mock_network_valid</span><span class="p">):</span>
        <span class="c1"># test node.provision_state is incorrect for clean</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ENROLL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_power_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_network_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_ok"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_ok">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_power_valid</span><span class="p">,</span> <span class="n">mock_network_valid</span><span class="p">,</span>
                              <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">last_error</span><span class="o">=</span><span class="s1">&#39;old error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">clean_steps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">mock_power_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_network_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                      <span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Node will be moved to CLEANING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_node_clean_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_node_clean_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_node_clean_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_power_valid</span><span class="p">,</span>
                                            <span class="n">mock_network_valid</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">clean_steps</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">]</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">clean_steps</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">mock_power_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_network_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                      <span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Make sure states were rolled back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="c1"># Test the appropriate exception is raised if the worker pool is full</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_wrong_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_wrong_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_wrong_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="c1"># Test the appropriate exception is raised if node isn&#39;t already</span>
        <span class="c1"># in CLEANWAIT state</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DELETING</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Make sure things were rolled back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_continue_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_state</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># test a node can continue cleaning via RPC</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">return_state</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                       <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">,</span>
                                          <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">,</span>
                                      <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_clean_step_index</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_automated"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_automated">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_automated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_manual"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_manual">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_continue_node_clean_skip_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># test that skipping current step mechanism works</span>
        <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                       <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
            <span class="n">driver_info</span><span class="p">[</span><span class="s1">&#39;skip_current_clean_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skip</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">,</span> <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="n">expected_step_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span>
                <span class="s1">&#39;skip_current_clean_step&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
            <span class="n">expected_step_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">,</span>
                                      <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expected_step_index</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_skip_step"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_skip_step">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_skip_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_skip_step</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_no_skip_step"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_no_skip_step">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_no_skip_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_skip_step</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_continue_node_clean_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">last_clean_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_clean_step</span><span class="p">[</span><span class="s1">&#39;abortable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">last_clean_step</span><span class="p">[</span><span class="s1">&#39;abort_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                       <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">,</span> <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># assert the clean step name is in the last error message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_automated_abort"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_automated_abort">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_automated_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_abort</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_manual_abort"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_manual_abort">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_manual_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_abort</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_continue_node_clean_abort_last_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">last_clean_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_clean_step</span><span class="p">[</span><span class="s1">&#39;abortable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">last_clean_step</span><span class="p">[</span><span class="s1">&#39;abort_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                       <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">,</span> <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">continue_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_automated_abort_last_clean_step"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_automated_abort_last_clean_step">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_automated_abort_last_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_abort_last_clean_step</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_continue_node_clean_manual_abort_last_clean_step"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_continue_node_clean_manual_abort_last_clean_step">[docs]</a>    <span class="k">def</span> <span class="nf">test_continue_node_clean_manual_abort_last_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue_node_clean_abort_last_clean_step</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__do_node_clean_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># InvalidParameterValue should cause node to go to CLEANFAIL</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">clean_steps</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_power_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_power_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_power_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual_power_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual_power_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual_power_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="p">[])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_network_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_network_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_network_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                            <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual_network_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual_network_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual_network_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="p">[])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">automated_clean</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Assert that the node was moved to available without cleaning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare_cleaning&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__do_node_clean_prepare_clean_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prep</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                           <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Exception from task.driver.deploy.prepare_cleaning should cause node</span>
        <span class="c1"># to go to CLEANFAIL</span>
        <span class="n">mock_prep</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">clean_steps</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="n">mock_prep</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_prepare_clean_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_prepare_clean_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_prepare_clean_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_prepare_clean_fail</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual_prepare_clean_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual_prepare_clean_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual_prepare_clean_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_prepare_clean_fail</span><span class="p">(</span><span class="n">clean_steps</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare_cleaning&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__do_node_clean_prepare_clean_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prep</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                           <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">mock_prep</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">clean_steps</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="n">clean_steps</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="n">mock_prep</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_prepare_clean_wait"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_prepare_clean_wait">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_prepare_clean_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_prepare_clean_wait</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual_prepare_clean_wait"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual_prepare_clean_wait">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual_prepare_clean_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_prepare_clean_wait</span><span class="p">(</span><span class="n">clean_steps</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">conductor_utils</span><span class="p">,</span> <span class="s1">&#39;set_node_cleaning_steps&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__do_node_clean_steps_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_steps</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                   <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">invalid_exc</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">invalid_exc</span><span class="p">:</span>
            <span class="n">mock_steps</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mock_steps</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeCleaningFailure</span><span class="p">(</span><span class="s1">&#39;failure&#39;</span><span class="p">)</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">clean_steps</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="n">clean_steps</span><span class="p">)</span>
            <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="n">mock_steps</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated_steps_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated_steps_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated_steps_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">invalid</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_steps_fail</span><span class="p">(</span><span class="n">invalid_exc</span><span class="o">=</span><span class="n">invalid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual_steps_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual_steps_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual_steps_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">invalid</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean_steps_fail</span><span class="p">(</span><span class="n">clean_steps</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">],</span>
                                            <span class="n">invalid_exc</span><span class="o">=</span><span class="n">invalid</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">conductor_utils</span><span class="p">,</span> <span class="s1">&#39;set_node_cleaning_steps&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager.&#39;</span>
                <span class="s1">&#39;_do_next_clean_step&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__do_node_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_power_valid</span><span class="p">,</span> <span class="n">mock_network_valid</span><span class="p">,</span>
                        <span class="n">mock_next_step</span><span class="p">,</span> <span class="n">mock_steps</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clean_steps</span><span class="p">:</span>
            <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
            <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
            <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_clean</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="n">clean_steps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="n">mock_power_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">mock_network_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">mock_next_step</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mock_steps</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clean_steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">clean_steps</span><span class="p">,</span>
                             <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">])</span>

        <span class="c1"># Check that state didn&#39;t change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_automated"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_automated">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_automated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_node_clean_manual"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_node_clean_manual">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_clean_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__do_node_clean</span><span class="p">(</span><span class="n">clean_steps</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_first_step_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_state</span><span class="p">,</span> <span class="n">mock_execute</span><span class="p">,</span>
                                             <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Execute the first async clean step on a node</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">clean_steps</span><span class="p">:</span>
            <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
            <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
            <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">return_state</span>
        <span class="n">expected_first_step</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_first_step</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">])</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">expected_first_step</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_automated_first_step_async"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_automated_first_step_async">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_automated_first_step_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_first_step_async</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_manual_first_step_async"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_manual_first_step_async">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_manual_first_step_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_first_step_async</span><span class="p">(</span>
            <span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">clean_steps</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deploy_raid</span><span class="p">])</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_continue_from_last_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_state</span><span class="p">,</span>
                                                        <span class="n">mock_execute</span><span class="p">,</span>
                                                        <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># Resume an in-progress cleaning after the first async step</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                  <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">return_state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_clean_step_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">])</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_continue_from_last_cleaning"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_continue_from_last_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_continue_from_last_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_continue_from_last_cleaning</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_manual_continue_from_last_cleaning"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_manual_continue_from_last_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_manual_continue_from_last_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_continue_from_last_cleaning</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
                                                             <span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_last_step_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_execute</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># Resume where last_step is the last cleaning step, should be noop</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Cleaning should be complete without calling additional steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_execute</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_automated_last_step_noop"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_automated_last_step_noop">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_automated_last_step_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_last_step_noop</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_manual_last_step_noop"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_manual_last_step_noop">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_manual_last_step_noop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_last_step_noop</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_deploy_execute</span><span class="p">,</span>
                                <span class="n">mock_power_execute</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># Run all steps from start to finish (all synchronous)</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                  <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">mock_deploy_execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">mock_power_execute</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Cleaning should be complete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">])</span>
        <span class="n">mock_power_execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">mock_deploy_execute</span><span class="o">.</span><span class="n">assert_has_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">]</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_automated_all"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_automated_all">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_automated_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_all</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test_do_next_clean_step_manual_all"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test_do_next_clean_step_manual_all">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_next_clean_step_manual_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_all</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeDeploy</span><span class="p">,</span> <span class="s1">&#39;tear_down_cleaning&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_execute_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tear_mock</span><span class="p">,</span> <span class="n">mock_execute</span><span class="p">,</span>
                                         <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># When a clean step fails, go to CLEANFAIL</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                  <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tear_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Make sure we go to CLEANFAIL, clear clean_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span>
        <span class="n">mock_execute</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_automated_execute_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_automated_execute_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_automated_execute_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_execute_fail</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_manual_execute_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_manual_execute_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_manual_execute_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_execute_fail</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">,</span>
                <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.execute_clean_step&#39;</span><span class="p">,</span>
                <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeDeploy</span><span class="p">,</span> <span class="s1">&#39;tear_down_cleaning&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_fail_in_tear_down_cleaning</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">tear_mock</span><span class="p">,</span> <span class="n">power_exec_mock</span><span class="p">,</span> <span class="n">deploy_exec_mock</span><span class="p">,</span> <span class="n">log_mock</span><span class="p">,</span>
            <span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                  <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>

        <span class="n">deploy_exec_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">power_exec_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">tear_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;boom&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Make sure we go to CLEANFAIL, clear clean_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tear_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span>
        <span class="n">deploy_exec_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">deploy_exec_calls</span><span class="p">,</span> <span class="n">deploy_exec_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>

        <span class="n">power_exec_calls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">power_exec_calls</span><span class="p">,</span> <span class="n">power_exec_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">log_mock</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s1">&#39;Failed to tear down from cleaning for node {}, reason: boom&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_automated_fail_in_tear_down_cleaning"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_automated_fail_in_tear_down_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_automated_fail_in_tear_down_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_fail_in_tear_down_cleaning</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_manual_fail_in_tear_down_cleaning"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_manual_fail_in_tear_down_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_manual_fail_in_tear_down_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_fail_in_tear_down_cleaning</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_no_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_execute</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="p">({</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
                     <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}):</span>
            <span class="c1"># Resume where there are no steps, should be a noop</span>
            <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
                <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
                <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
                <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

            <span class="c1"># Cleaning should be complete without calling additional steps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_execute</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="n">mock_execute</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_automated_no_steps"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_automated_no_steps">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_automated_no_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_no_steps</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_manual_no_steps"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_manual_no_steps">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_manual_no_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_no_steps</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.execute_clean_step&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_do_next_clean_step_bad_step_return_value</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">deploy_exec_mock</span><span class="p">,</span> <span class="n">power_exec_mock</span><span class="p">,</span> <span class="n">manual</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># When a clean step fails, go to CLEANFAIL</span>
        <span class="n">tgt_prov_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span> <span class="k">if</span> <span class="n">manual</span> <span class="k">else</span> <span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prov_state</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                  <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">deploy_exec_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_next_clean_step</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="c1"># Make sure we go to CLEANFAIL, clear clean_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prov_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="n">node</span><span class="o">.</span><span class="n">clean_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;clean_step_index&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span>
        <span class="n">deploy_exec_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Make sure we don&#39;t execute any other step and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">power_exec_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_automated_bad_step_return_value"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_automated_bad_step_return_value">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_automated_bad_step_return_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_bad_step_return_value</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__do_next_clean_step_manual_bad_step_return_value"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__do_next_clean_step_manual_bad_step_return_value">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_next_clean_step_manual_bad_step_return_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_next_clean_step_bad_step_return_value</span><span class="p">(</span><span class="n">manual</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__get_node_next_clean_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">step_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_get_node_next_clean_steps</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">skip_current_step</span><span class="o">=</span><span class="n">skip</span><span class="p">)</span>
            <span class="n">expected_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">skip</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="n">step_index</span><span class="p">)</span>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__get_node_next_clean_steps"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__get_node_next_clean_steps">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_node_next_clean_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_node_next_clean_steps</span><span class="p">()</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__get_node_next_clean_steps_no_skip"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__get_node_next_clean_steps_no_skip">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_node_next_clean_steps_no_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__get_node_next_clean_steps</span><span class="p">(</span><span class="n">skip</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeCleanTestCase.test__get_node_next_clean_steps_unset_clean_step"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeCleanTestCase.test__get_node_next_clean_steps_unset_clean_step">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_node_next_clean_steps_unset_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">,</span>
                                <span class="s1">&#39;clean_step_index&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">clean_step</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">step_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_get_node_next_clean_steps</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">step_index</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DoNodeVerifyTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeVerifyTestCase">[docs]</a><span class="k">class</span> <span class="nc">DoNodeVerifyTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                           <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeCorrectedPowerStateNotification&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.get_power_state&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeVerifyTestCase.test__do_node_verify"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeVerifyTestCase.test__do_node_verify">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span> <span class="n">mock_get_power_state</span><span class="p">,</span>
                             <span class="n">mock_notif</span><span class="p">):</span>
        <span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeCorrectedPowerStateNotification&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">VERIFYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_verify</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>

        <span class="c1"># 1 notification should be sent -</span>
        <span class="c1"># baremetal.node.power_state_corrected.success</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">event_type</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">level</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">payload</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.get_power_state&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeVerifyTestCase.test__do_node_verify_validation_fails"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeVerifyTestCase.test__do_node_verify_validation_fails">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_verify_validation_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                              <span class="n">mock_get_power_state</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">VERIFYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;boom&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_verify</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="n">mock_validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ENROLL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.get_power_state&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeVerifyTestCase.test__do_node_verify_get_state_fails"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeVerifyTestCase.test__do_node_verify_get_state_fails">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_node_verify_get_state_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">,</span>
                                             <span class="n">mock_get_power_state</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">VERIFYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;boom&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_node_verify</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="n">mock_get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ENROLL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="MiscTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase">[docs]</a><span class="k">class</span> <span class="nc">MiscTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span> <span class="n">mgr_utils</span><span class="o">.</span><span class="n">CommonMixIn</span><span class="p">,</span>
                   <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="MiscTestCase.test__mapped_to_this_conductor"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase.test__mapped_to_this_conductor">[docs]</a>    <span class="k">def</span> <span class="nf">test__mapped_to_this_conductor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_mapped_to_this_conductor</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span>
                                                               <span class="s1">&#39;fake&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_mapped_to_this_conductor</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span>
                                                                <span class="s1">&#39;otherdriver&#39;</span><span class="p">))</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscTestCase.test_validate_driver_interfaces"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase.test_validate_driver_interfaces">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_driver_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">target_raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logical_disks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;size_gb&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                                 <span class="s1">&#39;raid_level&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}]}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">target_raid_config</span><span class="o">=</span><span class="n">target_raid_config</span><span class="p">,</span>
            <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;noop&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">validate_driver_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                      <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;console&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;inspect&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;management&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;boot&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;raid&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;deploy&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;network&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span>
                    <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscTestCase.test_validate_driver_interfaces_validation_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase.test_validate_driver_interfaces_validation_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_driver_interfaces_validation_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;noop&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
            <span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.validate&#39;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;fake reason&#39;</span>
            <span class="n">deploy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">validate_driver_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                          <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>
            <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscTestCase.test_validate_driver_interfaces_validation_fail_unexpected"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase.test_validate_driver_interfaces_validation_fail_unexpected">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_driver_interfaces_validation_fail_unexpected</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">mock_iwdi</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
                <span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.validate&#39;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">deploy</span><span class="p">:</span>
            <span class="n">deploy</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;boom&#39;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">validate_driver_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                          <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unexpected exception, traceback saved &#39;</span>
                      <span class="s1">&#39;into log by ironic conductor service &#39;</span>
                      <span class="s1">&#39;that is running on test-host: boom&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>

            <span class="n">mock_iwdi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_fail_if_in_state&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="MiscTestCase.test_iter_nodes"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.MiscTestCase.test_iter_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">test_iter_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_nodeinfo_list</span><span class="p">,</span> <span class="n">mock_mapped</span><span class="p">,</span>
                        <span class="n">mock_fail_if_state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="n">mock_nodeinfo_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">(</span>
            <span class="n">nodes</span><span class="p">)</span>
        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">iter_nodes</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                              <span class="n">filters</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">sentinel</span><span class="o">.</span><span class="n">filters</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">mock_nodeinfo_list</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">sentinel</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mock_fail_if_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;provision_state&#39;</span><span class="p">:</span> <span class="s1">&#39;deploying&#39;</span><span class="p">,</span> <span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span>
            <span class="s1">&#39;deploying&#39;</span><span class="p">,</span> <span class="s1">&#39;provision_updated_at&#39;</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="ConsoleTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase">[docs]</a><span class="k">class</span> <span class="nc">ConsoleTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span> <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
                               <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">spawn_mock</span><span class="p">:</span>
            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">spawn_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_enabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
             <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">END</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
             <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">END</span><span class="p">)])</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="c1"># null the console interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_validation_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_validation_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_validation_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="n">mock_val</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_start_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_start_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_start_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;start_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;test-error&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
                <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
                 <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_set_console_mode_stop_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_set_console_mode_stop_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_console_mode_stop_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;stop_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;test-error&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
                <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
                 <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_enable_console_already_enabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_enable_console_already_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_enable_console_already_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;start_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_sc</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_notify</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ConsoleTestCase.test_disable_console_already_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_disable_console_already_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_disable_console_already_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;stop_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_sc</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_notify</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_get_console"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_get_console">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_console</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">console_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="s1">&#39;test info&#39;</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="s1">&#39;get_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_gc</span><span class="p">:</span>
            <span class="n">mock_gc</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">console_info</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_console_information</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                        <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">console_info</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_get_console_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_get_console_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_console_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># null the console interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_console_information</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_get_console_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_get_console_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_console_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_console_information</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeConsoleNotEnabled</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="ConsoleTestCase.test_get_console_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ConsoleTestCase.test_get_console_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_console_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_gc</span><span class="p">:</span>
            <span class="n">mock_gc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_console_information</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DestroyNodeTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase">[docs]</a><span class="k">class</span> <span class="nc">DestroyNodeTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">DELETE_ALLOWED_STATES</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                              <span class="n">provision_state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_node_by_uuid</span><span class="p">,</span>
                              <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_reserved"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_reserved">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">fake_reservation</span> <span class="o">=</span> <span class="s1">&#39;fake-reserv&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="n">fake_reservation</span><span class="p">)</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Verify existing reservation wasn&#39;t broken.</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_reservation</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_associated"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_associated">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_associated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeAssociated</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Verify reservation was released.</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_invalid_provision_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_invalid_provision_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_invalid_provision_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Verify reservation was released.</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_allowed_in_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_allowed_in_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_allowed_in_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_node_by_uuid</span><span class="p">,</span>
                          <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_power_off"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_power_off">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_power_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_console_enabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_console_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_console_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;stop_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_node_by_uuid</span><span class="p">,</span>
                              <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
                <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
                 <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">END</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_console_disable_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_console_disable_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_console_disable_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notify</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                               <span class="s1">&#39;stop_console&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sc</span><span class="p">:</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">mock_sc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_node_by_uuid</span><span class="p">,</span>
                              <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
                <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
                 <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;console_set&#39;</span><span class="p">,</span>
                           <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)])</span></div>

<div class="viewcode-block" id="DestroyNodeTestCase.test_destroy_node_adopt_failed_no_power_change"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyNodeTestCase.test_destroy_node_adopt_failed_no_power_change">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_node_adopt_failed_no_power_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTFAIL</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                               <span class="s1">&#39;set_power_state&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_power</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_power</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="UpdatePortTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdatePortTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                         <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">new_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">port</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">new_extra</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_extra</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_port_changed_failure"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_port_changed_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_port_changed_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">old_address</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">address</span>
        <span class="n">port</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;11:22:33:44:55:bb&#39;</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">FailedToUpdateMacOnPort</span><span class="p">(</span><span class="s1">&#39;boom&#39;</span><span class="p">))</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">FailedToUpdateMacOnPort</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_address</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">address</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_address_active_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_address_active_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_address_active_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake-id&#39;</span><span class="p">})</span>
        <span class="n">old_address</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">address</span>
        <span class="n">new_address</span> <span class="o">=</span> <span class="s1">&#39;11:22:33:44:55:bb&#39;</span>
        <span class="n">port</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">new_address</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_address</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_pc</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_val</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_address_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_address_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_address_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
                                          <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake-id&#39;</span><span class="p">})</span>
        <span class="n">new_address</span> <span class="o">=</span> <span class="s1">&#39;11:22:33:44:55:bb&#39;</span>
        <span class="n">port</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">new_address</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_address</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_portgroup_active_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_portgroup_active_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_portgroup_active_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
        <span class="n">pg1</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">pg2</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">portgroup_id</span><span class="o">=</span><span class="n">pg1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">portgroup_id</span> <span class="o">=</span> <span class="n">pg2</span><span class="o">.</span><span class="n">id</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pg1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">portgroup_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_pc</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_val</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_portgroup_enroll_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_portgroup_enroll_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_portgroup_enroll_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="s1">&#39;enroll&#39;</span><span class="p">)</span>
        <span class="n">pg1</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">pg2</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">portgroup_id</span><span class="o">=</span><span class="n">pg1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">portgroup_id</span> <span class="o">=</span> <span class="n">pg2</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pg2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">portgroup_id</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_node_deleting_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_node_deleting_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_node_deleting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DELETING</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">old_pxe</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span>
        <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_pxe</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_node_manageable_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_node_manageable_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_node_manageable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span>
                                               <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;port_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_update_port_node_active_state_and_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_update_port_node_active_state_and_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_port_node_active_state_and_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span>
                                                           <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                                          <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                          <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">pxe_enabled</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test__filter_out_unsupported_types_all"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test__filter_out_unsupported_types_all">[docs]</a>    <span class="k">def</span> <span class="nf">test__filter_out_unsupported_types_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_types&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;All&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">fake_sensors_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">},</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">}}</span>
        <span class="n">actual_result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_filter_out_unsupported_types</span><span class="p">(</span><span class="n">fake_sensors_data</span><span class="p">))</span>
        <span class="n">expected_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">},</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_result</span><span class="p">,</span> <span class="n">actual_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test__filter_out_unsupported_types_part"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test__filter_out_unsupported_types_part">[docs]</a>    <span class="k">def</span> <span class="nf">test__filter_out_unsupported_types_part</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_types&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">fake_sensors_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">},</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">}}</span>
        <span class="n">actual_result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_filter_out_unsupported_types</span><span class="p">(</span><span class="n">fake_sensors_data</span><span class="p">))</span>
        <span class="n">expected_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_result</span><span class="p">,</span> <span class="n">actual_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test__filter_out_unsupported_types_non"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test__filter_out_unsupported_types_non">[docs]</a>    <span class="k">def</span> <span class="nf">test__filter_out_unsupported_types_non</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_types&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;t3&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">fake_sensors_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;t1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">},</span> <span class="s2">&quot;t2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">}}</span>
        <span class="n">actual_result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_filter_out_unsupported_types</span><span class="p">(</span><span class="n">fake_sensors_data</span><span class="p">))</span>
        <span class="n">expected_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_result</span><span class="p">,</span> <span class="n">actual_result</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_send_sensor_task"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_send_sensor_task">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_sensor_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;fake_uuid-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span>
                               <span class="s1">&#39;get_sensors_data&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_sensors_data_mock</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span>
                                   <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">validate_mock</span><span class="p">:</span>
                <span class="n">get_sensors_data_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;fake-sensor-data&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sensors_nodes_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">validate_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">get_sensors_data_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test_send_sensor_task_no_management"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_send_sensor_task_no_management">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_sensor_task_no_management</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s1">&#39;fake_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeManagement</span><span class="p">,</span> <span class="s1">&#39;get_sensors_data&#39;</span><span class="p">,</span>
                               <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">get_sensors_data_mock</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">FakeManagement</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span>
                                   <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">validate_mock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sensors_nodes_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">get_sensors_data_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">validate_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test___send_sensor_data"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test___send_sensor_data">[docs]</a>    <span class="k">def</span> <span class="nf">test___send_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_list_mock</span><span class="p">,</span>
                                <span class="n">_mapped_to_this_conductor_mock</span><span class="p">,</span>
                                <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="c1"># NOTE(galyna): do not wait for threads to be finished in unittests</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_wait_timeout&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">_mapped_to_this_conductor_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">get_nodeinfo_list_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;fake_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_send_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sensors_nodes_task</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                      <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test___send_sensor_data_multiple_workers"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test___send_sensor_data_multiple_workers">[docs]</a>    <span class="k">def</span> <span class="nf">test___send_sensor_data_multiple_workers</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_list_mock</span><span class="p">,</span> <span class="n">_mapped_to_this_conductor_mock</span><span class="p">,</span>
            <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>

        <span class="n">number_of_workers</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_workers&#39;</span><span class="p">,</span> <span class="n">number_of_workers</span><span class="p">,</span>
                          <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="c1"># NOTE(galyna): do not wait for threads to be finished in unittests</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;send_sensor_data_wait_timeout&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="n">_mapped_to_this_conductor_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">get_nodeinfo_list_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;fake_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                                <span class="bp">None</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_send_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">number_of_workers</span><span class="p">,</span>
                         <span class="n">mock_spawn</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortTestCase.test___send_sensor_data_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test___send_sensor_data_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test___send_sensor_data_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_list_mock</span><span class="p">,</span>
                                         <span class="n">_mapped_to_this_conductor_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">get_nodeinfo_list_mock</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span>
                               <span class="s1">&#39;_spawn_worker&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_spawn_mock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_send_sensor_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">get_nodeinfo_list_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_mapped_to_this_conductor_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">_spawn_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_set_boot_device"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_set_boot_device">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_boot_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span>
                                   <span class="s1">&#39;set_boot_device&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sbd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">boot_devices</span><span class="o">.</span><span class="n">PXE</span><span class="p">)</span>
                <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
                <span class="n">mock_sbd</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">PXE</span><span class="p">,</span>
                                                 <span class="n">persistent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_set_boot_device_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_set_boot_device_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_boot_device_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_set_boot_device_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_set_boot_device_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_boot_device_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="c1"># null the console interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_set_boot_device_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_set_boot_device_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_boot_device_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="n">mock_val</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_boot_device"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_boot_device">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">bootdev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_boot_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;boot_device&#39;</span><span class="p">:</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">PXE</span><span class="p">,</span> <span class="s1">&#39;persistent&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">bootdev</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_boot_device_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_boot_device_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_device_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_boot_device</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_boot_device_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_boot_device_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_device_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="c1"># null the management interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_boot_device</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_boot_device_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_boot_device_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_device_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="n">mock_val</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_boot_device</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span>
                                   <span class="s1">&#39;inject_nmi&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sbd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
                <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
                <span class="n">mock_sbd</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="c1"># null the management interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi_validate_invalid_param"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi_validate_invalid_param">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi_validate_invalid_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="n">mock_val</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi_validate_missing_param"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi_validate_missing_param">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi_validate_missing_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_val</span><span class="p">:</span>
            <span class="n">mock_val</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_inject_nmi_not_implemented"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_inject_nmi_not_implemented">[docs]</a>    <span class="k">def</span> <span class="nf">test_inject_nmi_not_implemented</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_supported_boot_devices"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_supported_boot_devices">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_supported_boot_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">bootdevs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_supported_boot_devices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                           <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">boot_devices</span><span class="o">.</span><span class="n">PXE</span><span class="p">],</span> <span class="n">bootdevs</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortTestCase.test_get_supported_boot_devices_iface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortTestCase.test_get_supported_boot_devices_iface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_supported_boot_devices_iface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="c1"># null the management interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">management</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_supported_boot_devices</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase">[docs]</a><span class="k">class</span> <span class="nc">VifTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span> <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="VifTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VifTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vif</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake&#39;</span><span class="p">}</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_list&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_list"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_list">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_list</span><span class="p">,</span> <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">mock_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VIF_ID&#39;</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_list</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mock_list</span><span class="o">.</span><span class="n">return_value</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_attach&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_attach"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_attach">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_attach</span><span class="p">,</span> <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span>
        <span class="n">mock_attach</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_attach&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_attach_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_attach_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_attach_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_attach</span><span class="p">,</span> <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_attach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_attach</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_valid</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_attach&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_attach_raises_network_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_attach_raises_network_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_attach_raises_network_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_attach</span><span class="p">,</span>
                                             <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">mock_attach</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">(</span><span class="s2">&quot;BOOM&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_attach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_attach</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_attach&#39;</span><span class="p">,</span> <span class="n">autpspec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_attach_validate_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_attach_validate_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_attach_validate_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_attach</span><span class="p">,</span>
                                       <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span><span class="s2">&quot;BOOM&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_attach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vif</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_attach</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_detach&#39;</span><span class="p">,</span> <span class="n">autpspec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_detach"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_detach">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_detach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_detach&#39;</span><span class="p">,</span> <span class="n">autpspec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_detach_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_detach_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_detach_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_detach</span><span class="p">,</span> <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_detach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_detach</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_valid</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_detach&#39;</span><span class="p">,</span> <span class="n">autpspec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_detach_raises_network_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_detach_raises_network_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_detach_raises_network_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_detach</span><span class="p">,</span>
                                             <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">(</span><span class="s2">&quot;BOOM&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_detach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NetworkError</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_detach</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;vif_detach&#39;</span><span class="p">,</span> <span class="n">autpspec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="VifTestCase.test_vif_detach_validate_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.VifTestCase.test_vif_detach_validate_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_vif_detach_validate_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_detach</span><span class="p">,</span>
                                       <span class="n">mock_valid</span><span class="p">):</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span><span class="s2">&quot;BOOM&quot;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">vif_detach</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s2">&quot;interface&quot;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mock_valid</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_detach</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdatePortgroupTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                              <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;portgroup_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">new_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">new_extra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_extra</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;portgroup_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_failure"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">old_extra</span> <span class="o">=</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span>
        <span class="n">new_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">new_extra</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">FailedToUpdateMacOnPort</span><span class="p">(</span><span class="s1">&#39;boom&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_extra</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">old_extra</span> <span class="o">=</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_extra</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_to_node_in_deleting_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_to_node_in_deleting_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_to_node_in_deleting_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">update_node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DELETING</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>

        <span class="n">old_node_id</span> <span class="o">=</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">update_node</span><span class="o">.</span><span class="n">id</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_node_id</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_ports_by_portgroup_id&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;portgroup_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_to_node_in_manageable_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_to_node_in_manageable_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_to_node_in_manageable_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span>
                                                          <span class="n">mock_pgc</span><span class="p">,</span>
                                                          <span class="n">mock_get_ports</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">update_node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">update_node</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">update_node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">portgroup</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pgc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_ports_by_portgroup_id&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;portgroup_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_to_node_in_active_state_and_maintenance"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_to_node_in_active_state_and_maintenance">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_to_node_in_active_state_and_maintenance</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span> <span class="n">mock_pgc</span><span class="p">,</span> <span class="n">mock_get_ports</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">update_node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
            <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">update_node</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">update_node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">portgroup</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_val</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_pgc</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_ports_by_portgroup_id&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;portgroup_changed&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">n_flat</span><span class="o">.</span><span class="n">FlatNetwork</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="UpdatePortgroupTestCase.test_update_portgroup_association_with_ports"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdatePortgroupTestCase.test_update_portgroup_association_with_ports">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_portgroup_association_with_ports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_val</span><span class="p">,</span>
                                                     <span class="n">mock_pgc</span><span class="p">,</span> <span class="n">mock_get_ports</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">update_node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test_port&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">old_node_id</span> <span class="o">=</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">update_node</span><span class="o">.</span><span class="n">id</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_portgroup</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">PortgroupNotEmpty</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">old_node_id</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">node_id</span><span class="p">)</span>
        <span class="n">mock_get_ports</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">portgroup</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_val</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_pgc</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="RaidTestCases"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases">[docs]</a><span class="k">class</span> <span class="nc">RaidTestCases</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span> <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span>
    <span class="n">raid_interface</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="RaidTestCases.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RaidTestCases</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span><span class="p">,</span>
            <span class="n">raid_interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raid_interface</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span></div>

<div class="viewcode-block" id="RaidTestCases.test_get_raid_logical_disk_properties"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_get_raid_logical_disk_properties">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_raid_logical_disk_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_raid_logical_disk_properties</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;raid_level&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;size_gb&#39;</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span></div>

<div class="viewcode-block" id="RaidTestCases.test_get_raid_logical_disk_properties_iface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_get_raid_logical_disk_properties_iface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_raid_logical_disk_properties_iface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">raid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_raid_logical_disk_properties</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="RaidTestCases.test_set_target_raid_config"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_set_target_raid_config">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_target_raid_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logical_disks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;size_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;raid_level&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raid_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span><span class="p">)</span></div>

<div class="viewcode-block" id="RaidTestCases.test_set_target_raid_config_empty"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_set_target_raid_config_empty">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_target_raid_config_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">raid_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span><span class="p">)</span></div>

<div class="viewcode-block" id="RaidTestCases.test_set_target_raid_config_iface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_set_target_raid_config_iface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_target_raid_config_iface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logical_disks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;size_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;raid_level&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">raid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="RaidTestCases.test_set_target_raid_config_invalid_parameter_value"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidTestCases.test_set_target_raid_config_invalid_parameter_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_target_raid_config_invalid_parameter_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Missing raid_level in the below raid config.</span>
        <span class="n">raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logical_disks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;size_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">raid_config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="RaidHardwareTypeTestCases"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidHardwareTypeTestCases">[docs]</a><span class="k">class</span> <span class="nc">RaidHardwareTypeTestCases</span><span class="p">(</span><span class="n">RaidTestCases</span><span class="p">):</span>

    <span class="n">driver_name</span> <span class="o">=</span> <span class="s1">&#39;fake-hardware&#39;</span>
    <span class="n">raid_interface</span> <span class="o">=</span> <span class="s1">&#39;fake&#39;</span>

<div class="viewcode-block" id="RaidHardwareTypeTestCases.test_get_raid_logical_disk_properties_iface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidHardwareTypeTestCases.test_get_raid_logical_disk_properties_iface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_raid_logical_disk_properties_iface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE(jroll) we don&#39;t run this test as get_logical_disk_properties</span>
        <span class="c1"># is supported on all RAID implementations, and we cannot have a</span>
        <span class="c1"># null interface for a hardware type</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RaidHardwareTypeTestCases.test_set_target_raid_config_iface_not_supported"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.RaidHardwareTypeTestCases.test_set_target_raid_config_iface_not_supported">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_target_raid_config_iface_not_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE(jroll): it&#39;s impossible for a dynamic driver to have a null</span>
        <span class="c1"># interface (e.g. node.driver.raid), so this instead tests that</span>
        <span class="c1"># if validation fails, we blow up properly.</span>
        <span class="c1"># need a different raid interface and a hardware type that supports it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;manual-management&#39;</span><span class="p">,</span>
            <span class="n">raid_interface</span><span class="o">=</span><span class="s1">&#39;no-raid&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span>
        <span class="n">raid_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logical_disks&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;size_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;raid_level&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}]}</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({},</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">target_raid_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;manual-management&#39;</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">conductor_utils</span><span class="p">,</span> <span class="s1">&#39;node_power_action&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerDoSyncPowerStateTestCase</span><span class="p">(</span><span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerDoSyncPowerStateTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">drivers_base</span><span class="o">.</span><span class="n">BaseDriver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">power</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">maintenance</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;upgrade_lock&#39;</span><span class="p">,</span> <span class="s1">&#39;shared&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_sync_power_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_power_state</span><span class="p">,</span> <span class="n">new_power_states</span><span class="p">,</span>
                             <span class="n">fail_validate</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">old_power_state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_power_states</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">new_power_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_power_states</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fail_validate</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exc</span>
        <span class="k">for</span> <span class="n">new_power_state</span> <span class="ow">in</span> <span class="n">new_power_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">old_power_state</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_power_state</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">new_power_state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">new_power_state</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">do_sync_power_state</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_unchanged"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_unchanged">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_unchanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="s1">&#39;fake-power&#39;</span><span class="p">,</span> <span class="s1">&#39;fake-power&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;fake-power&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_not_set"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_not_set">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_not_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                                  <span class="n">fail_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_get_power_state_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_get_power_state_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_power_state_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                  <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_get_power_state_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_get_power_state_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_power_state_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_changed_no_sync"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_changed_no_sync">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_changed_no_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeCorrectedPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_changed_no_sync_notify"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_changed_no_sync_notify">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_changed_no_sync_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeCorrectedPowerStateNotification&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>

        <span class="c1"># 1 notification should be sent:</span>
        <span class="c1"># baremetal.node.power_state_updated.success, indicating the DB was</span>
        <span class="c1"># updated to reflect the actual node power state</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">event_type</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">level</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">payload</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

        <span class="n">notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span>
            <span class="n">notif_args</span><span class="p">,</span> <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="s1">&#39;baremetal.node.power_state_corrected.success&#39;</span><span class="p">,</span>
            <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_changed_sync"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_changed_sync">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_changed_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node_power_action</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_state_changed_sync_failed"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_state_changed_sync_failed">[docs]</a>    <span class="k">def</span> <span class="nf">test_state_changed_sync_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="n">node_power_action</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="c1"># Just testing that this test doesn&#39;t raise.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node_power_action</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded">[docs]</a>    <span class="k">def</span> <span class="nf">test_max_retries_exceeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="n">power_exp_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">power_exp_calls</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">node_power_action</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance_reason</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded2"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded2">[docs]</a>    <span class="k">def</span> <span class="nf">test_max_retries_exceeded2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="n">power_exp_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">power_exp_calls</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">npa_exp_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">npa_exp_calls</span><span class="p">,</span> <span class="n">node_power_action</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.node.NodeCorrectedPowerStateNotification&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded_notify"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_max_retries_exceeded_notify">[docs]</a>    <span class="k">def</span> <span class="nf">test_max_retries_exceeded_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_notif</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="c1"># Required for exception handling</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s1">&#39;NodeCorrectedPowerStateNotification&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">])</span>
        <span class="c1"># 1 notification should be sent:</span>
        <span class="c1"># baremetal.node.power_state_corrected.success, indicating</span>
        <span class="c1"># the DB was updated to reflect the actual node power state</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">publisher</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">event_type</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">level</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                           <span class="n">payload</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_notif</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">emit</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

        <span class="n">notif_args</span> <span class="o">=</span> <span class="n">mock_notif</span><span class="o">.</span><span class="n">call_args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotificationEqual</span><span class="p">(</span>
            <span class="n">notif_args</span><span class="p">,</span> <span class="s1">&#39;ironic-conductor&#39;</span><span class="p">,</span> <span class="n">CONF</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="s1">&#39;baremetal.node.power_state_corrected.success&#39;</span><span class="p">,</span>
            <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationLevel</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_retry_then_success"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_retry_then_success">[docs]</a>    <span class="k">def</span> <span class="nf">test_retry_then_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">force_power_state_during_sync</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="p">[</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                                                    <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="n">power_exp_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">power_exp_calls</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">npa_exp_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">npa_exp_calls</span><span class="p">,</span> <span class="n">node_power_action</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_power_state_sync_max_retries_gps_exception"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_power_state_sync_max_retries_gps_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test_power_state_sync_max_retries_gps_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                        <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">power_state_sync_max_retries</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">power_state_sync_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">node_power_action</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                  <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;SpongeBob&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="c1"># make sure the actual error is in the last_error attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;SpongeBob&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_maintenance_on_upgrade_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_maintenance_on_upgrade_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_maintenance_on_upgrade_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">maintenance</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_wrong_provision_state_on_upgrade_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_wrong_provision_state_on_upgrade_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_wrong_provision_state_on_upgrade_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">provision_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div>

<div class="viewcode-block" id="ManagerDoSyncPowerStateTestCase.test_correct_power_state_on_upgrade_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerDoSyncPowerStateTestCase.test_correct_power_state_on_upgrade_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_correct_power_state_on_upgrade_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_power_action</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_fake_upgrade</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">power_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">_fake_upgrade</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_do_sync_power_state</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">get_power_state</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node_power_action</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">upgrade_lock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;do_sync_power_state&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerSyncPowerStatesTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">CommonMixIn</span><span class="p">,</span>
                                     <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerSyncPowerStatesTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">dbapi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_not_mapped"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_not_mapped">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_not_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                             <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span> <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_locked_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_locked_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_locked_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                    <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span> <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;host1&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_in_deploywait_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_in_deploywait_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_in_deploywait_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                           <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span>
                                           <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span>
                            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_in_enroll_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_in_enroll_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_in_enroll_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                       <span class="n">acquire_mock</span><span class="p">,</span> <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ENROLL</span><span class="p">,</span>
                            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_in_power_transition_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_in_power_transition_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_in_power_transition_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                 <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span>
                                                 <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">target_power_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_in_maintenance_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_in_maintenance_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_in_maintenance_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                            <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span>
                                            <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_node_disappears_on_acquire"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_node_disappears_on_acquire">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_disappears_on_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                        <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span> <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                          <span class="n">host</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">sync_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test_single_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test_single_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_single_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                         <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span> <span class="n">sync_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                             <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sync_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncPowerStatesTestCase.test__sync_power_state_multiple_nodes"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncPowerStatesTestCase.test__sync_power_state_multiple_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">test__sync_power_state_multiple_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                              <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,</span>
                                              <span class="n">sync_mock</span><span class="p">):</span>
        <span class="c1"># Create 8 nodes:</span>
        <span class="c1"># 1st node: Should acquire and try to sync</span>
        <span class="c1"># 2nd node: Not mapped to this conductor</span>
        <span class="c1"># 3rd node: In DEPLOYWAIT provision_state</span>
        <span class="c1"># 4th node: In maintenance mode</span>
        <span class="c1"># 5th node: Is in power transition</span>
        <span class="c1"># 6th node: Disappears after getting nodeinfo list</span>
        <span class="c1"># 7th node: Should acquire and try to sync</span>
        <span class="c1"># 8th node: do_sync_power_state raises NodeLocked</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mapped_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                     <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()}</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;provision_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_provision_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;maintenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;target_power_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_ON</span>

            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">node_attrs</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span>
            <span class="n">mapped_map</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="bp">True</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node_attrs</span><span class="o">=</span><span class="n">node_attrs</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">uuid</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
        <span class="c1"># not found during acquire (4 = index of Node6 after removing Node2)</span>
        <span class="n">tasks</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">sync_results</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="p">[</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">mapped_map</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">sync_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">sync_results</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">eventlet</span><span class="p">,</span> <span class="s1">&#39;sleep&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sleep_mock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_power_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="c1"># Ensure we&#39;ve yielded on every iteration, except for node</span>
            <span class="c1"># not mapped to this conductor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sleep_mock</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>
        <span class="n">mapped_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mapped_calls</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">acquire_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                   <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
                                   <span class="n">shared</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">acquire_calls</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="c1"># Nodes 1 and 7 (5 = index of Node7 after removing Node2)</span>
        <span class="n">sync_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">),</span>
                      <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sync_calls</span><span class="p">,</span> <span class="n">sync_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerCheckDeployTimeoutsTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">CommonMixIn</span><span class="p">,</span>
                                         <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerCheckDeployTimeoutsTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">deploy_callback_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">dbapi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span>
                                      <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span>
                                       <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">&#39;provisioned_before&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">&#39;provision_state&#39;</span><span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">sort_key</span><span class="o">=</span><span class="s1">&#39;provision_updated_at&#39;</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="s1">&#39;asc&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                      <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">deploy_callback_timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mapped_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_not_mapped"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_not_mapped">[docs]</a>    <span class="k">def</span> <span class="nf">test_not_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_timeout"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s1">&#39;fail&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="n">call_args</span><span class="o">=</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">),</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">,</span>
            <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_acquire_node_disappears"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_acquire_node_disappears">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_node_disappears</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                     <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="c1"># Exception eaten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_acquire_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_acquire_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_acquire_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                 <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                                        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="c1"># Exception eaten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_no_deploywait_after_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_no_deploywait_after_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_deploywait_after_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                      <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_maintenance_after_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_maintenance_after_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test_maintenance_after_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                    <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYWAIT</span><span class="p">,</span>
                            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                            <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">),</span>
                          <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">driver</span><span class="p">)],</span>
                         <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">),</span>
                          <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)],</span>
                         <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="c1"># First node skipped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="c1"># Second node spawned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s1">&#39;fail&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="n">call_args</span><span class="o">=</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">),</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">,</span>
            <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_exiting_no_worker_avail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_exiting_no_worker_avail">[docs]</a>    <span class="k">def</span> <span class="nf">test_exiting_no_worker_avail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                                     <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">])</span>

        <span class="c1"># Exception should be nuked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="c1"># mapped should be only called for the first node as we should</span>
        <span class="c1"># have exited the loop early due to NoFreeConductorWorker</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s1">&#39;fail&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="n">call_args</span><span class="o">=</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">),</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">,</span>
            <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_exiting_with_other_exception"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_exiting_with_other_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test_exiting_with_other_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                          <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">])</span>

        <span class="c1"># Should re-raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="c1"># mapped should be only called for the first node as we should</span>
        <span class="c1"># have exited the loop early due to unknown exception</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span>
            <span class="s1">&#39;fail&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="n">call_args</span><span class="o">=</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">),</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">,</span>
            <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployTimeoutsTestCase.test_worker_limit"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployTimeoutsTestCase.test_worker_limit">[docs]</a>    <span class="k">def</span> <span class="nf">test_worker_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">periodic_max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="c1"># Use the same nodes/tasks to make life easier in the tests</span>
        <span class="c1"># here</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploy_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Should only have ran 2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">process_event_call</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
            <span class="s1">&#39;fail&#39;</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="n">call_args</span><span class="o">=</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">),</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">,</span>
            <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">process_event_call</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="ManagerTestProperties"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties">[docs]</a><span class="k">class</span> <span class="nc">ManagerTestProperties</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                            <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ManagerTestProperties.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerTestProperties</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;test-host&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_driver_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver_factory</span><span class="o">.</span><span class="n">get_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">,</span> <span class="s1">&#39;B1&#39;</span><span class="p">,</span> <span class="s1">&#39;B2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_ipmitool"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_ipmitool">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_ipmitool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ipmi_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_terminal_port&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_priv_level&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_username&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_bridging&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_transit_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_transit_address&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_target_channel&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_target_address&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_local_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_protocol_version&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_force_boot_device&#39;</span>
                    <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_ipmitool&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_ipminative"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_ipminative">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_ipminative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ipmi_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_username&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_terminal_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_force_boot_device&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_ipminative&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_ssh"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_ssh">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_ssh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ssh_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_username&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;vbox_use_headless&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_virt_type&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ssh_key_contents&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_key_filename&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ssh_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_terminal_port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_ssh&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_pxe"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_pxe">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_pxe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_pxe&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_snmp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_snmp">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_snmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;snmp_driver&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_address&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_port&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_version&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_community&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_security&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_outlet&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_snmp&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_pxe_ipmitool"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_pxe_ipmitool">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_pxe_ipmitool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ipmi_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_terminal_port&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_priv_level&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_username&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_bridging&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_transit_channel&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_transit_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_target_channel&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_target_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_local_address&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_protocol_version&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_force_boot_device&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;pxe_ipmitool&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_pxe_ipminative"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_pxe_ipminative">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_pxe_ipminative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ipmi_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_username&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ipmi_terminal_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ipmi_force_boot_device&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;pxe_ipminative&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_pxe_ssh"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_pxe_ssh">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_pxe_ssh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ssh_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_username&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;vbox_use_headless&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_virt_type&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ssh_key_contents&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_key_filename&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ssh_password&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ssh_terminal_port&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;pxe_ssh&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_pxe_snmp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_pxe_snmp">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_pxe_snmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_driver&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_address&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_port&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_version&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_community&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_security&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_outlet&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;pxe_snmp&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fake_ilo"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fake_ilo">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fake_ilo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ilo_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_username&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;client_port&#39;</span><span class="p">,</span> <span class="s1">&#39;client_timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_change_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ca_file&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_user&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_prot_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_priv_password&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_protocol&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_priv_protocol&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;fake_ilo&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_ilo_iscsi"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_ilo_iscsi">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_ilo_iscsi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ilo_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_username&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;client_port&#39;</span><span class="p">,</span> <span class="s1">&#39;client_timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_deploy_iso&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;console_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_change_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">,</span> <span class="s1">&#39;ca_file&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_user&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_prot_password&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_priv_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_protocol&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_priv_protocol&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;iscsi_ilo&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_agent_ilo"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_agent_ilo">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_agent_ilo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ilo_address&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_username&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;client_port&#39;</span><span class="p">,</span> <span class="s1">&#39;client_timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_deploy_iso&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;console_port&#39;</span><span class="p">,</span> <span class="s1">&#39;ilo_change_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ca_file&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_user&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_prot_password&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_priv_password&#39;</span><span class="p">,</span> <span class="s1">&#39;snmp_auth_protocol&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;snmp_auth_priv_protocol&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_properties</span><span class="p">(</span><span class="s2">&quot;agent_ilo&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerTestProperties.test_driver_properties_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestProperties.test_driver_properties_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_driver_properties_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver_factory</span><span class="o">.</span><span class="n">get_driver</span><span class="p">(</span><span class="s2">&quot;fake&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">init_host</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_properties</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;bad-driver&quot;</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">DriverNotFound</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="ManagerTestHardwareTypeProperties"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestHardwareTypeProperties">[docs]</a><span class="k">class</span> <span class="nc">ManagerTestHardwareTypeProperties</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                        <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_check_hardware_type_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hardware_type</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">enabled_hardware_types</span><span class="o">=</span><span class="p">[</span><span class="n">hardware_type</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hardware_type</span> <span class="o">=</span> <span class="n">driver_factory</span><span class="o">.</span><span class="n">get_hardware_type</span><span class="p">(</span><span class="n">hardware_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">get_driver_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                        <span class="n">hardware_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<div class="viewcode-block" id="ManagerTestHardwareTypeProperties.test_hardware_type_properties_manual_management"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerTestHardwareTypeProperties.test_hardware_type_properties_manual_management">[docs]</a>    <span class="k">def</span> <span class="nf">test_hardware_type_properties_manual_management</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deploy_kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_ramdisk&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;deploy_forces_oob_reboot&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_hardware_type_properties</span><span class="p">(</span><span class="s1">&#39;manual-management&#39;</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerSyncLocalStateTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerSyncLocalStateTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">CommonMixIn</span><span class="p">,</span>
                                    <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerSyncLocalStateTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">dbapi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">ring_manager</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                                      <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">&#39;maintenance&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">&#39;provision_state&#39;</span><span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;conductor_affinity&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">)</span>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_not_mapped"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_not_mapped">[docs]</a>    <span class="k">def</span> <span class="nf">test_not_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_already_mapped"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_already_mapped">[docs]</a>    <span class="k">def</span> <span class="nf">test_already_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                            <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="c1"># Node is already mapped to the conductor running the periodic task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">conductor_affinity</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">123</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_good"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_good">[docs]</a>    <span class="k">def</span> <span class="nf">test_good</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="c1"># assert spawn_after has been called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_no_free_worker"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_no_free_worker">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_free_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span>
                            <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">None</span><span class="p">,</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 3 nodes to be checked</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>

        <span class="c1"># assert  _mapped_to_this_conductor() gets called 2 times only</span>
        <span class="c1"># instead of 3. When NoFreeConductorWorker is raised the loop</span>
        <span class="c1"># should be broken</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>

        <span class="c1"># assert  acquire() gets called 2 times only instead of 3. When</span>
        <span class="c1"># NoFreeConductorWorker is raised the loop should be broken</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                              <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>

        <span class="c1"># assert spawn_after has been called twice</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">,):</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>

        <span class="c1"># 3 nodes to be checked</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>

        <span class="c1"># assert _mapped_to_this_conductor() gets called 3 times</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>

        <span class="c1"># assert acquire() gets called 3 times</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                              <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>

        <span class="c1"># assert spawn_after has been called only 2 times</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerSyncLocalStateTestCase.test_worker_limit"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerSyncLocalStateTestCase.test_worker_limit">[docs]</a>    <span class="k">def</span> <span class="nf">test_worker_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="c1"># Limit to only 1 worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">periodic_max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="c1"># 3 nodes to be checked</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_sync_local_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>

        <span class="c1"># assert _mapped_to_this_conductor() gets called only once</span>
        <span class="c1"># because of the worker limit</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>

        <span class="c1"># assert acquire() gets called only once because of the worker limit</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>

        <span class="c1"># assert spawn_after has been called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">spawn_after</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">swift</span><span class="p">,</span> <span class="s1">&#39;SwiftAPI&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="StoreConfigDriveTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.StoreConfigDriveTestCase">[docs]</a><span class="k">class</span> <span class="nc">StoreConfigDriveTestCase</span><span class="p">(</span><span class="n">tests_base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="StoreConfigDriveTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.StoreConfigDriveTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StoreConfigDriveTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                            <span class="n">instance_info</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="StoreConfigDriveTestCase.test_store_configdrive"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.StoreConfigDriveTestCase.test_store_configdrive">[docs]</a>    <span class="k">def</span> <span class="nf">test_store_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_swift</span><span class="p">):</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">_store_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="n">expected_instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_instance_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_swift</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="StoreConfigDriveTestCase.test_store_configdrive_swift"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.StoreConfigDriveTestCase.test_store_configdrive_swift">[docs]</a>    <span class="k">def</span> <span class="nf">test_store_configdrive_swift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_swift</span><span class="p">):</span>
        <span class="n">container_name</span> <span class="o">=</span> <span class="s1">&#39;foo_container&#39;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">123</span>
        <span class="n">expected_obj_name</span> <span class="o">=</span> <span class="s1">&#39;configdrive-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">expected_obj_header</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X-Delete-After&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeout</span><span class="p">)}</span>
        <span class="n">expected_instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="s1">&#39;http://1.2.3.4&#39;</span><span class="p">}</span>

        <span class="c1"># set configs and mocks</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;configdrive_use_swift&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;configdrive_swift_container&#39;</span><span class="p">,</span> <span class="n">container_name</span><span class="p">,</span>
                          <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;deploy_callback_timeout&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
                          <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">mock_swift</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">get_temp_url</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;http://1.2.3.4&#39;</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">_store_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">mock_swift</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
        <span class="n">mock_swift</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">create_object</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">container_name</span><span class="p">,</span> <span class="n">expected_obj_name</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span>
            <span class="n">object_headers</span><span class="o">=</span><span class="n">expected_obj_header</span><span class="p">)</span>
        <span class="n">mock_swift</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">get_temp_url</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">container_name</span><span class="p">,</span> <span class="n">expected_obj_name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_instance_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="NodeInspectHardware"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware">[docs]</a><span class="k">class</span> <span class="nc">NodeInspectHardware</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.inspect_hardware&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_ok"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_ok">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_inspect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">_do_inspect_hardware</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.inspect_hardware&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_return_inspecting"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_return_inspecting">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_return_inspecting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_inspect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">_do_inspect_hardware</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.inspect_hardware&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_return_other_state"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_return_other_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_return_other_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_inspect</span><span class="p">,</span> <span class="n">log_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HardwareInspectionFailure</span><span class="p">,</span>
                          <span class="n">manager</span><span class="o">.</span><span class="n">_do_inspect_hardware</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">log_mock</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeInspectHardware.test__check_inspect_timeouts"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test__check_inspect_timeouts">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;inspect_timeout&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">provision_updated_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">inspection_started_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_worker_pool_full"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_worker_pool_full">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_worker_pool_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="n">prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">tgt_prv_state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">prv_state</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">tgt_prv_state</span><span class="p">,</span>
                                          <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inspect_hardware</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_service</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="c1"># Make sure things were rolled back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tgt_prv_state</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_test_inspect_hardware_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="n">mock_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">inspect_hardware</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HardwareInspectionFailure</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># This is a sync operation last_error should be None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="c1"># Verify reservation has been cleared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_inspect_hardware_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_power_validate_fail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_power_validate_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_power_validate_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_inspect_hardware_validate_fail</span><span class="p">(</span><span class="n">mock_validate</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.inspect_hardware&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_raises_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_raises_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_raises_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_inspect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">HardwareInspectionFailure</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HardwareInspectionFailure</span><span class="p">,</span> <span class="s1">&#39;^test$&#39;</span><span class="p">,</span>
                               <span class="n">manager</span><span class="o">.</span><span class="n">_do_inspect_hardware</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_inspect</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeInspect.inspect_hardware&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="NodeInspectHardware.test_inspect_hardware_unexpected_error"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.NodeInspectHardware.test_inspect_hardware_unexpected_error">[docs]</a>    <span class="k">def</span> <span class="nf">test_inspect_hardware_unexpected_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_inspect</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_inspect</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
                                          <span class="n">target_provision_state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HardwareInspectionFailure</span><span class="p">,</span>
                               <span class="s1">&#39;Unexpected exception of type RuntimeError: x&#39;</span><span class="p">,</span>
                               <span class="n">manager</span><span class="o">.</span><span class="n">_do_inspect_hardware</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;Unexpected exception of type RuntimeError: x&#39;</span><span class="p">,</span>
                         <span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_inspect</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="p">,</span> <span class="s1">&#39;acquire&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_nodeinfo_list&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerCheckInspectTimeoutsTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">CommonMixIn</span><span class="p">,</span>
                                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerCheckInspectTimeoutsTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">inspect_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">dbapi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
                                      <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_node</span><span class="p">(</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                        <span class="s1">&#39;inspection_started_before&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                        <span class="s1">&#39;provision_state&#39;</span><span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">sort_dir</span><span class="o">=</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">sort_key</span><span class="o">=</span><span class="s1">&#39;inspection_started_at&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_disabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                              <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">inspect_timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mapped_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_not_mapped"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_not_mapped">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_not_mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">acquire_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeout"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeout">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                    <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_acquire_node_disappears"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_acquire_node_disappears">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_acquire_node_disappears</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                             <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                             <span class="n">mapped_mock</span><span class="p">,</span>
                                                             <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="c1"># Exception eaten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_acquire_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_acquire_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_acquire_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                         <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                         <span class="n">mapped_mock</span><span class="p">,</span>
                                                         <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                                        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="c1"># Exception eaten</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_no_acquire_after_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_no_acquire_after_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_no_acquire_after_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                           <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                           <span class="n">mapped_mock</span><span class="p">,</span>
                                                           <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">()</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_to_maintenance_after_lock"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_to_maintenance_after_lock">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_to_maintenance_after_lock</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">(</span>
            <span class="n">node_attrs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">INSPECTING</span><span class="p">,</span>
                            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
                            <span class="n">maintenance</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="n">task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">),</span>
                          <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">driver</span><span class="p">)],</span>
                         <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">),</span>
                          <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)],</span>
                         <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="c1"># First node skipped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="c1"># Second node spawned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_exiting_no_worker_avail"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_exiting_no_worker_avail">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_exiting_no_worker_avail</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoFreeConductorWorker</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">])</span>

        <span class="c1"># Exception should be nuked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="c1"># mapped should be only called for the first node as we should</span>
        <span class="c1"># have exited the loop early due to NoFreeConductorWorker</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_exit_with_other_exception"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_exit_with_other_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_exit_with_other_exception</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span> <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node2</span><span class="p">]))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">(</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">task2</span><span class="p">])</span>

        <span class="c1"># Should re-raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">IronicException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_get_nodeinfo_args</span><span class="p">(</span><span class="n">get_nodeinfo_mock</span><span class="p">)</span>
        <span class="c1"># mapped should be only called for the first node as we should</span>
        <span class="c1"># have exited the loop early due to unknown exception</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_worker_limit"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckInspectTimeoutsTestCase.test__check_inspect_timeouts_worker_limit">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_inspect_timeouts_worker_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_nodeinfo_mock</span><span class="p">,</span>
                                                  <span class="n">mapped_mock</span><span class="p">,</span> <span class="n">acquire_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">periodic_max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>

        <span class="c1"># Use the same nodes/tasks to make life easier in the tests</span>
        <span class="c1"># here</span>

        <span class="n">get_nodeinfo_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeinfo_list_response</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">mapped_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">acquire_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_acquire_side_effect</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_inspect_timeouts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Should only have ran 2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">mapped_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                    <span class="n">purpose</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">acquire_mock</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span>
        <span class="n">process_event_call</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">target_state</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">process_event_call</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">process_event</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DestroyPortTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortTestCase">[docs]</a><span class="k">class</span> <span class="nc">DestroyPortTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DestroyPortTestCase.test_destroy_port"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortTestCase.test_destroy_port">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                          <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">PortNotFound</span><span class="p">,</span> <span class="n">port</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyPortTestCase.test_destroy_port_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortTestCase.test_destroy_port_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_port_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>

        <span class="n">port</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_port</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DestroyPortgroupTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortgroupTestCase">[docs]</a><span class="k">class</span> <span class="nc">DestroyPortgroupTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                               <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DestroyPortgroupTestCase.test_destroy_portgroup"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortgroupTestCase.test_destroy_portgroup">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">PortgroupNotFound</span><span class="p">,</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyPortgroupTestCase.test_destroy_portgroup_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyPortgroupTestCase.test_destroy_portgroup_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_portgroup_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">portgroup</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_portgroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                    <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_portgroup</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">portgroup</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_fail_if_in_state&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">,</span> <span class="s1">&#39;_mapped_to_this_conductor&#39;</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">dbapi</span><span class="o">.</span><span class="n">IMPL</span><span class="p">,</span> <span class="s1">&#39;get_offline_conductors&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase">[docs]</a><span class="k">class</span> <span class="nc">ManagerCheckDeployingStatusTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                          <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagerCheckDeployingStatusTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span><span class="p">,</span>
            <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-conductor&#39;</span><span class="p">)</span>

        <span class="c1"># create a second node in a different state to test the</span>
        <span class="c1"># filtering nodes in DEPLOYING state</span>
        <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase.test__check_deploying_status"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase.test__check_deploying_status">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_deploying_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_off_cond</span><span class="p">,</span> <span class="n">mock_mapped</span><span class="p">,</span>
                                     <span class="n">mock_fail_if</span><span class="p">):</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fake-conductor&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploying_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">mock_fail_if</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">},</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
            <span class="s1">&#39;provision_updated_at&#39;</span><span class="p">,</span>
            <span class="n">callback_method</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">)</span>
        <span class="c1"># assert node was released</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase.test__check_deploying_status_alive"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase.test__check_deploying_status_alive">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_deploying_status_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_off_cond</span><span class="p">,</span>
                                           <span class="n">mock_mapped</span><span class="p">,</span> <span class="n">mock_fail_if</span><span class="p">):</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploying_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_mapped</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_fail_if</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="c1"># assert node still locked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase.test__check_deploying_status_release_exceptions_skipping"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase.test__check_deploying_status_release_exceptions_skipping">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_deploying_status_release_exceptions_skipping</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">mock_release</span><span class="p">,</span> <span class="n">mock_off_cond</span><span class="p">,</span> <span class="n">mock_mapped</span><span class="p">,</span> <span class="n">mock_fail_if</span><span class="p">):</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fake-conductor&#39;</span><span class="p">]</span>
        <span class="c1"># Add another node so we can check both exceptions</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYDONE</span><span class="p">,</span>
            <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-conductor&#39;</span><span class="p">)</span>

        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mock_release</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">(</span><span class="s1">&#39;not found&#39;</span><span class="p">),</span>
                                    <span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="s1">&#39;locked&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploying_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
        <span class="n">expected_calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">),</span>
                          <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">node2</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)]</span>
        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span><span class="n">expected_calls</span><span class="p">)</span>
        <span class="c1"># Assert we skipped and didn&#39;t try to call _fail_if_in_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_fail_if</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="s1">&#39;release&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ManagerCheckDeployingStatusTestCase.test__check_deploying_status_release_node_not_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.ManagerCheckDeployingStatusTestCase.test__check_deploying_status_release_node_not_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_deploying_status_release_node_not_locked</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">mock_release</span><span class="p">,</span> <span class="n">mock_off_cond</span><span class="p">,</span> <span class="n">mock_mapped</span><span class="p">,</span> <span class="n">mock_fail_if</span><span class="p">):</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fake-conductor&#39;</span><span class="p">]</span>
        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mock_release</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeNotLocked</span><span class="p">(</span><span class="s1">&#39;not locked&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_check_deploying_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="n">mock_off_cond</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">()</span>
        <span class="n">mock_mapped</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">mock_fail_if</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">},</span> <span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
            <span class="s1">&#39;provision_updated_at&#39;</span><span class="p">,</span>
            <span class="n">callback_method</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">cleanup_after_timeout</span><span class="p">,</span>
            <span class="n">err_handler</span><span class="o">=</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">provisioning_error_handler</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestIndirectionApiConductor"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor">[docs]</a><span class="k">class</span> <span class="nc">TestIndirectionApiConductor</span><span class="p">(</span><span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestIndirectionApiConductor.setUp"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestIndirectionApiConductor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conductor</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">ConductorManager</span><span class="p">(</span><span class="s1">&#39;test-host&#39;</span><span class="p">,</span> <span class="s1">&#39;test-topic&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_test_object_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_classmethod</span><span class="p">,</span> <span class="n">raise_exception</span><span class="p">,</span>
                            <span class="n">return_object</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nd">@obj_base.IronicObjectRegistry.register</span>
        <span class="k">class</span> <span class="nc">TestObject</span><span class="p">(</span><span class="n">obj_base</span><span class="o">.</span><span class="n">IronicObject</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

            <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">return_object</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">return_object</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;test&#39;</span>

            <span class="nd">@classmethod</span>
            <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">return_object</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">raise_exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">return_object</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;test&#39;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_classmethod</span><span class="p">:</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="n">ovo_base</span><span class="o">.</span><span class="n">obj_tree_get_versions</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">obj_name</span><span class="p">())</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">object_class_action_versions</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">TestObject</span><span class="o">.</span><span class="n">obj_name</span><span class="p">(),</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">versions</span><span class="p">,</span>
                <span class="nb">tuple</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;raise_exception&#39;</span><span class="p">:</span> <span class="n">raise_exception</span><span class="p">,</span>
                          <span class="s1">&#39;return_object&#39;</span><span class="p">:</span> <span class="n">return_object</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">object_action</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(),</span>
                <span class="p">{</span><span class="s1">&#39;raise_exception&#39;</span><span class="p">:</span> <span class="n">raise_exception</span><span class="p">,</span>
                 <span class="s1">&#39;return_object&#39;</span><span class="p">:</span> <span class="n">return_object</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">return_object</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_action"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_action">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_action_on_raise"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_action_on_raise">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_action_on_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_action_on_object"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_action_on_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_action_on_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_class_action"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_class_action">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_class_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_class_action_on_raise"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_class_action_on_raise">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_class_action_on_raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_class_action_on_object"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_class_action_on_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_class_action_on_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_object_action</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_action_copies_object"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_action_copies_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_action_copies_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nd">@obj_base.IronicObjectRegistry.register</span>
        <span class="k">class</span> <span class="nc">TestObject</span><span class="p">(</span><span class="n">obj_base</span><span class="o">.</span><span class="n">IronicObject</span><span class="p">):</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="o">.</span><span class="n">DictOfStringsField</span><span class="p">()}</span>

            <span class="k">def</span> <span class="nf">touch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obj_reset_changes</span><span class="p">()</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">obj_reset_changes</span><span class="p">()</span>
        <span class="n">updates</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">object_action</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;touch_dict&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="p">{})</span>
        <span class="c1"># NOTE(danms): If conductor did not properly copy the object, then</span>
        <span class="c1"># the new and reference copies of the nested dict object will be</span>
        <span class="c1"># the same, and thus &#39;dict&#39; will not be reported as changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">updates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="n">updates</span><span class="p">[</span><span class="s1">&#39;dict&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestIndirectionApiConductor.test_object_backport_versions"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.TestIndirectionApiConductor.test_object_backport_versions">[docs]</a>    <span class="k">def</span> <span class="nf">test_object_backport_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fake_backported_obj</span> <span class="o">=</span> <span class="s1">&#39;fake-backported-obj&#39;</span>
        <span class="n">obj_name</span> <span class="o">=</span> <span class="s1">&#39;fake-obj&#39;</span>
        <span class="n">test_obj</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">test_obj</span><span class="o">.</span><span class="n">obj_name</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">obj_name</span>
        <span class="n">test_obj</span><span class="o">.</span><span class="n">obj_to_primitive</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_backported_obj</span>
        <span class="n">fake_version_manifest</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj_name</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conductor</span><span class="o">.</span><span class="n">object_backport_versions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">test_obj</span><span class="p">,</span> <span class="n">fake_version_manifest</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fake_backported_obj</span><span class="p">)</span>
        <span class="n">test_obj</span><span class="o">.</span><span class="n">obj_to_primitive</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">target_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="n">version_manifest</span><span class="o">=</span><span class="n">fake_version_manifest</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DoNodeTakeOverTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeTakeOverTestCase">[docs]</a><span class="k">class</span> <span class="nc">DoNodeTakeOverTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                             <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeTakeOverTestCase.test__do_takeover"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeTakeOverTestCase.test__do_takeover">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_takeover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prepare</span><span class="p">,</span> <span class="n">mock_take_over</span><span class="p">,</span>
                          <span class="n">mock_start_console</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_start_console</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeTakeOverTestCase.test__do_takeover_with_console_enabled"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeTakeOverTestCase.test__do_takeover_with_console_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_takeover_with_console_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prepare</span><span class="p">,</span>
                                               <span class="n">mock_take_over</span><span class="p">,</span>
                                               <span class="n">mock_start_console</span><span class="p">,</span>
                                               <span class="n">mock_notify</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_start_console</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;console_restore&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
             <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;console_restore&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">END</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">notification_utils</span><span class="p">,</span> <span class="s1">&#39;emit_console_notification&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeTakeOverTestCase.test__do_takeover_with_console_exception"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeTakeOverTestCase.test__do_takeover_with_console_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_takeover_with_console_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_prepare</span><span class="p">,</span>
                                                 <span class="n">mock_take_over</span><span class="p">,</span>
                                                 <span class="n">mock_start_console</span><span class="p">,</span>
                                                 <span class="n">mock_notify</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">mock_start_console</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_takeover</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_start_console</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_notify</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span>
            <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;console_restore&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">START</span><span class="p">),</span>
             <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;console_restore&#39;</span><span class="p">,</span>
                       <span class="n">obj_fields</span><span class="o">.</span><span class="n">NotificationStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase">[docs]</a><span class="k">class</span> <span class="nc">DoNodeAdoptionTestCase</span><span class="p">(</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
        <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakePower.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeBoot.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test__do_adoption_with_takeover"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test__do_adoption_with_takeover">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_adoption_with_takeover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                        <span class="n">mock_prepare</span><span class="p">,</span>
                                        <span class="n">mock_take_over</span><span class="p">,</span>
                                        <span class="n">mock_start_console</span><span class="p">,</span>
                                        <span class="n">mock_boot_validate</span><span class="p">,</span>
                                        <span class="n">mock_power_validate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test a successful node adoption&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_adoption</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_start_console</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_boot_validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeBoot.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test__do_adoption_take_over_failure"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test__do_adoption_take_over_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_adoption_take_over_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">mock_prepare</span><span class="p">,</span>
                                            <span class="n">mock_take_over</span><span class="p">,</span>
                                            <span class="n">mock_start_console</span><span class="p">,</span>
                                            <span class="n">mock_boot_validate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that adoption failed if an exception is raised&quot;&quot;&quot;</span>
        <span class="c1"># Note(TheJulia): Use of an actual possible exception that</span>
        <span class="c1"># can be raised due to a misconfiguration.</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IPMIFailure</span><span class="p">(</span>
            <span class="s2">&quot;something went wrong&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_adoption</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="n">mock_prepare</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">mock_take_over</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_start_console</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_boot_validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeBoot.validate&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeConsole.start_console&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.take_over&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.fake.FakeDeploy.prepare&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test__do_adoption_boot_validate_failure"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test__do_adoption_boot_validate_failure">[docs]</a>    <span class="k">def</span> <span class="nf">test__do_adoption_boot_validate_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                <span class="n">mock_prepare</span><span class="p">,</span>
                                                <span class="n">mock_take_over</span><span class="p">,</span>
                                                <span class="n">mock_start_console</span><span class="p">,</span>
                                                <span class="n">mock_boot_validate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test that adoption fails if the boot validation fails&quot;&quot;&quot;</span>
        <span class="c1"># Note(TheJulia): Use of an actual possible exception that</span>
        <span class="c1"># can be raised due to a misconfiguration.</span>
        <span class="n">mock_boot_validate</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span>
            <span class="s2">&quot;something is missing&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTING</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_adoption</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTFAIL</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_prepare</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_take_over</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_start_console</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_boot_validate</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test_do_provisioning_action_adopt_node"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test_do_provisioning_action_adopt_node">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provisioning_action_adopt_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test an adoption request results in the node in ADOPTING&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;adopt&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_adoption</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test_do_provisioning_action_adopt_node_retry"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test_do_provisioning_action_adopt_node_retry">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provisioning_action_adopt_node_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test a retried adoption from ADOPTFAIL results in ADOPTING state&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTFAIL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;adopt&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTING</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">_do_adoption</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span></div>

<div class="viewcode-block" id="DoNodeAdoptionTestCase.test_do_provisioning_action_manage_of_failed_adoption"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test_do_provisioning_action_manage_of_failed_adoption">[docs]</a>    <span class="k">def</span> <span class="nf">test_do_provisioning_action_manage_of_failed_adoption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test a node in ADOPTFAIL can be taken to MANAGEABLE&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ADOPTFAIL</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;manage&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">MANAGEABLE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">target_provision_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.manager.ConductorManager._spawn_worker&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="DoNodeAdoptionTestCase.test_heartbeat"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DoNodeAdoptionTestCase.test_heartbeat">[docs]</a>    <span class="k">def</span> <span class="nf">test_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_spawn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test heartbeating.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
            <span class="n">provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">DEPLOYING</span><span class="p">,</span>
            <span class="n">target_provision_state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;http://callback&#39;</span><span class="p">)</span>
        <span class="n">mock_spawn</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">deploy</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">,</span>
                                      <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;http://callback&#39;</span><span class="p">)</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DestroyVolumeConnectorTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeConnectorTestCase">[docs]</a><span class="k">class</span> <span class="nc">DestroyVolumeConnectorTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                     <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DestroyVolumeConnectorTestCase.test_destroy_volume_connector"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeConnectorTestCase.test_destroy_volume_connector">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_connector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_connector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_connector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeConnectorNotFound</span><span class="p">,</span>
                          <span class="n">volume_connector</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeConnectorNotFound</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_volume_connector_by_uuid</span><span class="p">,</span>
                          <span class="n">volume_connector</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyVolumeConnectorTestCase.test_destroy_volume_connector_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeConnectorTestCase.test_destroy_volume_connector_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_connector_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>

        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_connector</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_connector</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="UpdateVolumeConnectorTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdateVolumeConnectorTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                    <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateVolumeConnectorTestCase.test_update_volume_connector"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase.test_update_volume_connector">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_connector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">new_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">volume_connector</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">new_extra</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_connector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                   <span class="n">volume_connector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_extra</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateVolumeConnectorTestCase.test_update_volume_connector_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase.test_update_volume_connector_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_connector_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>

        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_connector</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_connector</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_connector</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateVolumeConnectorTestCase.test_update_volume_connector_type"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase.test_update_volume_connector_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_connector_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vol_id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake-id&#39;</span><span class="p">})</span>
        <span class="n">new_type</span> <span class="o">=</span> <span class="s1">&#39;wwnn&#39;</span>
        <span class="n">volume_connector</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_type</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_connector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                   <span class="n">volume_connector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_type</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateVolumeConnectorTestCase.test_update_volume_connector_uuid"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase.test_update_volume_connector_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_connector_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_connector</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_connector</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_connector</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_connector</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateVolumeConnectorTestCase.test_update_volume_connector_duplicate"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeConnectorTestCase.test_update_volume_connector_duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_connector_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_connector1</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_connector2</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_connector</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;diff_type&#39;</span><span class="p">)</span>
        <span class="n">volume_connector2</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">volume_connector1</span><span class="o">.</span><span class="n">type</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_connector</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_connector2</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeConnectorTypeAndIdAlreadyExists</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="DestroyVolumeTargetTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeTargetTestCase">[docs]</a><span class="k">class</span> <span class="nc">DestroyVolumeTargetTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                  <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DestroyVolumeTargetTestCase.test_destroy_volume_target"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeTargetTestCase.test_destroy_volume_target">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                            <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeTargetNotFound</span><span class="p">,</span>
                          <span class="n">volume_target</span><span class="o">.</span><span class="n">refresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeTargetNotFound</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">dbapi</span><span class="o">.</span><span class="n">get_volume_target_by_uuid</span><span class="p">,</span>
                          <span class="n">volume_target</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DestroyVolumeTargetTestCase.test_destroy_volume_target_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeTargetTestCase.test_destroy_volume_target_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_target_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>

        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                            <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="DestroyVolumeTargetTestCase.test_destroy_volume_target_node_gone"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeTargetTestCase.test_destroy_volume_target_node_gone">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_target_node_gone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                            <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="DestroyVolumeTargetTestCase.test_destroy_volume_target_already_destroyed"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.DestroyVolumeTargetTestCase.test_destroy_volume_target_already_destroyed">[docs]</a>    <span class="k">def</span> <span class="nf">test_destroy_volume_target_already_destroyed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                            <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">destroy_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeTargetNotFound</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<span class="nd">@mgr_utils.mock_record_keepalive</span>
<div class="viewcode-block" id="UpdateVolumeTargetTestCase"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdateVolumeTargetTestCase</span><span class="p">(</span><span class="n">mgr_utils</span><span class="o">.</span><span class="n">ServiceSetUpMixin</span><span class="p">,</span>
                                 <span class="n">tests_db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>

        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">new_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">volume_target</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">new_extra</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_extra</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">extra</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_node_locked"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_node_locked">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_node_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span>
                                          <span class="n">reservation</span><span class="o">=</span><span class="s1">&#39;fake-reserv&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                            <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_target</span><span class="o">.</span><span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_volume_type"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_volume_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_volume_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vol_id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake-id&#39;</span><span class="p">})</span>
        <span class="n">new_volume_type</span> <span class="o">=</span> <span class="s1">&#39;fibre_channel&#39;</span>
        <span class="n">volume_target</span><span class="o">.</span><span class="n">volume_type</span> <span class="o">=</span> <span class="n">new_volume_type</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                <span class="n">volume_target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_volume_type</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">volume_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_uuid"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_uuid">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_target</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_duplicate"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_duplicate">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target1</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">volume_target2</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">boot_index</span><span class="o">=</span><span class="n">volume_target1</span><span class="o">.</span><span class="n">boot_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">volume_target2</span><span class="o">.</span><span class="n">boot_index</span> <span class="o">=</span> <span class="n">volume_target1</span><span class="o">.</span><span class="n">boot_index</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target2</span><span class="p">)</span>
        <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">VolumeTargetBootIndexAlreadyExists</span><span class="p">,</span>
                         <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_test_update_volume_target_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_exc</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="n">volume_target</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_volume_target</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vol_id&#39;</span><span class="p">:</span> <span class="s1">&#39;fake-id&#39;</span><span class="p">})</span>
        <span class="n">new_volume_type</span> <span class="o">=</span> <span class="s1">&#39;fibre_channel&#39;</span>
        <span class="n">volume_target</span><span class="o">.</span><span class="n">volume_type</span> <span class="o">=</span> <span class="n">new_volume_type</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">objects</span><span class="o">.</span><span class="n">VolumeTarget</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_save</span><span class="p">:</span>
            <span class="n">mock_save</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">expected_exc</span><span class="p">(</span><span class="s1">&#39;Boo&#39;</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">messaging</span><span class="o">.</span><span class="n">rpc</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">update_volume_target</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">volume_target</span><span class="p">)</span>
            <span class="c1"># Compare true exception hidden by @messaging.expected_exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_exc</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_node_not_found"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_node_not_found">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_node_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_update_volume_target_exception</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeNotFound</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateVolumeTargetTestCase.test_update_volume_target_not_found"><a class="viewcode-back" href="../../../../../api/ironic.tests.unit.conductor.test_manager.html#ironic.tests.unit.conductor.test_manager.UpdateVolumeTargetTestCase.test_update_volume_target_not_found">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_volume_target_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_update_volume_target_exception</span><span class="p">(</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">VolumeTargetNotFound</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/ironic
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Ironic 7.0.1.dev7 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/Ironic");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>