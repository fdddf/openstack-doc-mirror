<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ironic.tests.unit.drivers.modules.test_deploy_utils &mdash; Ironic 7.0.1.dev7 documentation</title>
    
    <link rel="stylesheet" href="../../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/toggle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '7.0.1.dev7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../../_static/toggle.js"></script>
    <link rel="top" title="Ironic 7.0.1.dev7 documentation" href="../../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ironic.tests.unit.drivers.modules.test_deploy_utils</h1><div class="highlight"><pre>
<span></span><span class="c1">#    Copyright (c) 2012 NTT DOCOMO, INC.</span>
<span class="c1">#    Copyright 2011 OpenStack Foundation</span>
<span class="c1">#    Copyright 2011 Ilya Alekseyev</span>
<span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">from</span> <span class="nn">ironic_lib</span> <span class="kn">import</span> <span class="n">disk_utils</span>
<span class="kn">import</span> <span class="nn">mock</span>
<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">import</span> <span class="nn">testtools</span>
<span class="kn">from</span> <span class="nn">testtools</span> <span class="kn">import</span> <span class="n">matchers</span>

<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">boot_devices</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">image_service</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">common_utils</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">task_manager</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">manager_utils</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules</span> <span class="kn">import</span> <span class="n">agent_client</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules</span> <span class="kn">import</span> <span class="n">deploy_utils</span> <span class="k">as</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules</span> <span class="kn">import</span> <span class="n">image_cache</span>
<span class="kn">from</span> <span class="nn">ironic.drivers.modules</span> <span class="kn">import</span> <span class="n">pxe</span>
<span class="kn">from</span> <span class="nn">ironic.drivers</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">driver_utils</span>
<span class="kn">from</span> <span class="nn">ironic.tests</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">tests_base</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.conductor</span> <span class="kn">import</span> <span class="n">mgr_utils</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.db</span> <span class="kn">import</span> <span class="n">base</span> <span class="k">as</span> <span class="n">db_base</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.db</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">db_utils</span>
<span class="kn">from</span> <span class="nn">ironic.tests.unit.objects</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">obj_utils</span>

<span class="n">INST_INFO_DICT</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_test_pxe_instance_info</span><span class="p">()</span>
<span class="n">DRV_INFO_DICT</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_test_pxe_driver_info</span><span class="p">()</span>
<span class="n">DRV_INTERNAL_INFO_DICT</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_test_pxe_driver_internal_info</span><span class="p">()</span>

<span class="n">_PXECONF_DEPLOY</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default deploy</span>

<span class="s2">label deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">append initrd=deploy_ramdisk</span>
<span class="s2">ipappend 3</span>

<span class="s2">label boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root={{ ROOT }}</span>

<span class="s2">label boot_whole_disk</span>
<span class="s2">COM32 chain.c32</span>
<span class="s2">append mbr:{{ DISK_IDENTIFIER }}</span>

<span class="s2">label trusted_boot</span>
<span class="s2">kernel mboot</span>
<span class="s2">append tboot.gz --- kernel root={{ ROOT }} --- ramdisk</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_PXECONF_BOOT_PARTITION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default boot_partition</span>

<span class="s2">label deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">append initrd=deploy_ramdisk</span>
<span class="s2">ipappend 3</span>

<span class="s2">label boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root=UUID=12345678-1234-1234-1234-1234567890abcdef</span>

<span class="s2">label boot_whole_disk</span>
<span class="s2">COM32 chain.c32</span>
<span class="s2">append mbr:{{ DISK_IDENTIFIER }}</span>

<span class="s2">label trusted_boot</span>
<span class="s2">kernel mboot</span>
<span class="s2">append tboot.gz --- kernel root=UUID=12345678-1234-1234-1234-1234567890abcdef </span><span class="se">\</span>
<span class="s2">--- ramdisk</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_PXECONF_BOOT_WHOLE_DISK</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default boot_whole_disk</span>

<span class="s2">label deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">append initrd=deploy_ramdisk</span>
<span class="s2">ipappend 3</span>

<span class="s2">label boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root={{ ROOT }}</span>

<span class="s2">label boot_whole_disk</span>
<span class="s2">COM32 chain.c32</span>
<span class="s2">append mbr:0x12345678</span>

<span class="s2">label trusted_boot</span>
<span class="s2">kernel mboot</span>
<span class="s2">append tboot.gz --- kernel root={{ ROOT }} --- ramdisk</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_PXECONF_TRUSTED_BOOT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default trusted_boot</span>

<span class="s2">label deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">append initrd=deploy_ramdisk</span>
<span class="s2">ipappend 3</span>

<span class="s2">label boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root=UUID=12345678-1234-1234-1234-1234567890abcdef</span>

<span class="s2">label boot_whole_disk</span>
<span class="s2">COM32 chain.c32</span>
<span class="s2">append mbr:{{ DISK_IDENTIFIER }}</span>

<span class="s2">label trusted_boot</span>
<span class="s2">kernel mboot</span>
<span class="s2">append tboot.gz --- kernel root=UUID=12345678-1234-1234-1234-1234567890abcdef </span><span class="se">\</span>
<span class="s2">--- ramdisk</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_IPXECONF_DEPLOY</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#!ipxe</span>

<span class="s2">dhcp</span>

<span class="s2">goto deploy</span>

<span class="s2">:deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">initrd deploy_ramdisk</span>
<span class="s2">boot</span>

<span class="s2">:boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root={{ ROOT }}</span>
<span class="s2">boot</span>

<span class="s2">:boot_whole_disk</span>
<span class="s2">kernel chain.c32</span>
<span class="s2">append mbr:{{ DISK_IDENTIFIER }}</span>
<span class="s2">boot</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_IPXECONF_BOOT_PARTITION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#!ipxe</span>

<span class="s2">dhcp</span>

<span class="s2">goto boot_partition</span>

<span class="s2">:deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">initrd deploy_ramdisk</span>
<span class="s2">boot</span>

<span class="s2">:boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root=UUID=12345678-1234-1234-1234-1234567890abcdef</span>
<span class="s2">boot</span>

<span class="s2">:boot_whole_disk</span>
<span class="s2">kernel chain.c32</span>
<span class="s2">append mbr:{{ DISK_IDENTIFIER }}</span>
<span class="s2">boot</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_IPXECONF_BOOT_WHOLE_DISK</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">#!ipxe</span>

<span class="s2">dhcp</span>

<span class="s2">goto boot_whole_disk</span>

<span class="s2">:deploy</span>
<span class="s2">kernel deploy_kernel</span>
<span class="s2">initrd deploy_ramdisk</span>
<span class="s2">boot</span>

<span class="s2">:boot_partition</span>
<span class="s2">kernel kernel</span>
<span class="s2">append initrd=ramdisk root={{ ROOT }}</span>
<span class="s2">boot</span>

<span class="s2">:boot_whole_disk</span>
<span class="s2">kernel chain.c32</span>
<span class="s2">append mbr:0x12345678</span>
<span class="s2">boot</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_DEPLOY</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default=deploy</span>

<span class="s2">image=deploy_kernel</span>
<span class="s2">        label=deploy</span>
<span class="s2">        initrd=deploy_ramdisk</span>
<span class="s2">        append=&quot;ro text&quot;</span>

<span class="s2">image=kernel</span>
<span class="s2">        label=boot_partition</span>
<span class="s2">        initrd=ramdisk</span>
<span class="s2">        append=&quot;root={{ ROOT }}&quot;</span>

<span class="s2">image=chain.c32</span>
<span class="s2">        label=boot_whole_disk</span>
<span class="s2">        append=&quot;mbr:{{ DISK_IDENTIFIER }}&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_BOOT_PARTITION</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default=boot_partition</span>

<span class="s2">image=deploy_kernel</span>
<span class="s2">        label=deploy</span>
<span class="s2">        initrd=deploy_ramdisk</span>
<span class="s2">        append=&quot;ro text&quot;</span>

<span class="s2">image=kernel</span>
<span class="s2">        label=boot_partition</span>
<span class="s2">        initrd=ramdisk</span>
<span class="s2">        append=&quot;root=UUID=12345678-1234-1234-1234-1234567890abcdef&quot;</span>

<span class="s2">image=chain.c32</span>
<span class="s2">        label=boot_whole_disk</span>
<span class="s2">        append=&quot;mbr:{{ DISK_IDENTIFIER }}&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_BOOT_WHOLE_DISK</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">default=boot_whole_disk</span>

<span class="s2">image=deploy_kernel</span>
<span class="s2">        label=deploy</span>
<span class="s2">        initrd=deploy_ramdisk</span>
<span class="s2">        append=&quot;ro text&quot;</span>

<span class="s2">image=kernel</span>
<span class="s2">        label=boot_partition</span>
<span class="s2">        initrd=ramdisk</span>
<span class="s2">        append=&quot;root={{ ROOT }}&quot;</span>

<span class="s2">image=chain.c32</span>
<span class="s2">        label=boot_whole_disk</span>
<span class="s2">        append=&quot;mbr:0x12345678&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_DEPLOY_GRUB</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">set default=deploy</span>
<span class="s2">set timeout=5</span>
<span class="s2">set hidden_timeout_quiet=false</span>

<span class="s2">menuentry &quot;deploy&quot;  {</span>
<span class="s2">    linuxefi deploy_kernel &quot;ro text&quot;</span>
<span class="s2">    initrdefi deploy_ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_partition&quot;  {</span>
<span class="s2">    linuxefi kernel &quot;root=(( ROOT ))&quot;</span>
<span class="s2">    initrdefi ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_whole_disk&quot;  {</span>
<span class="s2">    linuxefi chain.c32 mbr:(( DISK_IDENTIFIER ))</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_BOOT_PARTITION_GRUB</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">set default=boot_partition</span>
<span class="s2">set timeout=5</span>
<span class="s2">set hidden_timeout_quiet=false</span>

<span class="s2">menuentry &quot;deploy&quot;  {</span>
<span class="s2">    linuxefi deploy_kernel &quot;ro text&quot;</span>
<span class="s2">    initrdefi deploy_ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_partition&quot;  {</span>
<span class="s2">    linuxefi kernel &quot;root=UUID=12345678-1234-1234-1234-1234567890abcdef&quot;</span>
<span class="s2">    initrdefi ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_whole_disk&quot;  {</span>
<span class="s2">    linuxefi chain.c32 mbr:(( DISK_IDENTIFIER ))</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_UEFI_PXECONF_BOOT_WHOLE_DISK_GRUB</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">set default=boot_whole_disk</span>
<span class="s2">set timeout=5</span>
<span class="s2">set hidden_timeout_quiet=false</span>

<span class="s2">menuentry &quot;deploy&quot;  {</span>
<span class="s2">    linuxefi deploy_kernel &quot;ro text&quot;</span>
<span class="s2">    initrdefi deploy_ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_partition&quot;  {</span>
<span class="s2">    linuxefi kernel &quot;root=(( ROOT ))&quot;</span>
<span class="s2">    initrdefi ramdisk</span>
<span class="s2">}</span>

<span class="s2">menuentry &quot;boot_whole_disk&quot;  {</span>
<span class="s2">    linuxefi chain.c32 mbr:0x12345678</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;sleep&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">seconds</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase">[docs]</a><span class="k">class</span> <span class="nc">PhysicalWorkTestCase</span><span class="p">(</span><span class="n">tests_base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_mock_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_list</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="n">patch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="n">spec_set</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_list</span><span class="p">]</span>
        <span class="n">mock_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">patcher</span> <span class="ow">in</span> <span class="n">patch_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">patcher</span> <span class="ow">in</span> <span class="n">patch_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

        <span class="n">parent_mock</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="p">[])</span>
        <span class="k">for</span> <span class="n">mocker</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mock_list</span><span class="p">,</span> <span class="n">name_list</span><span class="p">):</span>
            <span class="n">parent_mock</span><span class="o">.</span><span class="n">attach_mock</span><span class="p">(</span><span class="n">mocker</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_mock</span>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;work_on_disk&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;is_block_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;get_image_mb&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;logout_iscsi&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;login_iscsi&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;get_dev&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;delete_iscsi&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_deploy_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">mock_delete_iscsi</span><span class="p">,</span>
                                     <span class="n">mock_discovery</span><span class="p">,</span>
                                     <span class="n">mock_get_dev</span><span class="p">,</span>
                                     <span class="n">mock_login_iscsi</span><span class="p">,</span>
                                     <span class="n">mock_logout_iscsi</span><span class="p">,</span>
                                     <span class="n">mock_get_image_mb</span><span class="p">,</span>
                                     <span class="n">mock_is_block_device</span><span class="p">,</span>
                                     <span class="n">mock_work_on_disk</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Below are the only values we allow callers to modify for testing.</span>
        <span class="c1"># Check that values other than this aren&#39;t passed in.</span>
        <span class="n">deploy_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;boot_mode&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;boot_option&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;disk_label&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;ephemeral_format&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;ephemeral_mb&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s1">&#39;image_mb&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s1">&#39;root_mb&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">64</span>
        <span class="p">}</span>
        <span class="n">disallowed_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">deploy_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disallowed_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only the following kwargs are allowed in &quot;</span>
                             <span class="s2">&quot;_test_deploy_partition_image: </span><span class="si">%(allowed)s</span><span class="s2">. &quot;</span>
                             <span class="s2">&quot;Disallowed values: </span><span class="si">%(disallowed)s</span><span class="s2">.&quot;</span>
                             <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;allowed&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                <span class="s2">&quot;disallowed&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">disallowed_values</span><span class="p">)})</span>
        <span class="n">deploy_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/xyz/image&#39;</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="s2">&quot;12345678-1234-1234-1234-1234567890abcxyz&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>
        <span class="n">root_uuid</span> <span class="o">=</span> <span class="s1">&#39;12345678-1234-1234-12345678-12345678abcdef&#39;</span>

        <span class="n">mock_get_dev</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">dev</span>
        <span class="n">mock_is_block_device</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mock_get_image_mb</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;image_mb&#39;</span><span class="p">]</span>
        <span class="n">mock_work_on_disk</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;root uuid&#39;</span><span class="p">:</span> <span class="n">root_uuid</span><span class="p">,</span>
            <span class="s1">&#39;efi system partition uuid&#39;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span>

        <span class="n">deploy_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;boot_mode&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;boot_mode&#39;</span><span class="p">],</span>
            <span class="s1">&#39;boot_option&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;boot_option&#39;</span><span class="p">],</span>
            <span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">],</span>
            <span class="s1">&#39;disk_label&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;disk_label&#39;</span><span class="p">],</span>
            <span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">deploy_partition_image</span><span class="p">(</span>
            <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;root_mb&#39;</span><span class="p">],</span>
            <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">],</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;ephemeral_mb&#39;</span><span class="p">],</span>
            <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">],</span> <span class="n">node_uuid</span><span class="p">,</span> <span class="o">**</span><span class="n">deploy_kwargs</span><span class="p">)</span>

        <span class="n">mock_get_dev</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span>
        <span class="n">mock_discovery</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">mock_login_iscsi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_logout_iscsi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_delete_iscsi</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_get_image_mb</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">mock_is_block_device</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>

        <span class="n">work_on_disk_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">],</span>
            <span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">],</span>
            <span class="c1"># boot_option defaults to &#39;netboot&#39; if</span>
            <span class="c1"># not set</span>
            <span class="s1">&#39;boot_option&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;boot_option&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;netboot&#39;</span><span class="p">,</span>
            <span class="s1">&#39;boot_mode&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;boot_mode&#39;</span><span class="p">],</span>
            <span class="s1">&#39;disk_label&#39;</span><span class="p">:</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;disk_label&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">mock_work_on_disk</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">dev</span><span class="p">,</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;root_mb&#39;</span><span class="p">],</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">],</span>
            <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;ephemeral_mb&#39;</span><span class="p">],</span> <span class="n">deploy_args</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">],</span>
            <span class="n">image_path</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">,</span> <span class="o">**</span><span class="n">work_on_disk_kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_without_boot_option"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_without_boot_option">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_without_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">()</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_netboot"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_netboot">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_netboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;netboot&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_localboot"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_localboot">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_localboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_wo_boot_option_and_wo_boot_mode"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_wo_boot_option_and_wo_boot_mode">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_wo_boot_option_and_wo_boot_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">()</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_netboot_bios"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_netboot_bios">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_netboot_bios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;netboot&quot;</span><span class="p">,</span>
                                          <span class="n">boot_mode</span><span class="o">=</span><span class="s2">&quot;bios&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_localboot_bios"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_localboot_bios">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_localboot_bios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                                          <span class="n">boot_mode</span><span class="o">=</span><span class="s2">&quot;bios&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_netboot_uefi"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_netboot_uefi">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_netboot_uefi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;netboot&quot;</span><span class="p">,</span>
                                          <span class="n">boot_mode</span><span class="o">=</span><span class="s2">&quot;uefi&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_disk_label"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_disk_label">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_disk_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">disk_label</span><span class="o">=</span><span class="s1">&#39;gpt&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_image_exceeds_root_partition"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_image_exceeds_root_partition">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_image_exceeds_root_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">,</span> <span class="n">image_mb</span><span class="o">=</span><span class="mi">129</span><span class="p">,</span>
                          <span class="n">root_mb</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_localboot_uefi"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_localboot_uefi">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_localboot_uefi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                                          <span class="n">boot_mode</span><span class="o">=</span><span class="s2">&quot;uefi&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_without_swap"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_without_swap">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_without_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">swap_mb</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_with_ephemeral"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_with_ephemeral">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_with_ephemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">ephemeral_format</span><span class="o">=</span><span class="s1">&#39;exttest&#39;</span><span class="p">,</span>
                                          <span class="n">ephemeral_mb</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_preserve_ephemeral"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_preserve_ephemeral">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_preserve_ephemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">ephemeral_format</span><span class="o">=</span><span class="s1">&#39;exttest&#39;</span><span class="p">,</span>
                                          <span class="n">ephemeral_mb</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                                          <span class="n">preserve_ephemeral</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_partition_image_with_configdrive"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_partition_image_with_configdrive">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_partition_image_with_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_deploy_partition_image</span><span class="p">(</span><span class="n">configdrive</span><span class="o">=</span><span class="s1">&#39;http://1.2.3.4/cd&#39;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;create_config_drive_partition&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;get_disk_identifier&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_gdi</span><span class="p">,</span> <span class="n">create_config_drive_mock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check loosely all functions are called with right args.&quot;&quot;&quot;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/xyz/image&#39;</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="s2">&quot;12345678-1234-1234-1234-1234567890abcxyz&quot;</span>

        <span class="n">dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>
        <span class="n">utils_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span> <span class="s1">&#39;login_iscsi&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;logout_iscsi&#39;</span><span class="p">,</span> <span class="s1">&#39;delete_iscsi&#39;</span><span class="p">]</span>
        <span class="n">disk_utils_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is_block_device&#39;</span><span class="p">,</span> <span class="s1">&#39;populate_image&#39;</span><span class="p">]</span>

        <span class="n">utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">utils_name_list</span><span class="p">,</span> <span class="n">utils</span><span class="p">)</span>
        <span class="n">utils_mock</span><span class="o">.</span><span class="n">get_dev</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">dev</span>

        <span class="n">disk_utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">disk_utils_name_list</span><span class="p">,</span> <span class="n">disk_utils</span><span class="p">)</span>
        <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">is_block_device</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mock_gdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;0x12345678&#39;</span>
        <span class="n">utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">get_dev</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">discovery</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">login_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">logout_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">delete_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)]</span>
        <span class="n">disk_utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">is_block_device</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
                                     <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">populate_image</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dev</span><span class="p">)]</span>

        <span class="n">uuid_dict_returned</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">deploy_disk_image</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
                                                     <span class="n">image_path</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">,</span>
                                                     <span class="n">configdrive</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">utils_calls_expected</span><span class="p">,</span> <span class="n">utils_mock</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">disk_utils_calls_expected</span><span class="p">,</span> <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">create_config_drive_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span> <span class="n">uuid_dict_returned</span><span class="p">[</span><span class="s1">&#39;disk identifier&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;create_config_drive_partition&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;get_disk_identifier&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_deploy_whole_disk_image_with_config_drive"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_deploy_whole_disk_image_with_config_drive">[docs]</a>    <span class="k">def</span> <span class="nf">test_deploy_whole_disk_image_with_config_drive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_gdi</span><span class="p">,</span>
                                                       <span class="n">create_partition_mock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check loosely all functions are called with right args.&quot;&quot;&quot;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/xyz/image&#39;</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="s2">&quot;12345678-1234-1234-1234-1234567890abcxyz&quot;</span>
        <span class="n">config_url</span> <span class="o">=</span> <span class="s1">&#39;http://1.2.3.4/cd&#39;</span>

        <span class="n">dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>
        <span class="n">utils_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span> <span class="s1">&#39;login_iscsi&#39;</span><span class="p">,</span> <span class="s1">&#39;logout_iscsi&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;delete_iscsi&#39;</span><span class="p">]</span>

        <span class="n">disk_utils_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;is_block_device&#39;</span><span class="p">,</span> <span class="s1">&#39;populate_image&#39;</span><span class="p">]</span>
        <span class="n">utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">utils_list</span><span class="p">,</span> <span class="n">utils</span><span class="p">)</span>
        <span class="n">disk_utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">disk_utils_list</span><span class="p">,</span> <span class="n">disk_utils</span><span class="p">)</span>
        <span class="n">utils_mock</span><span class="o">.</span><span class="n">get_dev</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">dev</span>
        <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">is_block_device</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">mock_gdi</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;0x12345678&#39;</span>
        <span class="n">utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">get_dev</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">discovery</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">login_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">logout_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">delete_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)]</span>

        <span class="n">disk_utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">is_block_device</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
                                     <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">populate_image</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">dev</span><span class="p">)]</span>

        <span class="n">uuid_dict_returned</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">deploy_disk_image</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
                                                     <span class="n">image_path</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">,</span>
                                                     <span class="n">configdrive</span><span class="o">=</span><span class="n">config_url</span><span class="p">)</span>

        <span class="n">utils_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span><span class="n">utils_calls_expected</span><span class="p">)</span>
        <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span><span class="n">disk_utils_calls_expected</span><span class="p">)</span>
        <span class="n">create_partition_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
                                                      <span class="n">config_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span> <span class="n">uuid_dict_returned</span><span class="p">[</span><span class="s1">&#39;disk identifier&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">common_utils</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_verify_iscsi_connection_raises"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_verify_iscsi_connection_raises">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_iscsi_connection_raises</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_exec</span><span class="p">):</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iqn.abc&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">verify_iscsi_connection</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">mock_exec</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_check_file_system_for_iscsi_device_raises"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_check_file_system_for_iscsi_device_raises">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_file_system_for_iscsi_device_raises</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_os</span><span class="p">):</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;22&quot;</span>
        <span class="n">mock_os</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">check_file_system_for_iscsi_device</span><span class="p">,</span>
                          <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">mock_os</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_check_file_system_for_iscsi_device"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_check_file_system_for_iscsi_device">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_file_system_for_iscsi_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_os</span><span class="p">):</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;22&quot;</span>
        <span class="n">check_dir</span> <span class="o">=</span> <span class="s2">&quot;/dev/disk/by-path/ip-</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">-iscsi-</span><span class="si">%s</span><span class="s2">-lun-1&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip</span><span class="p">,</span>
                                                                   <span class="n">port</span><span class="p">,</span>
                                                                   <span class="n">iqn</span><span class="p">)</span>

        <span class="n">mock_os</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">check_file_system_for_iscsi_device</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_os</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">check_dir</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">common_utils</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_verify_iscsi_connection"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_verify_iscsi_connection">[docs]</a>    <span class="k">def</span> <span class="nf">test_verify_iscsi_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_exec</span><span class="p">):</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iqn.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">verify_iscsi_connection</span><span class="p">(</span><span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s1">&#39;iscsiadm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-S&#39;</span><span class="p">,</span>
            <span class="n">run_as_root</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">check_exit_code</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">common_utils</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_force_iscsi_lun_update"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_force_iscsi_lun_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_force_iscsi_lun_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_exec</span><span class="p">):</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">force_iscsi_lun_update</span><span class="p">(</span><span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s1">&#39;iscsiadm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-T&#39;</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span>
            <span class="s1">&#39;-R&#39;</span><span class="p">,</span>
            <span class="n">run_as_root</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">check_exit_code</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">common_utils</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;verify_iscsi_connection&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;force_iscsi_lun_update&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;check_file_system_for_iscsi_device&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_login_iscsi_calls_verify_and_update"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_login_iscsi_calls_verify_and_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_login_iscsi_calls_verify_and_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">mock_check_dev</span><span class="p">,</span>
                                                 <span class="n">mock_update</span><span class="p">,</span>
                                                 <span class="n">mock_verify</span><span class="p">,</span>
                                                 <span class="n">mock_exec</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iqn.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">login_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s1">&#39;iscsiadm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
            <span class="s1">&#39;-T&#39;</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span>
            <span class="s1">&#39;--login&#39;</span><span class="p">,</span>
            <span class="n">run_as_root</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">check_exit_code</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">delay_on_retry</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">mock_verify</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">iqn</span><span class="p">)</span>

        <span class="n">mock_update</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">iqn</span><span class="p">)</span>

        <span class="n">mock_check_dev</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">common_utils</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;verify_iscsi_connection&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;force_iscsi_lun_update&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;check_file_system_for_iscsi_device&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_ipv6_address_wrapped"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_ipv6_address_wrapped">[docs]</a>    <span class="k">def</span> <span class="nf">test_ipv6_address_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">mock_check_dev</span><span class="p">,</span>
                                  <span class="n">mock_update</span><span class="p">,</span>
                                  <span class="n">mock_verify</span><span class="p">,</span>
                                  <span class="n">mock_exec</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;2001:DB8::1111&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iqn.xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">login_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)</span>
        <span class="n">mock_exec</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="s1">&#39;iscsiadm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
            <span class="s1">&#39;-T&#39;</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span>
            <span class="s1">&#39;--login&#39;</span><span class="p">,</span>
            <span class="n">run_as_root</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">check_exit_code</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">delay_on_retry</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;is_block_device&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="PhysicalWorkTestCase.test_always_logout_and_delete_iscsi"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.PhysicalWorkTestCase.test_always_logout_and_delete_iscsi">[docs]</a>    <span class="k">def</span> <span class="nf">test_always_logout_and_delete_iscsi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if logout_iscsi() and delete_iscsi() are called.</span>

<span class="sd">        Make sure that logout_iscsi() and delete_iscsi() are called once</span>
<span class="sd">        login_iscsi() is invoked.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/xyz/image&#39;</span>
        <span class="n">root_mb</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">swap_mb</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">ephemeral_mb</span> <span class="o">=</span> <span class="mi">256</span>
        <span class="n">ephemeral_format</span> <span class="o">=</span> <span class="s1">&#39;exttest&#39;</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="s2">&quot;12345678-1234-1234-1234-1234567890abcxyz&quot;</span>

        <span class="n">dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>

        <span class="k">class</span> <span class="nc">TestException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="n">utils_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span> <span class="s1">&#39;login_iscsi&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;logout_iscsi&#39;</span><span class="p">,</span> <span class="s1">&#39;delete_iscsi&#39;</span><span class="p">]</span>

        <span class="n">disk_utils_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;get_image_mb&#39;</span><span class="p">,</span> <span class="s1">&#39;work_on_disk&#39;</span><span class="p">]</span>

        <span class="n">utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">utils_name_list</span><span class="p">,</span> <span class="n">utils</span><span class="p">)</span>
        <span class="n">utils_mock</span><span class="o">.</span><span class="n">get_dev</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">dev</span>

        <span class="n">disk_utils_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mock_calls</span><span class="p">(</span><span class="n">disk_utils_name_list</span><span class="p">,</span> <span class="n">disk_utils</span><span class="p">)</span>
        <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">get_image_mb</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">work_on_disk</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">TestException</span>
        <span class="n">utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">get_dev</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">discovery</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">login_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">logout_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">),</span>
                                <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">delete_iscsi</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">)]</span>
        <span class="n">disk_utils_calls_expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">get_image_mb</span><span class="p">(</span><span class="n">image_path</span><span class="p">),</span>
                                     <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">work_on_disk</span><span class="p">(</span>
                                         <span class="n">dev</span><span class="p">,</span> <span class="n">root_mb</span><span class="p">,</span> <span class="n">swap_mb</span><span class="p">,</span>
                                         <span class="n">ephemeral_mb</span><span class="p">,</span>
                                         <span class="n">ephemeral_format</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span>
                                         <span class="n">node_uuid</span><span class="p">,</span> <span class="n">configdrive</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                         <span class="n">preserve_ephemeral</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">boot_option</span><span class="o">=</span><span class="s2">&quot;netboot&quot;</span><span class="p">,</span>
                                         <span class="n">boot_mode</span><span class="o">=</span><span class="s2">&quot;bios&quot;</span><span class="p">,</span>
                                         <span class="n">disk_label</span><span class="o">=</span><span class="bp">None</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">TestException</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">deploy_partition_image</span><span class="p">,</span>
                          <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span>
                          <span class="n">root_mb</span><span class="p">,</span> <span class="n">swap_mb</span><span class="p">,</span> <span class="n">ephemeral_mb</span><span class="p">,</span> <span class="n">ephemeral_format</span><span class="p">,</span>
                          <span class="n">node_uuid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">utils_calls_expected</span><span class="p">,</span> <span class="n">utils_mock</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">disk_utils_calls_expected</span><span class="p">,</span> <span class="n">disk_utils_mock</span><span class="o">.</span><span class="n">mock_calls</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SwitchPxeConfigTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase">[docs]</a><span class="k">class</span> <span class="nc">SwitchPxeConfigTestCase</span><span class="p">(</span><span class="n">tests_base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_create_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipxe</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">boot_mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">boot_loader</span><span class="o">=</span><span class="s1">&#39;elilo&#39;</span><span class="p">):</span>
        <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">boot_mode</span> <span class="o">==</span> <span class="s1">&#39;uefi&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ipxe</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">boot_loader</span> <span class="o">==</span> <span class="s1">&#39;grub&#39;</span><span class="p">:</span>
                <span class="n">pxe_cfg</span> <span class="o">=</span> <span class="n">_UEFI_PXECONF_DEPLOY_GRUB</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pxe_cfg</span> <span class="o">=</span> <span class="n">_UEFI_PXECONF_DEPLOY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pxe_cfg</span> <span class="o">=</span> <span class="n">_IPXECONF_DEPLOY</span> <span class="k">if</span> <span class="n">ipxe</span> <span class="k">else</span> <span class="n">_PXECONF_DEPLOY</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">pxe_cfg</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname</span>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_pxe_config_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_pxe_config_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_pxe_config_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;bios&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_PXECONF_BOOT_PARTITION</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_pxe_config_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_pxe_config_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_pxe_config_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;bios&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_PXECONF_BOOT_WHOLE_DISK</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_pxe_config_trusted_boot"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_pxe_config_trusted_boot">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_pxe_config_trusted_boot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;bios&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_PXECONF_TRUSTED_BOOT</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_ipxe_config_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_ipxe_config_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_ipxe_config_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;bios&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;ipxe_enabled&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">ipxe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_IPXECONF_BOOT_PARTITION</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_ipxe_config_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_ipxe_config_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_ipxe_config_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;bios&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;ipxe_enabled&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">ipxe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_IPXECONF_BOOT_WHOLE_DISK</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_elilo_pxe_config_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_elilo_pxe_config_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_elilo_pxe_config_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_UEFI_PXECONF_BOOT_PARTITION</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_elilo_config_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_elilo_config_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_elilo_config_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_UEFI_PXECONF_BOOT_WHOLE_DISK</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_grub_pxe_config_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_grub_pxe_config_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_grub_pxe_config_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">,</span> <span class="n">boot_loader</span><span class="o">=</span><span class="s1">&#39;grub&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_UEFI_PXECONF_BOOT_PARTITION_GRUB</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_grub_config_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_grub_config_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_grub_config_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">,</span> <span class="n">boot_loader</span><span class="o">=</span><span class="s1">&#39;grub&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_UEFI_PXECONF_BOOT_WHOLE_DISK_GRUB</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_ipxe_config_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_ipxe_config_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_ipxe_config_partition_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;ipxe_enabled&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">,</span> <span class="n">ipxe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;12345678-1234-1234-1234-1234567890abcdef&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_IPXECONF_BOOT_PARTITION</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div>

<div class="viewcode-block" id="SwitchPxeConfigTestCase.test_switch_uefi_ipxe_config_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.SwitchPxeConfigTestCase.test_switch_uefi_ipxe_config_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_switch_uefi_ipxe_config_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boot_mode</span> <span class="o">=</span> <span class="s1">&#39;uefi&#39;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;ipxe_enabled&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_config</span><span class="p">(</span><span class="n">boot_mode</span><span class="o">=</span><span class="n">boot_mode</span><span class="p">,</span> <span class="n">ipxe</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">switch_pxe_config</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span>
                                <span class="s1">&#39;0x12345678&#39;</span><span class="p">,</span>
                                <span class="n">boot_mode</span><span class="p">,</span>
                                <span class="bp">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pxeconf</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">_IPXECONF_BOOT_WHOLE_DISK</span><span class="p">,</span> <span class="n">pxeconf</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GetPxeBootConfigTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase">[docs]</a><span class="k">class</span> <span class="nc">GetPxeBootConfigTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GetPxeBootConfigTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name</span><span class="o">=</span><span class="s1">&#39;bios-bootfile&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">uefi_pxe_bootfile_name</span><span class="o">=</span><span class="s1">&#39;uefi-bootfile&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template</span><span class="o">=</span><span class="s1">&#39;bios-template&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">uefi_pxe_config_template</span><span class="o">=</span><span class="s1">&#39;uefi-template&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bootfile_by_arch</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aarch64&#39;</span><span class="p">:</span> <span class="s1">&#39;aarch64-bootfile&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;ppc64&#39;</span><span class="p">:</span> <span class="s1">&#39;ppc64-bootfile&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_by_arch</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aarch64&#39;</span><span class="p">:</span> <span class="s1">&#39;aarch64-template&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;ppc64&#39;</span><span class="p">:</span> <span class="s1">&#39;ppc64-template&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_boot_file_bios_without_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_boot_file_bios_without_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_boot_file_bios_without_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:bios&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name_by_arch</span><span class="o">=</span><span class="p">{},</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_boot_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-bootfile&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_config_template_bios_without_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_config_template_bios_without_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_config_template_bios_without_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:bios&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template_by_arch</span><span class="o">=</span><span class="p">{},</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_config_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-template&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_boot_file_uefi_without_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_boot_file_uefi_without_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_boot_file_uefi_without_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name_by_arch</span><span class="o">=</span><span class="p">{},</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_boot_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;uefi-bootfile&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_config_template_uefi_without_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_config_template_uefi_without_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_config_template_uefi_without_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template_by_arch</span><span class="o">=</span><span class="p">{},</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_config_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;uefi-template&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_boot_file_cpu_not_in_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_boot_file_cpu_not_in_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_boot_file_cpu_not_in_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:bios&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bootfile_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_boot_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-bootfile&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_config_template_cpu_not_in_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_config_template_cpu_not_in_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_config_template_cpu_not_in_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;x86&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:bios&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_config_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-template&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_boot_file_cpu_in_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_boot_file_cpu_in_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_boot_file_cpu_in_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;aarch64&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bootfile_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_boot_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aarch64-bootfile&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_config_template_cpu_in_by_arch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_config_template_cpu_in_by_arch">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_config_template_cpu_in_by_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cpu_arch&#39;</span><span class="p">:</span> <span class="s1">&#39;aarch64&#39;</span><span class="p">,</span> <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_config_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aarch64-template&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_boot_file_emtpy_property"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_boot_file_emtpy_property">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_boot_file_emtpy_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_bootfile_name_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bootfile_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_boot_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-bootfile&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="GetPxeBootConfigTestCase.test_get_pxe_config_template_emtpy_property"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.GetPxeBootConfigTestCase.test_get_pxe_config_template_emtpy_property">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_pxe_config_template_emtpy_property</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">pxe_config_template_by_arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_by_arch</span><span class="p">,</span>
                    <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_pxe_config_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios-template&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div></div>


<span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;time.sleep&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">sec</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase">[docs]</a><span class="k">class</span> <span class="nc">OtherFunctionTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="OtherFunctionTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OtherFunctionTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s2">&quot;fake_pxe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OtherFunctionTestCase.test_get_dev"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_dev">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_dev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;/dev/disk/by-path/ip-1.2.3.4:5678-iscsi-iqn.fake-lun-9&#39;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_dev</span><span class="p">(</span><span class="s1">&#39;1.2.3.4&#39;</span><span class="p">,</span> <span class="mi">5678</span><span class="p">,</span> <span class="s1">&#39;iqn.fake&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager_utils</span><span class="p">,</span> <span class="s1">&#39;node_power_action&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">task_manager</span><span class="o">.</span><span class="n">TaskManager</span><span class="p">,</span> <span class="s1">&#39;process_event&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_set_failed_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_event</span><span class="p">,</span> <span class="n">mock_power</span><span class="p">,</span> <span class="n">mock_log</span><span class="p">,</span>
                               <span class="n">event_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">power_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                               <span class="n">log_calls</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">poweroff</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                               <span class="n">collect_logs</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;some failure&#39;</span>
        <span class="n">mock_event</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">event_value</span>
        <span class="n">mock_power</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">power_value</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">collect_logs</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">set_failed_state</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">set_failed_state</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">,</span>
                                       <span class="n">collect_logs</span><span class="o">=</span><span class="n">collect_logs</span><span class="p">)</span>
            <span class="n">mock_event</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;fail&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">poweroff</span><span class="p">:</span>
                <span class="n">mock_power</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_power</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">last_error</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">log_calls</span> <span class="ow">and</span> <span class="n">poweroff</span><span class="p">):</span>
                <span class="n">mock_log</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">assert_has_calls</span><span class="p">(</span><span class="n">log_calls</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_log</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_utils</span><span class="p">,</span> <span class="s1">&#39;collect_ramdisk_logs&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_set_failed_state"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_set_failed_state">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_failed_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_collect</span><span class="p">):</span>
        <span class="n">exc_state</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">(</span><span class="s1">&#39;invalid state&#39;</span><span class="p">)</span>
        <span class="n">exc_param</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;invalid parameter&#39;</span><span class="p">)</span>
        <span class="n">mock_call</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">()</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">event_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_state</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">power_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">,</span> <span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">event_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_state</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">power_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">mock_collect</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_utils</span><span class="p">,</span> <span class="s1">&#39;collect_ramdisk_logs&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_set_failed_state_no_poweroff"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_set_failed_state_no_poweroff">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_failed_state_no_poweroff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_collect</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;power_off_after_deploy_failure&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">exc_state</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidState</span><span class="p">(</span><span class="s1">&#39;invalid state&#39;</span><span class="p">)</span>
        <span class="n">exc_param</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="s1">&#39;invalid parameter&#39;</span><span class="p">)</span>
        <span class="n">mock_call</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">poweroff</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">event_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_state</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">,</span> <span class="n">poweroff</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">power_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">,</span> <span class="n">poweroff</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">calls</span> <span class="o">=</span> <span class="p">[</span><span class="n">mock_call</span><span class="p">,</span> <span class="n">mock_call</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">event_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_state</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">power_value</span><span class="o">=</span><span class="nb">iter</span><span class="p">([</span><span class="n">exc_param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">calls</span><span class="p">)),</span>
                                    <span class="n">log_calls</span><span class="o">=</span><span class="n">calls</span><span class="p">,</span> <span class="n">poweroff</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">mock_collect</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_utils</span><span class="p">,</span> <span class="s1">&#39;collect_ramdisk_logs&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_failed_state_collect_deploy_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_collect</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="s1">&#39;on_failure&#39;</span><span class="p">):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;deploy_logs_collect&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">()</span>
            <span class="n">mock_collect</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
            <span class="n">mock_collect</span><span class="o">.</span><span class="n">reset_mock</span><span class="p">()</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_utils</span><span class="p">,</span> <span class="s1">&#39;collect_ramdisk_logs&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs_never"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs_never">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_failed_state_collect_deploy_logs_never</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_collect</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;deploy_logs_collect&#39;</span><span class="p">,</span> <span class="s1">&#39;never&#39;</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_collect</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">driver_utils</span><span class="p">,</span> <span class="s1">&#39;collect_ramdisk_logs&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs_overide"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_set_failed_state_collect_deploy_logs_overide">[docs]</a>    <span class="k">def</span> <span class="nf">test_set_failed_state_collect_deploy_logs_overide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_collect</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;deploy_logs_collect&#39;</span><span class="p">,</span> <span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="s1">&#39;agent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_set_failed_state</span><span class="p">(</span><span class="n">collect_logs</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_collect</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

<div class="viewcode-block" id="OtherFunctionTestCase.test_get_boot_option"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_boot_option">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;{&quot;boot_option&quot;: &quot;local&quot;}&#39;</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="OtherFunctionTestCase.test_get_boot_option_default_value"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_boot_option_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_option_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;netboot&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="OtherFunctionTestCase.test_get_boot_option_overriden_default_value"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_boot_option_overriden_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_option_overriden_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;default_boot_option&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="OtherFunctionTestCase.test_get_boot_option_instance_info_priority"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_boot_option_instance_info_priority">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_option_instance_info_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;default_boot_option&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span>
                                   <span class="s1">&#39;{&quot;boot_option&quot;: &quot;netboot&quot;}&#39;</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s2">&quot;netboot&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_cache</span><span class="p">,</span> <span class="s1">&#39;clean_up_caches&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_fetch_images"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_fetch_images">[docs]</a>    <span class="k">def</span> <span class="nf">test_fetch_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_clean_up_caches</span><span class="p">):</span>

        <span class="n">mock_cache</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span>
            <span class="n">spec_set</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fetch_image&#39;</span><span class="p">,</span> <span class="s1">&#39;master_dir&#39;</span><span class="p">],</span> <span class="n">master_dir</span><span class="o">=</span><span class="s1">&#39;master_dir&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">fetch_images</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">mock_cache</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)])</span>
        <span class="n">mock_clean_up_caches</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;master_dir&#39;</span><span class="p">,</span>
                                                     <span class="p">[(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)])</span>
        <span class="n">mock_cache</span><span class="o">.</span><span class="n">fetch_image</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span>
                                                       <span class="n">ctx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                                       <span class="n">force_raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_cache</span><span class="p">,</span> <span class="s1">&#39;clean_up_caches&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_fetch_images_fail"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_fetch_images_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_fetch_images_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_clean_up_caches</span><span class="p">):</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">InsufficientDiskSpace</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                                              <span class="n">required</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                              <span class="n">actual</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mock_cache</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span>
            <span class="n">spec_set</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;master_dir&#39;</span><span class="p">],</span> <span class="n">master_dir</span><span class="o">=</span><span class="s1">&#39;master_dir&#39;</span><span class="p">)</span>
        <span class="n">mock_clean_up_caches</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">exc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">fetch_images</span><span class="p">,</span>
                          <span class="bp">None</span><span class="p">,</span>
                          <span class="n">mock_cache</span><span class="p">,</span>
                          <span class="p">[(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)])</span>
        <span class="n">mock_clean_up_caches</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;master_dir&#39;</span><span class="p">,</span>
                                                     <span class="p">[(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_defaults"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_about_unsafe_shred_parameters_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_mock</span><span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">warn_about_unsafe_shred_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">log_mock</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_zeros"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_zeros">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_about_unsafe_shred_parameters_zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_mock</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_random_overwrite_iterations&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_final_overwrite_with_zeros&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">warn_about_unsafe_shred_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">log_mock</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_random_no_zeros"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_random_no_zeros">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_about_unsafe_shred_parameters_random_no_zeros</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                                <span class="n">log_mock</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_random_overwrite_iterations&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_final_overwrite_with_zeros&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">warn_about_unsafe_shred_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">log_mock</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_produces_a_warning"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_warn_about_unsafe_shred_parameters_produces_a_warning">[docs]</a>    <span class="k">def</span> <span class="nf">test_warn_about_unsafe_shred_parameters_produces_a_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                                   <span class="n">log_mock</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_random_overwrite_iterations&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_final_overwrite_with_zeros&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">warn_about_unsafe_shred_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">log_mock</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;_get_ironic_session&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.common.keystone.get_service_url&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_get_ironic_api_url_from_config"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_ironic_api_url_from_config">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_ironic_api_url_from_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_get_url</span><span class="p">,</span> <span class="n">mock_ks</span><span class="p">):</span>
        <span class="n">mock_sess</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_ks</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_sess</span>
        <span class="n">fake_api_url</span> <span class="o">=</span> <span class="s1">&#39;http://foo/&#39;</span>
        <span class="n">mock_get_url</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">KeystoneFailure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="n">fake_api_url</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_ironic_api_url</span><span class="p">()</span>
        <span class="c1"># also checking for stripped trailing slash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_api_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">mock_get_url</span><span class="o">.</span><span class="n">called</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;_get_ironic_session&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.common.keystone.get_service_url&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_get_ironic_api_url_from_keystone"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_ironic_api_url_from_keystone">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_ironic_api_url_from_keystone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_get_url</span><span class="p">,</span> <span class="n">mock_ks</span><span class="p">):</span>
        <span class="n">mock_sess</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_ks</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_sess</span>
        <span class="n">fake_api_url</span> <span class="o">=</span> <span class="s1">&#39;http://foo/&#39;</span>
        <span class="n">mock_get_url</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">fake_api_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_ironic_api_url</span><span class="p">()</span>
        <span class="c1"># also checking for stripped trailing slash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fake_api_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">mock_get_url</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">mock_sess</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;_get_ironic_session&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.common.keystone.get_service_url&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="OtherFunctionTestCase.test_get_ironic_api_url_fail"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.OtherFunctionTestCase.test_get_ironic_api_url_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_ironic_api_url_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_get_url</span><span class="p">,</span> <span class="n">mock_ks</span><span class="p">):</span>
        <span class="n">mock_sess</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">mock_ks</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">mock_sess</span>
        <span class="n">mock_get_url</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">KeystoneFailure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">get_ironic_api_url</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase">[docs]</a><span class="k">class</span> <span class="nc">VirtualMediaDeployUtilsTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VirtualMediaDeployUtilsTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s2">&quot;iscsi_ilo&quot;</span><span class="p">)</span>
        <span class="n">info_dict</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_test_ilo_info</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;iscsi_ilo&#39;</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">=</span><span class="n">info_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_vif_port_id"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_vif_port_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_single_nic_with_vif_port_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tenant_vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;test-vif-A&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_single_nic_with_vif_port_id</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>

<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_vif_port_id_extra"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_vif_port_id_extra">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_single_nic_with_vif_port_id_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;test-vif-A&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_single_nic_with_vif_port_id</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>

<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_cleaning_vif_port_id"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_cleaning_vif_port_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_single_nic_with_cleaning_vif_port_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cleaning_vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;test-vif-A&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_single_nic_with_vif_port_id</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div>

<div class="viewcode-block" id="VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_provisioning_vif_port_id"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.VirtualMediaDeployUtilsTestCase.test_get_single_nic_with_provisioning_vif_port_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_single_nic_with_provisioning_vif_port_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
            <span class="n">internal_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;provisioning_vif_port_id&#39;</span><span class="p">:</span> <span class="s1">&#39;test-vif-A&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_single_nic_with_vif_port_id</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;aa:bb:cc:dd:ee:ff&#39;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase">[docs]</a><span class="k">class</span> <span class="nc">ParseInstanceInfoCapabilitiesTestCase</span><span class="p">(</span><span class="n">tests_base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParseInstanceInfoCapabilitiesTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">get_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_capabilities_string"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_capabilities_string">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_capabilities_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;{&quot;cat&quot;: &quot;meow&quot;}&#39;</span><span class="p">}</span>
        <span class="n">expected_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cat&quot;</span><span class="p">:</span> <span class="s2">&quot;meow&quot;</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_capabilities"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dog&quot;</span><span class="p">:</span> <span class="s2">&quot;wuff&quot;</span><span class="p">}}</span>
        <span class="n">expected_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dog&quot;</span><span class="p">:</span> <span class="s2">&quot;wuff&quot;</span><span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_result</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_invalid_type"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_parse_instance_info_invalid_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_invalid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;not-a-dict&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info_capabilities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_true"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_secure_boot_requested_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;secure_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;tRue&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_secure_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_false"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_secure_boot_requested_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;secure_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_secure_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_invalid"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_secure_boot_requested_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_secure_boot_requested_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;secure_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_secure_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_true"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_trusted_boot_requested_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;trusted_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_trusted_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_false"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_trusted_boot_requested_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;trusted_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_trusted_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_invalid"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_is_trusted_boot_requested_invalid">[docs]</a>    <span class="k">def</span> <span class="nf">test_is_trusted_boot_requested_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;trusted_boot&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_trusted_boot_requested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">))</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_capabilities"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_mode_for_deploy_using_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi,cap2:value2&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_mode_for_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;uefi&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_instance_info_cap"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_instance_info_cap">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_mode_for_deploy_using_instance_info_cap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;secure_boot&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">instance_info</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_mode_for_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;uefi&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;trusted_boot&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">instance_info</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_mode_for_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;trusted_boot&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">},</span>
                         <span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;secure_boot&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">instance_info</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_mode_for_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;uefi&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_instance_info"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_get_boot_mode_for_deploy_using_instance_info">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_boot_mode_for_deploy_using_instance_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;deploy_boot_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;bios&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">instance_info</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_boot_mode_for_deploy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;bios&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_boot_mode_capability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi,cap2:value2&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_with_exc"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_with_exc">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_boot_mode_capability_with_exc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:UEFI,cap2:value2&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">prop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_capabilities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_instance_info"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_instance_info">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_boot_mode_capability_instance_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;boot_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;uefi&quot;</span><span class="p">,</span> <span class="s2">&quot;cap2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">inst_info</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">validate_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_instance_info_with_exc"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_validate_boot_mode_capability_instance_info_with_exc">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_boot_mode_capability_instance_info_with_exc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;boot_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;UEFI&quot;</span><span class="p">,</span> <span class="s2">&quot;cap2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">inst_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_capabilities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_validate_trusted_boot_capability"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_validate_trusted_boot_capability">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_trusted_boot_capability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;trusted_boot:value&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_capabilities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_all_supported_capabilities"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_all_supported_capabilities">[docs]</a>    <span class="k">def</span> <span class="nf">test_all_supported_capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;netboot&#39;</span><span class="p">),</span>
                         <span class="n">utils</span><span class="o">.</span><span class="n">SUPPORTED_CAPABILITIES</span><span class="p">[</span><span class="s1">&#39;boot_option&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="s1">&#39;bios&#39;</span><span class="p">,</span> <span class="s1">&#39;uefi&#39;</span><span class="p">),</span>
                         <span class="n">utils</span><span class="o">.</span><span class="n">SUPPORTED_CAPABILITIES</span><span class="p">[</span><span class="s1">&#39;boot_mode&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">),</span>
                         <span class="n">utils</span><span class="o">.</span><span class="n">SUPPORTED_CAPABILITIES</span><span class="p">[</span><span class="s1">&#39;secure_boot&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">),</span>
                         <span class="n">utils</span><span class="o">.</span><span class="n">SUPPORTED_CAPABILITIES</span><span class="p">[</span><span class="s1">&#39;trusted_boot&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ParseInstanceInfoCapabilitiesTestCase.test_get_disk_label"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ParseInstanceInfoCapabilitiesTestCase.test_get_disk_label">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_disk_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;disk_label&#39;</span><span class="p">:</span> <span class="s1">&#39;gpt&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">inst_info</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_disk_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;gpt&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TrySetBootDeviceTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase">[docs]</a><span class="k">class</span> <span class="nc">TrySetBootDeviceTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="TrySetBootDeviceTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TrySetBootDeviceTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager_utils</span><span class="p">,</span> <span class="s1">&#39;node_set_boot_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TrySetBootDeviceTestCase.test_try_set_boot_device_okay"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase.test_try_set_boot_device_okay">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_set_boot_device_okay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_set_boot_device_mock</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">try_set_boot_device</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span>
                                      <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager_utils</span><span class="p">,</span> <span class="s1">&#39;node_set_boot_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TrySetBootDeviceTestCase.test_try_set_boot_device_ipmifailure_uefi"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase.test_try_set_boot_device_ipmifailure_uefi">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_set_boot_device_ipmifailure_uefi</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">node_set_boot_device_mock</span><span class="p">,</span> <span class="n">log_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capabilities&#39;</span><span class="p">:</span> <span class="s1">&#39;boot_mode:uefi&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IPMIFailure</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">try_set_boot_device</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span>
                                      <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">log_mock</span><span class="o">.</span><span class="n">warning</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager_utils</span><span class="p">,</span> <span class="s1">&#39;node_set_boot_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TrySetBootDeviceTestCase.test_try_set_boot_device_ipmifailure_bios"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase.test_try_set_boot_device_ipmifailure_bios">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_set_boot_device_ipmifailure_bios</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">node_set_boot_device_mock</span><span class="p">):</span>
        <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IPMIFailure</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">IPMIFailure</span><span class="p">,</span>
                              <span class="n">utils</span><span class="o">.</span><span class="n">try_set_boot_device</span><span class="p">,</span>
                              <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">manager_utils</span><span class="p">,</span> <span class="s1">&#39;node_set_boot_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TrySetBootDeviceTestCase.test_try_set_boot_device_some_other_exception"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TrySetBootDeviceTestCase.test_try_set_boot_device_some_other_exception">[docs]</a>    <span class="k">def</span> <span class="nf">test_try_set_boot_device_some_other_exception</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">node_set_boot_device_mock</span><span class="p">):</span>
        <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">IloOperationError</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;qwe&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exc</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                  <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">IloOperationError</span><span class="p">,</span>
                              <span class="n">utils</span><span class="o">.</span><span class="n">try_set_boot_device</span><span class="p">,</span>
                              <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">node_set_boot_device_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">boot_devices</span><span class="o">.</span><span class="n">DISK</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AgentMethodsTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase">[docs]</a><span class="k">class</span> <span class="nc">AgentMethodsTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="AgentMethodsTestCase.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AgentMethodsTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;deploy&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;erase_devices&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;update_firmware&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;raid&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;interface&#39;</span><span class="p">:</span> <span class="s1">&#39;raid&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="s1">&#39;create_configuration&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="s1">&#39;fake_agent&#39;</span><span class="p">,</span>
             <span class="s1">&#39;driver_internal_info&#39;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s1">&#39;agent_cached_clean_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_port</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">node_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_agent_get_clean_steps"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_agent_get_clean_steps">[docs]</a>    <span class="k">def</span> <span class="nf">test_agent_get_clean_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_get_clean_steps</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># Since steps are returned in dicts, they have non-deterministic</span>
            <span class="c1"># ordering</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">matchers</span><span class="o">.</span><span class="n">HasLength</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">response</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">response</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;raid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_get_clean_steps_custom_interface"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_get_clean_steps_custom_interface">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_clean_steps_custom_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_get_clean_steps</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;raid&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">matchers</span><span class="o">.</span><span class="n">HasLength</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;raid&#39;</span><span class="p">],</span> <span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_get_clean_steps_override_priorities"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_get_clean_steps_override_priorities">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_clean_steps_override_priorities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">new_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;create_configuration&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_get_clean_steps</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;raid&#39;</span><span class="p">,</span> <span class="n">override_priorities</span><span class="o">=</span><span class="n">new_priorities</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_get_clean_steps_override_priorities_none"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_get_clean_steps_override_priorities_none">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_clean_steps_override_priorities_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="c1"># this is simulating the default value of a configuration option</span>
            <span class="n">new_priorities</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;create_configuration&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_get_clean_steps</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="s1">&#39;raid&#39;</span><span class="p">,</span> <span class="n">override_priorities</span><span class="o">=</span><span class="n">new_priorities</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;priority&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_get_clean_steps_missing_steps"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_get_clean_steps_missing_steps">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_clean_steps_missing_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span>
        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;agent_cached_clean_steps&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NodeCleaningFailure</span><span class="p">,</span>
                              <span class="n">utils</span><span class="o">.</span><span class="n">agent_get_clean_steps</span><span class="p">,</span>
                              <span class="n">task</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.Port.list_by_node_id&#39;</span><span class="p">,</span>
                <span class="n">spec_set</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">agent_client</span><span class="o">.</span><span class="n">AgentClient</span><span class="p">,</span> <span class="s1">&#39;execute_clean_step&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="AgentMethodsTestCase.test_execute_clean_step"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_execute_clean_step">[docs]</a>    <span class="k">def</span> <span class="nf">test_execute_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_mock</span><span class="p">,</span> <span class="n">list_ports_mock</span><span class="p">):</span>
        <span class="n">client_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;command_status&#39;</span><span class="p">:</span> <span class="s1">&#39;SUCCEEDED&#39;</span><span class="p">}</span>
        <span class="n">list_ports_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ports</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_execute_clean_step</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.Port.list_by_node_id&#39;</span><span class="p">,</span>
                <span class="n">spec_set</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">agent_client</span><span class="o">.</span><span class="n">AgentClient</span><span class="p">,</span> <span class="s1">&#39;execute_clean_step&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="AgentMethodsTestCase.test_execute_clean_step_running"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_execute_clean_step_running">[docs]</a>    <span class="k">def</span> <span class="nf">test_execute_clean_step_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_mock</span><span class="p">,</span> <span class="n">list_ports_mock</span><span class="p">):</span>
        <span class="n">client_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;command_status&#39;</span><span class="p">:</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">}</span>
        <span class="n">list_ports_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ports</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_execute_clean_step</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>

    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.objects.Port.list_by_node_id&#39;</span><span class="p">,</span>
                <span class="n">spec_set</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">agent_client</span><span class="o">.</span><span class="n">AgentClient</span><span class="p">,</span> <span class="s1">&#39;execute_clean_step&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="AgentMethodsTestCase.test_execute_clean_step_version_mismatch"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_execute_clean_step_version_mismatch">[docs]</a>    <span class="k">def</span> <span class="nf">test_execute_clean_step_version_mismatch</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">client_mock</span><span class="p">,</span> <span class="n">list_ports_mock</span><span class="p">):</span>
        <span class="n">client_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;command_status&#39;</span><span class="p">:</span> <span class="s1">&#39;RUNNING&#39;</span><span class="p">}</span>
        <span class="n">list_ports_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ports</span>

        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">agent_execute_clean_step</span><span class="p">(</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_steps</span><span class="p">[</span><span class="s1">&#39;deploy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_agent_add_clean_params"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_agent_add_clean_params">[docs]</a>    <span class="k">def</span> <span class="nf">test_agent_add_clean_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_random_overwrite_iterations&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;shred_final_overwrite_with_zeros&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;continue_if_disk_secure_erase_fails&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="s1">&#39;deploy&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">agent_add_clean_params</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span>
                <span class="s1">&#39;agent_erase_devices_iterations&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span>
                <span class="s1">&#39;agent_erase_devices_zeroize&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span>
                <span class="s1">&#39;agent_continue_if_ata_erase_failed&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">pxe</span><span class="o">.</span><span class="n">PXEBoot</span><span class="p">,</span> <span class="s1">&#39;prepare_ramdisk&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.utils.node_power_action&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;build_agent_options&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.&#39;</span>
                <span class="s1">&#39;add_cleaning_network&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_prepare_inband_cleaning</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">add_cleaning_network_mock</span><span class="p">,</span>
            <span class="n">build_options_mock</span><span class="p">,</span> <span class="n">power_mock</span><span class="p">,</span> <span class="n">prepare_ramdisk_mock</span><span class="p">,</span>
            <span class="n">manage_boot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">build_options_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">prepare_inband_cleaning</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">manage_boot</span><span class="o">=</span><span class="n">manage_boot</span><span class="p">))</span>
            <span class="n">add_cleaning_network_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">REBOOT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span>
                             <span class="s1">&#39;agent_erase_devices_iterations&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span><span class="p">[</span>
                             <span class="s1">&#39;agent_erase_devices_zeroize&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">manage_boot</span><span class="p">:</span>
                <span class="n">prepare_ramdisk_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                    <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
                <span class="n">build_options_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">prepare_ramdisk_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">build_options_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

<div class="viewcode-block" id="AgentMethodsTestCase.test_prepare_inband_cleaning"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_prepare_inband_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test_prepare_inband_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_prepare_inband_cleaning</span><span class="p">()</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_prepare_inband_cleaning_manage_boot_false"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_prepare_inband_cleaning_manage_boot_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_prepare_inband_cleaning_manage_boot_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_prepare_inband_cleaning</span><span class="p">(</span><span class="n">manage_boot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">pxe</span><span class="o">.</span><span class="n">PXEBoot</span><span class="p">,</span> <span class="s1">&#39;clean_up_ramdisk&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.drivers.modules.network.flat.FlatNetwork.&#39;</span>
                <span class="s1">&#39;remove_cleaning_network&#39;</span><span class="p">)</span>
    <span class="nd">@mock.patch</span><span class="p">(</span><span class="s1">&#39;ironic.conductor.utils.node_power_action&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_test_tear_down_inband_cleaning</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">power_mock</span><span class="p">,</span> <span class="n">remove_cleaning_network_mock</span><span class="p">,</span>
            <span class="n">clean_up_ramdisk_mock</span><span class="p">,</span> <span class="n">manage_boot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">tear_down_inband_cleaning</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">manage_boot</span><span class="o">=</span><span class="n">manage_boot</span><span class="p">)</span>
            <span class="n">power_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">)</span>
            <span class="n">remove_cleaning_network_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manage_boot</span><span class="p">:</span>
                <span class="n">clean_up_ramdisk_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">boot</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">clean_up_ramdisk_mock</span><span class="o">.</span><span class="n">called</span><span class="p">)</span>

<div class="viewcode-block" id="AgentMethodsTestCase.test_tear_down_inband_cleaning"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_tear_down_inband_cleaning">[docs]</a>    <span class="k">def</span> <span class="nf">test_tear_down_inband_cleaning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tear_down_inband_cleaning</span><span class="p">(</span><span class="n">manage_boot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_tear_down_inband_cleaning_manage_boot_false"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_tear_down_inband_cleaning_manage_boot_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_tear_down_inband_cleaning_manage_boot_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_tear_down_inband_cleaning</span><span class="p">(</span><span class="n">manage_boot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AgentMethodsTestCase.test_build_agent_options_conf"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_build_agent_options_conf">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_agent_options_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="s1">&#39;https://api-url&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">build_agent_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;https://api-url&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ipa-api-url&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;coreos.configdrive&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;_get_ironic_session&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="AgentMethodsTestCase.test_build_agent_options_keystone"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.AgentMethodsTestCase.test_build_agent_options_keystone">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_agent_options_keystone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_mock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">api_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;conductor&#39;</span><span class="p">)</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">get_endpoint</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;https://api-url&#39;</span>
        <span class="n">session_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">sess</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">build_agent_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;https://api-url&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;ipa-api-url&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;coreos.configdrive&#39;</span><span class="p">])</span></div></div>


<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">disk_utils</span><span class="p">,</span> <span class="s1">&#39;is_block_device&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;login_iscsi&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;logout_iscsi&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;delete_iscsi&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
<span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;get_dev&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="s1">&#39;/dev/fake&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ISCSISetupAndHandleErrorsTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ISCSISetupAndHandleErrorsTestCase">[docs]</a><span class="k">class</span> <span class="nc">ISCSISetupAndHandleErrorsTestCase</span><span class="p">(</span><span class="n">tests_base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ISCSISetupAndHandleErrorsTestCase.test_no_parent_device"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ISCSISetupAndHandleErrorsTestCase.test_no_parent_device">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_parent_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_ibd</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mock_ibd</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">expected_dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>
        <span class="k">with</span> <span class="n">testtools</span><span class="o">.</span><span class="n">ExpectedException</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InstanceDeployFailure</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">_iscsi_setup_and_handle_errors</span><span class="p">(</span>
                    <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="k">as</span> <span class="n">dev</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>

        <span class="n">mock_ibd</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">expected_dev</span><span class="p">)</span></div>

<div class="viewcode-block" id="ISCSISetupAndHandleErrorsTestCase.test_parent_device_yield"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ISCSISetupAndHandleErrorsTestCase.test_parent_device_yield">[docs]</a>    <span class="k">def</span> <span class="nf">test_parent_device_yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_ibd</span><span class="p">):</span>
        <span class="n">address</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span>
        <span class="n">iqn</span> <span class="o">=</span> <span class="s1">&#39;iqn.xyz&#39;</span>
        <span class="n">lun</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">expected_dev</span> <span class="o">=</span> <span class="s1">&#39;/dev/fake&#39;</span>
        <span class="n">mock_ibd</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">with</span> <span class="n">utils</span><span class="o">.</span><span class="n">_iscsi_setup_and_handle_errors</span><span class="p">(</span>
                <span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">iqn</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="k">as</span> <span class="n">dev</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span>

        <span class="n">mock_ibd</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">expected_dev</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ValidateImagePropertiesTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateImagePropertiesTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;get_image_service&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_glance_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_service_mock</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">INST_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">DRV_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_image_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">image_service_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">:</span> <span class="s1">&#39;1111&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk_id&#39;</span><span class="p">:</span> <span class="s1">&#39;2222&#39;</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inst_info</span><span class="p">,</span>
                                        <span class="p">[</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk_id&#39;</span><span class="p">])</span>
        <span class="n">image_service_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;get_image_service&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_missing_prop"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_missing_prop">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_glance_image_missing_prop</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">image_service_mock</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">INST_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">DRV_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_image_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">image_service_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">:</span> <span class="s1">&#39;1111&#39;</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inst_info</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk_id&#39;</span><span class="p">])</span>
        <span class="n">image_service_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">],</span> <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;get_image_service&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_not_authorized"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_not_authorized">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_glance_image_not_authorized</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">image_service_mock</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;uuid&#39;</span><span class="p">}</span>
        <span class="n">show_mock</span> <span class="o">=</span> <span class="n">image_service_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span>
        <span class="n">show_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ImageNotAuthorized</span><span class="p">(</span><span class="n">image_id</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                          <span class="n">inst_info</span><span class="p">,</span> <span class="p">[])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;get_image_service&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_not_found"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_glance_image_not_found">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_glance_image_not_found</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">image_service_mock</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;uuid&#39;</span><span class="p">}</span>
        <span class="n">show_mock</span> <span class="o">=</span> <span class="n">image_service_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span>
        <span class="n">show_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ImageNotFound</span><span class="p">(</span><span class="n">image_id</span><span class="o">=</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                          <span class="n">inst_info</span><span class="p">,</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_invalid_image_href"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_invalid_image_href">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_invalid_image_href</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;emule://uuid&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                          <span class="n">inst_info</span><span class="p">,</span> <span class="p">[])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_nonglance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_nonglance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_nonglance_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">image_service_show_mock</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;http://ubuntu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="s1">&#39;kernel_uuid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ramdisk&#39;</span><span class="p">:</span> <span class="s1">&#39;file://initrd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">image_service_show_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">DRV_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_image_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inst_info</span><span class="p">,</span>
                                        <span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">])</span>
        <span class="n">image_service_show_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="ValidateImagePropertiesTestCase.test_validate_image_properties_nonglance_image_validation_fail"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateImagePropertiesTestCase.test_validate_image_properties_nonglance_image_validation_fail">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_image_properties_nonglance_image_validation_fail</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">img_service_show_mock</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;http://ubuntu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="s1">&#39;kernel_uuid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ramdisk&#39;</span><span class="p">:</span> <span class="s1">&#39;file://initrd&#39;</span><span class="p">,</span>
            <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">img_service_show_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ImageRefValidationFailed</span><span class="p">(</span>
            <span class="n">image_href</span><span class="o">=</span><span class="s1">&#39;http://ubuntu&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;HTTPError&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">DRV_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">inst_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_image_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">validate_image_properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                          <span class="n">inst_info</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="ValidateParametersTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateParametersTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_test__get_img_instance_info</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">INST_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">DRV_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">):</span>
        <span class="c1"># make sure we get back the expected things</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
            <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">,</span>
            <span class="n">driver_info</span><span class="o">=</span><span class="n">driver_info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_image_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">info</span>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_good"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_good">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_good</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_good_non_glance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_good_non_glance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_good_non_glance_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://image&#39;</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://kernel&#39;</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://ramdisk&#39;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">(</span><span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_non_glance_image_missing_kernel"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_non_glance_image_missing_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_non_glance_image_missing_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://image&#39;</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://ramdisk&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_non_glance_image_missing_ramdisk"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_non_glance_image_missing_ramdisk">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_non_glance_image_missing_ramdisk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://image&#39;</span>
        <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://kernel&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_missing_image_source"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_missing_image_source">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_missing_image_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">instance_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateParametersTestCase.test__get_img_instance_info_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.ValidateParametersTestCase.test__get_img_instance_info_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test__get_img_instance_info_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">DRV_INTERNAL_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_test__get_img_instance_info</span><span class="p">(</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="InstanceInfoTestCase"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase">[docs]</a><span class="k">class</span> <span class="nc">InstanceInfoTestCase</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_good"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_good">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_good</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure we get back the expected things</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_pxe&#39;</span><span class="p">,</span>
            <span class="n">instance_info</span><span class="o">=</span><span class="n">INST_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span>
        <span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_missing_instance_source"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_missing_instance_source">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_missing_instance_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure error is raised when info is missing</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_missing_root_gb"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_missing_root_gb">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_missing_root_gb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure error is raised when info is missing</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_invalid_root_gb"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_invalid_root_gb">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_invalid_root_gb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_valid_ephemeral_gb"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_valid_ephemeral_gb">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_valid_ephemeral_gb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ephemeral_gb</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">ephemeral_mb</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">ephemeral_gb</span>
        <span class="n">ephemeral_fmt</span> <span class="o">=</span> <span class="s1">&#39;test-fmt&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ephemeral_gb</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ephemeral_fmt</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ephemeral_mb</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ephemeral_mb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ephemeral_fmt</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_unicode_swap_mb"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_unicode_swap_mb">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_unicode_swap_mb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">swap_mb</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;10&#39;</span>
        <span class="n">swap_mb_int</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swap_mb</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">swap_mb_int</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_invalid_ephemeral_gb"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_invalid_ephemeral_gb">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_invalid_ephemeral_gb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;exttest&#39;</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_valid_ephemeral_missing_format"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_valid_ephemeral_missing_format">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_valid_ephemeral_missing_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ephemeral_gb</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">ephemeral_fmt</span> <span class="o">=</span> <span class="s1">&#39;test-fmt&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ephemeral_gb</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">default_ephemeral_format</span><span class="o">=</span><span class="n">ephemeral_fmt</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;pxe&#39;</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ephemeral_fmt</span><span class="p">,</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_valid_preserve_ephemeral_true"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_valid_preserve_ephemeral_true">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_valid_preserve_ephemeral_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">]:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
                <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_valid_preserve_ephemeral_false"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_valid_preserve_ephemeral_false">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_valid_preserve_ephemeral_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">]:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
                <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_invalid_preserve_ephemeral"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_invalid_preserve_ephemeral">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_invalid_preserve_ephemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_invalid_ephemeral_disk"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_invalid_ephemeral_disk">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_invalid_ephemeral_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">drv_internal_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                                          <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}}</span>
        <span class="n">drv_internal_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">drv_internal_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test__check_disk_layout_unchanged_fails"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test__check_disk_layout_unchanged_fails">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_disk_layout_unchanged_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">drv_internal_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                                          <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}}</span>
        <span class="n">drv_internal_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">drv_internal_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">_check_disk_layout_unchanged</span><span class="p">,</span>
                          <span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test__check_disk_layout_unchanged"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test__check_disk_layout_unchanged">[docs]</a>    <span class="k">def</span> <span class="nf">test__check_disk_layout_unchanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;preserve_ephemeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">drv_internal_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                          <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}}</span>
        <span class="n">drv_internal_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">drv_internal_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">_check_disk_layout_unchanged</span><span class="p">(</span><span class="n">node</span><span class="p">,</span>
                                                             <span class="n">info</span><span class="p">))</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_configdrive"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_configdrive">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_configdrive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://1.2.3.4/cd&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;http://1.2.3.4/cd&#39;</span><span class="p">,</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_nonglance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_nonglance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_nonglance_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file:///image.qcow2&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file:///image.vmlinuz&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file:///image.initrd&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_nonglance_image_no_kernel"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_nonglance_image_no_kernel">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_nonglance_image_no_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">INST_INFO_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file:///image.qcow2&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file:///image.initrd&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_whole_disk_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_whole_disk_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_whole_disk_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DRV_INTERNAL_INFO_DICT</span><span class="p">)</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">INST_INFO_DICT</span><span class="p">,</span>
            <span class="n">driver_internal_info</span><span class="o">=</span><span class="n">driver_internal_info</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">instance_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;root_mb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;ephemeral_mb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InstanceInfoTestCase.test_parse_instance_info_whole_disk_image_missing_root"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.InstanceInfoTestCase.test_parse_instance_info_whole_disk_image_missing_root">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_instance_info_whole_disk_image_missing_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">INST_INFO_DICT</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">,</span>
                          <span class="n">utils</span><span class="o">.</span><span class="n">parse_instance_info</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy">[docs]</a><span class="k">class</span> <span class="nc">TestBuildInstanceInfoForDeploy</span><span class="p">(</span><span class="n">db_base</span><span class="o">.</span><span class="n">DbTestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.setUp"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestBuildInstanceInfoForDeploy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">obj_utils</span><span class="o">.</span><span class="n">create_test_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                               <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;validate_href&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;GlanceImageService&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_glance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_glance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_instance_info_for_deploy_glance_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glance_mock</span><span class="p">,</span>
                                                         <span class="n">validate_mock</span><span class="p">):</span>
        <span class="n">i_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;733d1c44-a2ea-414b-aca7-69decf20d810&#39;</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">driver_internal_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">i_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">image_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="s1">&#39;disk_format&#39;</span><span class="p">:</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;container_format&#39;</span><span class="p">:</span> <span class="s1">&#39;bare&#39;</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="p">[],</span>
                                                       <span class="n">return_value</span><span class="o">=</span><span class="n">image_info</span><span class="p">)</span>
        <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">swift_temp_url</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;http://temp-url&#39;</span><span class="p">)</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>

            <span class="n">utils</span><span class="o">.</span><span class="n">build_instance_info_for_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="n">glance_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">context</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span>
            <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">swift_temp_url</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">image_info</span><span class="p">)</span>
            <span class="n">validate_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;http://temp-url&#39;</span><span class="p">,</span>
                                                  <span class="n">secret</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;validate_href&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;parse_instance_info&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="p">,</span> <span class="s1">&#39;GlanceImageService&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_glance_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_glance_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_instance_info_for_deploy_glance_partition_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">glance_mock</span><span class="p">,</span> <span class="n">parse_instance_info_mock</span><span class="p">,</span> <span class="n">validate_mock</span><span class="p">):</span>
        <span class="n">i_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;733d1c44-a2ea-414b-aca7-69decf20d810&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;13ce5a56-1de3-4916-b8b2-be778645d003&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;a5a370a8-1b39-433f-be63-2c7d708e4b4e&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;ephemeral_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;configdrive&#39;</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">driver_internal_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">i_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">image_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="s1">&#39;disk_format&#39;</span><span class="p">:</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;container_format&#39;</span><span class="p">:</span> <span class="s1">&#39;bare&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">:</span> <span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;ramdisk_id&#39;</span><span class="p">:</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">}}</span>
        <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="p">[],</span>
                                                       <span class="n">return_value</span><span class="o">=</span><span class="n">image_info</span><span class="p">)</span>
        <span class="n">glance_obj_mock</span> <span class="o">=</span> <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span>
        <span class="n">glance_obj_mock</span><span class="o">.</span><span class="n">swift_temp_url</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;http://temp-url&#39;</span>
        <span class="n">parse_instance_info_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
        <span class="n">image_source</span> <span class="o">=</span> <span class="s1">&#39;733d1c44-a2ea-414b-aca7-69decf20d810&#39;</span>
        <span class="n">expected_i_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                           <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                           <span class="s1">&#39;ephemeral_gb&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;ephemeral_format&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                           <span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="s1">&#39;configdrive&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="n">image_source</span><span class="p">,</span>
                           <span class="s1">&#39;image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://temp-url&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;ramdisk&#39;</span><span class="p">:</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_type&#39;</span><span class="p">:</span> <span class="s1">&#39;partition&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_tags&#39;</span><span class="p">:</span> <span class="p">[],</span>
                           <span class="s1">&#39;image_properties&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">:</span> <span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;ramdisk_id&#39;</span><span class="p">:</span> <span class="s1">&#39;ramdisk&#39;</span><span class="p">},</span>
                           <span class="s1">&#39;image_checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_container_format&#39;</span><span class="p">:</span> <span class="s1">&#39;bare&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_disk_format&#39;</span><span class="p">:</span> <span class="s1">&#39;qcow2&#39;</span><span class="p">}</span>
        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">build_instance_info_for_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="n">glance_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                                <span class="n">context</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">show</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">])</span>
            <span class="n">glance_mock</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">swift_temp_url</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">image_info</span><span class="p">)</span>
            <span class="n">validate_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;http://temp-url&#39;</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">image_type</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_type&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;partition&#39;</span><span class="p">,</span> <span class="n">image_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_i_info</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="n">parse_instance_info_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;validate_href&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonglance_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonglance_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_instance_info_for_deploy_nonglance_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">validate_href_mock</span><span class="p">):</span>
        <span class="n">i_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://image-ref&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">i_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">driver_internal_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">build_instance_info_for_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">],</span>
                             <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_url&#39;</span><span class="p">])</span>
            <span class="n">validate_href_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;http://image-ref&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">utils</span><span class="p">,</span> <span class="s1">&#39;parse_instance_info&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;validate_href&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonglance_partition_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonglance_partition_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_instance_info_for_deploy_nonglance_partition_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">validate_href_mock</span><span class="p">,</span> <span class="n">parse_instance_info_mock</span><span class="p">):</span>
        <span class="n">i_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://image-ref&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://kernel-ref&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;ramdisk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;http://ramdisk-ref&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;root_gb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;configdrive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;configdrive&#39;</span>
        <span class="n">driver_internal_info</span><span class="p">[</span><span class="s1">&#39;is_whole_disk_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">i_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">driver_internal_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>
        <span class="n">validate_href_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://image-ref&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;http://kernel-ref&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;http://ramdisk-ref&#39;</span><span class="p">]</span>
        <span class="n">parse_instance_info_mock</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
        <span class="n">expected_i_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image_source&#39;</span><span class="p">:</span> <span class="s1">&#39;http://image-ref&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://image-ref&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_type&#39;</span><span class="p">:</span> <span class="s1">&#39;partition&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;kernel&#39;</span><span class="p">:</span> <span class="s1">&#39;http://kernel-ref&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;ramdisk&#39;</span><span class="p">:</span> <span class="s1">&#39;http://ramdisk-ref&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;image_checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;root_gb&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                           <span class="s1">&#39;swap_mb&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                           <span class="s1">&#39;configdrive&#39;</span><span class="p">:</span> <span class="s1">&#39;configdrive&#39;</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>

            <span class="n">info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">build_instance_info_for_deploy</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">],</span>
                             <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_url&#39;</span><span class="p">])</span>
            <span class="n">validate_href_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span>
                <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="s1">&#39;http://image-ref&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;partition&#39;</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_type&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_i_info</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="n">parse_instance_info_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">node</span><span class="p">)</span></div>

    <span class="nd">@mock.patch.object</span><span class="p">(</span><span class="n">image_service</span><span class="o">.</span><span class="n">HttpImageService</span><span class="p">,</span> <span class="s1">&#39;validate_href&#39;</span><span class="p">,</span>
                       <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<div class="viewcode-block" id="TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonsupported_image"><a class="viewcode-back" href="../../../../../../api/ironic.tests.unit.drivers.modules.test_deploy_utils.html#ironic.tests.unit.drivers.modules.test_deploy_utils.TestBuildInstanceInfoForDeploy.test_build_instance_info_for_deploy_nonsupported_image">[docs]</a>    <span class="k">def</span> <span class="nf">test_build_instance_info_for_deploy_nonsupported_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">validate_href_mock</span><span class="p">):</span>
        <span class="n">validate_href_mock</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ImageRefValidationFailed</span><span class="p">(</span>
            <span class="n">image_href</span><span class="o">=</span><span class="s1">&#39;file://img.qcow2&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span>
        <span class="n">i_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file://img.qcow2&#39;</span>
        <span class="n">i_info</span><span class="p">[</span><span class="s1">&#39;image_checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aa&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">i_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">mgr_utils</span><span class="o">.</span><span class="n">mock_the_extension_manager</span><span class="p">(</span><span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake_agent&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">task_manager</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">shared</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">task</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">ImageRefValidationFailed</span><span class="p">,</span>
                              <span class="n">utils</span><span class="o">.</span><span class="n">build_instance_info_for_deploy</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/ironic
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../../index.html">Ironic 7.0.1.dev7 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/Ironic");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>