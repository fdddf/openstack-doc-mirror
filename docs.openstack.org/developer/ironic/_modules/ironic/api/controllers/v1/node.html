<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ironic.api.controllers.v1.node &mdash; Ironic 7.0.1.dev7 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/toggle.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '7.0.1.dev7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/toggle.js"></script>
    <link rel="top" title="Ironic 7.0.1.dev7 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ironic.api.controllers.v1.node</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2013 Hewlett-Packard Development Company, L.P.</span>
<span class="c1"># All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">ironic_lib</span> <span class="kn">import</span> <span class="n">metrics_utils</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">strutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">import</span> <span class="nn">pecan</span>
<span class="kn">from</span> <span class="nn">pecan</span> <span class="kn">import</span> <span class="n">rest</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="n">http_client</span>
<span class="kn">import</span> <span class="nn">wsme</span>
<span class="kn">from</span> <span class="nn">wsme</span> <span class="kn">import</span> <span class="n">types</span> <span class="k">as</span> <span class="n">wtypes</span>

<span class="kn">from</span> <span class="nn">ironic.api.controllers</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers</span> <span class="kn">import</span> <span class="n">link</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">collection</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">notification_utils</span> <span class="k">as</span> <span class="n">notify</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">port</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">portgroup</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">api_utils</span>
<span class="kn">from</span> <span class="nn">ironic.api.controllers.v1</span> <span class="kn">import</span> <span class="n">versions</span>
<span class="kn">from</span> <span class="nn">ironic.api</span> <span class="kn">import</span> <span class="n">expose</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">ironic.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">policy</span>
<span class="kn">from</span> <span class="nn">ironic.common</span> <span class="kn">import</span> <span class="n">states</span> <span class="k">as</span> <span class="n">ir_states</span>
<span class="kn">from</span> <span class="nn">ironic.conductor</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">conductor_utils</span>
<span class="kn">import</span> <span class="nn">ironic.conf</span>
<span class="kn">from</span> <span class="nn">ironic</span> <span class="kn">import</span> <span class="n">objects</span>


<span class="n">CONF</span> <span class="o">=</span> <span class="n">ironic</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">CONF</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">_CLEAN_STEPS_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/schema#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Clean steps schema&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
    <span class="c1"># list of clean steps</span>
    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="c1"># args is optional</span>
        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">],</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;interface&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;driver interface&quot;</span><span class="p">,</span>
                <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">conductor_utils</span><span class="o">.</span><span class="n">CLEANING_INTERFACE_PRIORITY</span><span class="p">)</span>
                <span class="c1"># interface value must be one of the valid interfaces</span>
            <span class="p">},</span>
            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;name of clean step&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;additional args&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="c1"># interface, step and args are the only expected keys</span>
        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="bp">False</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">METRICS</span> <span class="o">=</span> <span class="n">metrics_utils</span><span class="o">.</span><span class="n">get_metrics_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Vendor information for node&#39;s driver:</span>
<span class="c1">#   key = driver name;</span>
<span class="c1">#   value = dictionary of node vendor methods of that driver:</span>
<span class="c1">#             key = method name.</span>
<span class="c1">#             value = dictionary with the metadata of that method.</span>
<span class="c1"># NOTE(lucasagomes). This is cached for the lifetime of the API</span>
<span class="c1"># service. If one or more conductor services are restarted with new driver</span>
<span class="c1"># versions, the API service should be restarted.</span>
<span class="n">_VENDOR_METHODS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">_DEFAULT_RETURN_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;instance_uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;maintenance&#39;</span><span class="p">,</span> <span class="s1">&#39;power_state&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;provision_state&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># States where calling do_provisioning_action makes sense</span>
<span class="n">PROVISION_ACTION_STATES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;manage&#39;</span><span class="p">],</span>
                           <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;provide&#39;</span><span class="p">],</span>
                           <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;abort&#39;</span><span class="p">],</span>
                           <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;adopt&#39;</span><span class="p">])</span>

<span class="n">_NODES_CONTROLLER_RESERVED_WORDS</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">ALLOWED_TARGET_POWER_STATES</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir_states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                               <span class="n">ir_states</span><span class="o">.</span><span class="n">POWER_OFF</span><span class="p">,</span>
                               <span class="n">ir_states</span><span class="o">.</span><span class="n">REBOOT</span><span class="p">,</span>
                               <span class="n">ir_states</span><span class="o">.</span><span class="n">SOFT_REBOOT</span><span class="p">,</span>
                               <span class="n">ir_states</span><span class="o">.</span><span class="n">SOFT_POWER_OFF</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_nodes_controller_reserved_names</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_NODES_CONTROLLER_RESERVED_WORDS</span>
    <span class="k">if</span> <span class="n">_NODES_CONTROLLER_RESERVED_WORDS</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_NODES_CONTROLLER_RESERVED_WORDS</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">api_utils</span><span class="o">.</span><span class="n">get_controller_reserved_names</span><span class="p">(</span><span class="n">NodesController</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_NODES_CONTROLLER_RESERVED_WORDS</span>


<span class="k">def</span> <span class="nf">hide_fields_in_newer_versions</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This method hides fields that were added in newer API versions.</span>

<span class="sd">    Certain node fields were introduced at certain API versions.</span>
<span class="sd">    These fields are only made available when the request&#39;s API version</span>
<span class="sd">    matches or exceeds the versions when these fields were introduced.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_3_DRIVER_INTERNAL_INFO</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_node_logical_names</span><span class="p">():</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="c1"># if requested version is &lt; 1.6, hide inspection_*_at fields</span>
    <span class="k">if</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_6_INSPECT_STATE</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">inspection_finished_at</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">inspection_started_at</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_7_NODE_CLEAN</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">clean_step</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_12_RAID_CONFIG</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">target_raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_20_NETWORK_INTERFACE</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">network_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_resource_class</span><span class="p">():</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">resource_class</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_dynamic_interfaces</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">V31_FIELDS</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">update_state_in_older_versions</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change provision state names for API backwards compatibility.</span>

<span class="sd">    :param obj: The object being returned to the API client that is</span>
<span class="sd">                to be updated by this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if requested version is &lt; 1.2, convert AVAILABLE to the old NOSTATE</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">versions</span><span class="o">.</span><span class="n">MINOR_2_AVAILABLE_STATE</span> <span class="ow">and</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">provision_state</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">provision_state</span> <span class="o">=</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">NOSTATE</span>


<div class="viewcode-block" id="BootDeviceController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.BootDeviceController">[docs]</a><span class="k">class</span> <span class="nc">BootDeviceController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;supported&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_boot_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current boot device or a list of supported devices.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :param supported: Boolean value. If true return a list of</span>
<span class="sd">                          supported boot devices, if false return the</span>
<span class="sd">                          current boot device. Default: False.</span>
<span class="sd">        :returns: The current boot device or a list of the supported</span>
<span class="sd">                  boot devices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">supported</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_supported_boot_devices</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_boot_device</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                        <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;BootDeviceController.put&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>
<div class="viewcode-block" id="BootDeviceController.put"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.BootDeviceController.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">boot_device</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the boot device for a node.</span>

<span class="sd">        Set the boot device to use on next reboot of the node.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :param boot_device: the boot device, one of</span>
<span class="sd">                            :mod:`ironic.common.boot_devices`.</span>
<span class="sd">        :param persistent: Boolean value. True if the boot device will</span>
<span class="sd">                           persist to all future boots, False if not.</span>
<span class="sd">                           Default: False.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_boot_device&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                             <span class="n">boot_device</span><span class="p">,</span>
                                             <span class="n">persistent</span><span class="o">=</span><span class="n">persistent</span><span class="p">,</span>
                                             <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;BootDeviceController.get&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">)</span>
<div class="viewcode-block" id="BootDeviceController.get"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.BootDeviceController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the current boot device for a node.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :returns: a json object containing:</span>

<span class="sd">            :boot_device: the boot device, one of</span>
<span class="sd">                :mod:`ironic.common.boot_devices` or None if it is unknown.</span>
<span class="sd">            :persistent: Whether the boot device will persist to all</span>
<span class="sd">                future boots or not, None if it is unknown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get_boot_device&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boot_device</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;BootDeviceController.supported&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">)</span>
<div class="viewcode-block" id="BootDeviceController.supported"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.BootDeviceController.supported">[docs]</a>    <span class="k">def</span> <span class="nf">supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of the supported boot devices.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :returns: A json object with the list of supported boot</span>
<span class="sd">                  devices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get_boot_device&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">boot_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_boot_device</span><span class="p">(</span><span class="n">node_ident</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;supported_boot_devices&#39;</span><span class="p">:</span> <span class="n">boot_devices</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="InjectNmiController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.InjectNmiController">[docs]</a><span class="k">class</span> <span class="nc">InjectNmiController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;InjectNmiController.put&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>
<div class="viewcode-block" id="InjectNmiController.put"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.InjectNmiController.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inject NMI for a node.</span>

<span class="sd">        Inject NMI (Non Maskable Interrupt) for a node immediately.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :raises: NotFound if requested version of the API doesn&#39;t support</span>
<span class="sd">                 inject nmi.</span>
<span class="sd">        :raises: HTTPForbidden if the policy is not authorized.</span>
<span class="sd">        :raises: NodeNotFound if the node is not found.</span>
<span class="sd">        :raises: NodeLocked if the node is locked by another conductor.</span>
<span class="sd">        :raises: UnsupportedDriverExtension if the node&#39;s driver doesn&#39;t</span>
<span class="sd">                 support management or management.inject_nmi.</span>
<span class="sd">        :raises: InvalidParameterValue when the wrong driver info is</span>
<span class="sd">                 specified or an invalid boot device is specified.</span>
<span class="sd">        :raises: MissingParameterValue if missing supplied info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_inject_nmi</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">()</span>

        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:inject_nmi&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">inject_nmi</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                        <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                        <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NodeManagementController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeManagementController">[docs]</a><span class="k">class</span> <span class="nc">NodeManagementController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="n">boot_device</span> <span class="o">=</span> <span class="n">BootDeviceController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose boot_device as a sub-element of management&quot;&quot;&quot;</span>

    <span class="n">inject_nmi</span> <span class="o">=</span> <span class="n">InjectNmiController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose inject_nmi as a sub-element of management&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ConsoleInfo"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.ConsoleInfo">[docs]</a><span class="k">class</span> <span class="nc">ConsoleInfo</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">APIBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API representation of the console information for a node.&quot;&quot;&quot;</span>

    <span class="n">console_enabled</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span>
    <span class="sd">&quot;&quot;&quot;The console state: if the console is enabled or not.&quot;&quot;&quot;</span>

    <span class="n">console_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;The console information. It typically includes the url to access the</span>
<span class="sd">    console and the type of the application that hosts the console.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ConsoleInfo.sample"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.ConsoleInfo.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">console</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;shellinabox&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://&lt;hostname&gt;:4201&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">console_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">console_info</span><span class="o">=</span><span class="n">console</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NodeConsoleController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeConsoleController">[docs]</a><span class="k">class</span> <span class="nc">NodeConsoleController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeConsoleController.get&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">ConsoleInfo</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">)</span>
<div class="viewcode-block" id="NodeConsoleController.get"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeConsoleController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get connection information about the console.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get_console&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">console</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_console_information</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
            <span class="n">console_state</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeConsoleNotEnabled</span><span class="p">:</span>
            <span class="n">console</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">console_state</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">ConsoleInfo</span><span class="p">(</span><span class="n">console_enabled</span><span class="o">=</span><span class="n">console_state</span><span class="p">,</span> <span class="n">console_info</span><span class="o">=</span><span class="n">console</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeConsoleController.put&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>
<div class="viewcode-block" id="NodeConsoleController.put"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeConsoleController.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start and stop the node console.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :param enabled: Boolean value; whether to enable or disable the</span>
<span class="sd">                console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_console_state&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">set_console_mode</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                              <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="c1"># Set the HTTP Location Header</span>
        <span class="n">url_args</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node_ident</span><span class="p">,</span> <span class="s1">&#39;states&#39;</span><span class="p">,</span> <span class="s1">&#39;console&#39;</span><span class="p">])</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">url_args</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NodeStates"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStates">[docs]</a><span class="k">class</span> <span class="nc">NodeStates</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">APIBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API representation of the states of a node.&quot;&quot;&quot;</span>

    <span class="n">console_enabled</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span>
    <span class="sd">&quot;&quot;&quot;Indicates whether the console access is enabled or disabled on</span>
<span class="sd">    the node.&quot;&quot;&quot;</span>

    <span class="n">power_state</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="sd">&quot;&quot;&quot;Represent the current (not transition) power state of the node&quot;&quot;&quot;</span>

    <span class="n">provision_state</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="sd">&quot;&quot;&quot;Represent the current (not transition) provision state of the node&quot;&quot;&quot;</span>

    <span class="n">provision_updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="sd">&quot;&quot;&quot;The UTC date and time of the last provision state change&quot;&quot;&quot;</span>

    <span class="n">target_power_state</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="sd">&quot;&quot;&quot;The user modified desired power state of the node.&quot;&quot;&quot;</span>

    <span class="n">target_provision_state</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="sd">&quot;&quot;&quot;The user modified desired provision state of the node.&quot;&quot;&quot;</span>

    <span class="n">last_error</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="sd">&quot;&quot;&quot;Any error from the most recent (last) asynchronous transaction that</span>
<span class="sd">    started but failed to finish.&quot;&quot;&quot;</span>

    <span class="n">raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Represents the RAID configuration that the node is configured with.&quot;&quot;&quot;</span>

    <span class="n">target_raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span>
                                     <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The desired RAID configuration, to be used the next time the node</span>
<span class="sd">    is configured.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NodeStates.convert"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStates.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">):</span>
        <span class="n">attr_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;console_enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;last_error&#39;</span><span class="p">,</span> <span class="s1">&#39;power_state&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;provision_state&#39;</span><span class="p">,</span> <span class="s1">&#39;target_power_state&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;target_provision_state&#39;</span><span class="p">,</span> <span class="s1">&#39;provision_updated_at&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_raid_config</span><span class="p">():</span>
            <span class="n">attr_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;raid_config&#39;</span><span class="p">,</span> <span class="s1">&#39;target_raid_config&#39;</span><span class="p">])</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">NodeStates</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attr_list</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
        <span class="n">update_state_in_older_versions</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">states</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="NodeStates.sample"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStates.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">target_power_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                     <span class="n">target_provision_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                     <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">console_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">provision_updated_at</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">power_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                     <span class="n">provision_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">raid_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">target_raid_config</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span></div></div>


<div class="viewcode-block" id="NodeStatesController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStatesController">[docs]</a><span class="k">class</span> <span class="nc">NodeStatesController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">],</span>
        <span class="s1">&#39;provision&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">],</span>
        <span class="s1">&#39;raid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">console</span> <span class="o">=</span> <span class="n">NodeConsoleController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose console as a sub-element of states&quot;&quot;&quot;</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeStatesController.get&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">NodeStates</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">)</span>
<div class="viewcode-block" id="NodeStatesController.get"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStatesController.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List the states of the node.</span>

<span class="sd">        :param node_ident: the UUID or logical_name of a node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get_states&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="c1"># NOTE(lucasagomes): All these state values come from the</span>
        <span class="c1"># DB. Ironic counts with a periodic task that verify the current</span>
        <span class="c1"># power states of the nodes and update the DB accordingly.</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NodeStates</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeStatesController.raid&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">)</span>
<div class="viewcode-block" id="NodeStatesController.raid"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStatesController.raid">[docs]</a>    <span class="k">def</span> <span class="nf">raid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">target_raid_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the target raid config of the node.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :param target_raid_config: Desired target RAID configuration of</span>
<span class="sd">            the node. It may be an empty dictionary as well.</span>
<span class="sd">        :raises: UnsupportedDriverExtension, if the node&#39;s driver doesn&#39;t</span>
<span class="sd">            support RAID configuration.</span>
<span class="sd">        :raises: InvalidParameterValue, if validation of target raid config</span>
<span class="sd">            fails.</span>
<span class="sd">        :raises: NotAcceptable, if requested version of the API is less than</span>
<span class="sd">            1.12.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_raid_state&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_raid_config</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">set_target_raid_config</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">target_raid_config</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">UnsupportedDriverExtension</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Change error code as 404 seems appropriate because RAID is a</span>
            <span class="c1"># standard interface and all drivers might not have it.</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">NOT_FOUND</span>
            <span class="k">raise</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeStatesController.power&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">wtypes</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>
<div class="viewcode-block" id="NodeStatesController.power"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStatesController.power">[docs]</a>    <span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the power state of the node.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :param target: The desired power state of the node.</span>
<span class="sd">        :param timeout: timeout (in seconds) positive integer (&gt; 0) for any</span>
<span class="sd">          power state. ``None`` indicates to use default timeout.</span>
<span class="sd">        :raises: ClientSideError (HTTP 409) if a power operation is</span>
<span class="sd">                 already in progress.</span>
<span class="sd">        :raises: InvalidStateRequested (HTTP 400) if the requested target</span>
<span class="sd">                 state is not valid or if the node is in CLEANING state.</span>
<span class="sd">        :raises: NotAcceptable (HTTP 406) for soft reboot, soft power off or</span>
<span class="sd">          timeout parameter, if requested version of the API is less than 1.27.</span>
<span class="sd">        :raises: Invalid (HTTP 400) if timeout value is less than 1.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_power_state&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="c1"># TODO(lucasagomes): Test if it&#39;s able to transition to the</span>
        <span class="c1">#                    target state from the current one</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">target</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ir_states</span><span class="o">.</span><span class="n">SOFT_REBOOT</span><span class="p">,</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">SOFT_POWER_OFF</span><span class="p">]</span> <span class="ow">or</span>
             <span class="n">timeout</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_soft_power_off</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>
        <span class="c1"># FIXME(naohirot): This check is workaround because</span>
        <span class="c1">#                  wtypes.IntegerType(minimum=1) is not effective</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;timeout has to be positive integer&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_TARGET_POWER_STATES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">(</span>
                <span class="n">action</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node_ident</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">power_state</span><span class="p">)</span>

        <span class="c1"># Don&#39;t change power state for nodes being cleaned</span>
        <span class="k">elif</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">provision_state</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ir_states</span><span class="o">.</span><span class="n">CLEANWAIT</span><span class="p">,</span>
                                          <span class="n">ir_states</span><span class="o">.</span><span class="n">CLEANING</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">(</span>
                <span class="n">action</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node_ident</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>

        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">change_node_power_state</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                                     <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="c1"># Set the HTTP Location Header</span>
        <span class="n">url_args</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node_ident</span><span class="p">,</span> <span class="s1">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">url_args</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeStatesController.provision&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>
<div class="viewcode-block" id="NodeStatesController.provision"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeStatesController.provision">[docs]</a>    <span class="k">def</span> <span class="nf">provision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">configdrive</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">clean_steps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asynchronous trigger the provisioning of the node.</span>

<span class="sd">        This will set the target provision state of the node, and a</span>
<span class="sd">        background task will begin which actually applies the state</span>
<span class="sd">        change. This call will return a 202 (Accepted) indicating the</span>
<span class="sd">        request was accepted and is in progress; the client should</span>
<span class="sd">        continue to GET the status of this node to observe the status</span>
<span class="sd">        of the requested action.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :param target: The desired provision state of the node or verb.</span>
<span class="sd">        :param configdrive: Optional. A gzipped and base64 encoded</span>
<span class="sd">            configdrive. Only valid when setting provision state</span>
<span class="sd">            to &quot;active&quot;.</span>
<span class="sd">        :param clean_steps: An ordered list of cleaning steps that will be</span>
<span class="sd">            performed on the node. A cleaning step is a dictionary with</span>
<span class="sd">            required keys &#39;interface&#39; and &#39;step&#39;, and optional key &#39;args&#39;. If</span>
<span class="sd">            specified, the value for &#39;args&#39; is a keyword variable argument</span>
<span class="sd">            dictionary that is passed to the cleaning step method.::</span>

<span class="sd">              { &#39;interface&#39;: &lt;driver_interface&gt;,</span>
<span class="sd">                &#39;step&#39;: &lt;name_of_clean_step&gt;,</span>
<span class="sd">                &#39;args&#39;: {&lt;arg1&gt;: &lt;value1&gt;, ..., &lt;argn&gt;: &lt;valuen&gt;} }</span>

<span class="sd">            For example (this isn&#39;t a real example, this cleaning step</span>
<span class="sd">            doesn&#39;t exist)::</span>

<span class="sd">              { &#39;interface&#39;: &#39;deploy&#39;,</span>
<span class="sd">                &#39;step&#39;: &#39;upgrade_firmware&#39;,</span>
<span class="sd">                &#39;args&#39;: {&#39;force&#39;: True} }</span>

<span class="sd">            This is required (and only valid) when target is &quot;clean&quot;.</span>
<span class="sd">        :raises: NodeLocked (HTTP 409) if the node is currently locked.</span>
<span class="sd">        :raises: ClientSideError (HTTP 409) if the node is already being</span>
<span class="sd">                 provisioned.</span>
<span class="sd">        :raises: InvalidParameterValue (HTTP 400), if validation of</span>
<span class="sd">                 clean_steps or power driver interface fails.</span>
<span class="sd">        :raises: InvalidStateRequested (HTTP 400) if the requested transition</span>
<span class="sd">                 is not possible from the current state.</span>
<span class="sd">        :raises: NodeInMaintenance (HTTP 400), if operation cannot be</span>
<span class="sd">                 performed because the node is in maintenance mode.</span>
<span class="sd">        :raises: NoFreeConductorWorker (HTTP 503) if no workers are available.</span>
<span class="sd">        :raises: NotAcceptable (HTTP 406) if the API version specified does</span>
<span class="sd">                 not allow the requested state transition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_provision_state&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_management_verbs</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">REBUILD</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">maintenance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeInMaintenance</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;provisioning&#39;</span><span class="p">),</span>
                                              <span class="n">node</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">machine</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">is_actionable_event</span><span class="p">(</span><span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">)):</span>
            <span class="c1"># Normally, we let the task manager recognize and deal with</span>
            <span class="c1"># NodeLocked exceptions. However, that isn&#39;t done until the RPC</span>
            <span class="c1"># calls below.</span>
            <span class="c1"># In order to main backward compatibility with our API HTTP</span>
            <span class="c1"># response codes, we have this check here to deal with cases where</span>
            <span class="c1"># a node is already being operated on (DEPLOYING or such) and we</span>
            <span class="c1"># want to continue returning 409. Without it, we&#39;d return 400.</span>
            <span class="k">if</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">reservation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NodeLocked</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                           <span class="n">host</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">(</span>
                <span class="n">action</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">provision_state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">configdrive</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">!=</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Adding a config drive is only supported when setting &#39;</span>
                     <span class="s1">&#39;provision state to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clean_steps</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">!=</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;&quot;clean_steps&quot; is only valid when setting target &#39;</span>
                     <span class="s1">&#39;provision state to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                <span class="n">msg</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>

        <span class="c1"># Note that there is a race condition. The node state(s) could change</span>
        <span class="c1"># by the time the RPC call is made and the TaskManager manager gets a</span>
        <span class="c1"># lock.</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                                                <span class="n">configdrive</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">REBUILD</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">do_node_deploy</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                                <span class="bp">None</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">DELETED</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">do_node_tear_down</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;inspect&#39;</span><span class="p">]:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">inspect_hardware</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">clean_steps</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;&quot;clean_steps&quot; is required when setting target &#39;</span>
                         <span class="s1">&#39;provision state to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>
            <span class="n">_check_clean_steps</span><span class="p">(</span><span class="n">clean_steps</span><span class="p">)</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">do_node_clean</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">clean_steps</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">PROVISION_ACTION_STATES</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">do_provisioning_action</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The requested action &quot;</span><span class="si">%(action)s</span><span class="s1">&quot; could not be &#39;</span>
                     <span class="s1">&#39;understood.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidStateRequested</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Set the HTTP Location Header</span>
        <span class="n">url_args</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">node_ident</span><span class="p">,</span> <span class="s1">&#39;states&#39;</span><span class="p">])</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">url_args</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_check_clean_steps</span><span class="p">(</span><span class="n">clean_steps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure all necessary keys are present and correct in clean steps.</span>

<span class="sd">    Check that the user-specified clean steps are in the expected format and</span>
<span class="sd">    include the required information.</span>

<span class="sd">    :param clean_steps: a list of clean steps. For more details, see the</span>
<span class="sd">        clean_steps parameter of :func:`NodeStatesController.provision`.</span>
<span class="sd">    :raises: InvalidParameterValue if validation of clean steps fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">clean_steps</span><span class="p">,</span> <span class="n">_CLEAN_STEPS_SCHEMA</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid clean_steps: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span>
                                              <span class="n">exc</span><span class="p">)</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">APIBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API representation of a bare metal node.</span>

<span class="sd">    This class enforces type checking and value constraints, and converts</span>
<span class="sd">    between the internal object model and the API representation of a node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_chassis_uuid</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_get_chassis_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chassis_uuid</span>

    <span class="k">def</span> <span class="nf">_set_chassis_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chassis_uuid</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chassis_uuid</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chassis</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Chassis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chassis_uuid</span> <span class="o">=</span> <span class="n">chassis</span><span class="o">.</span><span class="n">uuid</span>
                <span class="c1"># NOTE(lucasagomes): Create the chassis_id attribute on-the-fly</span>
                <span class="c1">#                    to satisfy the api -&gt; rpc object</span>
                <span class="c1">#                    conversion.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chassis_id</span> <span class="o">=</span> <span class="n">chassis</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ChassisNotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Change error code because 404 (NotFound) is inappropriate</span>
                <span class="c1"># response for a POST request to create a Port</span>
                <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
                <span class="k">raise</span>

    <span class="n">uuid</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span>
    <span class="sd">&quot;&quot;&quot;Unique UUID for this node&quot;&quot;&quot;</span>

    <span class="n">instance_uuid</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span>
    <span class="sd">&quot;&quot;&quot;The UUID of the instance in nova-compute&quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The logical name for this node&quot;&quot;&quot;</span>

    <span class="n">power_state</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Represent the current (not transition) power state of the node&quot;&quot;&quot;</span>

    <span class="n">target_power_state</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The user modified desired power state of the node.&quot;&quot;&quot;</span>

    <span class="n">last_error</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Any error from the most recent (last) asynchronous transaction that</span>
<span class="sd">    started but failed to finish.&quot;&quot;&quot;</span>

    <span class="n">provision_state</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Represent the current (not transition) provision state of the node&quot;&quot;&quot;</span>

    <span class="n">reservation</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The hostname of the conductor that holds an exclusive lock on</span>
<span class="sd">    the node.&quot;&quot;&quot;</span>

    <span class="n">provision_updated_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="sd">&quot;&quot;&quot;The UTC date and time of the last provision state change&quot;&quot;&quot;</span>

    <span class="n">inspection_finished_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="sd">&quot;&quot;&quot;The UTC date and time when the last hardware inspection finished</span>
<span class="sd">    successfully.&quot;&quot;&quot;</span>

    <span class="n">inspection_started_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="sd">&quot;&quot;&quot;The UTC date and time when the hardware inspection was started&quot;&quot;&quot;</span>

    <span class="n">maintenance</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span>
    <span class="sd">&quot;&quot;&quot;Indicates whether the node is in maintenance mode.&quot;&quot;&quot;</span>

    <span class="n">maintenance_reason</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Indicates reason for putting a node in maintenance mode.&quot;&quot;&quot;</span>

    <span class="n">target_provision_state</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The user modified desired provision state of the node.&quot;&quot;&quot;</span>

    <span class="n">console_enabled</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span>
    <span class="sd">&quot;&quot;&quot;Indicates whether the console access is enabled or disabled on</span>
<span class="sd">    the node.&quot;&quot;&quot;</span>

    <span class="n">instance_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;This node&#39;s instance info.&quot;&quot;&quot;</span>

    <span class="n">driver</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The driver responsible for controlling the node&quot;&quot;&quot;</span>

    <span class="n">driver_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;This node&#39;s driver configuration&quot;&quot;&quot;</span>

    <span class="n">driver_internal_info</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span>
                                       <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;This driver&#39;s internal configuration&quot;&quot;&quot;</span>

    <span class="n">clean_step</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The current clean step&quot;&quot;&quot;</span>

    <span class="n">raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Represents the current RAID configuration of the node &quot;&quot;&quot;</span>

    <span class="n">target_raid_config</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">({</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">},</span>
                                     <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The user modified RAID configuration of the node &quot;&quot;&quot;</span>

    <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;This node&#39;s meta data&quot;&quot;&quot;</span>

    <span class="n">resource_class</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">StringType</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;The resource class for the node, useful for classifying or grouping</span>
<span class="sd">       nodes. Used, for example, to classify nodes in Nova&#39;s placement</span>
<span class="sd">       engine.&quot;&quot;&quot;</span>

    <span class="c1"># NOTE: properties should use a class to enforce required properties</span>
    <span class="c1">#       current list: arch, cpus, disk, ram, image</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">jsontype</span><span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;The physical characteristics of this node&quot;&quot;&quot;</span>

    <span class="n">chassis_uuid</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsproperty</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">_get_chassis_uuid</span><span class="p">,</span>
                                   <span class="n">_set_chassis_uuid</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The UUID of the chassis this node belongs&quot;&quot;&quot;</span>

    <span class="n">links</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="p">],</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;A list containing a self link and associated node links&quot;&quot;&quot;</span>

    <span class="n">ports</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="p">],</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Links to the collection of ports on this node&quot;&quot;&quot;</span>

    <span class="n">portgroups</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="p">],</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Links to the collection of portgroups on this node&quot;&quot;&quot;</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">([</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="p">],</span> <span class="n">readonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Links to endpoint for retrieving and setting node states&quot;&quot;&quot;</span>

    <span class="n">boot_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The boot interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">console_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The console interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">deploy_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The deploy interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">inspect_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The inspect interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">management_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The management interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">network_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The network interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">power_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The power interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">raid_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The raid interface to be used for this node&quot;&quot;&quot;</span>

    <span class="n">vendor_interface</span> <span class="o">=</span> <span class="n">wsme</span><span class="o">.</span><span class="n">wsattr</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The vendor interface to be used for this node&quot;&quot;&quot;</span>

    <span class="c1"># NOTE(deva): &quot;conductor_affinity&quot; shouldn&#39;t be presented on the</span>
    <span class="c1">#             API because it&#39;s an internal value. Don&#39;t add it here.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
        <span class="c1"># NOTE(lucasagomes): chassis_uuid is not part of objects.Node.fields</span>
        <span class="c1"># because it&#39;s an API-only attribute.</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chassis_uuid&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="c1"># Add fields we expose.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">))</span>

        <span class="c1"># NOTE(lucasagomes): chassis_id is an attribute created on-the-fly</span>
        <span class="c1"># by _set_chassis_uuid(), it needs to be present in the fields so</span>
        <span class="c1"># that as_dict() will contain chassis_id field when converting it</span>
        <span class="c1"># before saving it in the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chassis_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;chassis_uuid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;chassis_uuid&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chassis_id&#39;</span><span class="p">,</span>
                                                     <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_with_links</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_states_links</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">show_portgroups</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># NOTE(lucasagomes): Since we are able to return a specified set of</span>
        <span class="c1"># fields the &quot;uuid&quot; can be unset, so we need to save it in another</span>
        <span class="c1"># variable to use when building the links</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">unset_fields_except</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                              <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/ports&quot;</span><span class="p">),</span>
                          <span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                              <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/ports&quot;</span><span class="p">,</span>
                                              <span class="n">bookmark</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                          <span class="p">]</span>
            <span class="k">if</span> <span class="n">show_states_links</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                                   <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/states&quot;</span><span class="p">),</span>
                               <span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                                   <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/states&quot;</span><span class="p">,</span>
                                                   <span class="n">bookmark</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">show_portgroups</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">portgroups</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                        <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/portgroups&quot;</span><span class="p">),</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                        <span class="n">node_uuid</span> <span class="o">+</span> <span class="s2">&quot;/portgroups&quot;</span><span class="p">,</span>
                                        <span class="n">bookmark</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>

        <span class="c1"># NOTE(lucasagomes): The numeric ID should not be exposed to</span>
        <span class="c1">#                    the user, it&#39;s internal only.</span>
        <span class="n">node</span><span class="o">.</span><span class="n">chassis_id</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span>

        <span class="n">node</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                          <span class="n">node_uuid</span><span class="p">),</span>
                      <span class="n">link</span><span class="o">.</span><span class="n">Link</span><span class="o">.</span><span class="n">make_link</span><span class="p">(</span><span class="s1">&#39;bookmark&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span>
                                          <span class="n">node_uuid</span><span class="p">,</span> <span class="n">bookmark</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                      <span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.convert_with_links"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.Node.convert_with_links">[docs]</a>    <span class="k">def</span> <span class="nf">convert_with_links</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="o">**</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">api_utils</span><span class="o">.</span><span class="n">check_for_invalid_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>

        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="c1"># NOTE(deva): the &#39;show_password&#39; policy setting name exists for legacy</span>
        <span class="c1">#             purposes and can not be changed. Changing it will cause</span>
        <span class="c1">#             upgrade problems for any operators who have customized</span>
        <span class="c1">#             the value of this field</span>
        <span class="n">show_driver_secrets</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;show_password&quot;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
        <span class="n">show_instance_secrets</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;show_instance_secrets&quot;</span><span class="p">,</span>
                                             <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_driver_secrets</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span> <span class="o">!=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">strutils</span><span class="o">.</span><span class="n">mask_dict_password</span><span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span><span class="p">,</span> <span class="s2">&quot;******&quot;</span><span class="p">)</span>

            <span class="c1"># NOTE(derekh): mask ssh keys for the ssh power driver.</span>
            <span class="c1"># As this driver is deprecated masking here (opposed to strutils)</span>
            <span class="c1"># is simpler, and easier to backport. This can be removed along</span>
            <span class="c1"># with support for the ssh power driver.</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssh_key_contents&#39;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">driver_info</span><span class="p">[</span><span class="s1">&#39;ssh_key_contents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;******&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_instance_secrets</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">!=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span> <span class="o">=</span> <span class="n">strutils</span><span class="o">.</span><span class="n">mask_dict_password</span><span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">,</span> <span class="s2">&quot;******&quot;</span><span class="p">)</span>
            <span class="c1"># NOTE(deva): agent driver may store a swift temp_url on the</span>
            <span class="c1"># instance_info, which shouldn&#39;t be exposed to non-admin users.</span>
            <span class="c1"># Now that ironic supports additional policies, we need to hide</span>
            <span class="c1"># it here, based on this policy.</span>
            <span class="c1"># Related to bug #1613903</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;image_url&#39;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">instance_info</span><span class="p">[</span><span class="s1">&#39;image_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;******&quot;</span>

        <span class="n">update_state_in_older_versions</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">hide_fields_in_newer_versions</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">show_states_links</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_links_node_states_and_driver_properties</span><span class="p">())</span>
        <span class="n">show_portgroups</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_portgroups_subcontrollers</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_with_links</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">public_url</span><span class="p">,</span>
                                       <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                                       <span class="n">show_states_links</span><span class="o">=</span><span class="n">show_states_links</span><span class="p">,</span>
                                       <span class="n">show_portgroups</span><span class="o">=</span><span class="n">show_portgroups</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Node.sample"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.Node.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">node_uuid</span> <span class="o">=</span> <span class="s1">&#39;1be26c0b-03f2-4d2e-ae87-c02d7f33c123&#39;</span>
        <span class="n">instance_uuid</span> <span class="o">=</span> <span class="s1">&#39;dcf1fbc5-93fc-4596-9395-b80572f6267b&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;database16-dc02&#39;</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="o">=</span><span class="n">instance_uuid</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">power_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">POWER_ON</span><span class="p">,</span>
                     <span class="n">target_power_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
                     <span class="n">last_error</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
                     <span class="n">target_provision_state</span><span class="o">=</span><span class="n">ir_states</span><span class="o">.</span><span class="n">NOSTATE</span><span class="p">,</span>
                     <span class="n">reservation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;fake&#39;</span><span class="p">,</span> <span class="n">driver_info</span><span class="o">=</span><span class="p">{},</span>
                     <span class="n">driver_internal_info</span><span class="o">=</span><span class="p">{},</span> <span class="n">extra</span><span class="o">=</span><span class="p">{},</span>
                     <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                         <span class="s1">&#39;memory_mb&#39;</span><span class="p">:</span> <span class="s1">&#39;1024&#39;</span><span class="p">,</span> <span class="s1">&#39;local_gb&#39;</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;cpus&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">},</span>
                     <span class="n">updated_at</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                     <span class="n">provision_updated_at</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">instance_info</span><span class="o">=</span><span class="p">{},</span>
                     <span class="n">maintenance</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">maintenance_reason</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">inspection_finished_at</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inspection_started_at</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                     <span class="n">console_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">clean_step</span><span class="o">=</span><span class="p">{},</span>
                     <span class="n">raid_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">target_raid_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">network_interface</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="n">resource_class</span><span class="o">=</span><span class="s1">&#39;baremetal-gold&#39;</span><span class="p">,</span>
                     <span class="n">boot_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">console_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">deploy_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inspect_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">management_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">power_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">raid_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">vendor_interface</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="c1"># NOTE(matty_dubs): The chassis_uuid getter() is based on the</span>
        <span class="c1"># _chassis_uuid variable:</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">_chassis_uuid</span> <span class="o">=</span> <span class="s1">&#39;edcad704-b2da-41d5-96d9-afd580ecfa12&#39;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">expand</span> <span class="k">else</span> <span class="n">_DEFAULT_RETURN_FIELDS</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_with_links</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;http://localhost:6385&#39;</span><span class="p">,</span>
                                       <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NodePatchType"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodePatchType">[docs]</a><span class="k">class</span> <span class="nc">NodePatchType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">JsonPatchType</span><span class="p">):</span>

    <span class="n">_api_base</span> <span class="o">=</span> <span class="n">Node</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NodePatchType.internal_attrs"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodePatchType.internal_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">internal_attrs</span><span class="p">():</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">JsonPatchType</span><span class="o">.</span><span class="n">internal_attrs</span><span class="p">()</span>
        <span class="c1"># TODO(lucasagomes): Include maintenance once the endpoint</span>
        <span class="c1"># v1/nodes/&lt;uuid&gt;/maintenance do more things than updating the DB.</span>
        <span class="k">return</span> <span class="n">defaults</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;/console_enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;/last_error&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/power_state&#39;</span><span class="p">,</span> <span class="s1">&#39;/provision_state&#39;</span><span class="p">,</span> <span class="s1">&#39;/reservation&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/target_power_state&#39;</span><span class="p">,</span> <span class="s1">&#39;/target_provision_state&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/provision_updated_at&#39;</span><span class="p">,</span> <span class="s1">&#39;/maintenance_reason&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/driver_internal_info&#39;</span><span class="p">,</span> <span class="s1">&#39;/inspection_finished_at&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/inspection_started_at&#39;</span><span class="p">,</span> <span class="s1">&#39;/clean_step&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;/raid_config&#39;</span><span class="p">,</span> <span class="s1">&#39;/target_raid_config&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="NodeCollection"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeCollection">[docs]</a><span class="k">class</span> <span class="nc">NodeCollection</span><span class="p">(</span><span class="n">collection</span><span class="o">.</span><span class="n">Collection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API representation of a collection of nodes.&quot;&quot;&quot;</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;A list containing nodes objects&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="s1">&#39;nodes&#39;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="NodeCollection.convert_with_links"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeCollection.convert_with_links">[docs]</a>    <span class="k">def</span> <span class="nf">convert_with_links</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">NodeCollection</span><span class="p">()</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Node</span><span class="o">.</span><span class="n">convert_with_links</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
        <span class="n">collection</span><span class="o">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">get_next</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">collection</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="NodeCollection.sample"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeCollection.sample">[docs]</a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sample</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sample</span></div></div>


<div class="viewcode-block" id="NodeVendorPassthruController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVendorPassthruController">[docs]</a><span class="k">class</span> <span class="nc">NodeVendorPassthruController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;REST controller for VendorPassthru.</span>

<span class="sd">    This controller allow vendors to expose a custom functionality in</span>
<span class="sd">    the Ironic API. Ironic will merely relay the message from here to the</span>
<span class="sd">    appropriate driver, no introspection will be made in the message body.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeVendorPassthruController.methods&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">)</span>
<div class="viewcode-block" id="NodeVendorPassthruController.methods"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVendorPassthruController.methods">[docs]</a>    <span class="k">def</span> <span class="nf">methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve information about vendor methods of the given node.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :returns: dictionary with &lt;vendor method name&gt;:&lt;method metadata&gt;</span>
<span class="sd">                  entries.</span>
<span class="sd">        :raises: NodeNotFound if the node is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:vendor_passthru&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="c1"># Raise an exception if node is not found</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">driver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_VENDOR_METHODS</span><span class="p">:</span>
            <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_node_vendor_passthru_methods</span><span class="p">(</span>
                <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
            <span class="n">_VENDOR_METHODS</span><span class="p">[</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">_VENDOR_METHODS</span><span class="p">[</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">driver</span><span class="p">]</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeVendorPassthruController._default&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">body</span><span class="o">=</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call a vendor extension.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :param method: name of the method in vendor driver.</span>
<span class="sd">        :param data: body of data to supply to the specified method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:vendor_passthru&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="c1"># Raise an exception if node is not found</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">vendor_passthru</span><span class="p">(</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span>
                                         <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="NodeMaintenanceController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeMaintenanceController">[docs]</a><span class="k">class</span> <span class="nc">NodeMaintenanceController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_set_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">maintenance_mode</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">rpc_node</span><span class="o">.</span><span class="n">maintenance</span> <span class="o">=</span> <span class="n">maintenance_mode</span>
        <span class="n">rpc_node</span><span class="o">.</span><span class="n">maintenance_reason</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_start_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;maintenance_set&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">notify</span><span class="o">.</span><span class="n">handle_error_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span>
                                              <span class="s1">&#39;maintenance_set&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidHost</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
                <span class="k">raise</span>

            <span class="n">new_node</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span>
                                                        <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_end_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;maintenance_set&#39;</span><span class="p">)</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeMaintenanceController.put&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>
<div class="viewcode-block" id="NodeMaintenanceController.put"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeMaintenanceController.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put the node in maintenance mode.</span>

<span class="sd">        :param node_ident: the UUID or logical_name of a node.</span>
<span class="sd">        :param reason: Optional, the reason why it&#39;s in maintenance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:set_maintenance&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_maintenance</span><span class="p">(</span><span class="n">node_ident</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeMaintenanceController.delete&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">ACCEPTED</span><span class="p">)</span>
<div class="viewcode-block" id="NodeMaintenanceController.delete"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeMaintenanceController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the node from maintenance mode.</span>

<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:clear_maintenance&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_maintenance</span><span class="p">(</span><span class="n">node_ident</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div></div>


<span class="c1"># NOTE(vsaienko) We don&#39;t support pagination with VIFs, so we don&#39;t use</span>
<span class="c1"># collection.Collection here.</span>
<div class="viewcode-block" id="VifCollection"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.VifCollection">[docs]</a><span class="k">class</span> <span class="nc">VifCollection</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;API representation of a collection of VIFs. &quot;&quot;&quot;</span>

    <span class="n">vifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">viftype</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;A list containing VIFs objects&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="VifCollection.collection_from_list"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.VifCollection.collection_from_list">[docs]</a>    <span class="k">def</span> <span class="nf">collection_from_list</span><span class="p">(</span><span class="n">vifs</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">VifCollection</span><span class="p">()</span>
        <span class="n">col</span><span class="o">.</span><span class="n">vifs</span> <span class="o">=</span> <span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">VifType</span><span class="o">.</span><span class="n">frombasetype</span><span class="p">(</span><span class="n">vif</span><span class="p">)</span> <span class="k">for</span> <span class="n">vif</span> <span class="ow">in</span> <span class="n">vifs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">col</span></div></div>


<div class="viewcode-block" id="NodeVIFController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVIFController">[docs]</a><span class="k">class</span> <span class="nc">NodeVIFController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_ident</span> <span class="o">=</span> <span class="n">node_ident</span>

    <span class="k">def</span> <span class="nf">_get_node_and_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidHost</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
            <span class="k">raise</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeVIFController.get_all&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">VifCollection</span><span class="p">)</span>
<div class="viewcode-block" id="NodeVIFController.get_all"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVIFController.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of attached VIFs&quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:vif:list&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
        <span class="n">rpc_node</span><span class="p">,</span> <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_and_topic</span><span class="p">()</span>
        <span class="n">vifs</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">vif_list</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                             <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">VifCollection</span><span class="o">.</span><span class="n">collection_from_list</span><span class="p">(</span><span class="n">vifs</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeVIFController.post&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">viftype</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>
<div class="viewcode-block" id="NodeVIFController.post"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVIFController.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vif</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a VIF to this node</span>

<span class="sd">        :param vif_info: a dictionary of information about a VIF.</span>
<span class="sd">            It must have an &#39;id&#39; key, whose value is a unique identifier</span>
<span class="sd">            for that VIF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:vif:attach&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
        <span class="n">rpc_node</span><span class="p">,</span> <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_and_topic</span><span class="p">()</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">vif_attach</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                        <span class="n">vif_info</span><span class="o">=</span><span class="n">vif</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodeVIFController.delete&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>
<div class="viewcode-block" id="NodeVIFController.delete"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodeVIFController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vif_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detach a VIF from this node</span>

<span class="sd">        :param vif_id: The ID of a VIF to detach</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:vif:detach&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
        <span class="n">rpc_node</span><span class="p">,</span> <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_and_topic</span><span class="p">()</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">vif_detach</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                        <span class="n">vif_id</span><span class="o">=</span><span class="n">vif_id</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NodesController"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController">[docs]</a><span class="k">class</span> <span class="nc">NodesController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;REST controller for Nodes.&quot;&quot;&quot;</span>

    <span class="c1"># NOTE(lucasagomes): For future reference. If we happen</span>
    <span class="c1"># to need to add another sub-controller in this class let&#39;s</span>
    <span class="c1"># try to make it a parameter instead of an endpoint due</span>
    <span class="c1"># https://bugs.launchpad.net/ironic/+bug/1572651, e.g, instead of</span>
    <span class="c1"># v1/nodes/(ident)/detail we could have v1/nodes/(ident)?detail=True</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">NodeStatesController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose the state controller action as a sub-element of nodes&quot;&quot;&quot;</span>

    <span class="n">vendor_passthru</span> <span class="o">=</span> <span class="n">NodeVendorPassthruController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;A resource used for vendors to expose a custom functionality in</span>
<span class="sd">    the API&quot;&quot;&quot;</span>

    <span class="n">management</span> <span class="o">=</span> <span class="n">NodeManagementController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose management as a sub-element of nodes&quot;&quot;&quot;</span>

    <span class="n">maintenance</span> <span class="o">=</span> <span class="n">NodeMaintenanceController</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Expose maintenance as a sub-element of nodes&quot;&quot;&quot;</span>

    <span class="n">from_chassis</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;A flag to indicate if the requests to this controller are coming</span>
<span class="sd">    from the top-level resource Chassis&quot;&quot;&quot;</span>

    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;detail&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span>
        <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">invalid_sort_key_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="s1">&#39;driver_info&#39;</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;instance_info&#39;</span><span class="p">,</span> <span class="s1">&#39;driver_internal_info&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;clean_step&#39;</span><span class="p">,</span> <span class="s1">&#39;raid_config&#39;</span><span class="p">,</span> <span class="s1">&#39;target_raid_config&#39;</span><span class="p">]</span>

    <span class="n">_subcontroller_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ports&#39;</span><span class="p">:</span> <span class="n">port</span><span class="o">.</span><span class="n">PortsController</span><span class="p">,</span>
        <span class="s1">&#39;portgroups&#39;</span><span class="p">:</span> <span class="n">portgroup</span><span class="o">.</span><span class="n">PortgroupsController</span><span class="p">,</span>
        <span class="s1">&#39;vifs&#39;</span><span class="p">:</span> <span class="n">NodeVIFController</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@pecan.expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidUuidOrName</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remainder</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">remainder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;portgroups&#39;</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_portgroups_subcontrollers</span><span class="p">())</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">remainder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vifs&#39;</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_vifs_subcontroller</span><span class="p">())):</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">http_client</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
        <span class="n">subcontroller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subcontroller_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remainder</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">subcontroller</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">subcontroller</span><span class="p">(</span><span class="n">node_ident</span><span class="o">=</span><span class="n">ident</span><span class="p">),</span> <span class="n">remainder</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">_get_nodes_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chassis_uuid</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="p">,</span> <span class="n">associated</span><span class="p">,</span>
                              <span class="n">maintenance</span><span class="p">,</span> <span class="n">provision_state</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
                              <span class="n">sort_key</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">resource_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">resource_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_chassis</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">chassis_uuid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingParameterValue</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Chassis id not specified.&quot;</span><span class="p">))</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">validate_limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">sort_dir</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">validate_sort_dir</span><span class="p">(</span><span class="n">sort_dir</span><span class="p">)</span>

        <span class="n">marker_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">marker</span><span class="p">:</span>
            <span class="n">marker_obj</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_uuid</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                  <span class="n">marker</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalid_sort_key_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidParameterValue</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The sort_key value </span><span class="si">%(key)s</span><span class="s2"> is an invalid field for &quot;</span>
                  <span class="s2">&quot;sorting&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">sort_key</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">instance_uuid</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_by_instance</span><span class="p">(</span><span class="n">instance_uuid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">chassis_uuid</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;chassis_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chassis_uuid</span>
            <span class="k">if</span> <span class="n">associated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;associated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">associated</span>
            <span class="k">if</span> <span class="n">maintenance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;maintenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maintenance</span>
            <span class="k">if</span> <span class="n">provision_state</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;provision_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">provision_state</span>
            <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;driver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">driver</span>
            <span class="k">if</span> <span class="n">resource_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;resource_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_class</span>

            <span class="n">nodes</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">marker_obj</span><span class="p">,</span>
                                      <span class="n">sort_key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                                      <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sort_key&#39;</span><span class="p">:</span> <span class="n">sort_key</span><span class="p">,</span> <span class="s1">&#39;sort_dir&#39;</span><span class="p">:</span> <span class="n">sort_dir</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">associated</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;associated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">associated</span>
        <span class="k">if</span> <span class="n">maintenance</span><span class="p">:</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;maintenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maintenance</span>
        <span class="k">return</span> <span class="n">NodeCollection</span><span class="o">.</span><span class="n">convert_with_links</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
                                                 <span class="n">url</span><span class="o">=</span><span class="n">resource_url</span><span class="p">,</span>
                                                 <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_nodes_by_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a node by its instance uuid.</span>

<span class="sd">        It returns a list with the node, or an empty list if no node is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">get_by_instance_uuid</span><span class="p">(</span><span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="n">instance_uuid</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">InstanceNotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_check_names_acceptable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks all node &#39;name&#39;s are acceptable, it does not return a value.</span>

<span class="sd">        This function will raise an exception for unacceptable names.</span>

<span class="sd">        :param names: list of node names to check</span>
<span class="sd">        :param error_msg: error message in case of wsme.exc.ClientSideError,</span>
<span class="sd">            should contain %(name)s placeholder.</span>
<span class="sd">        :raises: exception.NotAcceptable</span>
<span class="sd">        :raises: wsme.exc.ClientSideError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_node_logical_names</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="n">reserved_names</span> <span class="o">=</span> <span class="n">get_nodes_controller_reserved_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">is_valid_node_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                    <span class="n">error_msg</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reserved_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                    <span class="s1">&#39;The word &quot;</span><span class="si">%(name)s</span><span class="s1">&quot; is reserved and can not be used as a &#39;</span>
                    <span class="s1">&#39;node name. Reserved words are: </span><span class="si">%(reserved)s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                    <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                     <span class="s1">&#39;reserved&#39;</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reserved_names</span><span class="p">)},</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_changed_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update rpc_node based on changed fields in a node.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">patch_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># Ignore fields that aren&#39;t exposed in the API, except</span>
                <span class="c1"># chassis_id. chassis_id would have been set (instead of</span>
                <span class="c1"># chassis_uuid) if the node belongs to a chassis. This</span>
                <span class="c1"># AttributeError is raised for chassis_id only if</span>
                <span class="c1"># 1. the node doesn&#39;t belong to a chassis or</span>
                <span class="c1"># 2. the node belonged to a chassis but is now being removed</span>
                <span class="c1"># from the chassis.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;chassis_id&quot;</span> <span class="ow">and</span> <span class="n">rpc_node</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_remove_chassis_uuid</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>
                    <span class="n">rpc_node</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">patch_val</span> <span class="o">==</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">:</span>
                <span class="n">patch_val</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">rpc_node</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">!=</span> <span class="n">patch_val</span><span class="p">:</span>
                <span class="n">rpc_node</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">patch_val</span>

    <span class="k">def</span> <span class="nf">_check_driver_changed_and_console_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if the driver and the console is enabled in a node.</span>

<span class="sd">        If it does, is necessary to prevent updating it because the new driver</span>
<span class="sd">        will not be able to stop a console started by the previous one.</span>

<span class="sd">        :param rpc_node: RPC Node object to be verified.</span>
<span class="sd">        :param node_ident: the UUID or logical name of a node.</span>
<span class="sd">        :raises: wsme.exc.ClientSideError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">obj_what_changed</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;driver&#39;</span> <span class="ow">in</span> <span class="n">delta</span> <span class="ow">and</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">console_enabled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Node </span><span class="si">%s</span><span class="s2"> can not update the driver while the console is &quot;</span>
                  <span class="s2">&quot;enabled. Please stop the console first.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">node_ident</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">CONFLICT</span><span class="p">)</span>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.get_all&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">NodeCollection</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span>
                   <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">listtype</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.get_all"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chassis_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">associated</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">maintenance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resource_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a list of nodes.</span>

<span class="sd">        :param chassis_uuid: Optional UUID of a chassis, to get only nodes for</span>
<span class="sd">                             that chassis.</span>
<span class="sd">        :param instance_uuid: Optional UUID of an instance, to find the node</span>
<span class="sd">                              associated with that instance.</span>
<span class="sd">        :param associated: Optional boolean whether to return a list of</span>
<span class="sd">                           associated or unassociated nodes. May be combined</span>
<span class="sd">                           with other parameters.</span>
<span class="sd">        :param maintenance: Optional boolean value that indicates whether</span>
<span class="sd">                            to get nodes in maintenance mode (&quot;True&quot;), or not</span>
<span class="sd">                            in maintenance mode (&quot;False&quot;).</span>
<span class="sd">        :param provision_state: Optional string value to get only nodes in</span>
<span class="sd">                                that provision state.</span>
<span class="sd">        :param marker: pagination marker for large data sets.</span>
<span class="sd">        :param limit: maximum number of resources to return in a single result.</span>
<span class="sd">                      This value cannot be larger than the value of max_limit</span>
<span class="sd">                      in the [api] section of the ironic configuration, or only</span>
<span class="sd">                      max_limit resources will be returned.</span>
<span class="sd">        :param sort_key: column to sort results by. Default: id.</span>
<span class="sd">        :param sort_dir: direction to sort. &quot;asc&quot; or &quot;desc&quot;. Default: asc.</span>
<span class="sd">        :param driver: Optional string value to get only nodes using that</span>
<span class="sd">                       driver.</span>
<span class="sd">        :param resource_class: Optional string value to get only nodes with</span>
<span class="sd">                               that resource_class.</span>
<span class="sd">        :param fields: Optional, a list with a specified set of fields</span>
<span class="sd">                       of the resource to be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allowed_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_for_invalid_state_and_allow_filter</span><span class="p">(</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_resource_class</span><span class="p">(</span><span class="n">resource_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">_DEFAULT_RETURN_FIELDS</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_collection</span><span class="p">(</span><span class="n">chassis_uuid</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="p">,</span>
                                          <span class="n">associated</span><span class="p">,</span> <span class="n">maintenance</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span>
                                          <span class="n">limit</span><span class="p">,</span> <span class="n">sort_key</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                                          <span class="n">resource_class</span><span class="o">=</span><span class="n">resource_class</span><span class="p">,</span>
                                          <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.detail&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">NodeCollection</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span>
                   <span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                   <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.detail"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.detail">[docs]</a>    <span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chassis_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">associated</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">maintenance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provision_state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">resource_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a list of nodes with detail.</span>

<span class="sd">        :param chassis_uuid: Optional UUID of a chassis, to get only nodes for</span>
<span class="sd">                           that chassis.</span>
<span class="sd">        :param instance_uuid: Optional UUID of an instance, to find the node</span>
<span class="sd">                              associated with that instance.</span>
<span class="sd">        :param associated: Optional boolean whether to return a list of</span>
<span class="sd">                           associated or unassociated nodes. May be combined</span>
<span class="sd">                           with other parameters.</span>
<span class="sd">        :param maintenance: Optional boolean value that indicates whether</span>
<span class="sd">                            to get nodes in maintenance mode (&quot;True&quot;), or not</span>
<span class="sd">                            in maintenance mode (&quot;False&quot;).</span>
<span class="sd">        :param provision_state: Optional string value to get only nodes in</span>
<span class="sd">                                that provision state.</span>
<span class="sd">        :param marker: pagination marker for large data sets.</span>
<span class="sd">        :param limit: maximum number of resources to return in a single result.</span>
<span class="sd">                      This value cannot be larger than the value of max_limit</span>
<span class="sd">                      in the [api] section of the ironic configuration, or only</span>
<span class="sd">                      max_limit resources will be returned.</span>
<span class="sd">        :param sort_key: column to sort results by. Default: id.</span>
<span class="sd">        :param sort_dir: direction to sort. &quot;asc&quot; or &quot;desc&quot;. Default: asc.</span>
<span class="sd">        :param driver: Optional string value to get only nodes using that</span>
<span class="sd">                       driver.</span>
<span class="sd">        :param resource_class: Optional string value to get only nodes with</span>
<span class="sd">                               that resource_class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_for_invalid_state_and_allow_filter</span><span class="p">(</span><span class="n">provision_state</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_resource_class</span><span class="p">(</span><span class="n">resource_class</span><span class="p">)</span>
        <span class="c1"># /detail should only work against collections</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s2">&quot;nodes&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">()</span>

        <span class="n">resource_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;detail&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_collection</span><span class="p">(</span><span class="n">chassis_uuid</span><span class="p">,</span> <span class="n">instance_uuid</span><span class="p">,</span>
                                          <span class="n">associated</span><span class="p">,</span> <span class="n">maintenance</span><span class="p">,</span>
                                          <span class="n">provision_state</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span>
                                          <span class="n">limit</span><span class="p">,</span> <span class="n">sort_key</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">,</span>
                                          <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                                          <span class="n">resource_class</span><span class="o">=</span><span class="n">resource_class</span><span class="p">,</span>
                                          <span class="n">resource_url</span><span class="o">=</span><span class="n">resource_url</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.validate&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.validate"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">node_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the driver interfaces, using the node&#39;s UUID or name.</span>

<span class="sd">        Note that the &#39;node_uuid&#39; interface is deprecated in favour</span>
<span class="sd">        of the &#39;node&#39; interface</span>

<span class="sd">        :param node: UUID or name of a node.</span>
<span class="sd">        :param node_uuid: UUID of a node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:validate&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># We&#39;re invoking this interface using positional notation, or</span>
            <span class="c1"># explicitly using &#39;node&#39;.  Try and determine which one.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_node_logical_names</span><span class="p">()</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">is_uuid_like</span><span class="p">(</span><span class="n">node</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_uuid</span> <span class="ow">or</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">validate_driver_interfaces</span><span class="p">(</span>
            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.get_one&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">listtype</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.get_one"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.get_one">[docs]</a>    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve information about the given node.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :param fields: Optional, a list with a specified set of fields</span>
<span class="sd">            of the resource to be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:get&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_chassis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">OperationNotPermitted</span><span class="p">()</span>

        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allow_specify_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">api_utils</span><span class="o">.</span><span class="n">check_allowed_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Node</span><span class="o">.</span><span class="n">convert_with_links</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.post&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">Node</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">CREATED</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.post"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new node.</span>

<span class="sd">        :param node: a node within the request body.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:create&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_chassis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">OperationNotPermitted</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_resource_class</span><span class="p">()</span> <span class="ow">and</span>
                <span class="n">node</span><span class="o">.</span><span class="n">resource_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="n">n_interface</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">network_interface</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_network_interface</span><span class="p">()</span> <span class="ow">and</span>
                <span class="n">n_interface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_dynamic_interfaces</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">V31_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">wsme</span><span class="o">.</span><span class="n">Unset</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="c1"># NOTE(deva): get_topic_for checks if node.driver is in the hash ring</span>
        <span class="c1">#             and raises NoValidHost if it is not.</span>
        <span class="c1">#             We need to ensure that node has a UUID before it can</span>
        <span class="c1">#             be mapped onto the hash ring.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidHost</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># NOTE(deva): convert from 404 to 400 because client can see</span>
            <span class="c1">#             list of available drivers and shouldn&#39;t request</span>
            <span class="c1">#             one that doesn&#39;t exist.</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">Unset</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cannot create node with invalid name &#39;</span><span class="si">%(name)s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_names_acceptable</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">error_msg</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">provision_state</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">initial_node_provision_state</span><span class="p">()</span>

        <span class="n">new_node</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">node</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_start_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
                                       <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">notify</span><span class="o">.</span><span class="n">handle_error_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
                                              <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">):</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                                                        <span class="n">new_node</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="c1"># Set the HTTP Location Header</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="n">new_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">api_node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">convert_with_links</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_end_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span>
                                     <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">api_node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_node</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.patch&#39;</span><span class="p">)</span>
    <span class="nd">@wsme.validate</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="p">[</span><span class="n">NodePatchType</span><span class="p">])</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="p">[</span><span class="n">NodePatchType</span><span class="p">])</span>
<div class="viewcode-block" id="NodesController.patch"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.patch">[docs]</a>    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">patch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update an existing node.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        :param patch: a json PATCH document to apply to this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:update&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_chassis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">OperationNotPermitted</span><span class="p">()</span>

        <span class="n">resource_class</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_patch_values</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;/resource_class&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource_class</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_resource_class</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="n">n_interfaces</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_patch_values</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;/network_interface&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_interfaces</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_network_interface</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">allow_dynamic_interfaces</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">V31_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_patch_values</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotAcceptable</span><span class="p">()</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>

        <span class="n">remove_inst_uuid_patch</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/instance_uuid&#39;</span><span class="p">}]</span>
        <span class="k">if</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">maintenance</span> <span class="ow">and</span> <span class="n">patch</span> <span class="o">==</span> <span class="n">remove_inst_uuid_patch</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removing instance uuid </span><span class="si">%(instance)s</span><span class="s1"> from node </span><span class="si">%(node)s</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="p">{</span><span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">instance_uuid</span><span class="p">,</span>
                       <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">})</span>
        <span class="c1"># Check if node is transitioning state, although nodes in some states</span>
        <span class="c1"># can be updated.</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">rpc_node</span><span class="o">.</span><span class="n">target_provision_state</span> <span class="ow">and</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">provision_state</span>
              <span class="ow">not</span> <span class="ow">in</span> <span class="n">ir_states</span><span class="o">.</span><span class="n">UPDATE_ALLOWED_STATES</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Node </span><span class="si">%s</span><span class="s2"> can not be updated while a state transition &quot;</span>
                    <span class="s2">&quot;is in progress.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">wsme</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">ClientSideError</span><span class="p">(</span>
                <span class="n">msg</span> <span class="o">%</span> <span class="n">node_ident</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">CONFLICT</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_patch_values</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="s1">&#39;/name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Node </span><span class="si">%s</span><span class="s2">: Cannot change name to invalid name &quot;</span><span class="p">)</span>
                         <span class="o">%</span> <span class="n">node_ident</span><span class="p">)</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;&#39;</span><span class="si">%(name)s</span><span class="s2">&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_names_acceptable</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">node_dict</span> <span class="o">=</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="c1"># NOTE(lucasagomes):</span>
            <span class="c1"># 1) Remove chassis_id because it&#39;s an internal value and</span>
            <span class="c1">#    not present in the API object</span>
            <span class="c1"># 2) Add chassis_uuid</span>
            <span class="n">node_dict</span><span class="p">[</span><span class="s1">&#39;chassis_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;chassis_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="o">**</span><span class="n">api_utils</span><span class="o">.</span><span class="n">apply_jsonpatch</span><span class="p">(</span><span class="n">node_dict</span><span class="p">,</span> <span class="n">patch</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">JSONPATCH_EXCEPTIONS</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">PatchError</span><span class="p">(</span><span class="n">patch</span><span class="o">=</span><span class="n">patch</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_changed_fields</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">)</span>
        <span class="c1"># NOTE(deva): we calculate the rpc topic here in case node.driver</span>
        <span class="c1">#             has changed, so that update is sent to the</span>
        <span class="c1">#             new conductor, not the old one which may fail to</span>
        <span class="c1">#             load the new driver.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidHost</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># NOTE(deva): convert from 404 to 400 because client can see</span>
            <span class="c1">#             list of available drivers and shouldn&#39;t request</span>
            <span class="c1">#             one that doesn&#39;t exist.</span>
            <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_driver_changed_and_console_enabled</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">)</span>

        <span class="n">notify</span><span class="o">.</span><span class="n">emit_start_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                                       <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">notify</span><span class="o">.</span><span class="n">handle_error_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                                              <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">):</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">update_node</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                                                        <span class="n">rpc_node</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>

        <span class="n">api_node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">convert_with_links</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_end_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">,</span>
                                     <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">api_node</span><span class="o">.</span><span class="n">chassis_uuid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api_node</span></div>

    <span class="nd">@METRICS.timer</span><span class="p">(</span><span class="s1">&#39;NodesController.delete&#39;</span><span class="p">)</span>
    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">uuid_or_name</span><span class="p">,</span>
                   <span class="n">status_code</span><span class="o">=</span><span class="n">http_client</span><span class="o">.</span><span class="n">NO_CONTENT</span><span class="p">)</span>
<div class="viewcode-block" id="NodesController.delete"><a class="viewcode-back" href="../../../../../api/ironic.api.controllers.v1.node.html#ironic.api.controllers.v1.node.NodesController.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_ident</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a node.</span>

<span class="sd">        :param node_ident: UUID or logical name of a node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">context</span>
        <span class="n">cdict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_policy_values</span><span class="p">()</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">authorize</span><span class="p">(</span><span class="s1">&#39;baremetal:node:delete&#39;</span><span class="p">,</span> <span class="n">cdict</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_chassis</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">OperationNotPermitted</span><span class="p">()</span>

        <span class="n">rpc_node</span> <span class="o">=</span> <span class="n">api_utils</span><span class="o">.</span><span class="n">get_rpc_node</span><span class="p">(</span><span class="n">node_ident</span><span class="p">)</span>
        <span class="n">chassis_uuid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">chassis_id</span><span class="p">:</span>
            <span class="n">chassis_uuid</span> <span class="o">=</span> <span class="n">objects</span><span class="o">.</span><span class="n">Chassis</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="n">rpc_node</span><span class="o">.</span><span class="n">chassis_id</span><span class="p">)</span><span class="o">.</span><span class="n">uuid</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_start_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                                       <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">chassis_uuid</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">notify</span><span class="o">.</span><span class="n">handle_error_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                                              <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">chassis_uuid</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">topic</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">get_topic_for</span><span class="p">(</span><span class="n">rpc_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NoValidHost</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
                <span class="k">raise</span>

            <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">destroy_node</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">topic</span><span class="p">)</span>
        <span class="n">notify</span><span class="o">.</span><span class="n">emit_end_notification</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rpc_node</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                                     <span class="n">chassis_uuid</span><span class="o">=</span><span class="n">chassis_uuid</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/ironic
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">Ironic 7.0.1.dev7 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/Ironic");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>