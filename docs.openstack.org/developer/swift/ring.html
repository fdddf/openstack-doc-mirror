<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Partitioned Consistent Hash Ring &mdash; swift 2.12.1.dev102 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.12.1.dev102',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="swift 2.12.1.dev102 documentation" href="index.html" />
    <link rel="next" title="Proxy" href="proxy.html" />
    <link rel="prev" title="Use the Content-Disposition metadata" href="api/use_the_content-disposition_metadata.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="partitioned-consistent-hash-ring">
<span id="consistent-hashing-ring"></span><h1>Partitioned Consistent Hash Ring<a class="headerlink" href="#partitioned-consistent-hash-ring" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ring">
<span id="id1"></span><h2>Ring<a class="headerlink" href="#ring" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.ring.ring"></span><dl class="class">
<dt id="swift.common.ring.ring.Ring">
<em class="property">class </em><code class="descclassname">swift.common.ring.ring.</code><code class="descname">Ring</code><span class="sig-paren">(</span><em>serialized_path</em>, <em>reload_time=15</em>, <em>ring_name=None</em>, <em>validation_hook=&lt;function &lt;lambda&gt;&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Partitioned consistent hashing ring.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>serialized_path</strong> &#8211; path to serialized RingData instance</li>
<li><strong>reload_time</strong> &#8211; time interval in seconds to check for a ring change</li>
<li><strong>ring_name</strong> &#8211; ring name string (basically specified from policy)</li>
<li><strong>validation_hook</strong> &#8211; hook point to validate ring configuration ontime</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last">RingLoadError if the loaded ring data violates its constraint</p>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="swift.common.ring.ring.Ring.devs">
<code class="descname">devs</code><a class="headerlink" href="#swift.common.ring.ring.Ring.devs" title="Permalink to this definition">¶</a></dt>
<dd><p>devices in the ring</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.Ring.get_more_nodes">
<code class="descname">get_more_nodes</code><span class="sig-paren">(</span><em>part</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring.get_more_nodes" title="Permalink to this definition">¶</a></dt>
<dd><p>Generator to get extra nodes for a partition for hinted handoff.</p>
<p>The handoff nodes will try to be in zones other than the
primary zones, will take into account the device weights, and
will usually keep the same sequences of handoffs even with
ring changes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>part</strong> &#8211; partition to get handoff nodes for</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">generator of node dicts</td>
</tr>
</tbody>
</table>
<p>See <a class="reference internal" href="#swift.common.ring.ring.Ring.get_nodes" title="swift.common.ring.ring.Ring.get_nodes"><code class="xref py py-func docutils literal"><span class="pre">get_nodes()</span></code></a> for a description of the node dicts.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.Ring.get_nodes">
<code class="descname">get_nodes</code><span class="sig-paren">(</span><em>account</em>, <em>container=None</em>, <em>obj=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring.get_nodes" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the partition and nodes for an account/container/object.
If a node is responsible for more than one replica, it will
only appear in the output once.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>account</strong> &#8211; account name</li>
<li><strong>container</strong> &#8211; container name</li>
<li><strong>obj</strong> &#8211; object name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a tuple of (partition, list of node dicts)</p>
</td>
</tr>
</tbody>
</table>
<p>Each node dict will have at least the following keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>id</td>
<td>unique integer identifier amongst devices</td>
</tr>
<tr class="row-even"><td>index</td>
<td>offset into the primary node list for the partition</td>
</tr>
<tr class="row-odd"><td>weight</td>
<td>a float of the relative weight of this device as compared to
others; this indicates how many partitions the builder will try
to assign to this device</td>
</tr>
<tr class="row-even"><td>zone</td>
<td>integer indicating which zone the device is in; a given
partition will not be assigned to multiple devices within the
same zone</td>
</tr>
<tr class="row-odd"><td>ip</td>
<td>the ip address of the device</td>
</tr>
<tr class="row-even"><td>port</td>
<td>the tcp port of the device</td>
</tr>
<tr class="row-odd"><td>device</td>
<td>the device&#8217;s name on disk (sdb1, for example)</td>
</tr>
<tr class="row-even"><td>meta</td>
<td>general use &#8216;extra&#8217; field; for example: the online date, the
hardware description</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.Ring.get_part">
<code class="descname">get_part</code><span class="sig-paren">(</span><em>account</em>, <em>container=None</em>, <em>obj=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring.get_part" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the partition for an account/container/object.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>account</strong> &#8211; account name</li>
<li><strong>container</strong> &#8211; container name</li>
<li><strong>obj</strong> &#8211; object name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the partition number</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.Ring.get_part_nodes">
<code class="descname">get_part_nodes</code><span class="sig-paren">(</span><em>part</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring.get_part_nodes" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the nodes that are responsible for the partition. If one
node is responsible for more than one replica of the same
partition, it will only appear in the output once.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>part</strong> &#8211; partition to get nodes for</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">list of node dicts</td>
</tr>
</tbody>
</table>
<p>See <a class="reference internal" href="#swift.common.ring.ring.Ring.get_nodes" title="swift.common.ring.ring.Ring.get_nodes"><code class="xref py py-func docutils literal"><span class="pre">get_nodes()</span></code></a> for a description of the node dicts.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.Ring.has_changed">
<code class="descname">has_changed</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.Ring.has_changed" title="Permalink to this definition">¶</a></dt>
<dd><p>Check to see if the ring on disk is different than the current one in
memory.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">True if the ring on disk has changed, False otherwise</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.ring.ring.Ring.partition_count">
<code class="descname">partition_count</code><a class="headerlink" href="#swift.common.ring.ring.Ring.partition_count" title="Permalink to this definition">¶</a></dt>
<dd><p>Number of partitions in the ring.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.ring.ring.Ring.replica_count">
<code class="descname">replica_count</code><a class="headerlink" href="#swift.common.ring.ring.Ring.replica_count" title="Permalink to this definition">¶</a></dt>
<dd><p>Number of replicas (full or partial) used in the ring.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="swift.common.ring.ring.RingData">
<em class="property">class </em><code class="descclassname">swift.common.ring.ring.</code><code class="descname">RingData</code><span class="sig-paren">(</span><em>replica2part2dev_id</em>, <em>devs</em>, <em>part_shift</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Partitioned consistent hashing ring data (used for serialization).</p>
<dl class="classmethod">
<dt id="swift.common.ring.ring.RingData.deserialize_v1">
<em class="property">classmethod </em><code class="descname">deserialize_v1</code><span class="sig-paren">(</span><em>gz_file</em>, <em>metadata_only=False</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData.deserialize_v1" title="Permalink to this definition">¶</a></dt>
<dd><p>Deserialize a v1 ring file into a dictionary with <cite>devs</cite>, <cite>part_shift</cite>,
and <cite>replica2part2dev_id</cite> keys.</p>
<p>If the optional kwarg <cite>metadata_only</cite> is True, then the
<cite>replica2part2dev_id</cite> is not loaded and that key in the returned
dictionary just has the value <cite>[]</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>gz_file</strong> (<em>file</em>) &#8211; An opened file-like object which has already
consumed the 6 bytes of magic and version.</li>
<li><strong>metadata_only</strong> (<em>bool</em>) &#8211; If True, only load <cite>devs</cite> and <cite>part_shift</cite></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">A dict containing <cite>devs</cite>, <cite>part_shift</cite>, and
<cite>replica2part2dev_id</cite></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="classmethod">
<dt id="swift.common.ring.ring.RingData.load">
<em class="property">classmethod </em><code class="descname">load</code><span class="sig-paren">(</span><em>filename</em>, <em>metadata_only=False</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData.load" title="Permalink to this definition">¶</a></dt>
<dd><p>Load ring data from a file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>filename</strong> &#8211; Path to a file serialized by the save() method.</li>
<li><strong>metadata_only</strong> (<em>bool</em>) &#8211; If True, only load <cite>devs</cite> and <cite>part_shift</cite>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">A RingData instance containing the loaded data.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.RingData.save">
<code class="descname">save</code><span class="sig-paren">(</span><em>filename</em>, <em>mtime=1300507380.0</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData.save" title="Permalink to this definition">¶</a></dt>
<dd><p>Serialize this RingData instance to disk.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>filename</strong> &#8211; File into which this instance should be serialized.</li>
<li><strong>mtime</strong> &#8211; time used to override mtime for gzip, default or None
if the caller wants to include time</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.RingData.serialize_v1">
<code class="descname">serialize_v1</code><span class="sig-paren">(</span><em>file_obj</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData.serialize_v1" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="swift.common.ring.ring.RingData.to_dict">
<code class="descname">to_dict</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.ring.RingData.to_dict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

</div>
<div class="section" id="module-swift.common.ring.builder">
<span id="id2"></span><span id="ring-builder"></span><h2>Ring Builder<a class="headerlink" href="#module-swift.common.ring.builder" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.ring.builder.RingBuilder">
<em class="property">class </em><code class="descclassname">swift.common.ring.builder.</code><code class="descname">RingBuilder</code><span class="sig-paren">(</span><em>part_power</em>, <em>replicas</em>, <em>min_part_hours</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Used to build swift.common.ring.RingData instances to be written to disk
and used with swift.common.ring.Ring instances. See bin/swift-ring-builder
for example usage.</p>
<p>The instance variable devs_changed indicates if the device information has
changed since the last balancing. This can be used by tools to know whether
a rebalance request is an isolated request or due to added, changed, or
removed devices.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>part_power</strong> &#8211; number of partitions = 2**part_power.</li>
<li><strong>replicas</strong> &#8211; number of replicas for each partition</li>
<li><strong>min_part_hours</strong> &#8211; minimum number of hours between partition changes</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.add_dev">
<code class="descname">add_dev</code><span class="sig-paren">(</span><em>dev</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.add_dev" title="Permalink to this definition">¶</a></dt>
<dd><p>Add a device to the ring. This device dict should have a minimum of the
following keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>id</td>
<td>unique integer identifier amongst devices. Defaults to the next
id if the &#8216;id&#8217; key is not provided in the dict</td>
</tr>
<tr class="row-even"><td>weight</td>
<td>a float of the relative weight of this device as compared to
others; this indicates how many partitions the builder will try
to assign to this device</td>
</tr>
<tr class="row-odd"><td>region</td>
<td>integer indicating which region the device is in</td>
</tr>
<tr class="row-even"><td>zone</td>
<td>integer indicating which zone the device is in; a given
partition will not be assigned to multiple devices within the
same (region, zone) pair if there is any alternative</td>
</tr>
<tr class="row-odd"><td>ip</td>
<td>the ip address of the device</td>
</tr>
<tr class="row-even"><td>port</td>
<td>the tcp port of the device</td>
</tr>
<tr class="row-odd"><td>device</td>
<td>the device&#8217;s name on disk (sdb1, for example)</td>
</tr>
<tr class="row-even"><td>meta</td>
<td>general use &#8216;extra&#8217; field; for example: the online date, the
hardware description</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will not rebalance the ring immediately as you may want to
make multiple changes for a single rebalance.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>dev</strong> &#8211; device dict</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">id of device (not used in the tree anymore, but unknown
users may depend on it)</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.change_min_part_hours">
<code class="descname">change_min_part_hours</code><span class="sig-paren">(</span><em>min_part_hours</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.change_min_part_hours" title="Permalink to this definition">¶</a></dt>
<dd><p>Changes the value used to decide if a given partition can be moved
again. This restriction is to give the overall system enough time to
settle a partition to its new location before moving it to yet another
location. While no data would be lost if a partition is moved several
times quickly, it could make that data unreachable for a short period
of time.</p>
<p>This should be set to at least the average full partition replication
time. Starting it at 24 hours and then lowering it to what the
replicator reports as the longest partition cycle is best.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>min_part_hours</strong> &#8211; new value for min_part_hours</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.copy_from">
<code class="descname">copy_from</code><span class="sig-paren">(</span><em>builder</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.copy_from" title="Permalink to this definition">¶</a></dt>
<dd><p>Reinitializes this RingBuilder instance from data obtained from the
builder dict given. Code example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">RingBuilder</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Dummy values</span>
<span class="n">b</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span>
</pre></div>
</div>
<p>This is to restore a RingBuilder that has had its b.to_dict()
previously saved.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.debug">
<code class="descname">debug</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwds</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.debug" title="Permalink to this definition">¶</a></dt>
<dd><p>Temporarily enables debug logging, useful in tests, e.g.</p>
<blockquote>
<div><dl class="docutils">
<dt>with rb.debug():</dt>
<dd>rb.rebalance()</dd>
</dl>
</div></blockquote>
</dd></dl>

<dl class="classmethod">
<dt id="swift.common.ring.builder.RingBuilder.from_dict">
<em class="property">classmethod </em><code class="descname">from_dict</code><span class="sig-paren">(</span><em>builder_data</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.from_dict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.get_balance">
<code class="descname">get_balance</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.get_balance" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the balance of the ring. The balance value is the highest
percentage of the desired amount of partitions a given device
wants. For instance, if the &#8220;worst&#8221; device wants (based on its
weight relative to the sum of all the devices&#8217; weights) 123
partitions and it has 124 partitions, the balance value would
be 0.83 (1 extra / 123 wanted * 100 for percentage).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">balance of the ring</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.get_part_devices">
<code class="descname">get_part_devices</code><span class="sig-paren">(</span><em>part</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.get_part_devices" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the devices that are responsible for the partition,
filtering out duplicates.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>part</strong> &#8211; partition to get devices for</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">list of device dicts</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.get_required_overload">
<code class="descname">get_required_overload</code><span class="sig-paren">(</span><em>weighted=None</em>, <em>wanted=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.get_required_overload" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the minimum overload value required to make the ring maximally
dispersed.</p>
<p>The required overload is the largest percentage change of any single
device from its weighted replicanth to its wanted replicanth (note:
under weighted devices have a negative percentage change) to archive
dispersion - that is to say a single device that must be overloaded by
5% is worse than 5 devices in a single tier overloaded by 1%.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.get_ring">
<code class="descname">get_ring</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.get_ring" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the ring, or more specifically, the swift.common.ring.RingData.
This ring data is the minimum required for use of the ring. The ring
builder itself keeps additional data such as when partitions were last
moved.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.increase_partition_power">
<code class="descname">increase_partition_power</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.increase_partition_power" title="Permalink to this definition">¶</a></dt>
<dd><p>Increases ring partition power by one.</p>
<p>Devices will be assigned to partitions like this:</p>
<p>OLD: 0, 3, 7, 5, 2, 1, ...
NEW: 0, 0, 3, 3, 7, 7, 5, 5, 2, 2, 1, 1, ...</p>
</dd></dl>

<dl class="classmethod">
<dt id="swift.common.ring.builder.RingBuilder.load">
<em class="property">classmethod </em><code class="descname">load</code><span class="sig-paren">(</span><em>builder_file</em>, <em>open=&lt;built-in function open&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.load" title="Permalink to this definition">¶</a></dt>
<dd><p>Obtain RingBuilder instance of the provided builder file</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>builder_file</strong> &#8211; path to builder file to load</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">RingBuilder instance</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.ring.builder.RingBuilder.min_part_seconds_left">
<code class="descname">min_part_seconds_left</code><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.min_part_seconds_left" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the total seconds until a rebalance can be performed</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.pretend_min_part_hours_passed">
<code class="descname">pretend_min_part_hours_passed</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.pretend_min_part_hours_passed" title="Permalink to this definition">¶</a></dt>
<dd><p>Override min_part_hours by marking all partitions as having been moved
255 hours ago and last move epoch to &#8216;the beginning of time&#8217;. This can
be used to force a full rebalance on the next call to rebalance.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.rebalance">
<code class="descname">rebalance</code><span class="sig-paren">(</span><em>seed=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.rebalance" title="Permalink to this definition">¶</a></dt>
<dd><p>Rebalance the ring.</p>
<p>This is the main work function of the builder, as it will assign and
reassign partitions to devices in the ring based on weights, distinct
zones, recent reassignments, etc.</p>
<p>The process doesn&#8217;t always perfectly assign partitions (that&#8217;d take a
lot more analysis and therefore a lot more time &#8211; I had code that did
that before). Because of this, it keeps rebalancing until the device
skew (number of partitions a device wants compared to what it has) gets
below 1% or doesn&#8217;t change by more than 1% (only happens with a ring
that can&#8217;t be balanced no matter what).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">(number_of_partitions_altered, resulting_balance,
number_of_removed_devices)</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.remove_dev">
<code class="descname">remove_dev</code><span class="sig-paren">(</span><em>dev_id</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.remove_dev" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove a device from the ring.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will not rebalance the ring immediately as you may want to
make multiple changes for a single rebalance.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>dev_id</strong> &#8211; device id</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.save">
<code class="descname">save</code><span class="sig-paren">(</span><em>builder_file</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.save" title="Permalink to this definition">¶</a></dt>
<dd><p>Serialize this RingBuilder instance to disk.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>builder_file</strong> &#8211; path to builder file to save</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.search_devs">
<code class="descname">search_devs</code><span class="sig-paren">(</span><em>search_values</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.search_devs" title="Permalink to this definition">¶</a></dt>
<dd><p>Search devices by parameters.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>search_values</strong> &#8211; a dictionary with search values to filter
devices, supported parameters are id,
region, zone, ip, port, replication_ip,
replication_port, device, weight, meta</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">list of device dicts</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.set_dev_weight">
<code class="descname">set_dev_weight</code><span class="sig-paren">(</span><em>dev_id</em>, <em>weight</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.set_dev_weight" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the weight of a device. This should be called rather than just
altering the weight key in the device dict directly, as the builder
will need to rebuild some internal state to reflect the change.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will not rebalance the ring immediately as you may want to
make multiple changes for a single rebalance.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>dev_id</strong> &#8211; device id</li>
<li><strong>weight</strong> &#8211; new weight for device</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.set_overload">
<code class="descname">set_overload</code><span class="sig-paren">(</span><em>overload</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.set_overload" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.set_replicas">
<code class="descname">set_replicas</code><span class="sig-paren">(</span><em>new_replica_count</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.set_replicas" title="Permalink to this definition">¶</a></dt>
<dd><p>Changes the number of replicas in this ring.</p>
<p>If the new replica count is sufficiently different that
self._replica2part2dev will change size, sets
self.devs_changed. This is so tools like
bin/swift-ring-builder can know to write out the new ring
rather than bailing out due to lack of balance change.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.to_dict">
<code class="descname">to_dict</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.to_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a dict that can be used later with copy_from to
restore a RingBuilder. swift-ring-builder uses this to
pickle.dump the dict to a file and later load that dict into
copy_from.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.validate">
<code class="descname">validate</code><span class="sig-paren">(</span><em>stats=False</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.validate" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate the ring.</p>
<p>This is a safety function to try to catch any bugs in the building
process. It ensures partitions have been assigned to real devices,
aren&#8217;t doubly assigned, etc. It can also optionally check the even
distribution of partitions across devices.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>stats</strong> &#8211; if True, check distribution of partitions across devices</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">if stats is True, a tuple of (device_usage, worst_stat), else
(None, None). device_usage[dev_id] will equal the number of
partitions assigned to that device. worst_stat will equal the
number of partitions the worst device is skewed from the
number it should have.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Raises:</th><td class="field-body"><strong>RingValidationError</strong> &#8211; problem was found with the ring.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.ring.builder.RingBuilder.weight_of_one_part">
<code class="descname">weight_of_one_part</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.ring.builder.RingBuilder.weight_of_one_part" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the weight of each partition as calculated from the
total weight of all the devices.</p>
</dd></dl>

</dd></dl>

<dl class="exception">
<dt id="swift.common.ring.builder.RingValidationWarning">
<em class="property">exception </em><code class="descclassname">swift.common.ring.builder.</code><code class="descname">RingValidationWarning</code><a class="headerlink" href="#swift.common.ring.builder.RingValidationWarning" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">exceptions.Warning</span></code></p>
</dd></dl>

</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Partitioned Consistent Hash Ring</a><ul>
<li><a class="reference internal" href="#ring">Ring</a></li>
<li><a class="reference internal" href="#module-swift.common.ring.builder">Ring Builder</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="api/use_the_content-disposition_metadata.html"
                                  title="previous chapter">Use the Content-Disposition metadata</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="proxy.html"
                                  title="next chapter">Proxy</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/swift
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/ring.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="proxy.html" title="Proxy"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="api/use_the_content-disposition_metadata.html" title="Use the Content-Disposition metadata"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">swift 2.12.1.dev102 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, OpenStack Foundation.
      Last updated on &#39;Tue Feb 14 07:57:22 2017, commit 7cb6882&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/swift");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>