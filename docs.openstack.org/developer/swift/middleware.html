<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Middleware &mdash; swift 2.12.1.dev102 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.12.1.dev102',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="swift 2.12.1.dev102 documentation" href="index.html" />
    <link rel="prev" title="Misc" href="misc.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="middleware">
<span id="common-middleware"></span><h1>Middleware<a class="headerlink" href="#middleware" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-swift.common.middleware.account_quotas">
<span id="account-quotas"></span><h2>Account Quotas<a class="headerlink" href="#module-swift.common.middleware.account_quotas" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">account_quotas</span></code> is a middleware which blocks write requests (PUT, POST) if a
given account quota (in bytes) is exceeded while DELETE requests are still
allowed.</p>
<p><code class="docutils literal"><span class="pre">account_quotas</span></code> uses the <code class="docutils literal"><span class="pre">x-account-meta-quota-bytes</span></code> metadata entry to
store the quota. Write requests to this metadata entry are only permitted for
resellers. There is no quota limit if <code class="docutils literal"><span class="pre">x-account-meta-quota-bytes</span></code> is not
set.</p>
<p>The <code class="docutils literal"><span class="pre">account_quotas</span></code> middleware should be added to the pipeline in your
<code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code> file just after any auth middleware.
For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:main]
pipeline = catch_errors cache tempauth account_quotas proxy-server

[filter:account_quotas]
use = egg:swift#account_quotas
</pre></div>
</div>
<p>To set the quota on an account:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift -A http://127.0.0.1:8080/auth/v1.0 -U account:reseller -K secret post -m quota-bytes:10000
</pre></div>
</div>
<p>Remove the quota:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift -A http://127.0.0.1:8080/auth/v1.0 -U account:reseller -K secret post -m quota-bytes:
</pre></div>
</div>
<p>The same limitations apply for the account quotas as for the container quotas.</p>
<p>For example, when uploading an object without a content-length header the proxy
server doesn&#8217;t know the final size of the currently uploaded object and the
upload will be allowed if the current account size is within the quota.
Due to the eventual consistency further uploads might be possible until the
account size has been updated.</p>
<dl class="class">
<dt id="swift.common.middleware.account_quotas.AccountQuotaMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.account_quotas.</code><code class="descname">AccountQuotaMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.account_quotas.AccountQuotaMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Account quota middleware</p>
<p>See above for a full description.</p>
</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.account_quotas.filter_factory">
<code class="descclassname">swift.common.middleware.account_quotas.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.account_quotas.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a WSGI filter app for use with paste.deploy.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.bulk">
<span id="bulk-operations-delete-and-archive-auto-extraction"></span><span id="bulk"></span><h2>Bulk Operations (Delete and Archive Auto Extraction)<a class="headerlink" href="#module-swift.common.middleware.bulk" title="Permalink to this headline">¶</a></h2>
<p>Middleware that will perform many operations on a single request.</p>
<div class="section" id="extract-archive">
<h3>Extract Archive<a class="headerlink" href="#extract-archive" title="Permalink to this headline">¶</a></h3>
<p>Expand tar files into a Swift account. Request must be a PUT with the
query parameter <code class="docutils literal"><span class="pre">?extract-archive=format</span></code> specifying the format of archive
file. Accepted formats are tar, tar.gz, and tar.bz2.</p>
<p>For a PUT to the following url:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/v1/AUTH_Account/$UPLOAD_PATH?extract-archive=tar.gz
</pre></div>
</div>
<p>UPLOAD_PATH is where the files will be expanded to. UPLOAD_PATH can be a
container, a pseudo-directory within a container, or an empty string. The
destination of a file in the archive will be built as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/v1/AUTH_Account/$UPLOAD_PATH/$FILE_PATH
</pre></div>
</div>
<p>Where FILE_PATH is the file name from the listing in the tar file.</p>
<p>If the UPLOAD_PATH is an empty string, containers will be auto created
accordingly and files in the tar that would not map to any container (files
in the base directory) will be ignored.</p>
<p>Only regular files will be uploaded. Empty directories, symlinks, etc will
not be uploaded.</p>
</div>
<div class="section" id="content-type">
<h3>Content Type<a class="headerlink" href="#content-type" title="Permalink to this headline">¶</a></h3>
<p>If the content-type header is set in the extract-archive call, Swift will
assign that content-type to all the underlying files. The bulk middleware
will extract the archive file and send the internal files using PUT
operations using the same headers from the original request
(e.g. auth-tokens, content-Type, etc.). Notice that any middleware call
that follows the bulk middleware does not know if this was a bulk request
or if these were individual requests sent by the user.</p>
<p>In order to make Swift detect the content-type for the files based on the
file extension, the content-type in the extract-archive call should not be
set. Alternatively, it is possible to explicitly tell Swift to detect the
content type using this header:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>X-Detect-Content-Type: true
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -X PUT http://127.0.0.1/v1/AUTH_acc/cont/$?extract-archive=tar
 -T backup.tar
 -H &quot;Content-Type: application/x-tar&quot;
 -H &quot;X-Auth-Token: xxx&quot;
 -H &quot;X-Detect-Content-Type: true&quot;
</pre></div>
</div>
</div>
<div class="section" id="assigning-metadata">
<h3>Assigning Metadata<a class="headerlink" href="#assigning-metadata" title="Permalink to this headline">¶</a></h3>
<p>The tar file format (1) allows for UTF-8 key/value pairs to be associated
with each file in an archive. If a file has extended attributes, then tar
will store those as key/value pairs. The bulk middleware can read those
extended attributes and convert them to Swift object metadata. Attributes
starting with &#8220;user.meta&#8221; are converted to object metadata, and
&#8220;user.mime_type&#8221; is converted to Content-Type.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>setfattr -n user.mime_type -v &quot;application/python-setup&quot; setup.py
setfattr -n user.meta.lunch -v &quot;burger and fries&quot; setup.py
setfattr -n user.meta.dinner -v &quot;baked ziti&quot; setup.py
setfattr -n user.stuff -v &quot;whee&quot; setup.py
</pre></div>
</div>
<p>Will get translated to headers:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Content-Type: application/python-setup
X-Object-Meta-Lunch: burger and fries
X-Object-Meta-Dinner: baked ziti
</pre></div>
</div>
<p>The bulk middleware  will handle xattrs stored by both GNU and BSD tar (2).
Only xattrs <code class="docutils literal"><span class="pre">user.mime_type</span></code> and <code class="docutils literal"><span class="pre">user.meta.*</span></code> are processed. Other
attributes are ignored.</p>
<p>Notes:</p>
<p>(1) The POSIX 1003.1-2001 (pax) format. The default format on GNU tar
1.27.1 or later.</p>
<p>(2) Even with pax-format tarballs, different encoders store xattrs slightly
differently; for example, GNU tar stores the xattr &#8220;user.userattribute&#8221; as
pax header &#8220;SCHILY.xattr.user.userattribute&#8221;, while BSD tar (which uses
libarchive) stores it as &#8220;LIBARCHIVE.xattr.user.userattribute&#8221;.</p>
</div>
<div class="section" id="response">
<h3>Response<a class="headerlink" href="#response" title="Permalink to this headline">¶</a></h3>
<p>The response from bulk operations functions differently from other Swift
responses. This is because a short request body sent from the client could
result in many operations on the proxy server and precautions need to be
made to prevent the request from timing out due to lack of activity. To
this end, the client will always receive a 200 OK response, regardless of
the actual success of the call.  The body of the response must be parsed to
determine the actual success of the operation. In addition to this the
client may receive zero or more whitespace characters prepended to the
actual response body while the proxy server is completing the request.</p>
<p>The format of the response body defaults to text/plain but can be either
json or xml depending on the <code class="docutils literal"><span class="pre">Accept</span></code> header. Acceptable formats are
<code class="docutils literal"><span class="pre">text/plain</span></code>, <code class="docutils literal"><span class="pre">application/json</span></code>, <code class="docutils literal"><span class="pre">application/xml</span></code>, and <code class="docutils literal"><span class="pre">text/xml</span></code>.
An example body is as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;Response Status&quot;</span><span class="p">:</span> <span class="s2">&quot;201 Created&quot;</span><span class="p">,</span>
 <span class="s2">&quot;Response Body&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
 <span class="s2">&quot;Errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
 <span class="s2">&quot;Number Files Created&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</pre></div>
</div>
<p>If all valid files were uploaded successfully the Response Status will be
201 Created.  If any files failed to be created the response code
corresponds to the subrequest&#8217;s error. Possible codes are 400, 401, 502 (on
server errors), etc. In both cases the response body will specify the
number of files successfully uploaded and a list of the files that failed.</p>
<p>There are proxy logs created for each file (which becomes a subrequest) in
the tar. The subrequest&#8217;s proxy log will have a swift.source set to &#8220;EA&#8221;
the log&#8217;s content length will reflect the unzipped size of the file. If
double proxy-logging is used the leftmost logger will not have a
swift.source set and the content length will reflect the size of the
payload sent to the proxy (the unexpanded size of the tar.gz).</p>
</div>
<div class="section" id="bulk-delete">
<h3>Bulk Delete<a class="headerlink" href="#bulk-delete" title="Permalink to this headline">¶</a></h3>
<p>Will delete multiple objects or containers from their account with a
single request. Responds to POST requests with query parameter
<code class="docutils literal"><span class="pre">?bulk-delete</span></code> set. The request url is your storage url. The Content-Type
should be set to <code class="docutils literal"><span class="pre">text/plain</span></code>. The body of the POST request will be a
newline separated list of url encoded objects to delete. You can delete
10,000 (configurable) objects per request. The objects specified in the
POST request body must be URL encoded and in the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/container_name/obj_name
</pre></div>
</div>
<p>or for a container (which must be empty at time of delete):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/container_name
</pre></div>
</div>
<p>The response is similar to extract archive as in every response will be a
200 OK and you must parse the response body for actual results. An example
response is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;Number Not Found&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s2">&quot;Response Status&quot;</span><span class="p">:</span> <span class="s2">&quot;200 OK&quot;</span><span class="p">,</span>
 <span class="s2">&quot;Response Body&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
 <span class="s2">&quot;Errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
 <span class="s2">&quot;Number Deleted&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span>
</pre></div>
</div>
<p>If all items were successfully deleted (or did not exist), the Response
Status will be 200 OK. If any failed to delete, the response code
corresponds to the subrequest&#8217;s error. Possible codes are 400, 401, 502 (on
server errors), etc. In all cases the response body will specify the number
of items successfully deleted, not found, and a list of those that failed.
The return body will be formatted in the way specified in the request&#8217;s
<code class="docutils literal"><span class="pre">Accept</span></code> header. Acceptable formats are <code class="docutils literal"><span class="pre">text/plain</span></code>, <code class="docutils literal"><span class="pre">application/json</span></code>,
<code class="docutils literal"><span class="pre">application/xml</span></code>, and <code class="docutils literal"><span class="pre">text/xml</span></code>.</p>
<p>There are proxy logs created for each object or container (which becomes a
subrequest) that is deleted. The subrequest&#8217;s proxy log will have a
swift.source set to &#8220;BD&#8221; the log&#8217;s content length of 0. If double
proxy-logging is used the leftmost logger will not have a
swift.source set and the content length will reflect the size of the
payload sent to the proxy (the list of objects/containers to be deleted).</p>
<dl class="function">
<dt id="swift.common.middleware.bulk.get_response_body">
<code class="descclassname">swift.common.middleware.bulk.</code><code class="descname">get_response_body</code><span class="sig-paren">(</span><em>data_format</em>, <em>data_dict</em>, <em>error_list</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.bulk.get_response_body" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a properly formatted response body according to format. Handles
json and xml, otherwise will return text/plain. Note: xml response does not
include xml declaration.
:params data_format: resulting format
:params data_dict: generated data about results.
:params error_list: list of quoted filenames that failed</p>
</dd></dl>

</div>
</div>
<div class="section" id="module-swift.common.middleware.catch_errors">
<span id="catcherrors"></span><span id="catch-errors"></span><h2>CatchErrors<a class="headerlink" href="#module-swift.common.middleware.catch_errors" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.catch_errors.CatchErrorMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.catch_errors.</code><code class="descname">CatchErrorMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.catch_errors.CatchErrorMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Middleware that provides high-level error handling and ensures that a
transaction id will be set for every request.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.cname_lookup">
<span id="cname-lookup"></span><h2>CNAME Lookup<a class="headerlink" href="#module-swift.common.middleware.cname_lookup" title="Permalink to this headline">¶</a></h2>
<p>CNAME Lookup Middleware</p>
<p>Middleware that translates an unknown domain in the host header to
something that ends with the configured storage_domain by looking up
the given domain&#8217;s CNAME record in DNS.</p>
<p>This middleware will continue to follow a CNAME chain in DNS until it finds
a record ending in the configured storage domain or it reaches the configured
maximum lookup depth. If a match is found, the environment&#8217;s Host header is
rewritten and the request is passed further down the WSGI chain.</p>
<dl class="class">
<dt id="swift.common.middleware.cname_lookup.CNAMELookupMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.cname_lookup.</code><code class="descname">CNAMELookupMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.cname_lookup.CNAMELookupMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>CNAME Lookup Middleware</p>
<p>See above for a full description.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI filter or app in the paste.deploy
chain.</li>
<li><strong>conf</strong> &#8211; The configuration dict for the middleware.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.cname_lookup.lookup_cname">
<code class="descclassname">swift.common.middleware.cname_lookup.</code><code class="descname">lookup_cname</code><span class="sig-paren">(</span><em>domain</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.cname_lookup.lookup_cname" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a domain, returns its DNS CNAME mapping and DNS ttl.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>domain</strong> &#8211; domain to query on</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">(ttl, result)</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.container_quotas">
<span id="id1"></span><span id="container-quotas"></span><h2>Container Quotas<a class="headerlink" href="#module-swift.common.middleware.container_quotas" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">container_quotas</span></code> middleware implements simple quotas that can be
imposed on swift containers by a user with the ability to set container
metadata, most likely the account administrator.  This can be useful for
limiting the scope of containers that are delegated to non-admin users, exposed
to <code class="docutils literal"><span class="pre">formpost</span></code> uploads, or just as a self-imposed sanity check.</p>
<p>Any object PUT operations that exceed these quotas return a 413 response
(request entity too large) with a descriptive body.</p>
<p>Quotas are subject to several limitations: eventual consistency, the timeliness
of the cached container_info (60 second ttl by default), and it&#8217;s unable to
reject chunked transfer uploads that exceed the quota (though once the quota
is exceeded, new chunked transfers will be refused).</p>
<p>Quotas are set by adding meta values to the container, and are validated when
set:</p>
<table border="1" class="docutils">
<colgroup>
<col width="59%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Metadata</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>X-Container-Meta-Quota-Bytes</td>
<td>Maximum size of the
container, in bytes.</td>
</tr>
<tr class="row-odd"><td>X-Container-Meta-Quota-Count</td>
<td>Maximum object count of the
container.</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal"><span class="pre">container_quotas</span></code> middleware should be added to the pipeline in your
<code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code> file just after any auth middleware.
For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:main]
pipeline = catch_errors cache tempauth container_quotas proxy-server

[filter:container_quotas]
use = egg:swift#container_quotas
</pre></div>
</div>
</div>
<div class="section" id="module-swift.common.middleware.container_sync">
<span id="container-sync-middleware"></span><span id="container-sync"></span><h2>Container Sync Middleware<a class="headerlink" href="#module-swift.common.middleware.container_sync" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.container_sync.ContainerSync">
<em class="property">class </em><code class="descclassname">swift.common.middleware.container_sync.</code><code class="descname">ContainerSync</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em>, <em>logger=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.container_sync.ContainerSync" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>WSGI middleware that validates an incoming container sync request
using the container-sync-realms.conf style of container sync.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.crossdomain">
<span id="cross-domain-policies"></span><h2>Cross Domain Policies<a class="headerlink" href="#module-swift.common.middleware.crossdomain" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.crossdomain.CrossDomainMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crossdomain.</code><code class="descname">CrossDomainMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crossdomain.CrossDomainMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Cross domain middleware used to respond to requests for cross domain
policy information.</p>
<p>If the path is /crossdomain.xml it will respond with an xml cross domain
policy document. This allows web pages hosted elsewhere to use client
side technologies such as Flash, Java and Silverlight to interact
with the Swift API.</p>
<p>To enable this middleware, add it to the pipeline in your proxy-server.conf
file. It should be added before any authentication (e.g., tempauth or
keystone) middleware. In this example ellipsis (...) indicate other
middleware you may have chosen to use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:main]
pipeline =  ... crossdomain ... authtoken ... proxy-server
</pre></div>
</div>
<p>And add a filter section, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[filter:crossdomain]
use = egg:swift#crossdomain
cross_domain_policy = &lt;allow-access-from domain=&quot;*.example.com&quot; /&gt;
    &lt;allow-access-from domain=&quot;www.example.com&quot; secure=&quot;false&quot; /&gt;
</pre></div>
</div>
<p>For continuation lines, put some whitespace before the continuation
text. Ensure you put a completely blank line to terminate the
cross_domain_policy value.</p>
<p>The cross_domain_policy name/value is optional. If omitted, the policy
defaults as if you had specified:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>cross_domain_policy = &lt;allow-access-from domain=&quot;*&quot; secure=&quot;false&quot; /&gt;
</pre></div>
</div>
<dl class="method">
<dt id="swift.common.middleware.crossdomain.CrossDomainMiddleware.GET">
<code class="descname">GET</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crossdomain.CrossDomainMiddleware.GET" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a 200 response with cross domain policy information</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="discoverability">
<span id="id2"></span><h2>Discoverability<a class="headerlink" href="#discoverability" title="Permalink to this headline">¶</a></h2>
<p>Swift will by default provide clients with an interface providing details
about the installation. Unless disabled (i.e <code class="docutils literal"><span class="pre">expose_info=false</span></code> in
<a class="reference internal" href="deployment_guide.html#proxy-server-config"><span>Proxy Server Configuration</span></a>), a GET request to <code class="docutils literal"><span class="pre">/info</span></code> will return configuration
data in JSON format.  An example response:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;swift&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.11.0&quot;</span><span class="p">},</span> <span class="s2">&quot;staticweb&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;tempurl&quot;</span><span class="p">:</span> <span class="p">{}}</span>
</pre></div>
</div>
<p>This would signify to the client that swift version 1.11.0 is running and that
staticweb and tempurl are available in this installation.</p>
<p>There may be administrator-only information available via <code class="docutils literal"><span class="pre">/info</span></code>. To
retrieve it, one must use an HMAC-signed request, similar to TempURL.
The signature may be produced like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift-temp-url GET 3600 /info secret 2&gt;/dev/null | sed s/temp_url/swiftinfo/g
</pre></div>
</div>
</div>
<div class="section" id="module-swift.common.middleware.domain_remap">
<span id="domain-remap"></span><h2>Domain Remap<a class="headerlink" href="#module-swift.common.middleware.domain_remap" title="Permalink to this headline">¶</a></h2>
<p>Domain Remap Middleware</p>
<p>Middleware that translates container and account parts of a domain to
path parameters that the proxy server understands.</p>
<p>container.account.storageurl/object gets translated to
container.account.storageurl/path_root/account/container/object</p>
<p>account.storageurl/path_root/container/object gets translated to
account.storageurl/path_root/account/container/object</p>
<p>Browsers can convert a host header to lowercase, so check that reseller
prefix on the account is the correct case. This is done by comparing the
items in the reseller_prefixes config option to the found prefix. If they
match except for case, the item from reseller_prefixes will be used
instead of the found reseller prefix. When none match, the default reseller
prefix is used. When no default reseller prefix is configured, any request with
an account prefix not in that list will be ignored by this middleware.
reseller_prefixes defaults to &#8216;AUTH&#8217;.</p>
<p>Note that this middleware requires that container names and account names
(except as described above) must be DNS-compatible. This means that the
account name created in the system and the containers created by users
cannot exceed 63 characters or have UTF-8 characters. These are
restrictions over and above what swift requires and are not explicitly
checked. Simply put, the this middleware will do a best-effort attempt to
derive account and container names from elements in the domain name and
put those derived values into the URL path (leaving the Host header
unchanged).</p>
<p>Also note that using container sync with remapped domain names is not
advised. With container sync, you should use the true storage end points as
sync destinations.</p>
<dl class="class">
<dt id="swift.common.middleware.domain_remap.DomainRemapMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.domain_remap.</code><code class="descname">DomainRemapMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.domain_remap.DomainRemapMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Domain Remap Middleware</p>
<p>See above for a full description.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI filter or app in the paste.deploy
chain.</li>
<li><strong>conf</strong> &#8211; The configuration dict for the middleware.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="dynamic-large-objects">
<h2>Dynamic Large Objects<a class="headerlink" href="#dynamic-large-objects" title="Permalink to this headline">¶</a></h2>
<p>DLO support centers around a user specified filter that matches
segments and concatenates them together in object listing order. Please see
the DLO docs for <a class="reference internal" href="overview_large_objects.html#dlo-doc"><span>Dynamic Large Objects</span></a> further details.</p>
</div>
<div class="section" id="encryption">
<span id="id3"></span><h2>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h2>
<p>Encryption middleware should be deployed in conjunction with the
<a class="reference internal" href="#keymaster"><span>Keymaster</span></a> middleware.</p>
<span class="target" id="module-swift.common.middleware.crypto"></span><p>Implements middleware for object encryption which comprises an instance of a
<a class="reference internal" href="#swift.common.middleware.crypto.decrypter.Decrypter" title="swift.common.middleware.crypto.decrypter.Decrypter"><code class="xref py py-class docutils literal"><span class="pre">Decrypter</span></code></a> combined with an
instance of an <a class="reference internal" href="#swift.common.middleware.crypto.encrypter.Encrypter" title="swift.common.middleware.crypto.encrypter.Encrypter"><code class="xref py py-class docutils literal"><span class="pre">Encrypter</span></code></a>.</p>
<dl class="function">
<dt id="swift.common.middleware.crypto.filter_factory">
<code class="descclassname">swift.common.middleware.crypto.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides a factory function for loading encryption middleware.</p>
</dd></dl>

<span class="target" id="module-swift.common.middleware.crypto.encrypter"></span><dl class="class">
<dt id="swift.common.middleware.crypto.encrypter.EncInputWrapper">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crypto.encrypter.</code><code class="descname">EncInputWrapper</code><span class="sig-paren">(</span><em>crypto</em>, <em>keys</em>, <em>req</em>, <em>logger</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.encrypter.EncInputWrapper" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>File-like object to be swapped in for wsgi.input.</p>
</dd></dl>

<dl class="class">
<dt id="swift.common.middleware.crypto.encrypter.Encrypter">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crypto.encrypter.</code><code class="descname">Encrypter</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.encrypter.Encrypter" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Middleware for encrypting data and user metadata.</p>
<p>By default all PUT or POST&#8217;ed object data and/or metadata will be
encrypted. Encryption of new data and/or metadata may be disabled by
setting the <code class="docutils literal"><span class="pre">disable_encryption</span></code> option to True. However, this middleware
should remain in the pipeline in order for existing encrypted data to be
read.</p>
</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.crypto.encrypter.encrypt_header_val">
<code class="descclassname">swift.common.middleware.crypto.encrypter.</code><code class="descname">encrypt_header_val</code><span class="sig-paren">(</span><em>crypto</em>, <em>value</em>, <em>key</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.encrypter.encrypt_header_val" title="Permalink to this definition">¶</a></dt>
<dd><p>Encrypt a header value using the supplied key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>crypto</strong> &#8211; a Crypto instance</li>
<li><strong>value</strong> &#8211; value to encrypt</li>
<li><strong>key</strong> &#8211; crypto key to use</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">a tuple of (encrypted value, crypto_meta) where crypto_meta is a
dict of form returned by
<code class="xref py py-func docutils literal"><span class="pre">get_crypto_meta()</span></code></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last"><strong>ValueError</strong> &#8211; if value is empty</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="module-swift.common.middleware.crypto.decrypter"></span><dl class="class">
<dt id="swift.common.middleware.crypto.decrypter.Decrypter">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crypto.decrypter.</code><code class="descname">Decrypter</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.decrypter.Decrypter" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Middleware for decrypting data and user metadata.</p>
</dd></dl>

</div>
<div class="section" id="formpost">
<span id="id4"></span><h2>FormPost<a class="headerlink" href="#formpost" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.formpost"></span><p>FormPost Middleware</p>
<p>Translates a browser form post into a regular Swift object PUT.</p>
<p>The format of the form is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;form action=&quot;&lt;swift-url&gt;&quot; method=&quot;POST&quot;
      enctype=&quot;multipart/form-data&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;redirect&quot; value=&quot;&lt;redirect-url&gt;&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;max_file_size&quot; value=&quot;&lt;bytes&gt;&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;max_file_count&quot; value=&quot;&lt;count&gt;&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;expires&quot; value=&quot;&lt;unix-timestamp&gt;&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;signature&quot; value=&quot;&lt;hmac&gt;&quot; /&gt;
  &lt;input type=&quot;file&quot; name=&quot;file1&quot; /&gt;&lt;br /&gt;
  &lt;input type=&quot;submit&quot; /&gt;
&lt;/form&gt;
</pre></div>
</div>
<p>Optionally, if you want the uploaded files to be temporary you can set
x-delete-at or x-delete-after attributes by adding one of these as a
form input:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;input type=&quot;hidden&quot; name=&quot;x_delete_at&quot; value=&quot;&lt;unix-timestamp&gt;&quot; /&gt;
&lt;input type=&quot;hidden&quot; name=&quot;x_delete_after&quot; value=&quot;&lt;seconds&gt;&quot; /&gt;
</pre></div>
</div>
<p>The &lt;swift-url&gt; is the URL of the Swift destination, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object_prefix
</pre></div>
</div>
<p>The name of each file uploaded will be appended to the &lt;swift-url&gt;
given. So, you can upload directly to the root of container with a
url like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/
</pre></div>
</div>
<p>Optionally, you can include an object prefix to better separate
different users&#8217; uploads, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object_prefix
</pre></div>
</div>
<p>Note the form method must be POST and the enctype must be set as
&#8220;multipart/form-data&#8221;.</p>
<p>The redirect attribute is the URL to redirect the browser to after the upload
completes. This is an optional parameter. If you are uploading the form via an
XMLHttpRequest the redirect should not be included. The URL will have status
and message query parameters added to it, indicating the HTTP status code for
the upload (2xx is success) and a possible message for further information if
there was an error (such as &#8220;max_file_size exceeded&#8221;).</p>
<p>The max_file_size attribute must be included and indicates the
largest single file upload that can be done, in bytes.</p>
<p>The max_file_count attribute must be included and indicates the
maximum number of files that can be uploaded with the form. Include
additional <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;file&quot;</span> <span class="pre">name=&quot;filexx&quot;</span> <span class="pre">/&gt;</span></code> attributes if
desired.</p>
<p>The expires attribute is the Unix timestamp before which the form
must be submitted before it is invalidated.</p>
<p>The signature attribute is the HMAC-SHA1 signature of the form. Here is
sample code for computing the signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/v1/account/container/object_prefix&#39;</span>
<span class="n">redirect</span> <span class="o">=</span> <span class="s1">&#39;https://srv.com/some-page&#39;</span>  <span class="c1"># set to &#39;&#39; if redirect not in form</span>
<span class="n">max_file_size</span> <span class="o">=</span> <span class="mi">104857600</span>
<span class="n">max_file_count</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;mykey&#39;</span>
<span class="n">hmac_body</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span>
    <span class="n">max_file_size</span><span class="p">,</span> <span class="n">max_file_count</span><span class="p">,</span> <span class="n">expires</span><span class="p">)</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hmac_body</span><span class="p">,</span> <span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
<p>The key is the value of either the account (X-Account-Meta-Temp-URL-Key,
X-Account-Meta-Temp-Url-Key-2) or the container
(X-Container-Meta-Temp-URL-Key, X-Container-Meta-Temp-Url-Key-2) TempURL keys.</p>
<p>Be certain to use the full path, from the /v1/ onward.
Note that x_delete_at and x_delete_after are not used in signature generation
as they are both optional attributes.</p>
<p>The command line tool <code class="docutils literal"><span class="pre">swift-form-signature</span></code> may be used (mostly
just when testing) to compute expires and signature.</p>
<p>Also note that the file attributes must be after the other attributes
in order to be processed correctly. If attributes come after the
file, they won&#8217;t be sent with the subrequest (there is no way to
parse all the attributes on the server-side without reading the whole
thing into memory &#8211; to service many requests, some with large files,
there just isn&#8217;t enough memory on the server, so attributes following
the file are simply ignored).</p>
<dl class="class">
<dt id="swift.common.middleware.formpost.FormPost">
<em class="property">class </em><code class="descclassname">swift.common.middleware.formpost.</code><code class="descname">FormPost</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.formpost.FormPost" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>FormPost Middleware</p>
<p>See above for a full description.</p>
<p>The proxy logs created for any subrequests made will have swift.source set
to &#8220;FP&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI filter or app in the paste.deploy
chain.</li>
<li><strong>conf</strong> &#8211; The configuration dict for the middleware.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="swift.common.middleware.formpost.FormPost.app">
<code class="descname">app</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.formpost.FormPost.app" title="Permalink to this definition">¶</a></dt>
<dd><p>The next WSGI application/filter in the paste.deploy pipeline.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.formpost.FormPost.conf">
<code class="descname">conf</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.formpost.FormPost.conf" title="Permalink to this definition">¶</a></dt>
<dd><p>The filter configuration dict.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.formpost.filter_factory">
<code class="descclassname">swift.common.middleware.formpost.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.formpost.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the WSGI filter for use with paste.deploy.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.formpost.READ_CHUNK_SIZE">
<code class="descclassname">swift.common.middleware.formpost.</code><code class="descname">READ_CHUNK_SIZE</code><em class="property"> = 4096</em><a class="headerlink" href="#swift.common.middleware.formpost.READ_CHUNK_SIZE" title="Permalink to this definition">¶</a></dt>
<dd><p>The size of data to read from the form at any given time.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.formpost.MAX_VALUE_LENGTH">
<code class="descclassname">swift.common.middleware.formpost.</code><code class="descname">MAX_VALUE_LENGTH</code><em class="property"> = 4096</em><a class="headerlink" href="#swift.common.middleware.formpost.MAX_VALUE_LENGTH" title="Permalink to this definition">¶</a></dt>
<dd><p>The maximum size of any attribute&#8217;s value. Any additional data will be
truncated.</p>
</dd></dl>

</div>
<div class="section" id="gatekeeper">
<span id="id5"></span><h2>GateKeeper<a class="headerlink" href="#gatekeeper" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.gatekeeper"></span><p>The <code class="docutils literal"><span class="pre">gatekeeper</span></code> middleware imposes restrictions on the headers that
may be included with requests and responses. Request headers are filtered
to remove headers that should never be generated by a client. Similarly,
response headers are filtered to remove private headers that should
never be passed to a client.</p>
<p>The <code class="docutils literal"><span class="pre">gatekeeper</span></code> middleware must always be present in the proxy server
wsgi pipeline. It should be configured close to the start of the pipeline
specified in <code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code>, immediately after catch_errors
and before any other middleware. It is essential that it is configured ahead
of all middlewares using system metadata in order that they function
correctly.</p>
<p>If <code class="docutils literal"><span class="pre">gatekeeper</span></code> middleware is not configured in the pipeline then it will be
automatically inserted close to the start of the pipeline by the proxy server.</p>
<dl class="data">
<dt id="swift.common.middleware.gatekeeper.inbound_exclusions">
<code class="descclassname">swift.common.middleware.gatekeeper.</code><code class="descname">inbound_exclusions</code><em class="property"> = ['x-account-sysmeta-', 'x-container-sysmeta-', 'x-object-sysmeta-', 'x-object-transient-sysmeta-', 'x-backend']</em><a class="headerlink" href="#swift.common.middleware.gatekeeper.inbound_exclusions" title="Permalink to this definition">¶</a></dt>
<dd><p>A list of python regular expressions that will be used to
match against inbound request headers. Matching headers will
be removed from the request.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.gatekeeper.outbound_exclusions">
<code class="descclassname">swift.common.middleware.gatekeeper.</code><code class="descname">outbound_exclusions</code><em class="property"> = ['x-account-sysmeta-', 'x-container-sysmeta-', 'x-object-sysmeta-', 'x-object-transient-sysmeta-', 'x-backend']</em><a class="headerlink" href="#swift.common.middleware.gatekeeper.outbound_exclusions" title="Permalink to this definition">¶</a></dt>
<dd><p>A list of python regular expressions that will be used to
match against outbound response headers. Matching headers will
be removed from the response.</p>
</dd></dl>

</div>
<div class="section" id="healthcheck">
<span id="id6"></span><h2>Healthcheck<a class="headerlink" href="#healthcheck" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.healthcheck"></span><dl class="class">
<dt id="swift.common.middleware.healthcheck.HealthCheckMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.healthcheck.</code><code class="descname">HealthCheckMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.healthcheck.HealthCheckMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Healthcheck middleware used for monitoring.</p>
<p>If the path is /healthcheck, it will respond 200 with &#8220;OK&#8221; as the body.</p>
<p>If the optional config parameter &#8220;disable_path&#8221; is set, and a file is
present at that path, it will respond 503 with &#8220;DISABLED BY FILE&#8221; as the
body.</p>
<dl class="method">
<dt id="swift.common.middleware.healthcheck.HealthCheckMiddleware.DISABLED">
<code class="descname">DISABLED</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.healthcheck.HealthCheckMiddleware.DISABLED" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a 503 response with &#8220;DISABLED BY FILE&#8221; in the body.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.healthcheck.HealthCheckMiddleware.GET">
<code class="descname">GET</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.healthcheck.HealthCheckMiddleware.GET" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a 200 response with &#8220;OK&#8221; in the body.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="keymaster">
<span id="id7"></span><h2>Keymaster<a class="headerlink" href="#keymaster" title="Permalink to this headline">¶</a></h2>
<p>Keymaster middleware should be deployed in conjunction with the
<a class="reference internal" href="#encryption"><span>Encryption</span></a> middleware.</p>
<span class="target" id="module-swift.common.middleware.crypto.keymaster"></span><dl class="class">
<dt id="swift.common.middleware.crypto.keymaster.KeyMaster">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crypto.keymaster.</code><code class="descname">KeyMaster</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.keymaster.KeyMaster" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Middleware for providing encryption keys.</p>
<p>The middleware requires its <code class="docutils literal"><span class="pre">encryption_root_secret</span></code> option to be set.
This is the root secret from which encryption keys are derived. This must
be set before first use to a value that is a base64 encoding of at least 32
bytes. The security of all encrypted data critically depends on this key,
therefore it should be set to a high-entropy value. For example, a suitable
value may be obtained by base-64 encoding a 32 byte (or longer) value
generated by a cryptographically secure random number generator. Changing
the root secret is likely to result in data loss.</p>
</dd></dl>

<dl class="class">
<dt id="swift.common.middleware.crypto.keymaster.KeyMasterContext">
<em class="property">class </em><code class="descclassname">swift.common.middleware.crypto.keymaster.</code><code class="descname">KeyMasterContext</code><span class="sig-paren">(</span><em>keymaster</em>, <em>account</em>, <em>container</em>, <em>obj</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.keymaster.KeyMasterContext" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="misc.html#swift.common.wsgi.WSGIContext" title="swift.common.wsgi.WSGIContext"><code class="xref py py-class docutils literal"><span class="pre">swift.common.wsgi.WSGIContext</span></code></a></p>
<p>The simple scheme for key derivation is as follows: every path is
associated with a key, where the key is derived from the path itself in a
deterministic fashion such that the key does not need to be stored.
Specifically, the key for any path is an HMAC of a root key and the path
itself, calculated using an SHA256 hash function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;path_key&gt; = HMAC_SHA256(&lt;root_secret&gt;, &lt;path&gt;)
</pre></div>
</div>
<dl class="method">
<dt id="swift.common.middleware.crypto.keymaster.KeyMasterContext.fetch_crypto_keys">
<code class="descname">fetch_crypto_keys</code><span class="sig-paren">(</span><em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.crypto.keymaster.KeyMasterContext.fetch_crypto_keys" title="Permalink to this definition">¶</a></dt>
<dd><p>Setup container and object keys based on the request path.</p>
<p>Keys are derived from request path. The &#8216;id&#8217; entry in the results dict
includes the part of the path used to derive keys. Other keymaster
implementations may use a different strategy to generate keys and may
include a different type of &#8216;id&#8217;, so callers should treat the &#8216;id&#8217; as
opaque keymaster-specific data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">A dict containing encryption keys for &#8216;object&#8217; and
&#8216;container&#8217; and a key &#8216;id&#8217;.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="keystoneauth">
<span id="id8"></span><h2>KeystoneAuth<a class="headerlink" href="#keystoneauth" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.keystoneauth"></span><dl class="class">
<dt id="swift.common.middleware.keystoneauth.KeystoneAuth">
<em class="property">class </em><code class="descclassname">swift.common.middleware.keystoneauth.</code><code class="descname">KeystoneAuth</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.keystoneauth.KeystoneAuth" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Swift middleware to Keystone authorization system.</p>
<p>In Swift&#8217;s proxy-server.conf add this keystoneauth middleware and the
authtoken middleware to your pipeline. Make sure you have the authtoken
middleware before the keystoneauth middleware.</p>
<p>The authtoken middleware will take care of validating the user and
keystoneauth will authorize access.</p>
<p>The sample proxy-server.conf shows a sample pipeline that uses keystone.</p>
<p><a class="reference download internal" href="_downloads/proxy-server.conf-sample" download=""><code class="xref download docutils literal"><span class="pre">proxy-server.conf-sample</span></code></a></p>
<p>The authtoken middleware is shipped with keystonemiddleware - it
does not have any other dependencies than itself so you can either
install it by copying the file directly in your python path or by
installing keystonemiddleware.</p>
<p>If support is required for unvalidated users (as with anonymous
access) or for formpost/staticweb/tempurl middleware, authtoken will
need to be configured with <code class="docutils literal"><span class="pre">delay_auth_decision</span></code> set to true.  See
the Keystone documentation for more detail on how to configure the
authtoken middleware.</p>
<p>In proxy-server.conf you will need to have the setting account
auto creation to true:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[app:proxy-server]
account_autocreate = true
</pre></div>
</div>
<p>And add a swift authorization filter section, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[filter:keystoneauth]
use = egg:swift#keystoneauth
operator_roles = admin, swiftoperator
</pre></div>
</div>
<p>The user who is able to give ACL / create Containers permissions
will be the user with a role listed in the <code class="docutils literal"><span class="pre">operator_roles</span></code>
setting which by default includes the admin and the swiftoperator
roles.</p>
<p>The keystoneauth middleware maps a Keystone project/tenant to an account
in Swift by adding a prefix (<code class="docutils literal"><span class="pre">AUTH_</span></code> by default) to the tenant/project
id.. For example, if the project id is <code class="docutils literal"><span class="pre">1234</span></code>, the path is
<code class="docutils literal"><span class="pre">/v1/AUTH_1234</span></code>.</p>
<p>If you need to have a different reseller_prefix to be able to
mix different auth servers you can configure the option
<code class="docutils literal"><span class="pre">reseller_prefix</span></code> in your keystoneauth entry like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">reseller_prefix</span> <span class="o">=</span> <span class="n">NEWAUTH</span>
</pre></div>
</div>
<p>Don&#8217;t forget to also update the Keystone service endpoint configuration to
use NEWAUTH in the path.</p>
<p>It is possible to have several accounts associated with the same project.
This is done by listing several prefixes as shown in the following
example:</p>
<blockquote>
<div>reseller_prefix = AUTH, SERVICE</div></blockquote>
<p>This means that for project id &#8216;1234&#8217;, the paths &#8216;/v1/AUTH_1234&#8217; and
&#8216;/v1/SERVICE_1234&#8217; are associated with the project and are authorized
using roles that a user has with that project. The core use of this feature
is that it is possible to provide different rules for each account
prefix. The following parameters may be prefixed with the appropriate
prefix:</p>
<blockquote>
<div>operator_roles
service_roles</div></blockquote>
<p>For backward compatibility, if either of these parameters is specified
without a prefix then it applies to all reseller_prefixes. Here is an
example, using two prefixes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">reseller_prefix</span> <span class="o">=</span> <span class="n">AUTH</span><span class="p">,</span> <span class="n">SERVICE</span>
<span class="c1"># The next three lines have identical effects (since the first applies</span>
<span class="c1"># to both prefixes).</span>
<span class="n">operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">swiftoperator</span>
<span class="n">AUTH_operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">swiftoperator</span>
<span class="n">SERVICE_operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">swiftoperator</span>
<span class="c1"># The next line only applies to accounts with the SERVICE prefix</span>
<span class="n">SERVICE_operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">some_other_role</span>
</pre></div>
</div>
<p>X-Service-Token tokens are supported by the inclusion of the service_roles
configuration option. When present, this option requires that the
X-Service-Token header supply a token from a user who has a role listed
in service_roles. Here is an example configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">reseller_prefix</span> <span class="o">=</span> <span class="n">AUTH</span><span class="p">,</span> <span class="n">SERVICE</span>
<span class="n">AUTH_operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">swiftoperator</span>
<span class="n">SERVICE_operator_roles</span> <span class="o">=</span> <span class="n">admin</span><span class="p">,</span> <span class="n">swiftoperator</span>
<span class="n">SERVICE_service_roles</span> <span class="o">=</span> <span class="n">service</span>
</pre></div>
</div>
<p>The keystoneauth middleware supports cross-tenant access control using the
syntax <code class="docutils literal"><span class="pre">&lt;tenant&gt;:&lt;user&gt;</span></code> to specify a grantee in container Access Control
Lists (ACLs). For a request to be granted by an ACL, the grantee
<code class="docutils literal"><span class="pre">&lt;tenant&gt;</span></code> must match the UUID of the tenant to which the request
X-Auth-Token is scoped and the grantee <code class="docutils literal"><span class="pre">&lt;user&gt;</span></code> must match the UUID of
the user authenticated by that token.</p>
<p>Note that names must no longer be used in cross-tenant ACLs because with
the introduction of domains in keystone names are no longer globally
unique.</p>
<p>For backwards compatibility, ACLs using names will be granted by
keystoneauth when it can be established that the grantee tenant,
the grantee user and the tenant being accessed are either not yet in a
domain (e.g. the X-Auth-Token has been obtained via the keystone v2
API) or are all in the default domain to which legacy accounts would
have been migrated. The default domain is identified by its UUID,
which by default has the value <code class="docutils literal"><span class="pre">default</span></code>. This can be changed by
setting the <code class="docutils literal"><span class="pre">default_domain_id</span></code> option in the keystoneauth
configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">default_domain_id</span> <span class="o">=</span> <span class="n">default</span>
</pre></div>
</div>
<p>The backwards compatible behavior can be disabled by setting the config
option <code class="docutils literal"><span class="pre">allow_names_in_acls</span></code> to false:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">allow_names_in_acls</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<p>To enable this backwards compatibility, keystoneauth will attempt to
determine the domain id of a tenant when any new account is created,
and persist this as account metadata. If an account is created for a tenant
using a token with reselleradmin role that is not scoped on that tenant,
keystoneauth is unable to determine the domain id of the tenant;
keystoneauth will assume that the tenant may not be in the default domain
and therefore not match names in ACLs for that account.</p>
<p>By default, middleware higher in the WSGI pipeline may override auth
processing, useful for middleware such as tempurl and formpost. If you know
you&#8217;re not going to use such middleware and you want a bit of extra
security you can disable this behaviour by setting the <code class="docutils literal"><span class="pre">allow_overrides</span></code>
option to <code class="docutils literal"><span class="pre">false</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">allow_overrides</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI app in the pipeline</li>
<li><strong>conf</strong> &#8211; The dict of configuration values</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="swift.common.middleware.keystoneauth.KeystoneAuth.authorize_anonymous">
<code class="descname">authorize_anonymous</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.keystoneauth.KeystoneAuth.authorize_anonymous" title="Permalink to this definition">¶</a></dt>
<dd><p>Authorize an anonymous request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">None if authorization is granted, an error page otherwise.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.keystoneauth.KeystoneAuth.denied_response">
<code class="descname">denied_response</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.keystoneauth.KeystoneAuth.denied_response" title="Permalink to this definition">¶</a></dt>
<dd><p>Deny WSGI Response.</p>
<p>Returns a standard WSGI response callable with the status of 403 or 401
depending on whether the REMOTE_USER is set or not.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.keystoneauth.filter_factory">
<code class="descclassname">swift.common.middleware.keystoneauth.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.keystoneauth.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a WSGI filter app for use with paste.deploy.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.list_endpoints">
<span id="id9"></span><span id="list-endpoints"></span><h2>List Endpoints<a class="headerlink" href="#module-swift.common.middleware.list_endpoints" title="Permalink to this headline">¶</a></h2>
<p>List endpoints for an object, account or container.</p>
<p>This middleware makes it possible to integrate swift with software
that relies on data locality information to avoid network overhead,
such as Hadoop.</p>
<p>Using the original API, answers requests of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/endpoints/{account}/{container}/{object}
/endpoints/{account}/{container}
/endpoints/{account}
/endpoints/v1/{account}/{container}/{object}
/endpoints/v1/{account}/{container}
/endpoints/v1/{account}
</pre></div>
</div>
<p>with a JSON-encoded list of endpoints of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://{server}:{port}/{dev}/{part}/{acc}/{cont}/{obj}
http://{server}:{port}/{dev}/{part}/{acc}/{cont}
http://{server}:{port}/{dev}/{part}/{acc}
</pre></div>
</div>
<p>correspondingly, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://10.1.1.1:6200/sda1/2/a/c2/o1
http://10.1.1.1:6200/sda1/2/a/c2
http://10.1.1.1:6200/sda1/2/a
</pre></div>
</div>
<p>Using the v2 API, answers requests of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>/endpoints/v2/{account}/{container}/{object}
/endpoints/v2/{account}/{container}
/endpoints/v2/{account}
</pre></div>
</div>
<p>with a JSON-encoded dictionary containing a key &#8216;endpoints&#8217; that maps to a list
of endpoints having the same form as described above, and a key &#8216;headers&#8217; that
maps to a dictionary of headers that should be sent with a request made to
the endpoints, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="s2">&quot;endpoints&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;http://10.1.1.1:6010/sda1/2/a/c3/o1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://10.1.1.1:6030/sda3/2/a/c3/o1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;http://10.1.1.1:6040/sda4/2/a/c3/o1&quot;</span><span class="p">},</span>
  <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;X-Backend-Storage-Policy-Index&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}}</span>
</pre></div>
</div>
<p>In this example, the &#8216;headers&#8217; dictionary indicates that requests to the
endpoint URLs should include the header &#8216;X-Backend-Storage-Policy-Index: 1&#8217;
because the object&#8217;s container is using storage policy index 1.</p>
<p>The &#8216;/endpoints/&#8217; path is customizable (&#8216;list_endpoints_path&#8217;
configuration parameter).</p>
<p>Intended for consumption by third-party services living inside the
cluster (as the endpoints make sense only inside the cluster behind
the firewall); potentially written in a different language.</p>
<p>This is why it&#8217;s provided as a REST API and not just a Python API:
to avoid requiring clients to write their own ring parsers in their
languages, and to avoid the necessity to distribute the ring file
to clients and keep it up-to-date.</p>
<p>Note that the call is not authenticated, which means that a proxy
with this middleware enabled should not be open to an untrusted
environment (everyone can query the locality data using this middleware).</p>
<dl class="class">
<dt id="swift.common.middleware.list_endpoints.ListEndpointsMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.list_endpoints.</code><code class="descname">ListEndpointsMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.list_endpoints.ListEndpointsMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>List endpoints for an object, account or container.</p>
<p>See above for a full description.</p>
<p>Uses configuration parameter <cite>swift_dir</cite> (default <cite>/etc/swift</cite>).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI filter or app in the paste.deploy
chain.</li>
<li><strong>conf</strong> &#8211; The configuration dict for the middleware.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="swift.common.middleware.list_endpoints.ListEndpointsMiddleware.get_object_ring">
<code class="descname">get_object_ring</code><span class="sig-paren">(</span><em>policy_idx</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.list_endpoints.ListEndpointsMiddleware.get_object_ring" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the ring object to use to handle a request based on its policy.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Policy_idx:</th><td class="field-body">policy index as defined in swift.conf</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">appropriate ring object</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.memcache">
<span id="memcache"></span><h2>Memcache<a class="headerlink" href="#module-swift.common.middleware.memcache" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.memcache.MemcacheMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.memcache.</code><code class="descname">MemcacheMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.memcache.MemcacheMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Caching middleware that manages caching in swift.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.name_check">
<span id="name-check-forbidden-character-filter"></span><h2>Name Check (Forbidden Character Filter)<a class="headerlink" href="#module-swift.common.middleware.name_check" title="Permalink to this headline">¶</a></h2>
<p>Created on February 27, 2012</p>
<p>A filter that disallows any paths that contain defined forbidden characters or
that exceed a defined length.</p>
<p>Place early in the proxy-server pipeline after the left-most occurrence of the
<code class="docutils literal"><span class="pre">proxy-logging</span></code> middleware (if present) and before the final
<code class="docutils literal"><span class="pre">proxy-logging</span></code> middleware (if present) or the <code class="docutils literal"><span class="pre">proxy-serer</span></code> app itself,
e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:main]
pipeline = catch_errors healthcheck proxy-logging name_check cache ratelimit tempauth sos proxy-logging proxy-server

[filter:name_check]
use = egg:swift#name_check
forbidden_chars = &#39;&quot;`&lt;&gt;
maximum_length = 255
</pre></div>
</div>
<p>There are default settings for forbidden_chars (FORBIDDEN_CHARS) and
maximum_length (MAX_LENGTH)</p>
<p>The filter returns HTTPBadRequest if path is invalid.</p>
<p>&#64;author: eamonn-otoole</p>
</div>
<div class="section" id="module-swift.common.middleware.versioned_writes">
<span id="object-versioning"></span><span id="versioned-writes"></span><h2>Object Versioning<a class="headerlink" href="#module-swift.common.middleware.versioned_writes" title="Permalink to this headline">¶</a></h2>
<p>Object versioning in swift is implemented by setting a flag on the container
to tell swift to version all objects in the container. The value of the flag is
the container where the versions are stored (commonly referred to as the
&#8220;archive container&#8221;). The flag itself is one of two headers, which determines
how object <code class="docutils literal"><span class="pre">DELETE</span></code> requests are handled:</p>
<blockquote>
<div><ul>
<li><p class="first"><code class="docutils literal"><span class="pre">X-History-Location</span></code></p>
<p>On <code class="docutils literal"><span class="pre">DELETE</span></code>, copy the current version of the object to the archive
container, write a zero-byte &#8220;delete marker&#8221; object that notes when the
delete took place, and delete the object from the versioned container. The
object will no longer appear in container listings for the versioned
container and future requests there will return <code class="docutils literal"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code>. However,
the content will still be recoverable from the archive container.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">X-Versions-Location</span></code></p>
<p>On <code class="docutils literal"><span class="pre">DELETE</span></code>, only remove the current version of the object. If any
previous versions exist in the archive container, the most recent one is
copied over the current version, and the copy in the archive container is
deleted. As a result, if you have 5 total versions of the object, you must
delete the object 5 times for that object name to start responding with
<code class="docutils literal"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code>.</p>
</li>
</ul>
</div></blockquote>
<p>Either header may be used for the various containers within an account, but
only one may be set for any given container. Attempting to set both
simulataneously will result in a <code class="docutils literal"><span class="pre">400</span> <span class="pre">Bad</span> <span class="pre">Request</span></code> response.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is recommended to use a different archive container for
each container that is being versioned.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Enabling versioning on an archive container is not recommended.</p>
</div>
<p>When data is <code class="docutils literal"><span class="pre">PUT</span></code> into a versioned container (a container with the
versioning flag turned on), the existing data in the file is redirected to a
new object in the archive container and the data in the <code class="docutils literal"><span class="pre">PUT</span></code> request is
saved as the data for the versioned object. The new object name (for the
previous version) is <code class="docutils literal"><span class="pre">&lt;archive_container&gt;/&lt;length&gt;&lt;object_name&gt;/&lt;timestamp&gt;</span></code>,
where <code class="docutils literal"><span class="pre">length</span></code> is the 3-character zero-padded hexadecimal length of the
<code class="docutils literal"><span class="pre">&lt;object_name&gt;</span></code> and <code class="docutils literal"><span class="pre">&lt;timestamp&gt;</span></code> is the timestamp of when the previous
version was created.</p>
<p>A <code class="docutils literal"><span class="pre">GET</span></code> to a versioned object will return the current version of the object
without having to do any request redirects or metadata lookups.</p>
<p>A <code class="docutils literal"><span class="pre">POST</span></code> to a versioned object will update the object metadata as normal,
but will not create a new version of the object. In other words, new versions
are only created when the content of the object changes.</p>
<p>A <code class="docutils literal"><span class="pre">DELETE</span></code> to a versioned object will be handled in one of two ways,
as described above.</p>
<p>To restore a previous version of an object, find the desired version in the
archive container then issue a <code class="docutils literal"><span class="pre">COPY</span></code> with a <code class="docutils literal"><span class="pre">Destination</span></code> header
indicating the original location. This will archive the current version similar
to a <code class="docutils literal"><span class="pre">PUT</span></code> over the versioned object. If the client additionally wishes to
permanently delete what was the current version, it must find the newly-created
archive in the archive container and issue a separate <code class="docutils literal"><span class="pre">DELETE</span></code> to it.</p>
<div class="section" id="how-to-enable-object-versioning-in-a-swift-cluster">
<h3>How to Enable Object Versioning in a Swift Cluster<a class="headerlink" href="#how-to-enable-object-versioning-in-a-swift-cluster" title="Permalink to this headline">¶</a></h3>
<p>This middleware was written as an effort to refactor parts of the proxy server,
so this functionality was already available in previous releases and every
attempt was made to maintain backwards compatibility. To allow operators to
perform a seamless upgrade, it is not required to add the middleware to the
proxy pipeline and the flag <code class="docutils literal"><span class="pre">allow_versions</span></code> in the container server
configuration files are still valid, but only when using
<code class="docutils literal"><span class="pre">X-Versions-Location</span></code>. In future releases, <code class="docutils literal"><span class="pre">allow_versions</span></code> will be
deprecated in favor of adding this middleware to the pipeline to enable or
disable the feature.</p>
<p>In case the middleware is added to the proxy pipeline, you must also
set <code class="docutils literal"><span class="pre">allow_versioned_writes</span></code> to <code class="docutils literal"><span class="pre">True</span></code> in the middleware options
to enable the information about this middleware to be returned in a /info
request.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You need to add the middleware to the proxy pipeline and set
<code class="docutils literal"><span class="pre">allow_versioned_writes</span> <span class="pre">=</span> <span class="pre">True</span></code> to use <code class="docutils literal"><span class="pre">X-History-Location</span></code>. Setting
<code class="docutils literal"><span class="pre">allow_versions</span> <span class="pre">=</span> <span class="pre">True</span></code> in the container server is not sufficient to
enable the use of <code class="docutils literal"><span class="pre">X-History-Location</span></code>.</p>
</div>
</div></blockquote>
<div class="section" id="upgrade-considerations">
<h4>Upgrade considerations:<a class="headerlink" href="#upgrade-considerations" title="Permalink to this headline">¶</a></h4>
<p>If <code class="docutils literal"><span class="pre">allow_versioned_writes</span></code> is set in the filter configuration, you can leave
the <code class="docutils literal"><span class="pre">allow_versions</span></code> flag in the container server configuration files
untouched. If you decide to disable or remove the <code class="docutils literal"><span class="pre">allow_versions</span></code> flag, you
must re-set any existing containers that had the <code class="docutils literal"><span class="pre">X-Versions-Location</span></code> flag
configured so that it can now be tracked by the versioned_writes middleware.</p>
<p>Clients should not use the <code class="docutils literal"><span class="pre">X-History-Location</span></code> header until all proxies in
the cluster have been upgraded to a version of Swift that supports it.
Attempting to use <code class="docutils literal"><span class="pre">X-History-Location</span></code> during a rolling upgrade may result
in some requests being served by proxies running old code, leading to data
loss.</p>
</div>
</div>
<div class="section" id="examples-using-curl-with-x-versions-location">
<h3>Examples Using <code class="docutils literal"><span class="pre">curl</span></code> with <code class="docutils literal"><span class="pre">X-Versions-Location</span></code><a class="headerlink" href="#examples-using-curl-with-x-versions-location" title="Permalink to this headline">¶</a></h3>
<p>First, create a container with the <code class="docutils literal"><span class="pre">X-Versions-Location</span></code> header or add the
header to an existing container. Also make sure the container referenced by
the <code class="docutils literal"><span class="pre">X-Versions-Location</span></code> exists. In this example, the name of that
container is &#8220;versions&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT -H &quot;X-Auth-Token: &lt;token&gt;&quot; -H &quot;X-Versions-Location: versions&quot; http://&lt;storage_url&gt;/container
curl -i -XPUT -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions
</pre></div>
</div>
<p>Create an object (the first version):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT --data-binary 1 -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
<p>Now create a new version of that object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT --data-binary 2 -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
<p>See a listing of the older versions of the object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions?prefix=008myobject/
</pre></div>
</div>
<p>Now delete the current version of the object and see that the older version is
gone from &#8216;versions&#8217; container and back in &#8216;container&#8217; container:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XDELETE -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
curl -i -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions?prefix=008myobject/
curl -i -XGET -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
</div>
<div class="section" id="examples-using-curl-with-x-history-location">
<h3>Examples Using <code class="docutils literal"><span class="pre">curl</span></code> with <code class="docutils literal"><span class="pre">X-History-Location</span></code><a class="headerlink" href="#examples-using-curl-with-x-history-location" title="Permalink to this headline">¶</a></h3>
<p>As above, create a container with the <code class="docutils literal"><span class="pre">X-History-Location</span></code> header and ensure
that the container referenced by the <code class="docutils literal"><span class="pre">X-History-Location</span></code> exists. In this
example, the name of that container is &#8220;versions&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT -H &quot;X-Auth-Token: &lt;token&gt;&quot; -H &quot;X-History-Location: versions&quot; http://&lt;storage_url&gt;/container
curl -i -XPUT -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions
</pre></div>
</div>
<p>Create an object (the first version):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT --data-binary 1 -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
<p>Now create a new version of that object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPUT --data-binary 2 -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
<p>Now delete the current version of the object. Subsequent requests will 404:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XDELETE -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
curl -i -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/container/myobject
</pre></div>
</div>
<p>A listing of the older versions of the object will include both the first and
second versions of the object, as well as a &#8220;delete marker&#8221; object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions?prefix=008myobject/
</pre></div>
</div>
<p>To restore a previous version, simply <code class="docutils literal"><span class="pre">COPY</span></code> it from the archive container:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XCOPY -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions/008myobject/&lt;timestamp&gt; -H &quot;Destination: container/myobject&quot;
</pre></div>
</div>
<p>Note that the archive container still has all previous versions of the object,
including the source for the restore:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions?prefix=008myobject/
</pre></div>
</div>
<p>To permanently delete a previous version, <code class="docutils literal"><span class="pre">DELETE</span></code> it from the archive
container:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XDELETE -H &quot;X-Auth-Token: &lt;token&gt;&quot; http://&lt;storage_url&gt;/versions/008myobject/&lt;timestamp&gt;
</pre></div>
</div>
</div>
<div class="section" id="how-to-disable-object-versioning-in-a-swift-cluster">
<h3>How to Disable Object Versioning in a Swift Cluster<a class="headerlink" href="#how-to-disable-object-versioning-in-a-swift-cluster" title="Permalink to this headline">¶</a></h3>
<p>If you want to disable all functionality, set <code class="docutils literal"><span class="pre">allow_versioned_writes</span></code> to
<code class="docutils literal"><span class="pre">False</span></code> in the middleware options.</p>
<p>Disable versioning from a container (x is any value except empty):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -XPOST -H &quot;X-Auth-Token: &lt;token&gt;&quot; -H &quot;X-Remove-Versions-Location: x&quot; http://&lt;storage_url&gt;/container
</pre></div>
</div>
</div>
</div>
<div class="section" id="module-swift.common.middleware.proxy_logging">
<span id="proxy-logging"></span><h2>Proxy Logging<a class="headerlink" href="#module-swift.common.middleware.proxy_logging" title="Permalink to this headline">¶</a></h2>
<p>Logging middleware for the Swift proxy.</p>
<p>This serves as both the default logging implementation and an example of how
to plug in your own logging format/method.</p>
<p>The logging format implemented below is as follows:</p>
<dl class="docutils">
<dt>client_ip remote_addr datetime request_method request_path protocol</dt>
<dd>status_int referer user_agent auth_token bytes_recvd bytes_sent
client_etag transaction_id headers request_time source log_info
request_start_time request_end_time</dd>
</dl>
<p>These values are space-separated, and each is url-encoded, so that they can
be separated with a simple .split()</p>
<ul class="simple">
<li>remote_addr is the contents of the REMOTE_ADDR environment variable, while
client_ip is swift&#8217;s best guess at the end-user IP, extracted variously
from the X-Forwarded-For header, X-Cluster-Ip header, or the REMOTE_ADDR
environment variable.</li>
<li>source (swift.source in the WSGI environment) indicates the code
that generated the request, such as most middleware. (See below for
more detail.)</li>
<li>log_info (swift.log_info in the WSGI environment) is for additional
information that could prove quite useful, such as any x-delete-at
value or other &#8220;behind the scenes&#8221; activity that might not
otherwise be detectable from the plain log information. Code that
wishes to add additional log information should use code like
<code class="docutils literal"><span class="pre">env.setdefault('swift.log_info',</span> <span class="pre">[]).append(your_info)</span></code> so as to
not disturb others&#8217; log information.</li>
<li>Values that are missing (e.g. due to a header not being present) or zero
are generally represented by a single hyphen (&#8216;-&#8216;).</li>
</ul>
<p>The proxy-logging can be used twice in the proxy server&#8217;s pipeline when there
is middleware installed that can return custom responses that don&#8217;t follow the
standard pipeline to the proxy server.</p>
<p>For example, with staticweb, the middleware might intercept a request to
/v1/AUTH_acc/cont/, make a subrequest to the proxy to retrieve
/v1/AUTH_acc/cont/index.html and, in effect, respond to the client&#8217;s original
request using the 2nd request&#8217;s body. In this instance the subrequest will be
logged by the rightmost middleware (with a swift.source set) and the outgoing
request (with body overridden) will be logged by leftmost middleware.</p>
<p>Requests that follow the normal pipeline (use the same wsgi environment
throughout) will not be double logged because an environment variable
(swift.proxy_access_log_made) is checked/set when a log is made.</p>
<p>All middleware making subrequests should take care to set swift.source when
needed. With the doubled proxy logs, any consumer/processor of swift&#8217;s proxy
logs should look at the swift.source field, the rightmost log value, to decide
if this is a middleware subrequest or not. A log processor calculating
bandwidth usage will want to only sum up logs with no swift.source.</p>
<dl class="class">
<dt id="swift.common.middleware.proxy_logging.ProxyLoggingMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.proxy_logging.</code><code class="descname">ProxyLoggingMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em>, <em>logger=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.proxy_logging.ProxyLoggingMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Middleware that logs Swift proxy requests in the swift log format.</p>
<dl class="method">
<dt id="swift.common.middleware.proxy_logging.ProxyLoggingMiddleware.log_request">
<code class="descname">log_request</code><span class="sig-paren">(</span><em>req</em>, <em>status_int</em>, <em>bytes_received</em>, <em>bytes_sent</em>, <em>start_time</em>, <em>end_time</em>, <em>resp_headers=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.proxy_logging.ProxyLoggingMiddleware.log_request" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>req</strong> &#8211; swob.Request object for the request</li>
<li><strong>status_int</strong> &#8211; integer code for the response status</li>
<li><strong>bytes_received</strong> &#8211; bytes successfully read from the request body</li>
<li><strong>bytes_sent</strong> &#8211; bytes yielded to the WSGI server</li>
<li><strong>start_time</strong> &#8211; timestamp request started</li>
<li><strong>end_time</strong> &#8211; timestamp request completed</li>
<li><strong>resp_headers</strong> &#8211; dict of the response headers</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.ratelimit">
<span id="ratelimit"></span><h2>Ratelimit<a class="headerlink" href="#module-swift.common.middleware.ratelimit" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.ratelimit.RateLimitMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.ratelimit.</code><code class="descname">RateLimitMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em>, <em>logger=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.RateLimitMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Rate limiting middleware</p>
<p>Rate limits requests on both an Account and Container level.  Limits are
configurable.</p>
<dl class="method">
<dt id="swift.common.middleware.ratelimit.RateLimitMiddleware.get_ratelimitable_key_tuples">
<code class="descname">get_ratelimitable_key_tuples</code><span class="sig-paren">(</span><em>req</em>, <em>account_name</em>, <em>container_name=None</em>, <em>obj_name=None</em>, <em>global_ratelimit=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.RateLimitMiddleware.get_ratelimitable_key_tuples" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a list of key (used in memcache), ratelimit tuples. Keys
should be checked in order.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>req</strong> &#8211; swob request</li>
<li><strong>account_name</strong> &#8211; account name from path</li>
<li><strong>container_name</strong> &#8211; container name from path</li>
<li><strong>obj_name</strong> &#8211; object name from path</li>
<li><strong>global_ratelimit</strong> &#8211; this account has an account wide
ratelimit on all writes combined</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.ratelimit.RateLimitMiddleware.handle_ratelimit">
<code class="descname">handle_ratelimit</code><span class="sig-paren">(</span><em>req</em>, <em>account_name</em>, <em>container_name</em>, <em>obj_name</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.RateLimitMiddleware.handle_ratelimit" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs rate limiting and account white/black listing.  Sleeps
if necessary. If self.memcache_client is not set, immediately returns
None.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>account_name</strong> &#8211; account name from path</li>
<li><strong>container_name</strong> &#8211; container name from path</li>
<li><strong>obj_name</strong> &#8211; object name from path</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.ratelimit.filter_factory">
<code class="descclassname">swift.common.middleware.ratelimit.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>paste.deploy app factory for creating WSGI proxy apps.</p>
</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.ratelimit.get_maxrate">
<code class="descclassname">swift.common.middleware.ratelimit.</code><code class="descname">get_maxrate</code><span class="sig-paren">(</span><em>ratelimits</em>, <em>size</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.get_maxrate" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns number of requests allowed per second for given size.</p>
</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.ratelimit.interpret_conf_limits">
<code class="descclassname">swift.common.middleware.ratelimit.</code><code class="descname">interpret_conf_limits</code><span class="sig-paren">(</span><em>conf</em>, <em>name_prefix</em>, <em>info=None</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.ratelimit.interpret_conf_limits" title="Permalink to this definition">¶</a></dt>
<dd><p>Parses general parms for rate limits looking for things that
start with the provided name_prefix within the provided conf
and returns lists for both internal use and for /info</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>conf</strong> &#8211; conf dict to parse</li>
<li><strong>name_prefix</strong> &#8211; prefix of config parms to look for</li>
<li><strong>info</strong> &#8211; set to return extra stuff for /info registration</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="recon">
<span id="id10"></span><h2>Recon<a class="headerlink" href="#recon" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.recon"></span><dl class="class">
<dt id="swift.common.middleware.recon.ReconMiddleware">
<em class="property">class </em><code class="descclassname">swift.common.middleware.recon.</code><code class="descname">ReconMiddleware</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em>, <em>*args</em>, <em>**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Recon middleware used for monitoring.</p>
<p>/recon/load|mem|async... will return various system metrics.</p>
<p>Needs to be added to the pipeline and requires a filter
declaration in the object-server.conf:</p>
<p>[filter:recon]
use = egg:swift#recon
recon_cache_path = /var/cache/swift</p>
<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_async_info">
<code class="descname">get_async_info</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_async_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get # of async pendings</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_auditor_info">
<code class="descname">get_auditor_info</code><span class="sig-paren">(</span><em>recon_type</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_auditor_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get auditor info</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_device_info">
<code class="descname">get_device_info</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_device_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get devices</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_diskusage">
<code class="descname">get_diskusage</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_diskusage" title="Permalink to this definition">¶</a></dt>
<dd><p>get disk utilization statistics</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_driveaudit_error">
<code class="descname">get_driveaudit_error</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_driveaudit_error" title="Permalink to this definition">¶</a></dt>
<dd><p>get # of drive audit errors</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_expirer_info">
<code class="descname">get_expirer_info</code><span class="sig-paren">(</span><em>recon_type</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_expirer_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get expirer info</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_load">
<code class="descname">get_load</code><span class="sig-paren">(</span><em>openr=&lt;built-in function open&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_load" title="Permalink to this definition">¶</a></dt>
<dd><p>get info from /proc/loadavg</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_mem">
<code class="descname">get_mem</code><span class="sig-paren">(</span><em>openr=&lt;built-in function open&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_mem" title="Permalink to this definition">¶</a></dt>
<dd><p>get info from /proc/meminfo</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_mounted">
<code class="descname">get_mounted</code><span class="sig-paren">(</span><em>openr=&lt;built-in function open&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_mounted" title="Permalink to this definition">¶</a></dt>
<dd><p>get ALL mounted fs from /proc/mounts</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_quarantine_count">
<code class="descname">get_quarantine_count</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_quarantine_count" title="Permalink to this definition">¶</a></dt>
<dd><p>get obj/container/account quarantine counts</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_replication_info">
<code class="descname">get_replication_info</code><span class="sig-paren">(</span><em>recon_type</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_replication_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get replication info</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_ring_md5">
<code class="descname">get_ring_md5</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_ring_md5" title="Permalink to this definition">¶</a></dt>
<dd><p>get all ring md5sum&#8217;s</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_socket_info">
<code class="descname">get_socket_info</code><span class="sig-paren">(</span><em>openr=&lt;built-in function open&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_socket_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get info from /proc/net/sockstat and sockstat6</p>
<p>Note: The mem value is actually kernel pages, but we return bytes
allocated based on the systems page size.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_swift_conf_md5">
<code class="descname">get_swift_conf_md5</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_swift_conf_md5" title="Permalink to this definition">¶</a></dt>
<dd><p>get md5 of swift.conf</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_time">
<code class="descname">get_time</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_time" title="Permalink to this definition">¶</a></dt>
<dd><p>get current time</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_unmounted">
<code class="descname">get_unmounted</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_unmounted" title="Permalink to this definition">¶</a></dt>
<dd><p>list unmounted (failed?) devices</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_updater_info">
<code class="descname">get_updater_info</code><span class="sig-paren">(</span><em>recon_type</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_updater_info" title="Permalink to this definition">¶</a></dt>
<dd><p>get updater info</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.recon.ReconMiddleware.get_version">
<code class="descname">get_version</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.recon.ReconMiddleware.get_version" title="Permalink to this definition">¶</a></dt>
<dd><p>get swift version</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.copy">
<span id="server-side-copy"></span><span id="copy"></span><h2>Server Side Copy<a class="headerlink" href="#module-swift.common.middleware.copy" title="Permalink to this headline">¶</a></h2>
<p>Server side copy is a feature that enables users/clients to COPY objects
between accounts and containers without the need to download and then
re-upload objects, thus eliminating additional bandwidth consumption and
also saving time. This may be used when renaming/moving an object which
in Swift is a (COPY + DELETE) operation.</p>
<p>The server side copy middleware should be inserted in the pipeline after auth
and before the quotas and large object middlewares. If it is not present in the
pipeline in the proxy-server configuration file, it will be inserted
automatically. There is no configurable option provided to turn off server
side copy.</p>
<div class="section" id="metadata">
<h3>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>All metadata of source object is preserved during object copy.</li>
<li>One can also provide additional metadata during PUT/COPY request. This will
over-write any existing conflicting keys.</li>
<li>Server side copy can also be used to change content-type of an existing
object.</li>
</ul>
</div>
<div class="section" id="object-copy">
<h3>Object Copy<a class="headerlink" href="#object-copy" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>The destination container must exist before requesting copy of the object.</li>
<li>When several replicas exist, the system copies from the most recent replica.
That is, the copy operation behaves as though the X-Newest header is in the
request.</li>
<li>The request to copy an object should have no body (i.e. content-length of the
request must be zero).</li>
</ul>
<p>There are two ways in which an object can be copied:</p>
<ol class="arabic">
<li><p class="first">Send a PUT request to the new object (destination/target) with an additional
header named <code class="docutils literal"><span class="pre">X-Copy-From</span></code> specifying the source object
(in &#8216;/container/object&#8217; format). Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -X PUT http://&lt;storage_url&gt;/container1/destination_obj
 -H &#39;X-Auth-Token: &lt;token&gt;&#39;
 -H &#39;X-Copy-From: /container2/source_obj&#39;
 -H &#39;Content-Length: 0&#39;
</pre></div>
</div>
</li>
<li><p class="first">Send a COPY request with an existing object in URL with an additional header
named <code class="docutils literal"><span class="pre">Destination</span></code> specifying the destination/target object
(in &#8216;/container/object&#8217; format). Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -X COPY http://&lt;storage_url&gt;/container2/source_obj
 -H &#39;X-Auth-Token: &lt;token&gt;&#39;
 -H &#39;Destination: /container1/destination_obj&#39;
 -H &#39;Content-Length: 0&#39;
</pre></div>
</div>
</li>
</ol>
<p>Note that if the incoming request has some conditional headers (e.g. <code class="docutils literal"><span class="pre">Range</span></code>,
<code class="docutils literal"><span class="pre">If-Match</span></code>), the <em>source</em> object will be evaluated for these headers (i.e. if
PUT with both <code class="docutils literal"><span class="pre">X-Copy-From</span></code> and <code class="docutils literal"><span class="pre">Range</span></code>, Swift will make a partial copy to
the destination object).</p>
</div>
<div class="section" id="cross-account-object-copy">
<h3>Cross Account Object Copy<a class="headerlink" href="#cross-account-object-copy" title="Permalink to this headline">¶</a></h3>
<p>Objects can also be copied from one account to another account if the user
has the necessary permissions (i.e. permission to read from container
in source account and permission to write to container in destination account).</p>
<p>Similar to examples mentioned above, there are two ways to copy objects across
accounts:</p>
<ol class="arabic">
<li><p class="first">Like the example above, send PUT request to copy object but with an
additional header named <code class="docutils literal"><span class="pre">X-Copy-From-Account</span></code> specifying the source
account. Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -X PUT http://&lt;host&gt;:&lt;port&gt;/v1/AUTH_test1/container/destination_obj
 -H &#39;X-Auth-Token: &lt;token&gt;&#39;
 -H &#39;X-Copy-From: /container/source_obj&#39;
 -H &#39;X-Copy-From-Account: AUTH_test2&#39;
 -H &#39;Content-Length: 0&#39;
</pre></div>
</div>
</li>
<li><p class="first">Like the previous example, send a COPY request but with an additional header
named <code class="docutils literal"><span class="pre">Destination-Account</span></code> specifying the name of destination account.
Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>curl -i -X COPY http://&lt;host&gt;:&lt;port&gt;/v1/AUTH_test2/container/source_obj
 -H &#39;X-Auth-Token: &lt;token&gt;&#39;
 -H &#39;Destination: /container/destination_obj&#39;
 -H &#39;Destination-Account: AUTH_test1&#39;
 -H &#39;Content-Length: 0&#39;
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="large-object-copy">
<h3>Large Object Copy<a class="headerlink" href="#large-object-copy" title="Permalink to this headline">¶</a></h3>
<p>The best option to copy a large object is to copy segments individually.
To copy the manifest object of a large object, add the query parameter to
the copy request:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>?multipart-manifest=get
</pre></div>
</div>
<p>If a request is sent without the query parameter, an attempt will be made to
copy the whole object but will fail if the object size is
greater than 5GB.</p>
</div>
<div class="section" id="object-post-as-copy">
<h3>Object Post as Copy<a class="headerlink" href="#object-post-as-copy" title="Permalink to this headline">¶</a></h3>
<p>Historically, this has been a feature (and a configurable option with default
set to True) in proxy server configuration. This has been moved to server side
copy middleware and the default changed to False.</p>
<p>When <code class="docutils literal"><span class="pre">object_post_as_copy</span></code> is set to <code class="docutils literal"><span class="pre">true</span></code>, an incoming POST request is
morphed into a COPY request where source and destination objects are same.</p>
<p>This feature was necessary because of a previous behavior where POSTS would
update the metadata on the object but not on the container. As a result,
features like container sync would not work correctly. This is no longer the
case and this option is now deprecated. It will be removed in a future release.</p>
</div>
</div>
<div class="section" id="static-large-objects">
<h2>Static Large Objects<a class="headerlink" href="#static-large-objects" title="Permalink to this headline">¶</a></h2>
<p>Please see
the SLO docs for <a class="reference internal" href="overview_large_objects.html#slo-doc"><span>Static Large Objects</span></a> further details.</p>
</div>
<div class="section" id="staticweb">
<span id="id11"></span><h2>StaticWeb<a class="headerlink" href="#staticweb" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.staticweb"></span><p>This StaticWeb WSGI middleware will serve container data as a static web site
with index file and error file resolution and optional file listings. This mode
is normally only active for anonymous requests. When using keystone for
authentication set <code class="docutils literal"><span class="pre">delay_auth_decision</span> <span class="pre">=</span> <span class="pre">true</span></code> in the authtoken middleware
configuration in your <code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code> file.  If you want to
use it with authenticated requests, set the <code class="docutils literal"><span class="pre">X-Web-Mode:</span> <span class="pre">true</span></code> header on the
request.</p>
<p>The <code class="docutils literal"><span class="pre">staticweb</span></code> filter should be added to the pipeline in your
<code class="docutils literal"><span class="pre">/etc/swift/proxy-server.conf</span></code> file just after any auth middleware. Also, the
configuration section for the <code class="docutils literal"><span class="pre">staticweb</span></code> middleware itself needs to be
added. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[DEFAULT]
...

[pipeline:main]
pipeline = catch_errors healthcheck proxy-logging cache ratelimit tempauth
           staticweb proxy-logging proxy-server

...

[filter:staticweb]
use = egg:swift#staticweb
</pre></div>
</div>
<p>Any publicly readable containers (for example, <code class="docutils literal"><span class="pre">X-Container-Read:</span> <span class="pre">.r:*</span></code>, see
<a class="reference internal" href="misc.html#acls"><span>ACLs</span></a> for more information on this) will be checked for
X-Container-Meta-Web-Index and X-Container-Meta-Web-Error header values:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>X-Container-Meta-Web-Index  &lt;index.name&gt;
X-Container-Meta-Web-Error  &lt;error.name.suffix&gt;
</pre></div>
</div>
<p>If X-Container-Meta-Web-Index is set, any &lt;index.name&gt; files will be served
without having to specify the &lt;index.name&gt; part. For instance, setting
<code class="docutils literal"><span class="pre">X-Container-Meta-Web-Index:</span> <span class="pre">index.html</span></code> will be able to serve the object
.../pseudo/path/index.html with just .../pseudo/path or .../pseudo/path/</p>
<p>If X-Container-Meta-Web-Error is set, any errors (currently just 401
Unauthorized and 404 Not Found) will instead serve the
.../&lt;status.code&gt;&lt;error.name.suffix&gt; object. For instance, setting
<code class="docutils literal"><span class="pre">X-Container-Meta-Web-Error:</span> <span class="pre">error.html</span></code> will serve .../404error.html for
requests for paths not found.</p>
<p>For pseudo paths that have no &lt;index.name&gt;, this middleware can serve HTML file
listings if you set the <code class="docutils literal"><span class="pre">X-Container-Meta-Web-Listings:</span> <span class="pre">true</span></code> metadata item
on the container.</p>
<p>If listings are enabled, the listings can have a custom style sheet by setting
the X-Container-Meta-Web-Listings-CSS header. For instance, setting
<code class="docutils literal"><span class="pre">X-Container-Meta-Web-Listings-CSS:</span> <span class="pre">listing.css</span></code> will make listings link to
the .../listing.css style sheet. If you &#8220;view source&#8221; in your browser on a
listing page, you will see the well defined document structure that can be
styled.</p>
<p>By default, the listings will be rendered with a label of
&#8220;Listing of /v1/account/container/path&#8221;.  This can be altered by
setting a <code class="docutils literal"><span class="pre">X-Container-Meta-Web-Listings-Label:</span> <span class="pre">&lt;label&gt;</span></code>.  For example,
if the label is set to &#8220;example.com&#8221;, a label of
&#8220;Listing of example.com/path&#8221; will be used instead.</p>
<p>The content-type of directory marker objects can be modified by setting
the <code class="docutils literal"><span class="pre">X-Container-Meta-Web-Directory-Type</span></code> header.  If the header is not set,
application/directory is used by default.  Directory marker objects are
0-byte objects that represent directories to create a simulated hierarchical
structure.</p>
<p>Example usage of this middleware via <code class="docutils literal"><span class="pre">swift</span></code>:</p>
<blockquote>
<div><p>Make the container publicly readable:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -r &#39;.r:*&#39; container
</pre></div>
</div>
<p>You should be able to get objects directly, but no index.html resolution or
listings.</p>
<p>Set an index file directive:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -m &#39;web-index:index.html&#39; container
</pre></div>
</div>
<p>You should be able to hit paths that have an index.html without needing to
type the index.html part.</p>
<p>Turn on listings:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -r &#39;.r:*,.rlistings&#39; container
swift post -m &#39;web-listings: true&#39; container
</pre></div>
</div>
<p>Now you should see object listings for paths and pseudo paths that have no
index.html.</p>
<p>Enable a custom listings style sheet:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -m &#39;web-listings-css:listings.css&#39; container
</pre></div>
</div>
<p>Set an error file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -m &#39;web-error:error.html&#39; container
</pre></div>
</div>
<p>Now 401&#8217;s should load 401error.html, 404&#8217;s should load 404error.html, etc.</p>
<p>Set Content-Type of directory marker object:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>swift post -m &#39;web-directory-type:text/directory&#39; container
</pre></div>
</div>
<p>Now 0-byte objects with a content-type of text/directory will be treated
as directories rather than objects.</p>
</div></blockquote>
<dl class="class">
<dt id="swift.common.middleware.staticweb.StaticWeb">
<em class="property">class </em><code class="descclassname">swift.common.middleware.staticweb.</code><code class="descname">StaticWeb</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.staticweb.StaticWeb" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>The Static Web WSGI middleware filter; serves container data as a static
web site. See <a class="reference internal" href="#staticweb">staticweb</a> for an overview.</p>
<p>The proxy logs created for any subrequests made will have swift.source set
to &#8220;SW&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI application/filter in the paste.deploy pipeline.</li>
<li><strong>conf</strong> &#8211; The filter configuration dict.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="swift.common.middleware.staticweb.StaticWeb.app">
<code class="descname">app</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.staticweb.StaticWeb.app" title="Permalink to this definition">¶</a></dt>
<dd><p>The next WSGI application/filter in the paste.deploy pipeline.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.staticweb.StaticWeb.conf">
<code class="descname">conf</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.staticweb.StaticWeb.conf" title="Permalink to this definition">¶</a></dt>
<dd><p>The filter configuration dict. Only used in tests.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.staticweb.filter_factory">
<code class="descclassname">swift.common.middleware.staticweb.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.staticweb.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a Static Web WSGI filter for use with paste.deploy.</p>
</dd></dl>

</div>
<div class="section" id="module-swift.common.middleware.tempauth">
<span id="tempauth"></span><span id="common-tempauth"></span><h2>TempAuth<a class="headerlink" href="#module-swift.common.middleware.tempauth" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="swift.common.middleware.tempauth.TempAuth">
<em class="property">class </em><code class="descclassname">swift.common.middleware.tempauth.</code><code class="descname">TempAuth</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>Test authentication and authorization system.</p>
<p>Add to your pipeline in proxy-server.conf, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:main]
pipeline = catch_errors cache tempauth proxy-server
</pre></div>
</div>
<p>Set account auto creation to true in proxy-server.conf:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[app:proxy-server]
account_autocreate = true
</pre></div>
</div>
<p>And add a tempauth filter section, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[filter:tempauth]
use = egg:swift#tempauth
user_admin_admin = admin .admin .reseller_admin
user_test_tester = testing .admin
user_test2_tester2 = testing2 .admin
user_test_tester3 = testing3
# To allow accounts/users with underscores you can base64 encode them.
# Here is the account &quot;under_score&quot; and username &quot;a_b&quot; (note the lack
# of padding equal signs):
user64_dW5kZXJfc2NvcmU_YV9i = testing4
</pre></div>
</div>
<p>See the proxy-server.conf-sample for more information.</p>
<p>Multiple Reseller Prefix Items:</p>
<p>The reseller prefix specifies which parts of the account namespace this
middleware is responsible for managing authentication and authorization.
By default, the prefix is &#8216;AUTH&#8217; so accounts and tokens are prefixed
by &#8216;AUTH_&#8217;. When a request&#8217;s token and/or path start with &#8216;AUTH_&#8217;, this
middleware knows it is responsible.</p>
<p>We allow the reseller prefix to be a list. In tempauth, the first item
in the list is used as the prefix for tokens and user groups. The
other prefixes provide alternate accounts that user&#8217;s can access. For
example if the reseller prefix list is &#8216;AUTH, OTHER&#8217;, a user with
admin access to &#8216;AUTH_account&#8217; also has admin access to
&#8216;OTHER_account&#8217;.</p>
<p>Required Group:</p>
<p>The group .admin is normally needed to access an account (ACLs provide
an additional way to access an account). You can specify the
<code class="docutils literal"><span class="pre">require_group</span></code> parameter. This means that you also need the named group
to access an account. If you have several reseller prefix items, prefix
the <code class="docutils literal"><span class="pre">require_group</span></code> parameter with the appropriate prefix.</p>
<p>X-Service-Token:</p>
<p>If an X-Service-Token is presented in the request headers, the groups
derived from the token are appended to the roles derived from
X-Auth-Token. If X-Auth-Token is missing or invalid, X-Service-Token
is not processed.</p>
<p>The X-Service-Token is useful when combined with multiple reseller prefix
items. In the following configuration, accounts prefixed &#8216;SERVICE_&#8217;
are only accessible if X-Auth-Token is from the end-user and
X-Service-Token is from the <code class="docutils literal"><span class="pre">glance</span></code> user:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[filter:tempauth]
use = egg:swift#tempauth
reseller_prefix = AUTH, SERVICE
SERVICE_require_group = .service
user_admin_admin = admin .admin .reseller_admin
user_joeacct_joe = joepw .admin
user_maryacct_mary = marypw .admin
user_glance_glance = glancepw .service
</pre></div>
</div>
<p>The name .service is an example. Unlike .admin and .reseller_admin
it is not a reserved name.</p>
<p>Please note that ACLs can be set on service accounts and are matched
against the identity validated by X-Auth-Token. As such ACLs can grant
access to a service account&#8217;s container without needing to provide a
service token, just like any other cross-reseller request using ACLs.</p>
<dl class="docutils">
<dt>Account ACLs:</dt>
<dd><p class="first">If a swift_owner issues a POST or PUT to the account, with the
X-Account-Access-Control header set in the request, then this may
allow certain types of access for additional users.</p>
<ul class="last simple">
<li>Read-Only: Users with read-only access can list containers in the
account, list objects in any container, retrieve objects, and view
unprivileged account/container/object metadata.</li>
<li>Read-Write: Users with read-write access can (in addition to the
read-only privileges) create objects, overwrite existing objects,
create new containers, and set unprivileged container/object
metadata.</li>
<li>Admin: Users with admin access are swift_owners and can perform
any action, including viewing/setting privileged metadata (e.g.
changing account ACLs).</li>
</ul>
</dd>
</dl>
<p>To generate headers for setting an account ACL:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">swift.common.middleware.acl</span> <span class="kn">import</span> <span class="n">format_acl</span>
<span class="n">acl_data</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;alice&#39;</span><span class="p">],</span> <span class="s1">&#39;read-write&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="s1">&#39;carol&#39;</span><span class="p">]</span> <span class="p">}</span>
<span class="n">header_value</span> <span class="o">=</span> <span class="n">format_acl</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acl_dict</span><span class="o">=</span><span class="n">acl_data</span><span class="p">)</span>
</pre></div>
</div>
<p>To generate a curl command line from the above:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>token=...
storage_url=...
python -c &#39;
  from swift.common.middleware.acl import format_acl
  acl_data = { &#39;admin&#39;: [&#39;alice&#39;], &#39;read-write&#39;: [&#39;bob&#39;, &#39;carol&#39;] }
  headers = {&#39;X-Account-Access-Control&#39;:
             format_acl(version=2, acl_dict=acl_data)}
  header_str = &#39; &#39;.join([&quot;-H &#39;%s: %s&#39;&quot; % (k, v)
                         for k, v in headers.items()])
  print(&#39;curl -D- -X POST -H &quot;x-auth-token: $token&quot; %s &#39;
        &#39;$storage_url&#39; % header_str)
&#39;
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI app in the pipeline</li>
<li><strong>conf</strong> &#8211; The dict of configuration values from the Paste config file</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.account_acls">
<code class="descname">account_acls</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.account_acls" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a dict of ACL data from the account server via get_account_info.</p>
<p>Auth systems may define their own format, serialization, structure,
and capabilities implemented in the ACL headers and persisted in the
sysmeta data.  However, auth systems are strongly encouraged to be
interoperable with Tempauth.</p>
<dl class="docutils">
<dt>Account ACLs are set and retrieved via the header</dt>
<dd>X-Account-Access-Control</dd>
<dt>For header format and syntax, see:</dt>
<dd><ul class="first last simple">
<li><a class="reference internal" href="misc.html#swift.common.middleware.acl.parse_acl" title="swift.common.middleware.acl.parse_acl"><code class="xref py py-func docutils literal"><span class="pre">swift.common.middleware.acl.parse_acl()</span></code></a></li>
<li><a class="reference internal" href="misc.html#swift.common.middleware.acl.format_acl" title="swift.common.middleware.acl.format_acl"><code class="xref py py-func docutils literal"><span class="pre">swift.common.middleware.acl.format_acl()</span></code></a></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.authorize">
<code class="descname">authorize</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.authorize" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns None if the request is authorized to continue or a standard
WSGI response callable if not.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.denied_response">
<code class="descname">denied_response</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.denied_response" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a standard WSGI response callable with the status of 403 or 401
depending on whether the REMOTE_USER is set or not.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.extract_acl_and_report_errors">
<code class="descname">extract_acl_and_report_errors</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.extract_acl_and_report_errors" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a user-readable string indicating the errors in the input ACL,
or None if there are no errors.</p>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.get_groups">
<code class="descname">get_groups</code><span class="sig-paren">(</span><em>env</em>, <em>token</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.get_groups" title="Permalink to this definition">¶</a></dt>
<dd><p>Get groups for the given token.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>env</strong> &#8211; The current WSGI environment dictionary.</li>
<li><strong>token</strong> &#8211; Token to validate and return a group string for.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">None if the token is invalid or a string containing a comma
separated list of groups the authenticated user is a member
of. The first group in the list is also considered a unique
identifier for that user.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.handle">
<code class="descname">handle</code><span class="sig-paren">(</span><em>env</em>, <em>start_response</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.handle" title="Permalink to this definition">¶</a></dt>
<dd><p>WSGI entry point for auth requests (ones that match the
self.auth_prefix).
Wraps env in swob.Request object and passes it down.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>env</strong> &#8211; WSGI environment dictionary</li>
<li><strong>start_response</strong> &#8211; WSGI callable</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.handle_get_token">
<code class="descname">handle_get_token</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.handle_get_token" title="Permalink to this definition">¶</a></dt>
<dd><p>Handles the various <cite>request for token and service end point(s)</cite> calls.
There are various formats to support the various auth servers in the
past. Examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>GET &lt;auth-prefix&gt;/v1/&lt;act&gt;/auth
    X-Auth-User: &lt;act&gt;:&lt;usr&gt;  or  X-Storage-User: &lt;usr&gt;
    X-Auth-Key: &lt;key&gt;         or  X-Storage-Pass: &lt;key&gt;
GET &lt;auth-prefix&gt;/auth
    X-Auth-User: &lt;act&gt;:&lt;usr&gt;  or  X-Storage-User: &lt;act&gt;:&lt;usr&gt;
    X-Auth-Key: &lt;key&gt;         or  X-Storage-Pass: &lt;key&gt;
GET &lt;auth-prefix&gt;/v1.0
    X-Auth-User: &lt;act&gt;:&lt;usr&gt;  or  X-Storage-User: &lt;act&gt;:&lt;usr&gt;
    X-Auth-Key: &lt;key&gt;         or  X-Storage-Pass: &lt;key&gt;
</pre></div>
</div>
<p>On successful authentication, the response will have X-Auth-Token and
X-Storage-Token set to the token to use with Swift and X-Storage-URL
set to the URL to the default Swift cluster to use.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>req</strong> &#8211; The swob.Request to process.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">swob.Response, 2xx on success with data set as explained
above.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="swift.common.middleware.tempauth.TempAuth.handle_request">
<code class="descname">handle_request</code><span class="sig-paren">(</span><em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.TempAuth.handle_request" title="Permalink to this definition">¶</a></dt>
<dd><p>Entry point for auth requests (ones that match the self.auth_prefix).
Should return a WSGI-style callable (such as swob.Response).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>req</strong> &#8211; swob.Request object</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.tempauth.filter_factory">
<code class="descclassname">swift.common.middleware.tempauth.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempauth.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a WSGI filter app for use with paste.deploy.</p>
</dd></dl>

</div>
<div class="section" id="tempurl">
<span id="id12"></span><h2>TempURL<a class="headerlink" href="#tempurl" title="Permalink to this headline">¶</a></h2>
<span class="target" id="module-swift.common.middleware.tempurl"></span><p>TempURL Middleware</p>
<p>Allows the creation of URLs to provide temporary access to objects.</p>
<p>For example, a website may wish to provide a link to download a large
object in Swift, but the Swift account has no public access. The
website can generate a URL that will provide GET access for a limited
time to the resource. When the web browser user clicks on the link,
the browser will download the object directly from Swift, obviating
the need for the website to act as a proxy for the request.</p>
<p>If the user were to share the link with all his friends, or
accidentally post it on a forum, etc. the direct access would be
limited to the expiration time set when the website created the link.</p>
<p>Beyond that, the middleware provides the ability to create URLs, which
contain signatures which are valid for all objects which share a
common prefix. These prefix-based URLs are useful for sharing a set
of objects.</p>
<div class="section" id="client-usage">
<h3>Client Usage<a class="headerlink" href="#client-usage" title="Permalink to this headline">¶</a></h3>
<p>To create temporary URLs, first an <code class="docutils literal"><span class="pre">X-Account-Meta-Temp-URL-Key</span></code>
header must be set on the Swift account. Then, an HMAC-SHA1 (RFC 2104)
signature is generated using the HTTP method to allow (<code class="docutils literal"><span class="pre">GET</span></code>, <code class="docutils literal"><span class="pre">PUT</span></code>,
<code class="docutils literal"><span class="pre">DELETE</span></code>, etc.), the Unix timestamp the access should be allowed until,
the full path to the object, and the key set on the account.</p>
<p>For example, here is code generating the signature for a <code class="docutils literal"><span class="pre">GET</span></code> for 60
seconds on <code class="docutils literal"><span class="pre">/v1/AUTH_account/container/object</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
<span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/v1/AUTH_account/container/object&#39;</span>
<span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;mykey&#39;</span>
<span class="n">hmac_body</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">expires</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">hmac_body</span><span class="p">,</span> <span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
<p>Be certain to use the full path, from the <code class="docutils literal"><span class="pre">/v1/</span></code> onward.</p>
<p>Let&#8217;s say <code class="docutils literal"><span class="pre">sig</span></code> ends up equaling
<code class="docutils literal"><span class="pre">da39a3ee5e6b4b0d3255bfef95601890afd80709</span></code> and <code class="docutils literal"><span class="pre">expires</span></code> ends up
<code class="docutils literal"><span class="pre">1323479485</span></code>. Then, for example, the website could provide a link to:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485
</pre></div>
</div>
<p>You may also use ISO 8601 UTC timestamps with the format
<code class="docutils literal"><span class="pre">&quot;%Y-%m-%dT%H:%M:%SZ&quot;</span></code> instead of UNIX timestamps in the URL
(but NOT in the code above for generating the signature!).
So, the latter URL could also be formulated as:</p>
<blockquote>
<div><a class="reference external" href="https://swift-cluster.example.com/v1/AUTH_account/container/object">https://swift-cluster.example.com/v1/AUTH_account/container/object</a>?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=2011-12-10T01:11:25Z</div></blockquote>
<p>If a prefix-based signature with the prefix <code class="docutils literal"><span class="pre">pre</span></code> is desired, set path to:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;prefix:/v1/AUTH_account/container/pre&#39;</span>
</pre></div>
</div>
<p>The generated signature would be valid for all objects starting
with <code class="docutils literal"><span class="pre">pre</span></code>. The middleware detects a prefix-based temporary URL by
a query parameter called <code class="docutils literal"><span class="pre">temp_url_prefix</span></code>. So, if <code class="docutils literal"><span class="pre">sig</span></code> and <code class="docutils literal"><span class="pre">expires</span></code>
would end up like above, following URL would be valid:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/pre/object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485&amp;
temp_url_prefix=pre
</pre></div>
</div>
<p>Another valid URL:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/pre/
subfolder/another_object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485&amp;
temp_url_prefix=pre
</pre></div>
</div>
<p>Any alteration of the resource path or query arguments of a temporary URL
would result in <code class="docutils literal"><span class="pre">401</span> <span class="pre">Unauthorized</span></code>. Similarly, a <code class="docutils literal"><span class="pre">PUT</span></code> where <code class="docutils literal"><span class="pre">GET</span></code> was
the allowed method would be rejected with <code class="docutils literal"><span class="pre">401</span> <span class="pre">Unauthorized</span></code>.
However, <code class="docutils literal"><span class="pre">HEAD</span></code> is allowed if <code class="docutils literal"><span class="pre">GET</span></code>, <code class="docutils literal"><span class="pre">PUT</span></code>, or <code class="docutils literal"><span class="pre">POST</span></code> is allowed.</p>
<p>Using this in combination with browser form post translation
middleware could also allow direct-from-browser uploads to specific
locations in Swift.</p>
<p>TempURL supports both account and container level keys.  Each allows up to two
keys to be set, allowing key rotation without invalidating all existing
temporary URLs.  Account keys are specified by <code class="docutils literal"><span class="pre">X-Account-Meta-Temp-URL-Key</span></code>
and <code class="docutils literal"><span class="pre">X-Account-Meta-Temp-URL-Key-2</span></code>, while container keys are specified by
<code class="docutils literal"><span class="pre">X-Container-Meta-Temp-URL-Key</span></code> and <code class="docutils literal"><span class="pre">X-Container-Meta-Temp-URL-Key-2</span></code>.
Signatures are checked against account and container keys, if
present.</p>
<p>With <code class="docutils literal"><span class="pre">GET</span></code> TempURLs, a <code class="docutils literal"><span class="pre">Content-Disposition</span></code> header will be set on the
response so that browsers will interpret this as a file attachment to
be saved. The filename chosen is based on the object name, but you
can override this with a filename query parameter. Modifying the
above example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485&amp;filename=My+Test+File.pdf
</pre></div>
</div>
<p>If you do not want the object to be downloaded, you can cause
<code class="docutils literal"><span class="pre">Content-Disposition:</span> <span class="pre">inline</span></code> to be set on the response by adding the
<code class="docutils literal"><span class="pre">inline</span></code> parameter to the query string, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485&amp;inline
</pre></div>
</div>
<p>In some cases, the client might not able to present the content of the object,
but you still want the content able to save to local with the specific
filename. So you can cause <code class="docutils literal"><span class="pre">Content-Disposition:</span> <span class="pre">inline;</span> <span class="pre">filename=...</span></code> to be
set on the response by adding the <code class="docutils literal"><span class="pre">inline&amp;filename=...</span></code> parameter to the
query string, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>https://swift-cluster.example.com/v1/AUTH_account/container/object?
temp_url_sig=da39a3ee5e6b4b0d3255bfef95601890afd80709&amp;
temp_url_expires=1323479485&amp;inline&amp;filename=My+Test+File.pdf
</pre></div>
</div>
</div>
<div class="section" id="cluster-configuration">
<h3>Cluster Configuration<a class="headerlink" href="#cluster-configuration" title="Permalink to this headline">¶</a></h3>
<p>This middleware understands the following configuration settings:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">incoming_remove_headers</span></code></dt>
<dd>A whitespace-delimited list of the headers to remove from
incoming requests. Names may optionally end with <code class="docutils literal"><span class="pre">*</span></code> to
indicate a prefix match. <code class="docutils literal"><span class="pre">incoming_allow_headers</span></code> is a
list of exceptions to these removals.
Default: <code class="docutils literal"><span class="pre">x-timestamp</span></code></dd>
<dt><code class="docutils literal"><span class="pre">incoming_allow_headers</span></code></dt>
<dd><p class="first">A whitespace-delimited list of the headers allowed as
exceptions to <code class="docutils literal"><span class="pre">incoming_remove_headers</span></code>. Names may
optionally end with <code class="docutils literal"><span class="pre">*</span></code> to indicate a prefix match.</p>
<p class="last">Default: None</p>
</dd>
<dt><code class="docutils literal"><span class="pre">outgoing_remove_headers</span></code></dt>
<dd><p class="first">A whitespace-delimited list of the headers to remove from
outgoing responses. Names may optionally end with <code class="docutils literal"><span class="pre">*</span></code> to
indicate a prefix match. <code class="docutils literal"><span class="pre">outgoing_allow_headers</span></code> is a
list of exceptions to these removals.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">x-object-meta-*</span></code></p>
</dd>
<dt><code class="docutils literal"><span class="pre">outgoing_allow_headers</span></code></dt>
<dd><p class="first">A whitespace-delimited list of the headers allowed as
exceptions to <code class="docutils literal"><span class="pre">outgoing_remove_headers</span></code>. Names may
optionally end with <code class="docutils literal"><span class="pre">*</span></code> to indicate a prefix match.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">x-object-meta-public-*</span></code></p>
</dd>
<dt><code class="docutils literal"><span class="pre">methods</span></code></dt>
<dd><p class="first">A whitespace delimited list of request methods that are
allowed to be used with a temporary URL.</p>
<p class="last">Default: <code class="docutils literal"><span class="pre">GET</span> <span class="pre">HEAD</span> <span class="pre">PUT</span> <span class="pre">POST</span> <span class="pre">DELETE</span></code></p>
</dd>
</dl>
<dl class="class">
<dt id="swift.common.middleware.tempurl.TempURL">
<em class="property">class </em><code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">TempURL</code><span class="sig-paren">(</span><em>app</em>, <em>conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">object</span></code></p>
<p>WSGI Middleware to grant temporary URLs specific access to Swift
resources. See the overview for more information.</p>
<p>The proxy logs created for any subrequests made will have swift.source set
to &#8220;TU&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>app</strong> &#8211; The next WSGI filter or app in the paste.deploy
chain.</li>
<li><strong>conf</strong> &#8211; The configuration dict for the middleware.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.agent">
<code class="descname">agent</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.agent" title="Permalink to this definition">¶</a></dt>
<dd><p>HTTP user agent to use for subrequests.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.app">
<code class="descname">app</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.app" title="Permalink to this definition">¶</a></dt>
<dd><p>The next WSGI application/filter in the paste.deploy pipeline.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.conf">
<code class="descname">conf</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.conf" title="Permalink to this definition">¶</a></dt>
<dd><p>The filter configuration dict.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.incoming_allow_headers">
<code class="descname">incoming_allow_headers</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.incoming_allow_headers" title="Permalink to this definition">¶</a></dt>
<dd><p>Headers to allow in incoming requests. Uppercase WSGI env style,
like <cite>HTTP_X_MATCHES_REMOVE_PREFIX_BUT_OKAY</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.incoming_allow_headers_startswith">
<code class="descname">incoming_allow_headers_startswith</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.incoming_allow_headers_startswith" title="Permalink to this definition">¶</a></dt>
<dd><p>Header with match prefixes to allow in incoming requests. Uppercase
WSGI env style, like <cite>HTTP_X_MATCHES_REMOVE_PREFIX_BUT_OKAY_*</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.incoming_remove_headers">
<code class="descname">incoming_remove_headers</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.incoming_remove_headers" title="Permalink to this definition">¶</a></dt>
<dd><p>Headers to remove from incoming requests. Uppercase WSGI env style,
like <cite>HTTP_X_PRIVATE</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.incoming_remove_headers_startswith">
<code class="descname">incoming_remove_headers_startswith</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.incoming_remove_headers_startswith" title="Permalink to this definition">¶</a></dt>
<dd><p>Header with match prefixes to remove from incoming requests.
Uppercase WSGI env style, like <cite>HTTP_X_SENSITIVE_*</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.outgoing_allow_headers">
<code class="descname">outgoing_allow_headers</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.outgoing_allow_headers" title="Permalink to this definition">¶</a></dt>
<dd><p>Headers to allow in outgoing responses. Lowercase, like
<cite>x-matches-remove-prefix-but-okay</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.outgoing_allow_headers_startswith">
<code class="descname">outgoing_allow_headers_startswith</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.outgoing_allow_headers_startswith" title="Permalink to this definition">¶</a></dt>
<dd><p>Header with match prefixes to allow in outgoing responses.
Lowercase, like <cite>x-matches-remove-prefix-but-okay-*</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.outgoing_remove_headers">
<code class="descname">outgoing_remove_headers</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.outgoing_remove_headers" title="Permalink to this definition">¶</a></dt>
<dd><p>Headers to remove from outgoing responses. Lowercase, like
<cite>x-account-meta-temp-url-key</cite>.</p>
</dd></dl>

<dl class="attribute">
<dt id="swift.common.middleware.tempurl.TempURL.outgoing_remove_headers_startswith">
<code class="descname">outgoing_remove_headers_startswith</code><em class="property"> = None</em><a class="headerlink" href="#swift.common.middleware.tempurl.TempURL.outgoing_remove_headers_startswith" title="Permalink to this definition">¶</a></dt>
<dd><p>Header with match prefixes to remove from outgoing responses.
Lowercase, like <cite>x-account-meta-private-*</cite>.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="swift.common.middleware.tempurl.filter_factory">
<code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">filter_factory</code><span class="sig-paren">(</span><em>global_conf</em>, <em>**local_conf</em><span class="sig-paren">)</span><a class="headerlink" href="#swift.common.middleware.tempurl.filter_factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the WSGI filter for use with paste.deploy.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.tempurl.DEFAULT_INCOMING_REMOVE_HEADERS">
<code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">DEFAULT_INCOMING_REMOVE_HEADERS</code><em class="property"> = 'x-timestamp'</em><a class="headerlink" href="#swift.common.middleware.tempurl.DEFAULT_INCOMING_REMOVE_HEADERS" title="Permalink to this definition">¶</a></dt>
<dd><p>Default headers to remove from incoming requests. Simply a whitespace
delimited list of header names and names can optionally end with &#8216;*&#8217; to
indicate a prefix match. DEFAULT_INCOMING_ALLOW_HEADERS is a list of
exceptions to these removals.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.tempurl.DEFAULT_INCOMING_ALLOW_HEADERS">
<code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">DEFAULT_INCOMING_ALLOW_HEADERS</code><em class="property"> = ''</em><a class="headerlink" href="#swift.common.middleware.tempurl.DEFAULT_INCOMING_ALLOW_HEADERS" title="Permalink to this definition">¶</a></dt>
<dd><p>Default headers as exceptions to DEFAULT_INCOMING_REMOVE_HEADERS. Simply a
whitespace delimited list of header names and names can optionally end with
&#8216;*&#8217; to indicate a prefix match.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.tempurl.DEFAULT_OUTGOING_REMOVE_HEADERS">
<code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">DEFAULT_OUTGOING_REMOVE_HEADERS</code><em class="property"> = 'x-object-meta-*'</em><a class="headerlink" href="#swift.common.middleware.tempurl.DEFAULT_OUTGOING_REMOVE_HEADERS" title="Permalink to this definition">¶</a></dt>
<dd><p>Default headers to remove from outgoing responses. Simply a whitespace
delimited list of header names and names can optionally end with &#8216;*&#8217; to
indicate a prefix match. DEFAULT_OUTGOING_ALLOW_HEADERS is a list of
exceptions to these removals.</p>
</dd></dl>

<dl class="data">
<dt id="swift.common.middleware.tempurl.DEFAULT_OUTGOING_ALLOW_HEADERS">
<code class="descclassname">swift.common.middleware.tempurl.</code><code class="descname">DEFAULT_OUTGOING_ALLOW_HEADERS</code><em class="property"> = 'x-object-meta-public-*'</em><a class="headerlink" href="#swift.common.middleware.tempurl.DEFAULT_OUTGOING_ALLOW_HEADERS" title="Permalink to this definition">¶</a></dt>
<dd><p>Default headers as exceptions to DEFAULT_OUTGOING_REMOVE_HEADERS. Simply a
whitespace delimited list of header names and names can optionally end with
&#8216;*&#8217; to indicate a prefix match.</p>
</dd></dl>

</div>
</div>
<div class="section" id="module-swift.common.middleware.xprofile">
<span id="xprofile"></span><h2>XProfile<a class="headerlink" href="#module-swift.common.middleware.xprofile" title="Permalink to this headline">¶</a></h2>
<p>Profiling middleware for Swift Servers.</p>
<p>The current implementation is based on eventlet aware profiler.(For the
future, more profilers could be added in to collect more data for analysis.)
Profiling all incoming requests and accumulating cpu timing statistics
information for performance tuning and optimization. An mini web UI is also
provided for profiling data analysis. It can be accessed from the URL as
below.</p>
<p>Index page for browse profile data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://SERVER_IP:PORT/__profile__
</pre></div>
</div>
<p>List all profiles to return profile ids in json format:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://SERVER_IP:PORT/__profile__/
http://SERVER_IP:PORT/__profile__/all
</pre></div>
</div>
<p>Retrieve specific profile data in different formats:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://SERVER_IP:PORT/__profile__/PROFILE_ID?format=[default|json|csv|ods]
http://SERVER_IP:PORT/__profile__/current?format=[default|json|csv|ods]
http://SERVER_IP:PORT/__profile__/all?format=[default|json|csv|ods]
</pre></div>
</div>
<p>Retrieve metrics from specific function in json format:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>http://SERVER_IP:PORT/__profile__/PROFILE_ID/NFL?format=json
http://SERVER_IP:PORT/__profile__/current/NFL?format=json
http://SERVER_IP:PORT/__profile__/all/NFL?format=json

NFL is defined by concatenation of file name, function name and the first
line number.
e.g.::
    account.py:50(GETorHEAD)
or with full path:
    opt/stack/swift/swift/proxy/controllers/account.py:50(GETorHEAD)

A list of URL examples:

http://localhost:8080/__profile__    (proxy server)
http://localhost:6200/__profile__/all    (object server)
http://localhost:6201/__profile__/current    (container server)
http://localhost:6202/__profile__/12345?format=json    (account server)
</pre></div>
</div>
<p>The profiling middleware can be configured in paste file for WSGI servers such
as proxy, account, container and object servers. Please refer to the sample
configuration files in etc directory.</p>
<p>The profiling data is provided with four formats such as binary(by default),
json, csv and odf spreadsheet which requires installing odfpy library.</p>
<blockquote>
<div>sudo pip install odfpy</div></blockquote>
<p>There&#8217;s also a simple visualization capability which is enabled by using
matplotlib toolkit. it is also required to be installed if you want to use
it to visualize statistic data.</p>
<blockquote>
<div>sudo apt-get install python-matplotlib</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Middleware</a><ul>
<li><a class="reference internal" href="#module-swift.common.middleware.account_quotas">Account Quotas</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.bulk">Bulk Operations (Delete and Archive Auto Extraction)</a><ul>
<li><a class="reference internal" href="#extract-archive">Extract Archive</a></li>
<li><a class="reference internal" href="#content-type">Content Type</a></li>
<li><a class="reference internal" href="#assigning-metadata">Assigning Metadata</a></li>
<li><a class="reference internal" href="#response">Response</a></li>
<li><a class="reference internal" href="#bulk-delete">Bulk Delete</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-swift.common.middleware.catch_errors">CatchErrors</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.cname_lookup">CNAME Lookup</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.container_quotas">Container Quotas</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.container_sync">Container Sync Middleware</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.crossdomain">Cross Domain Policies</a></li>
<li><a class="reference internal" href="#discoverability">Discoverability</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.domain_remap">Domain Remap</a></li>
<li><a class="reference internal" href="#dynamic-large-objects">Dynamic Large Objects</a></li>
<li><a class="reference internal" href="#encryption">Encryption</a></li>
<li><a class="reference internal" href="#formpost">FormPost</a></li>
<li><a class="reference internal" href="#gatekeeper">GateKeeper</a></li>
<li><a class="reference internal" href="#healthcheck">Healthcheck</a></li>
<li><a class="reference internal" href="#keymaster">Keymaster</a></li>
<li><a class="reference internal" href="#keystoneauth">KeystoneAuth</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.list_endpoints">List Endpoints</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.memcache">Memcache</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.name_check">Name Check (Forbidden Character Filter)</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.versioned_writes">Object Versioning</a><ul>
<li><a class="reference internal" href="#how-to-enable-object-versioning-in-a-swift-cluster">How to Enable Object Versioning in a Swift Cluster</a><ul>
<li><a class="reference internal" href="#upgrade-considerations">Upgrade considerations:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples-using-curl-with-x-versions-location">Examples Using <code class="docutils literal"><span class="pre">curl</span></code> with <code class="docutils literal"><span class="pre">X-Versions-Location</span></code></a></li>
<li><a class="reference internal" href="#examples-using-curl-with-x-history-location">Examples Using <code class="docutils literal"><span class="pre">curl</span></code> with <code class="docutils literal"><span class="pre">X-History-Location</span></code></a></li>
<li><a class="reference internal" href="#how-to-disable-object-versioning-in-a-swift-cluster">How to Disable Object Versioning in a Swift Cluster</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-swift.common.middleware.proxy_logging">Proxy Logging</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.ratelimit">Ratelimit</a></li>
<li><a class="reference internal" href="#recon">Recon</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.copy">Server Side Copy</a><ul>
<li><a class="reference internal" href="#metadata">Metadata</a></li>
<li><a class="reference internal" href="#object-copy">Object Copy</a></li>
<li><a class="reference internal" href="#cross-account-object-copy">Cross Account Object Copy</a></li>
<li><a class="reference internal" href="#large-object-copy">Large Object Copy</a></li>
<li><a class="reference internal" href="#object-post-as-copy">Object Post as Copy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#static-large-objects">Static Large Objects</a></li>
<li><a class="reference internal" href="#staticweb">StaticWeb</a></li>
<li><a class="reference internal" href="#module-swift.common.middleware.tempauth">TempAuth</a></li>
<li><a class="reference internal" href="#tempurl">TempURL</a><ul>
<li><a class="reference internal" href="#client-usage">Client Usage</a></li>
<li><a class="reference internal" href="#cluster-configuration">Cluster Configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-swift.common.middleware.xprofile">XProfile</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="misc.html"
                                  title="previous chapter">Misc</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/swift
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/middleware.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="misc.html" title="Misc"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">swift 2.12.1.dev102 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, OpenStack Foundation.
      Last updated on &#39;Tue Feb 14 07:57:22 2017, commit 7cb6882&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/swift");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>