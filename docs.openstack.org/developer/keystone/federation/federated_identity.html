<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Federated Identity &mdash; keystone 11.0.0.0rc2.dev29 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '11.0.0.0rc2.dev29',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="keystone 11.0.0.0rc2.dev29 documentation" href="../index.html" />
    <link rel="next" title="Configuring Keystone for Tokenless Authorization" href="../configure_tokenless_x509.html" />
    <link rel="prev" title="Configuring Keystone" href="../configuration.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="federated-identity">
<h1>Federated Identity<a class="headerlink" href="#federated-identity" title="Permalink to this headline">¶</a></h1>
<p>Keystone&#8217;s one-stop-shop for all federated identity documentation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<div class="section" id="configuring-keystone-for-federation">
<h2>Configuring Keystone for Federation<a class="headerlink" href="#configuring-keystone-for-federation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="definitions">
<h3>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><cite>Service Provider (SP)</cite>: provides a service to an end-user.</li>
<li><cite>Identity Provider (IdP)</cite>: service that stores information about users and
groups.</li>
<li><cite>SAML assertion</cite>: contains information about a user as provided by an IdP.</li>
</ul>
</div>
<div class="section" id="keystone-as-a-service-provider-sp">
<h3>Keystone as a Service Provider (SP)<a class="headerlink" href="#keystone-as-a-service-provider-sp" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is considered stable and supported as of the Juno release.</p>
</div>
<div class="section" id="prerequisites">
<h4>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h4>
<p>This approach to federation supports keystone as a Service Provider, consuming
identity properties issued by an external Identity Provider, such as SAML
assertions or OpenID Connect claims, or by using
<a class="reference internal" href="#keystone-as-an-identity-provider-idp">Keystone as an Identity Provider (IdP)</a>.</p>
<p>Federated users are not mirrored in the keystone identity backend
(for example, using the SQL driver). The external Identity Provider is
responsible for authenticating users, and communicates the result of
authentication to keystone using identity properties. Keystone maps these
values to keystone user groups and assignments created in keystone.</p>
<p>The following configuration steps were performed on a machine running
Ubuntu 14.04 and Apache 2.4.7.</p>
<p>To enable federation, you&#8217;ll need to:</p>
<ol class="arabic simple">
<li><a class="reference external" href="../apache-httpd.html">Run keystone under Apache</a>, rather than using uwsgi command.</li>
<li><a class="reference internal" href="#configure-apache-to-use-a-federation-capable-authentication-method">Configure Apache to use a federation capable authentication method</a>.</li>
<li><a class="reference internal" href="#configure-federation-in-keystone">Configure Federation in Keystone</a>.</li>
</ol>
<div class="section" id="configure-apache-to-use-a-federation-capable-authentication-method">
<h5>Configure Apache to use a federation capable authentication method<a class="headerlink" href="#configure-apache-to-use-a-federation-capable-authentication-method" title="Permalink to this headline">¶</a></h5>
<p>There is currently support for two major federation protocols:</p>
<ul class="simple">
<li>SAML - Keystone supports the following implementations:<ul>
<li>Shibboleth - see <a class="reference external" href="shibboleth.html">Setup Shibboleth</a>.</li>
<li>Mellon - see <a class="reference external" href="mellon.html">Setup Mellon</a>.</li>
</ul>
</li>
<li>OpenID Connect - see <a class="reference external" href="openidc.html">Setup OpenID Connect</a>.</li>
</ul>
</div>
<div class="section" id="configure-keystone-and-horizon-for-single-sign-on">
<h5>Configure keystone and Horizon for Single Sign-On<a class="headerlink" href="#configure-keystone-and-horizon-for-single-sign-on" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>To configure horizon to access a federated keystone,
follow the steps outlined at: <a class="reference external" href="websso.html">Keystone Federation and Horizon</a>.</li>
</ul>
</div>
</div>
<div class="section" id="configure-federation-in-keystone">
<h4>Configure Federation in Keystone<a class="headerlink" href="#configure-federation-in-keystone" title="Permalink to this headline">¶</a></h4>
<p>Now that the Identity Provider and keystone are communicating we can start to
configure <code class="docutils literal"><span class="pre">federation</span></code>.</p>
<ol class="arabic simple">
<li><a class="reference external" href="federated_identity.html#configure-authentication-drivers-in-keystone-conf">Configure authentication drivers in keystone.conf</a></li>
<li><a class="reference internal" href="#create-keystone-groups-and-assign-roles">Create keystone groups and assign roles</a></li>
<li><a class="reference internal" href="#add-identity-provider-s-mapping-s-and-protocol-s">Add Identity Provider(s), Mapping(s), and Protocol(s)</a></li>
</ol>
<div class="section" id="configure-authentication-drivers-in-keystone-conf">
<h5>Configure authentication drivers in keystone.conf<a class="headerlink" href="#configure-authentication-drivers-in-keystone-conf" title="Permalink to this headline">¶</a></h5>
<p>Add the authentication methods to the <code class="docutils literal"><span class="pre">[auth]</span></code> section in <code class="docutils literal"><span class="pre">keystone.conf</span></code>.
Names should be equal to protocol names added via Identity API v3. Here we use
examples <code class="docutils literal"><span class="pre">mapped</span></code> and <code class="docutils literal"><span class="pre">openid</span></code>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>auth<span class="o">]</span>
<span class="nv">methods</span> <span class="o">=</span> external,password,token,mapped,openid
</pre></div>
</div>
</div>
<div class="section" id="create-keystone-groups-and-assign-roles">
<h5>Create keystone groups and assign roles<a class="headerlink" href="#create-keystone-groups-and-assign-roles" title="Permalink to this headline">¶</a></h5>
<p>As mentioned earlier, no new users will be added to the Identity backend, but
the Identity Service requires group-based role assignments to authorize
federated users. The federation mapping function will map the user into local
Identity Service groups objects, and hence to local role assignments.</p>
<p>Thus, it is required to create the necessary Identity Service groups that
correspond to the Identity Provider&#8217;s groups; additionally, these groups should
be assigned roles on one or more projects or domains.</p>
<p>You may be interested in more information on <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3/#create-group">group management</a>
and <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3/#assign-role-to-group-on-project">role assignments</a>,
both of which are exposed to the CLI via <a class="reference external" href="https://pypi.python.org/pypi/python-openstackclient/">python-openstackclient</a>.</p>
<p>For example, create a new domain and project like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack domain create federated_domain
$ openstack project create federated_project --domain federated_domain
</pre></div>
</div>
<p>And a new group like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack group create federated_users
</pre></div>
</div>
<p>Add the group to the domain and project:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack role add --group federated_users --domain federated_domain Member
$ openstack role add --group federated_users --project federated_project Member
</pre></div>
</div>
<p>We&#8217;ll later add a mapping that makes all federated users a part of this group
and therefore members of the new domain.</p>
</div>
<div class="section" id="add-identity-provider-s-mapping-s-and-protocol-s">
<h5>Add Identity Provider(s), Mapping(s), and Protocol(s)<a class="headerlink" href="#add-identity-provider-s-mapping-s-and-protocol-s" title="Permalink to this headline">¶</a></h5>
<p>To utilize federation the following must be created in the Identity Service:</p>
<ul class="simple">
<li><a class="reference internal" href="#identity-provider">Identity Provider</a></li>
<li><a class="reference internal" href="#mapping">Mapping</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a></li>
</ul>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#os-federation-api">federation in keystone</a>.</p>
<div class="section" id="identity-provider">
<h6>Identity Provider<a class="headerlink" href="#identity-provider" title="Permalink to this headline">¶</a></h6>
<p>Create an Identity Provider object in keystone, which represents the Identity
Provider we will use to authenticate end users:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack identity provider create --remote-id https://myidp.example.com/v3/OS-FEDERATION/saml2/idp myidp
</pre></div>
</div>
<p>The value for the <code class="docutils literal"><span class="pre">remote-id</span></code> option is the Entity ID provided by the IdP. It
is the same value that you set for the SSO entityID in /etc/shibboleth/shibboleth2.xml.
If the IdP is a Keystone IdP, it is the value set in that Keystone&#8217;s
<code class="docutils literal"><span class="pre">[saml]/idp_entity_id</span></code> option. It will usually appear as a URI but there
is no requirement for it to resolve to anything and may be arbitrarily decided
by the administrator of the IdP. The local name, here called &#8216;myidp&#8217;, is
decided by you and will be used by the mapping and protocol, and later for
authentication.</p>
<p>A keystone identity provider may have multiple <cite>remote_ids</cite> specified, this
allows the same <em>keystone</em> identity provider resource to be used with multiple
external identity providers. For example, an identity provider resource
<code class="docutils literal"><span class="pre">university-idp</span></code>, may have the following <cite>remote_ids</cite>:
<code class="docutils literal"><span class="pre">['university-x',</span> <span class="pre">'university-y',</span> <span class="pre">'university-z']</span></code>.
This removes the need to configure N identity providers in keystone.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Remote IDs are globally unique. Two identity providers cannot be
associated with the same remote ID. Once authenticated with the external
identity provider, keystone will determine which identity provider
and mapping to use based on the protocol and the value returned from the
<cite>remote_id_attribute</cite> key.</p>
<p>For example, if our identity provider is <code class="docutils literal"><span class="pre">google</span></code>, the mapping used is
<code class="docutils literal"><span class="pre">google_mapping</span></code> and the protocol is <code class="docutils literal"><span class="pre">oidc</span></code>. The identity provider&#8217;s
remote IDs  would be: [<code class="docutils literal"><span class="pre">accounts.google.com</span></code>].
The <cite>remote_id_attribute</cite> value may be set to <code class="docutils literal"><span class="pre">HTTP_OIDC_ISS</span></code>, since
this value will always be <code class="docutils literal"><span class="pre">accounts.google.com</span></code>.</p>
<p class="last">The motivation for this approach is that there will always be some data
sent by the identity provider (in the assertion or claim) that uniquely
identifies the identity provider. This removes the requirement for horizon
to list all the identity providers that are trusted by keystone.</p>
</div>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#identity-providers">identity providers</a>.</p>
</div>
<div class="section" id="mapping">
<h6>Mapping<a class="headerlink" href="#mapping" title="Permalink to this headline">¶</a></h6>
<p>A mapping is a list of rules. The only Identity API objects that will support mapping are groups
and users.</p>
<p>Mapping adds a set of rules to map federation protocol attributes to Identity API objects.
There are many different ways to setup as well as combine these rules. More information on
rules can be found on the <a class="reference internal" href="mapping_combinations.html"><em>Mapping Combinations</em></a> page.</p>
<p>An Identity Provider has exactly one mapping specified per protocol.
Mapping objects can be used multiple times by different combinations of Identity Provider and Protocol.</p>
<p>As a simple example, if keystone is your IdP, you can map a few known remote
users to the group you already created:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat &gt; rules.json <span class="s">&lt;&lt;EOF</span>
<span class="s">[</span>
<span class="s">    {</span>
<span class="s">        &quot;local&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;user&quot;: {</span>
<span class="s">                    &quot;name&quot;: &quot;{0}&quot;</span>
<span class="s">                },</span>
<span class="s">                &quot;group&quot;: {</span>
<span class="s">                    &quot;domain&quot;: {</span>
<span class="s">                        &quot;name&quot;: &quot;Default&quot;</span>
<span class="s">                    },</span>
<span class="s">                    &quot;name&quot;: &quot;federated_users&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        ],</span>
<span class="s">        &quot;remote&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;type&quot;: &quot;openstack_user&quot;,</span>
<span class="s">                &quot;any_one_of&quot;: [</span>
<span class="s">                    &quot;demo&quot;,</span>
<span class="s">                    &quot;alt_demo&quot;</span>
<span class="s">                ]</span>
<span class="s">            }</span>
<span class="s">        ]</span>
<span class="s">    }</span>
<span class="s">]</span>
<span class="s">EOF</span>
$ openstack mapping create --rules rules.json myidp_mapping
</pre></div>
</div>
<p>As another example, if Shibboleth is your IdP, the remote section should use REMOTE_USER as the remote type:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat &gt; rules.json <span class="s">&lt;&lt;EOF</span>
<span class="s">[</span>
<span class="s">    {</span>
<span class="s">        &quot;local&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;user&quot;: {</span>
<span class="s">                    &quot;name&quot;: &quot;{0}&quot;</span>
<span class="s">                },</span>
<span class="s">                &quot;group&quot;: {</span>
<span class="s">                    &quot;domain&quot;: {</span>
<span class="s">                        &quot;name&quot;: &quot;Default&quot;</span>
<span class="s">                    },</span>
<span class="s">                    &quot;name&quot;: &quot;federated_users&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        ],</span>
<span class="s">        &quot;remote&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;type&quot;: &quot;REMOTE_USER&quot;</span>
<span class="s">            }</span>
<span class="s">        ]</span>
<span class="s">    }</span>
<span class="s">]</span>
<span class="s">EOF</span>
$ openstack mapping create --rules rules.json myidp_mapping
</pre></div>
</div>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#mappings">mapping</a>.</p>
</div>
<div class="section" id="protocol">
<h6>Protocol<a class="headerlink" href="#protocol" title="Permalink to this headline">¶</a></h6>
<p>A protocol contains information that dictates which Mapping rules to use for an incoming
request made by an IdP. An IdP may have multiple supported protocols.</p>
<p>You can create a protocol like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack federation protocol create mapped --mapping myidp_mapping --identity-provider myidp
</pre></div>
</div>
<p>The name you give the protocol is not arbitrary. It must match the method name
you gave in the <code class="docutils literal"><span class="pre">[auth]/methods</span></code> config option. When authenticating it will be
referred to as the <code class="docutils literal"><span class="pre">protocol_id</span></code>.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#protocols">federation protocols</a></p>
</div>
</div>
</div>
<div class="section" id="performing-federated-authentication">
<h4>Performing federated authentication<a class="headerlink" href="#performing-federated-authentication" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Authentication with keystone-to-keystone federation does not follow these steps.
See <a class="reference internal" href="#testing-it-all-out">Testing it all out</a> to authenticate with keystone-to-keystone.</p>
</div>
<ol class="arabic simple">
<li>Authenticate externally and generate an unscoped token in keystone</li>
<li>Determine accessible resources</li>
<li>Get a scoped token</li>
</ol>
<div class="section" id="get-an-unscoped-token">
<h5>Get an unscoped token<a class="headerlink" href="#get-an-unscoped-token" title="Permalink to this headline">¶</a></h5>
<p>Unlike other authentication methods in the Identity Service, the user does not
issue an HTTP POST request with authentication data in the request body. To
start federated authentication a user must access the dedicated URL with
Identity Provider&#8217;s and Protocol&#8217;s identifiers stored within a protected URL.
The URL has a format of:
<code class="docutils literal"><span class="pre">/v3/OS-FEDERATION/identity_providers/{idp_id}/protocols/{protocol_id}/auth</span></code>.</p>
<p>In this instance we follow a standard SAML2 authentication procedure, that is,
the user will be redirected to the Identity Provider&#8217;s authentication webpage
and be prompted for credentials. After successfully authenticating the user
will be redirected to the Service Provider&#8217;s endpoint. If using a web browser,
a token will be returned in JSON format, with the ID in the X-Subject-Token
header.</p>
<p>In the returned unscoped token, a list of Identity Service groups the user
belongs to will be included.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#request-an-unscoped-os-federation-token">getting an unscoped token</a>.</p>
<div class="section" id="example-curl">
<h6>Example cURL<a class="headerlink" href="#example-curl" title="Permalink to this headline">¶</a></h6>
<p>Note that the request does not include a body. The following url would be
considered protected by <code class="docutils literal"><span class="pre">mod_shib</span></code> and Apache, as such a request made
to the URL would be redirected to the Identity Provider, to start the
SAML authentication procedure.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -D - http://localhost:5000/v3/OS-FEDERATION/identity_providers/<span class="o">{</span>idp_id<span class="o">}</span>/protocols/<span class="o">{</span>protocol_id<span class="o">}</span>/auth
</pre></div>
</div>
</div>
</div>
<div class="section" id="determine-accessible-resources">
<h5>Determine accessible resources<a class="headerlink" href="#determine-accessible-resources" title="Permalink to this headline">¶</a></h5>
<p>By using the previously returned token, the user can issue requests to the list
projects and domains that are accessible.</p>
<ul class="simple">
<li>List projects a federated user can access: <code class="docutils literal"><span class="pre">GET</span> <span class="pre">/OS-FEDERATION/projects</span></code></li>
<li>List domains a federated user can access: <code class="docutils literal"><span class="pre">GET</span> <span class="pre">/OS-FEDERATION/domains</span></code></li>
</ul>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#list-projects-a-federated-user-can-access">listing resources</a>.</p>
<div class="section" id="id1">
<h6>Example cURL<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h6>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -H <span class="s2">&quot;X-Auth-Token: &lt;unscoped token&gt;&quot;</span> http://localhost:5000/v3/OS-FEDERATION/projects
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -H <span class="s2">&quot;X-Auth-Token: &lt;unscoped token&gt;&quot;</span> http://localhost:5000/v3/OS-FEDERATION/domains
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-a-scoped-token">
<h5>Get a scoped token<a class="headerlink" href="#get-a-scoped-token" title="Permalink to this headline">¶</a></h5>
<p>A federated user may request a scoped token, by using the unscoped token. A
project or domain may be specified by either <code class="docutils literal"><span class="pre">id</span></code> or <code class="docutils literal"><span class="pre">name</span></code>. An <code class="docutils literal"><span class="pre">id</span></code> is
sufficient to uniquely identify a project or domain.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#request-a-scoped-os-federation-token">getting a scoped token</a>.</p>
<div class="section" id="id2">
<h6>Example cURL<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h6>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X POST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;auth&quot;:{&quot;identity&quot;:{&quot;methods&quot;:[&quot;mapped&quot;],&quot;mapped&quot;:{&quot;id&quot;:&quot;&lt;unscoped_token_id&gt;&quot;}},&quot;scope&quot;:{&quot;project&quot;:{&quot;domain&quot;: {&quot;name&quot;: &quot;federated_domain&quot;},&quot;name&quot;:&quot;federated_project&quot;}}}}&#39;</span> -D - http://localhost:5000/v3/auth/tokens
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="keystone-as-an-identity-provider-idp">
<h3>Keystone as an Identity Provider (IdP)<a class="headerlink" href="#keystone-as-an-identity-provider-idp" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is experimental and unsupported in Juno (with several issues
that will not be backported). These issues have been fixed and this feature
is considered stable and supported as of the Kilo release.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This feature requires installation of the xmlsec1 tool via your
distribution packaging system (for instance apt or yum)</p>
<p>Example for apt:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install xmlsec1
</pre></div>
</div>
</div>
<div class="section" id="configuration-options">
<h4>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h4>
<p>There are certain settings in <code class="docutils literal"><span class="pre">keystone.conf</span></code> that must be setup, prior to
attempting to federate multiple keystone deployments.</p>
<p>Within <code class="docutils literal"><span class="pre">keystone.conf</span></code>, assign values to the <code class="docutils literal"><span class="pre">[saml]</span></code> related fields, for
example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[saml]</span>
<span class="na">idp_entity_id</span><span class="o">=</span><span class="s">https://myidp.example.com/v3/OS-FEDERATION/saml2/idp</span>
<span class="na">idp_sso_endpoint</span><span class="o">=</span><span class="s">https://myidp.example.com/v3/OS-FEDERATION/saml2/sso</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">idp_entity_id</span></code> is the unique identifier for the Identity Provider. It
usually takes the form of a URI but it does not have to resolve to anything.
<code class="docutils literal"><span class="pre">idp_sso_endpoint</span></code> is required to generate valid metadata but its value is
not important, though it may be in the future.</p>
<p>Note the <code class="docutils literal"><span class="pre">certfile</span></code>, <code class="docutils literal"><span class="pre">keyfile</span></code>, and <code class="docutils literal"><span class="pre">idp_metadata_path</span></code> settings and adjust them if
necessary:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">certfile</span><span class="o">=</span><span class="s">/etc/keystone/ssl/certs/signing_cert.pem</span>
<span class="na">keyfile</span><span class="o">=</span><span class="s">/etc/keystone/ssl/private/signing_key.pem</span>
<span class="na">idp_metadata_path</span><span class="o">=</span><span class="s">/etc/keystone/saml2_idp_metadata.xml</span>
</pre></div>
</div>
<p>Though not necessary, the follow Organization configuration options should
also be setup. It is recommended that these values be URL safe.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">idp_organization_name</span><span class="o">=</span><span class="s">example_company</span>
<span class="na">idp_organization_display_name</span><span class="o">=</span><span class="s">Example Corp.</span>
<span class="na">idp_organization_url</span><span class="o">=</span><span class="s">example.com</span>
</pre></div>
</div>
<p>As with the Organization options, the Contact options, are not necessary, but
it&#8217;s advisable to set these values too.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">idp_contact_company</span><span class="o">=</span><span class="s">example_company</span>
<span class="na">idp_contact_name</span><span class="o">=</span><span class="s">John</span>
<span class="na">idp_contact_surname</span><span class="o">=</span><span class="s">Smith</span>
<span class="na">idp_contact_email</span><span class="o">=</span><span class="s">jsmith@example.com</span>
<span class="na">idp_contact_telephone</span><span class="o">=</span><span class="s">555-555-5555</span>
<span class="na">idp_contact_type</span><span class="o">=</span><span class="s">technical</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-metadata">
<h4>Generate Metadata<a class="headerlink" href="#generate-metadata" title="Permalink to this headline">¶</a></h4>
<p>In order to create a trust between the IdP and SP, metadata must be exchanged.</p>
<p>First, if you haven&#8217;t already generated a PKI key pair, you need to do so and
copy those files the locations designated by <code class="docutils literal"><span class="pre">certfile</span></code> and <code class="docutils literal"><span class="pre">keyfile</span></code>
options that were assigned in the previous section. Ensure that your apache
vhost has SSL enabled and is using that keypair by adding the following to the
vhost:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>SSLEngine on
SSLCertificateFile /etc/keystone/ssl/certs/signing_cert.pem
SSLCertificateKeyFile /etc/keystone/ssl/private/signing_key.pem
</pre></div>
</div>
<p>To create metadata for your keystone IdP, run the <code class="docutils literal"><span class="pre">keystone-manage</span></code> command
and redirect the output to a file. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage saml_idp_metadata &gt; /etc/keystone/saml2_idp_metadata.xml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The file location should match the value of the configuration option
<code class="docutils literal"><span class="pre">idp_metadata_path</span></code> that was assigned in the previous section.</p>
</div>
<p>Finally, restart apache.</p>
</div>
<div class="section" id="create-a-service-provider-sp">
<h4>Create a Service Provider (SP)<a class="headerlink" href="#create-a-service-provider-sp" title="Permalink to this headline">¶</a></h4>
<p>In this example we are creating a new Service Provider with an ID of <code class="docutils literal"><span class="pre">mysp</span></code>,
a <code class="docutils literal"><span class="pre">sp_url</span></code> of <code class="docutils literal"><span class="pre">http://mysp.example.com/Shibboleth.sso/SAML2/ECP</span></code> and a
<code class="docutils literal"><span class="pre">auth_url</span></code> of <code class="docutils literal"><span class="pre">http://mysp.example.com:5000/v3/OS-FEDERATION/identity_providers/myidp/protocols/mapped/auth</span></code>
. The <code class="docutils literal"><span class="pre">sp_url</span></code> will be used when creating a SAML assertion for <code class="docutils literal"><span class="pre">mysp</span></code> and
signed by the current keystone IdP. The <code class="docutils literal"><span class="pre">auth_url</span></code> is used to retrieve the
token for <code class="docutils literal"><span class="pre">mysp</span></code> once the SAML assertion is sent. The auth_url has the format
described in <a class="reference internal" href="#get-an-unscoped-token">Get an unscoped token</a>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack service provider create --service-provider-url <span class="s1">&#39;http://mysp.example.com/Shibboleth.sso/SAML2/ECP&#39;</span> --auth-url http://mysp.example.com:5000/v3/OS-FEDERATION/identity_providers/myidp/protocols/mapped/auth mysp
</pre></div>
</div>
</div>
<div class="section" id="testing-it-all-out">
<h4>Testing it all out<a class="headerlink" href="#testing-it-all-out" title="Permalink to this headline">¶</a></h4>
<p>Use keystoneauth to create a password session with the IdP, then use the
session to authenticate with the SP, and get a scoped token from the SP.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ECP stands for Enhanced Client or Proxy, an extension from the SAML2
protocol used in non-browser interfaces, like in the following example.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">keystoneauth1</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.identity</span> <span class="kn">import</span> <span class="n">v3</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.identity.v3</span> <span class="kn">import</span> <span class="n">k2k</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">Password</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_AUTH_URL&#39;</span><span class="p">),</span>
                   <span class="n">username</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_USERNAME&#39;</span><span class="p">),</span>
                   <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PASSWORD&#39;</span><span class="p">),</span>
                   <span class="n">user_domain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_USER_DOMAIN_NAME&#39;</span><span class="p">),</span>
                   <span class="n">project_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PROJECT_NAME&#39;</span><span class="p">),</span>
                   <span class="n">project_domain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PROJECT_DOMAIN_NAME&#39;</span><span class="p">))</span>
<span class="n">password_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<span class="n">k2ksession</span> <span class="o">=</span> <span class="n">k2k</span><span class="o">.</span><span class="n">Keystone2Keystone</span><span class="p">(</span><span class="n">password_session</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="s1">&#39;mysp&#39;</span><span class="p">,</span>
                                   <span class="n">domain_name</span><span class="o">=</span><span class="s1">&#39;federated_domain&#39;</span><span class="p">)</span>
<span class="n">auth_ref</span> <span class="o">=</span> <span class="n">k2ksession</span><span class="o">.</span><span class="n">get_auth_ref</span><span class="p">(</span><span class="n">password_session</span><span class="p">)</span>
<span class="n">scoped_token_id</span> <span class="o">=</span> <span class="n">auth_ref</span><span class="o">.</span><span class="n">auth_token</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scoped token id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">scoped_token_id</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="mapping-combinations">
<h2>Mapping Combinations<a class="headerlink" href="#mapping-combinations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="description">
<h3>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p>During the authentication process an identity provider (IdP) will present
keystone with a set of user attributes about the user that is authenticating.
For example, in the SAML2 flow this comes to keystone in the form of a SAML
document.</p>
<p>The attributes are typically processed by third-party software and are presented
to keystone as environment variables. The original document from the IdP is
generally not available to keystone. This is how the <cite>Shibboleth</cite> and <cite>Mellon</cite>
implementations work.</p>
<p>The mapping format described in this document maps these environment variables
to a local keystone user. The mapping may also define group membership for
that user and projects the user can access.</p>
<p>An IdP has exactly one mapping specified per protocol. Mappings themselves can
be used multiple times by different combinations of IdP and protocol.</p>
</div>
<div class="section" id="id3">
<h3>Definitions<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>A mapping looks as follows:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="o">&lt;</span><span class="nx">user</span><span class="o">&gt;</span>
                    <span class="p">[</span><span class="o">&lt;</span><span class="nx">group</span><span class="o">&gt;</span><span class="p">]</span>
                    <span class="p">[</span><span class="o">&lt;</span><span class="nx">project</span><span class="o">&gt;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="o">&lt;</span><span class="nx">match</span><span class="o">&gt;</span>
                    <span class="p">[</span><span class="o">&lt;</span><span class="nx">condition</span><span class="o">&gt;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><cite>mapping</cite>: a JSON object containing a list of rules.</li>
<li><cite>rules</cite>: a property in the mapping that contains the list of rules.</li>
<li><cite>rule</cite>: a JSON object containing <cite>local</cite> and <cite>remote</cite> properties to define
the rule. There is no explicit <cite>rule</cite> property.</li>
<li><cite>local</cite>: a JSON object containing information on what local attributes will
be mapped. The mapping engine processes this using the <cite>context</cite> (defined
below) and the result is a representation of the user from keystone&#8217;s
perspective.<ul>
<li><cite>&lt;user&gt;</cite>: the local user that will be mapped to the federated user.</li>
<li><cite>&lt;group&gt;</cite>: (optional) the local groups the federated user will be placed in.</li>
<li><cite>&lt;projects&gt;</cite>: (optional) the local projects mapped to the federated user.</li>
</ul>
</li>
<li><cite>remote</cite>: a JSON object containing information on what remote attributes will be mapped.<ul>
<li><cite>&lt;match&gt;</cite>: a JSON object that tells the mapping engine what federated attribute
to make available for substitution in the local object. There can be one or more
of these objects in the <cite>remote</cite> list.</li>
<li><cite>&lt;condition&gt;</cite>: a JSON object containing conditions that allow a rule. There can be
zero or more of these objects in the <cite>remote</cite> list.</li>
</ul>
</li>
<li><cite>direct mapping</cite>: the mapping engine keeps track of each match and makes them
available to the local rule for substitution.</li>
<li><cite>assertion</cite>: data provided to keystone by the IdP to assert facts
(name, groups, etc) about the authenticating user. This is an XML document when
using the SAML2 protocol.</li>
<li><cite>mapping context</cite>: the data, represented as key-value pairs, that is used by the
mapping engine to turn the <cite>local</cite> object into a representation of the user
from keystone&#8217;s perspective. The mapping context contains the environment of the
keystone process and any <cite>direct mapping</cite> values calculated when processing the
<cite>remote</cite> list.</li>
</ul>
</div>
<div class="section" id="how-mappings-are-processed">
<h3>How Mappings Are Processed<a class="headerlink" href="#how-mappings-are-processed" title="Permalink to this headline">¶</a></h3>
<p>A mapping is selected by IdP and protocol. Then keystone takes the mapping and
processes each rule sequentially stopping after the first matched rule. A rule
is matched when all of its conditions are met.</p>
<p>First keystone evaluates each condition from the rule&#8217;s remote property to see
if the rule is a match. If it is a match, keystone saves the data captured by
each of the matches from the rule&#8217;s remote property in an ordered list. We call
these matches <cite>direct mappings</cite> since they can be used in the next step.</p>
<p>After the rule is found using the rule&#8217;s conditions and a list of direct mappings is
stored, keystone begins processing the rule&#8217;s <cite>local</cite> property. Each object in
the <cite>local</cite> property is collapsed into a single JSON object. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{...}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;projects&quot;</span><span class="o">:</span> <span class="p">[...]</span>
        <span class="p">},</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>becomes:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{...}</span>
        <span class="s2">&quot;projects&quot;</span><span class="o">:</span> <span class="p">[...]</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>when the same property exists in the local multiple times the first occurrence wins:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>{
    &quot;local&quot;: [
        {
            &quot;user&quot;: {#first#}
        },
        {
            &quot;projects&quot;: [...]
        },
        {
            &quot;user&quot;: {#second#}
        },
    ]
}
</pre></div>
</div>
<p>becomes:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>{
    &quot;local&quot;: {
        &quot;user&quot;: {#first#}
        &quot;projects&quot;: [...]
    },
}
</pre></div>
</div>
<p>We take this JSON object and then recursively process it in order to apply
the direct mappings. This is simply looking for the pattern <cite>{#}</cite> and
substituting it with values from the direct mappings list. The index of the
direct mapping starts at zero.</p>
</div>
<div class="section" id="mapping-rules">
<h3>Mapping Rules<a class="headerlink" href="#mapping-rules" title="Permalink to this headline">¶</a></h3>
<div class="section" id="mapping-engine">
<h4>Mapping Engine<a class="headerlink" href="#mapping-engine" title="Permalink to this headline">¶</a></h4>
<p>The mapping engine can be tested before creating a federated setup. It can be
tested with the <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">mapping_engine</span></code> command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage mapping_engine --rules &lt;file&gt; --input &lt;file&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although the rules file is formated as JSON, the input file of assertion
data is formatted as individual lines of key: value pairs, see
<cite>keystone-manage mapping_engine &#8211;help</cite> for details.</p>
</div>
</div>
<div class="section" id="mapping-conditions">
<h4>Mapping Conditions<a class="headerlink" href="#mapping-conditions" title="Permalink to this headline">¶</a></h4>
<p>Mappings support 5 different types of conditions:</p>
<p><code class="docutils literal"><span class="pre">empty</span></code>: The rule is matched to all claims containing the remote attribute type.
This condition does not need to be specified.</p>
<p><code class="docutils literal"><span class="pre">any_one_of</span></code>: The rule is matched only if any of the specified strings appear
in the remote attribute type. Condition result is boolean, not the argument that
is passed as input.</p>
<p><code class="docutils literal"><span class="pre">not_any_of</span></code>: The rule is not matched if any of the specified strings appear
in the remote attribute type. Condition result is boolean, not the argument that
is passed as input.</p>
<p><code class="docutils literal"><span class="pre">blacklist</span></code>: The rule allows all except a specified set of groups. Condition
result is the argument(s) passed as input minus what was matched in the
blacklist.</p>
<p><code class="docutils literal"><span class="pre">whitelist</span></code>: The rules allows a specified set of groups. Condition result is
the argument(s) passed as input and is/are also present in the whitelist.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">empty</span></code>, <code class="docutils literal"><span class="pre">blacklist</span></code> and <code class="docutils literal"><span class="pre">whitelist</span></code> are the only conditions that can
be used in direct mapping ({0}, {1}, etc.)</p>
</div>
<p>Multiple conditions can be combined to create a single rule.</p>
</div>
<div class="section" id="mappings-examples">
<h4>Mappings Examples<a class="headerlink" href="#mappings-examples" title="Permalink to this headline">¶</a></h4>
<p>The following are all examples of mapping rule types.</p>
<div class="section" id="empty-condition">
<h5>empty condition<a class="headerlink" href="#empty-condition" title="Permalink to this headline">¶</a></h5>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0} {1}&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="s2">&quot;{2}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{3}&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0cd5e9&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;FirstName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;LastName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;Email&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;OIDC_GROUPS&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The numbers in braces {} are indices, they map in order. For example:</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span>- Mapping to user with the name matching the value in remote attribute FirstName
- Mapping to user with the name matching the value in remote attribute LastName
- Mapping to user with the email matching value in remote attribute Email
- Mapping to a group(s) with the name matching the value(s) in remote attribute OIDC_GROUPS
</pre></div>
</div>
</div>
<p>Groups can have multiple values. Each value must be separated by a <cite>;</cite>
Example: OIDC_GROUPS=developers;testers</p>
</div>
<div class="section" id="other-conditions">
<h5>other conditions<a class="headerlink" href="#other-conditions" title="Permalink to this headline">¶</a></h5>
<p>In <code class="docutils literal"><span class="pre">&lt;other_condition&gt;</span></code> shown below, please supply one of the following:
<code class="docutils literal"><span class="pre">any_one_of</span></code>, or <code class="docutils literal"><span class="pre">not_any_of</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0cd5e9&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;HTTP_OIDC_GROUPIDS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&lt;other_condition&gt;&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;HTTP_OIDC_EMAIL&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In <code class="docutils literal"><span class="pre">&lt;other_condition&gt;</span></code> shown below, please supply one of the following:
<code class="docutils literal"><span class="pre">blacklist</span></code>, or <code class="docutils literal"><span class="pre">whitelist</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;groups&quot;</span><span class="o">:</span> <span class="s2">&quot;{1}&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0cd5e9&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;HTTP_OIDC_GROUPIDS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;&lt;other_condition&gt;&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;me@example.com&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the user id and name are not specified in the mapping, the server tries to
directly map <code class="docutils literal"><span class="pre">REMOTE_USER</span></code> environment variable. If this variable is also
unavailable the server returns an HTTP 401 Unauthorized error.</p>
</div>
<p>Group ids and names can be provided in the local section:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;0cd5e9&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;developer_group&quot;</span><span class="p">,</span>
                <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;developer_group&quot;</span><span class="p">,</span>
                <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;private_cloud&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="output">
<h4>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h4>
<p>If a mapping is valid you will receive the following output:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;group_ids&quot;</span><span class="o">:</span> <span class="s2">&quot;[&lt;group-ids&gt;]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="o">:</span>
        <span class="p">{</span>
            <span class="s2">&quot;domain&quot;</span><span class="o">:</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;Federated&quot;</span> <span class="nx">or</span> <span class="s2">&quot;&lt;local-domain-id&gt;&quot;</span>
                <span class="p">},</span>
            <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;ephemeral&quot;</span> <span class="nx">or</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;local-user-name&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;local-user-id&gt;&quot;</span>
        <span class="p">},</span>
    <span class="s2">&quot;group_names&quot;</span><span class="o">:</span>
        <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;domain&quot;</span><span class="o">:</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;domain-name&gt;&quot;</span>
                    <span class="p">},</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;[&lt;groups-names&gt;]&quot;</span>
                    <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">{</span>
                <span class="s2">&quot;domain&quot;</span><span class="o">:</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;&lt;domain-name&gt;&quot;</span>
                    <span class="p">},</span>
                <span class="s2">&quot;name&quot;</span><span class="o">:</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;[&lt;groups-names&gt;]&quot;</span>
                    <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">type</span></code> parameter specifies the type of user being mapped. The 2 possible
user types are <code class="docutils literal"><span class="pre">local</span></code> and <code class="docutils literal"><span class="pre">ephemeral</span></code>.``local`` is displayed if the user
has a domain specified. The user is treated as existing in the backend, hence
the server will fetch user details (id, name, roles, groups).``ephemeral`` is
displayed for a user that does not exist in the backend.</p>
<p>The <code class="docutils literal"><span class="pre">id</span></code> parameter in the service domain specifies the domain a user belongs
to. <code class="docutils literal"><span class="pre">Federated</span></code> will be displayed if no domain is specified in the local rule.
User is deemed ephemeral and becomes a member of service domain named <code class="docutils literal"><span class="pre">Federated</span></code>.
If the domain is specified the local domain&#8217;s id will be displayed.
If the mapped user is local, mapping engine will discard further group
assigning and return set of roles configured for the user.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Domain <code class="docutils literal"><span class="pre">Federated</span></code> is a service domain - it cannot be listed, displayed,
added or deleted.  There is no need to perform any operation on it prior to
federation configuration.</p>
</div>
</div>
<div class="section" id="regular-expressions">
<h4>Regular Expressions<a class="headerlink" href="#regular-expressions" title="Permalink to this headline">¶</a></h4>
<p>Regular expressions can be used in a mapping by specifying the <code class="docutils literal"><span class="pre">regex</span></code> key, and
setting it to <code class="docutils literal"><span class="pre">true</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0cd5e9&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;HTTP_OIDC_GROUPIDS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;.*@yeah.com$&quot;</span>
                    <span class="p">]</span>
                    <span class="s2">&quot;regex&quot;</span><span class="o">:</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This allows any user with a claim containing a key with any value in
<code class="docutils literal"><span class="pre">HTTP_OIDC_GROUPIDS</span></code> to be mapped to group with id <code class="docutils literal"><span class="pre">0cd5e9</span></code>.</p>
</div>
<div class="section" id="condition-combinations">
<h4>Condition Combinations<a class="headerlink" href="#condition-combinations" title="Permalink to this headline">¶</a></h4>
<p>Combinations of mappings conditions can also be done.</p>
<p><code class="docutils literal"><span class="pre">empty</span></code>, <code class="docutils literal"><span class="pre">any_one_of</span></code>, and <code class="docutils literal"><span class="pre">not_any_of</span></code> can all be used in the same rule,
but cannot be repeated within the same condition. <code class="docutils literal"><span class="pre">any_one_of</span></code> and
<code class="docutils literal"><span class="pre">not_any_of</span></code> are mutually exclusive within a condition&#8217;s scope. So are
<code class="docutils literal"><span class="pre">whitelist</span></code> and <code class="docutils literal"><span class="pre">blacklist</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0cd5e9&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;cn=IBM_Canada_Lab&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;not_any_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;.*@naww.com$&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;regex&quot;</span><span class="o">:</span> <span class="kc">true</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;cn=IBM_USA_Lab&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;.*@yeah.com$&quot;</span>
                    <span class="p">]</span>
                    <span class="s2">&quot;regex&quot;</span><span class="o">:</span> <span class="kc">true</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As before group names and users can also be provided in the local section.</p>
<p>This allows any user with the following claim information to be mapped to
group with id 0cd5e9.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;UserName&quot;</span><span class="o">:</span><span class="s2">&quot;&lt;any_name&gt;@yeah.com&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;cn=IBM_USA_Lab&quot;</span><span class="o">:</span><span class="s2">&quot;&lt;any_name&gt;@yeah.com&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;cn=IBM_Canada_Lab&quot;</span><span class="o">:</span><span class="s2">&quot;&lt;any_name&gt;@yeah.com&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The following claims will be mapped:</p>
<ul class="simple">
<li>any claim containing the key UserName.</li>
<li>any claim containing key cn=IBM_Canada_Lab that doesn&#8217;t have the value &lt;any_name&gt;&#64;naww.com.</li>
<li>any claim containing key cn=IBM_USA_Lab that has value &lt;any_name&gt;&#64;yeah.com.</li>
</ul>
</div>
<div class="section" id="multiple-rules">
<h4>Multiple Rules<a class="headerlink" href="#multiple-rules" title="Permalink to this headline">¶</a></h4>
<p>Multiple rules can also be utilized in a mapping.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;non-contractors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;orgPersonType&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;not_any_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Contractor&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SubContractor&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;contractors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;orgPersonType&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Contractor&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SubContractor&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above assigns groups membership basing on <code class="docutils literal"><span class="pre">orgPersonType</span></code> values:</p>
<ul class="simple">
<li>neither <code class="docutils literal"><span class="pre">Contractor</span></code> nor <code class="docutils literal"><span class="pre">SubContractor</span></code> will belong to the <code class="docutils literal"><span class="pre">non-contractors</span></code> group.</li>
<li>either <code class="docutils literal"><span class="pre">Contractor</span> <span class="pre">or</span> <span class="pre">``SubContractor</span></code> will belong to the <code class="docutils literal"><span class="pre">contractors</span></code> group.</li>
</ul>
<p>Rules are additive, so permissions will only be granted for the rules that
succeed.  All the remote conditions of a rule must be valid.</p>
<p>When using multiple rules you can specify more than one effective user
identification, but only the first match will be considered and the others
ignored ordered from top to bottom.</p>
<p>Since rules are additive one can specify one user identification and this will
also work. The best practice for multiple rules is to create a rule for just
user and another rule for just groups. Below is rules example repeated but with
global username mapping.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserType&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;non-contractors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;orgPersonType&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;not_any_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Contractor&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SubContractor&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;contractors&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;orgPersonType&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Contractor&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SubContractor&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-provisioning">
<h4>Auto-Provisioning<a class="headerlink" href="#auto-provisioning" title="Permalink to this headline">¶</a></h4>
<p>The mapping engine has the ability to aid in the auto-provisioning of resources
when a federated user authenticates for the first time. This can be achieved
using a specific mapping syntax that the mapping engine can parse and
ultimately make decisions on.</p>
<p>For example, consider the following mapping:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;projects&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Production&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;observer&quot;</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Staging&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;member&quot;</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Project for {0}&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The semantics of the <code class="docutils literal"><span class="pre">remote</span></code> section have not changed. The difference
between this mapping and the other examples is the addition of a <code class="docutils literal"><span class="pre">projects</span></code>
section within the <code class="docutils literal"><span class="pre">local</span></code> rules. The <code class="docutils literal"><span class="pre">projects</span></code> list supplies a list
of projects that the federated user will be given access to. The projects
will be automatically created if they don&#8217;t exist when the user
authenticated and the mapping engine has applied values from the assertion
and mapped them into the <code class="docutils literal"><span class="pre">local</span></code> rules.</p>
<p>In the above example, an authenticated federated user will be granted the
<code class="docutils literal"><span class="pre">observer</span></code> role on the <code class="docutils literal"><span class="pre">Production</span></code> project, <code class="docutils literal"><span class="pre">member</span></code> role on the
<code class="docutils literal"><span class="pre">Staging</span></code> project, and they will have <code class="docutils literal"><span class="pre">admin</span></code> role on the <code class="docutils literal"><span class="pre">Project</span> <span class="pre">for</span>
<span class="pre">jsmith</span></code>.</p>
<p>It is important to note the following constraints apply when auto-provisioning:</p>
<ul class="simple">
<li>Projects are the only resource that will be created dynamically.</li>
<li>Projects will be created within the domain associated with the Identity
Provider.</li>
<li>The <code class="docutils literal"><span class="pre">projects</span></code> section of the mapping must also contain a <code class="docutils literal"><span class="pre">roles</span></code>
section.<ul>
<li>Roles within the project must already exist in the deployment or domain.</li>
</ul>
</li>
<li>Assignments are actually created for the user which is unlike the
ephemeral group memberships.</li>
</ul>
<p>Since the creation of roles typically requires policy changes across other
services in the deployment, it is expected that roles are created ahead of
time. Federated authentication should also be considered idempotent if the
attributes from the SAML assertion have not changed. In the example from above,
if the user&#8217;s name is still <code class="docutils literal"><span class="pre">jsmith</span></code>, then no new projects will be
created as a result of authentication.</p>
<p>Mappings can be created that mix <code class="docutils literal"><span class="pre">groups</span></code> and <code class="docutils literal"><span class="pre">projects</span></code> within the
<code class="docutils literal"><span class="pre">local</span></code> section. The mapping shown in the example above does not contain a
<code class="docutils literal"><span class="pre">groups</span></code> section in the <code class="docutils literal"><span class="pre">local</span></code> rules. This will result in the federated
user having direct role assignments on the projects in the <code class="docutils literal"><span class="pre">projects</span></code> list.
The following example contains <code class="docutils literal"><span class="pre">local</span></code> rules comprised of both <code class="docutils literal"><span class="pre">projects</span></code>
and <code class="docutils literal"><span class="pre">groups</span></code>, which allow for direct role assignments and group memberships.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;{0}&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;projects&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Marketing&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;member&quot;</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Development project for {0}&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Finance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;6fe767&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;UserName&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above example, a federated user will receive direct role assignments on
the <code class="docutils literal"><span class="pre">Marketing</span></code> project, as well as a dedicated project specific to the
federated user&#8217;s name. In addition to that, they will also be placed in the
<code class="docutils literal"><span class="pre">Finance</span></code> group and receive all role assignments that group has on projects
and domains.</p>
</div>
<div class="section" id="keystone-to-keystone">
<h4>keystone-to-keystone<a class="headerlink" href="#keystone-to-keystone" title="Permalink to this headline">¶</a></h4>
<p>keystone-to-keystone federation also utilizes mappings, but has some
differences.</p>
<p>An attribute file (e.g. <code class="docutils literal"><span class="pre">/etc/shibboleth/attribute-map.xml</span></code> in a Shibboleth
implementation) is used to add attributes to the mapping <cite>context</cite>. Attributes
look as follows:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- example from a K2k Shibboleth implementation --&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_user&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_user&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_user_domain&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_user_domain&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>The service provider must contain a mapping as shown below.
<code class="docutils literal"><span class="pre">openstack_user</span></code>, and <code class="docutils literal"><span class="pre">openstack_user_domain</span></code> match to the attribute
names we have in the Identity Provider. It will map any user with the name
<code class="docutils literal"><span class="pre">user1</span></code> or <code class="docutils literal"><span class="pre">admin</span></code> in the <code class="docutils literal"><span class="pre">openstack_user</span></code> attribute and
<code class="docutils literal"><span class="pre">openstack_domain</span></code> attribute <code class="docutils literal"><span class="pre">default</span></code> to a group with id <code class="docutils literal"><span class="pre">abc1234</span></code>.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;rules&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;local&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;group&quot;</span><span class="o">:</span> <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;abc1234&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;remote&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;openstack_user&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;user1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;admin&quot;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;openstack_user_domain&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;any_one_of&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Default&quot;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The possible attributes that can be used in a mapping are <cite>openstack_user</cite>,
<cite>openstack_user_domain</cite>, <cite>openstack_roles</cite>, <cite>openstack_project</cite>, and
<cite>openstack_project_domain</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>Setup OpenID Connect<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuring-mod-auth-openidc">
<h3>Configuring mod_auth_openidc<a class="headerlink" href="#configuring-mod-auth-openidc" title="Permalink to this headline">¶</a></h3>
<p>Federate Keystone (SP) and an external IdP using OpenID Connect (<a class="reference external" href="https://github.com/pingidentity/mod_auth_openidc">mod_auth_openidc</a>)</p>
<p>To install <cite>mod_auth_openidc</cite> on Ubuntu, perform the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install libapache2-mod-auth-openidc
</pre></div>
</div>
<p>This module is available for other distributions (Fedora/CentOS/Red Hat) from:
<a class="reference external" href="https://github.com/pingidentity/mod_auth_openidc/releases">https://github.com/pingidentity/mod_auth_openidc/releases</a></p>
<p>In the keystone Apache site file, add the following as a top level option, to
load the <cite>mod_auth_openidc</cite> module:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>LoadModule auth_openidc_module /usr/lib/apache2/modules/mod_auth_openidc.so
</pre></div>
</div>
<p>Also within the same file, locate the virtual host entry and add the following
entries for OpenID Connect:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;VirtualHost *:5000&gt;

    ...

    OIDCClaimPrefix &quot;OIDC-&quot;
    OIDCResponseType &quot;id_token&quot;
    OIDCScope &quot;openid email profile&quot;
    OIDCProviderMetadataURL &lt;url_of_provider_metadata&gt;
    OIDCClientID &lt;openid_client_id&gt;
    OIDCClientSecret &lt;openid_client_secret&gt;
    OIDCCryptoPassphrase openstack
    OIDCRedirectURI http://localhost:5000/v3/OS-FEDERATION/identity_providers/&lt;idp_id&gt;/protocols/oidc/auth/redirect

    &lt;LocationMatch /v3/OS-FEDERATION/identity_providers/.*?/protocols/oidc/auth&gt;
      AuthType openid-connect
      Require valid-user
      LogLevel debug
    &lt;/LocationMatch&gt;
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>Note an example of an <cite>OIDCProviderMetadataURL</cite> instance is: <a class="reference external" href="https://accounts.google.com/.well-known/openid-configuration">https://accounts.google.com/.well-known/openid-configuration</a>
If not using <cite>OIDCProviderMetadataURL</cite>, then the following attributes
must be specified: <cite>OIDCProviderIssuer</cite>, <cite>OIDCProviderAuthorizationEndpoint</cite>,
<cite>OIDCProviderTokenEndpoint</cite>, <cite>OIDCProviderTokenEndpointAuth</cite>,
<cite>OIDCProviderUserInfoEndpoint</cite>, and <cite>OIDCProviderJwksUri</cite></p>
<p>Note, if using a mod_wsgi version less than 4.3.0, then the <cite>OIDCClaimPrefix</cite>
must be specified to have only alphanumerics or a dash (&#8220;-&#8221;). This is because
mod_wsgi blocks headers that do not fit this criteria. See <a class="reference external" href="http://modwsgi.readthedocs.org/en/latest/release-notes/version-4.3.0.html#bugs-fixed">http://modwsgi.readthedocs.org/en/latest/release-notes/version-4.3.0.html#bugs-fixed</a>
for more details</p>
<p>Once you are done, restart your Apache daemon:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service apache2 restart
</pre></div>
</div>
</div>
<div class="section" id="tips">
<h3>Tips<a class="headerlink" href="#tips" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>When creating a mapping, note that the &#8216;remote&#8217; attributes will be prefixed,
with <cite>HTTP_</cite>, so for instance, if you set OIDCClaimPrefix to <cite>OIDC-</cite>, then a
typical remote value to check for is: <cite>HTTP_OIDC_ISS</cite>.</li>
<li>Don&#8217;t forget to add oidc as an [auth] plugin in keystone.conf, see
<a class="reference external" href="federated_identity.html#configure-authentication-drivers-in-keystone-conf">Configure authentication drivers in keystone.conf</a></li>
</ol>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id6">
<h2>Setup Mellon<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configure-apache-httpd-for-mod-auth-mellon">
<h3>Configure Apache HTTPD for mod_auth_mellon<a class="headerlink" href="#configure-apache-httpd-for-mod-auth-mellon" title="Permalink to this headline">¶</a></h3>
<p>Follow the steps outlined at: <a class="reference external" href="../apache-httpd.html">Running Keystone in HTTPD</a>.</p>
<p>You&#8217;ll also need to install the Apache module <a class="reference external" href="https://github.com/UNINETT/mod_auth_mellon">mod_auth_mellon</a>.  For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install libapache2-mod-auth-mellon
</pre></div>
</div>
<p>Configure your Keystone virtual host and adjust the config to properly handle SAML2 workflow:</p>
<p>Add this <em>WSGIScriptAlias</em> directive to your public vhost configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>WSGIScriptAliasMatch ^(/v3/OS-FEDERATION/identity_providers/.*?/protocols/.*?/auth)$ /usr/local/bin/keystone-wsgi-public/$1
</pre></div>
</div>
<p>Make sure the <em>wsgi-keystone.conf</em> contains a <em>&lt;Location&gt;</em> directive for the Mellon module and
a <em>&lt;Location&gt;</em> directive for each identity provider</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;Location /v3&gt;
    MellonEnable &quot;info&quot;
    MellonSPPrivateKeyFile /etc/httpd/mellon/http_keystone.fqdn.key
    MellonSPCertFile /etc/httpd/mellon/http_keystone.fqdn.cert
    MellonSPMetadataFile /etc/httpd/mellon/http_keystone.fqdn.xml
    MellonIdPMetadataFile /etc/httpd/mellon/idp-metadata.xml
    MellonEndpointPath /v3/OS-FEDERATION/identity_providers/idp_1/protocols/saml2/auth/mellon
    MellonIdP &quot;IDP&quot;
&lt;/Location&gt;

&lt;Location /v3/OS-FEDERATION/identity_providers/idp_1/protocols/saml2/auth&gt;
    AuthType &quot;Mellon&quot;
    MellonEnable &quot;auth&quot;
&lt;/Location&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>See below for information about how to generate the values for the
<cite>MellonSPMetadataFile</cite>, etc. directives.</li>
<li><code class="docutils literal"><span class="pre">saml2</span></code> may be different in your deployment, but do not use a wildcard value.
Otherwise <em>every</em> federated protocol will be handled by Mellon.</li>
<li><code class="docutils literal"><span class="pre">idp_1</span></code> has to be replaced with the name associated with the IdP in Keystone.</li>
<li>You are advised to carefully examine <a class="reference external" href="https://github.com/UNINETT/mod_auth_mellon">mod_auth_mellon Apache
configuration documentation</a></li>
</ul>
</div>
<p>Enable the Keystone virtual host, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ a2ensite wsgi-keystone.conf
</pre></div>
</div>
<p>Enable the <code class="docutils literal"><span class="pre">ssl</span></code> and <code class="docutils literal"><span class="pre">auth_mellon</span></code> modules, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ a2enmod ssl
$ a2enmod auth_mellon
</pre></div>
</div>
<p>Restart the Apache instance that is serving Keystone, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service apache2 restart
</pre></div>
</div>
</div>
<div class="section" id="configuring-the-mellon-sp-metadata">
<h3>Configuring the Mellon SP Metadata<a class="headerlink" href="#configuring-the-mellon-sp-metadata" title="Permalink to this headline">¶</a></h3>
<p>Mellon provides a script called <code class="docutils literal"><span class="pre">mellon_create_metadata.sh</span></code> which generates the
values for the config directives <cite>MellonSPPrivateKeyFile</cite>, <cite>MellonSPCertFile</cite>,
and <cite>MellonSPMetadataFile</cite>.  It is run like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mellon_create_metadata.sh http://keystone.fqdn:5000 <span class="se">\</span>
  http://keystone.fqdn:5000/v3/OS-FEDERATION/identity_providers/idp_1/protocols/saml2/auth/mellon
</pre></div>
</div>
<p>The first parameter is used as the entity ID, a unique identifier for this
Keystone SP.  You do not have to use the URL, but it is an easy way to uniquely
identify each Keystone SP.  The second parameter is the full URL for the
endpoint path corresponding to the parameter <cite>MellonEndpointPath</cite>.</p>
<p>Fetch your Service Provider&#8217;s Metadata file.  This corresponds to the value of
the <cite>MellonIdPMetadataFile</cite> directive above. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ wget --cacert /path/to/ca.crt -O /etc/httpd/mellon/idp-metadata.xml <span class="se">\</span>
  https://idp.fqdn/idp/saml2/metadata
</pre></div>
</div>
<p>Upload your Service Provider&#8217;s Metadata file to your Identity Provider.  This
is the file used as the value of the <cite>MellonSPMetadataFile</cite> in the config,
generated by the <cite>mellon_create_metadata.sh</cite> script.  The IdP may provide a
webpage where you can upload the file, or you may be required to submit the
file using <cite>wget</cite> or <cite>curl</cite>.  Please check your IdP documentation for details.</p>
<p>Once you are done, restart the Apache instance that is serving Keystone, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service apache2 restart
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="id7">
<h2>Setup Shibboleth<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configure-apache-httpd-for-mod-shibboleth">
<h3>Configure Apache HTTPD for mod_shibboleth<a class="headerlink" href="#configure-apache-httpd-for-mod-shibboleth" title="Permalink to this headline">¶</a></h3>
<p>Follow the steps outlined at: <a class="reference external" href="../apache-httpd.html">Running Keystone in HTTPD</a>.</p>
<p>You&#8217;ll also need to install <a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/Home">Shibboleth</a>, for
example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install libapache2-mod-shib2
</pre></div>
</div>
<p>Configure your Keystone virtual host and adjust the config to properly handle SAML2 workflow:</p>
<p>Add this <em>WSGIScriptAliasMatch</em> directive to your public vhost configuration:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>WSGIScriptAliasMatch ^(/v3/OS-FEDERATION/identity_providers/.*?/protocols/.*?/auth)$ /usr/local/bin/keystone-wsgi-public/$1
</pre></div>
</div>
<p>Make sure the <em>keystone.conf</em> vhost file contains a <em>&lt;Location&gt;</em> directive for the Shibboleth module and
a <em>&lt;Location&gt;</em> directive for each identity provider:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;Location /Shibboleth.sso&gt;
    SetHandler shib
&lt;/Location&gt;

&lt;Location /v3/OS-FEDERATION/identity_providers/myidp/protocols/mapped/auth&gt;
    ShibRequestSetting requireSession 1
    AuthType shibboleth
    ShibExportAssertion Off
    Require valid-user

    &lt;IfVersion &lt; 2.4&gt;
        ShibRequireSession On
        ShibRequireAll On
   &lt;/IfVersion&gt;
&lt;/Location&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li><code class="docutils literal"><span class="pre">mapped</span></code> is the name of the <a class="reference external" href="configure_federation.html#protocol">protocol that you will configure</a></li>
<li><code class="docutils literal"><span class="pre">myidp</span></code> is the name associated with the <a class="reference external" href="configure_federation.html#identity_provider">IdP in Keystone</a></li>
<li>The <code class="docutils literal"><span class="pre">ShibRequireSession</span></code> and <code class="docutils literal"><span class="pre">ShibRequireAll</span></code> rules are invalid in
Apache 2.4+.</li>
<li>You are advised to carefully examine <a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApacheConfig">Shibboleth Apache configuration
documentation</a></li>
</ul>
</div>
<p>Enable the <code class="docutils literal"><span class="pre">shib2</span></code> module, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ a2enmod shib2
</pre></div>
</div>
<p>Restart Apache, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service apache2 restart
</pre></div>
</div>
</div>
<div class="section" id="configuring-shibboleth2-xml">
<h3>Configuring shibboleth2.xml<a class="headerlink" href="#configuring-shibboleth2-xml" title="Permalink to this headline">¶</a></h3>
<p>Once you have your Keystone vhost (virtual host) ready, it&#8217;s then time to
configure Shibboleth and upload your Metadata to the Identity Provider.</p>
<p>Create a new keypair for Shibboleth with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ shib-keygen -y &lt;number of years&gt;
</pre></div>
</div>
<p>The newly created key file will be stored under <code class="docutils literal"><span class="pre">/etc/shibboleth/sp-key.pem</span></code>.</p>
<p>Configure your Service Provider by editing <code class="docutils literal"><span class="pre">/etc/shibboleth/shibboleth2.xml</span></code>
file. You will want to change five settings:</p>
<ul class="simple">
<li>Set the SP entity ID. This value usually has the form of a URI but it does not
have to resolve to anything. It must uniquely identify your Service Provider
to your Identity Provider.</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;ApplicationDefaults</span> <span class="na">entityID=</span><span class="s">&quot;http://mysp.example.com/shibboleth&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>Set the IdP entity ID. This value is determined by the IdP. For example, if
Keystone is the IdP:</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;SSO</span> <span class="na">entityID=</span><span class="s">&quot;https://myidp.example.com/v3/OS-FEDERATION/saml2/idp&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>Example if testshib.org is the IdP:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;SSO</span> <span class="na">entityID=</span><span class="s">&quot;https://idp.testshib.org/idp/shibboleth&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li>Remove the discoveryURL lines unless you want to enable advanced IdP discovery.</li>
<li>Add a MetadataProvider block. The URI given here is a real URL that Shibboleth
will use to fetch metadata from the IdP. For example, if Keystone is the IdP:</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;MetadataProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">uri=</span><span class="s">&quot;https://myidp.example.com:5000/v3/OS-FEDERATION/saml2/metadata&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>Example if testshib.org is the IdP:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;MetadataProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">uri=</span><span class="s">&quot;http://www.testshib.org/metadata/testshib-providers.xml&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>You are advised to examine <a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/Configuration">Shibboleth Service Provider Configuration documentation</a></p>
<p>The result should look like (The example shown below is for reference only, not
to be used in a production environment):</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;SPConfig</span> <span class="na">xmlns=</span><span class="s">&quot;urn:mace:shibboleth:2.0:native:sp:config&quot;</span>
    <span class="na">xmlns:conf=</span><span class="s">&quot;urn:mace:shibboleth:2.0:native:sp:config&quot;</span>
    <span class="na">xmlns:saml=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span>
    <span class="na">xmlns:samlp=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span>
    <span class="na">xmlns:md=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot;</span>
    <span class="na">clockSkew=</span><span class="s">&quot;180&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">    By default, in-memory StorageService, ReplayCache, ArtifactMap, and SessionCache</span>
<span class="c">    are used. See example-shibboleth2.xml for samples of explicitly configuring them.</span>
<span class="c">    --&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">    To customize behavior for specific resources on Apache, and to link vhosts or</span>
<span class="c">    resources to ApplicationOverride settings below, use web server options/commands.</span>
<span class="c">    See https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfigurationElements for help.</span>

<span class="c">    For examples with the RequestMap XML syntax instead, see the example-shibboleth2.xml</span>
<span class="c">    file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.</span>
<span class="c">    --&gt;</span>

    <span class="c">&lt;!-- The ApplicationDefaults element is where most of Shibboleth&#39;s SAML bits are defined. --&gt;</span>
    <span class="nt">&lt;ApplicationDefaults</span> <span class="na">entityID=</span><span class="s">&quot;https://mysp.example.com/shibboleth&quot;</span><span class="nt">&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">        Controls session lifetimes, address checks, cookie handling, and the protocol handlers.</span>
<span class="c">        You MUST supply an effectively unique handlerURL value for each of your applications.</span>
<span class="c">        The value defaults to /Shibboleth.sso, and should be a relative path, with the SP computing</span>
<span class="c">        a relative value based on the virtual host. Using handlerSSL=&quot;true&quot;, the default, will force</span>
<span class="c">        the protocol to be https. You should also set cookieProps to &quot;https&quot; for SSL-only sites.</span>
<span class="c">        Note that while we default checkAddress to &quot;false&quot;, this has a negative impact on the</span>
<span class="c">        security of your site. Stealing sessions via cookie theft is much easier with this disabled.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;Sessions</span> <span class="na">lifetime=</span><span class="s">&quot;28800&quot;</span> <span class="na">timeout=</span><span class="s">&quot;3600&quot;</span> <span class="na">relayState=</span><span class="s">&quot;ss:mem&quot;</span>
                  <span class="na">checkAddress=</span><span class="s">&quot;false&quot;</span> <span class="na">handlerSSL=</span><span class="s">&quot;false&quot;</span> <span class="na">cookieProps=</span><span class="s">&quot;http&quot;</span><span class="nt">&gt;</span>

            <span class="c">&lt;!--</span>
<span class="c">            Configures SSO for a default IdP. To allow for &gt;1 IdP, remove</span>
<span class="c">            entityID property and adjust discoveryURL to point to discovery service.</span>
<span class="c">            (Set discoveryProtocol to &quot;WAYF&quot; for legacy Shibboleth WAYF support.)</span>
<span class="c">            You can also override entityID on /Login query string, or in RequestMap/htaccess.</span>
<span class="c">            --&gt;</span>
            <span class="nt">&lt;SSO</span> <span class="na">entityID=</span><span class="s">&quot;https://myidp.example.com/v3/OS-FEDERATION/saml2/idp&quot;</span><span class="nt">&gt;</span>
              SAML2 SAML1
            <span class="nt">&lt;/SSO&gt;</span>

            <span class="c">&lt;!-- SAML and local-only logout. --&gt;</span>
            <span class="nt">&lt;Logout&gt;</span>SAML2 Local<span class="nt">&lt;/Logout&gt;</span>

            <span class="c">&lt;!-- Extension service that generates &quot;approximate&quot; metadata based on SP configuration. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;MetadataGenerator&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Metadata&quot;</span> <span class="na">signing=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Status reporting service. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;Status&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Status&quot;</span> <span class="na">acl=</span><span class="s">&quot;127.0.0.1 ::1&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Session diagnostic service. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;Session&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Session&quot;</span> <span class="na">showAttributeValues=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- JSON feed of discovery information. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;DiscoveryFeed&quot;</span> <span class="na">Location=</span><span class="s">&quot;/DiscoFeed&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Sessions&gt;</span>
        <span class="c">&lt;!--</span>
<span class="c">        Allows overriding of error template information/filenames. You can</span>
<span class="c">        also add attributes with values that can be plugged into the templates.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;Errors</span> <span class="na">supportContact=</span><span class="s">&quot;root@localhost&quot;</span>
            <span class="na">helpLocation=</span><span class="s">&quot;/about.html&quot;</span>
            <span class="na">styleSheet=</span><span class="s">&quot;/shibboleth-sp/main.css&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Example of remotely supplied batch of signed metadata. --&gt;</span>
        <span class="c">&lt;!--</span>
<span class="c">        &lt;MetadataProvider type=&quot;XML&quot; uri=&quot;http://federation.org/federation-metadata.xml&quot;</span>
<span class="c">              backingFilePath=&quot;federation-metadata.xml&quot; reloadInterval=&quot;7200&quot;&gt;</span>
<span class="c">            &lt;MetadataFilter type=&quot;RequireValidUntil&quot; maxValidityInterval=&quot;2419200&quot;/&gt;</span>
<span class="c">            &lt;MetadataFilter type=&quot;Signature&quot; certificate=&quot;fedsigner.pem&quot;/&gt;</span>
<span class="c">        &lt;/MetadataProvider&gt;</span>
<span class="c">        --&gt;</span>

        <span class="c">&lt;!-- Example of locally maintained metadata. --&gt;</span>
        <span class="c">&lt;!--</span>
<span class="c">        &lt;MetadataProvider type=&quot;XML&quot; file=&quot;partner-metadata.xml&quot;/&gt;</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;MetadataProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">uri=</span><span class="s">&quot;https://myidp.example.com:5000/v3/OS-FEDERATION/saml2/metadata&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Map to extract attributes from SAML assertions. --&gt;</span>
        <span class="nt">&lt;AttributeExtractor</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">reloadChanges=</span><span class="s">&quot;false&quot;</span> <span class="na">path=</span><span class="s">&quot;attribute-map.xml&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Use a SAML query if no attributes are supplied during SSO. --&gt;</span>
        <span class="nt">&lt;AttributeResolver</span> <span class="na">type=</span><span class="s">&quot;Query&quot;</span> <span class="na">subjectMatch=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Default filtering policy for recognized attributes, lets other data pass. --&gt;</span>
        <span class="nt">&lt;AttributeFilter</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">path=</span><span class="s">&quot;attribute-policy.xml&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Simple file-based resolver for using a single keypair. --&gt;</span>
        <span class="nt">&lt;CredentialResolver</span> <span class="na">type=</span><span class="s">&quot;File&quot;</span> <span class="na">key=</span><span class="s">&quot;sp-key.pem&quot;</span> <span class="na">certificate=</span><span class="s">&quot;sp-cert.pem&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">        The default settings can be overridden by creating ApplicationOverride elements (see</span>
<span class="c">        the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApplicationOverride topic).</span>
<span class="c">        Resource requests are mapped by web server commands, or the RequestMapper, to an</span>
<span class="c">        applicationId setting.</span>
<span class="c">        Example of a second application (for a second vhost) that has a different entityID.</span>
<span class="c">        Resources on the vhost would map to an applicationId of &quot;admin&quot;:</span>
<span class="c">        --&gt;</span>
        <span class="c">&lt;!--</span>
<span class="c">        &lt;ApplicationOverride id=&quot;admin&quot; entityID=&quot;https://admin.example.org/shibboleth&quot;/&gt;</span>
<span class="c">        --&gt;</span>
    <span class="nt">&lt;/ApplicationDefaults&gt;</span>

    <span class="c">&lt;!-- Policies that determine how to process and authenticate runtime messages. --&gt;</span>
    <span class="nt">&lt;SecurityPolicyProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">path=</span><span class="s">&quot;security-policy.xml&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Low-level configuration about protocols and bindings available for use. --&gt;</span>
    <span class="nt">&lt;ProtocolProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">reloadChanges=</span><span class="s">&quot;false&quot;</span> <span class="na">path=</span><span class="s">&quot;protocols.xml&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/SPConfig&gt;</span>
</pre></div>
</div>
<p>If keystone is your IdP, you will need to examine your attributes map file
<code class="docutils literal"><span class="pre">/etc/shibboleth/attribute-map.xml</span></code> and add the following attributes:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_user&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_user&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_roles&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_roles&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_project&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_project&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_user_domain&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_user_domain&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;openstack_project_domain&quot;</span> <span class="na">id=</span><span class="s">&quot;openstack_project_domain&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>For more information see the
<a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPAddAttribute">attributes documentation</a></p>
<p>Once you are done, restart your Shibboleth daemon and apache:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ service shibd restart
$ service apache2 restart
</pre></div>
</div>
<p>Check <code class="docutils literal"><span class="pre">/var/log/shibboleth/shibd_warn.log</span></code> for any ERROR or CRIT notices and
correct them.</p>
<p>Upload your Service Provider&#8217;s metadata file to your Identity Provider. You can
fetch it with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ wget http://mysp.example.com/Shibboleth.sso/Metadata
</pre></div>
</div>
<p>This step depends on your Identity Provider choice and is not covered here.
If keystone is your Identity Provider you do not need to upload this file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="setup-web-single-sign-on-sso">
<h2>Setup Web Single Sign-On (SSO)<a class="headerlink" href="#setup-web-single-sign-on-sso" title="Permalink to this headline">¶</a></h2>
<div class="section" id="keystone-changes">
<h3>Keystone Changes<a class="headerlink" href="#keystone-changes" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Update <cite>trusted_dashboard</cite> in keystone.conf.</li>
</ol>
<p>Specify URLs of trusted horizon servers. This value may be repeated
multiple times. This setting ensures that keystone only sends token data back
to trusted servers. This is performed as a precaution, specifically to
prevent man-in-the-middle (MITM) attacks.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[federation]</span>
<span class="na">trusted_dashboard</span> <span class="o">=</span> <span class="s">http://acme.horizon.com/auth/websso/</span>
<span class="na">trusted_dashboard</span> <span class="o">=</span> <span class="s">http://beta.horizon.com/auth/websso/</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Update httpd vhost file with websso information.</li>
</ol>
<p>The <cite>/v3/auth/OS-FEDERATION/websso/&lt;protocol&gt;</cite> and
<cite>/v3/auth/OS-FEDERATION/identity_providers/{idp_id}/protocols/{protocol_id}/websso</cite>
routes must be protected by the chosen httpd module. This is performed so the
request that originates from horizon will use the same identity provider that
is configured in keystone.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">By using the IdP specific route, a user will no longer leverage the Remote
ID of a specific Identity Provider, and will be unable to verify that the
Identity Provider is trusted, the mapping will remain as the only means to
controlling authorization.</p>
</div>
<p>If <cite>mod_shib</cite> is used, then use the following as an example:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;VirtualHost *:5000&gt;

    ...

    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/websso/mapped&quot;&gt;
      AuthType shibboleth
      Require valid-user
      ShibRequestSetting requireSession 1
      ShibRequireSession On
      ShibExportAssertion Off
    &lt;/Location&gt;
    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/identity_providers/myidp/protocols/mapped/websso&quot;&gt;
      AuthType shibboleth
      Require valid-user
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>If <cite>mod_auth_openidc</cite> is used, then use the following as an example:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;VirtualHost *:5000&gt;

    OIDCRedirectURI http://localhost:5000/v3/auth/OS-FEDERATION/websso/redirect
    OIDCRedirectURI http://localhost:5000/v3/auth/OS-FEDERATION/identity_providers/myidp/protocol/oidc/websso/redirect

    ...

    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/websso/oidc&quot;&gt;
      AuthType openid-connect
      Require valid-user
      ...
    &lt;/Location&gt;
    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/identity_providers/myidp/protocols/oidc/websso&quot;&gt;
      AuthType openid-connect
      Require valid-user
      ...
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>If <cite>mod_auth_kerb</cite> is used, then use the following as an example:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;VirtualHost *:5000&gt;

    ...

    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/websso/kerberos&quot;&gt;
      AuthType Kerberos
      AuthName &quot;Acme Corporation&quot;
      KrbMethodNegotiate on
      KrbMethodK5Passwd off
      Krb5Keytab /etc/apache2/http.keytab
      ...
    &lt;/Location&gt;
    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/identity_providers/myidp/protocols/kerberos/websso&quot;&gt;
      AuthType Kerberos
      AuthName &quot;Acme Corporation&quot;
      KrbMethodNegotiate on
      KrbMethodK5Passwd off
      Krb5Keytab /etc/apache2/http.keytab
      ...
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>If <cite>mod_auth_mellon</cite> is used, then use the following as an example:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>&lt;VirtualHost *:5000&gt;

    ...

    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/websso/mapped&quot;&gt;
      AuthType Mellon
      MellonEnable auth
      Require valid-user
      ...
    &lt;/Location&gt;
    &lt;Location ~ &quot;/v3/auth/OS-FEDERATION/identity_providers/myidp/protocols/mapped/websso&quot;&gt;
      AuthType Mellon
      MellonEnable auth
      Require valid-user
      ...
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are also using SSO via the API, don&#8217;t forget to make the Location
settings match your configuration used for the keystone identity provider
location:
<cite>/v3/OS-FEDERATION/identity_providers/&lt;idp&gt;/protocols/&lt;protocol&gt;/auth</cite></p>
</div>
<ol class="arabic simple" start="3">
<li>Update <cite>remote_id_attribute</cite> in keystone.conf.</li>
</ol>
<p>A remote id attribute indicates the header to retrieve from the WSGI
environment. This header contains information about the identity
of the identity provider. For <cite>mod_shib</cite> this would be
<code class="docutils literal"><span class="pre">Shib-Identity-Provider</span></code>, for <cite>mod_auth_openidc</cite>, this could be
<code class="docutils literal"><span class="pre">HTTP_OIDC_ISS</span></code>.  For <cite>mod_auth_mellon</cite>, this could be <code class="docutils literal"><span class="pre">MELLON_IDP</span></code>.</p>
<p>It is recommended that this option be set on a per-protocol basis.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[mapped]</span>
<span class="na">remote_id_attribute</span> <span class="o">=</span> <span class="s">Shib-Identity-Provider</span>
<span class="k">[oidc]</span>
<span class="na">remote_id_attribute</span> <span class="o">=</span> <span class="s">HTTP_OIDC_ISS</span>
</pre></div>
</div>
<p>Alternatively, a generic option may be set at the <cite>[federation]</cite> level.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[federation]</span>
<span class="na">remote_id_attribute</span> <span class="o">=</span> <span class="s">HTTP_OIDC_ISS</span>
</pre></div>
</div>
<p>4. Copy the <a class="reference external" href="https://git.openstack.org/cgit/openstack/keystone/plain/etc/sso_callback_template.html">sso_callback_template.html</a>
template into the location specified by <cite>[federation]/sso_callback_template</cite>.</p>
</div>
<div class="section" id="horizon-changes">
<h3>Horizon Changes<a class="headerlink" href="#horizon-changes" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Django OpenStack Auth version 1.2.0 or higher is required for these steps.</p>
<p class="last">Identity provider and federation protocol specific webSSO is only available
in Django OpenStack Auth version 2.0.0 or higher.</p>
</div>
<ol class="arabic simple">
<li>Set the <cite>WEBSSO_ENABLED</cite> option.</li>
</ol>
<p>Ensure the <cite>WEBSSO_ENABLED</cite> option is set to True in horizon&#8217;s local_settings.py file,
this will provide users with an updated login screen for horizon.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">WEBSSO_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>(Optional) Create a list of authentication methods with the
<cite>WEBSSO_CHOICES</cite> option.</li>
</ol>
<p>Within horizon&#8217;s settings.py file, a list of supported authentication methods can be
specified. The list includes Keystone federation protocols such as OpenID Connect and
SAML, and also keys that map to specific identity provider and federation protocol
combinations (as defined in <cite>WEBSSO_IDP_MAPPING</cite>). With the exception of <code class="docutils literal"><span class="pre">credentials</span></code>
which is reserved by horizon, and maps to the user name and password used by keystone&#8217;s
identity backend.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">WEBSSO_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
      <span class="p">(</span><span class="s2">&quot;credentials&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Keystone Credentials&quot;</span><span class="p">)),</span>
      <span class="p">(</span><span class="s2">&quot;oidc&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;OpenID Connect&quot;</span><span class="p">)),</span>
      <span class="p">(</span><span class="s2">&quot;mapped&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Security Assertion Markup Language&quot;</span><span class="p">)),</span>
      <span class="p">(</span><span class="s2">&quot;myidp_oidc&quot;</span><span class="p">,</span> <span class="s2">&quot;Acme Corporation - OpenID Connect&quot;</span><span class="p">),</span>
      <span class="p">(</span><span class="s2">&quot;myidp_mapped&quot;</span><span class="p">,</span> <span class="s2">&quot;Acme Corporation - SAML2&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>(Optional) Create a dictionary of specific identity provider and federation
protocol combinations.</li>
</ol>
<p>A dictionary of specific identity provider and federation protocol combinations.
From the selected authentication mechanism, the value will be looked up as keys
in the dictionary. If a match is found, it will redirect the user to a identity
provider and federation protocol specific WebSSO endpoint in keystone, otherwise
it will use the value as the protocol_id when redirecting to the WebSSO by
protocol endpoint.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">WEBSSO_IDP_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;myidp_oidc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;myidp&quot;</span><span class="p">,</span> <span class="s2">&quot;oidc&quot;</span><span class="p">),</span>
      <span class="s2">&quot;myidp_mapped&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;myidp&quot;</span><span class="p">,</span> <span class="s2">&quot;mapped&quot;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The value is expected to be a tuple formatted as: (&lt;idp_id&gt;, &lt;protocol_id&gt;).</p>
</div>
<ol class="arabic simple" start="6">
<li>(Optional) Specify an initial choice with the <cite>WEBSSO_INITIAL_CHOICE</cite>
option.</li>
</ol>
<p>The list set by the <cite>WEBSSO_CHOICES</cite> option will be generated in a drop-down
menu in the login screen. The setting <cite>WEBSSO_INITIAL_CHOICE</cite> will
automatically set that choice to be highlighted by default.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">WEBSSO_INITIAL_CHOICE</span> <span class="o">=</span> <span class="s2">&quot;credentials&quot;</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Federated Identity</a><ul>
<li><a class="reference internal" href="#configuring-keystone-for-federation">Configuring Keystone for Federation</a><ul>
<li><a class="reference internal" href="#definitions">Definitions</a></li>
<li><a class="reference internal" href="#keystone-as-a-service-provider-sp">Keystone as a Service Provider (SP)</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li><a class="reference internal" href="#configure-apache-to-use-a-federation-capable-authentication-method">Configure Apache to use a federation capable authentication method</a></li>
<li><a class="reference internal" href="#configure-keystone-and-horizon-for-single-sign-on">Configure keystone and Horizon for Single Sign-On</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configure-federation-in-keystone">Configure Federation in Keystone</a><ul>
<li><a class="reference internal" href="#configure-authentication-drivers-in-keystone-conf">Configure authentication drivers in keystone.conf</a></li>
<li><a class="reference internal" href="#create-keystone-groups-and-assign-roles">Create keystone groups and assign roles</a></li>
<li><a class="reference internal" href="#add-identity-provider-s-mapping-s-and-protocol-s">Add Identity Provider(s), Mapping(s), and Protocol(s)</a><ul>
<li><a class="reference internal" href="#identity-provider">Identity Provider</a></li>
<li><a class="reference internal" href="#mapping">Mapping</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performing-federated-authentication">Performing federated authentication</a><ul>
<li><a class="reference internal" href="#get-an-unscoped-token">Get an unscoped token</a><ul>
<li><a class="reference internal" href="#example-curl">Example cURL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#determine-accessible-resources">Determine accessible resources</a><ul>
<li><a class="reference internal" href="#id1">Example cURL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-a-scoped-token">Get a scoped token</a><ul>
<li><a class="reference internal" href="#id2">Example cURL</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#keystone-as-an-identity-provider-idp">Keystone as an Identity Provider (IdP)</a><ul>
<li><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li><a class="reference internal" href="#generate-metadata">Generate Metadata</a></li>
<li><a class="reference internal" href="#create-a-service-provider-sp">Create a Service Provider (SP)</a></li>
<li><a class="reference internal" href="#testing-it-all-out">Testing it all out</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#mapping-combinations">Mapping Combinations</a><ul>
<li><a class="reference internal" href="#description">Description</a></li>
<li><a class="reference internal" href="#id3">Definitions</a></li>
<li><a class="reference internal" href="#how-mappings-are-processed">How Mappings Are Processed</a></li>
<li><a class="reference internal" href="#mapping-rules">Mapping Rules</a><ul>
<li><a class="reference internal" href="#mapping-engine">Mapping Engine</a></li>
<li><a class="reference internal" href="#mapping-conditions">Mapping Conditions</a></li>
<li><a class="reference internal" href="#mappings-examples">Mappings Examples</a><ul>
<li><a class="reference internal" href="#empty-condition">empty condition</a></li>
<li><a class="reference internal" href="#other-conditions">other conditions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#output">Output</a></li>
<li><a class="reference internal" href="#regular-expressions">Regular Expressions</a></li>
<li><a class="reference internal" href="#condition-combinations">Condition Combinations</a></li>
<li><a class="reference internal" href="#multiple-rules">Multiple Rules</a></li>
<li><a class="reference internal" href="#auto-provisioning">Auto-Provisioning</a></li>
<li><a class="reference internal" href="#keystone-to-keystone">keystone-to-keystone</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id4">Setup OpenID Connect</a><ul>
<li><a class="reference internal" href="#configuring-mod-auth-openidc">Configuring mod_auth_openidc</a></li>
<li><a class="reference internal" href="#tips">Tips</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">Setup Mellon</a><ul>
<li><a class="reference internal" href="#configure-apache-httpd-for-mod-auth-mellon">Configure Apache HTTPD for mod_auth_mellon</a></li>
<li><a class="reference internal" href="#configuring-the-mellon-sp-metadata">Configuring the Mellon SP Metadata</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">Setup Shibboleth</a><ul>
<li><a class="reference internal" href="#configure-apache-httpd-for-mod-shibboleth">Configure Apache HTTPD for mod_shibboleth</a></li>
<li><a class="reference internal" href="#configuring-shibboleth2-xml">Configuring shibboleth2.xml</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setup-web-single-sign-on-sso">Setup Web Single Sign-On (SSO)</a><ul>
<li><a class="reference internal" href="#keystone-changes">Keystone Changes</a></li>
<li><a class="reference internal" href="#horizon-changes">Horizon Changes</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="../configuration.html"
                                  title="previous chapter">Configuring Keystone</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="../configure_tokenless_x509.html"
                                  title="next chapter">Configuring Keystone for Tokenless Authorization</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/keystone
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/federation/federated_identity.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../configure_tokenless_x509.html" title="Configuring Keystone for Tokenless Authorization"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../configuration.html" title="Configuring Keystone"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">keystone 11.0.0.0rc2.dev29 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012, OpenStack Foundation.
      Last updated on &#39;Fri Feb 10 22:47:54 2017, commit 9c47495&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/keystone");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>