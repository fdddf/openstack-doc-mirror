<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuring Keystone for Federation &mdash; keystone 11.0.0.0rc2.dev29 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '11.0.0.0rc2.dev29',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="keystone 11.0.0.0rc2.dev29 documentation" href="../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuring-keystone-for-federation">
<h1>Configuring Keystone for Federation<a class="headerlink" href="#configuring-keystone-for-federation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="definitions">
<h2>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><cite>Service Provider (SP)</cite>: provides a service to an end-user.</li>
<li><cite>Identity Provider (IdP)</cite>: service that stores information about users and
groups.</li>
<li><cite>SAML assertion</cite>: contains information about a user as provided by an IdP.</li>
</ul>
</div>
<div class="section" id="keystone-as-a-service-provider-sp">
<h2>Keystone as a Service Provider (SP)<a class="headerlink" href="#keystone-as-a-service-provider-sp" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is considered stable and supported as of the Juno release.</p>
</div>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>This approach to federation supports keystone as a Service Provider, consuming
identity properties issued by an external Identity Provider, such as SAML
assertions or OpenID Connect claims, or by using
<a class="reference internal" href="#keystone-as-an-identity-provider-idp">Keystone as an Identity Provider (IdP)</a>.</p>
<p>Federated users are not mirrored in the keystone identity backend
(for example, using the SQL driver). The external Identity Provider is
responsible for authenticating users, and communicates the result of
authentication to keystone using identity properties. Keystone maps these
values to keystone user groups and assignments created in keystone.</p>
<p>The following configuration steps were performed on a machine running
Ubuntu 14.04 and Apache 2.4.7.</p>
<p>To enable federation, you&#8217;ll need to:</p>
<ol class="arabic simple">
<li><a class="reference external" href="../apache-httpd.html">Run keystone under Apache</a>, rather than using uwsgi command.</li>
<li><a class="reference internal" href="#configure-apache-to-use-a-federation-capable-authentication-method">Configure Apache to use a federation capable authentication method</a>.</li>
<li><a class="reference internal" href="#configure-federation-in-keystone">Configure Federation in Keystone</a>.</li>
</ol>
<div class="section" id="configure-apache-to-use-a-federation-capable-authentication-method">
<h4>Configure Apache to use a federation capable authentication method<a class="headerlink" href="#configure-apache-to-use-a-federation-capable-authentication-method" title="Permalink to this headline">¶</a></h4>
<p>There is currently support for two major federation protocols:</p>
<ul class="simple">
<li>SAML - Keystone supports the following implementations:<ul>
<li>Shibboleth - see <a class="reference external" href="shibboleth.html">Setup Shibboleth</a>.</li>
<li>Mellon - see <a class="reference external" href="mellon.html">Setup Mellon</a>.</li>
</ul>
</li>
<li>OpenID Connect - see <a class="reference external" href="openidc.html">Setup OpenID Connect</a>.</li>
</ul>
</div>
<div class="section" id="configure-keystone-and-horizon-for-single-sign-on">
<h4>Configure keystone and Horizon for Single Sign-On<a class="headerlink" href="#configure-keystone-and-horizon-for-single-sign-on" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>To configure horizon to access a federated keystone,
follow the steps outlined at: <a class="reference external" href="websso.html">Keystone Federation and Horizon</a>.</li>
</ul>
</div>
</div>
<div class="section" id="configure-federation-in-keystone">
<h3>Configure Federation in Keystone<a class="headerlink" href="#configure-federation-in-keystone" title="Permalink to this headline">¶</a></h3>
<p>Now that the Identity Provider and keystone are communicating we can start to
configure <code class="docutils literal"><span class="pre">federation</span></code>.</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#configure-authentication-drivers-in-keystone-conf">Configure authentication drivers in keystone.conf</a></li>
<li><a class="reference internal" href="#create-keystone-groups-and-assign-roles">Create keystone groups and assign roles</a></li>
<li><a class="reference internal" href="#add-identity-provider-s-mapping-s-and-protocol-s">Add Identity Provider(s), Mapping(s), and Protocol(s)</a></li>
</ol>
<div class="section" id="configure-authentication-drivers-in-keystone-conf">
<h4>Configure authentication drivers in keystone.conf<a class="headerlink" href="#configure-authentication-drivers-in-keystone-conf" title="Permalink to this headline">¶</a></h4>
<p>Add the authentication methods to the <code class="docutils literal"><span class="pre">[auth]</span></code> section in <code class="docutils literal"><span class="pre">keystone.conf</span></code>.
Names should be equal to protocol names added via Identity API v3. Here we use
examples <code class="docutils literal"><span class="pre">mapped</span></code> and <code class="docutils literal"><span class="pre">openid</span></code>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">[</span>auth<span class="o">]</span>
<span class="nv">methods</span> <span class="o">=</span> external,password,token,mapped,openid
</pre></div>
</div>
</div>
<div class="section" id="create-keystone-groups-and-assign-roles">
<h4>Create keystone groups and assign roles<a class="headerlink" href="#create-keystone-groups-and-assign-roles" title="Permalink to this headline">¶</a></h4>
<p>As mentioned earlier, no new users will be added to the Identity backend, but
the Identity Service requires group-based role assignments to authorize
federated users. The federation mapping function will map the user into local
Identity Service groups objects, and hence to local role assignments.</p>
<p>Thus, it is required to create the necessary Identity Service groups that
correspond to the Identity Provider&#8217;s groups; additionally, these groups should
be assigned roles on one or more projects or domains.</p>
<p>You may be interested in more information on <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3/#create-group">group management</a>
and <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3/#assign-role-to-group-on-project">role assignments</a>,
both of which are exposed to the CLI via <a class="reference external" href="https://pypi.python.org/pypi/python-openstackclient/">python-openstackclient</a>.</p>
<p>For example, create a new domain and project like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack domain create federated_domain
$ openstack project create federated_project --domain federated_domain
</pre></div>
</div>
<p>And a new group like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack group create federated_users
</pre></div>
</div>
<p>Add the group to the domain and project:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack role add --group federated_users --domain federated_domain Member
$ openstack role add --group federated_users --project federated_project Member
</pre></div>
</div>
<p>We&#8217;ll later add a mapping that makes all federated users a part of this group
and therefore members of the new domain.</p>
</div>
<div class="section" id="add-identity-provider-s-mapping-s-and-protocol-s">
<h4>Add Identity Provider(s), Mapping(s), and Protocol(s)<a class="headerlink" href="#add-identity-provider-s-mapping-s-and-protocol-s" title="Permalink to this headline">¶</a></h4>
<p>To utilize federation the following must be created in the Identity Service:</p>
<ul class="simple">
<li><a class="reference internal" href="#identity-provider">Identity Provider</a></li>
<li><a class="reference internal" href="#mapping">Mapping</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a></li>
</ul>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#os-federation-api">federation in keystone</a>.</p>
<div class="section" id="identity-provider">
<h5>Identity Provider<a class="headerlink" href="#identity-provider" title="Permalink to this headline">¶</a></h5>
<p>Create an Identity Provider object in keystone, which represents the Identity
Provider we will use to authenticate end users:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack identity provider create --remote-id https://myidp.example.com/v3/OS-FEDERATION/saml2/idp myidp
</pre></div>
</div>
<p>The value for the <code class="docutils literal"><span class="pre">remote-id</span></code> option is the Entity ID provided by the IdP. It
is the same value that you set for the SSO entityID in /etc/shibboleth/shibboleth2.xml.
If the IdP is a Keystone IdP, it is the value set in that Keystone&#8217;s
<code class="docutils literal"><span class="pre">[saml]/idp_entity_id</span></code> option. It will usually appear as a URI but there
is no requirement for it to resolve to anything and may be arbitrarily decided
by the administrator of the IdP. The local name, here called &#8216;myidp&#8217;, is
decided by you and will be used by the mapping and protocol, and later for
authentication.</p>
<p>A keystone identity provider may have multiple <cite>remote_ids</cite> specified, this
allows the same <em>keystone</em> identity provider resource to be used with multiple
external identity providers. For example, an identity provider resource
<code class="docutils literal"><span class="pre">university-idp</span></code>, may have the following <cite>remote_ids</cite>:
<code class="docutils literal"><span class="pre">['university-x',</span> <span class="pre">'university-y',</span> <span class="pre">'university-z']</span></code>.
This removes the need to configure N identity providers in keystone.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Remote IDs are globally unique. Two identity providers cannot be
associated with the same remote ID. Once authenticated with the external
identity provider, keystone will determine which identity provider
and mapping to use based on the protocol and the value returned from the
<cite>remote_id_attribute</cite> key.</p>
<p>For example, if our identity provider is <code class="docutils literal"><span class="pre">google</span></code>, the mapping used is
<code class="docutils literal"><span class="pre">google_mapping</span></code> and the protocol is <code class="docutils literal"><span class="pre">oidc</span></code>. The identity provider&#8217;s
remote IDs  would be: [<code class="docutils literal"><span class="pre">accounts.google.com</span></code>].
The <cite>remote_id_attribute</cite> value may be set to <code class="docutils literal"><span class="pre">HTTP_OIDC_ISS</span></code>, since
this value will always be <code class="docutils literal"><span class="pre">accounts.google.com</span></code>.</p>
<p class="last">The motivation for this approach is that there will always be some data
sent by the identity provider (in the assertion or claim) that uniquely
identifies the identity provider. This removes the requirement for horizon
to list all the identity providers that are trusted by keystone.</p>
</div>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#identity-providers">identity providers</a>.</p>
</div>
<div class="section" id="mapping">
<h5>Mapping<a class="headerlink" href="#mapping" title="Permalink to this headline">¶</a></h5>
<p>A mapping is a list of rules. The only Identity API objects that will support mapping are groups
and users.</p>
<p>Mapping adds a set of rules to map federation protocol attributes to Identity API objects.
There are many different ways to setup as well as combine these rules. More information on
rules can be found on the <a class="reference internal" href="mapping_combinations.html"><em>Mapping Combinations</em></a> page.</p>
<p>An Identity Provider has exactly one mapping specified per protocol.
Mapping objects can be used multiple times by different combinations of Identity Provider and Protocol.</p>
<p>As a simple example, if keystone is your IdP, you can map a few known remote
users to the group you already created:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat &gt; rules.json <span class="s">&lt;&lt;EOF</span>
<span class="s">[</span>
<span class="s">    {</span>
<span class="s">        &quot;local&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;user&quot;: {</span>
<span class="s">                    &quot;name&quot;: &quot;{0}&quot;</span>
<span class="s">                },</span>
<span class="s">                &quot;group&quot;: {</span>
<span class="s">                    &quot;domain&quot;: {</span>
<span class="s">                        &quot;name&quot;: &quot;Default&quot;</span>
<span class="s">                    },</span>
<span class="s">                    &quot;name&quot;: &quot;federated_users&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        ],</span>
<span class="s">        &quot;remote&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;type&quot;: &quot;openstack_user&quot;,</span>
<span class="s">                &quot;any_one_of&quot;: [</span>
<span class="s">                    &quot;demo&quot;,</span>
<span class="s">                    &quot;alt_demo&quot;</span>
<span class="s">                ]</span>
<span class="s">            }</span>
<span class="s">        ]</span>
<span class="s">    }</span>
<span class="s">]</span>
<span class="s">EOF</span>
$ openstack mapping create --rules rules.json myidp_mapping
</pre></div>
</div>
<p>As another example, if Shibboleth is your IdP, the remote section should use REMOTE_USER as the remote type:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat &gt; rules.json <span class="s">&lt;&lt;EOF</span>
<span class="s">[</span>
<span class="s">    {</span>
<span class="s">        &quot;local&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;user&quot;: {</span>
<span class="s">                    &quot;name&quot;: &quot;{0}&quot;</span>
<span class="s">                },</span>
<span class="s">                &quot;group&quot;: {</span>
<span class="s">                    &quot;domain&quot;: {</span>
<span class="s">                        &quot;name&quot;: &quot;Default&quot;</span>
<span class="s">                    },</span>
<span class="s">                    &quot;name&quot;: &quot;federated_users&quot;</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        ],</span>
<span class="s">        &quot;remote&quot;: [</span>
<span class="s">            {</span>
<span class="s">                &quot;type&quot;: &quot;REMOTE_USER&quot;</span>
<span class="s">            }</span>
<span class="s">        ]</span>
<span class="s">    }</span>
<span class="s">]</span>
<span class="s">EOF</span>
$ openstack mapping create --rules rules.json myidp_mapping
</pre></div>
</div>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#mappings">mapping</a>.</p>
</div>
<div class="section" id="protocol">
<h5>Protocol<a class="headerlink" href="#protocol" title="Permalink to this headline">¶</a></h5>
<p>A protocol contains information that dictates which Mapping rules to use for an incoming
request made by an IdP. An IdP may have multiple supported protocols.</p>
<p>You can create a protocol like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack federation protocol create mapped --mapping myidp_mapping --identity-provider myidp
</pre></div>
</div>
<p>The name you give the protocol is not arbitrary. It must match the method name
you gave in the <code class="docutils literal"><span class="pre">[auth]/methods</span></code> config option. When authenticating it will be
referred to as the <code class="docutils literal"><span class="pre">protocol_id</span></code>.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#protocols">federation protocols</a></p>
</div>
</div>
</div>
<div class="section" id="performing-federated-authentication">
<h3>Performing federated authentication<a class="headerlink" href="#performing-federated-authentication" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Authentication with keystone-to-keystone federation does not follow these steps.
See <a class="reference internal" href="#testing-it-all-out">Testing it all out</a> to authenticate with keystone-to-keystone.</p>
</div>
<ol class="arabic simple">
<li>Authenticate externally and generate an unscoped token in keystone</li>
<li>Determine accessible resources</li>
<li>Get a scoped token</li>
</ol>
<div class="section" id="get-an-unscoped-token">
<h4>Get an unscoped token<a class="headerlink" href="#get-an-unscoped-token" title="Permalink to this headline">¶</a></h4>
<p>Unlike other authentication methods in the Identity Service, the user does not
issue an HTTP POST request with authentication data in the request body. To
start federated authentication a user must access the dedicated URL with
Identity Provider&#8217;s and Protocol&#8217;s identifiers stored within a protected URL.
The URL has a format of:
<code class="docutils literal"><span class="pre">/v3/OS-FEDERATION/identity_providers/{idp_id}/protocols/{protocol_id}/auth</span></code>.</p>
<p>In this instance we follow a standard SAML2 authentication procedure, that is,
the user will be redirected to the Identity Provider&#8217;s authentication webpage
and be prompted for credentials. After successfully authenticating the user
will be redirected to the Service Provider&#8217;s endpoint. If using a web browser,
a token will be returned in JSON format, with the ID in the X-Subject-Token
header.</p>
<p>In the returned unscoped token, a list of Identity Service groups the user
belongs to will be included.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#request-an-unscoped-os-federation-token">getting an unscoped token</a>.</p>
<div class="section" id="example-curl">
<h5>Example cURL<a class="headerlink" href="#example-curl" title="Permalink to this headline">¶</a></h5>
<p>Note that the request does not include a body. The following url would be
considered protected by <code class="docutils literal"><span class="pre">mod_shib</span></code> and Apache, as such a request made
to the URL would be redirected to the Identity Provider, to start the
SAML authentication procedure.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -D - http://localhost:5000/v3/OS-FEDERATION/identity_providers/<span class="o">{</span>idp_id<span class="o">}</span>/protocols/<span class="o">{</span>protocol_id<span class="o">}</span>/auth
</pre></div>
</div>
</div>
</div>
<div class="section" id="determine-accessible-resources">
<h4>Determine accessible resources<a class="headerlink" href="#determine-accessible-resources" title="Permalink to this headline">¶</a></h4>
<p>By using the previously returned token, the user can issue requests to the list
projects and domains that are accessible.</p>
<ul class="simple">
<li>List projects a federated user can access: <code class="docutils literal"><span class="pre">GET</span> <span class="pre">/OS-FEDERATION/projects</span></code></li>
<li>List domains a federated user can access: <code class="docutils literal"><span class="pre">GET</span> <span class="pre">/OS-FEDERATION/domains</span></code></li>
</ul>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#list-projects-a-federated-user-can-access">listing resources</a>.</p>
<div class="section" id="id1">
<h5>Example cURL<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -H <span class="s2">&quot;X-Auth-Token: &lt;unscoped token&gt;&quot;</span> http://localhost:5000/v3/OS-FEDERATION/projects
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X GET -H <span class="s2">&quot;X-Auth-Token: &lt;unscoped token&gt;&quot;</span> http://localhost:5000/v3/OS-FEDERATION/domains
</pre></div>
</div>
</div>
</div>
<div class="section" id="get-a-scoped-token">
<h4>Get a scoped token<a class="headerlink" href="#get-a-scoped-token" title="Permalink to this headline">¶</a></h4>
<p>A federated user may request a scoped token, by using the unscoped token. A
project or domain may be specified by either <code class="docutils literal"><span class="pre">id</span></code> or <code class="docutils literal"><span class="pre">name</span></code>. An <code class="docutils literal"><span class="pre">id</span></code> is
sufficient to uniquely identify a project or domain.</p>
<p>Read more about <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#request-a-scoped-os-federation-token">getting a scoped token</a>.</p>
<div class="section" id="id2">
<h5>Example cURL<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ curl -X POST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -d <span class="s1">&#39;{&quot;auth&quot;:{&quot;identity&quot;:{&quot;methods&quot;:[&quot;mapped&quot;],&quot;mapped&quot;:{&quot;id&quot;:&quot;&lt;unscoped_token_id&gt;&quot;}},&quot;scope&quot;:{&quot;project&quot;:{&quot;domain&quot;: {&quot;name&quot;: &quot;federated_domain&quot;},&quot;name&quot;:&quot;federated_project&quot;}}}}&#39;</span> -D - http://localhost:5000/v3/auth/tokens
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="keystone-as-an-identity-provider-idp">
<h2>Keystone as an Identity Provider (IdP)<a class="headerlink" href="#keystone-as-an-identity-provider-idp" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is experimental and unsupported in Juno (with several issues
that will not be backported). These issues have been fixed and this feature
is considered stable and supported as of the Kilo release.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This feature requires installation of the xmlsec1 tool via your
distribution packaging system (for instance apt or yum)</p>
<p>Example for apt:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>$ apt-get install xmlsec1
</pre></div>
</div>
</div>
<div class="section" id="configuration-options">
<h3>Configuration Options<a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h3>
<p>There are certain settings in <code class="docutils literal"><span class="pre">keystone.conf</span></code> that must be setup, prior to
attempting to federate multiple keystone deployments.</p>
<p>Within <code class="docutils literal"><span class="pre">keystone.conf</span></code>, assign values to the <code class="docutils literal"><span class="pre">[saml]</span></code> related fields, for
example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[saml]</span>
<span class="na">idp_entity_id</span><span class="o">=</span><span class="s">https://myidp.example.com/v3/OS-FEDERATION/saml2/idp</span>
<span class="na">idp_sso_endpoint</span><span class="o">=</span><span class="s">https://myidp.example.com/v3/OS-FEDERATION/saml2/sso</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">idp_entity_id</span></code> is the unique identifier for the Identity Provider. It
usually takes the form of a URI but it does not have to resolve to anything.
<code class="docutils literal"><span class="pre">idp_sso_endpoint</span></code> is required to generate valid metadata but its value is
not important, though it may be in the future.</p>
<p>Note the <code class="docutils literal"><span class="pre">certfile</span></code>, <code class="docutils literal"><span class="pre">keyfile</span></code>, and <code class="docutils literal"><span class="pre">idp_metadata_path</span></code> settings and adjust them if
necessary:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">certfile</span><span class="o">=</span><span class="s">/etc/keystone/ssl/certs/signing_cert.pem</span>
<span class="na">keyfile</span><span class="o">=</span><span class="s">/etc/keystone/ssl/private/signing_key.pem</span>
<span class="na">idp_metadata_path</span><span class="o">=</span><span class="s">/etc/keystone/saml2_idp_metadata.xml</span>
</pre></div>
</div>
<p>Though not necessary, the follow Organization configuration options should
also be setup. It is recommended that these values be URL safe.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">idp_organization_name</span><span class="o">=</span><span class="s">example_company</span>
<span class="na">idp_organization_display_name</span><span class="o">=</span><span class="s">Example Corp.</span>
<span class="na">idp_organization_url</span><span class="o">=</span><span class="s">example.com</span>
</pre></div>
</div>
<p>As with the Organization options, the Contact options, are not necessary, but
it&#8217;s advisable to set these values too.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">idp_contact_company</span><span class="o">=</span><span class="s">example_company</span>
<span class="na">idp_contact_name</span><span class="o">=</span><span class="s">John</span>
<span class="na">idp_contact_surname</span><span class="o">=</span><span class="s">Smith</span>
<span class="na">idp_contact_email</span><span class="o">=</span><span class="s">jsmith@example.com</span>
<span class="na">idp_contact_telephone</span><span class="o">=</span><span class="s">555-555-5555</span>
<span class="na">idp_contact_type</span><span class="o">=</span><span class="s">technical</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-metadata">
<h3>Generate Metadata<a class="headerlink" href="#generate-metadata" title="Permalink to this headline">¶</a></h3>
<p>In order to create a trust between the IdP and SP, metadata must be exchanged.</p>
<p>First, if you haven&#8217;t already generated a PKI key pair, you need to do so and
copy those files the locations designated by <code class="docutils literal"><span class="pre">certfile</span></code> and <code class="docutils literal"><span class="pre">keyfile</span></code>
options that were assigned in the previous section. Ensure that your apache
vhost has SSL enabled and is using that keypair by adding the following to the
vhost:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>SSLEngine on
SSLCertificateFile /etc/keystone/ssl/certs/signing_cert.pem
SSLCertificateKeyFile /etc/keystone/ssl/private/signing_key.pem
</pre></div>
</div>
<p>To create metadata for your keystone IdP, run the <code class="docutils literal"><span class="pre">keystone-manage</span></code> command
and redirect the output to a file. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage saml_idp_metadata &gt; /etc/keystone/saml2_idp_metadata.xml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The file location should match the value of the configuration option
<code class="docutils literal"><span class="pre">idp_metadata_path</span></code> that was assigned in the previous section.</p>
</div>
<p>Finally, restart apache.</p>
</div>
<div class="section" id="create-a-service-provider-sp">
<h3>Create a Service Provider (SP)<a class="headerlink" href="#create-a-service-provider-sp" title="Permalink to this headline">¶</a></h3>
<p>In this example we are creating a new Service Provider with an ID of <code class="docutils literal"><span class="pre">mysp</span></code>,
a <code class="docutils literal"><span class="pre">sp_url</span></code> of <code class="docutils literal"><span class="pre">http://mysp.example.com/Shibboleth.sso/SAML2/ECP</span></code> and a
<code class="docutils literal"><span class="pre">auth_url</span></code> of <code class="docutils literal"><span class="pre">http://mysp.example.com:5000/v3/OS-FEDERATION/identity_providers/myidp/protocols/mapped/auth</span></code>
. The <code class="docutils literal"><span class="pre">sp_url</span></code> will be used when creating a SAML assertion for <code class="docutils literal"><span class="pre">mysp</span></code> and
signed by the current keystone IdP. The <code class="docutils literal"><span class="pre">auth_url</span></code> is used to retrieve the
token for <code class="docutils literal"><span class="pre">mysp</span></code> once the SAML assertion is sent. The auth_url has the format
described in <a class="reference internal" href="#get-an-unscoped-token">Get an unscoped token</a>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack service provider create --service-provider-url <span class="s1">&#39;http://mysp.example.com/Shibboleth.sso/SAML2/ECP&#39;</span> --auth-url http://mysp.example.com:5000/v3/OS-FEDERATION/identity_providers/myidp/protocols/mapped/auth mysp
</pre></div>
</div>
</div>
<div class="section" id="testing-it-all-out">
<h3>Testing it all out<a class="headerlink" href="#testing-it-all-out" title="Permalink to this headline">¶</a></h3>
<p>Use keystoneauth to create a password session with the IdP, then use the
session to authenticate with the SP, and get a scoped token from the SP.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ECP stands for Enhanced Client or Proxy, an extension from the SAML2
protocol used in non-browser interfaces, like in the following example.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">keystoneauth1</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.identity</span> <span class="kn">import</span> <span class="n">v3</span>
<span class="kn">from</span> <span class="nn">keystoneauth1.identity.v3</span> <span class="kn">import</span> <span class="n">k2k</span>

<span class="n">auth</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">Password</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_AUTH_URL&#39;</span><span class="p">),</span>
                   <span class="n">username</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_USERNAME&#39;</span><span class="p">),</span>
                   <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PASSWORD&#39;</span><span class="p">),</span>
                   <span class="n">user_domain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_USER_DOMAIN_NAME&#39;</span><span class="p">),</span>
                   <span class="n">project_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PROJECT_NAME&#39;</span><span class="p">),</span>
                   <span class="n">project_domain_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OS_PROJECT_DOMAIN_NAME&#39;</span><span class="p">))</span>
<span class="n">password_session</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<span class="n">k2ksession</span> <span class="o">=</span> <span class="n">k2k</span><span class="o">.</span><span class="n">Keystone2Keystone</span><span class="p">(</span><span class="n">password_session</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="s1">&#39;mysp&#39;</span><span class="p">,</span>
                                   <span class="n">domain_name</span><span class="o">=</span><span class="s1">&#39;federated_domain&#39;</span><span class="p">)</span>
<span class="n">auth_ref</span> <span class="o">=</span> <span class="n">k2ksession</span><span class="o">.</span><span class="n">get_auth_ref</span><span class="p">(</span><span class="n">password_session</span><span class="p">)</span>
<span class="n">scoped_token_id</span> <span class="o">=</span> <span class="n">auth_ref</span><span class="o">.</span><span class="n">auth_token</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scoped token id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">scoped_token_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Configuring Keystone for Federation</a><ul>
<li><a class="reference internal" href="#definitions">Definitions</a></li>
<li><a class="reference internal" href="#keystone-as-a-service-provider-sp">Keystone as a Service Provider (SP)</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li><a class="reference internal" href="#configure-apache-to-use-a-federation-capable-authentication-method">Configure Apache to use a federation capable authentication method</a></li>
<li><a class="reference internal" href="#configure-keystone-and-horizon-for-single-sign-on">Configure keystone and Horizon for Single Sign-On</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configure-federation-in-keystone">Configure Federation in Keystone</a><ul>
<li><a class="reference internal" href="#configure-authentication-drivers-in-keystone-conf">Configure authentication drivers in keystone.conf</a></li>
<li><a class="reference internal" href="#create-keystone-groups-and-assign-roles">Create keystone groups and assign roles</a></li>
<li><a class="reference internal" href="#add-identity-provider-s-mapping-s-and-protocol-s">Add Identity Provider(s), Mapping(s), and Protocol(s)</a><ul>
<li><a class="reference internal" href="#identity-provider">Identity Provider</a></li>
<li><a class="reference internal" href="#mapping">Mapping</a></li>
<li><a class="reference internal" href="#protocol">Protocol</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#performing-federated-authentication">Performing federated authentication</a><ul>
<li><a class="reference internal" href="#get-an-unscoped-token">Get an unscoped token</a><ul>
<li><a class="reference internal" href="#example-curl">Example cURL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#determine-accessible-resources">Determine accessible resources</a><ul>
<li><a class="reference internal" href="#id1">Example cURL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-a-scoped-token">Get a scoped token</a><ul>
<li><a class="reference internal" href="#id2">Example cURL</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#keystone-as-an-identity-provider-idp">Keystone as an Identity Provider (IdP)</a><ul>
<li><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li><a class="reference internal" href="#generate-metadata">Generate Metadata</a></li>
<li><a class="reference internal" href="#create-a-service-provider-sp">Create a Service Provider (SP)</a></li>
<li><a class="reference internal" href="#testing-it-all-out">Testing it all out</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/keystone
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/federation/configure_federation.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">keystone 11.0.0.0rc2.dev29 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012, OpenStack Foundation.
      Last updated on &#39;Fri Feb 10 22:47:54 2017, commit 9c47495&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/keystone");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>