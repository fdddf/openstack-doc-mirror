<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Configuring Keystone &mdash; keystone 11.0.0.0rc2.dev29 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="_static/support-matrix.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '11.0.0.0rc2.dev29',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="keystone 11.0.0.0rc2.dev29 documentation" href="index.html" />
    <link rel="next" title="Federated Identity" href="federation/federated_identity.html" />
    <link rel="prev" title="Getting Involved" href="community.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuring-keystone">
<h1>Configuring Keystone<a class="headerlink" href="#configuring-keystone" title="Permalink to this headline">¶</a></h1>
<div class="section" id="config-files">
<h2>Config Files<a class="headerlink" href="#config-files" title="Permalink to this headline">¶</a></h2>
<p>Once keystone is installed, keystone is configured via a primary configuration
file (<code class="docutils literal"><span class="pre">etc/keystone.conf</span></code>), a PasteDeploy configuration file
(<code class="docutils literal"><span class="pre">etc/keystone-paste.ini</span></code>), possibly a separate logging configuration file,
and initializing data into keystone using the command line client.</p>
<p>The keystone configuration files are an <code class="docutils literal"><span class="pre">ini</span></code> file format based on <a class="reference external" href="http://pythonpaste.org/">Paste</a>, a
common system used to configure Python WSGI based applications. The PasteDeploy
configuration entries (WSGI pipeline definitions) can be provided in a separate
<code class="docutils literal"><span class="pre">keystone-paste.ini</span></code> file, while general and driver-specific configuration
parameters are in the primary configuration file <code class="docutils literal"><span class="pre">keystone.conf</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since keystone&#8217;s PasteDeploy configuration file has been separated
from the main keystone configuration file, <code class="docutils literal"><span class="pre">keystone.conf</span></code>, all
local configuration or driver-specific configuration parameters must
go in the main keystone configuration file instead of the PasteDeploy
configuration file, i.e. configuration in <code class="docutils literal"><span class="pre">keystone-paste.ini</span></code>
is not supported.</p>
</div>
<div class="section" id="sample-configuration-files">
<h3>Sample Configuration Files<a class="headerlink" href="#sample-configuration-files" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">etc/</span></code> folder distributed with keystone contains example configuration
files for each Server application.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">etc/keystone.conf.sample</span></code></li>
<li><code class="docutils literal"><span class="pre">etc/keystone-paste.ini</span></code></li>
<li><code class="docutils literal"><span class="pre">etc/logging.conf.sample</span></code></li>
<li><code class="docutils literal"><span class="pre">etc/default_catalog.templates</span></code></li>
<li><code class="docutils literal"><span class="pre">etc/sso_callback_template.html</span></code></li>
</ul>
</div>
<div class="section" id="keystone-conf-sections">
<h3><code class="docutils literal"><span class="pre">keystone.conf</span></code> sections<a class="headerlink" href="#keystone-conf-sections" title="Permalink to this headline">¶</a></h3>
<p>The primary configuration file is organized into the following sections:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">[DEFAULT]</span></code> - General configuration</li>
<li><code class="docutils literal"><span class="pre">[assignment]</span></code> - Assignment system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[auth]</span></code> - Authentication plugin configuration</li>
<li><code class="docutils literal"><span class="pre">[cache]</span></code> - Caching layer configuration</li>
<li><code class="docutils literal"><span class="pre">[catalog]</span></code> - Service catalog driver configuration</li>
<li><code class="docutils literal"><span class="pre">[credential]</span></code> - Credential system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[domain_config]</span></code> - Domain configuration</li>
<li><code class="docutils literal"><span class="pre">[endpoint_filter]</span></code> - Endpoint filtering configuration</li>
<li><code class="docutils literal"><span class="pre">[endpoint_policy]</span></code> - Endpoint policy configuration</li>
<li><code class="docutils literal"><span class="pre">[federation]</span></code> - Federation driver configuration</li>
<li><code class="docutils literal"><span class="pre">[fernet_tokens]</span></code> - Fernet token configuration</li>
<li><code class="docutils literal"><span class="pre">[identity]</span></code> - Identity system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[identity_mapping]</span></code> - Identity mapping system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[ldap]</span></code> - LDAP configuration options</li>
<li><code class="docutils literal"><span class="pre">[memcache]</span></code> - Memcache configuration options</li>
<li><code class="docutils literal"><span class="pre">[oauth1]</span></code> - OAuth 1.0a system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[paste_deploy]</span></code> - Pointer to the PasteDeploy configuration file</li>
<li><code class="docutils literal"><span class="pre">[policy]</span></code> - Policy system driver configuration for RBAC</li>
<li><code class="docutils literal"><span class="pre">[resource]</span></code> - Resource system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[revoke]</span></code> - Revocation system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[role]</span></code> - Role system driver configuration</li>
<li><code class="docutils literal"><span class="pre">[saml]</span></code> - SAML configuration options</li>
<li><code class="docutils literal"><span class="pre">[security_compliance]</span></code> - Security compliance configuration</li>
<li><code class="docutils literal"><span class="pre">[shadow_users]</span></code> - Shadow user configuration</li>
<li><code class="docutils literal"><span class="pre">[signing]</span></code> - Cryptographic signatures for PKI based tokens</li>
<li><code class="docutils literal"><span class="pre">[token]</span></code> - Token driver &amp; token provider configuration</li>
<li><code class="docutils literal"><span class="pre">[tokenless_auth]</span></code> - Tokenless authentication configuration</li>
<li><code class="docutils literal"><span class="pre">[trust]</span></code> - Trust configuration</li>
</ul>
<p>The keystone primary configuration file is expected to be named
<code class="docutils literal"><span class="pre">keystone.conf</span></code>. When starting keystone, you can specify a different
configuration file to use with <code class="docutils literal"><span class="pre">--config-file</span></code>. If you do <strong>not</strong> specify a
configuration file, keystone will look in the following directories for a
configuration file, in order:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">~/.keystone/</span></code></li>
<li><code class="docutils literal"><span class="pre">~/</span></code></li>
<li><code class="docutils literal"><span class="pre">/etc/keystone/</span></code></li>
<li><code class="docutils literal"><span class="pre">/etc/</span></code></li>
</ul>
<p>PasteDeploy configuration file is specified by the <code class="docutils literal"><span class="pre">config_file</span></code> parameter in
<code class="docutils literal"><span class="pre">[paste_deploy]</span></code> section of the primary configuration file. If the parameter
is not an absolute path, then keystone looks for it in the same directories as
above. If not specified, WSGI pipeline definitions are loaded from the primary
configuration file.</p>
</div>
</div>
<div class="section" id="bootstrapping-keystone-with-keystone-manage-bootstrap">
<h2>Bootstrapping Keystone with <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">bootstrap</span></code><a class="headerlink" href="#bootstrapping-keystone-with-keystone-manage-bootstrap" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setting-up-projects-users-and-roles">
<h3>Setting up projects, users, and roles<a class="headerlink" href="#setting-up-projects-users-and-roles" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">bootstrap</span></code> command will create a user, project and role,
and will assign the newly created role to the newly created user on the newly
created project. By default, the names of these new resources will be called
<code class="docutils literal"><span class="pre">admin</span></code>.</p>
<p>The defaults may be overridden by calling <code class="docutils literal"><span class="pre">--bootstrap-username</span></code>,
<code class="docutils literal"><span class="pre">--bootstrap-project-name</span></code> and <code class="docutils literal"><span class="pre">--bootstrap-role-name</span></code>. Each of these have
an environment variable equivalent: <code class="docutils literal"><span class="pre">OS_BOOTSTRAP_USERNAME</span></code>,
<code class="docutils literal"><span class="pre">OS_BOOTSTRAP_PROJECT_NAME</span></code> and <code class="docutils literal"><span class="pre">OS_BOOTSTRAP_ROLE_NAME</span></code>.</p>
<p>A user password must also be supplied. This can be passed in as either
<code class="docutils literal"><span class="pre">--bootstrap-password</span></code>, or set as an environment variable using
<code class="docutils literal"><span class="pre">OS_BOOTSTRAP_PASSWORD</span></code>.</p>
<p>Optionally, if specified by <code class="docutils literal"><span class="pre">--bootstrap-public-url</span></code>,
<code class="docutils literal"><span class="pre">--bootstrap-admin-url</span></code> and/or <code class="docutils literal"><span class="pre">--bootstrap-internal-url</span></code> or the equivalent
environment variables, the command will create an identity service with the
specified endpoint information. You may also configure the
<code class="docutils literal"><span class="pre">--bootstrap-region-id</span></code> and <code class="docutils literal"><span class="pre">--bootstrap-service-name</span></code> for the endpoints to
your deployment&#8217;s requirements.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is strongly encouraged to configure the identity service and its
endpoints while bootstrapping keystone.</p>
</div>
<p>Minimally, keystone can be bootstrapped with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage bootstrap --bootstrap-password s3cr3t
</pre></div>
</div>
<p>Verbosely, keystone can be bootstrapped with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage bootstrap <span class="se">\</span>
    --bootstrap-password s3cr3t <span class="se">\</span>
    --bootstrap-username admin <span class="se">\</span>
    --bootstrap-project-name admin <span class="se">\</span>
    --bootstrap-role-name admin <span class="se">\</span>
    --bootstrap-service-name keystone <span class="se">\</span>
    --bootstrap-region-id RegionOne <span class="se">\</span>
    --bootstrap-admin-url http://localhost:35357 <span class="se">\</span>
    --bootstrap-public-url http://localhost:5000 <span class="se">\</span>
    --bootstrap-internal-url http://localhost:5000
</pre></div>
</div>
<p>This will create an <code class="docutils literal"><span class="pre">admin</span></code> user with the <code class="docutils literal"><span class="pre">admin</span></code> role on the <code class="docutils literal"><span class="pre">admin</span></code>
project. The user will have the password specified in the command. Note that
both the user and the project will be created in the <code class="docutils literal"><span class="pre">default</span></code> domain. By not
creating an endpoint in the catalog users will need to provide endpoint
overrides to perform additional identity operations.</p>
<p>By creating an <code class="docutils literal"><span class="pre">admin</span></code> user and an identity endpoint deployers may
authenticate to keystone and perform identity operations like creating
additional services and endpoints using that <code class="docutils literal"><span class="pre">admin</span></code> user. This will preclude
the need to ever use or configure the <code class="docutils literal"><span class="pre">admin_token</span></code> (described below).</p>
<p>To test a proper configuration, a user can use OpenStackClient CLI:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack project list --os-username admin --os-project-name admin <span class="se">\</span>
    --os-user-domain-id default --os-project-domain-id default <span class="se">\</span>
    --os-identity-api-version <span class="m">3</span> --os-auth-url http://localhost:5000 <span class="se">\</span>
    --os-password s3cr3t
</pre></div>
</div>
</div>
</div>
<div class="section" id="bootstrapping-keystone-with-admin-token">
<h2>Bootstrapping Keystone with <code class="docutils literal"><span class="pre">ADMIN_TOKEN</span></code><a class="headerlink" href="#bootstrapping-keystone-with-admin-token" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<dl class="last docutils">
<dt>It is strongly recommended to configure the identity service with the</dt>
<dd><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">bootstrap</span></code> command and not the <code class="docutils literal"><span class="pre">ADMIN_TOKEN</span></code>.</dd>
</dl>
</div>
<div class="section" id="admin-token">
<h3>Admin Token<a class="headerlink" href="#admin-token" title="Permalink to this headline">¶</a></h3>
<p>For a default installation of Keystone, before you can use the REST API, you
need to define an authorization token. This is configured in <code class="docutils literal"><span class="pre">keystone.conf</span></code>
file under the section <code class="docutils literal"><span class="pre">[DEFAULT]</span></code>. In the sample file provided with the
Keystone project, the line defining this token is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">admin_token</span> <span class="o">=</span> <span class="n">ADMIN</span>
</pre></div>
</div>
<p>A &#8220;shared secret&#8221; that can be used to bootstrap Keystone. This token does not
represent a user, and carries no explicit authorization.
To disable in production (highly recommended), remove
<code class="docutils literal"><span class="pre">AdminTokenAuthMiddleware</span></code> from your paste application pipelines (for example,
in <code class="docutils literal"><span class="pre">keystone-paste.ini</span></code>)</p>
</div>
<div class="section" id="id1">
<h3>Setting up projects, users, and roles<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>You need to minimally define a project, user, and role to link the project and
user as the most basic set of details to get other services authenticating
and authorizing with Keystone.</p>
<p>You will also want to create service users for nova, glance, swift, etc. to
be able to use to authenticate users against Keystone. The <code class="docutils literal"><span class="pre">auth_token</span></code>
middleware supports using either the shared secret described above as
<cite>admin_token</cite> or users for each service.</p>
</div>
</div>
<div class="section" id="setting-up-other-openstack-services">
<h2>Setting up other OpenStack Services<a class="headerlink" href="#setting-up-other-openstack-services" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-service-users">
<h3>Creating Service Users<a class="headerlink" href="#creating-service-users" title="Permalink to this headline">¶</a></h3>
<p>To configure the OpenStack services with service users, we need to create
a project for all the services, and then users for each of the services. We
then assign those service users an <code class="docutils literal"><span class="pre">admin</span></code> role on the service project. This
allows them to validate tokens - and to authenticate and authorize other user
requests.</p>
<p>Create a project for the services, typically named <code class="docutils literal"><span class="pre">service</span></code> (however, the
name can be whatever you choose):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack project create service
</pre></div>
</div>
<p>Create service users for <code class="docutils literal"><span class="pre">nova</span></code>, <code class="docutils literal"><span class="pre">glance</span></code>, <code class="docutils literal"><span class="pre">swift</span></code>, and <code class="docutils literal"><span class="pre">neutron</span></code>
(or whatever subset is relevant to your deployment):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack user create nova --password Sekr3tPass --project service
</pre></div>
</div>
<p>Repeat this for each service you want to enable.</p>
<p>Create an administrative role for the service accounts, typically named
<code class="docutils literal"><span class="pre">admin</span></code> (however the name can be whatever you choose). For adding the
administrative role to the service accounts, you&#8217;ll need to know the
name of the role you want to add. If you don&#8217;t have it handy, you can look it
up quickly with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack role list
</pre></div>
</div>
<p>Once you have it, grant the administrative role to the service users.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack role add admin --project service --user nova
</pre></div>
</div>
</div>
<div class="section" id="defining-services">
<h3>Defining Services<a class="headerlink" href="#defining-services" title="Permalink to this headline">¶</a></h3>
<p>Keystone also acts as a service catalog to let other OpenStack systems know
where relevant API endpoints exist for OpenStack Services. The OpenStack
Dashboard, in particular, uses this heavily - and this <strong>must</strong> be configured
for the OpenStack Dashboard to properly function.</p>
<p>The endpoints for these services are defined in a template, an example of
which is in the project as the file <code class="docutils literal"><span class="pre">etc/default_catalog.templates</span></code>.</p>
<p>Keystone supports two means of defining the services, one is the catalog
template, as described above - in which case everything is detailed in that
template.</p>
<p>The other is a SQL backend for the catalog service, in which case after
Keystone is online, you need to add the services to the catalog:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack service create compute --name nova <span class="se">\</span>
                                --description <span class="s2">&quot;Nova Compute Service&quot;</span>
$ openstack service create ec2 --name ec2 <span class="se">\</span>
                               --description <span class="s2">&quot;EC2 Compatibility Layer&quot;</span>
$ openstack service create image --name glance <span class="se">\</span>
                                  --description <span class="s2">&quot;Glance Image Service&quot;</span>
$ openstack service create identity --name keystone <span class="se">\</span>
                                    --description <span class="s2">&quot;Keystone Identity Service&quot;</span>
$ openstack service create object-store --name swift <span class="se">\</span>
                                 --description <span class="s2">&quot;Swift Service&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="identity-sources">
<h2>Identity sources<a class="headerlink" href="#identity-sources" title="Permalink to this headline">¶</a></h2>
<p>One of the most impactful decisions you&#8217;ll have to make when configuring
keystone is deciding how you want keystone to source your identity data.
Keystone supports several different choices that will substantially impact how
you&#8217;ll configure, deploy, and interact with keystone.</p>
<p>You can also mix-and-match various sources of identity (see <a class="reference internal" href="#domain-specific-drivers">Domain-specific
Drivers</a> below for an example). For example, you can store OpenStack service
users and their passwords in SQL, manage customers in LDAP, and authenticate
employees via SAML federation.</p>
<h2 class="section-subtitle"><span class="section-subtitle">Summary</span></h2>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><em class="first last">Feature</em></th>
<th class="head"><em class="first last">Status</em></th>
<th class="head"><strong class="first last">REMOTE_USER</strong></th>
<th class="head"><strong class="first last">LDAP</strong></th>
<th class="head"><strong class="first last">OAuth v1.0a</strong></th>
<th class="head"><strong class="first last">OpenID Connect</strong></th>
<th class="head"><strong class="first last">SAML v2</strong></th>
<th class="head"><strong class="first last">SQL</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#feature_local_authentication"><strong>Local authentication</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_external"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_ldap"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_oauth1"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_oidc"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_samlv2"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_local_authentication_sql"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#feature_external_authentication"><strong>External authentication</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_external"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_ldap"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_oauth1"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_oidc"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_samlv2"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_external_authentication_sql"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#feature_identity_crud"><strong>Identity management</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_external"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_ldap"><code class="sp_impl_summary sp_impl_partial docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_oauth1"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_oidc"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_samlv2"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_identity_crud_sql"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#feature_pci_controls"><strong>PCI-DSS controls</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_external"><code class="sp_impl_summary sp_impl_partial docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_ldap"><code class="sp_impl_summary sp_impl_partial docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_oauth1"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_oidc"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_samlv2"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_pci_controls_sql"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#feature_auditing"><strong>Auditing</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_external"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_ldap"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_oauth1"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_oidc"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_samlv2"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_auditing_sql"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
</tbody>
</table>
<h2 class="section-subtitle"><span class="section-subtitle">Details</span></h2>
<ul>
<li><strong class="first" id="feature_local_authentication">Local authentication</strong><p><strong>Status: optional. </strong><span>Authenticate with keystone by providing credentials directly to keystone.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">OpenID Connect: </strong><code class="sp_impl_missing docutils literal" id="feature_local_authentication_oidc"><span class="pre">missing</span></code></li>
<li><strong class="first">SQL: </strong><code class="sp_impl_complete docutils literal" id="feature_local_authentication_sql"><span class="pre">complete</span></code></li>
<li><strong class="first">SAML v2: </strong><code class="sp_impl_missing docutils literal" id="feature_local_authentication_samlv2"><span class="pre">missing</span></code></li>
<li><strong class="first">OAuth v1.0a: </strong><code class="sp_impl_complete docutils literal" id="feature_local_authentication_oauth1"><span class="pre">complete</span></code></li>
<li><strong class="first">LDAP: </strong><code class="sp_impl_complete docutils literal" id="feature_local_authentication_ldap"><span class="pre">complete</span></code></li>
<li><strong class="first">REMOTE_USER: </strong><code class="sp_impl_missing docutils literal" id="feature_local_authentication_external"><span class="pre">missing</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_external_authentication">External authentication</strong><p><strong>Status: optional. </strong><span>Authenticate with keystone by providing credentials to an external system
that keystone trusts (as with federation).</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">OpenID Connect: </strong><code class="sp_impl_complete docutils literal" id="feature_external_authentication_oidc"><span class="pre">complete</span></code></li>
<li><strong class="first">SQL: </strong><code class="sp_impl_missing docutils literal" id="feature_external_authentication_sql"><span class="pre">missing</span></code></li>
<li><strong class="first">SAML v2: </strong><code class="sp_impl_complete docutils literal" id="feature_external_authentication_samlv2"><span class="pre">complete</span></code></li>
<li><strong class="first">OAuth v1.0a: </strong><code class="sp_impl_missing docutils literal" id="feature_external_authentication_oauth1"><span class="pre">missing</span></code></li>
<li><strong class="first">LDAP: </strong><code class="sp_impl_missing docutils literal" id="feature_external_authentication_ldap"><span class="pre">missing</span></code></li>
<li><strong class="first">REMOTE_USER: </strong><code class="sp_impl_complete docutils literal" id="feature_external_authentication_external"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_identity_crud">Identity management</strong><p><strong>Status: optional. </strong><span>Create, update, enable/disable, and delete users via Keystone&#8217;s HTTP API.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">OpenID Connect: </strong><code class="sp_impl_missing docutils literal" id="feature_identity_crud_oidc"><span class="pre">missing</span></code></li>
<li><strong class="first">SQL: </strong><code class="sp_impl_complete docutils literal" id="feature_identity_crud_sql"><span class="pre">complete</span></code></li>
<li><strong class="first">SAML v2: </strong><code class="sp_impl_missing docutils literal" id="feature_identity_crud_samlv2"><span class="pre">missing</span></code></li>
<li><strong class="first">OAuth v1.0a: </strong><code class="sp_impl_complete docutils literal" id="feature_identity_crud_oauth1"><span class="pre">complete</span></code></li>
<li><strong class="first">LDAP: </strong><code class="sp_impl_partial docutils literal" id="feature_identity_crud_ldap"><span class="pre">partial</span></code></li>
<li><strong class="first">REMOTE_USER: </strong><code class="sp_impl_missing docutils literal" id="feature_identity_crud_external"><span class="pre">missing</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_pci_controls">PCI-DSS controls</strong><p><strong>Status: optional. </strong><span>Configure keystone to enforce PCI-DSS compliant security controls.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">OpenID Connect: </strong><code class="sp_impl_missing docutils literal" id="feature_pci_controls_oidc"><span class="pre">missing</span></code></li>
<li><strong class="first">SQL: </strong><code class="sp_impl_complete docutils literal" id="feature_pci_controls_sql"><span class="pre">complete</span></code></li>
<li><strong class="first">SAML v2: </strong><code class="sp_impl_missing docutils literal" id="feature_pci_controls_samlv2"><span class="pre">missing</span></code></li>
<li><strong class="first">OAuth v1.0a: </strong><code class="sp_impl_missing docutils literal" id="feature_pci_controls_oauth1"><span class="pre">missing</span></code></li>
<li><strong class="first">LDAP: </strong><code class="sp_impl_partial docutils literal" id="feature_pci_controls_ldap"><span class="pre">partial</span></code></li>
<li><strong class="first">REMOTE_USER: </strong><code class="sp_impl_partial docutils literal" id="feature_pci_controls_external"><span class="pre">partial</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_auditing">Auditing</strong><p><strong>Status: optional. </strong><span>Audit authentication flows using PyCADF.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">OpenID Connect: </strong><code class="sp_impl_complete docutils literal" id="feature_auditing_oidc"><span class="pre">complete</span></code></li>
<li><strong class="first">SQL: </strong><code class="sp_impl_complete docutils literal" id="feature_auditing_sql"><span class="pre">complete</span></code></li>
<li><strong class="first">SAML v2: </strong><code class="sp_impl_complete docutils literal" id="feature_auditing_samlv2"><span class="pre">complete</span></code></li>
<li><strong class="first">OAuth v1.0a: </strong><code class="sp_impl_missing docutils literal" id="feature_auditing_oauth1"><span class="pre">missing</span></code></li>
<li><strong class="first">LDAP: </strong><code class="sp_impl_complete docutils literal" id="feature_auditing_ldap"><span class="pre">complete</span></code></li>
<li><strong class="first">REMOTE_USER: </strong><code class="sp_impl_missing docutils literal" id="feature_auditing_external"><span class="pre">missing</span></code></li>
</ul>
</p>
</li>
</ul>
<div class="section" id="domain-specific-drivers">
<h3>Domain-specific Drivers<a class="headerlink" href="#domain-specific-drivers" title="Permalink to this headline">¶</a></h3>
<p>Keystone supports the option (disabled by default) to specify identity driver
configurations on a domain by domain basis, allowing, for example, a specific
domain to have its own LDAP or SQL server. This is configured by specifying the
following options:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[identity]</span>
<span class="na">domain_specific_drivers_enabled</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">domain_config_dir</span> <span class="o">=</span> <span class="s">/etc/keystone/domains</span>
</pre></div>
</div>
<p>Setting <code class="docutils literal"><span class="pre">domain_specific_drivers_enabled</span></code> to <code class="docutils literal"><span class="pre">True</span></code> will enable this
feature, causing keystone to look in the <code class="docutils literal"><span class="pre">domain_config_dir</span></code> for config files
of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>keystone.&lt;domain_name&gt;.conf
</pre></div>
</div>
<p>Options given in the domain specific configuration file will override those in
the primary configuration file for the specified domain only. Domains without a
specific configuration file will continue to use the options from the primary
configuration file.</p>
<p>Keystone also supports the ability to store the domain-specific configuration
options in the keystone SQL database, managed via the Identity API, as opposed
to using domain-specific configuration files.</p>
<p>This capability (which is disabled by default) is enabled by specifying the
following options in the main keystone configuration file:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[identity]</span>
<span class="na">domain_specific_drivers_enabled</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">domain_configurations_from_database</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>Once enabled, any existing domain-specific configuration files in the
configuration directory will be ignored and only those domain-specific
configuration options specified via the Identity API will be used.</p>
<p>Unlike the file-based method of specifying domain-specific configurations,
options specified via the Identity API will become active without needing to
restart the keystone server. For performance reasons, the current state of
configuration options for a domain are cached in the keystone server, and in
multi-process and multi-threaded keystone configurations, the new
configuration options may not become active until the cache has timed out. The
cache settings for domain config options can be adjusted in the general
keystone configuration file (option <code class="docutils literal"><span class="pre">cache_time</span></code> in the <code class="docutils literal"><span class="pre">domain_config</span></code>
group).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is important to notice that when using either of these methods of
specifying domain-specific configuration options, the main keystone
configuration file is still maintained. Only those options that relate
to the Identity driver for users and groups (i.e. specifying whether the
driver for this domain is SQL or LDAP, and, if LDAP, the options that
define that connection) are supported in a domain-specific manner. Further,
when using the configuration options via the Identity API, the driver
option must be set to an LDAP driver (attempting to set it to an SQL driver
will generate an error when it is subsequently used).</p>
</div>
<p>For existing installations that already use file-based domain-specific
configurations who wish to migrate to the SQL-based approach, the
<code class="docutils literal"><span class="pre">keystone-manage</span></code> command can be used to upload all configuration files to
the SQL database:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage domain_config_upload --all
</pre></div>
</div>
<p>Once uploaded, these domain-configuration options will be visible via the
Identity API as well as applied to the domain-specific drivers. It is also
possible to upload individual domain-specific configuration files by
specifying the domain name:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage domain_config_upload --domain-name DOMAINA
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is important to notice that by enabling either of the domain-specific
configuration methods, the operations of listing all users and listing all
groups are not supported, those calls will need either a domain filter to
be specified or usage of a domain scoped token.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Keystone does not support moving the contents of a domain (i.e. &#8220;its&#8221; users
and groups) from one backend to another, nor group membership across
backend boundaries.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When using the file-based domain-specific configuration method, to delete a
domain that uses a domain specific backend, it&#8217;s necessary to first disable
it, remove its specific configuration file (i.e. its corresponding
keystone.&lt;domain_name&gt;.conf) and then restart the Identity server. When
managing configuration options via the Identity API, the domain can simply
be disabled and deleted via the Identity API; since any domain-specific
configuration options will automatically be removed.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although keystone supports multiple LDAP backends via the above
domain-specific configuration methods, it currently only supports one SQL
backend. This could be either the default driver or a single
domain-specific backend, perhaps for storing service users in a
predominantly LDAP installation.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Keystone has deprecated the <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">domain_config_upload</span></code>
option. The keystone team recommends setting domain config options via the
API instead.</p>
</div>
<p>Due to the need for user and group IDs to be unique across an OpenStack
installation and for keystone to be able to deduce which domain and backend to
use from just a user or group ID, it dynamically builds a persistent identity
mapping table from a public ID to the actual domain, local ID (within that
backend) and entity type. The public ID is automatically generated by keystone
when it first encounters the entity. If the local ID of the entity is from a
backend that does not guarantee to generate UUIDs, a hash algorithm will
generate a public ID for that entity, which is what will be exposed by
keystone.</p>
<p>The use of a hash will ensure that if the public ID needs to be regenerated
then the same public ID will be created. This is useful if you are running
multiple keystones and want to ensure the same ID would be generated whichever
server you hit.</p>
<p>While keystone will dynamically maintain the identity mapping, including
removing entries when entities are deleted via the keystone, for those entities
in backends that are managed outside of keystone (e.g. a read-only LDAP),
keystone will not know if entities have been deleted and hence will continue to
carry stale identity mappings in its table. While benign, keystone provides an
ability for operators to purge the mapping table of such stale entries using
the keystone-manage command, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage mapping_purge --domain-name DOMAINA --local-id abc@de.com
</pre></div>
</div>
<p>A typical usage would be for an operator to obtain a list of those entries in
an external backend that had been deleted out-of-band to keystone, and then
call keystone-manage to purge those entries by specifying the domain and
local-id. The type of the entity (i.e. user or group) may also be specified if
this is needed to uniquely identify the mapping.</p>
<p>Since public IDs can be regenerated <strong>with the correct generator
implementation</strong>, if the details of those entries that have been deleted are
not available, then it is safe to simply bulk purge identity mappings
periodically, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage mapping_purge --domain-name DOMAINA
</pre></div>
</div>
<p>will purge all the mappings for DOMAINA. The entire mapping table can be purged
with the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage mapping_purge --all
</pre></div>
</div>
<p>Generating public IDs in the first run may take a while, and most probably
first API requests to fetch user list will fail by timeout. To prevent this,
<code class="docutils literal"><span class="pre">mapping_populate</span></code> command should be executed. It should be executed right after
LDAP has been configured or after <code class="docutils literal"><span class="pre">mapping_purge</span></code>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage mapping_populate --domain DOMAINA
</pre></div>
</div>
</div>
<div class="section" id="public-id-generators">
<h3>Public ID Generators<a class="headerlink" href="#public-id-generators" title="Permalink to this headline">¶</a></h3>
<p>Keystone supports a customizable public ID generator and it is specified in the
<code class="docutils literal"><span class="pre">[identity_mapping]</span></code> section of the configuration file. Keystone provides a
sha256 generator as default, which produces regeneratable public IDs. The
generator algorithm for public IDs is a balance between key size (i.e. the
length of the public ID), the probability of collision and, in some
circumstances, the security of the public ID. The maximum length of public ID
supported by keystone is 64 characters, and the default generator (sha256) uses
this full capability. Since the public ID is what is exposed externally by
keystone and potentially stored in external systems, some installations may
wish to make use of other generator algorithms that have a different trade-off
of attributes. A different generator can be installed by configuring the
following property:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">generator</span></code> - identity mapping generator. Defaults to <code class="docutils literal"><span class="pre">sha256</span></code>
(implemented by <a class="reference internal" href="api/keystone.identity.id_generators.html#keystone.identity.id_generators.sha256.Generator" title="keystone.identity.id_generators.sha256.Generator"><code class="xref py py-class docutils literal"><span class="pre">keystone.identity.id_generators.sha256.Generator</span></code></a>)</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Changing the generator may cause all existing public IDs to be become
invalid, so typically the generator selection should be considered
immutable for a given installation.</p>
</div>
</div>
</div>
<div class="section" id="authentication-plugins">
<h2>Authentication Plugins<a class="headerlink" href="#authentication-plugins" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This feature is only supported by keystone for the Identity API v3 clients.</p>
</div>
<p>Keystone supports authentication plugins and they are specified in the
<code class="docutils literal"><span class="pre">[auth]</span></code> section of the configuration file. However, an authentication plugin
may also have its own section in the configuration file. It is up to the plugin
to register its own configuration options.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">methods</span></code> - comma-delimited list of authentication plugin names</li>
<li><code class="docutils literal"><span class="pre">&lt;plugin</span> <span class="pre">name&gt;</span></code> - specify the class which handles to authentication method,
in the same manner as one would specify a backend driver.</li>
</ul>
<p>Keystone provides three authentication methods by default. <code class="docutils literal"><span class="pre">password</span></code> handles
password authentication and <code class="docutils literal"><span class="pre">token</span></code> handles token authentication.
<code class="docutils literal"><span class="pre">external</span></code> is used in conjunction with authentication performed by a
container web server that sets the <code class="docutils literal"><span class="pre">REMOTE_USER</span></code> environment variable. For
more details, refer to <a class="reference internal" href="external-auth.html"><em>External Authentication</em></a>.</p>
<div class="section" id="how-to-implement-an-authentication-plugin">
<h3>How to Implement an Authentication Plugin<a class="headerlink" href="#how-to-implement-an-authentication-plugin" title="Permalink to this headline">¶</a></h3>
<p>All authentication plugins must extend the
<a class="reference internal" href="api/keystone.auth.plugins.html#keystone.auth.plugins.base.AuthMethodHandler" title="keystone.auth.plugins.base.AuthMethodHandler"><code class="xref py py-class docutils literal"><span class="pre">keystone.auth.plugins.base.AuthMethodHandler</span></code></a> class and implement the
<code class="docutils literal"><span class="pre">authenticate()</span></code> method. The <code class="docutils literal"><span class="pre">authenticate()</span></code> method expects the following
parameters.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">context</span></code> - keystone&#8217;s request context</li>
<li><code class="docutils literal"><span class="pre">auth_payload</span></code> - the content of the authentication for a given method</li>
<li><code class="docutils literal"><span class="pre">auth_context</span></code> - user authentication context, a dictionary shared by all
plugins. It contains <code class="docutils literal"><span class="pre">method_names</span></code> and <code class="docutils literal"><span class="pre">extras</span></code> by default.
<code class="docutils literal"><span class="pre">method_names</span></code> is a list and <code class="docutils literal"><span class="pre">extras</span></code> is a dictionary.</li>
</ul>
<p>If successful, the <code class="docutils literal"><span class="pre">authenticate()</span></code> method must provide a valid <code class="docutils literal"><span class="pre">user_id</span></code>
in <code class="docutils literal"><span class="pre">auth_context</span></code> and return <code class="docutils literal"><span class="pre">None</span></code>. <code class="docutils literal"><span class="pre">method_name</span></code> is used to convey any
additional authentication methods in case authentication is for re-scoping. For
example, if the authentication is for re-scoping, a plugin must append the
previous method names into <code class="docutils literal"><span class="pre">method_names</span></code>. Also, a plugin may add any
additional information into <code class="docutils literal"><span class="pre">extras</span></code>. Anything in <code class="docutils literal"><span class="pre">extras</span></code> will be conveyed
in the token&#8217;s <code class="docutils literal"><span class="pre">extras</span></code> field.</p>
<p>If authentication requires multiple steps, the <code class="docutils literal"><span class="pre">authenticate()</span></code> method must
return the payload in the form of a dictionary for the next authentication
step.</p>
<p>If authentication is unsuccessful, the <code class="docutils literal"><span class="pre">authenticate()</span></code> method must raise a
<a class="reference internal" href="api/keystone.html#keystone.exception.Unauthorized" title="keystone.exception.Unauthorized"><code class="xref py py-class docutils literal"><span class="pre">keystone.exception.Unauthorized</span></code></a> exception.</p>
<p>Simply add the new plugin name to the <code class="docutils literal"><span class="pre">methods</span></code> list along with your plugin
class configuration in the <code class="docutils literal"><span class="pre">[auth]</span></code> sections of the configuration file to
deploy it.</p>
<p>If the plugin requires additional configurations, it may register its own
section in the configuration file.</p>
<p>Plugins are invoked in the order in which they are specified in the <code class="docutils literal"><span class="pre">methods</span></code>
attribute of the <code class="docutils literal"><span class="pre">authentication</span></code> request body. If multiple plugins are
invoked, all plugins must succeed in order to for the entire authentication to
be successful. Furthermore, all the plugins invoked must agree on the
<code class="docutils literal"><span class="pre">user_id</span></code> in the <code class="docutils literal"><span class="pre">auth_context</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">REMOTE_USER</span></code> environment variable is only set from a containing
webserver. However, to ensure that a user must go through other authentication
mechanisms, even if this variable is set, remove <code class="docutils literal"><span class="pre">external</span></code> from the list of
plugins specified in <code class="docutils literal"><span class="pre">methods</span></code>. This effectively disables external
authentication. For more details, refer to <a class="reference internal" href="external-auth.html"><em>ExternalAuthentication</em></a>.</p>
</div>
</div>
<div class="section" id="token-drivers-and-providers">
<h2>Token Drivers and Providers<a class="headerlink" href="#token-drivers-and-providers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="token-persistence-driver">
<h3>Token Persistence Driver<a class="headerlink" href="#token-persistence-driver" title="Permalink to this headline">¶</a></h3>
<p>Keystone supports customizable token persistence drivers. These can be
specified in the <code class="docutils literal"><span class="pre">[token]</span></code> section of the configuration file. Keystone
provides two non-test persistence backends. These can be set with the
<code class="docutils literal"><span class="pre">[token]</span> <span class="pre">driver</span></code> configuration option.</p>
<p>The drivers keystone provides are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">sql</span></code> - The SQL-based (default) token persistence engine. Implemented by
<a class="reference internal" href="api/keystone.token.persistence.backends.html#keystone.token.persistence.backends.sql.Token" title="keystone.token.persistence.backends.sql.Token"><code class="xref py py-class docutils literal"><span class="pre">keystone.token.persistence.backends.sql.Token</span></code></a></li>
</ul>
</div>
<div class="section" id="token-provider">
<h3>Token Provider<a class="headerlink" href="#token-provider" title="Permalink to this headline">¶</a></h3>
<p>Keystone supports customizable token providers and it is specified in the
<code class="docutils literal"><span class="pre">[token]</span></code> section of the configuration file. Keystone provides two token
provider options (<code class="docutils literal"><span class="pre">fernet</span></code> and <code class="docutils literal"><span class="pre">uuid</span></code>, with <code class="docutils literal"><span class="pre">fernet</span></code> being the default).
Users may register their own token provider by configuring the
<code class="docutils literal"><span class="pre">[token]</span> <span class="pre">provider</span></code> property.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">fernet</span></code> - A Fernet based token provider. Implemented by
<code class="xref py py-class docutils literal"><span class="pre">keystone.token.providers.fernet.Provider</span></code></li>
<li><code class="docutils literal"><span class="pre">uuid</span></code> - A UUID based token provider. Implemented by
<a class="reference internal" href="api/keystone.token.providers.html#keystone.token.providers.uuid.Provider" title="keystone.token.providers.uuid.Provider"><code class="xref py py-class docutils literal"><span class="pre">keystone.token.providers.uuid.Provider</span></code></a></li>
</ul>
<div class="section" id="uuid-or-fernet">
<h4>UUID or Fernet?<a class="headerlink" href="#uuid-or-fernet" title="Permalink to this headline">¶</a></h4>
<p>Each token format uses different technologies to achieve various performance,
scaling and architectural requirements.</p>
<p>UUID tokens contain randomly generated UUID4 IDs that are issued and
validated by the identity service. They are encoded using their hex digest for
transport and are thus URL-friendly. They must be persisted by the identity
service in order to be later validated. Revoking them is simply a matter of
deleting them from the token persistence backend.</p>
<p>Fernet tokens contain a limited amount of identity and authorization data in a
<a class="reference external" href="http://msgpack.org/">MessagePacked</a> payload. The payload is then wrapped as
a <a class="reference external" href="https://github.com/fernet/spec">Fernet</a> message for transport, where
Fernet provides the required web safe characteristics for use in URLs and
headers. Fernet tokens require symmetric encryption keys which can be
established using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">fernet_setup</span></code> and periodically rotated
using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">fernet_rotate</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">UUID and Fernet tokens are both bearer tokens, meaning that they
must be protected from unnecessary disclosure to prevent unauthorized
access.</p>
</div>
<h4 class="section-subtitle"><span class="section-subtitle">Summary</span></h4>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><em class="first last">Feature</em></th>
<th class="head"><em class="first last">Status</em></th>
<th class="head"><strong class="first last">Fernet tokens</strong></th>
<th class="head"><strong class="first last">UUID tokens</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#operation_create_unscoped_token"><strong>Create unscoped token</strong></a></span></td>
<td><span class="sp_feature_mandatory first last">mandatory</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_unscoped_token_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_unscoped_token_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#operation_create_project_scoped_token"><strong>Create project-scoped token</strong></a></span></td>
<td><span class="sp_feature_mandatory first last">mandatory</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_project_scoped_token_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_project_scoped_token_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#operation_create_domain_scoped_token"><strong>Create domain-scoped token</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_domain_scoped_token_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_domain_scoped_token_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#operation_create_trust_scoped_token"><strong>Create trust-scoped token</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_trust_scoped_token_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_trust_scoped_token_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#operation_create_token_using_oauth"><strong>Create a token given an OAuth access token</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_token_using_oauth_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_token_using_oauth_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#operation_create_token_with_bind"><strong>Create a token with a bind attribute</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_token_with_bind_fernet"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_create_token_with_bind_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#operation_revoke_token"><strong>Revoke a token</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#operation_revoke_token_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#operation_revoke_token_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#feature_online_validation"><strong>Online validation</strong></a></span></td>
<td><span class="sp_feature_mandatory first last">mandatory</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_online_validation_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_online_validation_uuid"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
</tr>
<tr class="row-even"><td><span class="first last"><a class="reference internal" href="#feature_offline_validation"><strong>Offline validation</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_offline_validation_fernet"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_offline_validation_uuid"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
</tr>
<tr class="row-odd"><td><span class="first last"><a class="reference internal" href="#feature_non_persistent"><strong>Non-persistent</strong></a></span></td>
<td><span class="sp_feature_optional first last">optional</span></td>
<td><span class="first last"><a class="reference internal" href="#feature_non_persistent_fernet"><code class="sp_impl_summary sp_impl_complete docutils literal"><span class="pre">✔</span></code></a></span></td>
<td><span class="first last"><a class="reference internal" href="#feature_non_persistent_uuid"><code class="sp_impl_summary sp_impl_missing docutils literal"><span class="pre">✖</span></code></a></span></td>
</tr>
</tbody>
</table>
<h4 class="section-subtitle"><span class="section-subtitle">Details</span></h4>
<ul>
<li><strong class="first" id="operation_create_unscoped_token">Create unscoped token</strong><p><strong>Status: mandatory. </strong><span>All token providers must be capable of issuing tokens without an explicit
scope of authorization.</span></p>
<p><strong>CLI commands:</strong><ul>
<li><code class="sp_cli first docutils literal"><span class="pre">openstack</span> <span class="pre">--os-username=&lt;username&gt;</span> <span class="pre">--os-user-domain-name=&lt;domain&gt;</span>
<span class="pre">--os-password=&lt;password&gt;</span> <span class="pre">token</span> <span class="pre">issue</span></code></li>
</ul>
</p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_unscoped_token_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_unscoped_token_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_create_project_scoped_token">Create project-scoped token</strong><p><strong>Status: mandatory. </strong><span>All token providers must be capable of issuing project-scoped tokens.</span></p>
<p><strong>CLI commands:</strong><ul>
<li><code class="sp_cli first docutils literal"><span class="pre">openstack</span> <span class="pre">--os-username=&lt;username&gt;</span> <span class="pre">--os-user-domain-name=&lt;domain&gt;</span>
<span class="pre">--os-password=&lt;password&gt;</span> <span class="pre">--os-project-name=&lt;project&gt;</span>
<span class="pre">--os-project-domain-name=&lt;domain&gt;</span> <span class="pre">token</span> <span class="pre">issue</span></code></li>
</ul>
</p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_project_scoped_token_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_project_scoped_token_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_create_domain_scoped_token">Create domain-scoped token</strong><p><strong>Status: optional. </strong><span>Domain-scoped tokens are not required for all use cases, and for some use
cases, projects can be used instead.</span></p>
<p><strong>CLI commands:</strong><ul>
<li><code class="sp_cli first docutils literal"><span class="pre">openstack</span> <span class="pre">--os-username=&lt;username&gt;</span> <span class="pre">--os-user-domain-name=&lt;domain&gt;</span>
<span class="pre">--os-password=&lt;password&gt;</span> <span class="pre">--os-domain-name=&lt;domain&gt;</span> <span class="pre">token</span> <span class="pre">issue</span></code></li>
</ul>
</p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_domain_scoped_token_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_domain_scoped_token_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_create_trust_scoped_token">Create trust-scoped token</strong><p><strong>Status: optional. </strong><span>Tokens scoped to a trust convey only the user impersonation and
project-based authorization attributes included in the delegation.</span></p>
<p><strong>CLI commands:</strong><ul>
<li><code class="sp_cli first docutils literal"><span class="pre">openstack</span> <span class="pre">--os-username=&lt;username&gt;</span> <span class="pre">--os-user-domain-name=&lt;domain&gt;</span>
<span class="pre">--os-password=&lt;password&gt;</span> <span class="pre">--os-trust-id=&lt;trust&gt;</span> <span class="pre">token</span> <span class="pre">issue</span></code></li>
</ul>
</p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_trust_scoped_token_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_trust_scoped_token_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_create_token_using_oauth">Create a token given an OAuth access token</strong><p><strong>Status: optional. </strong><span>OAuth access tokens can be exchanged for keystone tokens.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_token_using_oauth_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_token_using_oauth_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_create_token_with_bind">Create a token with a bind attribute</strong><p><strong>Status: optional. </strong><span>Tokens can express a binding to an additional authentication method, such
as kerberos or x509.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_missing docutils literal" id="operation_create_token_with_bind_fernet"><span class="pre">missing</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_create_token_with_bind_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="operation_revoke_token">Revoke a token</strong><p><strong>Status: optional. </strong><span>Tokens may be individually revoked, such as when a user logs out of
Horizon. Under certain circumstances, it&#8217;s acceptable for more than just a
single token may be revoked as a result of this operation (such as when the
revoked token was previously used to create additional tokens).</span></p>
<p><strong>CLI commands:</strong><ul>
<li><code class="sp_cli first docutils literal"><span class="pre">openstack</span> <span class="pre">token</span> <span class="pre">revoke</span></code></li>
</ul>
</p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_revoke_token_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="operation_revoke_token_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_online_validation">Online validation</strong><p><strong>Status: mandatory. </strong><span>Keystone must be able to validate the tokens that it issues when
presented with a token that it previously issued.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="feature_online_validation_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_complete docutils literal" id="feature_online_validation_uuid"><span class="pre">complete</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_offline_validation">Offline validation</strong><p><strong>Status: optional. </strong><span>Services using Keystone for authentication may want to validate tokens
themselves, rather than calling back to keystone, in order to improve
performance and scalability.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_missing docutils literal" id="feature_offline_validation_fernet"><span class="pre">missing</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_missing docutils literal" id="feature_offline_validation_uuid"><span class="pre">missing</span></code></li>
</ul>
</p>
</li>
<li><strong class="first" id="feature_non_persistent">Non-persistent</strong><p><strong>Status: optional. </strong><span>If a token format does not require persistence (such as to a SQL
backend), then there is no scalability limit to the number of tokens that
keystone can issue at once, and there is no need to perform clean up
operations such as `keystone-manage token_flush`.</span></p>
<p><strong>drivers:</strong><ul>
<li><strong class="first">Fernet tokens: </strong><code class="sp_impl_complete docutils literal" id="feature_non_persistent_fernet"><span class="pre">complete</span></code></li>
<li><strong class="first">UUID tokens: </strong><code class="sp_impl_missing docutils literal" id="feature_non_persistent_uuid"><span class="pre">missing</span></code></li>
</ul>
</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="encryption-keys-for-fernet-tokens">
<h2>Encryption Keys for Fernet Tokens<a class="headerlink" href="#encryption-keys-for-fernet-tokens" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">fernet_setup</span></code> will attempt to create a key repository as
configured in the <code class="docutils literal"><span class="pre">[fernet_tokens]</span></code> section of <code class="docutils literal"><span class="pre">keystone.conf</span></code> and
bootstrap it with encryption keys.</p>
<p>A single 256-bit key is actually composed of two smaller keys: a 128-bit key
used for SHA256 HMAC signing and a 128-bit key used for AES encryption. See the
<a class="reference external" href="https://github.com/fernet/spec">Fernet token</a> specification for more detail.</p>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">fernet_rotate</span></code> will rotate encryption keys through the
following states:</p>
<ul class="simple">
<li><strong>Staged key</strong>: In a key rotation, a new key is introduced into the rotation
in this state. Only one key is considered to be the <em>staged</em> key at any given
time. This key will become the <em>primary</em> during the <em>next</em> key rotation. This
key is only used to validate tokens and serves to avoid race conditions in
multi-node deployments (all nodes should recognize all <em>primary</em> keys in the
deployment at all times). In a multi-node keystone deployment this would
allow for the <em>staged</em> key to be replicated to all keystone nodes before
being promoted to <em>primary</em> on a single node. This prevents the case where a
<em>primary</em> key is created on one keystone node and tokens encrypted/signed with
that new <em>primary</em> are rejected on another keystone node because the new
<em>primary</em> doesn&#8217;t exist there yet.</li>
<li><strong>Primary key</strong>: In a key rotation, the old <em>staged</em> key is promoted to be
the <em>primary</em>. Only one key is considered to be the <em>primary</em> key at any
given time. This is the key used to generate new tokens. This key is also
used to validate previously generated tokens.</li>
<li><strong>Secondary keys</strong>: In a key rotation, the old <em>primary</em> key is demoted to be
a <em>secondary</em> key. <em>Secondary</em> keys are only used to validate previously
generated tokens. You can maintain any number of <em>secondary</em> keys, up to
<code class="docutils literal"><span class="pre">[fernet_tokens]</span> <span class="pre">max_active_keys</span></code> (where &#8220;active&#8221; refers to the sum of all
recognized keys in any state: <em>staged</em>, <em>primary</em> or <em>secondary</em>). When
<code class="docutils literal"><span class="pre">max_active_keys</span></code> is exceeded during a key rotation, the oldest keys are
discarded.</li>
</ul>
<p>When a new primary key is created, all new tokens will be encrypted using the
new primary key. The old primary key is demoted to a secondary key, which can
still be used for validating tokens. Excess secondary keys (beyond
<code class="docutils literal"><span class="pre">[fernet_tokens]</span> <span class="pre">max_active_keys</span></code>) are revoked. Revoked keys are permanently
deleted.</p>
<p>Rotating keys too frequently, or with <code class="docutils literal"><span class="pre">[fernet_tokens]</span> <span class="pre">max_active_keys</span></code> set
too low, will cause tokens to become invalid prior to their expiration. As
tokens may be fetched beyond there initial expiration period keys should not be
fully rotated within the period of <code class="docutils literal"><span class="pre">[token]</span> <span class="pre">expiration</span></code> + <code class="docutils literal"><span class="pre">[token]</span>
<span class="pre">allow_expired_window</span></code> seconds to prevent the tokens becoming unavailable.</p>
</div>
<div class="section" id="caching-layer">
<h2>Caching Layer<a class="headerlink" href="#caching-layer" title="Permalink to this headline">¶</a></h2>
<p>Keystone&#8217;s configuration file offers two separate sections related to caching,
<code class="docutils literal"><span class="pre">[memcache]</span></code> and <code class="docutils literal"><span class="pre">[cache]</span></code>. The <code class="docutils literal"><span class="pre">[memcache]</span></code> section provides caching
options to configure memcache backends. For example, if your deployment issues
UUID tokens (<code class="docutils literal"><span class="pre">[token]</span> <span class="pre">provider</span> <span class="pre">=</span> <span class="pre">uuid</span></code>) and your token storage driver is
memcache (<code class="docutils literal"><span class="pre">[token]</span> <span class="pre">driver</span> <span class="pre">=</span> <span class="pre">kvs</span></code>), the configuration options in the
<code class="docutils literal"><span class="pre">[memcache]</span></code> section will effect token storage behavior. The <code class="docutils literal"><span class="pre">[cache]</span></code>
section is provided through the <code class="docutils literal"><span class="pre">oslo.cache</span></code> library and consists of options
to configure the caching of data between a particular keystone subsystem (e.g.
<code class="docutils literal"><span class="pre">token</span></code>, <code class="docutils literal"><span class="pre">identity</span></code>, etc) and its configured storage backend. For example,
if your deployment&#8217;s identity backend is using SQL (<code class="docutils literal"><span class="pre">[identity]</span> <span class="pre">driver</span> <span class="pre">=</span>
<span class="pre">sql</span></code>) and you have caching enabled (<code class="docutils literal"><span class="pre">[cache]</span> <span class="pre">enabled</span> <span class="pre">=</span> <span class="pre">true</span></code>),
<code class="docutils literal"><span class="pre">oslo.cache</span></code> will cache responses from SQL improving the overall performance
of the identity subsystem. The options in the <code class="docutils literal"><span class="pre">[cache]</span></code> section will effect
the caching layer in-between a keystone subsystem and its storage backend.</p>
<p>Keystone uses the <a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/">dogpile.cache</a> library which allows for flexible cache
backends. The majority of the caching configuration options are set in the
<code class="docutils literal"><span class="pre">[cache]</span></code> section.  However, each section that has the capability to be
cached usually has a <code class="docutils literal"><span class="pre">caching</span></code> boolean value that will toggle caching for
that specific section.  The current default behavior is that global and
subsystem caching is enabled.</p>
<div class="section" id="cache-configuration-section">
<h3><code class="docutils literal"><span class="pre">[cache]</span></code> configuration section<a class="headerlink" href="#cache-configuration-section" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">enabled</span></code> - enables/disables caching across all of keystone</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">debug_cache_backend</span></code> - enables more in-depth logging from the cache
backend (get, set, delete, etc)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">backend</span></code> - the caching backend module to use e.g.
<code class="docutils literal"><span class="pre">dogpile.cache.memcached</span></code></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A given <code class="docutils literal"><span class="pre">backend</span></code> must be registered with <code class="docutils literal"><span class="pre">dogpile.cache</span></code> before it
can be used. The default backend is the keystone no-op backend
(<code class="docutils literal"><span class="pre">keystone.common.cache.noop</span></code>). If caching is desired a different
backend will need to be specified. Current functional backends are:</p>
</div>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.memcached</span></code> - Memcached backend using the standard
<a class="reference external" href="http://www.tummy.com/software/python-memcached/">python-memcached</a> library (recommended for use with Apache httpd with
<code class="docutils literal"><span class="pre">mod_wsgi</span></code>)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.pylibmc</span></code> - Memcached backend using the <a class="reference external" href="http://sendapatch.se/projects/pylibmc/index.html">pylibmc</a>
library</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.bmemcached</span></code> - Memcached using <a class="reference external" href="https://github.com/jaysonsantos/python-binary-memcached">python-binary-memcached</a>
library.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.redis</span></code> - <a class="reference external" href="http://redis.io/">Redis</a> backend</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.dbm</span></code> - local DBM file backend</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">dogpile.cache.memory</span></code> - in-memory cache</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">oslo_cache.mongo</span></code> - MongoDB as caching backend</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">oslo_cache.memcache_pool</span></code> - Memcache with pooling.
This implementation also provides client connection re-use.</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">dogpile.cache.memory</span></code> is not suitable for use outside of unit
testing as it does not cleanup its internal cache on cache
expiration, does not provide isolation to the cached data (values
in the store can be inadvertently changed without extra layers of
data protection added), and does not share cache between processes.
This means that caching and cache invalidation will not be
consistent or reliable when using <code class="docutils literal"><span class="pre">keystone</span></code> and the
<code class="docutils literal"><span class="pre">dogpile.cache.memory</span></code> backend under any real workload.</p>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">expiration_time</span></code> - int, the default length of time to cache a specific
value. A value of <code class="docutils literal"><span class="pre">0</span></code> indicates to not cache anything. It is recommended
that the <code class="docutils literal"><span class="pre">enabled</span></code> option be used to disable cache instead of setting this
to <code class="docutils literal"><span class="pre">0</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">backend_argument</span></code> - an argument passed to the backend when instantiated
<code class="docutils literal"><span class="pre">backend_argument</span></code> should be specified once per argument to be passed to
the backend and in the format of <code class="docutils literal"><span class="pre">&lt;argument</span> <span class="pre">name&gt;:&lt;argument</span> <span class="pre">value&gt;</span></code>. e.g.:
<code class="docutils literal"><span class="pre">backend_argument</span> <span class="pre">=</span> <span class="pre">host:localhost</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">proxies</span></code> - comma delimited list of <a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/api.html#proxy-backends">ProxyBackends</a> e.g.
<code class="docutils literal"><span class="pre">my.example.Proxy,</span> <span class="pre">my.example.Proxy2</span></code></p>
</li>
</ul>
<dl class="docutils">
<dt>Current keystone systems that have caching capabilities:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">token</span></code></dt>
<dd><p class="first">The token system has a separate <code class="docutils literal"><span class="pre">cache_time</span></code> configuration option,
that can be set to a value above or below the global
<code class="docutils literal"><span class="pre">expiration_time</span></code> default, allowing for different caching behavior
from the other systems in keystone. This option is set in the
<code class="docutils literal"><span class="pre">[token]</span></code> section of the configuration file.</p>
<p class="last">The Token Revocation List cache time is handled by the configuration
option <code class="docutils literal"><span class="pre">revocation_cache_time</span></code> in the <code class="docutils literal"><span class="pre">[token]</span></code> section. The
revocation list is refreshed whenever a token is revoked. It typically
sees significantly more requests than specific token retrievals or
token validation calls.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">resource</span></code></dt>
<dd><p class="first">The resource system has a separate <code class="docutils literal"><span class="pre">cache_time</span></code> configuration option,
that can be set to a value above or below the global
<code class="docutils literal"><span class="pre">expiration_time</span></code> default, allowing for different caching behavior
from the other systems in keystone. This option is set in the
<code class="docutils literal"><span class="pre">[resource]</span></code> section of the configuration file.</p>
<p>Currently <code class="docutils literal"><span class="pre">resource</span></code> has caching for <code class="docutils literal"><span class="pre">project</span></code> and <code class="docutils literal"><span class="pre">domain</span></code>
specific requests (primarily around the CRUD actions).  The
<code class="docutils literal"><span class="pre">list_projects</span></code> and <code class="docutils literal"><span class="pre">list_domains</span></code> methods are not subject to
caching.</p>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Be aware that if a read-only <code class="docutils literal"><span class="pre">resource</span></code> backend is in use, the
cache will not immediately reflect changes on the back end.  Any
given change may take up to the <code class="docutils literal"><span class="pre">cache_time</span></code> (if set in the
<code class="docutils literal"><span class="pre">[resource]</span></code> section of the configuration) or the global
<code class="docutils literal"><span class="pre">expiration_time</span></code> (set in the <code class="docutils literal"><span class="pre">[cache]</span></code> section of the
configuration) before it is reflected. If this type of delay (when
using a read-only <code class="docutils literal"><span class="pre">resource</span></code> backend) is an issue, it is
recommended that caching be disabled on <code class="docutils literal"><span class="pre">resource</span></code>. To disable
caching specifically on <code class="docutils literal"><span class="pre">resource</span></code>, in the <code class="docutils literal"><span class="pre">[resource]</span></code> section
of the configuration set <code class="docutils literal"><span class="pre">caching</span></code> to <code class="docutils literal"><span class="pre">False</span></code>.</p>
</div>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">role</span></code></dt>
<dd><p class="first">Currently <code class="docutils literal"><span class="pre">role</span></code> has caching for <code class="docutils literal"><span class="pre">get_role</span></code>, but not for <code class="docutils literal"><span class="pre">list_roles</span></code>.
The role system has a separate <code class="docutils literal"><span class="pre">cache_time</span></code> configuration option,
that can be set to a value above or below the global <code class="docutils literal"><span class="pre">expiration_time</span></code>
default, allowing for different caching behavior from the other systems in
keystone.  This option is set in the <code class="docutils literal"><span class="pre">[role]</span></code> section of the
configuration file.</p>
<div class="last admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Be aware that if a read-only <code class="docutils literal"><span class="pre">role</span></code> backend is in use, the cache
will not immediately reflect changes on the back end.  Any given change
may take up to the <code class="docutils literal"><span class="pre">cache_time</span></code> (if set in the <code class="docutils literal"><span class="pre">[role]</span></code>
section of the configuration) or the global <code class="docutils literal"><span class="pre">expiration_time</span></code> (set in
the <code class="docutils literal"><span class="pre">[cache]</span></code> section of the configuration) before it is reflected.
If this type of delay (when using a read-only <code class="docutils literal"><span class="pre">role</span></code> backend) is
an issue, it is recommended that caching be disabled on <code class="docutils literal"><span class="pre">role</span></code>.
To disable caching specifically on <code class="docutils literal"><span class="pre">role</span></code>, in the <code class="docutils literal"><span class="pre">[role]</span></code>
section of the configuration set <code class="docutils literal"><span class="pre">caching</span></code> to <code class="docutils literal"><span class="pre">False</span></code>.</p>
</div>
</dd>
</dl>
</li>
</ul>
</dd>
<dt>For more information about the different backends (and configuration options):</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/api.html#memory-backend">dogpile.cache.backends.memory</a></li>
<li><a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/api.html#memcached-backends">dogpile.cache.backends.memcached</a></li>
<li><a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/api.html#redis-backends">dogpile.cache.backends.redis</a></li>
<li><a class="reference external" href="http://dogpilecache.readthedocs.org/en/latest/api.html#file-backends">dogpile.cache.backends.file</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="certificates-for-pki">
<h2>Certificates for PKI<a class="headerlink" href="#certificates-for-pki" title="Permalink to this headline">¶</a></h2>
<p>PKI stands for Public Key Infrastructure. Tokens are documents,
cryptographically signed using the X509 standard. In order to work correctly
token generation requires a public/private key pair. The public key must be
signed in an X509 certificate, and the certificate used to sign it must be
available as Certificate Authority (CA) certificate. These files can be either
externally generated or generated using the <code class="docutils literal"><span class="pre">keystone-manage</span></code> utility.</p>
<p>The files used for signing and verifying certificates are set in the keystone
configuration file. The private key should only be readable by the system user
that will run keystone. The values that specify the certificates are under the
<code class="docutils literal"><span class="pre">[signing]</span></code> section of the configuration file. The configuration values are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">certfile</span></code> - Location of certificate used to verify tokens. Default is
<code class="docutils literal"><span class="pre">/etc/keystone/ssl/certs/signing_cert.pem</span></code></li>
<li><code class="docutils literal"><span class="pre">keyfile</span></code> - Location of private key used to sign tokens. Default is
<code class="docutils literal"><span class="pre">/etc/keystone/ssl/private/signing_key.pem</span></code></li>
<li><code class="docutils literal"><span class="pre">ca_certs</span></code> - Location of certificate for the authority that issued the
above certificate. Default is <code class="docutils literal"><span class="pre">/etc/keystone/ssl/certs/ca.pem</span></code></li>
</ul>
<div class="section" id="signing-certificate-issued-by-external-ca">
<h3>Signing Certificate Issued by External CA<a class="headerlink" href="#signing-certificate-issued-by-external-ca" title="Permalink to this headline">¶</a></h3>
<p>You may use a signing certificate issued by an external CA instead of generated
by <code class="docutils literal"><span class="pre">keystone-manage</span></code>. However, certificate issued by external CA must satisfy
the following conditions:</p>
<ul class="simple">
<li>all certificate and key files must be in Privacy Enhanced Mail (PEM) format</li>
<li>private key files must not be protected by a password</li>
</ul>
<p>The basic workflow for using a signing certificate issued by an external CA
involves:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="#request-signing-certificate-from-external-ca">Request Signing Certificate from External CA</a></li>
<li>Convert certificate and private key to PEM if needed</li>
<li><a class="reference internal" href="#install-external-signing-certificate">Install External Signing Certificate</a></li>
</ol>
</div>
<div class="section" id="request-signing-certificate-from-external-ca">
<h3>Request Signing Certificate from External CA<a class="headerlink" href="#request-signing-certificate-from-external-ca" title="Permalink to this headline">¶</a></h3>
<p>One way to request a signing certificate from an external CA is to first
generate a PKCS #10 Certificate Request Syntax (CRS) using OpenSSL CLI.</p>
<p>First create a certificate request configuration file (e.g. <code class="docutils literal"><span class="pre">cert_req.conf</span></code>):</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ req ]</span>
<span class="na">default_bits</span>            <span class="o">=</span> <span class="s">2048</span>
<span class="na">default_keyfile</span>         <span class="o">=</span> <span class="s">keystonekey.pem</span>
<span class="na">default_md</span>              <span class="o">=</span> <span class="s">default</span>

<span class="na">prompt</span>                  <span class="o">=</span> <span class="s">no</span>
<span class="na">distinguished_name</span>      <span class="o">=</span> <span class="s">distinguished_name</span>

<span class="k">[ distinguished_name ]</span>
<span class="na">countryName</span>             <span class="o">=</span> <span class="s">US</span>
<span class="na">stateOrProvinceName</span>     <span class="o">=</span> <span class="s">CA</span>
<span class="na">localityName</span>            <span class="o">=</span> <span class="s">Sunnyvale</span>
<span class="na">organizationName</span>        <span class="o">=</span> <span class="s">OpenStack</span>
<span class="na">organizationalUnitName</span>  <span class="o">=</span> <span class="s">Keystone</span>
<span class="na">commonName</span>              <span class="o">=</span> <span class="s">Keystone Signing</span>
<span class="na">emailAddress</span>            <span class="o">=</span> <span class="s">keystone@openstack.org</span>
</pre></div>
</div>
<p>Then generate a CRS with OpenSSL CLI. <strong>Do not encrypt the generated private
key. The -nodes option must be used.</strong></p>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openssl req -newkey rsa:2048 -keyout signing_key.pem -keyform PEM -out signing_cert_req.pem -outform PEM -config cert_req.conf -nodes
</pre></div>
</div>
<p>If everything is successfully, you should end up with <code class="docutils literal"><span class="pre">signing_cert_req.pem</span></code>
and <code class="docutils literal"><span class="pre">signing_key.pem</span></code>. Send <code class="docutils literal"><span class="pre">signing_cert_req.pem</span></code> to your CA to request a
token signing certificate and make sure to ask the certificate to be in PEM
format. Also, make sure your trusted CA certificate chain is also in PEM
format.</p>
</div>
<div class="section" id="install-external-signing-certificate">
<h3>Install External Signing Certificate<a class="headerlink" href="#install-external-signing-certificate" title="Permalink to this headline">¶</a></h3>
<p>Assuming you have the following already:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">signing_cert.pem</span></code> - (Keystone token) signing certificate in PEM format</li>
<li><code class="docutils literal"><span class="pre">signing_key.pem</span></code> - corresponding (non-encrypted) private key in PEM format</li>
<li><code class="docutils literal"><span class="pre">cacert.pem</span></code> - trust CA certificate chain in PEM format</li>
</ul>
<p>Copy the above to your certificate directory. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ mkdir -p /etc/keystone/ssl/certs
$ cp signing_cert.pem /etc/keystone/ssl/certs/
$ cp signing_key.pem /etc/keystone/ssl/certs/
$ cp cacert.pem /etc/keystone/ssl/certs/
$ chmod -R <span class="m">700</span> /etc/keystone/ssl/certs
</pre></div>
</div>
<p><strong>Make sure the certificate directory is root-protected.</strong></p>
<p>If your certificate directory path is different from the default
<code class="docutils literal"><span class="pre">/etc/keystone/ssl/certs</span></code>, make sure it is reflected in the <code class="docutils literal"><span class="pre">[signing]</span></code>
section of the configuration file.</p>
</div>
<div class="section" id="generating-a-signing-certificate-using-pki-setup">
<h3>Generating a Signing Certificate using <code class="docutils literal"><span class="pre">pki_setup</span></code><a class="headerlink" href="#generating-a-signing-certificate-using-pki-setup" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">pki_setup</span></code> is a development tool. We recommend that you do
not use <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">pki_setup</span></code> in a production environment. In
production, an external CA should be used instead. This is because the CA
secret key should generally be kept apart from the token signing secret keys so
that a compromise of a node does not lead to an attacker being able to generate
valid signed keystone tokens. This is a low probability attack vector, as
compromise of a keystone service machine&#8217;s filesystem security almost certainly
means the attacker will be able to gain direct access to the token backend.</p>
<p>When using the <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">pki_setup</span></code> to generate the certificates, the
following configuration options in the <code class="docutils literal"><span class="pre">[signing]</span></code> section are used:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ca_key</span></code> - Default is <code class="docutils literal"><span class="pre">/etc/keystone/ssl/private/cakey.pem</span></code></li>
<li><code class="docutils literal"><span class="pre">key_size</span></code> - Default is <code class="docutils literal"><span class="pre">2048</span></code></li>
<li><code class="docutils literal"><span class="pre">valid_days</span></code> - Default is <code class="docutils literal"><span class="pre">3650</span></code></li>
</ul>
<p>If <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">pki_setup</span></code> is not used then these options don&#8217;t need to
be set.</p>
</div>
</div>
<div class="section" id="service-catalog">
<h2>Service Catalog<a class="headerlink" href="#service-catalog" title="Permalink to this headline">¶</a></h2>
<p>Keystone provides two configuration options for managing a service catalog.</p>
<div class="section" id="sql-based-service-catalog-sql-catalog">
<h3>SQL-based Service Catalog (<code class="docutils literal"><span class="pre">sql.Catalog</span></code>)<a class="headerlink" href="#sql-based-service-catalog-sql-catalog" title="Permalink to this headline">¶</a></h3>
<p>A dynamic database-backed driver fully supporting persistent configuration.</p>
<p><code class="docutils literal"><span class="pre">keystone.conf</span></code> example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[catalog]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <cite>template_file</cite> does not need to be defined for the sql based catalog.</p>
</div>
<p>To build your service catalog using this driver, see the built-in help:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack --help
$ openstack service create --help
$ openstack endpoint create --help
</pre></div>
</div>
</div>
<div class="section" id="file-based-service-catalog-templated-catalog">
<h3>File-based Service Catalog (<code class="docutils literal"><span class="pre">templated.Catalog</span></code>)<a class="headerlink" href="#file-based-service-catalog-templated-catalog" title="Permalink to this headline">¶</a></h3>
<p>The templated catalog is an in-memory backend initialized from a read-only
<code class="docutils literal"><span class="pre">template_file</span></code>. Choose this option only if you know that your service
catalog will not change very much over time.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Attempting to change your service catalog against this driver will result
in <code class="docutils literal"><span class="pre">HTTP</span> <span class="pre">501</span> <span class="pre">Not</span> <span class="pre">Implemented</span></code> errors. This is the expected behavior. If
you want to use these commands, you must instead use the SQL-based Service
Catalog driver.</p>
</div>
<p><code class="docutils literal"><span class="pre">keystone.conf</span></code> example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[catalog]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">templated</span>
<span class="na">template_file</span> <span class="o">=</span> <span class="s">/opt/stack/keystone/etc/default_catalog.templates</span>
</pre></div>
</div>
<p>The value of <code class="docutils literal"><span class="pre">template_file</span></code> is expected to be an absolute path to your
service catalog configuration. An example <code class="docutils literal"><span class="pre">template_file</span></code> is included in
keystone, however you should create your own to reflect your deployment.</p>
</div>
</div>
<div class="section" id="endpoint-filtering">
<h2>Endpoint Filtering<a class="headerlink" href="#endpoint-filtering" title="Permalink to this headline">¶</a></h2>
<p>Endpoint Filtering enables creation of ad-hoc catalogs for each project-scoped
token request.</p>
<p>Configure the endpoint filter catalog driver in the <code class="docutils literal"><span class="pre">[catalog]</span></code> section.
For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[catalog]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">catalog_sql</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">[endpoint_filter]</span></code> section, set <code class="docutils literal"><span class="pre">return_all_endpoints_if_no_filter</span></code>
to <code class="docutils literal"><span class="pre">False</span></code> to return an empty catalog if no associations are made.
For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[endpoint_filter]</span>
<span class="na">return_all_endpoints_if_no_filter</span> <span class="o">=</span> <span class="s">False</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://developer.openstack.org/api-ref/identity/v3-ext/#os-ep-filter-api">API Specification for Endpoint Filtering</a> for the details of API definition.</p>
</div>
<div class="section" id="endpoint-policy">
<h2>Endpoint Policy<a class="headerlink" href="#endpoint-policy" title="Permalink to this headline">¶</a></h2>
<p>The Endpoint Policy feature provides associations between service endpoints
and policies that are already stored in the Identity server and referenced
by a policy ID.</p>
<p>Configure the endpoint policy backend driver in the <code class="docutils literal"><span class="pre">[endpoint_policy]</span></code>
section. For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[endpoint_policy]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://specs.openstack.org/openstack/keystone-specs/api/v3/identity-api-v3-os-endpoint-policy.html">API Specification for Endpoint Policy</a>
for the details of API definition.</p>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>Logging is configured externally to the rest of keystone. Configure the path to
your logging configuration file using the <code class="docutils literal"><span class="pre">[DEFAULT]</span> <span class="pre">log_config_append</span></code>
option of <code class="docutils literal"><span class="pre">keystone.conf</span></code>. If you wish to route all your logging through
syslog, set the <code class="docutils literal"><span class="pre">[DEFAULT]</span> <span class="pre">use_syslog</span></code> option.</p>
<p>A sample <code class="docutils literal"><span class="pre">log_config_append</span></code> file is included with the project at
<code class="docutils literal"><span class="pre">etc/logging.conf.sample</span></code>. Like other OpenStack projects, keystone uses the
<a class="reference external" href="http://docs.python.org/library/logging.html">Python logging module</a>, which includes extensive configuration options for
choosing the output levels and formats.</p>
</div>
<div class="section" id="ssl">
<h2>SSL<a class="headerlink" href="#ssl" title="Permalink to this headline">¶</a></h2>
<p>A secure deployment should have keystone running in a web server (such as
Apache httpd), or behind an SSL terminator.</p>
</div>
<div class="section" id="oauth1-1-0a">
<h2>OAuth1 1.0a<a class="headerlink" href="#oauth1-1-0a" title="Permalink to this headline">¶</a></h2>
<p>The OAuth 1.0a feature provides the ability for Identity users to delegate
roles to third party consumers via the OAuth 1.0a specification.</p>
<p>To enable OAuth1:</p>
<ol class="arabic simple">
<li>Add the oauth1 driver to the <code class="docutils literal"><span class="pre">[oauth1]</span></code> section in <code class="docutils literal"><span class="pre">keystone.conf</span></code>. For
example:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[oauth1]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Add the <code class="docutils literal"><span class="pre">oauth1</span></code> authentication method to the <code class="docutils literal"><span class="pre">[auth]</span></code> section in
<code class="docutils literal"><span class="pre">keystone.conf</span></code>:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[auth]</span>
<span class="na">methods</span> <span class="o">=</span> <span class="s">external,password,token,oauth1</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>If deploying under Apache httpd with <code class="docutils literal"><span class="pre">mod_wsgi</span></code>, set the
<cite>WSGIPassAuthorization</cite> to allow the OAuth Authorization headers to pass
through <cite>mod_wsgi</cite>. For example, add the following to the keystone virtual
host file:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">WSGIPassAuthorization On</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://specs.openstack.org/openstack/keystone-specs/api/v3/identity-api-v3-os-oauth1-ext.html">API Specification for OAuth 1.0a</a> for the details of
API definition.</p>
</div>
<div class="section" id="revocation-events">
<h2>Revocation Events<a class="headerlink" href="#revocation-events" title="Permalink to this headline">¶</a></h2>
<p>The Revocation Events feature provides a list of token revocations. Each event
expresses a set of criteria which describes a set of tokens that are
no longer valid.</p>
<p>Add the revoke backend driver to the <code class="docutils literal"><span class="pre">[revoke]</span></code> section in
<code class="docutils literal"><span class="pre">keystone.conf</span></code>. For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[revoke]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://specs.openstack.org/openstack/keystone-specs/api/v3/identity-api-v3-os-revoke-ext.html">API Specification for Revocation Events</a> for
the details of API definition.</p>
</div>
<div class="section" id="token-binding">
<h2>Token Binding<a class="headerlink" href="#token-binding" title="Permalink to this headline">¶</a></h2>
<p>Token binding refers to the practice of embedding information from external
authentication providers (like a company&#8217;s Kerberos server) inside the token
such that a client may enforce that the token only be used in conjunction with
that specified authentication. This is an additional security mechanism as it
means that if a token is stolen it will not be usable without also providing
the external authentication.</p>
<p>To activate token binding you must specify the types of authentication that
token binding should be used for in <code class="docutils literal"><span class="pre">keystone.conf</span></code> e.g.:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[token]</span>
<span class="na">bind</span> <span class="o">=</span> <span class="s">kerberos</span>
</pre></div>
</div>
<p>Currently only <code class="docutils literal"><span class="pre">kerberos</span></code> is supported.</p>
<p>To enforce checking of token binding the <code class="docutils literal"><span class="pre">enforce_token_bind</span></code> parameter
should be set to one of the following modes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">disabled</span></code> disable token bind checking</li>
<li><code class="docutils literal"><span class="pre">permissive</span></code> enable bind checking, if a token is bound to a mechanism that
is unknown to the server then ignore it. This is the default.</li>
<li><code class="docutils literal"><span class="pre">strict</span></code> enable bind checking, if a token is bound to a mechanism that is
unknown to the server then this token should be rejected.</li>
<li><code class="docutils literal"><span class="pre">required</span></code> enable bind checking and require that at least 1 bind mechanism
is used for tokens.</li>
<li>named enable bind checking and require that the specified authentication
mechanism is used. e.g.:</li>
</ul>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[token]</span>
<span class="na">enforce_token_bind</span> <span class="o">=</span> <span class="s">kerberos</span>
</pre></div>
</div>
<p><em>Do not</em> set <code class="docutils literal"><span class="pre">enforce_token_bind</span> <span class="pre">=</span> <span class="pre">named</span></code> as there is not an authentication
mechanism called <code class="docutils literal"><span class="pre">named</span></code>.</p>
</div>
<div class="section" id="limiting-list-return-size">
<h2>Limiting list return size<a class="headerlink" href="#limiting-list-return-size" title="Permalink to this headline">¶</a></h2>
<p>Keystone provides a method of setting a limit to the number of entities
returned in a collection, which is useful to prevent overly long response times
for list queries that have not specified a sufficiently narrow filter. This
limit can be set globally by setting <code class="docutils literal"><span class="pre">list_limit</span></code> in the default section of
<code class="docutils literal"><span class="pre">keystone.conf</span></code>, with no limit set by default. Individual driver sections may
override this global value with a specific limit, for example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[resource]</span>
<span class="na">list_limit</span> <span class="o">=</span> <span class="s">100</span>
</pre></div>
</div>
<p>If a response to <code class="docutils literal"><span class="pre">list_{entity}</span></code> call has been truncated, then the response
status code will still be 200 (OK), but the <code class="docutils literal"><span class="pre">truncated</span></code> attribute in the
collection will be set to <code class="docutils literal"><span class="pre">true</span></code>.</p>
</div>
<div class="section" id="url-safe-naming-of-projects-and-domains">
<h2>URL safe naming of projects and domains<a class="headerlink" href="#url-safe-naming-of-projects-and-domains" title="Permalink to this headline">¶</a></h2>
<p>In the future, keystone may offer the ability to identify a project in a
hierarchy via a URL style of naming from the root of the hierarchy (for example
specifying &#8216;projectA/projectB/projectC&#8217; as the project name in an
authentication request). In order to prepare for this, keystone supports the
optional ability to ensure both projects and domains are named without
including any of the reserverd characters specified in section 2.2 of
<a class="reference external" href="http://tools.ietf.org/html/rfc3986">rfc3986</a>.</p>
<p>The safety of the names of projects and domains can be controlled via two
configuration options:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[resource]</span>
<span class="na">project_name_url_safe</span> <span class="o">=</span> <span class="s">off</span>
<span class="na">domain_name_url_safe</span> <span class="o">=</span> <span class="s">off</span>
</pre></div>
</div>
<p>When set to <code class="docutils literal"><span class="pre">off</span></code> (which is the default), no checking is done on the URL
safeness of names. When set to <code class="docutils literal"><span class="pre">new</span></code>, an attempt to create a new project or
domain with an unsafe name (or update the name of a project or domain to be
unsafe) will cause a status code of 400 (Bad Request) to be returned. Setting
the configuration option to <code class="docutils literal"><span class="pre">strict</span></code> will, in addition to preventing the
creation and updating of entities with unsafe names, cause an authentication
attempt which specifies a project or domain name that is unsafe to return a
status code of 401 (Unauthorized).</p>
<p>It is recommended that installations take the steps necessary to where they
can run with both options set to <code class="docutils literal"><span class="pre">strict</span></code> as soon as is practical.</p>
</div>
<div class="section" id="health-check-middleware">
<h2>Health Check middleware<a class="headerlink" href="#health-check-middleware" title="Permalink to this headline">¶</a></h2>
<p>This health check middleware allows an operator to configure the endpoint URL
that will provide information to a load balancer if the given API endpoint at
the node should be available or not.</p>
<p>To enable the health check middleware, it must occur in the beginning of the
application pipeline.</p>
<p>The health check middleware should be placed in your
<code class="docutils literal"><span class="pre">keystone-paste.ini</span></code> in a section titled <code class="docutils literal"><span class="pre">[filter:healthcheck]</span></code>.
It should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[filter:healthcheck]
use = egg:oslo.middleware#healthcheck
</pre></div>
</div>
<p>Desired keystone application pipelines have been defined with this filter,
looking like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[pipeline:public_version_api]
pipeline = healthcheck cors sizelimit osprofiler url_normalize public_version_service
</pre></div>
</div>
<p>It&#8217;s important that the healthcheck go to the front of the pipeline for the
most efficient checks.</p>
<p>For more information and configuration options for the middleware see
<a class="reference external" href="https://docs.openstack.org/developer/oslo.middleware/api.html#oslo_middleware.Healthcheck">oslo.middleware</a>.</p>
</div>
<div class="section" id="api-protection-with-role-based-access-control-rbac">
<span id="api-protection-with-rbac"></span><h2>API protection with Role Based Access Control (RBAC)<a class="headerlink" href="#api-protection-with-role-based-access-control-rbac" title="Permalink to this headline">¶</a></h2>
<p>Like most OpenStack projects, keystone supports the protection of its APIs by
defining policy rules based on an RBAC approach. These are stored in a JSON
policy file, the name and location of which is set in the main keystone
configuration file.</p>
<p>Each keystone v3 API has a line in the policy file which dictates what level of
protection is applied to it, where each line is of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;api name&gt;: &lt;rule statement&gt; or &lt;match statement&gt;
</pre></div>
</div>
<p>where:</p>
<p><code class="docutils literal"><span class="pre">&lt;rule</span> <span class="pre">statement&gt;</span></code> can contain <code class="docutils literal"><span class="pre">&lt;rule</span> <span class="pre">statement&gt;</span></code> or <code class="docutils literal"><span class="pre">&lt;match</span> <span class="pre">statement&gt;</span></code></p>
<p><code class="docutils literal"><span class="pre">&lt;match</span> <span class="pre">statement&gt;</span></code> is a set of identifiers that must match between the token
provided by the caller of the API and the parameters or target entities of the
API call in question. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="s2">&quot;identity:create_user&quot;</span><span class="o">:</span> <span class="s2">&quot;role:admin and domain_id:%(user.domain_id)s&quot;</span>
</pre></div>
</div>
<p>Indicates that to create a user you must have the admin role in your token and
in addition the domain_id in your token (which implies this must be a domain
scoped token) must match the domain_id in the user object you are trying to
create. In other words, you must have the admin role on the domain in which you
are creating the user, and the token you are using must be scoped to that
domain.</p>
<p>Each component of a match statement is of the form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;attribute from token&gt;:&lt;constant&gt; or &lt;attribute related to API call&gt;
</pre></div>
</div>
<p>The following attributes are available</p>
<ul>
<li><p class="first">Attributes from token: user_id, the domain_id or project_id depending on
the scope, and the list of roles you have within that scope</p>
</li>
<li><p class="first">Attributes related to API call: Any parameters that are passed into the API
call are available, along with any filters specified in the query string.
Attributes of objects passed can be referenced using an object.attribute
syntax (e.g. user.domain_id). The target objects of an API are also available
using a target.object.attribute syntax. For instance:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="s2">&quot;identity:delete_user&quot;</span><span class="o">:</span> <span class="s2">&quot;role:admin and domain_id:%(target.user.domain_id)s&quot;</span>
</pre></div>
</div>
<p>would ensure that the user object that is being deleted is in the same
domain as the token provided.</p>
</li>
</ul>
<p>Every target object (except token) has an <cite>id</cite> and a <cite>name</cite> available as
<cite>target.&lt;object&gt;.id</cite> and <cite>target.&lt;object&gt;.name</cite>. Other attributes are retrieved
from the database and vary between object types. Moreover, some database fields
are filtered out (e.g. user passwords).</p>
<p>List of object attributes:</p>
<ul>
<li><dl class="first docutils">
<dt>role:</dt>
<dd><ul class="first last simple">
<li>target.role.domain_id</li>
<li>target.role.id</li>
<li>target.role.name</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>user:</dt>
<dd><ul class="first last simple">
<li>target.user.default_project_id</li>
<li>target.user.description</li>
<li>target.user.domain_id</li>
<li>target.user.enabled</li>
<li>target.user.id</li>
<li>target.user.name</li>
<li>target.user.password_expires_at</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>group:</dt>
<dd><ul class="first last simple">
<li>target.group.description</li>
<li>target.group.domain_id</li>
<li>target.group.id</li>
<li>target.group.name</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>domain:</dt>
<dd><ul class="first last simple">
<li>target.domain.description</li>
<li>target.domain.enabled</li>
<li>target.domain.id</li>
<li>target.domain.name</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>project:</dt>
<dd><ul class="first last simple">
<li>target.project.description</li>
<li>target.project.domain_id</li>
<li>target.project.enabled</li>
<li>target.project.id</li>
<li>target.project.is_domain</li>
<li>target.project.name</li>
<li>target.project.parent_id</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>token</dt>
<dd><ul class="first last simple">
<li>target.token.user_id</li>
<li>target.token.user.domain.id</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>The default policy.json file supplied provides a somewhat basic example of API
protection, and does not assume any particular use of domains. For multi-domain
configuration installations where, for example, a cloud provider wishes to
allow administration of the contents of a domain to be delegated, it is
recommended that the supplied policy.v3cloudsample.json is used as a basis for
creating a suitable production policy file. This example policy file also shows
the use of an admin_domain to allow a cloud provider to enable cloud
administrators to have wider access across the APIs.</p>
<p>A clean installation would need to perhaps start with the standard policy file,
to allow creation of the admin_domain with the first users within it. The
domain_id of the admin domain would then be obtained and could be pasted into a
modified version of policy.v3cloudsample.json which could then be enabled as
the main policy file.</p>
</div>
<div class="section" id="preparing-your-deployment">
<span id="prepare-your-deployment"></span><h2>Preparing your deployment<a class="headerlink" href="#preparing-your-deployment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-configure-keystone-conf">
<h3>Step 1: Configure keystone.conf<a class="headerlink" href="#step-1-configure-keystone-conf" title="Permalink to this headline">¶</a></h3>
<p>Ensure that your <code class="docutils literal"><span class="pre">keystone.conf</span></code> is configured to use a SQL driver:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[identity]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<p>You may also want to configure your <code class="docutils literal"><span class="pre">[database]</span></code> settings to better reflect
your environment:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[database]</span>
<span class="na">connection</span> <span class="o">=</span> <span class="s">sqlite:///keystone.db</span>
<span class="na">idle_timeout</span> <span class="o">=</span> <span class="s">200</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is important that the database that you specify be different from the
one containing your existing install.</p>
</div>
</div>
<div class="section" id="step-2-sync-your-new-empty-database">
<h3>Step 2: Sync your new, empty database<a class="headerlink" href="#step-2-sync-your-new-empty-database" title="Permalink to this headline">¶</a></h3>
<p>You should now be ready to initialize your new database without error, using:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage db_sync
</pre></div>
</div>
<p>To test this, you should now be able to start keystone:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ uwsgi --http <span class="m">127</span>.0.0.1:35357 --wsgi-file <span class="k">$(</span>which keystone-wsgi-admin<span class="k">)</span>
</pre></div>
</div>
<p>And use the OpenStack Client to list your projects (which should successfully
return an empty list from your new database):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ openstack --os-token ADMIN --os-url http://127.0.0.1:35357/v2.0/ project list
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We&#8217;re providing the default OS_TOKEN and OS_URL values from
<code class="docutils literal"><span class="pre">keystone.conf</span></code> to connect to the keystone service. If you changed those
values, or deployed keystone to a different endpoint, you will need to
change the provided command accordingly.</p>
</div>
</div>
</div>
<div class="section" id="keystone-manage">
<h2><code class="docutils literal"><span class="pre">keystone-manage</span></code><a class="headerlink" href="#keystone-manage" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">keystone-manage</span></code> is the command line tool which interacts with the Keystone
service to initialize and update data within Keystone. Generally,
<code class="docutils literal"><span class="pre">keystone-manage</span></code> is only used for operations that cannot be accomplished
with the HTTP API, such data import/export and database migrations.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<div class="section" id="general-keystone-manage-options">
<h3>General keystone-manage options:<a class="headerlink" href="#general-keystone-manage-options" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">--help</span></code> : display verbose help output.</li>
</ul>
<p>Invoking <code class="docutils literal"><span class="pre">keystone-manage</span></code> by itself will give you some usage information.</p>
<p>Available commands:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">bootstrap</span></code>: Perform the basic bootstrap process.</li>
<li><code class="docutils literal"><span class="pre">credential_migrate</span></code>: Encrypt credentials using a new primary key.</li>
<li><code class="docutils literal"><span class="pre">credential_rotate</span></code>: Rotate Fernet keys for credential encryption.</li>
<li><code class="docutils literal"><span class="pre">credential_setup</span></code>: Setup a Fernet key repository for credential encryption.</li>
<li><code class="docutils literal"><span class="pre">db_sync</span></code>: Sync the database.</li>
<li><code class="docutils literal"><span class="pre">db_version</span></code>: Print the current migration version of the database.</li>
<li><code class="docutils literal"><span class="pre">doctor</span></code>: Diagnose common problems with keystone deployments.</li>
<li><code class="docutils literal"><span class="pre">domain_config_upload</span></code>: Upload domain configuration file.</li>
<li><code class="docutils literal"><span class="pre">fernet_rotate</span></code>: Rotate keys in the Fernet key repository.</li>
<li><code class="docutils literal"><span class="pre">fernet_setup</span></code>: Setup a Fernet key repository for token encryption.</li>
<li><code class="docutils literal"><span class="pre">mapping_populate</span></code>: Prepare domain-specific LDAP backend.</li>
<li><code class="docutils literal"><span class="pre">mapping_purge</span></code>: Purge the identity mapping table.</li>
<li><code class="docutils literal"><span class="pre">mapping_engine</span></code>: Test your federation mapping rules.</li>
<li><code class="docutils literal"><span class="pre">pki_setup</span></code>: Initialize the certificates used to sign revocation lists. <strong>deprecated</strong></li>
<li><code class="docutils literal"><span class="pre">saml_idp_metadata</span></code>: Generate identity provider metadata.</li>
<li><code class="docutils literal"><span class="pre">token_flush</span></code>: Purge expired tokens.</li>
</ul>
</div>
</div>
<div class="section" id="removing-expired-tokens">
<h2>Removing Expired Tokens<a class="headerlink" href="#removing-expired-tokens" title="Permalink to this headline">¶</a></h2>
<p>In the SQL backend expired UUID tokens are not automatically removed. These
tokens can be removed with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ keystone-manage token_flush
</pre></div>
</div>
<p>It is recommended to run this command periodically with <code class="docutils literal"><span class="pre">cron</span></code> if using UUID
tokens.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It it not required to run this command at all if using Fernet tokens. Fernet
tokens are not persisted.</p>
</div>
</div>
<div class="section" id="supported-clients">
<h2>Supported clients<a class="headerlink" href="#supported-clients" title="Permalink to this headline">¶</a></h2>
<p>There are two supported clients, <a class="reference external" href="https://docs.openstack.org/developer/python-keystoneclient/">python-keystoneclient</a> project provides
python bindings and <a class="reference external" href="https://docs.openstack.org/developer/python-openstackclient/">python-openstackclient</a> provides a command line
interface.</p>
<div class="section" id="authenticating-with-a-password-via-cli">
<h3>Authenticating with a Password via CLI<a class="headerlink" href="#authenticating-with-a-password-via-cli" title="Permalink to this headline">¶</a></h3>
<p>To authenticate with keystone using a password and <code class="docutils literal"><span class="pre">python-openstackclient</span></code>,
set the following flags, note that the following user referenced below should
be granted the <code class="docutils literal"><span class="pre">admin</span></code> role.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">--os-username</span> <span class="pre">OS_USERNAME</span></code>: Name of your user</li>
<li><code class="docutils literal"><span class="pre">--os-password</span> <span class="pre">OS_PASSWORD</span></code>: Password for your user</li>
<li><code class="docutils literal"><span class="pre">--os-project-name</span> <span class="pre">OS_PROJECT_NAME</span></code>: Name of your project</li>
<li><code class="docutils literal"><span class="pre">--os-auth-url</span> <span class="pre">OS_AUTH_URL</span></code>: URL of the keystone authentication server</li>
</ul>
<p>You can also set these variables in your environment so that they do not need
to be passed as arguments each time:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">OS_USERNAME</span><span class="o">=</span>my_username
$ <span class="nb">export</span> <span class="nv">OS_PASSWORD</span><span class="o">=</span>my_password
$ <span class="nb">export</span> <span class="nv">OS_PROJECT_NAME</span><span class="o">=</span>my_project
$ <span class="nb">export</span> <span class="nv">OS_AUTH_URL</span><span class="o">=</span>http://localhost:35357/v2.0
</pre></div>
</div>
<p>For example, the commands <code class="docutils literal"><span class="pre">user</span> <span class="pre">list</span></code>, <code class="docutils literal"><span class="pre">token</span> <span class="pre">issue</span></code> and <code class="docutils literal"><span class="pre">project</span> <span class="pre">create</span></code>
can be invoked as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Using password authentication, with environment variables</span>
$ <span class="nb">export</span> <span class="nv">OS_USERNAME</span><span class="o">=</span>admin
$ <span class="nb">export</span> <span class="nv">OS_PASSWORD</span><span class="o">=</span>secret
$ <span class="nb">export</span> <span class="nv">OS_PROJECT_NAME</span><span class="o">=</span>admin
$ <span class="nb">export</span> <span class="nv">OS_AUTH_URL</span><span class="o">=</span>http://localhost:35357/v2.0
$ openstack user list
$ openstack project create demo
$ openstack token issue

<span class="c1"># Using password authentication, with flags</span>
$ openstack --os-username<span class="o">=</span>admin --os-password<span class="o">=</span>secret --os-project-name<span class="o">=</span>admin --os-auth-url<span class="o">=</span>http://localhost:35357/v2.0 user list
$ openstack --os-username<span class="o">=</span>admin --os-password<span class="o">=</span>secret --os-project-name<span class="o">=</span>admin --os-auth-url<span class="o">=</span>http://localhost:35357/v2.0 project create demo
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-an-ldap-server">
<h2>Using an LDAP server<a class="headerlink" href="#using-an-ldap-server" title="Permalink to this headline">¶</a></h2>
<p>As an alternative to the SQL Database backing store, keystone can use a
directory server to provide the Identity service. An example schema for
OpenStack would look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>dn: dc=openstack,dc=org
dc: openstack
objectClass: dcObject
objectClass: organizationalUnit
ou: openstack

dn: ou=Groups,dc=openstack,dc=org
objectClass: top
objectClass: organizationalUnit
ou: groups

dn: ou=Users,dc=openstack,dc=org
objectClass: top
objectClass: organizationalUnit
ou: users
</pre></div>
</div>
<p>The corresponding entries in the keystone configuration file are:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">ldap://localhost</span>
<span class="na">user</span> <span class="o">=</span> <span class="s">dc=Manager,dc=openstack,dc=org</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">badpassword</span>
<span class="na">suffix</span> <span class="o">=</span> <span class="s">dc=openstack,dc=org</span>

<span class="na">user_tree_dn</span> <span class="o">=</span> <span class="s">ou=Users,dc=openstack,dc=org</span>
<span class="na">user_objectclass</span> <span class="o">=</span> <span class="s">inetOrgPerson</span>
</pre></div>
</div>
<p>The default object classes and attributes are intentionally simplistic. They
reflect the common standard objects according to the LDAP RFCs. However, in a
live deployment, the correct attributes can be overridden to support a
preexisting, more complex schema. For example, in the user object, the
objectClass posixAccount from RFC2307 is very common. If this is the underlying
objectclass, then the <em>uid</em> field should probably be <em>uidNumber</em> and <em>username</em>
field either <em>uid</em> or <em>cn</em>. To change these two fields, the corresponding
entries in the keystone configuration file are:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">user_id_attribute</span> <span class="o">=</span> <span class="s">uidNumber</span>
<span class="na">user_name_attribute</span> <span class="o">=</span> <span class="s">cn</span>
</pre></div>
</div>
<p>There are some configuration options for filtering users, tenants and roles, if
the backend is providing too much output, in such case the configuration will
look like:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">user_filter</span> <span class="o">=</span> <span class="s">(memberof=CN=openstack-users,OU=workgroups,DC=openstack,DC=org)</span>
</pre></div>
</div>
<p>In case that the directory server does not have an attribute enabled of type
boolean for the user, there is several configuration parameters that can be
used to extract the value from an integer attribute like in Active Directory:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">user_enabled_attribute</span> <span class="o">=</span> <span class="s">userAccountControl</span>
<span class="na">user_enabled_mask</span>      <span class="o">=</span> <span class="s">2</span>
<span class="na">user_enabled_default</span>   <span class="o">=</span> <span class="s">512</span>
</pre></div>
</div>
<p>In this case the attribute is an integer and the enabled attribute is listed in
bit 1, so the if the mask configured <em>user_enabled_mask</em> is different from 0,
it gets the value from the field <em>user_enabled_attribute</em> and it makes an ADD
operation with the value indicated on <em>user_enabled_mask</em> and if the value
matches the mask then the account is disabled.</p>
<p>It also saves the value without mask to the user identity in the attribute
<em>enabled_nomask</em>. This is needed in order to set it back in case that we need
to change it to enable/disable a user because it contains more information than
the status like password expiration. Last setting <em>user_enabled_mask</em> is needed
in order to create a default value on the integer attribute (512 = NORMAL
ACCOUNT on AD)</p>
<p>In case of Active Directory the classes and attributes could not match the
specified classes in the LDAP module so you can configure them like:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">user_objectclass</span>           <span class="o">=</span> <span class="s">person</span>
<span class="na">user_id_attribute</span>          <span class="o">=</span> <span class="s">cn</span>
<span class="na">user_name_attribute</span>        <span class="o">=</span> <span class="s">cn</span>
<span class="na">user_description_attribute</span> <span class="o">=</span> <span class="s">displayName</span>
<span class="na">user_mail_attribute</span>        <span class="o">=</span> <span class="s">mail</span>
<span class="na">user_enabled_attribute</span>     <span class="o">=</span> <span class="s">userAccountControl</span>
<span class="na">user_enabled_mask</span>          <span class="o">=</span> <span class="s">2</span>
<span class="na">user_enabled_default</span>       <span class="o">=</span> <span class="s">512</span>
<span class="na">user_attribute_ignore</span>      <span class="o">=</span> <span class="s">tenant_id,tenants</span>
</pre></div>
</div>
<div class="section" id="debugging-ldap">
<h3>Debugging LDAP<a class="headerlink" href="#debugging-ldap" title="Permalink to this headline">¶</a></h3>
<p>For additional information on LDAP connections, performance (such as slow
response time), or field mappings, setting <code class="docutils literal"><span class="pre">debug_level</span></code> in the [ldap]
section is used to enable debugging:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">debug_level</span> <span class="o">=</span> <span class="s">4095</span>
</pre></div>
</div>
<p>This setting in turn sets OPT_DEBUG_LEVEL in the underlying python library.
This field is a bit mask (integer), and the possible flags are documented in
the OpenLDAP manpages. Commonly used values include 255 and 4095, with 4095
being more verbose.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Enabling <code class="docutils literal"><span class="pre">debug_level</span></code> will negatively impact performance.</p>
</div>
</div>
<div class="section" id="enabled-emulation">
<h3>Enabled Emulation<a class="headerlink" href="#enabled-emulation" title="Permalink to this headline">¶</a></h3>
<p>Some directory servers do not provide any enabled attribute. For these servers,
the <code class="docutils literal"><span class="pre">user_enabled_emulation</span></code> attribute has been created. It is enabled by
setting the respective flags to True. Then the attribute
<code class="docutils literal"><span class="pre">user_enabled_emulation_dn</span></code> may be set to specify how the enabled users are
selected. This attribute works by using a <code class="docutils literal"><span class="pre">groupOfNames</span></code> entry and adding
whichever users or that you want enabled to the respective group with the
<code class="docutils literal"><span class="pre">member</span></code> attribute. For example, this will mark any user who is a member of
<code class="docutils literal"><span class="pre">enabled_users</span></code> as enabled:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">user_enabled_emulation</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">user_enabled_emulation_dn</span> <span class="o">=</span> <span class="s">cn=enabled_users,cn=groups,dc=openstack,dc=org</span>
</pre></div>
</div>
<p>The default values for user enabled emulation DN is
<code class="docutils literal"><span class="pre">cn=enabled_users,$user_tree_dn</span></code>.</p>
<p>If a different LDAP schema is used for group membership, it is possible to use
the <code class="docutils literal"><span class="pre">group_objectclass</span></code> and <code class="docutils literal"><span class="pre">group_member_attribute</span></code> attributes to
determine membership in the enabled emulation group by setting the
<code class="docutils literal"><span class="pre">user_enabled_emulation_use_group_config</span></code> attribute to True.</p>
</div>
<div class="section" id="secure-connection">
<h3>Secure Connection<a class="headerlink" href="#secure-connection" title="Permalink to this headline">¶</a></h3>
<p>If you are using a directory server to provide the Identity service, it is
strongly recommended that you utilize a secure connection from keystone to the
directory server. In addition to supporting LDAP, keystone also provides
Transport Layer Security (TLS) support. There are some basic configuration
options for enabling TLS, identifying a single file or directory that contains
certificates for all the Certificate Authorities that the keystone LDAP client
will recognize, and declaring what checks the client should perform on server
certificates. This functionality can easily be configured as follows:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">use_tls</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">tls_cacertfile</span> <span class="o">=</span> <span class="s">/etc/keystone/ssl/certs/cacert.pem</span>
<span class="na">tls_cacertdir</span> <span class="o">=</span> <span class="s">/etc/keystone/ssl/certs/</span>
<span class="na">tls_req_cert</span> <span class="o">=</span> <span class="s">demand</span>
</pre></div>
</div>
<p>A few points worth mentioning regarding the above options. If both
<code class="docutils literal"><span class="pre">tls_cacertfile</span></code> and <code class="docutils literal"><span class="pre">tls_cacertdir</span></code> are set then tls_cacertfile will be
used and <code class="docutils literal"><span class="pre">tls_cacertdir</span></code> is ignored. Furthermore, valid options for
<code class="docutils literal"><span class="pre">tls_req_cert</span></code> are <code class="docutils literal"><span class="pre">demand</span></code>, <code class="docutils literal"><span class="pre">never</span></code>, and <code class="docutils literal"><span class="pre">allow</span></code>. These correspond to
the standard options permitted by the <code class="docutils literal"><span class="pre">TLS_REQCERT</span></code> TLS option.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If unable to connect to LDAP via keystone (more specifically, if a
<em>SERVER DOWN</em> error is seen), set the <code class="docutils literal"><span class="pre">TLS_CACERT</span></code> in
<code class="docutils literal"><span class="pre">/etc/ldap/ldap.conf</span></code> to the same value specified in the
<code class="docutils literal"><span class="pre">[ldap]</span> <span class="pre">tls_certificate</span></code> section of <code class="docutils literal"><span class="pre">keystone.conf</span></code>.</p>
</div>
</div>
<div class="section" id="read-only-ldap">
<h3>Read Only LDAP<a class="headerlink" href="#read-only-ldap" title="Permalink to this headline">¶</a></h3>
<p>Many environments typically have user and group information in directories that
are accessible by LDAP. This information is for read-only use in a wide array
of applications. Prior to the Havana release, we could not deploy keystone with
read-only directories as backends because keystone also needed to store
information such as projects, roles, domains and role assignments into the
directories in conjunction with reading user and group information.</p>
<p>Keystone now provides an option whereby these read-only directories can be
easily integrated as it now enables its identity entities (which comprises
users, groups, and group memberships) to be served out of directories while
resource (which comprises projects and domains), assignment and role
entities are to be served from different keystone backends (i.e. SQL). To
enable this option, you must have the following <code class="docutils literal"><span class="pre">keystone.conf</span></code> options set:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[identity]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">ldap</span>

<span class="k">[resource]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>

<span class="k">[assignment]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>

<span class="k">[role]</span>
<span class="na">driver</span> <span class="o">=</span> <span class="s">sql</span>
</pre></div>
</div>
<p>With the above configuration, keystone will only lookup identity related
information such users, groups, and group membership from the directory, while
resources, roles and assignment related information will be provided by the SQL
backend. Also note that if there is an LDAP Identity, and no resource,
assignment or role backend is specified, they will default to LDAP. Although
this may seem counter intuitive, it is provided for backwards compatibility.
Nonetheless, the explicit option will always override the implicit option, so
specifying the options as shown above will always be correct.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While having identity related information backed by LDAP while other
information is backed by SQL is a supported configuration, as shown above;
the opposite is not true. If either resource or assignment drivers are
configured for LDAP, then Identity must also be configured for LDAP.</p>
</div>
</div>
<div class="section" id="connection-pooling">
<h3>Connection Pooling<a class="headerlink" href="#connection-pooling" title="Permalink to this headline">¶</a></h3>
<p>Various LDAP backends in keystone use a common LDAP module to interact with
LDAP data. By default, a new connection is established for each LDAP operation.
This can become highly expensive when TLS support is enabled, which is a likely
configuration in an enterprise setup. Reuse of connectors from a connection
pool drastically reduces overhead of initiating a new connection for every LDAP
operation.</p>
<p>Keystone provides connection pool support via configuration. This will keep
LDAP connectors alive and reused for subsequent LDAP operations. The connection
lifespan is configurable as other pooling specific attributes.</p>
<p>In the LDAP identity driver, keystone authenticates end users via an LDAP bind
with the user&#8217;s DN and provided password. This kind of authentication bind
can fill up the pool pretty quickly, so a separate pool is provided for end
user authentication bind calls. If a deployment does not want to use a pool for
those binds, then it can disable pooling selectively by setting
<code class="docutils literal"><span class="pre">use_auth_pool</span></code> to false. If a deployment wants to use a pool for those
authentication binds, then <code class="docutils literal"><span class="pre">use_auth_pool</span></code> needs to be set to true. For the
authentication pool, a different pool size (<code class="docutils literal"><span class="pre">auth_pool_size</span></code>) and connection
lifetime (<code class="docutils literal"><span class="pre">auth_pool_connection_lifetime</span></code>) can be specified. With an enabled
authentication pool, its connection lifetime should be kept short so that the
pool frequently re-binds the connection with the provided credentials and works
reliably in the end user password change case. When <code class="docutils literal"><span class="pre">use_pool</span></code> is false
(disabled), then the authentication pool configuration is also not used.</p>
<p>Connection pool configuration is part of the <code class="docutils literal"><span class="pre">[ldap]</span></code> configuration section:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="c1"># Enable LDAP connection pooling for queries to the LDAP server. There is</span>
<span class="c1"># typically no reason to disable this. (boolean value)</span>
<span class="na">use_pool</span> <span class="o">=</span> <span class="s">true</span>

<span class="c1"># The size of the LDAP connection pool. This option has no effect unless</span>
<span class="c1"># `[ldap] use_pool` is also enabled. (integer value)</span>
<span class="c1"># Minimum value: 1</span>
<span class="na">pool_size</span> <span class="o">=</span> <span class="s">10</span>

<span class="c1"># The maximum number of times to attempt reconnecting to the LDAP server before</span>
<span class="c1"># aborting. A value of zero prevents retries. This option has no effect unless</span>
<span class="c1"># `[ldap] use_pool` is also enabled. (integer value)</span>
<span class="c1"># Minimum value: 0</span>
<span class="na">pool_retry_max</span> <span class="o">=</span> <span class="s">3</span>

<span class="c1"># The number of seconds to wait before attempting to reconnect to the LDAP</span>
<span class="c1"># server. This option has no effect unless `[ldap] use_pool` is also enabled.</span>
<span class="c1"># (floating point value)</span>
<span class="na">pool_retry_delay</span> <span class="o">=</span> <span class="s">0.1</span>

<span class="c1"># The connection timeout to use with the LDAP server. A value of `-1` means</span>
<span class="c1"># that connections will never timeout. This option has no effect unless `[ldap]</span>
<span class="c1"># use_pool` is also enabled. (integer value)</span>
<span class="c1"># Minimum value: -1</span>
<span class="na">pool_connection_timeout</span> <span class="o">=</span> <span class="s">-1</span>

<span class="c1"># The maximum connection lifetime to the LDAP server in seconds. When this</span>
<span class="c1"># lifetime is exceeded, the connection will be unbound and removed from the</span>
<span class="c1"># connection pool. This option has no effect unless `[ldap] use_pool` is also</span>
<span class="c1"># enabled. (integer value)</span>
<span class="c1"># Minimum value: 1</span>
<span class="na">pool_connection_lifetime</span> <span class="o">=</span> <span class="s">600</span>

<span class="c1"># Enable LDAP connection pooling for end user authentication. There is</span>
<span class="c1"># typically no reason to disable this. (boolean value)</span>
<span class="na">use_auth_pool</span> <span class="o">=</span> <span class="s">true</span>

<span class="c1"># The size of the connection pool to use for end user authentication. This</span>
<span class="c1"># option has no effect unless `[ldap] use_auth_pool` is also enabled. (integer</span>
<span class="c1"># value)</span>
<span class="c1"># Minimum value: 1</span>
<span class="na">auth_pool_size</span> <span class="o">=</span> <span class="s">100</span>

<span class="c1"># The maximum end user authentication connection lifetime to the LDAP server in</span>
<span class="c1"># seconds. When this lifetime is exceeded, the connection will be unbound and</span>
<span class="c1"># removed from the connection pool. This option has no effect unless `[ldap]</span>
<span class="c1"># use_auth_pool` is also enabled. (integer value)</span>
<span class="c1"># Minimum value: 1</span>
<span class="na">auth_pool_connection_lifetime</span> <span class="o">=</span> <span class="s">60</span>
</pre></div>
</div>
</div>
<div class="section" id="specifying-multiple-ldap-servers">
<h3>Specifying Multiple LDAP servers<a class="headerlink" href="#specifying-multiple-ldap-servers" title="Permalink to this headline">¶</a></h3>
<p>Multiple LDAP server URLs can be provided to keystone to provide
high-availability support for a single LDAP backend. To specify multiple LDAP
servers, simply change the <code class="docutils literal"><span class="pre">url</span></code> option in the <code class="docutils literal"><span class="pre">[ldap]</span></code> section. The new
option should list the different servers, each separated by a comma. For
example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ldap]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">&quot;ldap://localhost,ldap://backup.localhost&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="credential-encryption">
<h2>Credential Encryption<a class="headerlink" href="#credential-encryption" title="Permalink to this headline">¶</a></h2>
<p>As of the Newton release, keystone encrypts all credentials stored in the
default <code class="docutils literal"><span class="pre">sql</span></code> backend. Credentials are encrypted with the same mechanism used
to encrypt Fernet tokens, <code class="docutils literal"><span class="pre">fernet</span></code>. Keystone provides only one type of
credential encryption but the encryption provider is pluggable in the event
you wish to supply a custom implementation.</p>
<p>This document details how credential encryption works, how to migrate existing
credentials in a deployment, and how to manage encryption keys for credentials.</p>
<div class="section" id="configuring-credential-encryption">
<h3>Configuring credential encryption<a class="headerlink" href="#configuring-credential-encryption" title="Permalink to this headline">¶</a></h3>
<p>The configuration for credential encryption is straightforward. There are only
two configuration options needed:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[credential]</span>
<span class="na">provider</span> <span class="o">=</span> <span class="s">fernet</span>
<span class="na">key_repository</span> <span class="o">=</span> <span class="s">/etc/keystone/credential-keys/</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">[credential]</span> <span class="pre">provider</span></code> defaults to the only option supplied by keystone,
<code class="docutils literal"><span class="pre">fernet</span></code>. There is no reason to change this option unless you wish to provide
a custom credential encryption implementation. The <code class="docutils literal"><span class="pre">[credential]</span>
<span class="pre">key_repository</span></code> location is a requirement of using <code class="docutils literal"><span class="pre">fernet</span></code> but will default
to the <code class="docutils literal"><span class="pre">/etc/keystone/credential-keys/</span></code> directory. Both <code class="docutils literal"><span class="pre">[credential]</span>
<span class="pre">key_repository</span></code> and <code class="docutils literal"><span class="pre">[fernet_tokens]</span> <span class="pre">key_repository</span></code> define locations for
keys used to encrypt things. One holds the keys to encrypt and decrypt
credentials and the other holds keys to encrypt and decrypt tokens. It is
imperative that these repositories are managed separately and they must not
share keys. Meaning they cannot share the same directory path. The
<code class="docutils literal"><span class="pre">[credential]</span> <span class="pre">key_repository</span></code> is only allowed to have three keys. This is not
configurable and allows for credentials to be re-encrypted periodically with a
new encryption key for the sake of security.</p>
</div>
<div class="section" id="how-credential-encryption-works">
<h3>How credential encryption works<a class="headerlink" href="#how-credential-encryption-works" title="Permalink to this headline">¶</a></h3>
<p>The implementation of this feature did not change any existing credential API
contracts. All changes are transparent to the user unless you&#8217;re inspecting the
credential backend directly.</p>
<p>When creating a credential, keystone will encrypt the <code class="docutils literal"><span class="pre">blob</span></code> attribute before
persisting it to the backend. Keystone will also store a hash of the key that
was used to encrypt the information in that credential. Since Fernet is used to
encrypt credentials, a key repository consists of multiple keys. Keeping track
of which key was used to encrypt each credential is an important part of
encryption key management. Why this is important is detailed later in the
<cite>Encryption key management</cite> section.</p>
<p>When updating an existing credential&#8217;s <code class="docutils literal"><span class="pre">blob</span></code> attribute, keystone will encrypt
the new <code class="docutils literal"><span class="pre">blob</span></code> and update the key hash.</p>
<p>When listing or showing credentials, all <code class="docutils literal"><span class="pre">blob</span></code> attributes are decrypted in
the response. Neither the cipher text, nor the hash of the key used to encrypt
the <code class="docutils literal"><span class="pre">blob</span></code> are exposed through the API. Furthermore, the key is only used
internally to keystone.</p>
</div>
<div class="section" id="encrypting-existing-credentials">
<h3>Encrypting existing credentials<a class="headerlink" href="#encrypting-existing-credentials" title="Permalink to this headline">¶</a></h3>
<p>When upgrading a Mitaka deployment to Newton, three database migrations will
ensure all credentials are encrypted. The process is as follows:</p>
<ol class="arabic simple">
<li>An additive schema change is made to create the new <code class="docutils literal"><span class="pre">encrypted_blob</span></code> and
<code class="docutils literal"><span class="pre">key_hash</span></code> columns in the existing <code class="docutils literal"><span class="pre">credential</span></code> table using
<code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">db_sync</span> <span class="pre">--expand</span></code>.</li>
<li>A data migration will loop through all existing credentials, encrypt each
<code class="docutils literal"><span class="pre">blob</span></code> and store the result in the new <code class="docutils literal"><span class="pre">encrypted_blob</span></code> column. The hash
of the key used is also written to the <code class="docutils literal"><span class="pre">key_hash</span></code> column for that specific
credential. This step is done using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">db_sync</span> <span class="pre">--migrate</span></code>.</li>
<li>A contractive schema will remove the <code class="docutils literal"><span class="pre">blob</span></code> column that held the plain
text representations of the credential using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">db_sync</span>
<span class="pre">--contract</span></code>. This should only be done after all nodes in the deployment are
running Newton. If any Mitaka nodes are running after the database is
contracted, they won&#8217;t be able to read credentials since they are looking
for the <code class="docutils literal"><span class="pre">blob</span></code> column that no longer exists.</li>
</ol>
<p>If performing a rolling upgrade, please note that a limited service outage will
take affect during this migration. When the migration is in place, credentials
will become read-only until the database is contracted. After the contract
phase is complete, credentials will be writeable to the backend. A
<code class="docutils literal"><span class="pre">[credential]</span> <span class="pre">key_repository</span></code> location must be specified through
configuration and bootstrapped with keys using <code class="docutils literal"><span class="pre">keystone-manage</span>
<span class="pre">credential_setup</span></code> prior to migrating any existing credentials. If a new key
repository isn&#8217;t setup using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_setup</span></code> keystone will
assume a null key to encrypt and decrypt credentials until a proper key
repository is present. The null key is a key consisting of all null bytes and
its only purpose is to ease the upgrade process from Mitaka to Newton. It is
highly recommended that the null key isn&#8217;t used. It is no more secure than
storing credentials in plain text. If the null key is used, you should migrate
to a proper key repository using <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_setup</span></code> and
<code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_migrate</span></code>.</p>
</div>
<div class="section" id="encryption-key-management">
<h3>Encryption key management<a class="headerlink" href="#encryption-key-management" title="Permalink to this headline">¶</a></h3>
<p>Key management of <code class="docutils literal"><span class="pre">[credential]</span> <span class="pre">key_repository</span></code> is handled with three
<code class="docutils literal"><span class="pre">keystone-manage</span></code> commands:</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_setup</span></code></li>
<li><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_rotate</span></code></li>
<li><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_migrate</span></code></li>
</ol>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_setup</span></code> will populate <code class="docutils literal"><span class="pre">[credential]</span>
<span class="pre">key_repository</span></code> with new encryption keys. This must be done in order for
proper credential encryption to work, with the exception of the null key. This
step should only be done once.</p>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_rotate</span></code> will create and rotate a new encryption
key in the <code class="docutils literal"><span class="pre">[credential]</span> <span class="pre">key_repository</span></code>. This will only be done if all
credential key hashes match the hash of the current primary key. If any
credential has been encrypted with an older key, or secondary key, the rotation
will fail. Failing the rotation is necessary to prevent overrotation, which
would leave some credentials indecipherable since the key used to encrypt it
no longer exists. If this step fails, it is possible to forcibly re-key all
credentials using the same primary key with <code class="docutils literal"><span class="pre">keystone-manage</span>
<span class="pre">credential_migrate</span></code>.</p>
<p><code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">credential_migrate</span></code> will check the backend for credentials
whose key hash doesn&#8217;t match the hash of the current primary key. Any
credentials with a key hash mismatching the current primary key will be
re-encrypted with the current primary key. The new cipher text and key hash
will be updated in the backend.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Configuring Keystone</a><ul>
<li><a class="reference internal" href="#config-files">Config Files</a><ul>
<li><a class="reference internal" href="#sample-configuration-files">Sample Configuration Files</a></li>
<li><a class="reference internal" href="#keystone-conf-sections"><code class="docutils literal"><span class="pre">keystone.conf</span></code> sections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bootstrapping-keystone-with-keystone-manage-bootstrap">Bootstrapping Keystone with <code class="docutils literal"><span class="pre">keystone-manage</span> <span class="pre">bootstrap</span></code></a><ul>
<li><a class="reference internal" href="#setting-up-projects-users-and-roles">Setting up projects, users, and roles</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bootstrapping-keystone-with-admin-token">Bootstrapping Keystone with <code class="docutils literal"><span class="pre">ADMIN_TOKEN</span></code></a><ul>
<li><a class="reference internal" href="#admin-token">Admin Token</a></li>
<li><a class="reference internal" href="#id1">Setting up projects, users, and roles</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-up-other-openstack-services">Setting up other OpenStack Services</a><ul>
<li><a class="reference internal" href="#creating-service-users">Creating Service Users</a></li>
<li><a class="reference internal" href="#defining-services">Defining Services</a></li>
</ul>
</li>
<li><a class="reference internal" href="#identity-sources">Identity sources</a><ul>
<li><a class="reference internal" href="#domain-specific-drivers">Domain-specific Drivers</a></li>
<li><a class="reference internal" href="#public-id-generators">Public ID Generators</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authentication-plugins">Authentication Plugins</a><ul>
<li><a class="reference internal" href="#how-to-implement-an-authentication-plugin">How to Implement an Authentication Plugin</a></li>
</ul>
</li>
<li><a class="reference internal" href="#token-drivers-and-providers">Token Drivers and Providers</a><ul>
<li><a class="reference internal" href="#token-persistence-driver">Token Persistence Driver</a></li>
<li><a class="reference internal" href="#token-provider">Token Provider</a><ul>
<li><a class="reference internal" href="#uuid-or-fernet">UUID or Fernet?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#encryption-keys-for-fernet-tokens">Encryption Keys for Fernet Tokens</a></li>
<li><a class="reference internal" href="#caching-layer">Caching Layer</a><ul>
<li><a class="reference internal" href="#cache-configuration-section"><code class="docutils literal"><span class="pre">[cache]</span></code> configuration section</a></li>
</ul>
</li>
<li><a class="reference internal" href="#certificates-for-pki">Certificates for PKI</a><ul>
<li><a class="reference internal" href="#signing-certificate-issued-by-external-ca">Signing Certificate Issued by External CA</a></li>
<li><a class="reference internal" href="#request-signing-certificate-from-external-ca">Request Signing Certificate from External CA</a></li>
<li><a class="reference internal" href="#install-external-signing-certificate">Install External Signing Certificate</a></li>
<li><a class="reference internal" href="#generating-a-signing-certificate-using-pki-setup">Generating a Signing Certificate using <code class="docutils literal"><span class="pre">pki_setup</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#service-catalog">Service Catalog</a><ul>
<li><a class="reference internal" href="#sql-based-service-catalog-sql-catalog">SQL-based Service Catalog (<code class="docutils literal"><span class="pre">sql.Catalog</span></code>)</a></li>
<li><a class="reference internal" href="#file-based-service-catalog-templated-catalog">File-based Service Catalog (<code class="docutils literal"><span class="pre">templated.Catalog</span></code>)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#endpoint-filtering">Endpoint Filtering</a></li>
<li><a class="reference internal" href="#endpoint-policy">Endpoint Policy</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
<li><a class="reference internal" href="#ssl">SSL</a></li>
<li><a class="reference internal" href="#oauth1-1-0a">OAuth1 1.0a</a></li>
<li><a class="reference internal" href="#revocation-events">Revocation Events</a></li>
<li><a class="reference internal" href="#token-binding">Token Binding</a></li>
<li><a class="reference internal" href="#limiting-list-return-size">Limiting list return size</a></li>
<li><a class="reference internal" href="#url-safe-naming-of-projects-and-domains">URL safe naming of projects and domains</a></li>
<li><a class="reference internal" href="#health-check-middleware">Health Check middleware</a></li>
<li><a class="reference internal" href="#api-protection-with-role-based-access-control-rbac">API protection with Role Based Access Control (RBAC)</a></li>
<li><a class="reference internal" href="#preparing-your-deployment">Preparing your deployment</a><ul>
<li><a class="reference internal" href="#step-1-configure-keystone-conf">Step 1: Configure keystone.conf</a></li>
<li><a class="reference internal" href="#step-2-sync-your-new-empty-database">Step 2: Sync your new, empty database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#keystone-manage"><code class="docutils literal"><span class="pre">keystone-manage</span></code></a><ul>
<li><a class="reference internal" href="#general-keystone-manage-options">General keystone-manage options:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#removing-expired-tokens">Removing Expired Tokens</a></li>
<li><a class="reference internal" href="#supported-clients">Supported clients</a><ul>
<li><a class="reference internal" href="#authenticating-with-a-password-via-cli">Authenticating with a Password via CLI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-an-ldap-server">Using an LDAP server</a><ul>
<li><a class="reference internal" href="#debugging-ldap">Debugging LDAP</a></li>
<li><a class="reference internal" href="#enabled-emulation">Enabled Emulation</a></li>
<li><a class="reference internal" href="#secure-connection">Secure Connection</a></li>
<li><a class="reference internal" href="#read-only-ldap">Read Only LDAP</a></li>
<li><a class="reference internal" href="#connection-pooling">Connection Pooling</a></li>
<li><a class="reference internal" href="#specifying-multiple-ldap-servers">Specifying Multiple LDAP servers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#credential-encryption">Credential Encryption</a><ul>
<li><a class="reference internal" href="#configuring-credential-encryption">Configuring credential encryption</a></li>
<li><a class="reference internal" href="#how-credential-encryption-works">How credential encryption works</a></li>
<li><a class="reference internal" href="#encrypting-existing-credentials">Encrypting existing credentials</a></li>
<li><a class="reference internal" href="#encryption-key-management">Encryption key management</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="community.html"
                                  title="previous chapter">Getting Involved</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="federation/federated_identity.html"
                                  title="next chapter">Federated Identity</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/keystone
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/configuration.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="federation/federated_identity.html" title="Federated Identity"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="community.html" title="Getting Involved"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">keystone 11.0.0.0rc2.dev29 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012, OpenStack Foundation.
      Last updated on &#39;Fri Feb 10 22:47:54 2017, commit 9c47495&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/keystone");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>