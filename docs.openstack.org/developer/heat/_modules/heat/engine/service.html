<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.service &mdash; heat 8.0.0.0rc2.dev38 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '8.0.0.0rc2.dev38',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="heat 8.0.0.0rc2.dev38 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heat.engine.service</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">import</span> <span class="nn">eventlet</span>
<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_context</span> <span class="kn">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">oslo_context</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="nn">oslo_messaging</span> <span class="kn">as</span> <span class="nn">messaging</span>
<span class="kn">from</span> <span class="nn">oslo_serialization</span> <span class="kn">import</span> <span class="n">jsonutils</span>
<span class="kn">from</span> <span class="nn">oslo_service</span> <span class="kn">import</span> <span class="n">service</span>
<span class="kn">from</span> <span class="nn">oslo_service</span> <span class="kn">import</span> <span class="n">threadgroup</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">from</span> <span class="nn">osprofiler</span> <span class="kn">import</span> <span class="n">profiler</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">webob</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">environment_format</span> <span class="k">as</span> <span class="n">env_fmt</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">environment_util</span> <span class="k">as</span> <span class="n">env_util</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">messaging</span> <span class="k">as</span> <span class="n">rpc_messaging</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">policy</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">service_utils</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">attributes</span>
<span class="kn">from</span> <span class="nn">heat.engine.cfn</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">cfntemplate</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">clients</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">heat.engine.hot</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">hot_functions</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">parameter_groups</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">properties</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">service_software_config</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">service_stack_watch</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">stack_lock</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">templatem</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">watchrule</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">event</span> <span class="k">as</span> <span class="n">event_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">service_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">snapshot</span> <span class="k">as</span> <span class="n">snapshot_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">watch_data</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">watch_rule</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">rpc_api</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">worker_api</span> <span class="k">as</span> <span class="n">rpc_worker_api</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;engine_life_check_timeout&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;max_resources_per_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;max_stacks_per_tenant&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;enable_stack_abandon&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;enable_stack_adopt&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;convergence_engine&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>

<span class="c1"># Time to wait for a stack to stop when cancelling running threads, before</span>
<span class="c1"># giving up on being able to start a delete.</span>
<span class="n">STOP_STACK_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ThreadGroupManager"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager">[docs]</a><span class="k">class</span> <span class="nc">ThreadGroupManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadGroupManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_queues</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Create dummy service task, because when there is nothing queued</span>
        <span class="c1"># on self.tg the process exits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service_task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_service_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dummy task which gets queued on the service.Service threadgroup.</span>

<span class="sd">        Without this, service.Service sees nothing running i.e has nothing to</span>
<span class="sd">        wait() on, so the process exits. This could also be used to trigger</span>
<span class="sd">        periodic non-stack-specific housekeeping tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_serialize_profile_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">trace_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">prof</span><span class="p">:</span>
            <span class="n">trace_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;hmac_key&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">hmac_key</span><span class="p">,</span>
                <span class="s2">&quot;base_id&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">get_base_id</span><span class="p">(),</span>
                <span class="s2">&quot;parent_id&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">trace_info</span>

    <span class="k">def</span> <span class="nf">_start_with_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">profiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="o">**</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnxt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cnxt</span><span class="o">.</span><span class="n">update_store</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadGroupManager.start"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the given method in a sub-thread.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">log_exceptions</span><span class="p">(</span><span class="n">gt</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gt</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Unhandled error in asynchronous task&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">req_cnxt</span> <span class="o">=</span> <span class="n">oslo_context</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span>
        <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_with_trace</span><span class="p">,</span> <span class="n">req_cnxt</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_profile_info</span><span class="p">(),</span>
                                              <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">log_exceptions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">th</span></div>

<div class="viewcode-block" id="ThreadGroupManager.start_with_lock"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start_with_lock">[docs]</a>    <span class="k">def</span> <span class="nf">start_with_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the method in sub-thread after acquiring the stack lock.</span>

<span class="sd">        Release the lock when the thread finishes.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param stack: Stack to be operated on</span>
<span class="sd">        :type stack: heat.engine.parser.Stack</span>
<span class="sd">        :param engine_id: The UUID of the engine/worker acquiring the lock</span>
<span class="sd">        :param func: Callable to be invoked in sub-thread</span>
<span class="sd">        :type func: function or instancemethod</span>
<span class="sd">        :param args: Args to be passed to func</span>
<span class="sd">        :param kwargs: Keyword-args to be passed to func.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span>
                                               <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">th</span></div>

<div class="viewcode-block" id="ThreadGroupManager.start_with_acquired_lock"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start_with_acquired_lock">[docs]</a>    <span class="k">def</span> <span class="nf">start_with_acquired_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the given method in a sub-thread with an existing stack lock.</span>

<span class="sd">        Release the provided lock when the thread finishes.</span>

<span class="sd">        :param stack: Stack to be operated on</span>
<span class="sd">        :type stack: heat.engine.parser.Stack</span>
<span class="sd">        :param lock: The acquired stack lock</span>
<span class="sd">        :type lock: heat.engine.stack_lock.StackLock</span>
<span class="sd">        :param func: Callable to be invoked in sub-thread</span>
<span class="sd">        :type func: function or instancemethod</span>
<span class="sd">        :param args: Args to be passed to func</span>
<span class="sd">        :param kwargs: Keyword-args to be passed to func</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">gt</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Callback function that will be passed to GreenThread.link().</span>

<span class="sd">            Persist the stack state to COMPLETE and FAILED close to</span>
<span class="sd">            releasing the lock to avoid race conditions.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span>
                <span class="ow">and</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
                                         <span class="n">stack</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span>
                                         <span class="n">stack</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">)):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">persist_state_and_release_lock</span><span class="p">(</span><span class="n">lock</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="c1"># Link to self to allow the stack to run tasks</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">th</span></div>

<div class="viewcode-block" id="ThreadGroupManager.add_timer"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.add_timer">[docs]</a>    <span class="k">def</span> <span class="nf">add_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define a periodic task in the stack threadgroups.</span>

<span class="sd">        The task is run in a separate greenthread.</span>

<span class="sd">        Periodicity is cfg.CONF.periodic_interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span>
                                        <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadGroupManager.add_msg_queue"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.add_msg_queue">[docs]</a>    <span class="k">def</span> <span class="nf">add_msg_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_queues</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg_queue</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadGroupManager.remove_msg_queue"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.remove_msg_queue">[docs]</a>    <span class="k">def</span> <span class="nf">remove_msg_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_queues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">msg_queue</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_msg_queue</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadGroupManager.stop_timers"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.stop_timers">[docs]</a>    <span class="k">def</span> <span class="nf">stop_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">stop_timers</span><span class="p">()</span></div>

<div class="viewcode-block" id="ThreadGroupManager.stop"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop any active threads on a stack.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg_queues</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">threadgroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">threads</span><span class="p">[:]</span>

            <span class="n">threadgroup</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">graceful</span><span class="p">)</span>
            <span class="n">threadgroup</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Wait for link()ed functions (i.e. lock release)</span>
            <span class="n">links_done</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">th</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">mark_done</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">th</span><span class="p">):</span>
                <span class="n">links_done</span><span class="p">[</span><span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">mark_done</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">links_done</span><span class="p">)):</span>
                <span class="n">eventlet</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span></div>

<div class="viewcode-block" id="ThreadGroupManager.send"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.ThreadGroupManager.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">msg_queue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_queues</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">msg_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div></div>


<span class="nd">@profiler.trace_cls</span><span class="p">(</span><span class="s2">&quot;rpc&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="EngineListener"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener">[docs]</a><span class="k">class</span> <span class="nc">EngineListener</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Listen on an AMQP queue named for the engine.</span>

<span class="sd">    Allows individual engines to communicate with each other for multi-engine</span>
<span class="sd">    support.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span><span class="n">STOP_STACK</span><span class="p">,</span> <span class="n">SEND</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;stop_stack&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">thread_group_mgr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">thread_group_mgr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="EngineListener.start"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">messaging</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
            <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">LISTENER_TOPIC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="EngineListener.stop"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to stop engine listener...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Engine listener is stopped successfully&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Failed to stop engine listener, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="EngineListener.listening"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener.listening">[docs]</a>    <span class="k">def</span> <span class="nf">listening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Respond to a watchdog request.</span>

<span class="sd">        Respond affirmatively to confirm that the engine performing the action</span>
<span class="sd">        is still alive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="EngineListener.stop_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener.stop_stack">[docs]</a>    <span class="k">def</span> <span class="nf">stop_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop any active threads on a stack.&quot;&quot;&quot;</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="n">stack_identity</span><span class="p">[</span><span class="s1">&#39;stack_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="EngineListener.send"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineListener.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="n">stack_identity</span><span class="p">[</span><span class="s1">&#39;stack_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div></div>


<span class="nd">@profiler.trace_cls</span><span class="p">(</span><span class="s2">&quot;rpc&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="EngineService"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService">[docs]</a><span class="k">class</span> <span class="nc">EngineService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">ServiceBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manages the running instances from creation to destruction.</span>

<span class="sd">    All the methods in here are called from the RPC backend.  This is</span>
<span class="sd">    all done dynamically so if a call is made via RPC that does not</span>
<span class="sd">    have a corresponding method here, an exception will be thrown when</span>
<span class="sd">    it attempts to call into this class.  Arguments to these methods</span>
<span class="sd">    are also dynamically added and will be named as keyword arguments</span>
<span class="sd">    by the RPC caller.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RPC_API_VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.35&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
        <span class="n">resources</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s1">&#39;heat-engine&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

        <span class="c1"># The following are initialized here, but assigned in start() which</span>
        <span class="c1"># happens after the fork when spawning multiple worker processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span> <span class="o">=</span> <span class="n">service_software_config</span><span class="o">.</span><span class="n">SoftwareConfigService</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">ResourceEnforcer</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">trusts_delegated_roles</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;The default value of &quot;trusts_delegated_roles&quot; &#39;</span>
                            <span class="s1">&#39;option in heat.conf is changed to [] in Kilo &#39;</span>
                            <span class="s1">&#39;and heat will delegate all roles of trustor. &#39;</span>
                            <span class="s1">&#39;Please keep the same if you do not want to &#39;</span>
                            <span class="s1">&#39;delegate subset roles when upgrading.&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="EngineService.create_periodic_tasks"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.create_periodic_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">create_periodic_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting periodic watch tasks pid=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="c1"># Note with multiple workers, the parent process hasn&#39;t called start()</span>
        <span class="c1"># so we need to create a ThreadGroupManager here for the periodic tasks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">ThreadGroupManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span> <span class="o">=</span> <span class="n">service_stack_watch</span><span class="o">.</span><span class="n">StackWatch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">create_watch_tasks</span><span class="p">():</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Create a periodic_watcher_task per-stack</span>
                    <span class="n">admin_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
                    <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
                        <span class="n">admin_context</span><span class="p">,</span>
                        <span class="n">show_hidden</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="o">.</span><span class="n">start_watch_task</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">admin_context</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Watch tasks created&quot;</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Watch task creation attempt failed, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">eventlet</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">add_thread</span><span class="p">(</span><span class="n">create_watch_tasks</span><span class="p">)</span></div>

<div class="viewcode-block" id="EngineService.start"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="n">service_utils</span><span class="o">.</span><span class="n">generate_engine_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">ThreadGroupManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">EngineListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting listener for engine </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">WorkerService</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="n">rpc_worker_api</span><span class="o">.</span><span class="n">TOPIC</span><span class="p">,</span>
                <span class="n">engine_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                <span class="n">thread_group_mgr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">messaging</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RPC_API_VERSION</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_server</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_client</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RPC_API_VERSION</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_db_conn_pool_size</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_manage_cleanup</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">service_manage_report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">add_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_stack_status</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_configure_db_conn_pool_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># bug #1491185</span>
        <span class="c1"># Set the DB max_overflow to match the thread pool size.</span>
        <span class="c1"># The overflow connections are automatically closed when they are</span>
        <span class="c1"># not used; setting it is better than setting DB max_pool_size.</span>
        <span class="n">worker_pool_size</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">executor_thread_pool_size</span>
        <span class="c1"># Update max_overflow only if it is not adequate</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">max_overflow</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">max_overflow</span> <span class="o">&lt;</span> <span class="n">worker_pool_size</span><span class="p">)):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">set_override</span><span class="p">(</span><span class="s1">&#39;max_overflow&#39;</span><span class="p">,</span> <span class="n">worker_pool_size</span><span class="p">,</span>
                                  <span class="n">group</span><span class="o">=</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="n">enforce_type</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_stop_rpc_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Stop rpc connection at first for preventing new requests</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to stop engine service...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Engine service is stopped successfully&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Failed to stop engine service, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

<div class="viewcode-block" id="EngineService.stop"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_rpc_server</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="p">:</span>
            <span class="c1"># Stop the WorkerService</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="c1"># Wait for all active threads to be finished</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1"># Ignore dummy service task</span>
                <span class="k">if</span> <span class="n">stack_id</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Waiting stack </span><span class="si">%s</span><span class="s2"> processing to be finished&quot;</span><span class="p">),</span>
                         <span class="n">stack_id</span><span class="p">)</span>
                <span class="c1"># Stop threads gracefully</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Stack </span><span class="si">%s</span><span class="s2"> processing was finished&quot;</span><span class="p">),</span> <span class="n">stack_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">ctxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
            <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Service </span><span class="si">%s</span><span class="s1"> is deleted&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>

        <span class="c1"># Terminate the engine process</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;All threads were gone, terminating engine&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="EngineService.wait"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="EngineService.reset"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="p">,</span> <span class="s1">&#39;heat&#39;</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.identify_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.identify_stack">[docs]</a>    <span class="k">def</span> <span class="nf">identify_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The full stack identifier for a single, live stack with stack_name.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name or UUID of the stack to look up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">is_uuid_like</span><span class="p">(</span><span class="n">stack_name</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="n">stack_name</span><span class="p">,</span>
                <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">eager_load</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1"># may be the name is in uuid format, so if get by id returns None,</span>
            <span class="c1"># we should get the info by name again</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Stack&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">stack_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_get_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">HeatIdentifier</span><span class="p">(</span><span class="o">**</span><span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">identity</span><span class="o">.</span><span class="n">stack_id</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Stack&#39;</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">is_admin</span> <span class="ow">and</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">identity</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">):</span>
            <span class="c1"># The DB API should not allow this, but sanity-check anyway..</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidTenant</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span>
                                          <span class="n">actual</span><span class="o">=</span><span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identity</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Stack&#39;</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_stack">[docs]</a>    <span class="k">def</span> <span class="nf">show_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resolve_outputs</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return detailed information about one or all stacks.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to show, or None</span>
<span class="sd">            to show all</span>
<span class="sd">        :param resolve_outputs: If True, outputs for given stack/stacks will</span>
<span class="sd">            be resolved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stacks</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack</span><span class="p">(</span>
            <span class="n">stack</span><span class="p">,</span> <span class="n">resolve_outputs</span><span class="o">=</span><span class="n">resolve_outputs</span><span class="p">)</span> <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">]</span></div>

<div class="viewcode-block" id="EngineService.get_revision"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.get_revision">[docs]</a>    <span class="k">def</span> <span class="nf">get_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">revision</span><span class="p">[</span><span class="s1">&#39;heat_revision&#39;</span><span class="p">]</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_stacks"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_stacks">[docs]</a>    <span class="k">def</span> <span class="nf">list_stacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">not_tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns attributes of all stacks.</span>

<span class="sd">        It supports pagination (``limit`` and ``marker``),</span>
<span class="sd">        sorting (``sort_keys`` and ``sort_dir``) and filtering (``filters``)</span>
<span class="sd">        of the results.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param limit: the number of stacks to list (integer or string)</span>
<span class="sd">        :param marker: the ID of the last item in the previous page</span>
<span class="sd">        :param sort_keys: an array of fields used to sort the list</span>
<span class="sd">        :param sort_dir: the direction of the sort (&#39;asc&#39; or &#39;desc&#39;)</span>
<span class="sd">        :param filters: a dict with attribute:value to filter the list</span>
<span class="sd">        :param tenant_safe: DEPRECATED, if true, scope the request by</span>
<span class="sd">            the current tenant</span>
<span class="sd">        :param show_deleted: if true, show soft-deleted stacks</span>
<span class="sd">        :param show_nested: if true, show nested stacks</span>
<span class="sd">        :param show_hidden: if true, show hidden stacks</span>
<span class="sd">        :param tags: show stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean AND expression</span>
<span class="sd">        :param tags_any: show stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean OR expression</span>
<span class="sd">        :param not_tags: show stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean AND expression</span>
<span class="sd">        :param not_tags_any: show stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean OR expression</span>
<span class="sd">        :returns: a list of formatted stacks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">translate_filters</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tenant_safe</span><span class="p">:</span>
            <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>

        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">show_nested</span><span class="o">=</span><span class="n">show_nested</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="o">=</span><span class="n">show_hidden</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">tags_any</span><span class="o">=</span><span class="n">tags_any</span><span class="p">,</span>
            <span class="n">not_tags</span><span class="o">=</span><span class="n">not_tags</span><span class="p">,</span>
            <span class="n">not_tags_any</span><span class="o">=</span><span class="n">not_tags_any</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack_db_object</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">]</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.count_stacks"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.count_stacks">[docs]</a>    <span class="k">def</span> <span class="nf">count_stacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">not_tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of stacks that match the given filters.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param filters: a dict of ATTR:VALUE to match against stacks</span>
<span class="sd">        :param tenant_safe: DEPRECATED, if true, scope the request by</span>
<span class="sd">            the current tenant</span>
<span class="sd">        :param show_deleted: if true, count will include the deleted stacks</span>
<span class="sd">        :param show_nested: if true, count will include nested stacks</span>
<span class="sd">        :param show_hidden: if true, count will include hidden stacks</span>
<span class="sd">        :param tags: count stacks containing these tags, combine multiple tags</span>
<span class="sd">            using the boolean AND expression</span>
<span class="sd">        :param tags_any: count stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean OR expression</span>
<span class="sd">        :param not_tags: count stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean AND expression</span>
<span class="sd">        :param not_tags_any: count stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean OR expression</span>
<span class="sd">        :returns: an integer representing the number of matched stacks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tenant_safe</span><span class="p">:</span>
            <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">count_all</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">show_nested</span><span class="o">=</span><span class="n">show_nested</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="o">=</span><span class="n">show_hidden</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">tags_any</span><span class="o">=</span><span class="n">tags_any</span><span class="p">,</span>
            <span class="n">not_tags</span><span class="o">=</span><span class="n">not_tags</span><span class="p">,</span>
            <span class="n">not_tags_any</span><span class="o">=</span><span class="n">not_tags_any</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate_deferred_auth_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">deferred_auth_method</span> <span class="o">!=</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">requires_deferred_auth</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">username</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingCredentialError</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="s1">&#39;X-Auth-User&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingCredentialError</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="s1">&#39;X-Auth-Key&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_new_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">parsed_template</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackExists</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="n">tenant_limit</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_stacks_per_tenant</span>
        <span class="k">if</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">count_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">tenant_limit</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;You have reached the maximum stacks per tenant, &quot;</span>
                        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">. Please delete some stacks.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">tenant_limit</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_template</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">parsed_template</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">parsed_template</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed_template</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="n">max_resources</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_resources_per_stack</span>
        <span class="k">if</span> <span class="n">max_resources</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">num_resources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_template</span><span class="p">[</span><span class="n">parsed_template</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_resources</span> <span class="o">&gt;</span> <span class="n">max_resources</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackResourceLimitExceeded</span><span class="o">.</span><span class="n">msg_fmt</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_template_and_validate_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                                           <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">environment_files</span><span class="p">,</span>
                                           <span class="n">args</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">convergence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">parent_resource_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">template_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">common_params</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">extract_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># If it is stack-adopt, use parameters from adopt_stack_data</span>
        <span class="k">if</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_ADOPT_STACK_DATA</span> <span class="ow">in</span> <span class="n">common_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">enable_stack_adopt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="s1">&#39;Stack Adopt&#39;</span><span class="p">)</span>

            <span class="c1"># Override the params with values given with -P option</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;environment&#39;</span> <span class="ow">in</span> <span class="n">common_params</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_ADOPT_STACK_DATA</span><span class="p">]:</span>
                <span class="n">new_params</span> <span class="o">=</span> <span class="n">common_params</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_ADOPT_STACK_DATA</span><span class="p">][</span>
                    <span class="s1">&#39;environment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">params</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_params</span>

        <span class="k">if</span> <span class="n">template_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">template_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
            <span class="n">env_util</span><span class="o">.</span><span class="n">merge_environments</span><span class="p">(</span><span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                        <span class="n">tmpl</span><span class="o">.</span><span class="n">param_schemata</span><span class="p">())</span>
            <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_new_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                             <span class="n">owner_id</span><span class="o">=</span><span class="n">owner_id</span><span class="p">,</span>
                             <span class="n">nested_depth</span><span class="o">=</span><span class="n">nested_depth</span><span class="p">,</span>
                             <span class="n">user_creds_id</span><span class="o">=</span><span class="n">user_creds_id</span><span class="p">,</span>
                             <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack_user_project_id</span><span class="p">,</span>
                             <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                             <span class="n">parent_resource</span><span class="o">=</span><span class="n">parent_resource_name</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">common_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_deferred_auth_context</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        <span class="n">is_root</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">nested_depth</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validate_resources</span><span class="o">=</span><span class="n">is_root</span><span class="p">)</span>
        <span class="c1"># For the root stack, log a summary of the TemplateResources loaded</span>
        <span class="k">if</span> <span class="n">is_root</span><span class="p">:</span>
            <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">log_resource_info</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">stack_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stack</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.preview_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.preview_stack">[docs]</a>    <span class="k">def</span> <span class="nf">preview_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span>
                      <span class="n">args</span><span class="p">,</span> <span class="n">environment_files</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate a new stack using the provided template.</span>

<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        :param environment_files: optional ordered list of environment file</span>
<span class="sd">               names included in the files dict</span>
<span class="sd">        :type  environment_files: list or None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;previewing stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">stack_name</span><span class="p">)</span>

        <span class="n">conv_eng</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_template_and_validate_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                                        <span class="n">stack_name</span><span class="p">,</span>
                                                        <span class="n">template</span><span class="p">,</span>
                                                        <span class="n">params</span><span class="p">,</span>
                                                        <span class="n">files</span><span class="p">,</span>
                                                        <span class="n">environment_files</span><span class="p">,</span>
                                                        <span class="n">args</span><span class="p">,</span>
                                                        <span class="n">convergence</span><span class="o">=</span><span class="n">conv_eng</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_preview</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.create_stack">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span>
                     <span class="n">args</span><span class="p">,</span> <span class="n">environment_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_resource_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">template_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new stack using the template provided.</span>

<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        :param environment_files: optional ordered list of environment file</span>
<span class="sd">               names included in the files dict</span>
<span class="sd">        :type  environment_files: list or None</span>
<span class="sd">        :param owner_id: parent stack ID for nested stacks, only expected when</span>
<span class="sd">                         called from another heat-engine (not a user option)</span>
<span class="sd">        :param nested_depth: the nested depth for nested stacks, only expected</span>
<span class="sd">                         when called from another heat-engine</span>
<span class="sd">        :param user_creds_id: the parent user_creds record for nested stacks</span>
<span class="sd">        :param stack_user_project_id: the parent stack_user_project_id for</span>
<span class="sd">                         nested stacks</span>
<span class="sd">        :param parent_resource_name: the parent resource name</span>
<span class="sd">        :param template_id: the ID of a pre-stored template in the DB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Creating stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">stack_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_create_stack_user</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">create_stack_user_project_id</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">AuthorizationFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                    <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_stack_create</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">msg_queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="c1"># Create/Adopt a stack, and create the periodic task if successful</span>
            <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">adopt_stack_data</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">adopt</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">stack</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">msg_queue</span><span class="o">=</span><span class="n">msg_queue</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="p">:</span>
                    <span class="c1"># Schedule a periodic watcher task for this stack</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="o">.</span><span class="n">start_watch_task</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Stack create failed, status </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

        <span class="n">convergence</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_template_and_validate_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">environment_files</span><span class="p">,</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">,</span> <span class="n">nested_depth</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="p">,</span>
            <span class="n">stack_user_project_id</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">parent_resource_name</span><span class="p">,</span>
            <span class="n">template_id</span><span class="p">)</span>

        <span class="n">stack_id</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">reauthentication_auth_method</span> <span class="o">==</span> <span class="s1">&#39;trusts&#39;</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">_create_stack_user</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span>
            <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">adopt_stack_data</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">ADOPT</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_queue</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">LightQueue</span><span class="p">()</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                                       <span class="n">_stack_create</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span>
                                                       <span class="n">msg_queue</span><span class="o">=</span><span class="n">msg_queue</span><span class="p">)</span>
            <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">remove_msg_queue</span><span class="p">,</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">add_msg_queue</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">_prepare_stack_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span>
                               <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">environment_files</span><span class="p">,</span>
                               <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">template_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current and updated stack for a given transition.</span>

<span class="sd">        Changes *will not* be persisted, this is a helper method for</span>
<span class="sd">        update_stack and preview_update_stack.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack: A stack to be updated.</span>
<span class="sd">        :param template: Template of stack you want to update to.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        :param template_id: the ID of a pre-stored template in the DB</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Now parse the template and any parameters for the updated</span>
        <span class="c1"># stack definition.  If PARAM_EXISTING is specified, we merge</span>
        <span class="c1"># any environment provided into the existing one and attempt</span>
        <span class="c1"># to use the existing stack template, if one is not provided.</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_EXISTING</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">template_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> \
                <span class="s2">&quot;Cannot specify template_id with PARAM_EXISTING&quot;</span>

            <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">new_template</span> <span class="o">=</span> <span class="n">template</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">convergence</span> <span class="ow">or</span>
                  <span class="n">current_stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
                <span class="c1"># If convergence is enabled, or the stack is complete, we can</span>
                <span class="c1"># just use the current template...</span>
                <span class="n">new_template</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ..but if it&#39;s FAILED without convergence things may be in an</span>
                <span class="c1"># inconsistent state, so we try to fall back on a stored copy</span>
                <span class="c1"># of the previous template</span>
                <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Use the stored previous template</span>
                    <span class="n">prev_t</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">prev_raw_template_id</span><span class="p">)</span>
                    <span class="n">new_template</span> <span class="o">=</span> <span class="n">prev_t</span><span class="o">.</span><span class="n">t</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Nothing we can do, the failed update happened before</span>
                    <span class="c1"># we started storing prev_raw_template_id</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;PATCH update to FAILED stack only &#39;</span>
                                  <span class="s1">&#39;possible if convergence enabled or &#39;</span>
                                  <span class="s1">&#39;previous template stored&#39;</span><span class="p">))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PATCH update to non-COMPLETE stack&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">new_files</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span>
            <span class="n">new_files</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">files</span> <span class="ow">or</span> <span class="p">{})</span>
            <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">new_template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">new_files</span><span class="p">)</span>
            <span class="n">env_util</span><span class="o">.</span><span class="n">merge_environments</span><span class="p">(</span><span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                        <span class="n">tmpl</span><span class="o">.</span><span class="n">param_schemata</span><span class="p">())</span>
            <span class="n">existing_env</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">env_as_dict</span><span class="p">()</span>
            <span class="n">existing_params</span> <span class="o">=</span> <span class="n">existing_env</span><span class="p">[</span><span class="n">env_fmt</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">]</span>
            <span class="n">clear_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_CLEAR_PARAMETERS</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">retained</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">existing_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clear_params</span><span class="p">)</span>
            <span class="n">existing_env</span><span class="p">[</span><span class="n">env_fmt</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">]</span> <span class="o">=</span> <span class="n">retained</span>
            <span class="n">new_env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">existing_env</span><span class="p">)</span>
            <span class="n">new_env</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_env</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">param_schemata</span><span class="p">():</span>
                    <span class="n">new_env</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">new_env</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">template_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">template_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
                <span class="n">env_util</span><span class="o">.</span><span class="n">merge_environments</span><span class="p">(</span><span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                            <span class="n">tmpl</span><span class="o">.</span><span class="n">param_schemata</span><span class="p">())</span>
                <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">max_resources</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_resources_per_stack</span>
        <span class="k">if</span> <span class="n">max_resources</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpl</span><span class="p">[</span><span class="n">tmpl</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_resources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">exception</span><span class="o">.</span><span class="n">StackResourceLimitExceeded</span><span class="o">.</span><span class="n">msg_fmt</span><span class="p">)</span>

        <span class="n">stack_name</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">name</span>
        <span class="n">current_kwargs</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>

        <span class="n">common_params</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">extract_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">common_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_TIMEOUT</span><span class="p">,</span>
                                 <span class="n">current_stack</span><span class="o">.</span><span class="n">timeout_mins</span><span class="p">)</span>
        <span class="n">common_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_DISABLE_ROLLBACK</span><span class="p">,</span>
                                 <span class="n">current_stack</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">)</span>

        <span class="n">current_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">common_params</span><span class="p">)</span>
        <span class="n">updated_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">current_kwargs</span><span class="p">)</span>

        <span class="n">invalid_params</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">immutable_params_modified</span><span class="p">(</span>
            <span class="n">updated_stack</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ImmutableParameterModified</span><span class="p">(</span><span class="o">*</span><span class="n">invalid_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">updated_stack</span><span class="p">)</span>
        <span class="n">updated_stack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_deferred_auth_context</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">updated_stack</span><span class="p">)</span>
        <span class="n">is_root</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">nested_depth</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">updated_stack</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validate_resources</span><span class="o">=</span><span class="n">is_root</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.update_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.update_stack">[docs]</a>    <span class="k">def</span> <span class="nf">update_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                     <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">environment_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">template_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update an existing stack based on the provided template and params.</span>

<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        :param environment_files: optional ordered list of environment file</span>
<span class="sd">               names included in the files dict</span>
<span class="sd">        :type  environment_files: list or None</span>
<span class="sd">        :param template_id: the ID of a pre-stored template in the DB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the database representation of the existing stack</span>
        <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Updating stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">reauthentication_auth_method</span> <span class="o">==</span> <span class="s1">&#39;trusts&#39;</span><span class="p">:</span>
            <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">,</span> <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">current_stack</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Updating a stack when it is suspended&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Updating a stack when it is deleting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">tmpl</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_stack_updates</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
            <span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">template_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
            <span class="n">current_stack</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span>
            <span class="n">current_stack</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">tmpl</span><span class="p">,</span>
                                         <span class="n">new_stack</span><span class="o">=</span><span class="n">updated_stack</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg_queue</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">LightQueue</span><span class="p">()</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                                       <span class="n">current_stack</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                                                       <span class="n">updated_stack</span><span class="p">,</span>
                                                       <span class="n">msg_queue</span><span class="o">=</span><span class="n">msg_queue</span><span class="p">)</span>
            <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">remove_msg_queue</span><span class="p">,</span>
                    <span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">add_msg_queue</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.preview_update_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.preview_update_stack">[docs]</a>    <span class="k">def</span> <span class="nf">preview_update_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                             <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">environment_files</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shows the resources that would be updated.</span>

<span class="sd">        The preview_update_stack method shows the resources that would be</span>
<span class="sd">        changed with an update to an existing stack based on the provided</span>
<span class="sd">        template and parameters. See update_stack for description of</span>
<span class="sd">        parameters.</span>

<span class="sd">        This method *cannot* guarantee that an update will have the actions</span>
<span class="sd">        specified because resource plugins can influence changes/replacements</span>
<span class="sd">        at runtime.</span>

<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the database representation of the existing stack</span>
        <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Previewing update of stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>

        <span class="n">tmpl</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_stack_updates</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
            <span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="n">update_task</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">StackUpdate</span><span class="p">(</span><span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">actions</span> <span class="o">=</span> <span class="n">update_task</span><span class="o">.</span><span class="n">preview</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">fmt_action_map</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">updated</span><span class="p">,</span> <span class="n">act</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">fmt_updated_res</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">updated</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">fmt_current_res</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;unchanged&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="n">fmt_updated_res</span><span class="p">,</span> <span class="n">act</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unchanged&#39;</span><span class="p">,</span> <span class="p">[]))),</span>
                <span class="s1">&#39;updated&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fmt_current_res</span><span class="p">,</span> <span class="n">act</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="p">[]))),</span>
                <span class="s1">&#39;replaced&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="n">fmt_updated_res</span><span class="p">,</span> <span class="n">act</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replaced&#39;</span><span class="p">,</span> <span class="p">[]))),</span>
                <span class="s1">&#39;added&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fmt_updated_res</span><span class="p">,</span> <span class="n">act</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="p">[]))),</span>
                <span class="s1">&#39;deleted&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fmt_current_res</span><span class="p">,</span> <span class="n">act</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span> <span class="p">[]))),</span>
            <span class="p">}</span>

        <span class="n">updated_stack</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">id</span>
        <span class="n">fmt_actions</span> <span class="o">=</span> <span class="n">fmt_action_map</span><span class="p">(</span><span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_SHOW_NESTED</span><span class="p">):</span>
            <span class="c1"># Note preview_resources is needed here to build the tree</span>
            <span class="c1"># of nested resources/stacks in memory, otherwise the</span>
            <span class="c1"># nested/has_nested() tests below won&#39;t work</span>
            <span class="n">updated_stack</span><span class="o">.</span><span class="n">preview_resources</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">nested_fmt_actions</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">updated</span><span class="p">,</span> <span class="n">act</span><span class="p">):</span>
                <span class="n">updated</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">id</span>

                <span class="c1"># Recurse for resources deleted from the current stack,</span>
                <span class="c1"># which is all those marked as deleted or replaced</span>
                <span class="k">def</span> <span class="nf">_n_deleted</span><span class="p">(</span><span class="n">stk</span><span class="p">,</span> <span class="n">deleted</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">:</span>
                        <span class="n">deleted_rsrc</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">deleted_rsrc</span><span class="o">.</span><span class="n">has_nested</span><span class="p">():</span>
                            <span class="n">nested_stk</span> <span class="o">=</span> <span class="n">deleted_rsrc</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span>
                            <span class="n">nested_rsrc</span> <span class="o">=</span> <span class="n">nested_stk</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">n_fmt</span> <span class="o">=</span> <span class="n">fmt_action_map</span><span class="p">(</span>
                                <span class="n">nested_stk</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;deleted&#39;</span><span class="p">:</span> <span class="n">nested_rsrc</span><span class="p">})</span>
                            <span class="n">fmt_actions</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">n_fmt</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">])</span>
                            <span class="n">_n_deleted</span><span class="p">(</span><span class="n">nested_stk</span><span class="p">,</span> <span class="n">nested_rsrc</span><span class="p">)</span>
                <span class="n">_n_deleted</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">act</span><span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">act</span><span class="p">[</span><span class="s1">&#39;replaced&#39;</span><span class="p">])</span>

                <span class="c1"># Recurse for all resources added to the updated stack,</span>
                <span class="c1"># which is all those marked added or replaced</span>
                <span class="k">def</span> <span class="nf">_n_added</span><span class="p">(</span><span class="n">stk</span><span class="p">,</span> <span class="n">added</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">added</span><span class="p">:</span>
                        <span class="n">added_rsrc</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">added_rsrc</span><span class="o">.</span><span class="n">has_nested</span><span class="p">():</span>
                            <span class="n">nested_stk</span> <span class="o">=</span> <span class="n">added_rsrc</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span>
                            <span class="n">nested_rsrc</span> <span class="o">=</span> <span class="n">nested_stk</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">n_fmt</span> <span class="o">=</span> <span class="n">fmt_action_map</span><span class="p">(</span>
                                <span class="bp">None</span><span class="p">,</span> <span class="n">nested_stk</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;added&#39;</span><span class="p">:</span> <span class="n">nested_rsrc</span><span class="p">})</span>
                            <span class="n">fmt_actions</span><span class="p">[</span><span class="s1">&#39;added&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">n_fmt</span><span class="p">[</span><span class="s1">&#39;added&#39;</span><span class="p">])</span>
                            <span class="n">_n_added</span><span class="p">(</span><span class="n">nested_stk</span><span class="p">,</span> <span class="n">nested_rsrc</span><span class="p">)</span>
                <span class="n">_n_added</span><span class="p">(</span><span class="n">updated</span><span class="p">,</span> <span class="n">act</span><span class="p">[</span><span class="s1">&#39;added&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">act</span><span class="p">[</span><span class="s1">&#39;replaced&#39;</span><span class="p">])</span>

                <span class="c1"># Recursively preview all &quot;updated&quot; resources</span>
                <span class="k">for</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">act</span><span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">]:</span>
                    <span class="n">current_rsrc</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
                    <span class="n">updated_rsrc</span> <span class="o">=</span> <span class="n">updated</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_rsrc</span><span class="o">.</span><span class="n">has_nested</span><span class="p">()</span> <span class="ow">and</span> <span class="n">updated_rsrc</span><span class="o">.</span><span class="n">has_nested</span><span class="p">():</span>
                        <span class="n">current_nested</span> <span class="o">=</span> <span class="n">current_rsrc</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span>
                        <span class="n">updated_nested</span> <span class="o">=</span> <span class="n">updated_rsrc</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span>
                        <span class="n">update_task</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">StackUpdate</span><span class="p">(</span>
                            <span class="n">current_nested</span><span class="p">,</span> <span class="n">updated_nested</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                        <span class="n">n_actions</span> <span class="o">=</span> <span class="n">update_task</span><span class="o">.</span><span class="n">preview</span><span class="p">()</span>
                        <span class="n">n_fmt_actions</span> <span class="o">=</span> <span class="n">fmt_action_map</span><span class="p">(</span>
                            <span class="n">current_nested</span><span class="p">,</span> <span class="n">updated_nested</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fmt_actions</span><span class="p">:</span>
                            <span class="n">fmt_actions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">n_fmt_actions</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">nested_fmt_actions</span><span class="p">(</span><span class="n">current_nested</span><span class="p">,</span> <span class="n">updated_nested</span><span class="p">,</span>
                                           <span class="n">n_actions</span><span class="p">)</span>
            <span class="c1"># Start the recursive nested_fmt_actions with the parent stack.</span>
            <span class="n">nested_fmt_actions</span><span class="p">(</span><span class="n">current_stack</span><span class="p">,</span> <span class="n">updated_stack</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fmt_actions</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_cancel_update"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_cancel_update">[docs]</a>    <span class="k">def</span> <span class="nf">stack_cancel_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span>
                            <span class="n">cancel_with_rollback</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel currently running stack update.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack for which to cancel update.</span>
<span class="sd">        :param cancel_with_rollback: Force rollback when cancel update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the database representation of the existing stack</span>
        <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cancel_with_rollback</span><span class="p">:</span>  <span class="c1"># Commanded by user</span>
            <span class="n">allowed_actions</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Cancelled by parent stack</span>
            <span class="n">allowed_actions</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span> <span class="ow">and</span>
                <span class="n">current_stack</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="n">allowed_actions</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Cancelling update when stack is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Starting cancel of updating stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cancel_with_rollback</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">rollback</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">stop_traversal</span><span class="p">,</span>
                                         <span class="n">current_stack</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">get_engine_id</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">engine_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No lock found on stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">cancel_with_rollback</span><span class="p">:</span>
            <span class="n">cancel_message</span> <span class="o">=</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL_WITH_ROLLBACK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cancel_message</span> <span class="o">=</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span>

        <span class="c1"># Current engine has the lock</span>
        <span class="k">if</span> <span class="n">engine_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cancel_message</span><span class="p">)</span>

        <span class="c1"># Another active engine has the lock</span>
        <span class="k">elif</span> <span class="n">service_utils</span><span class="o">.</span><span class="n">engine_alive</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
            <span class="n">cancel_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_call</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">engine_life_check_timeout</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">SEND</span><span class="p">,</span>
                <span class="n">stack_identity</span><span class="o">=</span><span class="n">stack_identity</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">cancel_message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cancel_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully sent </span><span class="si">%(msg)s</span><span class="s2"> message &quot;</span>
                          <span class="s2">&quot;to remote task on engine </span><span class="si">%(eng)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span>
                              <span class="s1">&#39;eng&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">cancel_message</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EventSendFailed</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">current_stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">engine_id</span><span class="o">=</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Cannot cancel stack </span><span class="si">%(stack_name)s</span><span class="s1">: lock held by &#39;</span>
                          <span class="s1">&#39;unknown engine </span><span class="si">%(engine_id)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
                              <span class="s1">&#39;stack_name&#39;</span><span class="p">:</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                              <span class="s1">&#39;engine_id&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">})</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.validate_template"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.validate_template">[docs]</a>    <span class="k">def</span> <span class="nf">validate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">environment_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">ignorable_errors</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the validity of a template.</span>

<span class="sd">        Checks, so far as we can, that a template is valid, and returns</span>
<span class="sd">        information about the parameters suitable for producing a user</span>
<span class="sd">        interface through which to specify the parameter values.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param environment_files: optional ordered list of environment file</span>
<span class="sd">               names included in the files dict</span>
<span class="sd">        :type  environment_files: list or None</span>
<span class="sd">        :param show_nested: if True, any nested templates will be checked</span>
<span class="sd">        :param ignorable_errors: List of error_code to be ignored as part of</span>
<span class="sd">        validation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;validate_template&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No Template provided.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">webob</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">explanation</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">service_check_defer</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">ignorable_errors</span><span class="p">:</span>
            <span class="n">invalid_codes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ignorable_errors</span><span class="p">)</span> <span class="o">-</span>
                             <span class="nb">set</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">ERROR_CODE_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">invalid_codes</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid codes in ignore_errors : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span>
                       <span class="nb">list</span><span class="p">(</span><span class="n">invalid_codes</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">webob</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">explanation</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">service_check_defer</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">env_util</span><span class="o">.</span><span class="n">merge_environments</span><span class="p">(</span><span class="n">environment_files</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                    <span class="n">tmpl</span><span class="o">.</span><span class="n">param_schemata</span><span class="p">())</span>
        <span class="n">tmpl</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_template</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)}</span>

        <span class="n">stack_name</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                             <span class="n">strict_validate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">resource_validate</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">service_check_defer</span><span class="o">=</span><span class="n">service_check_defer</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">ignorable_errors</span><span class="o">=</span><span class="n">ignorable_errors</span><span class="p">,</span>
                           <span class="n">validate_by_deps</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)}</span>

        <span class="k">def</span> <span class="nf">filter_parameter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">PSEUDO_PARAMETERS</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">format_validate_parameter</span><span class="p">,</span>
                                      <span class="n">filter_func</span><span class="o">=</span><span class="n">filter_parameter</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;Parameters&#39;</span><span class="p">:</span> <span class="n">params</span>
        <span class="p">}</span>

        <span class="n">param_groups</span> <span class="o">=</span> <span class="n">parameter_groups</span><span class="o">.</span><span class="n">ParameterGroups</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">parameter_groups</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ParameterGroups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">parameter_groups</span>

        <span class="k">if</span> <span class="n">show_nested</span><span class="p">:</span>
            <span class="c1"># Note preview_resources is needed here to build the tree</span>
            <span class="c1"># of nested resources/stacks in memory, otherwise the</span>
            <span class="c1"># nested/has_nested() tests below won&#39;t work</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">preview_resources</span><span class="p">()</span>

            <span class="k">def</span> <span class="nf">nested_params</span><span class="p">(</span><span class="n">stk</span><span class="p">):</span>
                <span class="n">n_result</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">stk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stk</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">has_nested</span><span class="p">():</span>
                        <span class="n">n_params</span> <span class="o">=</span> <span class="n">stk</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                            <span class="n">api</span><span class="o">.</span><span class="n">format_validate_parameter</span><span class="p">,</span>
                            <span class="n">filter_func</span><span class="o">=</span><span class="n">filter_parameter</span><span class="p">)</span>
                        <span class="n">n_result</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
                            <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s1">&#39;Description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;Parameters&#39;</span><span class="p">:</span> <span class="n">n_params</span>
                        <span class="p">}</span>
                        <span class="n">n_result</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nested_params</span><span class="p">(</span><span class="n">stk</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">nested</span><span class="p">()))</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;NestedParameters&#39;</span><span class="p">:</span> <span class="n">n_result</span><span class="p">}</span> <span class="k">if</span> <span class="n">n_result</span> <span class="k">else</span> <span class="p">{}</span>

            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nested_params</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.authenticated_to_backend"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.authenticated_to_backend">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_to_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the credentials in the RPC context.</span>

<span class="sd">        Verify that the credentials in the RPC context are valid for the</span>
<span class="sd">        current cloud backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">clients</span><span class="o">.</span><span class="n">Clients</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span><span class="o">.</span><span class="n">authenticated</span><span class="p">()</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.get_template"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the template.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to see.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">raw_template</span><span class="o">.</span><span class="n">template</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.get_environment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.get_environment">[docs]</a>    <span class="k">def</span> <span class="nf">get_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the environment for an existing stack.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param stack_identity: identifies the stack</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">raw_template</span><span class="o">.</span><span class="n">environment</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.get_files"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.get_files">[docs]</a>    <span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the files for an existing stack.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param stack_identity: identifies the stack</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">raw_template_id</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">raw_template</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">files</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_outputs"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cntx</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of stack outputs.</span>

<span class="sd">        :param cntx: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to see.</span>
<span class="sd">        :return: list of stack outputs in defined format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cntx</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cntx</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_outputs</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_output"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_output">[docs]</a>    <span class="k">def</span> <span class="nf">show_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cntx</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">output_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns dict with specified output key, value and description.</span>

<span class="sd">        :param cntx: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to see.</span>
<span class="sd">        :param output_key: key of desired stack output.</span>
<span class="sd">        :return: dict with output key, value and description in defined format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cntx</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cntx</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">outputs</span>

        <span class="k">if</span> <span class="n">output_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Specified output key </span><span class="si">%s</span><span class="s1"> not &#39;</span>
                                       <span class="s1">&#39;found.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">output_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">output_key</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_remote_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">lock_engine_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cctxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">LISTENER_TOPIC</span><span class="p">,</span>
            <span class="n">server</span><span class="o">=</span><span class="n">lock_engine_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cctxt</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">messaging</span><span class="o">.</span><span class="n">MessagingTimeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.delete_stack">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a given stack.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">COMPLETE</span> <span class="ow">and</span>
                <span class="n">st</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Stack&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Deleting stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">convergence</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">convergence_delete</span><span class="p">():</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">stop_all_workers</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">create_empty_template</span><span class="p">(</span>
                    <span class="n">from_template</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">convergence_delete</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">try_thread_lock</span><span class="p">()</span> <span class="k">as</span> <span class="n">acquire_result</span><span class="p">:</span>

            <span class="c1"># Successfully acquired lock</span>
            <span class="k">if</span> <span class="n">acquire_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop_timers</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span>
                                                               <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Current engine has the lock</span>
        <span class="k">if</span> <span class="n">acquire_result</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">:</span>
            <span class="c1"># give threads which are almost complete an opportunity to</span>
            <span class="c1"># finish naturally before force stopping them</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">)</span>

        <span class="c1"># Another active engine has the lock</span>
        <span class="k">elif</span> <span class="n">service_utils</span><span class="o">.</span><span class="n">engine_alive</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">):</span>
            <span class="n">cancel_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_call</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">engine_life_check_timeout</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">SEND</span><span class="p">,</span>
                <span class="n">stack_identity</span><span class="o">=</span><span class="n">stack_identity</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cancel_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully sent </span><span class="si">%(msg)s</span><span class="s2"> message &quot;</span>
                          <span class="s2">&quot;to remote task on engine </span><span class="si">%(eng)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span>
                              <span class="s1">&#39;eng&#39;</span><span class="p">:</span> <span class="n">acquire_result</span><span class="p">,</span>
                              <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EventSendFailed</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">engine_id</span><span class="o">=</span><span class="n">acquire_result</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">reload</span><span class="p">():</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stack</span>

        <span class="k">def</span> <span class="nf">wait_then_delete</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">watch</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">StopWatch</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">error_wait_time</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">watch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">watch</span><span class="o">.</span><span class="n">expired</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for stack cancel to complete: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">try_thread_lock</span><span class="p">()</span> <span class="k">as</span> <span class="n">acquire_result</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">acquire_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">stack</span> <span class="o">=</span> <span class="nb">reload</span><span class="p">()</span>
                        <span class="c1"># do the actual delete with the aquired lock</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span>
                            <span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">eventlet</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">acquire_result</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">:</span>
                <span class="c1"># cancel didn&#39;t finish in time, attempt a stop instead</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">service_utils</span><span class="o">.</span><span class="n">engine_alive</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">):</span>
                <span class="c1"># Another active engine has the lock</span>
                <span class="n">stop_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_call</span><span class="p">(</span>
                    <span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">,</span> <span class="n">STOP_STACK_TIMEOUT</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">STOP_STACK</span><span class="p">,</span>
                    <span class="n">stack_identity</span><span class="o">=</span><span class="n">stack_identity</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully stopped remote task &quot;</span>
                              <span class="s2">&quot;on engine </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">acquire_result</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StopActionFailed</span><span class="p">(</span>
                        <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">engine_id</span><span class="o">=</span><span class="n">acquire_result</span><span class="p">)</span>

            <span class="n">stack</span> <span class="o">=</span> <span class="nb">reload</span><span class="p">()</span>
            <span class="c1"># do the actual delete in a locked task</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                                  <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>

        <span class="c1"># Cancelling the stack could take some time, so do it in a task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">wait_then_delete</span><span class="p">,</span>
                                    <span class="n">stack</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.export_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.export_stack">[docs]</a>    <span class="k">def</span> <span class="nf">export_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exports the stack data json.</span>

<span class="sd">        Intended to be used to safely retrieve the stack data before</span>
<span class="sd">        performing the abandon action.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to export.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">abandon_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.abandon_stack"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.abandon_stack">[docs]</a>    <span class="k">def</span> <span class="nf">abandon_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Abandon a given stack.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to abandon.</span>
<span class="sd">        :param abandon: Delete Heat stack but not physical resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">enable_stack_abandon</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="s1">&#39;Stack Abandon&#39;</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="c1"># Get stack details before deleting it.</span>
            <span class="n">stack_info</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">abandon</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;abandoning stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span>
                                                               <span class="n">lock</span><span class="p">,</span>
                                                               <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span>
                                                               <span class="n">abandon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;exporting stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stack_info</span></div>

<div class="viewcode-block" id="EngineService.list_resource_types"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_resource_types">[docs]</a>    <span class="k">def</span> <span class="nf">list_resource_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">cnxt</span><span class="p">,</span>
                            <span class="n">support_status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">type_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">heat_version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">with_description</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of supported resource types.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param support_status: Support status of resource type</span>
<span class="sd">        :param type_name: Resource type&#39;s name (regular expression allowed)</span>
<span class="sd">        :param heat_version: Heat version</span>
<span class="sd">        :param with_description: Either return resource type description or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_types</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">support_status</span><span class="o">=</span><span class="n">support_status</span><span class="p">,</span>
            <span class="n">type_name</span><span class="o">=</span><span class="n">type_name</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">heat_version</span><span class="p">,</span>
            <span class="n">with_description</span><span class="o">=</span><span class="n">with_description</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">resource_type</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">build_resource_description</span><span class="p">(</span>
                    <span class="n">resource_type</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EngineService.list_template_versions"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_template_versions">[docs]</a>    <span class="k">def</span> <span class="nf">list_template_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">find_version_class</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">cls</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">version</span>

        <span class="n">mgr</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">_get_template_extension_manager</span><span class="p">()</span>
        <span class="n">_template_classes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">mgr</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">plugin</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mgr</span><span class="o">.</span><span class="n">names</span><span class="p">()]</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">_template_classes</span><span class="p">):</span>  <span class="c1"># Sort to ensure dates come first</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cfntemplate</span><span class="o">.</span><span class="n">CfnTemplateBase</span><span class="p">):</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;cfn&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span>

            <span class="c1"># Official versions are in &#39;%Y-%m-%d&#39; format. Default</span>
            <span class="c1"># version aliases are the Heat release code name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">versions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                                 <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;aliases&#39;</span><span class="p">:</span> <span class="p">[]})</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">find_version_class</span><span class="p">(</span><span class="n">versions</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">version</span><span class="p">[</span><span class="s1">&#39;aliases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidTemplateVersions</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># &#39;class&#39; was just used to find the version that the alias</span>
        <span class="c1"># maps to. Remove it so it will not show up in the output</span>
        <span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">versions</span></div>

<div class="viewcode-block" id="EngineService.list_template_functions"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_template_functions">[docs]</a>    <span class="k">def</span> <span class="nf">list_template_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">template_version</span><span class="p">,</span>
                                <span class="n">with_condition</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">mgr</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">_get_template_extension_manager</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmpl_class</span> <span class="o">=</span> <span class="n">mgr</span><span class="p">[</span><span class="n">template_version</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Template with version </span><span class="si">%s</span><span class="s2"> not found&quot;</span><span class="p">)</span> <span class="o">%</span>
                                     <span class="n">template_version</span><span class="p">)</span>

        <span class="n">supported_funcs</span> <span class="o">=</span> <span class="n">tmpl_class</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">functions</span>
        <span class="k">if</span> <span class="n">with_condition</span><span class="p">:</span>
            <span class="n">supported_funcs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmpl_class</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">condition_functions</span><span class="p">)</span>

        <span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">supported_funcs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">hot_functions</span><span class="o">.</span><span class="n">Removed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;functions&#39;</span><span class="p">:</span> <span class="n">func_name</span><span class="p">,</span>
                     <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">functions</span></div>

<div class="viewcode-block" id="EngineService.resource_schema"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.resource_schema">[docs]</a>    <span class="k">def</span> <span class="nf">resource_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">with_description</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the schema of the specified type.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param type_name: Name of the resource type to obtain the schema of.</span>
<span class="sd">        :param with_description: Return result with description or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_class</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Error loading resource type </span><span class="si">%s</span><span class="s1"> &#39;</span>
                              <span class="s1">&#39;from global environment.&#39;</span><span class="p">),</span>
                          <span class="n">type_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidGlobalResource</span><span class="p">(</span><span class="n">type_name</span><span class="o">=</span><span class="n">type_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">support</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">type_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">svc_available</span> <span class="o">=</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">is_service_available</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeUnavailable</span><span class="p">(</span>
                <span class="n">service_name</span><span class="o">=</span><span class="n">resource_class</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">,</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="n">type_name</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">svc_available</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeUnavailable</span><span class="p">(</span>
                    <span class="n">service_name</span><span class="o">=</span><span class="n">resource_class</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">,</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="n">type_name</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Service endpoint not in service catalog.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">properties_schema</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_dict</span> <span class="ow">in</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">properties_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">from_legacy</span><span class="p">(</span><span class="n">schema_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">implemented</span>
                        <span class="ow">and</span> <span class="n">schema</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">support</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">attributes_schema</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_data</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                    <span class="n">resource_class</span><span class="o">.</span><span class="n">attributes_schema</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="n">resource_class</span><span class="o">.</span><span class="n">base_attributes_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">from_attribute</span><span class="p">(</span><span class="n">schema_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">support</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_RES_TYPE</span><span class="p">:</span> <span class="n">type_name</span><span class="p">,</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_PROPERTIES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties_schema</span><span class="p">()),</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_ATTRIBUTES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attributes_schema</span><span class="p">()),</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_SUPPORT_STATUS</span><span class="p">:</span>
                <span class="n">resource_class</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">with_description</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="n">resource_class</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">build_resource_description</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_DESCRIPTION</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EngineService.generate_template"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.generate_template">[docs]</a>    <span class="k">def</span> <span class="nf">generate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="s1">&#39;cfn&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a template based on the specified type.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param type_name: Name of the resource type to generate a template for.</span>
<span class="sd">        :param template_type: the template type to generate, cfn or hot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_class</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Error loading resource type </span><span class="si">%s</span><span class="s1"> &#39;</span>
                              <span class="s1">&#39;from global environment.&#39;</span><span class="p">),</span>
                          <span class="n">type_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidGlobalResource</span><span class="p">(</span><span class="n">type_name</span><span class="o">=</span><span class="n">type_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">support</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">type_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">resource_to_template</span><span class="p">(</span><span class="n">type_name</span><span class="p">,</span>
                                                       <span class="n">template_type</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_events"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_events">[docs]</a>    <span class="k">def</span> <span class="nf">list_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">nested_depth</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lists all events associated with a given stack.</span>

<span class="sd">        It supports pagination (``limit`` and ``marker``),</span>
<span class="sd">        sorting (``sort_keys`` and ``sort_dir``) and filtering(filters)</span>
<span class="sd">        of the results.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to get events for</span>
<span class="sd">        :param filters: a dict with attribute:value to filter the list</span>
<span class="sd">        :param limit: the number of events to list (integer or string)</span>
<span class="sd">        :param marker: the ID of the last event in the previous page</span>
<span class="sd">        :param sort_keys: an array of fields used to sort the list</span>
<span class="sd">        :param sort_dir: the direction of the sort (&#39;asc&#39; or &#39;desc&#39;).</span>
<span class="sd">        :param nested_depth: Levels of nested stacks to list events for.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stack_identifiers</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">root_stack_identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">stack_identity</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nested_depth</span><span class="p">:</span>
                <span class="n">root_stack_identifier</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">identifier</span><span class="p">()</span>
                <span class="c1"># find all resources associated with a root stack</span>
                <span class="n">all_r</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_root_stack</span><span class="p">(</span>
                    <span class="n">cnxt</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

                <span class="c1"># find stacks to the requested nested_depth</span>
                <span class="n">stack_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">stack_id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">all_r</span><span class="p">)}</span>
                <span class="n">stack_filters</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">stack_ids</span><span class="p">,</span>
                    <span class="s1">&#39;nested_depth&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nested_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="p">}</span>

                <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                                    <span class="n">filters</span><span class="o">=</span><span class="n">stack_filters</span><span class="p">,</span>
                                                    <span class="n">show_nested</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">stack_identifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">identifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">filters</span><span class="p">[</span><span class="s1">&#39;stack_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stack_identifiers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event_object</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">get_all_by_tenant</span><span class="p">(</span>
                    <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                    <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                    <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event_object</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">get_all_by_stack</span><span class="p">(</span>
                    <span class="n">cnxt</span><span class="p">,</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                    <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                    <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                    <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">))</span>
                <span class="n">stack_identifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">identifier</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event_object</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">get_all_by_tenant</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">))</span>

            <span class="n">stack_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="o">.</span><span class="n">stack_id</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">}</span>
            <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                                <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">stack_ids</span><span class="p">},</span>
                                                <span class="n">show_nested</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">stack_identifiers</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">identifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_event</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">stack_identifiers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stack_id</span><span class="p">),</span>
                <span class="n">root_stack_identifier</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_authorize_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter access to describe_stack_resource for in-instance users.</span>

<span class="sd">        - The user must map to a User resource defined in the requested stack</span>
<span class="sd">        - The user resource must validate OK against any Policy specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first check whether access is allowed by context user_id</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">access_allowed</span><span class="p">(</span><span class="n">cnxt</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># fall back to looking for EC2 credentials in the context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ec2_creds</span> <span class="o">=</span> <span class="n">jsonutils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cnxt</span><span class="o">.</span><span class="n">aws_creds</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ec2Credentials&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">ec2_creds</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ec2_creds</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">access_key</span> <span class="o">=</span> <span class="n">ec2_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stack</span><span class="o">.</span><span class="n">access_allowed</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_stack_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">resource_get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                             <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotAvailable</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">)</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.describe_stack_resource"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.describe_stack_resource">[docs]</a>    <span class="k">def</span> <span class="nf">describe_stack_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span>
                                <span class="n">with_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">heat_stack_user_role</span> <span class="ow">in</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authorize_stack_user</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Access denied to resource </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">resource_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Forbidden</span><span class="p">()</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">resource_get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                             <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">with_attr</span><span class="o">=</span><span class="n">with_attr</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.resource_signal"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.resource_signal">[docs]</a>    <span class="k">def</span> <span class="nf">resource_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span>
                        <span class="n">sync_call</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls resource&#39;s signal for the specified resource.</span>

<span class="sd">        :param sync_call: indicates whether a synchronized call behavior is</span>
<span class="sd">                          expected. This is reserved for CFN WaitCondition</span>
<span class="sd">                          implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_resource_signal</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">need_check</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;signaling resource </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">needs_metadata_updates</span> <span class="o">=</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">need_check</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">needs_metadata_updates</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># Refresh the metadata for all other resources, since signals can</span>
            <span class="c1"># update metadata which is used by other resources, e.g</span>
            <span class="c1"># when signalling a WaitConditionHandle resource, and other</span>
            <span class="c1"># resources may refer to WaitCondition Fn::GetAtt Data</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">):</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">metadata_update</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="c1"># This is not &quot;nice&quot; converting to the stored context here,</span>
        <span class="c1"># but this happens because the keystone user associated with the</span>
        <span class="c1"># signal doesn&#39;t have permission to read the secret key of</span>
        <span class="c1"># the user associated with the cfn-credentials file</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_stack_resource</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>

        <span class="n">rsrc</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">resource_get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
            <span class="n">rsrc</span><span class="o">.</span><span class="n">_signal_check_action</span><span class="p">()</span>
            <span class="n">rsrc</span><span class="o">.</span><span class="n">_signal_check_hook</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sync_call</span><span class="p">:</span>
                <span class="n">_resource_signal</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_resource_signal</span><span class="p">,</span>
                                            <span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.resource_mark_unhealthy"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.resource_mark_unhealthy">[docs]</a>    <span class="k">def</span> <span class="nf">resource_mark_unhealthy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span>
                                <span class="n">mark_unhealthy</span><span class="p">,</span> <span class="n">resource_status_reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the resource as healthy or unhealthy.</span>

<span class="sd">           Put the resource in CHECK_FAILED state if &#39;mark_unhealthy&#39;</span>
<span class="sd">           is true. Put the resource in CHECK_COMPLETE if &#39;mark_unhealthy&#39;</span>
<span class="sd">           is false and the resource is in CHECK_FAILED state.</span>
<span class="sd">           Otherwise, make no change.</span>

<span class="sd">        :param resource_name: either the logical name of the resource or the</span>
<span class="sd">                              physical resource ID.</span>
<span class="sd">        :param mark_unhealthy: indicates whether the resource is unhealthy.</span>
<span class="sd">        :param resource_status_reason: reason for health change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="n">rsrc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                            <span class="n">rsrc</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mark_unhealthy</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Invalid</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;mark_unhealthy is not a boolean&quot;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="n">rsrc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_resource_in_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="n">resource_status_reason</span> <span class="ow">or</span>
                  <span class="s2">&quot;state changed by resource_mark_unhealthy api&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">(</span><span class="n">rsrc</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mark_unhealthy</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
                        <span class="n">rsrc</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
                    <span class="n">rsrc</span><span class="o">.</span><span class="n">handle_metadata_reset</span><span class="p">()</span>
                    <span class="n">rsrc</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">UpdateInProgress</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ActionInProgress</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_resource_in_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find a resource in a stack by either name or physical ID.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stack</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>

        <span class="n">rsrcs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_physical_resource_id</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">resource_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">in_stack</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="n">stack_id</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">stack</span><span class="p">[</span><span class="n">rs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rs</span><span class="o">.</span><span class="n">id</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="n">rs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">rsrcs</span> <span class="k">if</span> <span class="n">in_stack</span><span class="p">(</span><span class="n">rs</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">PhysicalResourceIDAmbiguity</span><span class="p">(</span><span class="n">phys_id</span><span class="o">=</span><span class="n">resource_name</span><span class="p">)</span>

        <span class="c1"># Try it the slow way</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">resource_by_refid</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span>

        <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                         <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.find_physical_resource"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.find_physical_resource">[docs]</a>    <span class="k">def</span> <span class="nf">find_physical_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">physical_resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an identifier for the specified resource.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param physical_resource_id: The physical resource ID to look up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rsrcs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_physical_resource_id</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">physical_resource_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rsrcs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">physical_resource_id</span><span class="p">)</span>
        <span class="c1"># This call is used only in the cfn API, which only cares about</span>
        <span class="c1"># finding the stack anyway. So allow duplicate resource IDs within the</span>
        <span class="c1"># same stack.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">rs</span><span class="o">.</span><span class="n">stack_id</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">rsrcs</span><span class="p">})</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">PhysicalResourceIDAmbiguity</span><span class="p">(</span>
                <span class="n">phys_id</span><span class="o">=</span><span class="n">physical_resource_id</span><span class="p">)</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="n">rsrcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">stack_id</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">rs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.describe_stack_resources"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.describe_stack_resources">[docs]</a>    <span class="k">def</span> <span class="nf">describe_stack_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="n">resource_name</span><span class="p">]</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_stack_resources"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_stack_resources">[docs]</a>    <span class="k">def</span> <span class="nf">list_stack_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span>
                             <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">with_detail</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nested_depth</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_nested_stack_depth</span><span class="p">)</span>
        <span class="n">res_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">translate_filters</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
            <span class="c1"># There is not corresponding for `type` column in Resource table,</span>
            <span class="c1"># so sqlalchemy filters can&#39;t be used.</span>
            <span class="n">res_type</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># populate context with resources from all nested depths</span>
            <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_root_stack</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">filter_type</span><span class="p">(</span><span class="n">res_iter</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">res_iter</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">res_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">type</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="k">yield</span> <span class="n">res</span>
        <span class="k">if</span> <span class="n">res_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rsrcs</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">iter_resources</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rsrcs</span> <span class="o">=</span> <span class="n">filter_type</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">iter_resources</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">with_detail</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">rsrcs</span><span class="p">]</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_suspend"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_suspend">[docs]</a>    <span class="k">def</span> <span class="nf">stack_suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle request to perform suspend action on a stack.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_stack_suspend</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;suspending stack </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_suspend</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_resume"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_resume">[docs]</a>    <span class="k">def</span> <span class="nf">stack_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle request to perform a resume action on a stack.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_stack_resume</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;resuming stack </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_resume</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_snapshot"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">stack_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_stack_snapshot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">save_snapshot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Function that saves snapshot before snapshot complete.&quot;&quot;&quot;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
                <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                     <span class="s1">&#39;status_reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">})</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Snapshotting stack </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">snapshot</span><span class="p">(</span><span class="n">save_snapshot_func</span><span class="o">=</span><span class="n">save_snapshot</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(stack)s</span><span class="s1"> is in state </span><span class="si">%(action)s</span><span class="s1">_IN_PROGRESS, &#39;</span>
                         <span class="s1">&#39;snapshot is not permitted.&#39;</span><span class="p">),</span> <span class="p">{</span>
                             <span class="s1">&#39;stack&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span>
                             <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ActionInProgress</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;tenant&#39;</span><span class="p">:</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;stack_id&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;IN_PROGRESS&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span>
                <span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">_stack_snapshot</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_snapshot"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">show_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_snapshot"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_delete_snapshot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Deleting in-progress snapshot&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_delete_snapshot</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_check"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_check">[docs]</a>    <span class="k">def</span> <span class="nf">stack_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle request to perform a check action on a stack.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Checking stack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">stack</span><span class="o">.</span><span class="n">check</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_restore"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_restore">[docs]</a>    <span class="k">def</span> <span class="nf">stack_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_stack_restore</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;restoring stack </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_enforcer</span><span class="o">.</span><span class="n">enforce_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="c1"># FIXME(pas-ha) has to be amended to deny restoring stacks</span>
        <span class="c1"># that have disallowed for current user</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_restore</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_list_snapshots"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.stack_list_snapshots">[docs]</a>    <span class="k">def</span> <span class="nf">stack_list_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_watch_data"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.create_watch_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_watch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">,</span> <span class="n">stats_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates data for CloudWatch and WaitConditions.</span>

<span class="sd">        This could be used by CloudWatch and WaitConditions</span>
<span class="sd">        and treat HA service events like any other CloudWatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_matching_watches</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">watch_name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="n">watch_rule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">rule_can_use_sample</span><span class="p">(</span><span class="n">wr</span><span class="p">,</span> <span class="n">stats_data</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch</span><span class="o">=</span><span class="n">wr</span><span class="p">)</span>

        <span class="n">rule_run</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">get_matching_watches</span><span class="p">():</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">create_watch_data</span><span class="p">(</span><span class="n">stats_data</span><span class="p">)</span>
            <span class="n">rule_run</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">watch_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">watch_name</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span><span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Watch Rule&#39;</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">watch_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stats_data</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_watch"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_watch">[docs]</a>    <span class="k">def</span> <span class="nf">show_watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the attributes of one watch/alarm.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param watch_name: Name of the watch you want to see, or None to see</span>
<span class="sd">            all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">watch_name</span><span class="p">:</span>
            <span class="n">wrn</span> <span class="o">=</span> <span class="p">[</span><span class="n">watch_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wrn</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">watch_rule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;show_watch (all) db error </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">wrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrn</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_watch</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_watch_metric"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_watch_metric">[docs]</a>    <span class="k">def</span> <span class="nf">show_watch_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">metric_namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the datapoints for a metric.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param metric_namespace: Name of the namespace you want to see, or None</span>
<span class="sd">            to see all.</span>
<span class="sd">        :param metric_name: Name of the metric you want to see, or None to see</span>
<span class="sd">            all.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># DB API and schema does not yet allow us to easily query by</span>
        <span class="c1"># namespace/metric, but we will want this at some point</span>
        <span class="c1"># for now, the API can query all metric data and filter locally</span>
        <span class="k">if</span> <span class="n">metric_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Filtering by namespace/metric not yet supported&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wds</span> <span class="o">=</span> <span class="n">watch_data</span><span class="o">.</span><span class="n">WatchData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span>
            <span class="n">rule_names</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">watch_rule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;show_metric (all) db error </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_watch_data</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rule_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.set_watch_state"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.set_watch_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_watch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Temporarily set the state of a given watch.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param watch_name: Name of the watch.</span>
<span class="sd">        :param state: State (must be one defined in WatchRule class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">WATCH_STATE_CEILOMETER_CONTROLLED</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">wr</span><span class="o">.</span><span class="n">set_watch_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">wr</span><span class="o">.</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="c1"># Return the watch with the state overridden to indicate success</span>
        <span class="c1"># We do not update the timestamps as we are not modifying the DB</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">format_watch</span><span class="p">(</span><span class="n">wr</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">WATCH_STATE_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_software_config"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">show_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">show_software_config</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_software_configs"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_software_configs">[docs]</a>    <span class="k">def</span> <span class="nf">list_software_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                              <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tenant_safe</span><span class="p">:</span>
            <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">list_software_configs</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_software_config"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.create_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">create_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
                               <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">create_software_config</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_software_config"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.delete_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">delete_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">delete_software_config</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_software_deployments"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_software_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">list_software_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">list_software_deployments</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.metadata_software_deployments"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.metadata_software_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_software_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">metadata_software_deployments</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.show_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">show_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">show_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.check_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.check_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">check_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">check_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.create_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">create_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">config_id</span><span class="p">,</span>
                                   <span class="n">input_values</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                                   <span class="n">status_reason</span><span class="p">,</span> <span class="n">stack_user_project_id</span><span class="p">,</span>
                                   <span class="n">deployment_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">create_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="o">=</span><span class="n">server_id</span><span class="p">,</span>
            <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">input_values</span><span class="o">=</span><span class="n">input_values</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span>
            <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack_user_project_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.signal_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.signal_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">signal_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span>
                                   <span class="n">updated_at</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">signal_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
            <span class="n">updated_at</span><span class="o">=</span><span class="n">updated_at</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.update_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.update_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">update_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">config_id</span><span class="p">,</span>
                                   <span class="n">input_values</span><span class="p">,</span> <span class="n">output_values</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                   <span class="n">status</span><span class="p">,</span> <span class="n">status_reason</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">update_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span>
            <span class="n">input_values</span><span class="o">=</span><span class="n">input_values</span><span class="p">,</span>
            <span class="n">output_values</span><span class="o">=</span><span class="n">output_values</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span>
            <span class="n">updated_at</span><span class="o">=</span><span class="n">updated_at</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_software_deployment"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.delete_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">delete_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">delete_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">)</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_services"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.list_services">[docs]</a>    <span class="k">def</span> <span class="nf">list_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">service_utils</span><span class="o">.</span><span class="n">format_service</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.migrate_convergence_1"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.migrate_convergence_1">[docs]</a>    <span class="k">def</span> <span class="nf">migrate_convergence_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">):</span>
        <span class="n">parent_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span>
                                         <span class="n">stack_id</span><span class="o">=</span><span class="n">stack_id</span><span class="p">,</span>
                                         <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent_stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Convergence was already enabled for stack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span>
                     <span class="n">stack_id</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">db_stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all_by_root_owner_id</span><span class="p">(</span>
            <span class="n">ctxt</span><span class="p">,</span> <span class="n">parent_stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">db_stacks</span><span class="p">]</span>
        <span class="n">stacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_stack</span><span class="p">)</span>
        <span class="n">locks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
                <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">locks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="n">ctxt</span><span class="o">.</span><span class="n">session</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">service_check_defer</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">migrate_to_convergence</span><span class="p">()</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lock</span> <span class="ow">in</span> <span class="n">locks</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EngineService.service_manage_report"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.service_manage_report">[docs]</a>    <span class="k">def</span> <span class="nf">service_manage_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">service_ref</span> <span class="o">=</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                     <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                     <span class="n">binary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span>
                     <span class="n">engine_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                     <span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
                     <span class="n">report_interval</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Service </span><span class="si">%s</span><span class="s1"> is started&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">deleted_at</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Service </span><span class="si">%s</span><span class="s1"> is updated&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Service </span><span class="si">%(service_id)s</span><span class="s1"> update &#39;</span>
                          <span class="s1">&#39;failed: </span><span class="si">%(error)s</span><span class="s1">&#39;</span><span class="p">),</span>
                      <span class="p">{</span><span class="s1">&#39;service_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span></div>

<div class="viewcode-block" id="EngineService.service_manage_cleanup"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.service_manage_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">service_manage_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">last_updated_window</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">)</span>
        <span class="n">time_line</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="n">last_updated_window</span><span class="p">)</span>

        <span class="n">service_refs</span> <span class="o">=</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">get_all_by_args</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">service_ref</span> <span class="ow">in</span> <span class="n">service_refs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="ow">or</span>
                    <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;deleted_at&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
                    <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">time_line</span><span class="p">:</span>
                <span class="c1"># hasn&#39;t been updated, assuming it&#39;s died.</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Service </span><span class="si">%s</span><span class="s1"> was aborted&#39;</span> <span class="o">%</span> <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">service_ref</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EngineService.reset_stack_status"><a class="viewcode-back" href="../../../api/heat.engine.service.html#heat.engine.service.EngineService.reset_stack_status">[docs]</a>    <span class="k">def</span> <span class="nf">reset_stack_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
            <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                                            <span class="n">show_nested</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
            <span class="n">stack_id</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
            <span class="n">engine_id</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">get_engine_id</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

                    <span class="c1"># refetch stack and confirm it is still IN_PROGRESS</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                        <span class="n">cnxt</span><span class="p">,</span>
                        <span class="n">stack_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
                        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">continue</span>

                    <span class="n">stk</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                            <span class="n">service_check_defer</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                            <span class="n">resource_validate</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Engine </span><span class="si">%(engine)s</span><span class="s1"> went down when stack &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">%(stack_id)s</span><span class="s1"> was in action </span><span class="si">%(action)s</span><span class="s1">&#39;</span><span class="p">),</span>
                             <span class="p">{</span><span class="s1">&#39;engine&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                              <span class="s1">&#39;stack_id&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

                    <span class="n">reason</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Engine went down during stack </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">stk</span><span class="o">.</span><span class="n">action</span>

                    <span class="c1"># Set stack and resources status to FAILED in sub thread</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span>
                        <span class="n">stk</span><span class="p">,</span>
                        <span class="n">lock</span><span class="p">,</span>
                        <span class="n">stk</span><span class="o">.</span><span class="n">reset_stack_and_resources_in_progress</span><span class="p">,</span>
                        <span class="n">reason</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ActionInProgress</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Error while resetting stack: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
                              <span class="o">%</span> <span class="n">stack_id</span><span class="p">)</span>
                <span class="k">continue</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/heat
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">heat 8.0.0.0rc2.dev38 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012,2013 Heat Developers.
      Last updated on &#39;Tue Feb 14 11:42:51 2017, commit 3ffc97c&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/heat");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>