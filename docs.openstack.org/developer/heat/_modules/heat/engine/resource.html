<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.resource &mdash; heat 8.0.0.0rc2.dev38 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '8.0.0.0rc2.dev38',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="heat 8.0.0.0rc2.dev38 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heat.engine.resource</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">excutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">reflection</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">short_id</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">attributes</span>
<span class="kn">from</span> <span class="nn">heat.engine.cfn</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">cfn_tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">clients</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">function</span>
<span class="kn">from</span> <span class="nn">heat.engine.hot</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">hot_tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">properties</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">rsrc_defn</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">scheduler</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource_data</span> <span class="k">as</span> <span class="n">resource_data_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource_properties_data</span> <span class="k">as</span> <span class="n">rpd_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_objects</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">rpc_client</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;action_retry_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;observe_on_update&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s1">&#39;error_wait_time&#39;</span><span class="p">,</span> <span class="s1">&#39;heat.common.config&#39;</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span>


<span class="k">def</span> <span class="nf">_register_class</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">):</span>
    <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">)</span>


<span class="c1"># Attention developers about to move/delete this: STOP IT!!!</span>
<span class="n">UpdateReplace</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">UpdateReplace</span>


<span class="c1"># Attention developers about to move this: STOP IT!!!</span>
<div class="viewcode-block" id="NoActionRequired"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.NoActionRequired">[docs]</a><span class="k">class</span> <span class="nc">NoActionRequired</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised when a signal is ignored.</span>

<span class="sd">    Resource subclasses should raise this exception from handle_signal() to</span>
<span class="sd">    suppress recording of an event corresponding to the signal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res_name</span><span class="o">=</span><span class="s1">&#39;Unknown&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The resource </span><span class="si">%(res)s</span><span class="s2"> could not perform &quot;</span>
                 <span class="s2">&quot;scaling action: </span><span class="si">%(reason)s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span>
               <span class="p">{</span><span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="n">res_name</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">})</span>
        <span class="nb">super</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span></div>


<div class="viewcode-block" id="PollDelay"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.PollDelay">[docs]</a><span class="k">class</span> <span class="nc">PollDelay</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception to delay polling of the resource.</span>

<span class="sd">    This exception may be raised by a Resource subclass&#39;s check_*_complete()</span>
<span class="sd">    methods to indicate that it need not be polled again immediately. If this</span>
<span class="sd">    exception is raised, the check_*_complete() method will not be called</span>
<span class="sd">    again until the nth time that the resource becomes eligible for polling.</span>
<span class="sd">    A PollDelay period of 1 is equivalent to returning False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">period</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span></div>


<span class="nd">@six.python_2_unicode_compatible</span>
<div class="viewcode-block" id="Resource"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource">[docs]</a><span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">INIT</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">ROLLBACK</span><span class="p">,</span>
        <span class="n">SUSPEND</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="n">ADOPT</span><span class="p">,</span> <span class="n">SNAPSHOT</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;INIT&#39;</span><span class="p">,</span> <span class="s1">&#39;CREATE&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;ROLLBACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SUSPEND&#39;</span><span class="p">,</span> <span class="s1">&#39;RESUME&#39;</span><span class="p">,</span> <span class="s1">&#39;ADOPT&#39;</span><span class="p">,</span> <span class="s1">&#39;SNAPSHOT&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">COMPLETE</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;IN_PROGRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;COMPLETE&#39;</span><span class="p">)</span>

    <span class="n">BASE_ATTRIBUTES</span> <span class="o">=</span> <span class="p">(</span><span class="n">SHOW</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="p">)</span>

    <span class="c1"># If True, this resource must be created before it can be referenced.</span>
    <span class="n">strict_dependency</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1"># Resource implementation set this to the subset of resource properties</span>
    <span class="c1"># supported for handle_update, used by update_template_diff_properties</span>
    <span class="n">update_allowed_properties</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c1"># Resource implementations set this to the name: description dictionary</span>
    <span class="c1"># that describes the appropriate resource attributes</span>
    <span class="n">attributes_schema</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Resource implementations set this to update policies</span>
    <span class="n">update_policy_schema</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Default entity of resource, which is used for during resolving</span>
    <span class="c1"># show attribute</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Description dictionary, that describes the common attributes for all</span>
    <span class="c1"># resources</span>
    <span class="n">base_attributes_schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">SHOW</span><span class="p">:</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Detailed information about resource.&quot;</span><span class="p">),</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">attributes</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">MAP</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># If True, this resource may perform authenticated API requests</span>
    <span class="c1"># throughout its lifecycle</span>
    <span class="n">requires_deferred_auth</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># Limit to apply to physical_resource_name() size reduction algorithm.</span>
    <span class="c1"># If set to None no limit will be applied.</span>
    <span class="n">physical_resource_name_limit</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="n">support_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">SupportStatus</span><span class="p">()</span>

    <span class="c1"># Default name to use for calls to self.client()</span>
    <span class="n">default_client_name</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Required service extension for this resource</span>
    <span class="n">required_service_extension</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># no signal actions</span>
    <span class="n">no_signal_actions</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">)</span>

    <span class="c1"># Whether all other resources need a metadata_update() after</span>
    <span class="c1"># a signal to this resource</span>
    <span class="n">signal_needs_metadata_updates</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new Resource of the appropriate class for its type.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span> <span class="o">!=</span> <span class="n">Resource</span><span class="p">:</span>
            <span class="c1"># Call is already for a subclass, so pass it through</span>
            <span class="n">ResourceClass</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
            <span class="n">ResourceClass</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_class_to_instantiate</span><span class="p">(</span>
                <span class="n">definition</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span>
                <span class="n">resource_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ResourceClass</span><span class="p">,</span> <span class="n">Resource</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">service_check_defer</span><span class="p">:</span>
            <span class="n">ResourceClass</span><span class="o">.</span><span class="n">_validate_service_availability</span><span class="p">(</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                <span class="n">definition</span><span class="o">.</span><span class="n">resource_type</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Resource</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">ResourceClass</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_validate_service_availability</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">svc_available</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">is_service_available</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Resource type </span><span class="si">%s</span><span class="s2"> unavailable&quot;</span><span class="p">),</span>
                          <span class="n">resource_type</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeUnavailable</span><span class="p">(</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ex</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">svc_available</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeUnavailable</span><span class="p">(</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">,</span>
                    <span class="n">service_name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">ex</span>

    <span class="k">def</span> <span class="nf">_init_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The method that defines attribute initialization for a resource.</span>

<span class="sd">        Some resource requires different initialization of resource attributes.</span>
<span class="sd">        So they must override this method and return the initialized</span>
<span class="sd">        attributes to the resource.</span>
<span class="sd">        :return: resource attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">attributes_schema</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">_make_resolver</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_validate_name</span><span class="p">(</span><span class="n">res_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">res_name</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Resource name may not contain &quot;/&quot;&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="n">_validate_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="c1"># Only translate in cases where resource_validate is True</span>
        <span class="c1"># ex. for template-validate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">(</span><span class="n">translate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">resource_validate</span><span class="p">,</span>
                     <span class="n">client_resolve</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">update_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_policy_schema</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_allowed_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_update_allowed</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes_schema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_attributes_schema</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_attributes</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># if the stack is being deleted, assume we&#39;ve already been deleted.</span>
        <span class="c1"># or if the resource has not been created yet, and the stack was</span>
        <span class="c1"># rollback, we set the resource to rollback</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">or</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">created_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">updated_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">cache_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">db_resource_get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">cache_data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">cache_data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">cache_data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">cache_data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Resource.rpc_client"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.rpc_client">[docs]</a>    <span class="k">def</span> <span class="nf">rpc_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a client for making engine RPC calls.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span> <span class="o">=</span> <span class="n">rpc_client</span><span class="o">.</span><span class="n">EngineClient</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span></div>

    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the resource state from its DB representation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">physical_resource_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">status_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">uuid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">rsrc_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">properties_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">rsrc_prop_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">created_at</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">updated_at</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">needed_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">requires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">replaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">replaced_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">current_template_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">root_stack_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">external_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">external_id</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackref</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;Need a reference to the Stack object&quot;</span>
        <span class="k">return</span> <span class="n">stack</span>

    <span class="nd">@stack.setter</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stackref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.load"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">,</span> <span class="n">is_update</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_mod</span>
        <span class="n">db_res</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">)</span>
        <span class="n">curr_stack</span> <span class="o">=</span> <span class="n">stack_mod</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="n">db_res</span><span class="o">.</span><span class="n">stack_id</span><span class="p">,</span>
                                          <span class="n">cache_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="n">resource_owning_stack</span> <span class="o">=</span> <span class="n">curr_stack</span>
        <span class="k">if</span> <span class="n">db_res</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">!=</span> <span class="n">curr_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c1"># load stack with template owning the resource</span>
            <span class="n">db_stack</span> <span class="o">=</span> <span class="n">stack_objects</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">db_res</span><span class="o">.</span><span class="n">stack_id</span><span class="p">)</span>
            <span class="n">db_stack</span><span class="o">.</span><span class="n">raw_template</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">db_stack</span><span class="o">.</span><span class="n">raw_template_id</span> <span class="o">=</span> <span class="n">db_res</span><span class="o">.</span><span class="n">current_template_id</span>
            <span class="n">resource_owning_stack</span> <span class="o">=</span> <span class="n">stack_mod</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                                                         <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>

        <span class="c1"># Load only the resource in question; don&#39;t load all resources</span>
        <span class="c1"># by invoking stack.resources. Maintain light-weight stack.</span>
        <span class="n">res_defn</span> <span class="o">=</span> <span class="n">resource_owning_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span>
            <span class="n">resource_owning_stack</span><span class="p">)[</span><span class="n">db_res</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">db_res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res_defn</span><span class="p">,</span> <span class="n">resource_owning_stack</span><span class="p">)</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span><span class="n">db_res</span><span class="p">)</span>

        <span class="c1"># assign current stack to the resource for updates</span>
        <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">curr_stack</span>

        <span class="c1"># return resource owning stack so that it is not GCed since it</span>
        <span class="c1"># is the only stack instance with a weak-ref from resource</span>
        <span class="k">return</span> <span class="n">resource</span><span class="p">,</span> <span class="n">resource_owning_stack</span><span class="p">,</span> <span class="n">curr_stack</span></div>

<div class="viewcode-block" id="Resource.make_replacement"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.make_replacement">[docs]</a>    <span class="k">def</span> <span class="nf">make_replacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tmpl_id</span><span class="p">):</span>
        <span class="c1"># 1. create the replacement with &quot;replaces&quot; = self.id</span>
        <span class="c1"># Don&#39;t set physical_resource_id so that a create is triggered.</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
              <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="s1">&#39;rsrc_prop_data_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_replace_rsrc_prop_data</span><span class="p">(),</span>
              <span class="s1">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">,</span>
              <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">,</span>
              <span class="s1">&#39;replaces&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
              <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span>
              <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span>
              <span class="s1">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="n">new_tmpl_id</span><span class="p">,</span>
              <span class="s1">&#39;stack_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="s1">&#39;root_stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span><span class="p">}</span>
        <span class="n">new_rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>

        <span class="c1"># 2. update the current resource to be replaced_by the one above.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">id</span>
        <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="s1">&#39;replaced_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Resource.reparse"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.reparse">[docs]</a>    <span class="k">def</span> <span class="nf">reparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">client_resolve</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reparse the resource properties.</span>

<span class="sd">        Optional translate flag for property translation and</span>
<span class="sd">        client_resolve flag for resolving properties by doing</span>
<span class="sd">        client lookup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">translate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translate_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="n">client_resolve</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.calc_update_allowed"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.calc_update_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">calc_update_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">update_allowed_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_allowed_properties</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">psk</span><span class="p">,</span> <span class="n">psv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">props</span><span class="o">.</span><span class="n">props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">psv</span><span class="o">.</span><span class="n">update_allowed</span><span class="p">():</span>
                <span class="n">update_allowed_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">psk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update_allowed_set</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow == comparison of two resources.&quot;&quot;&quot;</span>
        <span class="c1"># For the purposes of comparison, we declare two resource objects</span>
        <span class="c1"># equal if their names and resolved templates are the same</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">freeze</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow != comparison of two resources.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.metadata_get"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.metadata_get">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                               <span class="n">refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">rsrc_metadata</span>
        <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="n">rsrc_metadata</span></div>

    <span class="nd">@resource_objects.retry_on_conflict</span>
<div class="viewcode-block" id="Resource.metadata_set"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.metadata_set">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">merge_metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write new metadata to the database.</span>

<span class="sd">        The caller may optionally provide a merge_metadata() function, which</span>
<span class="sd">        takes two arguments - the metadata passed to metadata_set() and the</span>
<span class="sd">        current metadata of the resource - and returns the merged metadata to</span>
<span class="sd">        write. If merge_metadata is not provided, the metadata passed to</span>
<span class="sd">        metadata_set() is written verbatim, overwriting any existing metadata.</span>

<span class="sd">        If a race condition is detected, the write will be retried with the new</span>
<span class="sd">        result of merge_metadata() (if it is supplied) or the verbatim data (if</span>
<span class="sd">        it is not).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotAvailable</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting metadata for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="n">merge_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">db_res</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                   <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">merge_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">db_res</span><span class="o">.</span><span class="n">rsrc_metadata</span><span class="p">)</span>
        <span class="n">db_res</span><span class="o">.</span><span class="n">update_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="Resource.handle_metadata_reset"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.handle_metadata_reset">[docs]</a>    <span class="k">def</span> <span class="nf">handle_metadata_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; should be overridden by resources.</span>

<span class="sd">        Now we override this method to reset the metadata for scale-policy</span>
<span class="sd">        and scale-group resources, because their metadata might hang in a</span>
<span class="sd">        wrong state (&#39;scaling_in_progress&#39; is always True) if engine restarts</span>
<span class="sd">        while scaling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.set_needed_by"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.set_needed_by">[docs]</a>    <span class="k">def</span> <span class="nf">set_needed_by</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_rsrc</span><span class="p">,</span> <span class="n">needed_by</span><span class="p">,</span> <span class="n">expected_engine_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_rsrc</span><span class="p">:</span>
            <span class="n">db_rsrc</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;needed_by&#39;</span><span class="p">:</span> <span class="n">needed_by</span><span class="p">},</span>
                <span class="n">atomic_key</span><span class="o">=</span><span class="n">db_rsrc</span><span class="o">.</span><span class="n">atomic_key</span><span class="p">,</span>
                <span class="n">expected_engine_id</span><span class="o">=</span><span class="n">expected_engine_id</span>
            <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.set_requires"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.set_requires">[docs]</a>    <span class="k">def</span> <span class="nf">set_requires</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db_rsrc</span><span class="p">,</span> <span class="n">requires</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_rsrc</span><span class="p">:</span>
            <span class="n">db_rsrc</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">}</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_break_if_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block the resource until the hook is cleared if there is one.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">matches_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(a)s</span><span class="s2"> paused until Hook </span><span class="si">%(h)s</span><span class="s2"> is cleared&quot;</span><span class="p">)</span>
                            <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">})</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Reached hook on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clear_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;Failure occurred while waiting.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)):</span>
                        <span class="k">raise</span>

<div class="viewcode-block" id="Resource.has_nested"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.has_nested">[docs]</a>    <span class="k">def</span> <span class="nf">has_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the resource has an existing nested stack.</span>

<span class="sd">        For most resource types, this will always return False. StackResource</span>
<span class="sd">        subclasses return True when appropriate. Resource subclasses that may</span>
<span class="sd">        return True must also provide a nested_identifier() method to return</span>
<span class="sd">        the identifier of the nested stack, and a nested() method to return a</span>
<span class="sd">        Stack object for the nested stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Resource.has_hook"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.has_hook">[docs]</a>    <span class="k">def</span> <span class="nf">has_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="c1"># Clear the cache to make sure the data is up to date:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span></div>

<div class="viewcode-block" id="Resource.trigger_hook"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.trigger_hook">[docs]</a>    <span class="k">def</span> <span class="nf">trigger_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="s2">&quot;True&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.clear_hook"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.clear_hook">[docs]</a>    <span class="k">def</span> <span class="nf">clear_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_delete</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.type"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_type</span></div>

<div class="viewcode-block" id="Resource.has_interface"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.has_interface">[docs]</a>    <span class="k">def</span> <span class="nf">has_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if resource is mapped to resource_type or is &quot;resource_type&quot;.</span>

<span class="sd">        Check to see if this resource is either mapped to resource_type</span>
<span class="sd">        or is a &quot;resource_type&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">resource_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_resource_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ri</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">resource_type</span></div>

<div class="viewcode-block" id="Resource.identifier"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.identifier">[docs]</a>    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an identifier for this resource.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">ResourceIdentifier</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span></div>

<div class="viewcode-block" id="Resource.frozen_definition"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.frozen_definition">[docs]</a>    <span class="k">def</span> <span class="nf">frozen_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.update_template_diff"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.update_template_diff">[docs]</a>    <span class="k">def</span> <span class="nf">update_template_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the difference between the before and after json snippets.</span>

<span class="sd">        If something has been removed in after which exists in before we set it</span>
<span class="sd">        to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span></div>

<div class="viewcode-block" id="Resource.update_template_diff_properties"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.update_template_diff_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_template_diff_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return changed Properties between the before and after properties.</span>

<span class="sd">        If any property having immutable as True is updated, raises</span>
<span class="sd">        NotSupported error.</span>
<span class="sd">        If any properties have changed which are not in</span>
<span class="sd">        update_allowed_properties, raises UpdateReplace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">update_allowed_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_update_allowed</span><span class="p">(</span><span class="n">after_props</span><span class="p">)</span>
        <span class="n">immutable_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">psk</span><span class="p">,</span> <span class="n">psv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">after_props</span><span class="o">.</span><span class="n">props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">psv</span><span class="o">.</span><span class="n">immutable</span><span class="p">():</span>
                <span class="n">immutable_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">psk</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">prop_changed</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">before_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># We shouldn&#39;t get here usually, but there is a known issue</span>
                <span class="c1"># with template resources and new parameters in non-convergence</span>
                <span class="c1"># stacks (see bug 1543685). The error should be harmless</span>
                <span class="c1"># because we&#39;re on the before properties, which have presumably</span>
                <span class="c1"># already been validated.</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;Ignoring error in old property value &#39;</span>
                                <span class="s1">&#39;</span><span class="si">%(prop_name)s</span><span class="s1">: </span><span class="si">%(msg)s</span><span class="s1">&#39;</span><span class="p">),</span>
                            <span class="p">{</span><span class="s1">&#39;prop_name&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">)})</span>
                <span class="k">return</span> <span class="bp">True</span>

            <span class="k">return</span> <span class="n">before</span> <span class="o">!=</span> <span class="n">after_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Create a set of keys which differ (or are missing/added)</span>
        <span class="n">changed_properties_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">after_props</span> <span class="k">if</span> <span class="n">prop_changed</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="c1"># Create a list of updated properties offending property immutability</span>
        <span class="n">update_replace_forbidden</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed_properties_set</span>
                                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">immutable_set</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">update_replace_forbidden</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Update to properties </span><span class="si">%(props)s</span><span class="s2"> of </span><span class="si">%(name)s</span><span class="s2"> (</span><span class="si">%(res)s</span><span class="s2">)&quot;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">update_replace_forbidden</span><span class="p">)),</span>
                         <span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">changed_properties_set</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_replace_with_prop_diff</span><span class="p">(</span>
                <span class="n">changed_properties_set</span><span class="p">,</span>
                <span class="n">after_props</span><span class="p">,</span>
                <span class="n">before_props</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_properties_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">update_allowed_set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">after_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed_properties_set</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">reflection</span><span class="o">.</span><span class="n">get_class_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fully_qualified</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot; [</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
                                            <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.dep_attrs"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.dep_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">dep_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">dep_attrs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.add_explicit_dependencies"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.add_explicit_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_explicit_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add all dependencies explicitly specified in the template.</span>

<span class="sd">        The deps parameter is a Dependencies object to which dependency pairs</span>
<span class="sd">        are added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
        <span class="n">deps</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.add_dependencies"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.add_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add implicit dependencies specific to the resource type.</span>

<span class="sd">        Some resource types may have implicit dependencies on other resources</span>
<span class="sd">        in the same stack that are not linked by a property value (that would</span>
<span class="sd">        be set using get_resource or get_attr for example, thus creating an</span>
<span class="sd">        explicit dependency). Such dependencies are opaque to the user and</span>
<span class="sd">        should be avoided wherever possible, however in some circumstances they</span>
<span class="sd">        are required due to magic in the underlying API.</span>

<span class="sd">        The deps parameter is a Dependencies object to which dependency pairs</span>
<span class="sd">        may be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Resource.required_by"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.required_by">[docs]</a>    <span class="k">def</span> <span class="nf">required_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of resources that require this one as a dependency.</span>

<span class="sd">        Returns a list of names of resources that depend on this resource</span>
<span class="sd">        directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">required_by</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># for convergence, fall back to building from needed_by</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">]</span></div>

<div class="viewcode-block" id="Resource.client"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.client">[docs]</a>    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span>
        <span class="k">assert</span> <span class="n">client_name</span><span class="p">,</span> <span class="s2">&quot;Must specify client name&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">client_name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.client_plugin"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.client_plugin">[docs]</a>    <span class="k">def</span> <span class="nf">client_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span>
        <span class="k">assert</span> <span class="n">client_name</span><span class="p">,</span> <span class="s2">&quot;Must specify client name&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.is_service_available"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.is_service_available">[docs]</a>    <span class="k">def</span> <span class="nf">is_service_available</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># NOTE(kanagaraj-manickam): return True to satisfy the cases like</span>
        <span class="c1"># resource does not have endpoint, such as RandomString, OS::Heat</span>
        <span class="c1"># resources as they are implemented within the engine.</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">client_plugin</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">Clients</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">client_plugin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ClientNotAvailable</span><span class="p">(</span>
                <span class="n">client_name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">)</span>

        <span class="n">service_types</span> <span class="o">=</span> <span class="n">client_plugin</span><span class="o">.</span><span class="n">service_types</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">service_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># NOTE(kanagaraj-manickam): if one of the service_type does</span>
        <span class="c1"># exist in the keystone, then considered it as available.</span>
        <span class="k">for</span> <span class="n">service_type</span> <span class="ow">in</span> <span class="n">service_types</span><span class="p">:</span>
            <span class="n">endpoint_exists</span> <span class="o">=</span> <span class="n">client_plugin</span><span class="o">.</span><span class="n">does_endpoint_exist</span><span class="p">(</span>
                <span class="n">service_type</span><span class="o">=</span><span class="n">service_type</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">endpoint_exists</span><span class="p">:</span>
                <span class="n">req_extension</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">required_service_extension</span>
                <span class="n">is_ext_available</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">req_extension</span> <span class="ow">or</span> <span class="n">client_plugin</span><span class="o">.</span><span class="n">has_extension</span><span class="p">(</span>
                        <span class="n">req_extension</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">is_ext_available</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Required extension {0} in {1} service &#39;</span>
                               <span class="s1">&#39;is not available.&#39;</span><span class="p">)</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req_extension</span><span class="p">,</span>
                                           <span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;{0} {1} endpoint is not in service catalog.&#39;</span><span class="p">)</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">,</span> <span class="n">service_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.keystone"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.keystone">[docs]</a>    <span class="k">def</span> <span class="nf">keystone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;keystone&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.nova"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.nova">[docs]</a>    <span class="k">def</span> <span class="nf">nova</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;nova&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.swift"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.swift">[docs]</a>    <span class="k">def</span> <span class="nf">swift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;swift&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.neutron"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.neutron">[docs]</a>    <span class="k">def</span> <span class="nf">neutron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;neutron&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.cinder"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.cinder">[docs]</a>    <span class="k">def</span> <span class="nf">cinder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cinder&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.trove"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.trove">[docs]</a>    <span class="k">def</span> <span class="nf">trove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;trove&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.ceilometer"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.ceilometer">[docs]</a>    <span class="k">def</span> <span class="nf">ceilometer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ceilometer&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.heat"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.heat">[docs]</a>    <span class="k">def</span> <span class="nf">heat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;heat&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.glance"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.glance">[docs]</a>    <span class="k">def</span> <span class="nf">glance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;glance&#39;</span><span class="p">)</span></div>

    <span class="nd">@contextlib.contextmanager</span>
    <span class="k">def</span> <span class="nf">_action_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">expected_exceptions</span><span class="o">=</span><span class="nb">tuple</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Return a context manager to record the progress of an action.</span>

<span class="sd">        Upon entering the context manager, the state is set to IN_PROGRESS.</span>
<span class="sd">        Upon exiting, the state will be set to COMPLETE if no exception was</span>
<span class="sd">        raised, or FAILED otherwise. Non-exit exceptions will be translated</span>
<span class="sd">        to ResourceFailure exceptions.</span>

<span class="sd">        Expected exceptions are re-raised, with the Resource moved to the</span>
<span class="sd">        COMPLETE state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">except</span> <span class="n">expected_exceptions</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(action)s</span><span class="s1">: </span><span class="si">%(info)s</span><span class="s1">&#39;</span><span class="p">),</span>
                     <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                      <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)},</span>
                     <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">failure</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">failure</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">reason</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> aborted&#39;</span> <span class="o">%</span> <span class="n">action</span>
                    <span class="k">if</span> <span class="n">reason</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">reason</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Error marking resource as failed&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.action_handler_task"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.action_handler_task">[docs]</a>    <span class="k">def</span> <span class="nf">action_handler_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">action_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A task to call the Resource subclass&#39;s handler methods for action.</span>

<span class="sd">        Calls the handle_&lt;ACTION&gt;() method for the given action and then calls</span>
<span class="sd">        the check_&lt;ACTION&gt;_complete() method with the result in a loop until it</span>
<span class="sd">        returns True. If the methods are not provided, the call is omitted.</span>

<span class="sd">        Any args provided are passed to the handler.</span>

<span class="sd">        If a prefix is supplied, the handler method handle_&lt;PREFIX&gt;_&lt;ACTION&gt;()</span>
<span class="sd">        is called instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">handler_action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">check</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;check_</span><span class="si">%s</span><span class="s1">_complete&#39;</span> <span class="o">%</span> <span class="n">handler_action</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action_prefix</span><span class="p">:</span>
            <span class="n">handler_action</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">handler_action</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">handler_action</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="n">handler_data</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">done</span> <span class="o">=</span> <span class="n">check</span><span class="p">(</span><span class="n">handler_data</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">PollDelay</span> <span class="k">as</span> <span class="n">delay</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">delay</span><span class="o">.</span><span class="n">period</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">yield</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
                    <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                        <span class="n">canceller</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">_cancel&#39;</span> <span class="o">%</span> <span class="n">handler_action</span><span class="p">,</span>
                            <span class="bp">None</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">canceller</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">canceller</span><span class="p">(</span><span class="n">handler_data</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                    <span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Error cancelling resource </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span>
                                    <span class="n">action</span>
                                <span class="p">)</span></div>

    <span class="nd">@scheduler.wrappertask</span>
    <span class="k">def</span> <span class="nf">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">pre_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a transition to a new state via a specified action.</span>

<span class="sd">        Action should be e.g self.CREATE, self.UPDATE etc, we set</span>
<span class="sd">        status based on this, the transition is handled by calling the</span>
<span class="sd">        corresponding handle_* and check_*_complete functions</span>
<span class="sd">        Note pre_func is an optional function reference which will</span>
<span class="sd">        be called before the handle_&lt;action&gt; function</span>

<span class="sd">        If the resource does not declare a check_$action_complete function,</span>
<span class="sd">        we declare COMPLETE status as soon as the handle_$action call has</span>
<span class="sd">        finished, and if no handle_$action function is declared, then we do</span>
<span class="sd">        nothing, useful e.g if the resource requires no action for a given</span>
<span class="sd">        state transition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="s1">&#39;Invalid action </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">action</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pre_func</span><span class="p">):</span>
                <span class="n">pre_func</span><span class="p">()</span>

            <span class="n">handler_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">resource_data</span><span class="p">]</span> <span class="k">if</span> <span class="n">resource_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">handler_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_stored_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">!=</span> <span class="n">old_props</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Resource.preview"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.preview">[docs]</a>    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation of Resource.preview.</span>

<span class="sd">        This method should be overridden by child classes for specific</span>
<span class="sd">        behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Resource.create_convergence"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.create_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">create_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span>
                           <span class="n">timeout</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the resource by invoking the scheduler TaskRunner.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">resource_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="n">template_id</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">adopt_stack_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adopt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">_adopt_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">runner</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adopt</span><span class="p">,</span> <span class="o">**</span><span class="n">adopt_data</span><span class="p">)</span>

            <span class="n">runner</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.validate_external"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.validate_external">[docs]</a>    <span class="k">def</span> <span class="nf">validate_external</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_show_resource</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">is_not_found</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid external resource: Resource &quot;</span>
                                       <span class="s2">&quot;</span><span class="si">%(external_id)s</span><span class="s2"> (</span><span class="si">%(type)s</span><span class="s2">) can not &quot;</span>
                                       <span class="s2">&quot;be found.&quot;</span><span class="p">)</span> <span class="o">%</span>
                                     <span class="p">{</span><span class="s1">&#39;external_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span><span class="p">,</span>
                                      <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()})</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">error_message</span><span class="p">)</span>
                <span class="k">raise</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.create"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the resource.</span>

<span class="sd">        Subclasses should provide a handle_create() method to customise</span>
<span class="sd">        creation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;State </span><span class="si">%s</span><span class="s1"> invalid for create&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span>
                                  <span class="n">resource_data</span><span class="o">=</span><span class="p">{</span>
                                      <span class="s1">&#39;resource_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># This method can be called when we replace a resource, too. In that</span>
        <span class="c1"># case, a hook has already been dealt with in `Resource.update` so we</span>
        <span class="c1"># shouldn&#39;t do it here again:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_PRE_CREATE</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;creating </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Re-resolve the template, since if the resource Ref&#39;s</span>
        <span class="c1"># the StackId pseudo parameter, it will change after</span>
        <span class="c1"># the parser.Stack is stored (which is after the resources</span>
        <span class="c1"># are __init__&#39;d, but before they are create()&#39;d). We also</span>
        <span class="c1"># do client lookups for RESOLVE translation rules here.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>

        <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">retry_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">action_retry_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">first_failure</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">retry_limit</span> <span class="ow">and</span>
               <span class="n">count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">retry_limit</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">retry_backoff_delay</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                                                      <span class="n">jitter_max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="n">waiter</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">waiter</span><span class="o">.</span><span class="n">as_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                    <span class="n">first_failure</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">failure</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">failure</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceInError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">failure</span>

                <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span>
                    <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">first_failure</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># Save the first exception</span>
                    <span class="n">first_failure</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="k">if</span> <span class="n">first_failure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">first_failure</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_POST_CREATE</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.pause"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.pause">[docs]</a>    <span class="k">def</span> <span class="nf">pause</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">yield</span>
        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="Resource.prepare_abandon"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.prepare_abandon">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_abandon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;resource_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">(),</span>
            <span class="s1">&#39;resource_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Resource.adopt"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.adopt">[docs]</a>    <span class="k">def</span> <span class="nf">adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adopt the existing resource.</span>

<span class="sd">        Resource subclasses can provide a handle_adopt() method to customise</span>
<span class="sd">        adopt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="n">resource_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.handle_adopt"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.handle_adopt">[docs]</a>    <span class="k">def</span> <span class="nf">handle_adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">resource_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_info</span><span class="p">(</span><span class="n">resource_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_id</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Resource ID was not provided.&#39;</span><span class="p">))</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">failure</span>

        <span class="c1"># set resource id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id_set</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>

        <span class="c1"># save the resource data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># save the resource metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_set</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.translation_rules"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.translation_rules">[docs]</a>    <span class="k">def</span> <span class="nf">translation_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return specified rules for resource.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Resource.translate_properties"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.translate_properties">[docs]</a>    <span class="k">def</span> <span class="nf">translate_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span>
                             <span class="n">client_resolve</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translates properties with resource specific rules.</span>

<span class="sd">        The properties parameter is a properties object and the</span>
<span class="sd">        optional client_resolve flag is to specify whether to</span>
<span class="sd">        do &#39;RESOLVE&#39; translation with client lookup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translation_rules</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rule</span><span class="o">.</span><span class="n">execute_rule</span><span class="p">(</span><span class="n">client_resolve</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourcePropertyConflict</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">get_section_name</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RES_PROPERTIES</span><span class="p">)]</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">=</span><span class="s1">&#39;Property error&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">message</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Resource.cancel_grace_period"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.cancel_grace_period">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_grace_period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">canceller</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">_cancel&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                            <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">canceller</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">error_wait_time</span></div>

    <span class="k">def</span> <span class="nf">_get_resource_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_id&#39;</span><span class="p">),</span>
                <span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_data&#39;</span><span class="p">),</span>
                <span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="Resource.needs_replace"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.needs_replace">[docs]</a>    <span class="k">def</span> <span class="nf">needs_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mandatory replace based on certain properties.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Resource.needs_replace_with_prop_diff"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.needs_replace_with_prop_diff">[docs]</a>    <span class="k">def</span> <span class="nf">needs_replace_with_prop_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changed_properties_set</span><span class="p">,</span>
                                     <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needs replace based on prop_diff.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Resource.needs_replace_with_tmpl_diff"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.needs_replace_with_tmpl_diff">[docs]</a>    <span class="k">def</span> <span class="nf">needs_replace_with_tmpl_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmpl_diff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needs replace based on tmpl_diff.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Resource.needs_replace_failed"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.needs_replace_failed">[docs]</a>    <span class="k">def</span> <span class="nf">needs_replace_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Needs replace if resource is in *_FAILED.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span></div>

    <span class="k">def</span> <span class="nf">_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                      <span class="n">prev_resource</span><span class="p">,</span> <span class="n">check_init_complete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="c1"># always replace when a resource is in CHECK_FAILED</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_replace_failed</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">check_init_complete</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_replace</span><span class="p">(</span><span class="n">after_props</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">before</span> <span class="o">!=</span> <span class="n">after</span><span class="o">.</span><span class="n">freeze</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">before_props</span> <span class="o">!=</span> <span class="n">after_props</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_check_for_convergence_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restricted_actions</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;replace&#39;</span> <span class="ow">in</span> <span class="n">restricted_actions</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionRestricted</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">failure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.update_convergence"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.update_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">update_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span>
                           <span class="n">timeout</span><span class="p">,</span> <span class="n">new_stack</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the resource synchronously.</span>

<span class="sd">        Persist the resource&#39;s current_template_id to template_id and</span>
<span class="sd">        resource&#39;s requires to list of the required resource ids from the given</span>
<span class="sd">        resource_data and existing resource&#39;s requires, then updates the</span>
<span class="sd">        resource by invoking the scheduler TaskRunner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">update_tmpl_id_and_requires</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="n">template_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">resource_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
            <span class="n">new_res_def</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span>
                <span class="n">new_stack</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">new_res_type</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_class_to_instantiate</span><span class="p">(</span>
                <span class="n">new_res_def</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">restricted_actions</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_rsrc_restricted_actions</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">is_substituted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_is_substituted</span><span class="p">(</span><span class="n">new_res_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">new_res_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_substituted</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_convergence_replace</span><span class="p">(</span><span class="n">restricted_actions</span><span class="p">)</span>

            <span class="n">action_rollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">ROLLBACK</span>
            <span class="n">status_in_progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span>
            <span class="k">if</span> <span class="n">action_rollback</span> <span class="ow">and</span> <span class="n">status_in_progress</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restore_prev_rsrc</span><span class="p">(</span><span class="n">convergence</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                   <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">failure</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">failure</span>

            <span class="c1"># Use new resource as update method if existing resource</span>
            <span class="c1"># need to be substituted.</span>
            <span class="k">if</span> <span class="n">is_substituted</span><span class="p">:</span>
                <span class="n">substitute</span> <span class="o">=</span> <span class="n">new_res_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">substitute</span>
                <span class="n">updater</span> <span class="o">=</span> <span class="n">substitute</span><span class="o">.</span><span class="n">update</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updater</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">updater</span><span class="p">,</span> <span class="n">new_res_def</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">runner</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">)</span>
                <span class="n">update_tmpl_id_and_requires</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UpdateReplace</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                    <span class="n">update_tmpl_id_and_requires</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_tmpl_id_and_requires</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resource.preview_update"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.preview_update">[docs]</a>    <span class="k">def</span> <span class="nf">preview_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                       <span class="n">prev_resource</span><span class="p">,</span> <span class="n">check_init_complete</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulates update without actually updating the resource.</span>

<span class="sd">        Raises UpdateReplace, if replacement is required or returns True,</span>
<span class="sd">        if in-place update is required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_update</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                              <span class="n">prev_resource</span><span class="p">,</span> <span class="n">check_init_complete</span><span class="p">):</span>
            <span class="n">tmpl_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">freeze</span><span class="p">(),</span> <span class="n">before</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tmpl_diff</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_replace_with_tmpl_diff</span><span class="p">(</span><span class="n">tmpl_diff</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff_properties</span><span class="p">(</span><span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span></div>

    <span class="k">def</span> <span class="nf">_check_restricted_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span>
                                  <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                                  <span class="n">prev_resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks for restricted actions.</span>

<span class="sd">        Raises ResourceActionRestricted, if the resource requires update</span>
<span class="sd">        or replace and the required action is restricted.</span>

<span class="sd">        Else, Raises UpdateReplace, if replacement is required or returns</span>
<span class="sd">        True, if in-place update is required.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_update</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                                   <span class="n">prev_resource</span><span class="p">,</span> <span class="n">check_init_complete</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;update&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionRestricted</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">UpdateReplace</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;replace&#39;</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionRestricted</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_prepare_update_props</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">):</span>

        <span class="n">before_props</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Regenerate the schema, else validation would fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regenerate_info_schema</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
        <span class="n">after_props</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_properties</span><span class="p">(</span><span class="n">after_props</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_properties</span><span class="p">(</span><span class="n">before_props</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">observe_on_update</span> <span class="ow">and</span> <span class="n">before_props</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">resource_reality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_state</span><span class="p">(</span><span class="n">before_props</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resource_reality</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_properties_with_live_state</span><span class="p">(</span><span class="n">before_props</span><span class="p">,</span>
                                                            <span class="n">resource_reality</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Resource cannot be updated with it&#39;s &quot;</span>
                                <span class="s2">&quot;live state in case of next &quot;</span>
                                <span class="s2">&quot;error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span>

    <span class="k">def</span> <span class="nf">_prepare_update_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;ROLLBACK&#39;</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;IN_PROGRESS&#39;</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">):</span>
                <span class="c1"># handle case, when it&#39;s rollback and we should restore</span>
                <span class="c1"># old resource</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_prev_rsrc</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_replace</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># if any exception happen, we should set the resource to</span>
            <span class="c1"># FAILED, then raise ResourceFailure</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">failure</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">failure</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.check_is_substituted"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.check_is_substituted">[docs]</a>    <span class="k">def</span> <span class="nf">check_is_substituted</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_res_type</span><span class="p">):</span>
            <span class="n">support_status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;support_status&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">support_status</span><span class="p">:</span>
                <span class="n">is_substituted</span> <span class="o">=</span> <span class="n">support_status</span><span class="o">.</span><span class="n">is_substituted</span><span class="p">(</span><span class="n">new_res_type</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">is_substituted</span>
            <span class="k">return</span> <span class="bp">False</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.update"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prev_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a task to update the resource.</span>

<span class="sd">        Subclasses should provide a handle_update() method to customise update,</span>
<span class="sd">        the base-class handle_update will fail by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">before</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen_definition</span><span class="p">()</span>

        <span class="n">after_external_id</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">external_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_id</span> <span class="o">!=</span> <span class="n">after_external_id</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Update to property </span><span class="si">%(prop)s</span><span class="s2"> of </span><span class="si">%(name)s</span><span class="s2"> (</span><span class="si">%(res)s</span><span class="s2">)&quot;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;prop&#39;</span><span class="p">:</span> <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">RES_EXTERNAL_ID</span><span class="p">,</span>
                         <span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">after_external_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skip update on external resource.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_update_props</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">)</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_PRE_UPDATE</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
            <span class="n">restr_actions</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_rsrc_restricted_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">restr_actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_restricted_actions</span><span class="p">(</span><span class="n">restr_actions</span><span class="p">,</span>
                                                      <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span>
                                                      <span class="n">after_props</span><span class="p">,</span>
                                                      <span class="n">before_props</span><span class="p">,</span>
                                                      <span class="n">prev_resource</span><span class="p">):</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_update</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span>
                                          <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                                          <span class="n">prev_resource</span><span class="p">):</span>
                    <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)):</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Resource update already requested&#39;</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;updating </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">UpdateReplace</span><span class="p">):</span>
                <span class="n">after_props</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

                <span class="n">tmpl_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">freeze</span><span class="p">(),</span> <span class="n">before</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmpl_diff</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_replace_with_tmpl_diff</span><span class="p">(</span><span class="n">tmpl_diff</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="n">prop_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff_properties</span><span class="p">(</span><span class="n">after_props</span><span class="p">,</span>
                                                                 <span class="n">before_props</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">before_props</span>

                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span>
                                               <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">after</span><span class="p">,</span> <span class="n">tmpl_diff</span><span class="p">,</span>
                                                     <span class="n">prop_diff</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">after</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionRestricted</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
            <span class="c1"># catch all ResourceActionRestricted exceptions</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ae</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">failure</span>
        <span class="k">except</span> <span class="n">UpdateReplace</span><span class="p">:</span>
            <span class="c1"># catch all UpdateReplace exceptions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_update_replace</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_POST_UPDATE</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.prepare_for_replace"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.prepare_for_replace">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_for_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare resource for replacing.</span>

<span class="sd">        Some resources requires additional actions before replace them.</span>
<span class="sd">        If resource need to be changed before replacing, this method should</span>
<span class="sd">        be implemented in resource class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Resource.restore_prev_rsrc"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.restore_prev_rsrc">[docs]</a>    <span class="k">def</span> <span class="nf">restore_prev_rsrc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convergence</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore resource after rollback.</span>

<span class="sd">        Some resources requires additional actions after rollback.</span>
<span class="sd">        If resource need to be changed during rollback, this method should</span>
<span class="sd">        be implemented in resource class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Resource.check"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that the physical resource is in its expected state.</span>

<span class="sd">        Gets the current status of the physical resource and updates the</span>
<span class="sd">        database accordingly. If check is not supported by the resource,</span>
<span class="sd">        default action is to fail and revert the resource&#39;s status to its</span>
<span class="sd">        original state with the added message that check was not performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Checking </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not supported for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_verify_check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checks</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">check</span><span class="p">[</span><span class="s1">&#39;expected&#39;</span><span class="p">]</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%(attr)s</span><span class="s2">&#39;: expected &#39;</span><span class="si">%(expected)s</span><span class="s2">&#39;, got &#39;</span><span class="si">%(current)s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">invalid_checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">msg</span> <span class="o">%</span> <span class="n">check</span>
            <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">invalid_checks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_checks</span><span class="p">))</span>

<div class="viewcode-block" id="Resource.suspend"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.suspend">[docs]</a>    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a task to suspend the resource.</span>

<span class="sd">        Subclasses should provide a handle_suspend() method to implement</span>
<span class="sd">        suspend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span>

        <span class="c1"># Don&#39;t try to suspend the resource unless it&#39;s in a stable state</span>
        <span class="c1"># or if the previous suspend failed</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;State </span><span class="si">%s</span><span class="s1"> invalid for suspend&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;suspending </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.resume"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a task to resume the resource.</span>

<span class="sd">        Subclasses should provide a handle_resume() method to implement resume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span>

        <span class="c1"># Allow resume a resource if it&#39;s SUSPEND_COMPLETE</span>
        <span class="c1"># or RESUME_FAILED or RESUME_COMPLETE. Recommend to check</span>
        <span class="c1"># the real state of physical resource in handle_resume()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">),</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;State </span><span class="si">%s</span><span class="s1"> invalid for resume&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;resuming </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.snapshot"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Snapshot the resource and return the created data, if any.&quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;snapshotting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">)</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.delete_snapshot"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="s1">&#39;delete_snapshot&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">])</span></div>

<div class="viewcode-block" id="Resource.physical_resource_name"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.physical_resource_name">[docs]</a>    <span class="k">def</span> <span class="nf">physical_resource_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="n">short_id</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name_limit</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_physical_resource_name</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.reduce_physical_resource_name"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.reduce_physical_resource_name">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_physical_resource_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduce length of physical resource name to a limit.</span>

<span class="sd">        The reduced name will consist of the following:</span>

<span class="sd">        * the first 2 characters of the name</span>
<span class="sd">        * a hyphen</span>
<span class="sd">        * the end of the name, truncated on the left to bring</span>
<span class="sd">          the name length within the limit</span>

<span class="sd">        :param name: The name to reduce the length of</span>
<span class="sd">        :param limit: The max length limit</span>
<span class="sd">        :returns: A name whose length is less than or equal to the limit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;limit cannot be less than 4&#39;</span><span class="p">))</span>

        <span class="n">postfix_length</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="n">postfix_length</span><span class="p">:]</span></div>

<div class="viewcode-block" id="Resource.validate"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the resource.</span>

<span class="sd">        This may be overridden by resource plugins to add extra</span>
<span class="sd">        validation logic specific to the resource implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Validating </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_template</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resource.validate_template"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.validate_template">[docs]</a>    <span class="k">def</span> <span class="nf">validate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate structural/syntax aspects of the resource definition.</span>

<span class="sd">        Resource plugins should not override this, because this interface</span>
<span class="sd">        is expected to be called pre-create so things normally valid</span>
<span class="sd">        in an overridden validate() such as accessing properties</span>
<span class="sd">        may not work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">service_check_defer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_service_availability</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_type</span>
            <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="n">function</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_deletion_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">deletion_policy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">update_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_policy_schema</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
                <span class="n">with_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">strict_validate</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">get_section_name</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                <span class="n">error</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validate</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.validate_deletion_policy"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.validate_deletion_policy">[docs]</a>    <span class="k">def</span> <span class="nf">validate_deletion_policy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="o">.</span><span class="n">DELETION_POLICIES</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid deletion policy &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">policy</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;handle_snapshot_delete&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; deletion policy not supported&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">policy</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_replacement_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id</span><span class="p">):</span>
        <span class="c1"># Update the replacement resource&#39;s needed_by and replaces</span>
        <span class="c1"># fields. Make sure that the replacement belongs to the given</span>
        <span class="c1"># template and there is no engine working on it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_res</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Could not find replacement of resource </span><span class="si">%(name)s</span><span class="s2"> &quot;</span>
                         <span class="s2">&quot;with id </span><span class="si">%(id)s</span><span class="s2"> while updating needed_by.&quot;</span><span class="p">),</span>
                     <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">})</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">db_res</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">==</span> <span class="n">template_id</span><span class="p">):</span>
                <span class="c1"># Following update failure is ignorable; another</span>
                <span class="c1"># update might have locked/updated the resource.</span>
                <span class="n">db_res</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">,</span>
                     <span class="s1">&#39;replaces&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">},</span>
                    <span class="n">atomic_key</span><span class="o">=</span><span class="n">db_res</span><span class="o">.</span><span class="n">atomic_key</span><span class="p">,</span>
                    <span class="n">expected_engine_id</span><span class="o">=</span><span class="bp">None</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Resource.delete_convergence"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.delete_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">delete_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span>
                           <span class="n">progress_callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Destroys the resource if it doesn&#39;t belong to given template.</span>

<span class="sd">        The given template is suppose to be the current template being</span>
<span class="sd">        provisioned.</span>

<span class="sd">        Also, since this resource is visited as part of clean-up phase,</span>
<span class="sd">        the needed_by should be updated. If this resource was</span>
<span class="sd">        replaced by more recent resource, then delete this and update</span>
<span class="sd">        the replacement resource&#39;s needed_by and replaces fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">engine_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                      <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">!=</span> <span class="n">template_id</span><span class="p">:</span>
                <span class="c1"># just delete the resources in INIT state</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">runner</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>
                    <span class="n">runner</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                           <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_replacement_data</span><span class="p">(</span><span class="n">template_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.handle_delete"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.handle_delete">[docs]</a>    <span class="k">def</span> <span class="nf">handle_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; should be overridden by resources.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">ignore_not_found</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.delete"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A task to delete the resource.</span>

<span class="sd">        Subclasses should provide a handle_delete() method to customise</span>
<span class="sd">        deletion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nd">@excutils.exception_filter</span>
        <span class="k">def</span> <span class="nf">should_retry</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">retry_limit</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">PhysicalResourceExists</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">PhysicalResourceExists</span><span class="p">)</span>

        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># No need to delete if the resource has never been created</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">initial_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>

        <span class="c1"># This method can be called when we replace a resource, too. In that</span>
        <span class="c1"># case, a hook has already been dealt with in `Resource.update` so we</span>
        <span class="c1"># shouldn&#39;t do it here again:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_PRE_DELETE</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;deleting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># On delete we can&#39;t rely on re-resolving the properties</span>
            <span class="c1"># so use the stored frozen_definition instead</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen_definition</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span><span class="p">:</span>
                <span class="n">deletion_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RETAIN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deletion_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">deletion_policy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">deletion_policy</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RETAIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">deletion_policy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">:</span>
                    <span class="n">action_args</span> <span class="o">=</span> <span class="p">[[</span><span class="n">initial_state</span><span class="p">],</span> <span class="s1">&#39;snapshot&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action_args</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">retry_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">action_retry_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;delete </span><span class="si">%(name)s</span><span class="s1"> attempt </span><span class="si">%(attempt)d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span>
                             <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;attempt&#39;</span><span class="p">:</span> <span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                        <span class="n">delay</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">retry_backoff_delay</span><span class="p">(</span><span class="n">count</span><span class="p">,</span>
                                                              <span class="n">jitter_max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                        <span class="n">waiter</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">waiter</span><span class="o">.</span><span class="n">as_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">exception_filter</span><span class="p">(</span><span class="n">should_retry</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span>
                                                       <span class="o">*</span><span class="n">action_args</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_POST_DELETE</span><span class="p">)</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.destroy"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A task to delete the resource and remove it from the database.&quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="c1"># Don&#39;t fail on delete if the db entry has</span>
            <span class="c1"># not been created yet.</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Resource.resource_id_set"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.resource_id_set">[docs]</a>    <span class="k">def</span> <span class="nf">resource_id_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">inst</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;physical_resource_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;db error </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.store"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_metadata</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the resource in the database.</span>

<span class="sd">        If self.id is set, we update the existing stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">root_stack_id</span><span class="p">()</span>

        <span class="n">rs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
              <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
              <span class="s1">&#39;status_reason&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">),</span>
              <span class="s1">&#39;stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
              <span class="s1">&#39;physical_resource_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
              <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="s1">&#39;rsrc_prop_data_id&#39;</span><span class="p">:</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_create_or_replace_rsrc_prop_data</span><span class="p">(),</span>
              <span class="s1">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">,</span>
              <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">,</span>
              <span class="s1">&#39;replaces&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span><span class="p">,</span>
              <span class="s1">&#39;replaced_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">,</span>
              <span class="s1">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span><span class="p">,</span>
              <span class="s1">&#39;root_stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_stack_id</span><span class="p">,</span>
              <span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span><span class="p">,</span>
              <span class="s1">&#39;properties_data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">set_metadata</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>
            <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;rsrc_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">uuid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">created_at</span></div>

    <span class="k">def</span> <span class="nf">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a state change event to the database.&quot;&quot;&quot;</span>
        <span class="n">physical_res_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name</span><span class="p">()</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
                         <span class="n">physical_res_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>

        <span class="n">ev</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">dispatch_event</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

    <span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="Resource.lock"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.lock">[docs]</a>    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acquire</span><span class="p">(</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_release</span><span class="p">(</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_release</span><span class="p">(</span><span class="n">engine_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
        <span class="n">updated_ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">updated_ok</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;engine_id&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">},</span>
                <span class="n">atomic_key</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">atomic_key</span><span class="p">,</span>
                <span class="n">expected_engine_id</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;DB error </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_ok</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Resource </span><span class="si">%s</span><span class="s1"> is locked for update; deferring&#39;</span><span class="p">),</span>
                     <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="s1">&#39;Resource id:</span><span class="si">%(resource_id)s</span><span class="s1"> with &#39;</span>
                       <span class="s1">&#39;atomic_key:</span><span class="si">%(atomic_key)s</span><span class="s1">, locked &#39;</span>
                       <span class="s1">&#39;by engine_id:</span><span class="si">%(rs_engine_id)s</span><span class="s1">/</span><span class="si">%(engine_id)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
                           <span class="s1">&#39;resource_id&#39;</span><span class="p">:</span> <span class="n">rs</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;atomic_key&#39;</span><span class="p">:</span> <span class="n">rs</span><span class="o">.</span><span class="n">atomic_key</span><span class="p">,</span>
                           <span class="s1">&#39;rs_engine_id&#39;</span><span class="p">:</span> <span class="n">rs</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                           <span class="s1">&#39;engine_id&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">UpdateInProgress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">):</span>
            <span class="c1"># ignore: Resource is deleted holding a lock-on</span>
            <span class="k">return</span>

        <span class="n">atomic_key</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">atomic_key</span>
        <span class="k">if</span> <span class="n">atomic_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">atomic_key</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">updated_ok</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;engine_id&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
             <span class="s1">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span><span class="p">,</span>
             <span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span><span class="p">,</span>
             <span class="s1">&#39;requires&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">,</span>
             <span class="s1">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">},</span>
            <span class="n">expected_engine_id</span><span class="o">=</span><span class="n">engine_id</span><span class="p">,</span>
            <span class="n">atomic_key</span><span class="o">=</span><span class="n">atomic_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_ok</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;Failed to unlock resource </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method for resolving all attributes.</span>

<span class="sd">        This method uses basic _resolve_attribute method for resolving</span>
<span class="sd">        specific attributes. Base attributes will be resolved with</span>
<span class="sd">        corresponding method, which should be defined in each resource</span>
<span class="sd">        class.</span>

<span class="sd">        :param attr: attribute name, which will be resolved</span>
<span class="sd">        :returns: method of resource class, which resolve base attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_attributes_schema</span><span class="p">:</span>
            <span class="c1"># check resource_id, because usually it is required for getting</span>
            <span class="c1"># information about resource</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_{0}_resource&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">))()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">ignore_not_found</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_attribute</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">ignore_not_found</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_show_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; should be overridden by resources.</span>

<span class="sd">        :returns: the map of resource information or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">)</span>
                <span class="n">resource</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">resource</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Resolving &#39;show&#39; attribute has failed : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="Resource.get_live_resource_data"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.get_live_resource_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_live_resource_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; can be overridden by resources.</span>

<span class="sd">        Get resource data and handle it with exceptions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_resource</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">()</span><span class="o">.</span><span class="n">is_not_found</span><span class="p">(</span><span class="n">ex</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EntityNotFound</span><span class="p">(</span>
                    <span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">resource_data</span></div>

<div class="viewcode-block" id="Resource.parse_live_resource_data"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.parse_live_resource_data">[docs]</a>    <span class="k">def</span> <span class="nf">parse_live_resource_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_properties</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; can be overridden by resources.</span>

<span class="sd">        Parse resource data for using it in updating properties with live</span>
<span class="sd">        state.</span>
<span class="sd">        :param resource_properties: properties of stored resource plugin.</span>
<span class="sd">        :param resource_data: data from current live state of a resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_allowed_properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">resource_data</span><span class="p">:</span>
                <span class="n">resource_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resource_result</span></div>

<div class="viewcode-block" id="Resource.get_live_state"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.get_live_state">[docs]</a>    <span class="k">def</span> <span class="nf">get_live_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; should be overridden by resources.</span>

<span class="sd">        :param resource_properties: resource&#39;s object of Properties class.</span>
<span class="sd">        :returns: dict of resource&#39;s real state of properties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resource_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_resource_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resource_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_live_resource_data</span><span class="p">(</span><span class="n">resource_properties</span><span class="p">,</span>
                                             <span class="n">resource_data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_properties_with_live_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_properties</span><span class="p">,</span>
                                           <span class="n">live_properties</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update resource properties data with live state properties.</span>

<span class="sd">        Note, that live_properties can contains None values, so there&#39;s next</span>
<span class="sd">        situation: property equals to some value, but live state has no such</span>
<span class="sd">        property, i.e. property equals to None, so during update property</span>
<span class="sd">        should be updated with None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">resource_properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">live_properties</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resource_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">live_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">resource_properties</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">live_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">_resolve_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation of resolving resource&#39;s attributes.</span>

<span class="sd">        Should be overridden by resources, that expose attributes.</span>

<span class="sd">        :param name: The attribute to resolve</span>
<span class="sd">        :returns: the resource attribute named key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># By default, no attributes resolve</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Resource.regenerate_info_schema"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.regenerate_info_schema">[docs]</a>    <span class="k">def</span> <span class="nf">regenerate_info_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation; should be overridden by resources.</span>

<span class="sd">        Should be overridden by resources that would require schema refresh</span>
<span class="sd">        during update, ex. TemplateResource.</span>

<span class="sd">        :definition: Resource Definition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># By default, do not regenerate</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Resource.state_reset"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.state_reset">[docs]</a>    <span class="k">def</span> <span class="nf">state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset state to (INIT, COMPLETE).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span></div>

<div class="viewcode-block" id="Resource.state_set"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.state_set">[docs]</a>    <span class="k">def</span> <span class="nf">state_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;state changed&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid action </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUSES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid status </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="n">old_state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="n">set_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">set_metadata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_state</span> <span class="o">!=</span> <span class="n">old_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">reset_resource_attributes</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns state, tuple of action, status.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.get_reference_id"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.get_reference_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_reference_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation for function get_resource.</span>

<span class="sd">        This may be overridden by resource plugins to add extra</span>
<span class="sd">        logic specific to the resource implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.FnGetRefId"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.FnGetRefId">[docs]</a>    <span class="k">def</span> <span class="nf">FnGetRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the intrinsic function Ref.</span>

<span class="sd">        :results: the id or name of the resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">cache_data_reference_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reference_id</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resource.physical_resource_name_or_FnGetRefId"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.physical_resource_name_or_FnGetRefId">[docs]</a>    <span class="k">def</span> <span class="nf">physical_resource_name_or_FnGetRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">res_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Resource</span><span class="o">.</span><span class="n">get_reference_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.get_attribute"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.get_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Default implementation for function get_attr and Fn::GetAtt.</span>

<span class="sd">        This may be overridden by resource plugins to add extra</span>
<span class="sd">        logic specific to the resource implementation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidTemplateAttribute</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                     <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">attributes</span><span class="o">.</span><span class="n">select_from_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.FnGetAtt"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.FnGetAtt">[docs]</a>    <span class="k">def</span> <span class="nf">FnGetAtt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the intrinsic function Fn::GetAtt.</span>

<span class="sd">        :param key: the attribute key.</span>
<span class="sd">        :param path: a list of path components to select from the attribute.</span>
<span class="sd">        :returns: the attribute value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="c1"># Load from cache for lightweight resources.</span>
            <span class="n">complex_key</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">complex_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">cache_data_resource_attribute</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">complex_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">attribute</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.FnGetAtts"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.FnGetAtts">[docs]</a>    <span class="k">def</span> <span class="nf">FnGetAtts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the intrinsic function get_attr which returns all attributes.</span>

<span class="sd">        :returns: dict of all resource&#39;s attributes exclude &quot;show&quot; attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">cache_data_resource_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">))</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOW</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span></div>

<div class="viewcode-block" id="Resource.FnBase64"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.FnBase64">[docs]</a>    <span class="k">def</span> <span class="nf">FnBase64</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the intrinsic function Fn::Base64.</span>

<span class="sd">        :param data: the input data.</span>
<span class="sd">        :returns: the Base64 representation of the input data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_signal_check_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_signal_actions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                            <span class="s1">&#39;Cannot signal resource during </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Signal resource during </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_signal_check_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">details</span> <span class="ow">and</span> <span class="s1">&#39;unset_hook&#39;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">hook</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;unset_hook&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">environment</span><span class="o">.</span><span class="n">valid_hook_type</span><span class="p">(</span><span class="n">hook</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid hook type &quot;</span><span class="si">%(hook)s</span><span class="s1">&quot; for </span><span class="si">%(resource)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span>
                       <span class="p">{</span><span class="s1">&#39;hook&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidBreakPointHook</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The &quot;</span><span class="si">%(hook)s</span><span class="s1">&quot; hook is not defined &#39;</span>
                         <span class="s1">&#39;on </span><span class="si">%(resource)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span>
                       <span class="p">{</span><span class="s1">&#39;hook&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidBreakPointHook</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unset_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="c1"># Clear the hook without interfering with resources&#39;</span>
        <span class="c1"># `handle_signal` callbacks:</span>
        <span class="n">hook</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;unset_hook&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Clearing </span><span class="si">%(hook)s</span><span class="s1"> hook on </span><span class="si">%(resource)s</span><span class="s1">&#39;</span><span class="p">),</span>
                 <span class="p">{</span><span class="s1">&#39;hook&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">,</span> <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;Hook </span><span class="si">%s</span><span class="s2"> is cleared&quot;</span> <span class="o">%</span> <span class="n">hook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_signal&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionNotSupported</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_string_details</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">details</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;No signal details provided&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">details</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">details</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;reason&#39;</span><span class="p">)):</span>
                    <span class="c1"># this is from Ceilometer.</span>
                    <span class="n">auto</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(previous)s</span><span class="s1"> to </span><span class="si">%(current)s</span><span class="s1"> (</span><span class="si">%(reason)s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">details</span>
                    <span class="k">return</span> <span class="s1">&#39;alarm state changed from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">auto</span>
                <span class="k">elif</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
                    <span class="c1"># this is from watchrule</span>
                    <span class="k">return</span> <span class="s1">&#39;alarm state changed to </span><span class="si">%(state)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">details</span>

            <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_signal</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal_result</span><span class="p">:</span>
                <span class="n">reason_string</span> <span class="o">=</span> <span class="s2">&quot;Signal: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">signal_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason_string</span> <span class="o">=</span> <span class="n">get_string_details</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="s1">&#39;SIGNAL&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">reason_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoActionRequired</span><span class="p">:</span>
            <span class="c1"># Don&#39;t log an event as it just spams the user.</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;signal </span><span class="si">%(name)s</span><span class="s1"> : </span><span class="si">%(msg)s</span><span class="s1">&#39;</span><span class="p">),</span>
                     <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                      <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)},</span>
                     <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">failure</span>

<div class="viewcode-block" id="Resource.signal"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.signal">[docs]</a>    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">need_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signal the resource.</span>

<span class="sd">        Returns True if the metadata for all resources in the stack needs to</span>
<span class="sd">        be regenerated as a result of the signal, False if it should not be.</span>

<span class="sd">        Subclasses should provide a handle_signal() method to implement the</span>
<span class="sd">        signal. The base-class raise an exception if no handler is implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">need_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_check_action</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signal_check_hook</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span> <span class="ow">and</span> <span class="s1">&#39;unset_hook&#39;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unset_hook</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_signal</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_needs_metadata_updates</span></div>

<div class="viewcode-block" id="Resource.handle_update"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.handle_update">[docs]</a>    <span class="k">def</span> <span class="nf">handle_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_snippet</span><span class="p">,</span> <span class="n">tmpl_diff</span><span class="p">,</span> <span class="n">prop_diff</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prop_diff</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resource.metadata_update"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.metadata_update">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;No-op for resources which don&#39;t explicitly override this method.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_metadata</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Resource </span><span class="si">%s</span><span class="s2"> does not implement metadata update&quot;</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.resource_to_template"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.resource_to_template">[docs]</a>    <span class="k">def</span> <span class="nf">resource_to_template</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="s1">&#39;cfn&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a provider template that mirrors the resource.</span>

<span class="sd">        :param resource_type: The resource type to be displayed in the template</span>
<span class="sd">        :param template_type: the template type to generate, cfn or hot.</span>
<span class="sd">        :returns: A template where the resource&#39;s properties_schema is mapped</span>
<span class="sd">            as parameters, and the resource&#39;s attributes_schema is mapped as</span>
<span class="sd">            outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">props_schema</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_dict</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">properties_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">from_legacy</span><span class="p">(</span><span class="n">schema_dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">support</span><span class="o">.</span><span class="n">HIDDEN</span><span class="p">:</span>
                <span class="n">props_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>

        <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span>
                         <span class="n">schema_to_parameters_and_properties</span><span class="p">(</span><span class="n">props_schema</span><span class="p">,</span>
                                                             <span class="n">template_type</span><span class="p">))</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">as_outputs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span>
                                                   <span class="n">template_type</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Initial template of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resource_name</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">build_template_dict</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span>
                                       <span class="n">template_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span>
                                       <span class="n">outputs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.build_template_dict"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.build_template_dict">[docs]</a>    <span class="k">def</span> <span class="nf">build_template_dict</span><span class="p">(</span><span class="n">res_name</span><span class="p">,</span> <span class="n">res_type</span><span class="p">,</span> <span class="n">tmpl_type</span><span class="p">,</span>
                            <span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tmpl_type</span> <span class="o">==</span> <span class="s1">&#39;hot&#39;</span><span class="p">:</span>
            <span class="n">tmpl_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span> <span class="s1">&#39;2016-10-14&#39;</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">res_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">RES_TYPE</span><span class="p">:</span> <span class="n">res_type</span><span class="p">,</span>
                        <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20161014</span><span class="o">.</span><span class="n">RES_PROPERTIES</span><span class="p">:</span> <span class="n">props</span><span class="p">}}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmpl_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">ALTERNATE_VERSION</span><span class="p">:</span> <span class="s1">&#39;2012-12-12&#39;</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">res_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">RES_TYPE</span><span class="p">:</span> <span class="n">res_type</span><span class="p">,</span>
                        <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">RES_PROPERTIES</span><span class="p">:</span> <span class="n">props</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">tmpl_dict</span></div>

<div class="viewcode-block" id="Resource.data"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the resource data for this resource.</span>

<span class="sd">        Use methods data_set and data_delete to modify the resource data</span>
<span class="sd">        for this resource.</span>

<span class="sd">        :returns: a dict representing the resource data for this resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">or</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Resource.data_set"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.data_set">[docs]</a>    <span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">redact</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a key in the resource data.&quot;&quot;&quot;</span>
        <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">redact</span><span class="p">)</span>
        <span class="c1"># force fetch all resource data from the database again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Resource.data_delete"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.data_delete">[docs]</a>    <span class="k">def</span> <span class="nf">data_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a key from the resource data.</span>

<span class="sd">        :returns: True if the key existed to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># force fetch all resource data from the database again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">True</span></div>

    <span class="k">def</span> <span class="nf">_create_or_replace_rsrc_prop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span> <span class="o">=</span> \
            <span class="n">rpd_objects</span><span class="o">.</span><span class="n">ResourcePropertiesData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_prop_data</span><span class="o">.</span><span class="n">id</span>

<div class="viewcode-block" id="Resource.is_using_neutron"><a class="viewcode-back" href="../../../api/heat.engine.resource.html#heat.engine.resource.Resource.is_using_neutron">[docs]</a>    <span class="k">def</span> <span class="nf">is_using_neutron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sess_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;neutron&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">httpclient</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sess_client</span><span class="o">.</span><span class="n">get_endpoint</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_resolver</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an attribute resolution method.</span>

<span class="sd">        This builds a resolver without a strong reference to this resource, to</span>
<span class="sd">        break a possible cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">ref</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Resource collected&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">_resolve_all_attributes</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolve</span></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/heat
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">heat 8.0.0.0rc2.dev38 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012,2013 Heat Developers.
      Last updated on &#39;Tue Feb 14 11:42:51 2017, commit 3ffc97c&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/heat");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>