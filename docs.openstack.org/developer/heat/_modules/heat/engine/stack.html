<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.stack &mdash; heat 8.0.0.0rc2.dev38 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '8.0.0.0rc2.dev38',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="heat 8.0.0.0rc2.dev38 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heat.engine.stack</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">eventlet</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">keystoneauth1</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">ks_exceptions</span>
<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">encodeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">excutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">timeutils</span> <span class="k">as</span> <span class="n">oslo_timeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">from</span> <span class="nn">osprofiler</span> <span class="kn">import</span> <span class="n">profiler</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">common_context</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">environment_format</span> <span class="k">as</span> <span class="n">env_fmt</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">lifecycle_plugin_utils</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">dependencies</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">heat.engine.notification</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">notification</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">parameter_groups</span> <span class="k">as</span> <span class="n">param_groups</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resource</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">scheduler</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">sync_point</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">raw_template</span> <span class="k">as</span> <span class="n">raw_template_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">snapshot</span> <span class="k">as</span> <span class="n">snapshot_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack_tag</span> <span class="k">as</span> <span class="n">stack_tag_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">user_creds</span> <span class="k">as</span> <span class="n">ucreds_object</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">rpc_api</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">worker_client</span> <span class="k">as</span> <span class="n">rpc_worker_client</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ForcedCancel"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.ForcedCancel">[docs]</a><span class="k">class</span> <span class="nc">ForcedCancel</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised to cancel task execution.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_rollback</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_rollback</span> <span class="o">=</span> <span class="n">with_rollback</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Operation cancelled&quot;</span></div>


<div class="viewcode-block" id="reset_state_on_error"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.reset_state_on_error">[docs]</a><span class="k">def</span> <span class="nf">reset_state_on_error</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@six.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_exceptions</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">errmsg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Unexpected exception in </span><span class="si">%(func)s</span><span class="s1">: </span><span class="si">%(msg)s</span><span class="s1">&#39;</span><span class="p">),</span>
                          <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">errmsg</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="n">exc_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Stopped due to </span><span class="si">%(msg)s</span><span class="s1"> in </span><span class="si">%(func)s</span><span class="s1">&#39;</span><span class="p">),</span>
                         <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">errmsg</span><span class="p">})</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
                <span class="n">rtnmsg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unexpected exit while IN_PROGRESS.&quot;</span><span class="p">)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                <span class="n">errmsg</span> <span class="k">if</span> <span class="n">errmsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">rtnmsg</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">errmsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">&quot;Returned while IN_PROGRESS.&quot;</span>

    <span class="k">return</span> <span class="n">handle_exceptions</span></div>


<span class="nd">@six.python_2_unicode_compatible</span>
<div class="viewcode-block" id="Stack"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack">[docs]</a><span class="k">class</span> <span class="nc">Stack</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>

    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">CREATE</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">ROLLBACK</span><span class="p">,</span> <span class="n">SUSPEND</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="n">ADOPT</span><span class="p">,</span>
        <span class="n">SNAPSHOT</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">,</span> <span class="n">RESTORE</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;CREATE&#39;</span><span class="p">,</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;UPDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;ROLLBACK&#39;</span><span class="p">,</span> <span class="s1">&#39;SUSPEND&#39;</span><span class="p">,</span> <span class="s1">&#39;RESUME&#39;</span><span class="p">,</span> <span class="s1">&#39;ADOPT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SNAPSHOT&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;RESTORE&#39;</span>
    <span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">COMPLETE</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;IN_PROGRESS&#39;</span><span class="p">,</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">,</span> <span class="s1">&#39;COMPLETE&#39;</span><span class="p">)</span>

    <span class="n">_zones</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                 <span class="n">stack_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">status_reason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">timeout_mins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">disable_rollback</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parent_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">adopt_stack_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">created_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">updated_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">convergence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">current_traversal</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prev_raw_template_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">current_deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cache_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resource_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">service_check_defer</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">deleted_time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Initialise the Stack.</span>

<span class="sd">        Initialise from a context, name, Template object and (optionally)</span>
<span class="sd">        Environment object. The database ID may also be initialised, if the</span>
<span class="sd">        stack is already in the database.</span>

<span class="sd">        Creating a stack with cache_data creates a lightweight stack which</span>
<span class="sd">        will not load any resources from the database and resolve the</span>
<span class="sd">        functions from the cache_data specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_validate_stack_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[a-zA-Z][a-zA-Z0-9_.-]{0,254}$&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid stack name </span><span class="si">%s</span><span class="s1"> must contain &#39;</span>
                                <span class="s1">&#39;only alphanumeric or </span><span class="se">\&quot;</span><span class="s1">_-.</span><span class="se">\&quot;</span><span class="s1"> characters, &#39;</span>
                                <span class="s1">&#39;must start with alpha and must be 255 &#39;</span>
                                <span class="s1">&#39;characters or less.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">name</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid stack name </span><span class="si">%s</span><span class="s1">, must be a string&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">name</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">owner_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_validate_stack_name</span><span class="p">(</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">stack_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">owner_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">tmpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">stack_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span> <span class="k">if</span> <span class="n">adopt_stack_data</span> <span class="k">else</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span> <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">status_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">=</span> <span class="n">timeout_mins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="o">=</span> <span class="n">disable_rollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span> <span class="o">=</span> <span class="n">parent_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_stack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adopt_stack_data</span> <span class="o">=</span> <span class="n">adopt_stack_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="o">=</span> <span class="n">stack_user_project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">created_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">updated_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleted_time</span> <span class="o">=</span> <span class="n">deleted_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="n">user_creds_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nested_depth</span> <span class="o">=</span> <span class="n">nested_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="n">current_traversal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="n">prev_raw_template_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_deps</span> <span class="o">=</span> <span class="n">current_deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span> <span class="o">=</span> <span class="n">cache_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_client</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convg_deps</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># strict_validate can be used to disable value validation</span>
        <span class="c1"># in the resource properties schema, this is useful when</span>
        <span class="c1"># performing validation when properties reference attributes</span>
        <span class="c1"># for not-yet-created resources (which return None)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span> <span class="o">=</span> <span class="n">strict_validate</span>

        <span class="c1"># resource_validate can be used to disable resource plugin subclass</span>
        <span class="c1"># validate methods, which is useful when you want to validate</span>
        <span class="c1"># template integrity but some parameters may not be provided</span>
        <span class="c1"># at all, thus we can&#39;t yet reference property values such as is</span>
        <span class="c1"># commonly done in plugin validate() methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_validate</span> <span class="o">=</span> <span class="n">resource_validate</span>

        <span class="c1"># service_check_defer can be used to defer the validation of service</span>
        <span class="c1"># availability for a given resource, which helps to create the resource</span>
        <span class="c1"># dependency tree completely when respective service is not available,</span>
        <span class="c1"># especially during template_validate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_check_defer</span> <span class="o">=</span> <span class="n">service_check_defer</span>

        <span class="k">if</span> <span class="n">use_stored_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_context</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">clients</span>

        <span class="c1"># This will use the provided tenant ID when loading the stack</span>
        <span class="c1"># from the DB or get it from the context for new stacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">tenant_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">username</span>

        <span class="n">resources</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">(),</span>
                <span class="n">user_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">param_defaults</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">param_defaults</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tags</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>

    <span class="nd">@tags.setter</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">worker_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a client for making engine RPC calls.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_client</span> <span class="o">=</span> <span class="n">rpc_worker_client</span><span class="o">.</span><span class="n">WorkerClient</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a helper to allow resources to access stack.env.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dynamically load up the parent_resource.</span>

<span class="sd">        Note: this should only be used by &quot;Fn::ResourceFacade&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># we need both parent name and owner id.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_stack</span> <span class="o">=</span> <span class="n">owner</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_stack</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span><span class="p">]</span>

<div class="viewcode-block" id="Stack.set_parent_stack"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.set_parent_stack">[docs]</a>    <span class="k">def</span> <span class="nf">set_parent_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_stack</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_stack</span> <span class="o">=</span> <span class="n">parent_stack</span></div>

<div class="viewcode-block" id="Stack.stored_context"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.stored_context">[docs]</a>    <span class="k">def</span> <span class="nf">stored_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
            <span class="n">creds_obj</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
            <span class="c1"># Maintain request_id from self.context so we retain traceability</span>
            <span class="c1"># in situations where servicing a request requires switching from</span>
            <span class="c1"># the request context to the stored context</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">creds_obj</span><span class="o">.</span><span class="n">obj_to_primitive</span><span class="p">()[</span><span class="s2">&quot;versioned_object.data&quot;</span><span class="p">]</span>
            <span class="n">creds</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">request_id</span>
            <span class="c1"># We don&#39;t store roles in the user_creds table, so disable the</span>
            <span class="c1"># policy check for admin by setting is_admin=False.</span>
            <span class="n">creds</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">creds</span><span class="p">[</span><span class="s1">&#39;overwrite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">return</span> <span class="n">common_context</span><span class="o">.</span><span class="n">StoredContext</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Attempt to use stored_context with no user_creds&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">res_defns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                                   <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">res_defns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span>

    <span class="k">def</span> <span class="nf">_find_filtered_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">rsrc_def_cache</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> \
                <span class="s2">&quot;Resources should not be loaded from the DB&quot;</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_stack</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources_get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rsc</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">resources</span><span class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_from_db_resource</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="n">rsrc_def_cache</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.iter_resources"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.iter_resources">[docs]</a>    <span class="k">def</span> <span class="nf">iter_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterates over all the resources in a stack.</span>

<span class="sd">        Iterating includes nested stacks up to `nested_depth` levels below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_filtered_resources</span><span class="p">(</span><span class="n">filters</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">res</span>

        <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_filtered_resources</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">has_nested</span><span class="p">()</span> <span class="ow">or</span> <span class="n">nested_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nested_stack</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nested_stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">nested_res</span> <span class="ow">in</span> <span class="n">nested_stack</span><span class="o">.</span><span class="n">iter_resources</span><span class="p">(</span><span class="n">nested_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                          <span class="n">filters</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">nested_res</span></div>

<div class="viewcode-block" id="Stack.db_active_resources_get"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.db_active_resources_get">[docs]</a>    <span class="k">def</span> <span class="nf">db_active_resources_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_active_by_stack</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resources</span> <span class="ow">or</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Stack.db_resource_get"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.db_resource_get">[docs]</a>    <span class="k">def</span> <span class="nf">db_resource_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources_get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_db_resources_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> \
                <span class="s2">&quot;Resources should not be loaded from the DB&quot;</span>
            <span class="n">_db_resources</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_stack</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_db_resources</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="o">=</span> <span class="n">_db_resources</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span>

    <span class="k">def</span> <span class="nf">_resource_from_db_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_res</span><span class="p">,</span> <span class="n">rsrc_def_cache</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="n">db_res</span><span class="o">.</span><span class="n">current_template_id</span>
        <span class="k">if</span> <span class="n">tid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="n">rsrc_def_cache</span> <span class="ow">and</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">rsrc_def_cache</span><span class="p">:</span>
            <span class="n">rsrc_def</span> <span class="o">=</span> <span class="n">rsrc_def_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">tid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">rsrc_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rsrc_def_cache</span><span class="p">:</span>
                <span class="n">rsrc_def_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsrc_def</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">tid</span><span class="p">)</span>
            <span class="n">rsrc_def</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rsrc_def_cache</span><span class="p">:</span>
                <span class="n">rsrc_def_cache</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsrc_def</span>

        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">db_res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rsrc_def</span><span class="p">[</span><span class="n">db_res</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.resource_get"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.resource_get">[docs]</a>    <span class="k">def</span> <span class="nf">resource_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a stack resource, even if not in the current template.&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># fall back to getting the resource from the database</span>
        <span class="n">db_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_resource_get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db_res</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_from_db_resource</span><span class="p">(</span><span class="n">db_res</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies</span><span class="p">(</span>
                <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span>

<div class="viewcode-block" id="Stack.reset_dependencies"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.reset_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">reset_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Stack.root_stack_id"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.root_stack_id">[docs]</a>    <span class="k">def</span> <span class="nf">root_stack_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_root_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stack.object_path_in_stack"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.object_path_in_stack">[docs]</a>    <span class="k">def</span> <span class="nf">object_path_in_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return stack resources and stacks in path from the root stack.</span>

<span class="sd">        If this is not nested return (None, self), else return stack resources</span>
<span class="sd">        and stacks in path from the root stack and including this stack.</span>

<span class="sd">        :returns: a list of (stack_resource, stack) tuples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">object_path_in_stack</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Stack.path_in_stack"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.path_in_stack">[docs]</a>    <span class="k">def</span> <span class="nf">path_in_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return tuples of names in path from the root stack.</span>

<span class="sd">        If this is not nested return (None, self.name), else return tuples of</span>
<span class="sd">        names (stack_resource.name, stack.name) in path from the root stack and</span>
<span class="sd">        including this stack.</span>

<span class="sd">        :returns: a list of (string, string) tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_path_in_stack</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">stckres</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">stckres</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">stck</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">stck</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">stckres</span><span class="p">,</span> <span class="n">stck</span> <span class="ow">in</span> <span class="n">opis</span><span class="p">]</span></div>

<div class="viewcode-block" id="Stack.total_resources"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.total_resources">[docs]</a>    <span class="k">def</span> <span class="nf">total_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total number of resources in a stack.</span>

<span class="sd">        Includes nested stacks below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="c1"># We&#39;re not stored yet, so we don&#39;t have anything to count</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">count_total_resources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_param_stackid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update self.parameters with the current ARN.</span>

<span class="sd">        The ARN is then provided via the Parameters class as the StackId pseudo</span>
<span class="sd">        parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Unable to set parameters StackId identifier&quot;</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Stack.get_dep_attrs"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.get_dep_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">get_dep_attrs</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the attributes of the specified resource that are referenced.</span>

<span class="sd">        Return an iterator over any attributes of the specified resource that</span>
<span class="sd">        are referenced in resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
            <span class="n">res</span><span class="o">.</span><span class="n">dep_attrs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_get_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the dependency graph for a list of resources.&quot;&quot;&quot;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">Dependencies</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">add_explicit_dependencies</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s1">&#39;Ignoring error adding implicit &#39;</span>
                                    <span class="s1">&#39;dependencies for </span><span class="si">%(res)s</span><span class="s1">: </span><span class="si">%(err)s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span>
                                <span class="p">{</span><span class="s1">&#39;res&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
                                 <span class="s1">&#39;err&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">)})</span>

        <span class="k">return</span> <span class="n">deps</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Stack.load"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force_reload</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cache_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">service_check_defer</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">resource_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">load_template</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve a Stack from the database.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">stack_id</span><span class="p">,</span>
                <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;No stack exists with id &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_db</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span>
                            <span class="n">use_stored_context</span><span class="o">=</span><span class="n">use_stored_context</span><span class="p">,</span>
                            <span class="n">cache_data</span><span class="o">=</span><span class="n">cache_data</span><span class="p">,</span>
                            <span class="n">service_check_defer</span><span class="o">=</span><span class="n">service_check_defer</span><span class="p">,</span>
                            <span class="n">resource_validate</span><span class="o">=</span><span class="n">resource_validate</span><span class="p">,</span>
                            <span class="n">load_template</span><span class="o">=</span><span class="n">load_template</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Stack.load_all"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.load_all">[docs]</a>    <span class="k">def</span> <span class="nf">load_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
            <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">show_nested</span><span class="o">=</span><span class="n">show_nested</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="o">=</span><span class="n">show_hidden</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">tags_any</span><span class="o">=</span><span class="n">tags_any</span><span class="p">,</span>
            <span class="n">not_tags</span><span class="o">=</span><span class="n">not_tags</span><span class="p">,</span>
            <span class="n">not_tags_any</span><span class="o">=</span><span class="n">not_tags_any</span><span class="p">,</span>
            <span class="n">eager_load</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_db</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="c1"># We&#39;re in a different transaction than the get_all, so a stack</span>
                <span class="c1"># returned above can be deleted by the time we try to load it.</span>
                <span class="k">pass</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span>
                 <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cache_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">service_check_defer</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">resource_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">load_template</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">load_template</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">raw_template_id</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">raw_template</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                   <span class="n">stack_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                   <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                   <span class="n">status_reason</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">status_reason</span><span class="p">,</span>
                   <span class="n">timeout_mins</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                   <span class="n">disable_rollback</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">,</span>
                   <span class="n">parent_resource</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">parent_resource_name</span><span class="p">,</span>
                   <span class="n">owner_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">owner_id</span><span class="p">,</span>
                   <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">,</span>
                   <span class="n">created_time</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                   <span class="n">updated_time</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
                   <span class="n">user_creds_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">,</span> <span class="n">tenant_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span>
                   <span class="n">use_stored_context</span><span class="o">=</span><span class="n">use_stored_context</span><span class="p">,</span>
                   <span class="n">username</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">convergence</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">,</span>
                   <span class="n">current_traversal</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
                   <span class="n">prev_raw_template_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">prev_raw_template_id</span><span class="p">,</span>
                   <span class="n">current_deps</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">cache_data</span><span class="o">=</span><span class="n">cache_data</span><span class="p">,</span>
                   <span class="n">nested_depth</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">nested_depth</span><span class="p">,</span>
                   <span class="n">deleted_time</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">deleted_at</span><span class="p">,</span>
                   <span class="n">service_check_defer</span><span class="o">=</span><span class="n">service_check_defer</span><span class="p">,</span>
                   <span class="n">resource_validate</span><span class="o">=</span><span class="n">resource_validate</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.get_kwargs_for_cloning"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.get_kwargs_for_cloning">[docs]</a>    <span class="k">def</span> <span class="nf">get_kwargs_for_cloning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_status</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only_db</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get common kwargs for calling Stack() for cloning.</span>

<span class="sd">        The point of this method is to reduce the number of places that we</span>
<span class="sd">        need to update when a kwarg to Stack.__init__() is modified. It</span>
<span class="sd">        is otherwise easy to forget an option and cause some unexpected</span>
<span class="sd">        error if this option is lost.</span>

<span class="sd">        Note:</span>
<span class="sd">        - This doesn&#39;t return the args(name, template) but only the kwargs.</span>
<span class="sd">        - We often want to start &#39;fresh&#39; so don&#39;t want to maintain the old</span>
<span class="sd">          status, action and status_reason.</span>
<span class="sd">        - We sometimes only want the DB attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;owner_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s1">&#39;disable_rollback&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">,</span>
            <span class="s1">&#39;stack_user_project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">,</span>
            <span class="s1">&#39;user_creds_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">,</span>
            <span class="s1">&#39;nested_depth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_depth</span><span class="p">,</span>
            <span class="s1">&#39;convergence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">,</span>
            <span class="s1">&#39;current_traversal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
            <span class="s1">&#39;prev_raw_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span><span class="p">,</span>
            <span class="s1">&#39;current_deps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_deps</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">keep_status</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                <span class="s1">&#39;status_reason&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">)})</span>

        <span class="k">if</span> <span class="n">only_db</span><span class="p">:</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;parent_resource_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;tenant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;parent_resource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;tenant_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;timeout_mins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span>
            <span class="n">stack</span><span class="p">[</span><span class="s1">&#39;strict_validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span>

        <span class="k">return</span> <span class="n">stack</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.store&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.store"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exp_trvsl</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">ignore_traversal_check</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store the stack in the database and return its ID.</span>

<span class="sd">        If self.id is set, we update the existing stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">(</span><span class="n">keep_status</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_db</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">s</span><span class="p">[</span><span class="s1">&#39;backup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup</span>
        <span class="n">s</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">encrypt_hidden_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;raw_template_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="s1">&#39;raw_template_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exp_trvsl</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_traversal_check</span><span class="p">:</span>
                <span class="n">exp_trvsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                <span class="c1"># do things differently for convergence</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">exp_trvsl</span><span class="o">=</span><span class="n">exp_trvsl</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
                <span class="c1"># Create a context containing a trust_id and trustor_user_id</span>
                <span class="c1"># if trusts are enabled</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">deferred_auth_method</span> <span class="o">==</span> <span class="s1">&#39;trusts&#39;</span><span class="p">:</span>
                    <span class="n">keystone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;keystone&#39;</span><span class="p">)</span>
                    <span class="n">trust_ctx</span> <span class="o">=</span> <span class="n">keystone</span><span class="o">.</span><span class="n">create_trust_context</span><span class="p">()</span>
                    <span class="n">new_creds</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">trust_ctx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_creds</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;user_creds_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_creds</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="n">new_creds</span><span class="o">.</span><span class="n">id</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                    <span class="c1"># create a traversal ID</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
                    <span class="n">s</span><span class="p">[</span><span class="s1">&#39;current_traversal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span>

            <span class="n">new_s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_s</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">new_s</span><span class="o">.</span><span class="n">created_at</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span></div>

    <span class="k">def</span> <span class="nf">_backup_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Stack.identifier"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.identifier">[docs]</a>    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an identifier for this stack.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">HeatIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an iterator over the resource names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of resources.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the resource with the specified name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Stack.add_resource"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.add_resource">[docs]</a>    <span class="k">def</span> <span class="nf">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Insert the given resource into the stack.&quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">reparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.remove_resource"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.remove_resource">[docs]</a>    <span class="k">def</span> <span class="nf">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the resource with the specified name.&quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether the stack contains the specified resource.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two Stacks for equality.</span>

<span class="sd">        Stacks are considered equal only if they are identical.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a human-readable string representation of the stack.&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;Stack &quot;</span><span class="si">%s</span><span class="s1">&quot; [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.resource_by_refid"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.resource_by_refid">[docs]</a>    <span class="k">def</span> <span class="nf">resource_by_refid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the resource in this stack with the specified refid.</span>

<span class="sd">        :returns: resource in this stack with the specified refid, or None if</span>
<span class="sd">                  not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">FnGetRefId</span><span class="p">()</span> <span class="o">==</span> <span class="n">refid</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">refid</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Stack.register_access_allowed_handler"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.register_access_allowed_handler">[docs]</a>    <span class="k">def</span> <span class="nf">register_access_allowed_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credential_id</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an authorization handler function.</span>

<span class="sd">        Register a function which determines whether the credentials with a</span>
<span class="sd">        given ID can have access to a named resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span> <span class="s1">&#39;Handler is not callable&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span><span class="p">[</span><span class="n">credential_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span></div>

<div class="viewcode-block" id="Stack.access_allowed"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.access_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">access_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credential_id</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is credential_id authorised to access resource by resource_name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
            <span class="c1"># this also triggers lazy-loading of resources</span>
            <span class="c1"># so is required for register_access_allowed_handler</span>
            <span class="c1"># to be called</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">credential_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handler</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.validate&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.validate"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignorable_errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validate_by_deps</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">validate_resources</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validates the stack.&quot;&quot;&quot;</span>
        <span class="c1"># TODO(sdake) Should return line number of invalid reference</span>

        <span class="c1"># validate overall template (top-level structure)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Validate parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                 <span class="n">validate_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span><span class="p">)</span>

        <span class="c1"># Validate Parameter Groups</span>
        <span class="n">parameter_groups</span> <span class="o">=</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">ParameterGroups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">parameter_groups</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Continue to call this function, since old third-party Template</span>
        <span class="c1"># plugins may depend on it being called to validate the resource</span>
        <span class="c1"># definitions before actually generating them.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">validate_resource_definitions</span> <span class="o">!=</span>
                <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">validate_resource_definitions</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The Template.validate_resource_definitions() &quot;</span>
                          <span class="s2">&quot;method is deprecated and will no longer be called &quot;</span>
                          <span class="s2">&quot;in future versions of Heat. Template subclasses &quot;</span>
                          <span class="s2">&quot;should validate resource definitions in the &quot;</span>
                          <span class="s2">&quot;resource_definitions() method.&quot;</span><span class="p">,</span>
                          <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">validate_resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c1"># Load the resources definitions (success of which implies the</span>
        <span class="c1"># definitions are valid)</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>

        <span class="c1"># Check duplicate names between parameters and resources</span>
        <span class="n">dup_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dup_names</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Duplicate names </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dup_names</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Duplicate names </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">dup_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">validate_by_deps</span><span class="p">:</span>
            <span class="n">iter_rsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iter_rsc</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>

        <span class="c1"># Validate resources only for top-level stacks. Nested stacks have</span>
        <span class="c1"># already had their resources validated by their parent.</span>
        <span class="k">if</span> <span class="n">validate_resources</span><span class="p">:</span>
            <span class="n">unique_defns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">t</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">resources</span><span class="p">))</span>
            <span class="n">unique_defn_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">defn</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">unique_defns</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">iter_rsc</span><span class="p">:</span>
                <span class="c1"># Don&#39;t validate identical definitions multiple times</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_defn_names</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_validate</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">external_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">validate_external</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">external_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">validate_template</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">HeatException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ignorable_errors</span> <span class="ow">and</span> <span class="n">ex</span><span class="o">.</span><span class="n">error_code</span> <span class="ow">in</span> <span class="n">ignorable_errors</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Exception in stack validation&quot;</span><span class="p">),</span>
                             <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">,</span> <span class="n">op_name</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">OUTPUT_VALUE</span><span class="p">])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="Stack.requires_deferred_auth"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.requires_deferred_auth">[docs]</a>    <span class="k">def</span> <span class="nf">requires_deferred_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether to perform API requests with deferred auth.</span>

<span class="sd">        Returns whether this stack may need to perform API requests</span>
<span class="sd">        during its lifecycle using the configured deferred authentication</span>
<span class="sd">        method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">requires_deferred_auth</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a state change event to the database.&quot;&quot;&quot;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;OS::Heat::Stack&#39;</span><span class="p">)</span>

        <span class="n">ev</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_event</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.dispatch_event"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.dispatch_event">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_dispatch</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">sinks</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sink</span> <span class="ow">in</span> <span class="n">sinks</span><span class="p">:</span>
                    <span class="n">sink</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got error sending events </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_dispatch</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_event_sinks</span><span class="p">(),</span>
                                        <span class="n">ev</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.state_set&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.state_set"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.state_set">[docs]</a>    <span class="k">def</span> <span class="nf">state_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the stack state.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid action </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUSES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid status </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_status</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">):</span>
            <span class="c1"># if convergence and stack operation is create/update/rollback/</span>
            <span class="c1"># delete, stack lock is not used, hence persist state</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_persist_state</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
                <span class="c1"># Possibly failed concurrent update</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Failed to set state of stack </span><span class="si">%(name)s</span><span class="s2"> with&quot;</span>
                                <span class="s2">&quot; traversal ID </span><span class="si">%(trvsl_id)s</span><span class="s2">, to&quot;</span>
                                <span class="s2">&quot; </span><span class="si">%(action)s</span><span class="s2">_</span><span class="si">%(status)s</span><span class="s2">&quot;</span><span class="p">),</span>
                            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;trvsl_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
                             <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">updated</span>

        <span class="c1"># Persist state to db only if status == IN_PROGRESS</span>
        <span class="c1"># or action == UPDATE/DELETE/ROLLBACK. Else, it would</span>
        <span class="c1"># be done before releasing the stack lock.</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span> <span class="ow">or</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_persist_state</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_log_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Stack </span><span class="si">%(action)s</span><span class="s1"> </span><span class="si">%(status)s</span><span class="s1"> (</span><span class="si">%(name)s</span><span class="s1">): &#39;</span>
                     <span class="s1">&#39;</span><span class="si">%(reason)s</span><span class="s1">&#39;</span><span class="p">),</span>
                 <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                  <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_persist_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Persist stack state to database&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                             <span class="n">eager_load</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                      <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                      <span class="s1">&#39;status_reason&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_notification_and_add_event</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
                <span class="c1"># do things differently for convergence</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">select_and_update</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                    <span class="n">exp_trvsl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">updated</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_send_notification_and_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Persisting stack </span><span class="si">%(name)s</span><span class="s1"> status </span><span class="si">%(action)s</span><span class="s1"> </span><span class="si">%(status)s</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                   <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                   <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
        <span class="n">notification</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.persist_state_and_release_lock"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.persist_state_and_release_lock">[docs]</a>    <span class="k">def</span> <span class="nf">persist_state_and_release_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Persist stack state to database and release stack lock&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                             <span class="n">eager_load</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                      <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                      <span class="s1">&#39;status_reason&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_notification_and_add_event</span><span class="p">()</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">persist_state_and_release_lock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                 <span class="n">engine_id</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns state, tuple of action, status.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.timeout_secs"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.timeout_secs">[docs]</a>    <span class="k">def</span> <span class="nf">timeout_secs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the stack action timeout in seconds.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">stack_action_timeout</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">*</span> <span class="mi">60</span></div>

<div class="viewcode-block" id="Stack.preview_resources"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.preview_resources">[docs]</a>    <span class="k">def</span> <span class="nf">preview_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preview the stack with all of the resources.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">preview</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_store_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.create&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.create"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg_queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the stack and all of the resources.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store_resources</span><span class="p">()</span>

        <span class="n">check_message</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_for_message</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">)</span>

        <span class="n">creator</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">post_func</span><span class="o">=</span><span class="n">rollback</span><span class="p">)</span>
        <span class="n">creator</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">(),</span> <span class="n">progress_callback</span><span class="o">=</span><span class="n">check_message</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_adopt_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adopt_stack_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;resource_data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;resource_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)}</span>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Stack.stack_task"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.stack_task">[docs]</a>    <span class="k">def</span> <span class="nf">stack_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">post_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pre_completion_func</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A task to perform an action on the stack.</span>

<span class="sd">        All of the resources are traversed in forward or reverse dependency</span>
<span class="sd">        order.</span>

<span class="sd">        :param action: action that should be executed with stack resources</span>
<span class="sd">        :param reverse: define if action on the resources need to be executed</span>
<span class="sd">         in reverse order (resources - first and then res dependencies )</span>
<span class="sd">        :param post_func: function that need to be executed after</span>
<span class="sd">        action complete on the stack</span>
<span class="sd">        :param aggregate_exceptions: define if exceptions should be aggregated</span>
<span class="sd">        :param pre_completion_func: function that need to be executed right</span>
<span class="sd">        before action completion. Uses stack ,action, status and reason as</span>
<span class="sd">        input parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                              <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                           <span class="s1">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post_func</span><span class="p">):</span>
                <span class="n">post_func</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
                       <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> started&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> completed successfully&#39;</span> <span class="o">%</span> <span class="n">action</span>

        <span class="n">action_method</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># If a local _$action_kwargs function exists, call it to get the</span>
        <span class="c1"># action specific argument list, otherwise an empty arg list</span>
        <span class="n">handle_kwargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_kwargs&#39;</span> <span class="o">%</span> <span class="n">action_method</span><span class="p">,</span>
                                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{})</span>

        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">,</span> <span class="n">action_method</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">resource_action</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="c1"># Find e.g resource.create and call it</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">action_method</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">handle</span><span class="p">(</span><span class="o">**</span><span class="n">handle_kwargs</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">get_error_wait_time</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">cancel_grace_period</span><span class="p">()</span>

        <span class="n">action_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">DependencyTaskGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
            <span class="n">resource_action</span><span class="p">,</span>
            <span class="n">reverse</span><span class="p">,</span>
            <span class="n">error_wait_time</span><span class="o">=</span><span class="n">get_error_wait_time</span><span class="p">,</span>
            <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="n">aggregate_exceptions</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">action_task</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> timed out&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c1"># We use a catch-all here to ensure any raised exceptions</span>
            <span class="c1"># make the stack fail. This is necessary for when</span>
            <span class="c1"># aggregate_exceptions is false, as in that case we don&#39;t get</span>
            <span class="c1"># ExceptionGroup, but the raw exception.</span>
            <span class="c1"># see scheduler.py line 395-399</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Resource </span><span class="si">%s</span><span class="s1"> failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pre_completion_func</span><span class="p">:</span>
            <span class="n">pre_completion_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post_func</span><span class="p">):</span>
            <span class="n">post_func</span><span class="p">()</span>
        <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.check&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.check"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">checker</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span>
            <span class="n">post_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supports_check_action</span><span class="p">,</span>
            <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">checker</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.supports_check_action"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.supports_check_action">[docs]</a>    <span class="k">def</span> <span class="nf">supports_check_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_supported</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">has_nested</span><span class="p">()</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">nested</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span><span class="o">.</span><span class="n">supports_check_action</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">supported</span> <span class="o">=</span> <span class="p">[</span><span class="n">is_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">supported</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;. &#39;</span><span class="si">%s</span><span class="s2">&#39; not fully supported (see resources)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">+</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">supported</span><span class="p">)</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack._backup_stack&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_backup_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_if_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Backup the stack.</span>

<span class="sd">        Get a Stack containing any in-progress resources from the previous</span>
<span class="sd">        stack state prior to an update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name_and_owner_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backup_name</span><span class="p">(),</span>
            <span class="n">owner_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loaded existing backup stack&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">create_if_missing</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;owner_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="k">del</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;prev_raw_template_id&#39;</span><span class="p">])</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_name</span><span class="p">(),</span>
                              <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">prev</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Created new backup stack&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.adopt&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.adopt"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.adopt">[docs]</a>    <span class="k">def</span> <span class="nf">adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adopt existing resources into a new stack.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
                <span class="c1"># enter the same flow as abandon and just delete the stack</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">creator</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">post_func</span><span class="o">=</span><span class="n">rollback</span><span class="p">)</span>
        <span class="n">creator</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.update&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.update"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">msg_queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the stack.</span>

<span class="sd">        Compare the current stack with newstack,</span>
<span class="sd">        and where necessary create/update/delete the resources until</span>
<span class="sd">        this stack aligns with newstack.</span>

<span class="sd">        Note update of existing stack resources depends on update</span>
<span class="sd">        being implemented in the underlying resource types</span>

<span class="sd">        Update will fail if it exceeds the specified timeout. The default is</span>
<span class="sd">        60 minutes, set in the constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span>
                                       <span class="n">msg_queue</span><span class="o">=</span><span class="n">msg_queue</span><span class="p">)</span>
        <span class="n">updater</span><span class="p">()</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.converge_stack&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.converge_stack"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.converge_stack">[docs]</a>    <span class="k">def</span> <span class="nf">converge_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">new_stack</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the stack template and trigger convergence for resources.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">]:</span>
            <span class="c1"># no back-up template for create action</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># switch template and reset dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_dependencies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">new_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">disable_rollback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">timeout_mins</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">tags</span>
            <span class="k">if</span> <span class="n">new_stack</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="n">new_stack</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> started&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span>

        <span class="c1"># generate new traversal and store</span>
        <span class="n">previous_traversal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="c1"># we expect to update the stack having previous traversal ID</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">exp_trvsl</span><span class="o">=</span><span class="n">previous_traversal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Failed to store stack </span><span class="si">%(name)s</span><span class="s2"> with traversal &quot;</span>
                            <span class="s2">&quot;ID </span><span class="si">%(trvsl_id)s</span><span class="s2">, aborting stack </span><span class="si">%(action)s</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;trvsl_id&#39;</span><span class="p">:</span> <span class="n">previous_traversal</span><span class="p">,</span>
                         <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">})</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_notification_and_add_event</span><span class="p">()</span>

        <span class="c1"># delete the prev traversal sync_points</span>
        <span class="k">if</span> <span class="n">previous_traversal</span><span class="p">:</span>
            <span class="n">sync_point</span><span class="o">.</span><span class="n">delete_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">previous_traversal</span><span class="p">)</span>

        <span class="c1"># TODO(later): lifecycle_plugin_utils.do_pre_ops</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_converge_create_or_update</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_converge_create_or_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_store_resources</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_convg_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_rsrcs_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                         <span class="n">current_resources</span><span class="p">)</span>
        <span class="c1"># Store list of edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_deps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;edges&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">rqr</span><span class="p">,</span> <span class="n">rqd</span><span class="p">]</span> <span class="k">for</span> <span class="n">rqr</span><span class="p">,</span> <span class="n">rqd</span> <span class="ow">in</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">convergence_dependencies</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span><span class="o">.</span><span class="n">edges</span><span class="p">()]}</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Failed concurrent update</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Failed to store stack </span><span class="si">%(name)s</span><span class="s2"> with traversal &quot;</span>
                            <span class="s2">&quot;ID </span><span class="si">%(trvsl_id)s</span><span class="s2">, aborting stack </span><span class="si">%(action)s</span><span class="s2">&quot;</span><span class="p">),</span>
                        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;trvsl_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
                         <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">})</span>
            <span class="k">return</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;convergence_dependencies: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">),</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">convergence_dependencies</span><span class="p">)</span>

        <span class="c1"># Delete all the snapshots before starting delete operation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
                <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># create sync_points for resources in DB</span>
        <span class="k">for</span> <span class="n">rsrc_id</span><span class="p">,</span> <span class="n">is_update</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence_dependencies</span><span class="p">:</span>
            <span class="n">sync_point</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rsrc_id</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span> <span class="n">is_update</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># create sync_point entry for stack</span>
        <span class="n">sync_point</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">leaves</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convergence_dependencies</span><span class="o">.</span><span class="n">leaves</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">leaves</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mark_complete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rsrc_id</span><span class="p">,</span> <span class="n">is_update</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence_dependencies</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Triggering resource </span><span class="si">%s</span><span class="s2"> for update&quot;</span><span class="p">),</span> <span class="n">rsrc_id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Triggering resource </span><span class="si">%s</span><span class="s2"> for cleanup&quot;</span><span class="p">),</span>
                             <span class="n">rsrc_id</span><span class="p">)</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="n">sync_point</span><span class="o">.</span><span class="n">serialize_input_data</span><span class="p">({})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_client</span><span class="o">.</span><span class="n">check_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rsrc_id</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
                                                  <span class="n">input_data</span><span class="p">,</span> <span class="n">is_update</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">adopt_stack_data</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.rollback"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_tmpl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span>
        <span class="k">if</span> <span class="n">old_tmpl_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rollback_tmpl</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">create_empty_template</span><span class="p">(</span>
                <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rollback_tmpl</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">old_tmpl_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># Failed concurrent update</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Failed to store stack </span><span class="si">%(name)s</span><span class="s2"> with traversal&quot;</span>
                                <span class="s2">&quot; ID </span><span class="si">%(trvsl_id)s</span><span class="s2">, not triggering rollback.&quot;</span><span class="p">),</span>
                            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;trvsl_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">})</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">rollback_tmpl</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_best_existing_rsrc_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rsrc_name</span><span class="p">):</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_rsrcs_db</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">ext_rsrc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_rsrcs_db</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">ext_rsrc</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">rsrc_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ext_rsrc</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="c1"># Rollback where the previous resource still exists</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">ext_rsrc</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">ext_rsrc</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">==</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span><span class="p">):</span>
                    <span class="c1"># Current resource is otherwise a good candidate</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">ext_rsrc</span>
                <span class="k">elif</span> <span class="n">candidate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># In multiple concurrent updates, if candidate is not</span>
                    <span class="c1"># found in current/previous template, it could be found</span>
                    <span class="c1"># in old tmpl.</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">ext_rsrc</span>

        <span class="k">return</span> <span class="n">candidate</span>

    <span class="k">def</span> <span class="nf">_update_or_store_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext_rsrcs_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_active_resources_get</span><span class="p">()</span>

        <span class="n">curr_name_translated_dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span>
                                                               <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">rsrcs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">update_needed_by</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">new_requirers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">rsrcs</span><span class="p">[</span><span class="n">rsrc_name</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">rsrc_name</span> <span class="ow">in</span>
                <span class="n">curr_name_translated_dep</span><span class="o">.</span><span class="n">required_by</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">old_requirers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">needed_by</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">needed_by</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">needed_by</span> <span class="o">=</span> <span class="n">old_requirers</span> <span class="o">|</span> <span class="n">new_requirers</span>
            <span class="n">res</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">needed_by</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="n">existing_rsrc_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_best_existing_rsrc_db</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_rsrc_db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">update_needed_by</span><span class="p">(</span><span class="n">rsrc</span><span class="p">)</span>
                <span class="n">rsrc</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span>
                <span class="n">rsrc</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
                <span class="n">rsrcs</span><span class="p">[</span><span class="n">rsrc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsrc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">update_needed_by</span><span class="p">(</span><span class="n">existing_rsrc_db</span><span class="p">)</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">set_needed_by</span><span class="p">(</span>
                    <span class="n">existing_rsrc_db</span><span class="p">,</span> <span class="n">existing_rsrc_db</span><span class="o">.</span><span class="n">needed_by</span>
                <span class="p">)</span>
                <span class="n">rsrcs</span><span class="p">[</span><span class="n">existing_rsrc_db</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_rsrc_db</span>
        <span class="k">return</span> <span class="n">rsrcs</span>

<div class="viewcode-block" id="Stack.set_resource_deps"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.set_resource_deps">[docs]</a>    <span class="k">def</span> <span class="nf">set_resource_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">curr_name_translated_dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">res</span><span class="p">:</span>
                                                               <span class="n">res</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">ext_rsrcs_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_active_resources_get</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr_name_translated_dep</span><span class="o">.</span><span class="n">required_by</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">r</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr_name_translated_dep</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">set_needed_by</span><span class="p">(</span><span class="n">ext_rsrcs_db</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">needed_by</span><span class="p">)</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">set_requires</span><span class="p">(</span><span class="n">ext_rsrcs_db</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compute_convg_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">existing_resources</span><span class="p">,</span>
                                    <span class="n">current_template_deps</span><span class="p">,</span> <span class="n">current_resources</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">make_graph_key</span><span class="p">(</span><span class="n">rsrc</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">current_resources</span><span class="p">[</span><span class="n">rsrc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">True</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="n">current_template_deps</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">make_graph_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_resources</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rsrc_id</span><span class="p">,</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">existing_resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rsrc_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="bp">None</span>

                <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">requires</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">existing_resources</span><span class="p">:</span>
                        <span class="n">dep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">requirement</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="p">(</span><span class="n">rsrc_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">replaces</span> <span class="ow">in</span> <span class="n">existing_resources</span><span class="p">:</span>
                    <span class="n">dep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">replaces</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="p">(</span><span class="n">rsrc_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dep</span><span class="p">:</span>
                    <span class="n">dep</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rsrc_id</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span> <span class="p">(</span><span class="n">rsrc_id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_convg_deps</span> <span class="o">=</span> <span class="n">dep</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">convergence_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convg_deps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">current_deps</span> <span class="o">=</span> <span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)]</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_deps</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convg_deps</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">Dependencies</span><span class="p">(</span><span class="n">edges</span><span class="o">=</span><span class="n">current_deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convg_deps</span>

<div class="viewcode-block" id="Stack.reset_stack_and_resources_in_progress"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.reset_stack_and_resources_in_progress">[docs]</a>    <span class="k">def</span> <span class="nf">reset_stack_and_resources_in_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
                <span class="n">rsrc</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                               <span class="n">rsrc</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span></div>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Stack.update_task"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.update_task">[docs]</a>    <span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">msg_queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Unexpected action </span><span class="si">%s</span><span class="s2"> passed to update!&quot;</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                           <span class="s2">&quot;Invalid action </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                              <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                           <span class="s1">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting update rollback for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Attempted to </span><span class="si">%s</span><span class="s1"> an IN_PROGRESS &#39;</span>
                           <span class="s1">&#39;stack&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">action</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_stack_and_resources_in_progress</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Save a copy of the new template.  To avoid two DB writes</span>
        <span class="c1"># we store the ID at the same time as the action/status</span>
        <span class="n">prev_tmpl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span>
        <span class="c1"># newstack.t may have been pre-stored, so save with that one</span>
        <span class="n">bu_tmpl</span><span class="p">,</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="n">bu_tmpl</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> started&#39;</span> <span class="o">%</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_notification_and_add_event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">prev_tmpl_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">raw_template_object</span><span class="o">.</span><span class="n">RawTemplate</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">prev_tmpl_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
            <span class="c1"># Oldstack is useless when the action is not UPDATE , so we don&#39;t</span>
            <span class="c1"># need to build it, this can avoid some unexpected errors.</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_encrypted_param_names_valid</span><span class="p">()</span>
            <span class="n">oldstack</span> <span class="o">=</span> <span class="n">Stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">backup_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_stack</span><span class="p">()</span>
        <span class="n">existing_params</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">({</span><span class="n">env_fmt</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">params</span><span class="p">})</span>
        <span class="n">previous_template_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">should_rollback</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">update_task</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">StackUpdate</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">backup_stack</span><span class="p">,</span>
            <span class="n">rollback</span><span class="o">=</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">update_task</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">disable_rollback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">timeout_mins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span>
            <span class="k">if</span> <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="n">check_message</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_for_message</span><span class="p">,</span>
                                              <span class="n">msg_queue</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">updater</span><span class="o">.</span><span class="n">as_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">(),</span>
                                      <span class="n">progress_callback</span><span class="o">=</span><span class="n">check_message</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_dependencies</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> completed successfully&#39;</span> <span class="o">%</span> <span class="n">action</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>

        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s1">&#39;Timed out&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If rollback is enabled when resource failure occurred,</span>
            <span class="c1"># we do another update, with the existing template,</span>
            <span class="c1"># so we roll back to the original state</span>
            <span class="n">should_rollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_exception_handler</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">should_rollback</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">(</span><span class="n">oldstack</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_exception_handler</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting backup stack&#39;</span><span class="p">)</span>
            <span class="n">backup_stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c1"># flip the template to the newstack values</span>
            <span class="n">previous_template_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">should_rollback</span><span class="p">:</span>
                <span class="c1"># Already handled in rollback task</span>
                <span class="k">return</span>

            <span class="c1"># Don&#39;t use state_set to do only one update query and avoid race</span>
            <span class="c1"># condition with the COMPLETE status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_status</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_notification_and_add_event</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="c1"># Since template was incrementally updated based on existing</span>
                <span class="c1"># and new stack resources, we should have user params of both.</span>
                <span class="n">existing_params</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user_env_as_dict</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">existing_params</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">merge_snippets</span><span class="p">(</span><span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="n">backup_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">existing_params</span>
                <span class="n">backup_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">merge_snippets</span><span class="p">(</span><span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                <span class="n">backup_stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">previous_template_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">raw_template_object</span><span class="o">.</span><span class="n">RawTemplate</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                       <span class="n">previous_template_id</span><span class="p">)</span>

            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                               <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_update_exception_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle exceptions in update_task.</span>

<span class="sd">        Decide if we should cancel tasks or not. Also decide if we should</span>
<span class="sd">        rollback or not, depend on disable rollback flag if force rollback flag</span>
<span class="sd">        not triggered.</span>

<span class="sd">        :returns: a boolean for require rollback flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">ForcedCancel</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_rollback</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">):</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_ensure_encrypted_param_names_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If encryption was enabled when the stack was created but</span>
        <span class="c1"># then disabled when the stack was updated, env.params and</span>
        <span class="c1"># env.encrypted_param_names will be in an inconsistent</span>
        <span class="c1"># state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">encrypt_parameters_and_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">encrypted_param_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_for_message</span><span class="p">(</span><span class="n">msg_queue</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">msg_queue</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">msg_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ForcedCancel</span><span class="p">(</span><span class="n">with_rollback</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL_WITH_ROLLBACK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ForcedCancel</span><span class="p">(</span><span class="n">with_rollback</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s1">&#39;Unknown message &quot;</span><span class="si">%s</span><span class="s1">&quot; received&#39;</span><span class="p">),</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_backup_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="c1"># Delete resources in the backup stack referred to by &#39;stack&#39;</span>

        <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">child</span><span class="o">.</span><span class="n">CREATE</span> <span class="ow">and</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">copy_data</span><span class="p">(</span><span class="n">source_res</span><span class="p">,</span> <span class="n">destination_res</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">source_res</span><span class="o">.</span><span class="n">data</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">source_res</span><span class="o">.</span><span class="n">data</span><span class="p">()):</span>
                    <span class="n">destination_res</span><span class="o">.</span><span class="n">data_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">backup_res</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># If UpdateReplace is failed, we must restore backup_res</span>
            <span class="c1"># to existing_stack in case of it may have dependencies in</span>
            <span class="c1"># these stacks. curr_res is the resource that just</span>
            <span class="c1"># created and failed, so put into the stack to delete anyway.</span>
            <span class="n">backup_res_id</span> <span class="o">=</span> <span class="n">backup_res</span><span class="o">.</span><span class="n">resource_id</span>
            <span class="n">curr_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_res_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">curr_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">curr_res_id</span> <span class="o">=</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">failed</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">curr_res</span><span class="p">])</span> <span class="ow">or</span>
                        <span class="n">curr_res</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span>
                        <span class="p">(</span><span class="n">curr_res</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)):</span>
                    <span class="c1"># If child resource failed to update, curr_res</span>
                    <span class="c1"># should be replaced to resolve dependencies. But this</span>
                    <span class="c1"># is not fundamental solution. If there are update</span>
                    <span class="c1"># failer and success resources in the children, cannot</span>
                    <span class="c1"># delete the stack.</span>
                    <span class="c1"># Stack class owns dependencies as set of resource&#39;s</span>
                    <span class="c1"># objects, so we switch members of the resource that is</span>
                    <span class="c1"># needed to delete it.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">backup_res_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">backup_res</span><span class="o">.</span><span class="n">properties</span>
                    <span class="n">copy_data</span><span class="p">(</span><span class="n">backup_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                    <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">curr_res_id</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">properties</span>
                    <span class="n">copy_data</span><span class="p">(</span><span class="n">curr_res</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_get_user_creds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># There are cases where the user_creds cannot be returned</span>
        <span class="c1"># due to credentials truncated when being saved to DB.</span>
        <span class="c1"># Ignore this error instead of blocking stack deletion.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Failed to retrieve user_creds&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_delete_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">abandon</span><span class="p">):</span>
        <span class="c1"># Cleanup stored user_creds so they aren&#39;t accessible via</span>
        <span class="c1"># the soft-deleted stack which remains in the DB</span>
        <span class="c1"># The stack_status and reason passed in are current values, which</span>
        <span class="c1"># may get rewritten and returned from this method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
            <span class="n">user_creds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_get_user_creds</span><span class="p">()</span>
            <span class="c1"># If we created a trust, delete it</span>
            <span class="k">if</span> <span class="n">user_creds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">trust_id</span> <span class="o">=</span> <span class="n">user_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trust_id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trust_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># If the trustor doesn&#39;t match the context user the</span>
                        <span class="c1"># we have to use the stored context to cleanup the</span>
                        <span class="c1"># trust, as although the user evidently has</span>
                        <span class="c1"># permission to delete the stack, they don&#39;t have</span>
                        <span class="c1"># rights to delete the trust unless an admin</span>
                        <span class="n">trustor_id</span> <span class="o">=</span> <span class="n">user_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trustor_user_id&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">trustor_id</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Context user_id doesn&#39;t match &quot;</span>
                                      <span class="s2">&quot;trustor, using stored context&quot;</span><span class="p">)</span>
                            <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_context</span><span class="p">()</span>
                            <span class="n">sc</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_trust</span><span class="p">(</span>
                                <span class="n">trust_id</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_trust</span><span class="p">(</span>
                                <span class="n">trust_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">ks_exceptions</span><span class="o">.</span><span class="n">Unauthorized</span><span class="p">:</span>
                        <span class="c1"># ignore if unauthorized, don&#39;t to set FAILED</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Unauthorized, including the cases: &quot;</span>
                                        <span class="s2">&quot;the trustor is deleted or the trust &quot;</span>
                                        <span class="s2">&quot;is expired.&quot;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Error deleting trust&quot;</span><span class="p">))</span>
                        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
                        <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Error deleting trust: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                  <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

            <span class="c1"># Delete the stored credentials</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Tried to delete user_creds that do not exist &quot;</span>
                             <span class="s2">&quot;(stack=</span><span class="si">%(stack)s</span><span class="s2"> user_creds_id=</span><span class="si">%(uc)s</span><span class="s2">)&quot;</span><span class="p">),</span>
                         <span class="p">{</span><span class="s1">&#39;stack&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;uc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">})</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Tried to store a stack that does not exist </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># If the stack has a domain project, delete it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abandon</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keystone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;keystone&#39;</span><span class="p">)</span>
                <span class="n">keystone</span><span class="o">.</span><span class="n">delete_stack_domain_project</span><span class="p">(</span>
                    <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Error deleting project&quot;</span><span class="p">))</span>
                <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;Error deleting project: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.delete&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.delete"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete all of the resources, and then the stack itself.</span>

<span class="sd">        The action parameter is used to differentiate between a user</span>
<span class="sd">        initiated delete and an automatic stack rollback after a failed</span>
<span class="sd">        create, which amount to the same thing, but the states are recorded</span>
<span class="sd">        differently.</span>

<span class="sd">        Note abandon is a delete where all resources have been set to a</span>
<span class="sd">        RETAIN deletion policy, but we also don&#39;t want to delete anything</span>
<span class="sd">        required for those resources, e.g the stack_user_project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s2">&quot;Unexpected action </span><span class="si">%s</span><span class="s2"> passed to delete!&quot;</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                           <span class="s2">&quot;Invalid action </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> completed successfully&#39;</span> <span class="o">%</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> started&#39;</span> <span class="o">%</span>
                       <span class="n">action</span><span class="p">)</span>

        <span class="n">backup_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_stack</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backup_stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_backup_stack</span><span class="p">(</span><span class="n">backup_stack</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">:</span>
                <span class="n">errs</span> <span class="o">=</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">status_reason</span>
                <span class="n">failure</span> <span class="o">=</span> <span class="s1">&#39;Error deleting backup resources: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">errs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="s1">&#39;Failed to </span><span class="si">%s</span><span class="s1"> : </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">failure</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                                  <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                               <span class="s1">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="n">action_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">DependencyTaskGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                                    <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">destroy</span><span class="p">,</span>
                                                    <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">action_task</span><span class="p">)(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Resource </span><span class="si">%s</span><span class="s1"> failed: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> timed out&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="c1"># If the stack delete succeeded, this is not a backup stack and it&#39;s</span>
        <span class="c1"># not a nested stack, we should delete the credentials</span>
        <span class="k">if</span> <span class="n">stack_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">backup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_credentials</span><span class="p">(</span><span class="n">stack_status</span><span class="p">,</span>
                                                            <span class="n">reason</span><span class="p">,</span>
                                                            <span class="n">abandon</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Tried to delete stack that does not exist &quot;</span>
                         <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                               <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stack_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="c1"># delete the stack</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s2">&quot;Tried to delete stack that does not exist &quot;</span>
                             <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.suspend&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.suspend"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.suspend">[docs]</a>    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Suspend the stack.</span>

<span class="sd">        Invokes handle_suspend for all stack resources.</span>

<span class="sd">        Waits for all resources to become SUSPEND_COMPLETE then declares the</span>
<span class="sd">        stack SUSPEND_COMPLETE.</span>
<span class="sd">        Note the default implementation for all resources is to do nothing</span>
<span class="sd">        other than move to SUSPEND_COMPLETE, so the resources must implement</span>
<span class="sd">        handle_suspend for this to have any effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No need to suspend if the stack has been suspended</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is already suspended&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.resume&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.resume"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resume the stack.</span>

<span class="sd">        Invokes handle_resume for all stack resources.</span>

<span class="sd">        Waits for all resources to become RESUME_COMPLETE then declares the</span>
<span class="sd">        stack RESUME_COMPLETE.</span>
<span class="sd">        Note the default implementation for all resources is to do nothing</span>
<span class="sd">        other than move to RESUME_COMPLETE, so the resources must implement</span>
<span class="sd">        handle_resume for this to have any effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No need to resume if the stack has been resumed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is already resumed&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.snapshot&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.snapshot"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_snapshot_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Snapshot the stack, invoking handle_snapshot on all resources.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">pre_completion_func</span><span class="o">=</span><span class="n">save_snapshot_func</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.delete_snapshot&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.delete_snapshot"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a snapshot from the backends.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">snapshot_data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">snapshot_data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">,</span> <span class="n">data</span><span class="p">)()</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.restore&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@reset_state_on_error</span>
<div class="viewcode-block" id="Stack.restore"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore the given snapshot.</span>

<span class="sd">        Invokes handle_restore on all resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">oslo_timeutils</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">])</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">],</span>
                                 <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">newstack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                                  <span class="n">timeout_mins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span><span class="p">,</span>
                                  <span class="n">disable_rollback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span>
                <span class="n">template</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="n">newstack</span><span class="p">)):</span>
            <span class="n">rsrc</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">defn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">handle_restore</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsrc</span><span class="p">,</span> <span class="s1">&#39;handle_restore&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handle_restore</span><span class="p">):</span>
                <span class="n">defn</span> <span class="o">=</span> <span class="n">handle_restore</span><span class="p">(</span><span class="n">defn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">template</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">defn</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">newstack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>

        <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span>
                                       <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">)</span>
        <span class="n">updater</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.restart_resource"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.restart_resource">[docs]</a>    <span class="k">def</span> <span class="nf">restart_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the resource specified by resource_name.</span>

<span class="sd">        stop resource_name and all that depend on it</span>
<span class="sd">        start resource_name and all that depend on it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Stack.restart_resource() is horribly broken and will &quot;</span>
                      <span class="s2">&quot;never be fixed. If you&#39;re using it in a resource type &quot;</span>
                      <span class="s2">&quot;other than HARestarter, don&#39;t. And don&#39;t use &quot;</span>
                      <span class="s2">&quot;HARestarter either.&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">deps</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">destroy</span><span class="p">)()</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Resource </span><span class="si">%(name)s</span><span class="s1"> delete failed: </span><span class="si">%(ex)s</span><span class="s1">&#39;</span><span class="p">),</span>
                         <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">state_reset</span><span class="p">()</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">create</span><span class="p">)()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;Resource </span><span class="si">%(name)s</span><span class="s1"> create failed: &#39;</span>
                                 <span class="s1">&#39;</span><span class="si">%(ex)s</span><span class="s1">&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                              <span class="s1">&#39;Resource restart aborted&#39;</span><span class="p">)</span></div>
        <span class="c1"># TODO(asalkeld) if any of this fails we Should</span>
        <span class="c1"># restart the whole stack</span>

<div class="viewcode-block" id="Stack.get_availability_zones"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.get_availability_zones">[docs]</a>    <span class="k">def</span> <span class="nf">get_availability_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nova</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;nova&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">zone</span><span class="o">.</span><span class="n">zoneName</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span>
                <span class="n">nova</span><span class="o">.</span><span class="n">availability_zones</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">detailed</span><span class="o">=</span><span class="bp">False</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span></div>

<div class="viewcode-block" id="Stack.set_stack_user_project_id"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.set_stack_user_project_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_stack_user_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.create_stack_user_project_id&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.create_stack_user_project_id"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.create_stack_user_project_id">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_user_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s1">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_stack_domain_project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_user_project_id</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span></div>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s1">&#39;Stack.prepare_abandon&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.prepare_abandon"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.prepare_abandon">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_abandon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s1">&#39;environment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user_env_as_dict</span><span class="p">(),</span>
            <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="s1">&#39;resources&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">())</span>
                              <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)),</span>
            <span class="s1">&#39;project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
            <span class="s1">&#39;stack_user_project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Stack.reset_resource_attributes"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.reset_resource_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">reset_resource_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># nothing is cached if no resources exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># a change in some resource may have side-effects in the attributes</span>
        <span class="c1"># of other resources, so ensure that attributes are re-calculated</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">reset_resolved_values</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.has_cache_data"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.has_cache_data">[docs]</a>    <span class="k">def</span> <span class="nf">has_cache_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stack.cache_data_reference_id"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.cache_data_reference_id">[docs]</a>    <span class="k">def</span> <span class="nf">cache_data_reference_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">resource_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_id&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stack.cache_data_resource_attribute"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.cache_data_resource_attribute">[docs]</a>    <span class="k">def</span> <span class="nf">cache_data_resource_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">attribute_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">resource_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="Stack.cache_data_resource_all_attributes"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.cache_data_resource_all_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">cache_data_resource_all_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attrs&#39;</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="Stack.mark_complete"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.mark_complete">[docs]</a>    <span class="k">def</span> <span class="nf">mark_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the update as complete.</span>

<span class="sd">        This currently occurs when all resources have been updated; there may</span>
<span class="sd">        still be resources being cleaned up, but the Stack should now be in</span>
<span class="sd">        service.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%(name)s</span><span class="s1">(</span><span class="si">%(id)s</span><span class="s1">)] update traversal </span><span class="si">%(tid)s</span><span class="s1"> complete&#39;</span><span class="p">),</span>
                 <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                  <span class="s1">&#39;tid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">})</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Stack </span><span class="si">%s</span><span class="s1"> completed successfully&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">purge_db</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.purge_db"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.purge_db">[docs]</a>    <span class="k">def</span> <span class="nf">purge_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleanup database after stack has completed/failed.</span>

<span class="sd">        1. Delete the resources from DB.</span>
<span class="sd">        2. If the stack failed, update the current_traversal to empty string</span>
<span class="sd">        so that the resource workers bail out.</span>
<span class="sd">        3. Delete previous raw template if stack completes successfully.</span>
<span class="sd">        4. Deletes all sync points. They are no longer needed after stack</span>
<span class="sd">           has completed/failed.</span>
<span class="sd">        5. Delete the stack if the action is DELETE.</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">purge_deleted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">exp_trvsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">prev_tmpl_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
            <span class="n">prev_tmpl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">stack_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">exp_trvsl</span><span class="o">=</span><span class="n">exp_trvsl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Failed concurrent update</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s2">&quot;Failed to store stack </span><span class="si">%(name)s</span><span class="s2"> with traversal ID &quot;</span>
                            <span class="s2">&quot;</span><span class="si">%(trvsl_id)s</span><span class="s2">, aborting stack purge&quot;</span><span class="p">),</span>
                        <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                         <span class="s1">&#39;trvsl_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">})</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">prev_tmpl_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">raw_template_object</span><span class="o">.</span><span class="n">RawTemplate</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">prev_tmpl_id</span><span class="p">)</span>

        <span class="n">sync_point</span><span class="o">.</span><span class="n">delete_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exp_trvsl</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
                <span class="n">status</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_credentials</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">,</span>
                    <span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                    <span class="c1"># something wrong when delete credentials, set FAILED</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="Stack.time_elapsed"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.time_elapsed">[docs]</a>    <span class="k">def</span> <span class="nf">time_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time elapsed in seconds since the stack operation started.&quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">round_to_seconds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="ow">or</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span><span class="p">)</span>
        <span class="n">nowish</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">round_to_seconds</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nowish</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span></div>

<div class="viewcode-block" id="Stack.time_remaining"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.time_remaining">[docs]</a>    <span class="k">def</span> <span class="nf">time_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Time left before stack times out.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="p">()</span></div>

<div class="viewcode-block" id="Stack.has_timed_out"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.has_timed_out">[docs]</a>    <span class="k">def</span> <span class="nf">has_timed_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns True if this stack has timed-out.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_elapsed</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="Stack.migrate_to_convergence"><a class="viewcode-back" href="../../../api/heat.engine.stack.html#heat.engine.stack.Stack.migrate_to_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">migrate_to_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="n">db_rsrcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_active_resources_get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">db_rsrcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">db_rsrcs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">res</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_resource_deps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_raw_template_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">ignore_traversal_check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev_raw_template_id</span><span class="p">:</span>
            <span class="n">raw_template_object</span><span class="o">.</span><span class="n">RawTemplate</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                   <span class="n">prev_raw_template_id</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/heat
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">heat 8.0.0.0rc2.dev38 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2012,2013 Heat Developers.
      Last updated on &#39;Tue Feb 14 11:42:51 2017, commit 3ffc97c&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/heat");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>