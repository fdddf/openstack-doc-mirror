<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Neutron Callback System &mdash; neutron-lib 1.1.1.dev70 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.1.dev70',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="neutron-lib 1.1.1.dev70 documentation" href="../index.html" />
    <link rel="up" title="Developer Guide" href="index.html" />
    <link rel="prev" title="API Validators" href="api_validators.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="neutron-callback-system">
<h1>Neutron Callback System<a class="headerlink" href="#neutron-callback-system" title="Permalink to this headline">¶</a></h1>
<p>In Neutron, core and service components may need to cooperate during the
execution of certain operations, or they may need to react upon the occurrence
of certain events. For instance, when a Neutron resource is associated to
multiple services, the components in charge of these services may need to play
an active role in determining what the right state of the resource needs to be.</p>
<p>The cooperation may be achieved by making each object aware of each other, but
this leads to tight coupling, or alternatively it can be achieved by using a
callback-based system, where the same objects are allowed to cooperate in a
loose manner.</p>
<p>This is particularly important since the spin off of the advanced services like
VPN, Firewall and Load Balancer, where each service&#8217;s codebase lives independently
from the core and from one another. This means that the tight coupling is no longer
a practical solution for object cooperation. In addition to this, if more services
are developed independently, there is no viable integration between them and the
Neutron core. A callback system, and its registry, tries to address these issues.</p>
<p>In object-oriented software systems, method invocation is also known as message
passing: an object passes a message to another object, and it may or may not expect
a message back. This point-to-point interaction can take place between the parties
directly involved in the communication, or it can happen via an intermediary. The
intermediary is then in charge of keeping track of who is interested in the messages
and in delivering the messages forth and back, when required. As mentioned earlier,
the use of an intermediary has the benefit of decoupling the parties involved
in the communications, as now they only need to know about the intermediary; the
other benefit is that the use of an intermediary opens up the possibility of
multiple party communication: more than one object can express interest in
receiving the same message, and the same message can be delivered to more than
one object. To this aim, the intermediary is the entity that exists throughout
the system lifecycle, as it needs to be able to track whose interest is associated
to what message.</p>
<p>In a design for a system that enables callback-based communication, the following
aspects need to be taken into account:</p>
<ul class="simple">
<li>how to become consumer of messages (i.e. how to be on the receiving end of the message);</li>
<li>how to become producer of messages (i.e. how to be on the sending end of the message);</li>
<li>how to consume/produce messages selectively;</li>
</ul>
<p>Translate and narrow this down to Neutron needs, and this means the design of a callback
system where messages are about lifecycle events (e.g. before creation, before
deletion, etc.) of Neutron resources (e.g. networks, routers, ports, etc.), where the
various parties can express interest in knowing when these events for a specific
resources take place.</p>
<p>Rather than keeping the conversation abstract, let us delve into some examples, that would
help understand better some of the principles behind the provided mechanism.</p>
<div class="section" id="event-payloads">
<h2>Event payloads<a class="headerlink" href="#event-payloads" title="Permalink to this headline">¶</a></h2>
<p>The use of <code class="docutils literal"><span class="pre">**kwargs</span></code> for callback event payloads is deprecated (slated to be
removed in &#8216;Queens&#8217;) in favor of standardized event payload objects as
described herein.</p>
<p>The event payloads are defined in <code class="docutils literal"><span class="pre">neutron_lib.callbacks.events</span></code> and define a
set of set of payload objects based on consumption pattern. The following event
objects are defined today:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">EventPayload</span></code>: Base object for all other payloads and define the common set
of attributes used by events. The <code class="docutils literal"><span class="pre">EventPayload</span></code> can also be used directly
for basic payloads that don&#8217;t need to transport additional values.</li>
<li><code class="docutils literal"><span class="pre">DBEventPayload</span></code>: Payloads pertaining to database callbacks. These objects
capture both the pre and post state (among other things) for database
changes.</li>
<li><code class="docutils literal"><span class="pre">APIEventPayload</span></code>: Payloads pertaining to API callbacks. These objects
capture details relating to an API event; such as the method name and API
action.</li>
</ul>
<p>Each event object is described in greater detail in its own subsection below.</p>
<p>For backwards compatibility the callback registry and manager still provide
the <code class="docutils literal"><span class="pre">notify</span></code> method for passing <code class="docutils literal"><span class="pre">**kwargs</span></code>, but also provide the
<code class="docutils literal"><span class="pre">publish</span></code> method for passing an event object.</p>
<div class="section" id="event-objects-eventpayload">
<h3>Event objects: EventPayload<a class="headerlink" href="#event-objects-eventpayload" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">EventPayload</span></code> object is the parent class of all other payload objects
and defines the common set of attributes applicable to most events. For
example, the <code class="docutils literal"><span class="pre">EventPayload</span></code> contains the <code class="docutils literal"><span class="pre">context</span></code>, <code class="docutils literal"><span class="pre">request_body</span></code>, etc.
In addition, a <code class="docutils literal"><span class="pre">metadata</span></code> attribute is available to transport event data
that&#8217;s not yet standardized. While the <code class="docutils literal"><span class="pre">metadata</span></code> attribute is there for
use, it should only be used in special cases like phasing in new payload
attributes.</p>
<p>Payload objects also transport resource state via the <code class="docutils literal"><span class="pre">states</span></code> attribute.
This collection of resource objects tracks the state changes for the respective
resource related to the event. For example database changes might have a
pre and post updated resource that&#8217;s used as <code class="docutils literal"><span class="pre">states</span></code>. Tracking states
allows consumers to inspect the various changes in the resource and take
action as needed; for example checking the pre and post object to determine
the delta. State object types are event specific; API events may use python
<code class="docutils literal"><span class="pre">dicts</span></code> as state objects whereas database events use resource/OVO model objects.</p>
<p>Note that states as well as any other event payload attributes are not copied;
subscribers obtain a direct reference to event payload objects (states,
metadata, etc.) and should not be modified by subscribers.</p>
</div>
<div class="section" id="event-objects-dbeventpayload">
<h3>Event objects: DBEventPayload<a class="headerlink" href="#event-objects-dbeventpayload" title="Permalink to this headline">¶</a></h3>
<p>For datastore/database events, <code class="docutils literal"><span class="pre">DBEventPayload</span></code> can be used as the payload
event object. In addition to the attributes inherited from <code class="docutils literal"><span class="pre">EventPayload</span></code>,
database payloads also contain an additional <code class="docutils literal"><span class="pre">desired_state</span></code>. The desired state
is intended for use with pre create/commit scenarios where the publisher
has a resource object (yet to be persisted) that&#8217;s used in the event payload.</p>
<p>These event objects are suitable for the standard before/after database
events we have today as well as any that might arise in the future.</p>
<p>Example usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span># BEFORE_CREATE:
DBEventPayload(context,
               request_body=params_of_create_request,
               resource_id=id_of_resource_if_avail,
               desired_state=db_resource_to_commit)

# AFTER_CREATE:
DBEventPayload(context,
               request_body=params_of_create_request,
               states=[my_new_copy_after_create],
               resource_id=id_of_resource)

# PRECOMMIT_CREATE:
DBEventPayload(context,
               request_body=params_of_create_request,
               resource_id=id_of_resource_if_avail,
               desired_state=db_resource_to_commit)

# BEFORE_DELETE:
DBEventPayload(context,
               states=[resource_to_delete],
               resource_id=id_of_resource)

# AFTER_DELETE:
DBEventPayload(context,
               states=[copy_of_deleted_resource],
               resource_id=id_of_resource)

# BEFORE_UPDATE:
DBEventPayload(context,
               request_body=body_of_update_request,
               states=[original_db_resource],
               resource_id=id_of_resource
               desired_state=updated_db_resource_to_commit)

# AFTER_UPDATE:
DBEventPayload(context,
               request_body=body_of_update_request,
               states=[original_db_resource, updated_db_resource],
               resource_id=id_of_resource)
</pre></div>
</div>
</div>
<div class="section" id="event-objects-apieventpayload">
<h3>Event objects: APIEventPayload<a class="headerlink" href="#event-objects-apieventpayload" title="Permalink to this headline">¶</a></h3>
<p>For API related callbacks, the <code class="docutils literal"><span class="pre">APIEventPayload</span></code> object can be used to
transport callback payloads. For example, the REST API resource controller can
use API events for pre/post operation callbacks.</p>
<p>In addition to transporting all the attributes of <code class="docutils literal"><span class="pre">EventPayload</span></code>, the
<code class="docutils literal"><span class="pre">APIEventPayload</span></code> object also includes the <code class="docutils literal"><span class="pre">action</span></code>, <code class="docutils literal"><span class="pre">method_name</span></code> and
<code class="docutils literal"><span class="pre">collection_name</span></code> payload attributes permitting API components to
pass along API controller specifics.</p>
<p>Sample usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># BEFORE_RESPONSE for create:</span>
<span class="n">APIEventPayload</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">notifier_method</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
         <span class="n">request_body</span><span class="o">=</span><span class="n">req_body</span><span class="p">,</span>
         <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">create_result</span><span class="p">],</span>
         <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_name</span><span class="p">)</span>

<span class="c1"># BEFORE_RESPONSE for delete:</span>
<span class="n">APIEventPayload</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">notifier_method</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
         <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">copy_of_deleted_resource</span><span class="p">],</span>
         <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_name</span><span class="p">)</span>

<span class="c1"># BEFORE_RESPONSE for update:</span>
<span class="n">APIEventPayload</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">notifier_method</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
         <span class="n">states</span><span class="o">=</span><span class="p">[</span><span class="n">original</span><span class="p">,</span> <span class="n">updated</span><span class="p">],</span>
         <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_collection_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="subscribing-to-events">
<h2>Subscribing to events<a class="headerlink" href="#subscribing-to-events" title="Permalink to this headline">¶</a></h2>
<p>Imagine that you have entity A, B, and C that have some common business over router creation.
A wants to tell B and C that the router has been created and that they need to get on and
do whatever they are supposed to do. In a callback-less world this would work like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span># A is done creating the resource
# A gets hold of the references of B and C
# A calls B
# A calls C
B-&gt;my_random_method_for_knowing_about_router_created()
C-&gt;my_random_very_difficult_to_remember_method_about_router_created()
</pre></div>
</div>
<p>If B and/or C change, things become sour. In a callback-based world, things become a lot
more uniform and straightforward:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span># B and C ask I to be notified when A is done creating the resource

# ...
# A is done creating the resource
# A gets hold of the reference to the intermediary I
# A calls I
I-&gt;notify()
</pre></div>
</div>
<p>Since B and C will have expressed interest in knowing about A&#8217;s business, &#8216;I&#8217; will
deliver the messages to B and C. If B and C changes, A and &#8216;I&#8217; do not need to change.</p>
<p>In practical terms this scenario would be translated in the code below:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">def</span> <span class="nf">callback1</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Callback1 called by trigger: &#39;</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;payload: &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback2</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Callback2 called by trigger: &#39;</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;payload: &#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>


<span class="c1"># B and C express interest with I</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback2</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Subscribed&#39;</span><span class="p">)</span>


<span class="c1"># A notifies</span>
<span class="k">def</span> <span class="nf">do_notify</span><span class="p">():</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">,</span>
                     <span class="n">do_notify</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">EventPayload</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>


<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Notifying...&#39;</span><span class="p">)</span>
<span class="n">do_notify</span><span class="p">()</span>
</pre></div>
</div>
<p>The output is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt; Subscribed
&gt; Notifying...
&gt; Callback2 called by trigger:  &lt;function do_notify at 0x7f2a5d663410&gt;
&gt; payload: &lt;neutron_lib._callbacks.events.EventPayload object at 0x7ff9ed253510&gt;
&gt; Callback1 called by trigger:  &lt;function do_notify at 0x7f2a5d663410&gt;
&gt; payload: &lt;neutron_lib._callbacks.events.EventPayload object at 0x7ff9ed253510&gt;
</pre></div>
</div>
<p>Thanks to the intermediary existence throughout the life of the system, A, B, and C
are flexible to evolve their internals, dynamics, and lifecycles.</p>
</div>
<div class="section" id="subscribing-and-aborting-events">
<h2>Subscribing and aborting events<a class="headerlink" href="#subscribing-and-aborting-events" title="Permalink to this headline">¶</a></h2>
<p>Interestingly in Neutron, certain events may need to be forbidden from happening due to the
nature of the resources involved. To this aim, the callback-based mechanism has been designed
to support a use case where, when callbacks subscribe to specific events, the action that
results from it, may lead to the propagation of a message back to the sender, so that it itself
can be alerted and stop the execution of the activity that led to the message dispatch in the
first place.</p>
<p>The typical example is where a resource, like a router, is used by one or more high-level
service(s), like a VPN or a Firewall, and actions like interface removal or router destruction
cannot not take place, because the resource is shared.</p>
<p>To address this scenario, special events are introduced, &#8216;BEFORE_*&#8217; events, to which callbacks
can subscribe and have the opportunity to &#8216;abort&#8217;, by raising an exception when notified.</p>
<p>Since multiple callbacks may express an interest in the same event for a particular resource,
and since callbacks are executed independently from one another, this may lead to situations
where notifications that occurred before the exception must be aborted. To this aim, when an
exception occurs during the notification process, an abort_* event is propagated immediately
after. It is up to the callback developer to determine whether subscribing to an abort
notification is required in order to revert the actions performed during the initial execution
of the callback (when the BEFORE_* event was fired). Exceptions caused by callbacks registered
to abort events are ignored. The snippet below shows this in action:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">def</span> <span class="nf">callback1</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;I am failing!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback2</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Callback2 called by </span><span class="si">%s</span><span class="s1"> on event  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>


<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback2</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback2</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">ABORT_CREATE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Subscribed&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_notify</span><span class="p">():</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Notifying...&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">do_notify</span><span class="p">()</span>
<span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">CallbackFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>The output is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt; Subscribed
&gt; Notifying...
&gt; Callback2 called by &lt;function do_notify at 0x7f3194c7f410&gt; on event  before_create
&gt; Callback2 called by &lt;function do_notify at 0x7f3194c7f410&gt; on event  abort_create
&gt; Error:  Callback __main__.callback1 failed with &quot;I am failing!&quot;
</pre></div>
</div>
<p>In this case, upon the notification of the BEFORE_CREATE event, Callback1 triggers an exception
that can be used to stop the action from taking place in do_notify(). On the other end, Callback2
will be executing twice, once for dealing with the BEFORE_CREATE event, and once to undo the
actions during the ABORT_CREATE event. It is worth noting that it is not mandatory to have
the same callback register to both BEFORE_* and the respective ABORT_* event; as a matter of
fact, it is best to make use of different callbacks to keep the two logic separate.</p>
</div>
<div class="section" id="unsubscribing-to-events">
<h2>Unsubscribing to events<a class="headerlink" href="#unsubscribing-to-events" title="Permalink to this headline">¶</a></h2>
<p>There are a few options to unsubscribe registered callbacks:</p>
<ul class="simple">
<li>clear(): it unsubscribes all subscribed callbacks: this can be useful especially when
winding down the system, and notifications shall no longer be triggered.</li>
<li>unsubscribe(): it selectively unsubscribes a callback for a specific resource&#8217;s event.
Say callback C has subscribed to event A for resource R, any notification of event A
for resource R will no longer be handed over to C, after the unsubscribe() invocation.</li>
<li>unsubscribe_by_resource(): say that callback C has subscribed to event A, B, and C for
resource R, any notification of events related to resource R will no longer be handed
over to C, after the unsubscribe_by_resource() invocation.</li>
<li>unsubscribe_all(): say that callback C has subscribed to events A, B for resource R1,
and events C, D for resource R2, any notification of events pertaining resources R1 and
R2 will no longer be handed over to C, after the unsubscribe_all() invocation.</li>
</ul>
<p>The snippet below shows these concepts in action:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">def</span> <span class="nf">callback1</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Callback1 called by </span><span class="si">%s</span><span class="s1"> on event </span><span class="si">%s</span><span class="s1"> for resource </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">callback2</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Callback2 called by </span><span class="si">%s</span><span class="s1"> on event </span><span class="si">%s</span><span class="s1"> for resource </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>


<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_READ</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">AFTER_DELETE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">PORT</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_UPDATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback2</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER_GATEWAY</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_UPDATE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Subscribed&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_notify</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Notifying...&#39;</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_READ</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">AFTER_DELETE</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">PORT</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_UPDATE</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER_GATEWAY</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_UPDATE</span><span class="p">,</span> <span class="n">do_notify</span><span class="p">)</span>


<span class="n">do_notify</span><span class="p">()</span>
<span class="n">registry</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_READ</span><span class="p">)</span>
<span class="n">do_notify</span><span class="p">()</span>
<span class="n">registry</span><span class="o">.</span><span class="n">unsubscribe_by_resource</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">PORT</span><span class="p">)</span>
<span class="n">do_notify</span><span class="p">()</span>
<span class="n">registry</span><span class="o">.</span><span class="n">unsubscribe_all</span><span class="p">(</span><span class="n">callback1</span><span class="p">)</span>
<span class="n">do_notify</span><span class="p">()</span>
<span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="n">do_notify</span><span class="p">()</span>
</pre></div>
</div>
<p>The output is:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Subscribed
Notifying...
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_read for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_create for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event after_delete for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource port
Callback2 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource router_gateway
Notifying...
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_create for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event after_delete for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource port
Callback2 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource router_gateway
Notifying...
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_create for resource router
Callback1 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event after_delete for resource router
Callback2 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource router_gateway
Notifying...
Callback2 called by &lt;function do_notify at 0x7f062c8f67d0&gt; on event before_update for resource router_gateway
Notifying...
</pre></div>
</div>
</div>
<div class="section" id="testing-with-callbacks">
<h2>Testing with callbacks<a class="headerlink" href="#testing-with-callbacks" title="Permalink to this headline">¶</a></h2>
<p>A python <a class="reference external" href="https://pypi.python.org/pypi/fixtures">fixture</a> is provided for implementations that need to
unit test and mock the callback registry. This can be used for example, when your code publishes callback events
that you need to verify. Consumers can use <code class="docutils literal"><span class="pre">neutron_lib.tests.unit.callbacks.base.CallbackRegistryFixture</span></code>
in their unit test classes with the <code class="docutils literal"><span class="pre">useFixture()</span></code> method passing along a <code class="docutils literal"><span class="pre">CallbackRegistryFixture</span></code> instance.
If mocking of the actual singleton callback manager is necessary, consumers can pass a value to
with the <code class="docutils literal"><span class="pre">callback_manager</span></code> kwarg. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MyTestClass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">registry_fixture</span> <span class="o">=</span> <span class="n">callback_base</span><span class="o">.</span><span class="n">CallbackRegistryFixture</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">useFixture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry_fixture</span><span class="p">)</span>
    <span class="c1"># each test now uses an isolated callback manager</span>
</pre></div>
</div>
</div>
<div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h2>
<p>Can I use the callbacks registry to subscribe and notify non-core resources and events?</p>
<blockquote>
<div>Short answer is yes. The callbacks module defines literals for what are considered core Neutron
resources and events. However, the ability to subscribe/notify is not limited to these as you
can use your own defined resources and/or events. Just make sure you use string literals, as
typos are common, and the registry does not provide any runtime validation. Therefore, make
sure you test your code!</div></blockquote>
<p>What is the relationship between Callbacks and Taskflow?</p>
<blockquote>
<div>There is no overlap between Callbacks and Taskflow or mutual exclusion; as matter of fact they
can be combined; You could have a callback that goes on and trigger a taskflow. It is a nice
way of separating implementation from abstraction, because you can keep the callback in place
and change Taskflow with something else.</div></blockquote>
<p>Is there any ordering guarantee during notifications?</p>
<blockquote>
<div>No, the ordering in which callbacks are notified is completely arbitrary by design: callbacks
should know nothing about each other, and ordering should not matter; a callback will always be
notified and its outcome should always be the same regardless as to in which order is it
notified. Priorities can be a future extension, if a use case arises that require enforced
ordering.</div></blockquote>
<p>How is the notifying object expected to interact with the subscribing objects?</p>
<blockquote>
<div>The <code class="docutils literal"><span class="pre">notify</span></code> method implements a one-way communication paradigm: the notifier sends a message
without expecting a response back (in other words it fires and forget). However, due to the nature
of Python, the payload can be mutated by the subscribing objects, and this can lead to unexpected
behavior of your code, if you assume that this is the intentional design. Bear in mind, that
passing-by-value using deepcopy was not chosen for efficiency reasons. Having said that, if you
intend for the notifier object to expect a response, then the notifier itself would need to act
as a subscriber.</div></blockquote>
<p>Is the registry thread-safe?</p>
<blockquote>
<div>Short answer is no: it is not safe to make mutations while callbacks are being called (more
details as to why can be found <a class="reference external" href="https://hg.python.org/releasing/2.7.9/file/753a8f457ddc/Objects/dictobject.c#l937">here</a>).
A mutation could happen if a &#8216;subscribe&#8217;/&#8217;unsubscribe&#8217; operation interleaves with the execution
of the notify loop. Albeit there is a possibility that things may end up in a bad state, the
registry works correctly under the assumption that subscriptions happen at the very beginning
of the life of the process and that the unsubscriptions (if any) take place at the very end.
In this case, chances that things do go badly may be pretty slim. Making the registry
thread-safe will be considered as a future improvement.</div></blockquote>
<p>What kind of function can be a callback?</p>
<blockquote>
<div>Anything you fancy: lambdas, &#8216;closures&#8217;, class, object or module methods. For instance:</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">neutron_lib.callbacks</span> <span class="kn">import</span> <span class="n">registry</span>


<span class="k">def</span> <span class="nf">callback1</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;module callback&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyCallback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">callback2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;object callback&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">callback3</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;class callback&#39;</span><span class="p">)</span>


<span class="n">c</span> <span class="o">=</span> <span class="n">MyCallback</span><span class="p">()</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">callback1</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">callback2</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>
<span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">MyCallback</span><span class="o">.</span><span class="n">callback3</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">do_notify</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">nested_subscribe</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;nested callback&#39;</span><span class="p">)</span>

    <span class="n">registry</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">nested_subscribe</span><span class="p">,</span> <span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">)</span>

    <span class="n">registry</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">BEFORE_CREATE</span><span class="p">,</span>
                     <span class="n">do_notify</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">EventPayload</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>


<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Notifying...&#39;</span><span class="p">)</span>
<span class="n">do_notify</span><span class="p">()</span>
</pre></div>
</div>
<p>And the output is going to be:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Notifying...
module callback
object callback
class callback
nested callback
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Neutron Callback System</a><ul>
<li><a class="reference internal" href="#event-payloads">Event payloads</a><ul>
<li><a class="reference internal" href="#event-objects-eventpayload">Event objects: EventPayload</a></li>
<li><a class="reference internal" href="#event-objects-dbeventpayload">Event objects: DBEventPayload</a></li>
<li><a class="reference internal" href="#event-objects-apieventpayload">Event objects: APIEventPayload</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subscribing-to-events">Subscribing to events</a></li>
<li><a class="reference internal" href="#subscribing-and-aborting-events">Subscribing and aborting events</a></li>
<li><a class="reference internal" href="#unsubscribing-to-events">Unsubscribing to events</a></li>
<li><a class="reference internal" href="#testing-with-callbacks">Testing with callbacks</a></li>
<li><a class="reference internal" href="#faq">FAQ</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="api_validators.html"
                                  title="previous chapter">API Validators</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/neutron-lib
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/devref/callbacks.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api_validators.html" title="API Validators"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">neutron-lib 1.1.1.dev70 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Developer Guide</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015-present, OpenStack Foundation..
      Last updated on &#39;Tue Feb 14 19:59:47 2017, commit b0d4f85&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/neutron-lib");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>