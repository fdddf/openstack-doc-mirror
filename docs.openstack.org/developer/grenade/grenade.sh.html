<!DOCTYPE html>
<html>
<head>
    <meta http-eqiv='content-type' content='text/html;charset=utf-8'>
    <title>grenade.sh</title>
    <link rel=stylesheet href="http://jashkenas.github.com/docco/resources/classic/docco.css">
</head>
<body>
<div id=container>
    <div id=background></div>
    <table cellspacing=0 cellpadding=0>
    <thead>
      <tr>
        <th class=docs><h1>grenade.sh</h1></th>
        <th class=code></th>
      </tr>
    </thead>
    <tbody>
        <tr><td class='docs'><?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7952 2016-07-26 18:15:59Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<p><tt class="docutils literal">grenade.sh</tt> is an OpenStack upgrade test harness to exercise the
OpenStack upgrade process.  It uses DevStack to perform the initial
OpenStack install.</p>
<span></span><span class="c1"># DIVIDER</span>
<span class="c1">#!/usr/bin/env bash</span>


<span class="c1"># DIVIDER</span>

<span class="c1"># DIVIDER</span>



<span class="c1"># DIVIDER</span>
<span class="nb">export</span> <span class="nv">GRENADE_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$0</span><span class="s2">&quot;</span><span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>

<span class="c1"># DIVIDER</span>
<span class="nb">export</span> <span class="nv">DSTOOLS_VERSION</span><span class="o">=</span><span class="si">${</span><span class="nv">DSTOOLS_VERSION</span><span class="k">:-</span><span class="nv">0</span><span class="p">.1.4</span><span class="si">}</span>
<span class="nb">source</span> <span class="nv">$GRENADE_DIR</span>/grenaderc
<span class="nb">source</span> <span class="nv">$GRENADE_DIR</span>/inc/bootstrap

<span class="k">while</span> <span class="nb">getopts</span> bqs:t c<span class="p">;</span> <span class="k">do</span>
    <span class="k">case</span> <span class="nv">$c</span> in
        b<span class="o">)</span>
            <span class="nv">RUN_TARGET</span><span class="o">=</span>False
            <span class="p">;;</span>
        q<span class="o">)</span>
            <span class="nv">VERBOSE</span><span class="o">=</span>False
            <span class="p">;;</span>
        s<span class="o">)</span>
            <span class="nv">STOP</span><span class="o">=</span><span class="nv">$2</span>
            <span class="p">;;</span>
        t<span class="o">)</span>
            <span class="nv">RUN_BASE</span><span class="o">=</span>False
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>
<span class="nb">shift</span> <span class="sb">`</span>expr <span class="nv">$OPTIND</span> - <span class="m">1</span><span class="sb">`</span>


<span class="c1"># DIVIDER</span>
sudo mkdir -p <span class="nv">$BASE_RELEASE_DIR</span> <span class="nv">$TARGET_RELEASE_DIR</span>
sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$STACK_ROOT</span>

<span class="c1"># DIVIDER</span>

<span class="c1"># DIVIDER</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$LOGFILE</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">LOGDAYS</span><span class="o">=</span><span class="si">${</span><span class="nv">LOGDAYS</span><span class="k">:-</span><span class="nv">7</span><span class="si">}</span>
    <span class="nv">TIMESTAMP_FORMAT</span><span class="o">=</span><span class="si">${</span><span class="nv">TIMESTAMP_FORMAT</span><span class="k">:-</span><span class="s2">&quot;%F-%H%M%S&quot;</span><span class="si">}</span>
    <span class="nv">CURRENT_LOG_TIME</span><span class="o">=</span><span class="k">$(</span>date <span class="s2">&quot;+</span><span class="nv">$TIMESTAMP_FORMAT</span><span class="s2">&quot;</span><span class="k">)</span>

<span class="c1"># DIVIDER</span>
    <span class="nv">LOGDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&quot;</span><span class="nv">$LOGFILE</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="nv">LOGNAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="s2">&quot;</span><span class="nv">$LOGFILE</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Creating </span><span class="nv">$LOGDIR</span><span class="s2">....&quot;</span>

    sudo mkdir -p <span class="nv">$LOGDIR</span>
    sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$LOGDIR</span>
    find <span class="nv">$LOGDIR</span> -maxdepth <span class="m">1</span> -name <span class="nv">$LOGNAME</span>.<span class="se">\*</span> -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="nv">LOGFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="si">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="si">}</span>
    <span class="nv">SUMFILE</span><span class="o">=</span><span class="nv">$LOGFILE</span>.<span class="si">${</span><span class="nv">CURRENT_LOG_TIME</span><span class="si">}</span>.summary

<span class="c1"># DIVIDER</span>
    <span class="nb">exec</span> <span class="m">3</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$VERBOSE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Running in verbose mode:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Full logs found at =&gt; </span><span class="si">${</span><span class="nv">LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Summary logs at =&gt; </span><span class="si">${</span><span class="nv">SUMFILE</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="c1"># DIVIDER</span>
        <span class="nb">exec</span> <span class="m">1</span>&gt; &gt;<span class="o">(</span> ./tools/outfilter.py -v -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># DIVIDER</span>
        <span class="nb">exec</span> <span class="m">6</span>&gt; &gt;<span class="o">(</span> ./tools/outfilter.py -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUMFILE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">)</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Running in summary mode:&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Full logs found at =&gt; </span><span class="si">${</span><span class="nv">LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">echo</span> <span class="s2">&quot;  Summary logs at =&gt; </span><span class="si">${</span><span class="nv">SUMFILE</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="c1"># DIVIDER</span>
        <span class="nb">exec</span> <span class="m">1</span>&gt; &gt;<span class="o">(</span> ./tools/outfilter.py -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">)</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="c1"># DIVIDER</span>
        <span class="nb">exec</span> <span class="m">6</span>&gt; &gt;<span class="o">(</span> ./tools/outfilter.py -v -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUMFILE</span><span class="si">}</span><span class="s2">&quot;</span> &gt;<span class="p">&amp;</span><span class="m">3</span><span class="o">)</span>
    <span class="k">fi</span>

    echo_summary <span class="s2">&quot;grenade.sh log </span><span class="nv">$LOGFILE</span><span class="s2">&quot;</span>
<span class="c1"># DIVIDER</span>
    ln -sf <span class="nv">$LOGFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>
    ln -sf <span class="nv">$SUMFILE</span> <span class="nv">$LOGDIR</span>/<span class="nv">$LOGNAME</span>.summary
<span class="k">else</span>
<span class="c1"># DIVIDER</span>
    <span class="nb">exec</span> <span class="m">3</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$VERBOSE</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="c1"># DIVIDER</span>
        <span class="nb">exec</span> <span class="m">1</span>&gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="k">fi</span>
<span class="c1"># DIVIDER</span>
    <span class="nb">exec</span> <span class="m">6</span>&gt; &gt;<span class="o">(</span> ./tools/outfilter.py -v -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUMFILE</span><span class="si">}</span><span class="s2">&quot;</span> &gt;<span class="p">&amp;</span><span class="m">3</span><span class="o">)</span>
<span class="k">fi</span>

<span class="c1"># DIVIDER</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;</span><span class="nv">$SCREEN_LOGDIR</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>

<span class="c1"># DIVIDER</span>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="s2">&quot;</span><span class="nv">$SCREEN_LOGDIR</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="c1"># DIVIDER</span>
        find <span class="nv">$SCREEN_LOGDIR</span> -maxdepth <span class="m">1</span> -name screen-<span class="se">\*</span>.log -mtime +<span class="nv">$LOGDAYS</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
    <span class="k">else</span>
        sudo mkdir -p <span class="nv">$SCREEN_LOGDIR</span>
        sudo chown -R <span class="sb">`</span>whoami<span class="sb">`</span> <span class="nv">$SCREEN_LOGDIR</span>
    <span class="k">fi</span>
<span class="k">fi</span>


<span class="c1"># DIVIDER</span>
<span class="nb">set</span> -o errexit

<span class="c1"># DIVIDER</span>
<span class="nb">set</span> -o xtrace


<span class="c1"># DIVIDER</span>

<span class="c1"># DIVIDER</span>
fetch_devstacks

<span class="c1"># DIVIDER</span>
<span class="nb">source</span> <span class="nv">$GRENADE_DIR</span>/functions

<span class="c1"># DIVIDER</span>
<span class="nb">export</span> <span class="nv">PS4</span><span class="o">=</span><span class="s1">&#39;+ $(short_source):   &#39;</span>

<span class="c1"># DIVIDER</span>
<span class="nb">export</span> <span class="nv">TOP_DIR</span><span class="o">=</span><span class="nv">$TARGET_DEVSTACK_DIR</span>

<span class="c1"># DIVIDER</span>

<span class="nb">source</span> <span class="nv">$TARGET_DEVSTACK_DIR</span>/inc/meta-config
<span class="c1"># DIVIDER</span>
extract_localrc_section <span class="nv">$BASE_DEVSTACK_DIR</span>/local.conf <span class="se">\</span>
                        <span class="nv">$BASE_DEVSTACK_DIR</span>/localrc <span class="se">\</span>
                        <span class="nv">$BASE_DEVSTACK_DIR</span>/.localrc.auto

<span class="c1"># DIVIDER</span>
<span class="nv">ENABLED_SERVICES</span><span class="o">=</span><span class="k">$(</span><span class="nb">set</span> +o xtrace <span class="o">&amp;&amp;</span>
                   <span class="nb">source</span> <span class="nv">$BASE_DEVSTACK_DIR</span>/stackrc <span class="o">&amp;&amp;</span>
                   <span class="nb">echo</span> <span class="nv">$ENABLED_SERVICES</span><span class="k">)</span>

<span class="c1"># DIVIDER</span>
fetch_grenade_plugins

<span class="c1"># DIVIDER</span>
load_settings

<span class="c1"># DIVIDER</span>

extract_localrc_section <span class="nv">$TARGET_DEVSTACK_DIR</span>/local.conf <span class="se">\</span>
                        <span class="nv">$TARGET_DEVSTACK_DIR</span>/localrc <span class="se">\</span>
                        <span class="nv">$TARGET_DEVSTACK_DIR</span>/.localrc.auto

<span class="c1"># DIVIDER</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$RUN_BASE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>

<span class="c1"># DIVIDER</span>
    init_grenade_db

    echo_summary <span class="s2">&quot;Running base stack.sh&quot;</span>
    <span class="nb">cd</span> <span class="nv">$BASE_DEVSTACK_DIR</span>
    <span class="nv">GIT_BASE</span><span class="o">=</span><span class="nv">$GIT_BASE</span> ./stack.sh
    stop <span class="nv">$STOP</span> stack.sh <span class="m">10</span>

    echo_summary <span class="s2">&quot;Running post-stack.sh&quot;</span>
    <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$GRENADE_DIR</span>/post-stack.sh <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">cd</span> <span class="nv">$GRENADE_DIR</span>
        ./post-stack.sh
        stop <span class="nv">$STOP</span> post-stack.sh <span class="m">15</span>
        echo_summary <span class="s2">&quot;Completed post-stack.sh&quot;</span>
    <span class="k">fi</span>

<span class="c1"># DIVIDER</span>

    echo_summary <span class="s2">&quot;Caching downloaded images&quot;</span>
    mkdir -p <span class="nv">$BASE_RELEASE_DIR</span>/images
    <span class="nb">echo</span> <span class="s2">&quot;Images: </span><span class="nv">$IMAGE_URLS</span><span class="s2">&quot;</span>
    <span class="k">for</span> image_url in <span class="si">${</span><span class="nv">IMAGE_URLS</span><span class="p">//,/ </span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
        <span class="nv">IMAGE_FNAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;</span><span class="nv">$image_url</span><span class="s2">&quot;</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[[</span> -r <span class="nv">$BASE_DEVSTACK_DIR</span>/files/<span class="nv">$IMAGE_FNAME</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
            rsync -a <span class="nv">$BASE_DEVSTACK_DIR</span>/files/<span class="nv">$IMAGE_FNAME</span> <span class="nv">$BASE_RELEASE_DIR</span>/images
        <span class="k">fi</span>
    <span class="k">done</span>
<span class="c1"># DIVIDER</span>
    <span class="k">if</span> <span class="o">[[</span> -d <span class="nv">$BASE_DEVSTACK_DIR</span>/files/images <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
        rsync -a <span class="nv">$BASE_DEVSTACK_DIR</span>/files/images/ <span class="nv">$BASE_RELEASE_DIR</span>/images
    <span class="k">fi</span>
    stop <span class="nv">$STOP</span> image-cache <span class="m">20</span>

<span class="c1"># DIVIDER</span>

<span class="c1"># DIVIDER</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$BASE_RUN_SMOKE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        echo_summary <span class="s2">&quot;Running base smoke test&quot;</span>
        <span class="nb">cd</span> <span class="nv">$BASE_RELEASE_DIR</span>/tempest
        tox -esmoke -- --concurrency<span class="o">=</span><span class="nv">$TEMPEST_CONCURRENCY</span>
<span class="c1"># DIVIDER</span>
        <span class="k">if</span> <span class="o">[[</span> -e <span class="nv">$TARGET_RELEASE_DIR</span>/tempest <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
            <span class="k">for</span> file in .tox .testrepository<span class="p">;</span> <span class="k">do</span>
                rsync -a <span class="nv">$BASE_RELEASE_DIR</span>/tempest/<span class="nv">$file</span>/ <span class="nv">$TARGET_RELEASE_DIR</span>/tempest/<span class="nv">$file</span>/
            <span class="k">done</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
    stop <span class="nv">$STOP</span> base-smoke <span class="m">110</span>

<span class="c1"># DIVIDER</span>
    resources early_create

<span class="c1"># DIVIDER</span>
    resources create

<span class="c1"># DIVIDER</span>
    resources verify pre-upgrade

<span class="c1"># DIVIDER</span>
    echo_summary <span class="s2">&quot;Saving current state information&quot;</span>
    <span class="nv">$GRENADE_DIR</span>/save-state
    stop <span class="nv">$STOP</span> save-state <span class="m">130</span>

<span class="c1"># DIVIDER</span>
    echo_summary <span class="s2">&quot;Shutting down all services on base devstack...&quot;</span>
    shutdown_services

<span class="c1"># DIVIDER</span>
    resources verify_noapi pre-upgrade
<span class="k">fi</span>


<span class="c1"># DIVIDER</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$RUN_TARGET</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="c1"># DIVIDER</span>
    fetch_plugins

<span class="c1"># DIVIDER</span>
    echo_summary <span class="s2">&quot;Preparing the target devstack environment&quot;</span>
    <span class="nv">$GRENADE_DIR</span>/prep-target

<span class="c1"># DIVIDER</span>
    <span class="nb">echo</span> <span class="s2">&quot;Upgrade projects: </span><span class="nv">$UPGRADE_PROJECTS</span><span class="s2">&quot;</span>
    <span class="k">for</span> project in <span class="nv">$UPGRADE_PROJECTS</span><span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;Upgrading project: </span><span class="nv">$project</span><span class="s2">&quot;</span>
        upgrade_service <span class="nv">$project</span>
    <span class="k">done</span>

<span class="c1"># DIVIDER</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$ENABLE_TEMPEST</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        echo_summary <span class="s2">&quot;Running upgrade-tempest&quot;</span>
        <span class="nv">$GRENADE_DIR</span>/upgrade-tempest <span class="o">||</span> die <span class="nv">$LINENO</span> <span class="s2">&quot;Failure in upgrade-tempest&quot;</span>
        stop <span class="nv">$STOP</span> upgrade-tempest <span class="m">290</span>
    <span class="k">fi</span>

<span class="c1"># DIVIDER</span>

<span class="c1"># DIVIDER</span>
    resources verify post-upgrade

<span class="c1"># DIVIDER</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$TARGET_RUN_SMOKE</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        echo_summary <span class="s2">&quot;Running tempest smoke tests&quot;</span>
        <span class="nb">cd</span> <span class="nv">$TARGET_RELEASE_DIR</span>/tempest
        tox -esmoke -- --concurrency<span class="o">=</span><span class="nv">$TEMPEST_CONCURRENCY</span>
        stop <span class="nv">$STOP</span> run-smoke <span class="m">330</span>
    <span class="k">fi</span>

<span class="c1"># DIVIDER</span>
    save_data <span class="nv">$TARGET_RELEASE</span> <span class="nv">$TARGET_DEVSTACK_DIR</span>

<span class="c1"># DIVIDER</span>
    resources destroy

<span class="k">fi</span>


<span class="c1"># DIVIDER</span>

echo_summary <span class="s2">&quot;Grenade has completed the pre-programmed upgrade scripts.&quot;</span>
<span class="c1"># DIVIDER</span>
echo_summary <span class="s2">&quot;grenade.sh completed in </span><span class="nv">$SECONDS</span><span class="s2"> seconds.&quot;</span>


<span class="c1"># DIVIDER</span>

</pre></div></td></tr><tr><td class=docs>
<p>Grenade assumes it is running on the system that will be hosting the
upgrade processes</p>
</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">grenade.sh <span class="pre">[-b]</span> <span class="pre">[-t]</span> <span class="pre">[-s</span> <span class="pre">stop-label]</span> <span class="pre">[-q]</span></tt></p>
<p><tt class="docutils literal"><span class="pre">-b</span></tt>    Run only the base part
<tt class="docutils literal"><span class="pre">-t</span></tt>    Run only the target part (assumes a base run is in place)
<tt class="docutils literal"><span class="pre">-q</span></tt>    Quiet mode
<tt class="docutils literal"><span class="pre">-s</span> <span class="pre">stop-label</span></tt> is the name of the step after which the script will stop.
This is useful for debugging upgrades.</p>
</pre></div></td></tr><tr><td class=docs>
<p><tt class="docutils literal">GRENADE_DIR</tt> is set once by the top level grenade.sh and exported
so that all subsequent scripts can find their way back to the
grenade root directory. No other scripts should set this variable</p>
</pre></div></td></tr><tr><td class=docs>
<p>Source the bootstrapping facilities</p>
<p>Grenade attempts to reuse as much content from devstack on the
target side as possible, but we need enough of our own code to get
there.</p>
<p><tt class="docutils literal">grenaderc</tt> is a set of X=Y declarations that don't need <em>any</em> of
the devstack functions to work</p>
<p><tt class="docutils literal">inc/bootstrap</tt> is the most minimal amount of functions that
grenade needs to get going. This includes things like echo
functions, trueorfalse, and the functions related to git cloning, so
that we can get our devstack trees.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Create all the base directory structures needed for the rest of the
environment to run.</p>
<p>This will give you an STACK_ROOT tree that you expect, and that your
normal user owns for follow on activities.</p>
</pre></div></td></tr><tr><td class=docs>
<div class="section" id="logging">
<h1>Logging</h1>
</pre></div></td></tr><tr><td class=docs>
<p>TODO(sdague): should this extract into <tt class="docutils literal">inc/bootstrap</tt>?</p>
<p>Set up logging
Set <tt class="docutils literal">LOGFILE</tt> to turn on logging
Append '.xxxxxxxx' to the given name to maintain history
where 'xxxxxxxx' is a representation of the date the file was created</p>
</pre></div></td></tr><tr><td class=docs>
<p>First clean up old log files.  Use the user-specified <tt class="docutils literal">LOGFILE</tt>
as the template to search for, appending '.*' to match the date
we added on earlier runs.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Redirect output according to config
Copy stdout to fd 3</p>
</pre></div></td></tr><tr><td class=docs>
<p>Redirect stdout/stderr to tee to write the log file</p>
</pre></div></td></tr><tr><td class=docs>
<p>Set up a second fd for output</p>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 1 and 2 to primary logfile</p>
</pre></div></td></tr><tr><td class=docs>
<p>Set fd 6 to summary logfile and stdout</p>
</pre></div></td></tr><tr><td class=docs>
<p>Specified logfile name always links to the most recent log</p>
</pre></div></td></tr><tr><td class=docs>
<p>Set up output redirection without log files
Copy stdout to fd 3</p>
</pre></div></td></tr><tr><td class=docs>
<p>Throw away stdout and stderr</p>
</pre></div></td></tr><tr><td class=docs>
<p>Always send summary fd to original stdout</p>
</pre></div></td></tr><tr><td class=docs>
<p>Set up logging of screen windows
Set <tt class="docutils literal">SCREEN_LOGDIR</tt> to turn on logging of screen windows to the
directory specified in <tt class="docutils literal">SCREEN_LOGDIR</tt>, we will log to the file
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME-$TIMESTAMP.log</span></tt> in that dir and have a link
<tt class="docutils literal"><span class="pre">screen-$SERVICE_NAME.log</span></tt> to the latest log file.
Logs are kept for as long specified in <tt class="docutils literal">LOGDAYS</tt>.</p>
</pre></div></td></tr><tr><td class=docs>
<p>We make sure the directory is created.</p>
</pre></div></td></tr><tr><td class=docs>
<p>We cleanup the old logs</p>
</pre></div></td></tr><tr><td class=docs>
<p>This script exits on an error so that errors don't compound and you see
only the first error that occurred.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Print the commands being run so that we can see the command that triggers
an error.  It is also useful for following allowing as the install occurs.</p>
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="devstack-phase-2-initialization">
<h1>Devstack Phase 2 initialization</h1>
<p>We now have enough infrastructure in grenade.sh to go and get <em>both</em>
SOURCE and TARGET devstack trees. After which point we 'pivot' onto
the TARGET devstack functions file, then source the rest of the
grenade settings. This should let us run the bulk of grenade.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Get both devstack trees, so that BASE_DEVSTACK_DIR, and
TARGET_DEVSTACK_DIR are now fully populated.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Source the rest of the Grenade functions. For convenience
<tt class="docutils literal">$GRENADE_DIR/functions</tt> implicitly sources
<tt class="docutils literal">$TARGET_DEVSTACK_DIR/functions</tt>. So this line can't happen until
we have the devstacks pulled down.</p>
</pre></div></td></tr><tr><td class=docs>
<p>We now have the 'short_source' function available, so setup our PS4 variable</p>
</pre></div></td></tr><tr><td class=docs>
<p>Many calls inside of devstack functions reference $TOP_DIR, which is
the root of devstack. We export $TOP_DIR to all child processes here
to be the TARGET_DEVSTACK_DIR.</p>
<p>If you want a script to use functions off of BASE_DEVSTACK_DIR (like
the shutdown phase) you <em>must</em> explicitly reset TOP_DIR in those
scripts.</p>
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="install-base-build-of-openstack">
<h1>Install 'Base' Build of OpenStack</h1>
</pre></div></td></tr><tr><td class=docs>
<p>Oh the complexity of bootstrapping. We need to populate enabled
services from what devstack-gate might have set it as.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Collect the ENABLED_SERVICES from the base directory, this is what
we are starting with.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Fetch all the grenade plugins which were registered in <tt class="docutils literal">pluginrc</tt>
via the <tt class="docutils literal">enable_grenade_plugin</tt> stanza. This must be done before
settings are loaded, but has to be this late to give access to all
the devstack functions.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Load the <tt class="docutils literal">settings</tt> files for all the in tree <tt class="docutils literal">projects/</tt>. This
registers all the projects in order that we're going to be upgrading
when the time is right.</p>
</pre></div></td></tr><tr><td class=docs>
<p>And ensure that we setup the target localrc.auto, because stack.sh
isn't run there. This has to be run after load_settings because
plugins might change the service list during this phase.</p>
</pre></div></td></tr><tr><td class=docs>
<p>Run the base install of the environment</p>
</pre></div></td></tr><tr><td class=docs>
<p>Initialize grenade_db local storage, used for resource tracking</p>
</pre></div></td></tr><tr><td class=docs>
<div class="section" id="cache-downloaded-instances">
<h2>Cache downloaded instances</h2>
</pre></div></td></tr><tr><td class=docs>
<p>NOTE(sileht): If glance is not enabled the directory cannot exists.</p>
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="operation">
<h2>Operation</h2>
</pre></div></td></tr><tr><td class=docs>
<p>Validate the install</p>
</pre></div></td></tr><tr><td class=docs>
<p>once we are done, copy our created artifacts to the target</p>
</pre></div></td></tr><tr><td class=docs>
<p>Early Create resources, used largely for network setup</p>
</pre></div></td></tr><tr><td class=docs>
<p>Create resources</p>
</pre></div></td></tr><tr><td class=docs>
<p>Verify the resources were created</p>
</pre></div></td></tr><tr><td class=docs>
<p>Save some stuff before we shut that whole thing down</p>
</pre></div></td></tr><tr><td class=docs>
<p>Shut down running code</p>
</pre></div></td></tr><tr><td class=docs>
<p>Verify the resources still exist after the shutdown</p>
</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="upgrades">
<h1>Upgrades</h1>
</pre></div></td></tr><tr><td class=docs>
<p>Clone all devstack plugins on the new side, because we're not
running a full stack.sh</p>
</pre></div></td></tr><tr><td class=docs>
<p>Get target devstack tree ready for services to be run from it,
including trying to reuse any existing files we pulled during
the base run.</p>
</pre></div></td></tr><tr><td class=docs>
<p>upgrade all the projects in order</p>
</pre></div></td></tr><tr><td class=docs>
<p>Upgrade Tempest</p>
</pre></div></td></tr><tr><td class=docs>
</div>
<div class="section" id="upgrade-tests">
<h1>Upgrade Tests</h1>
</pre></div></td></tr><tr><td class=docs>
<p>Verify the resources still exist after the upgrade</p>
</pre></div></td></tr><tr><td class=docs>
<p>Validate the upgrade
This is used for testing grenade locally, and should not be used in the
gate. Instead, grenade.sh runs smoke tests on the old cloud above, but
smoke tests are run on the upgraded cloud by the gate script after
grenade.sh has finished. If this option is enabled in the gate, tempest
will be run twice against the new cloud.</p>
</pre></div></td></tr><tr><td class=docs>
<div class="section" id="save-databases">
<h2>Save databases</h2>
</pre></div></td></tr><tr><td class=docs>
<p>Cleanup the resources</p>
</pre></div></td></tr><tr><td class=docs>
</div>
</div>
<div class="section" id="fin">
<h1>Fin</h1>
</pre></div></td></tr><tr><td class=docs>
<p>Indicate how long this took to run (bash maintained variable <tt class="docutils literal">SECONDS</tt>)</p>
</pre></div></td></tr><tr><td class=docs>
</pre></div></td></tr><tr><td class=docs>
</div>
</div>
</body>
</html></td><td class='code'></td></tr>
    </tbody>
    </table>
</div>
</body>
</html>
