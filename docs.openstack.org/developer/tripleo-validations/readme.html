<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Team and repository tags &mdash; tripleo-validations 5.3.1.dev2 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5.3.1.dev2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="tripleo-validations 5.3.1.dev2 documentation" href="index.html" />
    <link rel="next" title="Installation" href="installation.html" />
    <link rel="prev" title="Welcome to tripleo-validations’s documentation!" href="index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="team-and-repository-tags">
<h1>Team and repository tags<a class="headerlink" href="#team-and-repository-tags" title="Permalink to this headline">¶</a></h1>
<a class="reference external image-reference" href="http://governance.openstack.org/reference/tags/index.html"><img src="http://governance.openstack.org/badges/tripleo-validations.svg" /></a>
<div class="section" id="tripleo-validations">
<h2>TripleO Validations<a class="headerlink" href="#tripleo-validations" title="Permalink to this headline">¶</a></h2>
<p>A collection of Ansible playbooks to detect and report potential issues during TripleO deployments</p>
<p>The validations will help detect issues early in the deployment process and
prevent field engineers from wasting time on misconfiguration or hardware
issues in their environments.</p>
<p>All validations are written in Ansible and are written in a way that&#8217;s
consumable by the <a class="reference external" href="https://review.openstack.org/#/c/255792/">Mistral validation framework</a> or by Ansible directly. They are
available independently from the UI or the command line client.</p>
<ul class="simple">
<li>Free software: Apache license</li>
<li>Source: <a class="reference external" href="http://git.openstack.org/cgit/openstack/tripleo-validations">http://git.openstack.org/cgit/openstack/tripleo-validations</a></li>
<li>Bugs: <a class="reference external" href="https://bugs.launchpad.net/tripleo/+bugs?field.tag=validations">https://bugs.launchpad.net/tripleo/+bugs?field.tag=validations</a></li>
</ul>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>The TripleO validations require Ansible 2.0 or above:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sudo pip install &#39;ansible&gt;=2&#39;
</pre></div>
</div>
</div>
<div class="section" id="existing-validations">
<h3>Existing validations<a class="headerlink" href="#existing-validations" title="Permalink to this headline">¶</a></h3>
<p>Here are all the validations that currently exist. They&#8217;re grouped by
the deployment stage they&#8217;re should be run on.</p>
<p>Validations can belong to multiple groups.</p>
<div class="section" id="prep">
<h4>Prep<a class="headerlink" href="#prep" title="Permalink to this headline">¶</a></h4>
<p>Validations that are run on a fresh machine <em>before</em> the undercloud is
installed.</p>
<ul class="simple">
<li><a class="reference internal" href="validations-prep-details.html#prep-512e"><span>512e</span></a>: Advanced Format 512e Support</li>
<li><a class="reference internal" href="validations-prep-details.html#prep-undercloud-cpu"><span>undercloud-cpu</span></a>: Verify undercloud fits the CPU core requirements</li>
<li><a class="reference internal" href="validations-prep-details.html#prep-undercloud-disk-space"><span>undercloud-disk-space</span></a>: Verify undercloud fits the disk space requirements</li>
<li><a class="reference internal" href="validations-prep-details.html#prep-undercloud-ram"><span>undercloud-ram</span></a>: Verify the undercloud fits the RAM requirements</li>
</ul>
</div>
<div class="section" id="pre-introspection">
<h4>Pre Introspection<a class="headerlink" href="#pre-introspection" title="Permalink to this headline">¶</a></h4>
<p>Validations that are run when the undercloud is ready to perform hardware
introspection.</p>
<ul class="simple">
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-check-network-gateway"><span>check-network-gateway</span></a>: Check network_gateway on the provisioning network</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-ctlplane-ip-range"><span>ctlplane-ip-range</span></a>: Check the number of IP addresses available to overcloud nodes</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-dhcp-introspection"><span>dhcp-introspection</span></a>: DHCP on the Introspection Network</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-undercloud-cpu"><span>undercloud-cpu</span></a>: Verify undercloud fits the CPU core requirements</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-undercloud-disk-space"><span>undercloud-disk-space</span></a>: Verify undercloud fits the disk space requirements</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-undercloud-ram"><span>undercloud-ram</span></a>: Verify the undercloud fits the RAM requirements</li>
<li><a class="reference internal" href="validations-pre-introspection-details.html#pre-introspection-undercloud-tokenflush"><span>undercloud-tokenflush</span></a>: Verify token_flush is enabled in keystone users crontab.</li>
</ul>
</div>
<div class="section" id="pre-deployment">
<h4>Pre Deployment<a class="headerlink" href="#pre-deployment" title="Permalink to this headline">¶</a></h4>
<p>Validation that are run right before deploying the overcloud.</p>
<ul class="simple">
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-512e"><span>512e</span></a>: Advanced Format 512e Support</li>
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-ceilometerdb-size"><span>ceilometerdb-size</span></a>: Ceilometer Database Size Check</li>
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-deployment-images"><span>deployment-images</span></a>: Verify existence of deployment images.</li>
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-dhcp-provisioning"><span>dhcp-provisioning</span></a>: DHCP on the Provisioning Network</li>
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-undercloud-debug"><span>undercloud-debug</span></a>: Undercloud Services Debug Check</li>
<li><a class="reference internal" href="validations-pre-deployment-details.html#pre-deployment-undercloud-process-count"><span>undercloud-process-count</span></a>: Check the number of OpenStack processes on undercloud</li>
</ul>
</div>
<div class="section" id="post-deployment">
<h4>Post Deployment<a class="headerlink" href="#post-deployment" title="Permalink to this headline">¶</a></h4>
<p>Validations that are run after the overcloud deployment finished.</p>
<ul class="simple">
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-controller-ulimits"><span>controller-ulimits</span></a>: Check controller ulimits</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-haproxy"><span>haproxy</span></a>: HAProxy configuration</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-mysql-open-files-limit"><span>mysql-open-files-limit</span></a>: MySQL Open Files Limit</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-no-op-firewall-nova-driver"><span>no-op-firewall-nova-driver</span></a>: Verify NoOpFirewallDriver is set in Nova</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-ntpstat"><span>ntpstat</span></a>: Verify all deployed nodes have their clock synchronised.</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-openstack-endpoints"><span>openstack-endpoints</span></a>: Check connectivity to various OpenStack services</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-pacemaker-status"><span>pacemaker-status</span></a>: Check the status of the pacemaker cluster</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-rabbitmq-limits"><span>rabbitmq-limits</span></a>: Rabbitmq limits</li>
<li><a class="reference internal" href="validations-post-deployment-details.html#post-deployment-stonith-exists"><span>stonith-exists</span></a>: stonith-exists</li>
</ul>
</div>
</div>
<div class="section" id="writing-validations">
<h3>Writing Validations<a class="headerlink" href="#writing-validations" title="Permalink to this headline">¶</a></h3>
<p>All validations are written in standard Ansible with a couple of extra
meta-data to provide information to the Mistral validation framework.</p>
<p>For people not familiar with Ansible, get started with their <a class="reference external" href="http://docs.ansible.com/ansible/">excellent
documentation</a>.</p>
<p>After the generic explanation on writing validations is a couple of concrete
examples.</p>
<div class="section" id="directory-structure">
<h4>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h4>
<p>All validations are located in the <code class="docutils literal"><span class="pre">validations</span></code> directory. It
contains a couple of subdirectories:</p>
<ul class="simple">
<li>the <code class="docutils literal"><span class="pre">files</span></code> directory contains scripts that are directly executable;</li>
<li>the <code class="docutils literal"><span class="pre">library</span></code> one is for custom Ansible modules available to the
validations;</li>
<li><code class="docutils literal"><span class="pre">tasks</span></code> is for common steps that can be shared between the validations.</li>
</ul>
<p>Here is what the tree looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>validations
├── first_validation.yaml
├── second_validation.yaml
├── files
│   └── some_script.sh
├── library
│   ├── another_module.py
│   └── some_module.py
└── tasks
    └── some_task.yaml
</pre></div>
</div>
</div>
<div class="section" id="sample-validation">
<h4>Sample Validation<a class="headerlink" href="#sample-validation" title="Permalink to this headline">¶</a></h4>
<p>Each validation is an Ansible playbook with a known location and some
meta-data. Here is what a minimal validation would look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>---
- hosts: overcloud
  vars:
    metadata:
      name: Hello World
      description: This validation prints Hello World!
  tasks:
  - name: Run an echo command
    command: echo Hello World!
</pre></div>
</div>
<p>It should be saved as <code class="docutils literal"><span class="pre">validations/hello_world.yaml</span></code>.</p>
<p>As shown here, the validation playbook requires three top-level directives:
<code class="docutils literal"><span class="pre">hosts</span></code>, <code class="docutils literal"><span class="pre">vars</span> <span class="pre">-&gt;</span> <span class="pre">metadata</span></code> and <code class="docutils literal"><span class="pre">tasks</span></code>.</p>
<p><code class="docutils literal"><span class="pre">hosts</span></code> specify which nodes to run the validation on. Based on the
<code class="docutils literal"><span class="pre">hosts.sample</span></code> structure, the options can be <code class="docutils literal"><span class="pre">all</span></code> (run on all nodes),
<code class="docutils literal"><span class="pre">undercloud</span></code>, <code class="docutils literal"><span class="pre">overcloud</span></code> (all overcloud nodes), <code class="docutils literal"><span class="pre">controller</span></code> and
<code class="docutils literal"><span class="pre">compute</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">vars</span></code> section serves for storing variables that are going to be
available to the Ansible playbook. The validations API uses the <code class="docutils literal"><span class="pre">metadata</span></code>
section to read each validation&#8217;s name and description. These values are then
reported by the API and shown in the UI.</p>
<p>The validations can be grouped together by specifying a <code class="docutils literal"><span class="pre">groups</span></code> metadata.
Groups function similar to tags and a validation can thus be part of many
groups.  Here is, for example, how to have a validation be part of the
<cite>pre-deployment</cite> and <cite>hardware</cite> groups:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>metadata:
  groups:
    - pre-deployment
    - hardware
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">tasks</span></code> contain a list of Ansible tasks to run. Each task is a YAML
dictionary that must at minimum contain a name and a module to use.
Module can be any module that ships with Ansible or any of the custom
ones in the <code class="docutils literal"><span class="pre">library</span></code> subdirectory.</p>
<p>The <a class="reference external" href="http://docs.ansible.com/ansible/playbooks.html">Ansible documentation on playbooks</a> provides more detailed
information.</p>
</div>
<div class="section" id="ansible-inventory">
<h4>Ansible Inventory<a class="headerlink" href="#ansible-inventory" title="Permalink to this headline">¶</a></h4>
<div class="section" id="dynamic-inventory">
<h5>Dynamic inventory<a class="headerlink" href="#dynamic-inventory" title="Permalink to this headline">¶</a></h5>
<p>Tripleo-validations ships with a <a class="reference external" href="http://docs.ansible.com/ansible/intro_dynamic_inventory.html">dynamic inventory</a>, which
contacts the various OpenStack services to provide the addresses of the
deployed nodes as well as the undercloud.</p>
<p>Just pass <code class="docutils literal"><span class="pre">-i</span> <span class="pre">tripleo-ansible-inventory</span></code> to <code class="docutils literal"><span class="pre">ansible-playbook</span></code> command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible-playbook -i tripleo-ansible-inventory validations/hello_world.yaml
</pre></div>
</div>
</div>
<div class="section" id="hosts-file">
<h5>Hosts file<a class="headerlink" href="#hosts-file" title="Permalink to this headline">¶</a></h5>
<p>When more flexibility than what the current dynamic inventory provides is
needed or when running validations against a host that hasn&#8217;t been deployed via
heat (such as the <code class="docutils literal"><span class="pre">prep</span></code> validations), it is possible to write a custom hosts
inventory file. It should look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[undercloud]
undercloud.example.com

[overcloud:children]
controller
compute

[controller]
controller.example.com

[compute]
compute-1.example.com
compute-2.example.com

[all:vars]
ansible_ssh_user=stack
ansible_sudo=true
</pre></div>
</div>
<p>It will have a <code class="docutils literal"><span class="pre">[group]</span></code> section for each role (<code class="docutils literal"><span class="pre">undercloud</span></code>,
<code class="docutils literal"><span class="pre">controller</span></code>, <code class="docutils literal"><span class="pre">compute</span></code>) listing all the nodes belonging to that group. It
is also possible to create a group from other groups as done with
<code class="docutils literal"><span class="pre">[overcloud:children]</span></code> in the above example. If a validation specifies
<code class="docutils literal"><span class="pre">hosts:</span> <span class="pre">overcloud</span></code>, it will be run on any node that belongs to the
<code class="docutils literal"><span class="pre">compute</span></code> or <code class="docutils literal"><span class="pre">controller</span></code> groups. If a node happens to belong to both, the
validation will only be run once.</p>
<p>Lastly, there is an <code class="docutils literal"><span class="pre">[all:vars]</span></code> section where to configure certain
Ansible-specific options.</p>
<p><code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> will specify the user Ansible should SSH as. If that user
does not have root privileges, it is possible to instruct it to use <code class="docutils literal"><span class="pre">sudo</span></code> by
setting <code class="docutils literal"><span class="pre">ansible_sudo</span></code> to <code class="docutils literal"><span class="pre">true</span></code>.</p>
<p>Learn more at the <a class="reference external" href="http://docs.ansible.com/ansible/intro_inventory.html">Ansible documentation page for the Inventory</a></p>
</div>
</div>
<div class="section" id="custom-modules">
<h4>Custom Modules<a class="headerlink" href="#custom-modules" title="Permalink to this headline">¶</a></h4>
<p>In case the <a class="reference external" href="http://docs.ansible.com/ansible/modules_by_category.html">available Ansible modules</a> don&#8217;t cover your
needs, it is possible to write your own. Modules belong to the
<code class="docutils literal"><span class="pre">validations/library</span></code> directory.</p>
<p>Here is a sample module that will always fail:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleModule</span><span class="p">(</span><span class="n">argument_spec</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;This module always fails.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Save it as <code class="docutils literal"><span class="pre">validations/library/my_module.py</span></code> and use it in a validation like
so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tasks:
...  # some tasks
- name: Running my custom module
  my_module:
...  # some other tasks
</pre></div>
</div>
<p>The name of the module in the validation <code class="docutils literal"><span class="pre">my_module</span></code> must match the file name
(without extension): <code class="docutils literal"><span class="pre">my_module.py</span></code>.</p>
<p>The custom modules can accept parameters and do more complex reporting.  Please
refer to the guide on writing modules in the Ansible documentation.</p>
<p>Learn more at the <a class="reference external" href="http://docs.ansible.com/ansible/developing_modules.html">Ansible documentation page about writing custom modules</a>.</p>
</div>
<div class="section" id="running-a-validation">
<h4>Running a validation<a class="headerlink" href="#running-a-validation" title="Permalink to this headline">¶</a></h4>
<p>Running the validations require ansible and a set of nodes to run them against.
These nodes need to be reachable from the operator&#8217;s machine and need to have
an account it can ssh to and perform passwordless sudo.</p>
<p>The nodes need to be present in the static inventory file or available from the
dynamic inventory script depending on which one the operator choses to use.
Check which nodes are available with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ source stackrc
$ tripleo-ansible-inventory --list
</pre></div>
</div>
<p>In general, Ansible and the validations will be located on the <em>undercloud</em>,
because it should have connectivity to all the <em>overcloud</em> nodes is already set
up to SSH to them.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ source ~/stackrc
$ ansible-playbook -i tripleo-ansible-inventory path/to/validation.yaml
</pre></div>
</div>
</div>
<div class="section" id="example-verify-undercloud-ram-requirements">
<h4>Example: Verify Undercloud RAM requirements<a class="headerlink" href="#example-verify-undercloud-ram-requirements" title="Permalink to this headline">¶</a></h4>
<p>The Undercloud has a requirement of 16GB RAM. Let&#8217;s write a validation
that verifies this is indeed the case before deploying anything.</p>
<p>Let&#8217;s create <code class="docutils literal"><span class="pre">validations/undercloud-ram.yaml</span></code> and put some metadata
in there:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>---
- hosts: undercloud
  vars:
    metadata:
      name: Minimum RAM required on the undercloud
      description: &gt;
        Make sure the undercloud has enough RAM.
      groups:
        - prep
        - pre-introspection
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">hosts</span></code> key will tell which server should the validation run on. The
common values are <code class="docutils literal"><span class="pre">undercloud</span></code>, <code class="docutils literal"><span class="pre">overcloud</span></code> (i.e. all overcloud nodes),
<code class="docutils literal"><span class="pre">controller</span></code> and <code class="docutils literal"><span class="pre">compute</span></code> (i.e. just the controller or the compute nodes).</p>
<p>The <code class="docutils literal"><span class="pre">name</span></code> and <code class="docutils literal"><span class="pre">description</span></code> metadata will show up in the API and the
TripleO UI so make sure to put something meaningful there. The <code class="docutils literal"><span class="pre">groups</span></code>
metadata applies a tag to the validation and allows to group them together in
order to perform group operations, such are running them all in one call.</p>
<p>Now let&#8217;s add an Ansible task to test that it&#8217;s all set up properly. Add
this under the same indentation as <code class="docutils literal"><span class="pre">hosts</span></code> and <code class="docutils literal"><span class="pre">vars</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tasks:
- name: Test Output
  debug: msg=&quot;Hello World!&quot;
</pre></div>
</div>
<p>When running it, it should output something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ ansible-playbook -i tripleo-ansible-inventory validations/undercloud-ram.yaml

PLAY [undercloud] *************************************************************

GATHERING FACTS ***************************************************************
ok: [localhost]

TASK: [Test Output] ***********************************************************
ok: [localhost] =&gt; {
    &quot;msg&quot;: &quot;Hello World!&quot;
}

PLAY RECAP ********************************************************************
localhost                  : ok=2    changed=0    unreachable=0    failed=0
</pre></div>
</div>
<p>Writing the full validation code is quite easy in this case because Ansible has
done all the hard work for us already. We can use the <code class="docutils literal"><span class="pre">ansible_memtotal_mb</span></code>
fact to get the amount of RAM (in megabytes) the tested server currently has.
For other useful values, run <code class="docutils literal"><span class="pre">ansible</span> <span class="pre">-i</span> <span class="pre">tripleo-ansible-inventory</span>
<span class="pre">undercloud</span> <span class="pre">-m</span> <span class="pre">setup</span></code>.</p>
<p>So, let&#8217;s replace the hello world task with a real one:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tasks:
- name: Verify the RAM requirements
  fail: msg=&quot;The RAM on the undercloud node is {{ ansible_memtotal_mb }} MB, the minimal recommended value is 16 GB.&quot;
  failed_when: &quot;({{ ansible_memtotal_mb }}) &lt; 16000&quot;
</pre></div>
</div>
<p>Running this, we see:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>TASK: [Verify the RAM requirements] *******************************************
failed: [localhost] =&gt; {&quot;failed&quot;: true, &quot;failed_when_result&quot;: true}
msg: The RAM on the undercloud node is 8778 MB, the minimal recommended value is 16 GB.
</pre></div>
</div>
<p>Because our Undercloud node really does not have enough RAM. Your mileage may
vary.</p>
<p>Either way, the validation works and reports the lack of RAM properly!</p>
<p><code class="docutils literal"><span class="pre">failed_when</span></code> is the real hero here: it evaluates an Ansible expression (e.g.
does the node have more than 16 GB of RAM) and fails when it&#8217;s evaluated as
true.</p>
<p>The <code class="docutils literal"><span class="pre">fail</span></code> line right above it lets us print a custom error in case of
a failure. If the task succeeds (because we do have enough RAM), nothing will
be printed out.</p>
<p>Now, we&#8217;re almost done, but there are a few things we can do to make this nicer
on everybody.</p>
<p>First, let&#8217;s hoist the minimum RAM requirement into a variable. That way we&#8217;ll
have one place where to change it if we need to and we&#8217;ll be able to test the
validation better as well!</p>
<p>So, let&#8217;s call the variable <code class="docutils literal"><span class="pre">minimum_ram_gb</span></code> and set it to <code class="docutils literal"><span class="pre">16</span></code>. Do this in
the <code class="docutils literal"><span class="pre">vars</span></code> section:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>vars:
  metadata:
    name: ...
    description: ...
    groups: ...
  minimum_ram_gb: 16
</pre></div>
</div>
<p>Make sure it&#8217;s on the same indentation level as <code class="docutils literal"><span class="pre">metadata</span></code>.</p>
<p>Then, update <code class="docutils literal"><span class="pre">failed_when</span></code> like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>failed_when: &quot;({{ ansible_memtotal_mb }}) &lt; {{ minimum_ram_gb|int * 1024 }}&quot;
</pre></div>
</div>
<p>And <code class="docutils literal"><span class="pre">fail</span></code> like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>fail: msg=&quot;The RAM on the undercloud node is {{ ansible_memtotal_mb }} MB, the minimal recommended value is {{ minimum_ram_gb|int * 1024 }} MB.&quot;
</pre></div>
</div>
<p>And re-run it again to be sure it&#8217;s still working.</p>
<p>One benefit of using a variable instead of a hardcoded value is that we can now
change the value without editing the yaml file!</p>
<p>Let&#8217;s do that to test both success and failure cases.</p>
<p>This should succeed but saying the RAM requirement is 1 GB:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible-playbook -i tripleo-ansible-inventory validations/undercloud-ram.yaml -e minimum_ram_gb=1
</pre></div>
</div>
<p>And this should fail by requiring much more RAM than is necessary:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible-playbook -i tripleo-ansible-inventory validations/undercloud-ram.yaml -e minimum_ram_gb=128
</pre></div>
</div>
<p>(the actual values may be different in your configuration &#8211; just make sure one
is low enough and the other too high)</p>
<p>And that&#8217;s it! The validation is now finished and you can start using it in
earnest.</p>
<p>For reference, here&#8217;s the full validation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>---
- hosts: undercloud
  vars:
    metadata:
      name: Minimum RAM required on the undercloud
      description: Make sure the undercloud has enough RAM.
      groups:
        - prep
        - pre-introspection
    minimum_ram_gb: 16
  tasks:
  - name: Verify the RAM requirements
    fail: msg=&quot;The RAM on the undercloud node is {{ ansible_memtotal_mb }} MB, the minimal recommended value is {{ minimum_ram_gb|int * 1024 }} MB.&quot;
    failed_when: &quot;({{ ansible_memtotal_mb }}) &lt; {{ minimum_ram_gb|int * 1024 }}&quot;
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Team and repository tags</a><ul>
<li><a class="reference internal" href="#tripleo-validations">TripleO Validations</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#existing-validations">Existing validations</a><ul>
<li><a class="reference internal" href="#prep">Prep</a></li>
<li><a class="reference internal" href="#pre-introspection">Pre Introspection</a></li>
<li><a class="reference internal" href="#pre-deployment">Pre Deployment</a></li>
<li><a class="reference internal" href="#post-deployment">Post Deployment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-validations">Writing Validations</a><ul>
<li><a class="reference internal" href="#directory-structure">Directory Structure</a></li>
<li><a class="reference internal" href="#sample-validation">Sample Validation</a></li>
<li><a class="reference internal" href="#ansible-inventory">Ansible Inventory</a><ul>
<li><a class="reference internal" href="#dynamic-inventory">Dynamic inventory</a></li>
<li><a class="reference internal" href="#hosts-file">Hosts file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-modules">Custom Modules</a></li>
<li><a class="reference internal" href="#running-a-validation">Running a validation</a></li>
<li><a class="reference internal" href="#example-verify-undercloud-ram-requirements">Example: Verify Undercloud RAM requirements</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="index.html"
                                  title="previous chapter">Welcome to tripleo-validations&#8217;s documentation!</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="installation.html"
                                  title="next chapter">Installation</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/tripleo-validations
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/readme.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="installation.html" title="Installation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Welcome to tripleo-validations’s documentation!"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">tripleo-validations 5.3.1.dev2 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/tripleo-validations");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>