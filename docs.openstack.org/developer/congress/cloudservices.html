<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cloud Services &mdash; congress 5.0.0.0rc2.dev7 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5.0.0.0rc2.dev7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="congress 5.0.0.0rc2.dev7 documentation" href="index.html" />
    <link rel="next" title="Policy" href="policy.html" />
    <link rel="prev" title="Architecture" href="architecture.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cloud-services">
<span id="cloudservices"></span><h1>Cloud Services<a class="headerlink" href="#cloud-services" title="Permalink to this headline">¶</a></h1>
<div class="section" id="congress-works-with-all-services">
<h2>1. Congress Works With All Services<a class="headerlink" href="#congress-works-with-all-services" title="Permalink to this headline">¶</a></h2>
<p>Congress will work with any cloud service, as long as Congress can
represent the service&#8217;s state in <em>table</em> format.  A table is a
collection of rows, where each row is a collection of columns, and
each row-column entry contains a string or a number.</p>
<p>For example, Neutron contains a mapping between IP addresses and the
ports they are assigned to; neutron represents this state as the
following table.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>====================================== ==========
ID                                     IP
====================================== ==========
&quot;66dafde0-a49c-11e3-be40-425861b86ab6&quot; &quot;10.0.0.1&quot;
&quot;66dafde0-a49c-11e3-be40-425861b86ab6&quot; &quot;10.0.0.2&quot;
&quot;73e31d4c-a49c-11e3-be40-425861b86ab6&quot; &quot;10.0.0.3&quot;
====================================== ==========
</pre></div>
</div>
</div>
<div class="section" id="drivers">
<h2>2. Drivers<a class="headerlink" href="#drivers" title="Permalink to this headline">¶</a></h2>
<p>To plug a new service into Congress, you write a small piece of code,
called a <em>driver</em>, that queries the new service (usually through API calls)
and translates the service state into tables of data.  Out of the box
Congress includes drivers for a number of common services (see below).</p>
<p>For example, the driver for Neutron invokes the Neutron API calls that list
networks, ports, security groups, and routers.  The driver translates each of
the JSON objects that the API calls return into tables (where in Python a table
is a list of tuples).  The Neutron driver is implemented here:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">congress</span><span class="o">/</span><span class="n">datasources</span><span class="o">/</span><span class="n">neutronv2_driver</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Once the driver is available, you install it into Congress,
you configure it (such as with an IP address/port/username), and you
write policy that references the tables populated by that driver.</p>
<div class="section" id="driver-installation">
<h3>2.1 Driver installation<a class="headerlink" href="#driver-installation" title="Permalink to this headline">¶</a></h3>
<p>To install a new driver, you must add its location to the Congress
configuration file and restart the server.  Congress has a single
configuration parameter (called <cite>drivers</cite>) that is a list of all the
installed drivers.  To install a new driver, simply add to this list
and restart.</p>
<p>For example, to install the Neutron driver, you add the following to the
list of drivers in the configuration file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">congress</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">neutronv2_driver</span><span class="o">.</span><span class="n">NeutronV2Driver</span>
</pre></div>
</div>
<p>If you have Nova and Neutron installed, you configure Congress as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">drivers</span> <span class="o">=</span> <span class="n">congress</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">neutronv2_driver</span><span class="o">.</span><span class="n">NeutronV2Driver</span><span class="p">,</span><span class="n">congress</span><span class="o">.</span><span class="n">datasources</span><span class="o">.</span><span class="n">nova_driver</span><span class="o">.</span><span class="n">NovaDriver</span>
</pre></div>
</div>
</div>
<div class="section" id="driver-configuration-deprecated-and-writing-policy">
<h3>2.2 Driver configuration (DEPRECATED) and writing policy<a class="headerlink" href="#driver-configuration-deprecated-and-writing-policy" title="Permalink to this headline">¶</a></h3>
<p>Once the driver code is in place, you can use it to create a <cite>datasource</cite> whose
data is available to Congress policies.  To create a datasource, you use the API and
provide a unique name (the name you will use in policy to refer to the service), the
name of the datasource driver you want to use, and additional connection details
needed by your service (such as an IP and a username/password).</p>
<p>For example, using the Congress CLI, you can create a datasource named &#8216;neutron_test&#8217; using the
&#8216;neutronv2&#8217; driver:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ openstack congress datasource create &lt;driver_name&gt; &lt;datasource_name&gt;
   --config username=&lt;username&gt;
   --config password=&lt;password&gt;
   --config tenant_name=&lt;tenant&gt;
   --config auth_url=&lt;url_authentication&gt;

$ openstack congress datasource create neutronv2 neutron_test
  --config username=neutron
  --config password=password
  --config tenant_name=cloudservices
  --config auth_url=http://10.10.10.10:5000/v2.0
</pre></div>
</div>
<p>And if you had a second instance of Neutron running to manage
your production network, you could create a second datasource (named say &#8216;neutron_prod&#8217;)
using the neutronv2 driver so that you could write policy over both instances of Neutron.</p>
<p>When you write policy, you would use the name &#8216;neutron_test:ports&#8217; to reference the &#8216;ports&#8217;
table generated by the &#8216;neutron_test&#8217; datasource, and you use &#8216;neutron_test:networks&#8217; to
reference the &#8216;networks&#8217; table generated by the &#8216;neutron_test&#8217; datasource.  Similarly,
you use &#8216;neutron_prod:ports&#8217; and &#8216;neutron_prod:networks&#8217; to reference the
tables populated by the &#8216;neutron_prod&#8217; datasource.
(More details about writing policy can be found in the
<a class="reference internal" href="policy.html#policy"><span>Policy</span></a> section.)</p>
</div>
</div>
<div class="section" id="currently-supported-drivers">
<h2>3. Currently Supported Drivers<a class="headerlink" href="#currently-supported-drivers" title="Permalink to this headline">¶</a></h2>
<p>Congress currently has drivers for each of the following services.  Each driver
has a differing degree of coverage for the available API calls.</p>
<blockquote>
<div><ul class="simple">
<li>Openstack Aodh</li>
<li>OpenStack Ceilometer</li>
<li>OpenStack Cinder</li>
<li>OpenStack Glance (v2)</li>
<li>OpenStack Heat</li>
<li>OpenStack Ironic</li>
<li>OpenStack Keystone (v2 &amp; v3)</li>
<li>OpenStack Monasca</li>
<li>OpenStack Murano</li>
<li>OpenStack Neutron (v2)</li>
<li>OpenStack Nova</li>
<li>OpenStack Swift</li>
<li>Cloud Foundry</li>
<li>Plexxi</li>
<li>vCenter</li>
<li>OPNFV Doctor</li>
</ul>
</div></blockquote>
<p>Using the API or CLI, you can review the list of tables and columns that a driver supports.
Roughly, you can think of each table as a collection of objects (like networks or servers),
and the columns of that table as the attributes of those objects (like name, status, or ID).
The value of each row-column entry is a (Python) string or number. If
the attribute as returned by the API call is a complex object, that object
is flattened into its own table (or tables).</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ openstack congress datasource schema show nova
+--------------+------------------------------------------------+
| table        | columns                                        |
+--------------+------------------------------------------------+
| flavors      | {&#39;name&#39;: &#39;id&#39;, &#39;description&#39;: &#39;None&#39;},         |
|              | {&#39;name&#39;: &#39;name&#39;, &#39;description&#39;: &#39;None&#39;},       |
|              | {&#39;name&#39;: &#39;vcpus&#39;, &#39;description&#39;: &#39;None&#39;},      |
|              | {&#39;name&#39;: &#39;ram&#39;, &#39;description&#39;: &#39;None&#39;},        |
|              | {&#39;name&#39;: &#39;disk&#39;, &#39;description&#39;: &#39;None&#39;},       |
|              | {&#39;name&#39;: &#39;ephemeral&#39;, &#39;description&#39;: &#39;None&#39;},  |
|              | {&#39;name&#39;: &#39;rxtx_factor&#39;, &#39;description&#39;: &#39;None&#39;} |
|              |                                                |
| hosts        | {&#39;name&#39;: &#39;host_name&#39;, &#39;description&#39;: &#39;None&#39;},  |
|              | {&#39;name&#39;: &#39;service&#39;, &#39;description&#39;: &#39;None&#39;},    |
|              | {&#39;name&#39;: &#39;zone&#39;, &#39;description&#39;: &#39;None&#39;}        |
|              |                                                |
| floating_IPs | {&#39;name&#39;: &#39;fixed_ip&#39;, &#39;description&#39;: &#39;None&#39;},   |
|              | {&#39;name&#39;: &#39;id&#39;, &#39;description&#39;: &#39;None&#39;},         |
|              | {&#39;name&#39;: &#39;ip&#39;, &#39;description&#39;: &#39;None&#39;},         |
|              | {&#39;name&#39;: &#39;host_id&#39;, &#39;description&#39;: &#39;None&#39;},    |
|              | {&#39;name&#39;: &#39;pool&#39;, &#39;description&#39;: &#39;None&#39;}        |
|              |                                                |
| servers      | {&#39;name&#39;: &#39;id&#39;, &#39;description&#39;: &#39;None&#39;},         |
|              | {&#39;name&#39;: &#39;name&#39;, &#39;description&#39;: &#39;None&#39;},       |
|              | {&#39;name&#39;: &#39;host_id&#39;, &#39;description&#39;: &#39;None&#39;},    |
|              | {&#39;name&#39;: &#39;status&#39;, &#39;description&#39;: &#39;None&#39;},     |
|              | {&#39;name&#39;: &#39;tenant_id&#39;, &#39;description&#39;: &#39;None&#39;},  |
|              | {&#39;name&#39;: &#39;user_id&#39;, &#39;description&#39;: &#39;None&#39;},    |
|              | {&#39;name&#39;: &#39;image_id&#39;, &#39;description&#39;: &#39;None&#39;},   |
|              | {&#39;name&#39;: &#39;flavor_id&#39;, &#39;description&#39;: &#39;None&#39;}   |
|              |                                                |
+--------------+------------------------------------------------+
</pre></div>
</div>
</div>
<div class="section" id="writing-a-datasource-driver">
<span id="datasource-driver"></span><h2>4. Writing a Datasource Driver<a class="headerlink" href="#writing-a-datasource-driver" title="Permalink to this headline">¶</a></h2>
<p>This section is a tutorial for those of you interested in writing your own
datasource driver.  It can be safely skipped otherwise.</p>
<div class="section" id="implementing-a-datasource-driver">
<h3>4.1 Implementing a Datasource Driver<a class="headerlink" href="#implementing-a-datasource-driver" title="Permalink to this headline">¶</a></h3>
<p>All the Datasource drivers extend the code found in:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">congress</span><span class="o">/</span><span class="n">datasources</span><span class="o">/</span><span class="n">datasource_driver</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Typically, you will create a subclass of
<code class="docutils literal"><span class="pre">datasource_driver.PollingDataSourceDriver</span></code> or
<code class="docutils literal"><span class="pre">datasource_driver.PushedDataSourceDriver</span></code> depending on the type of your
datasource driver. Each instance of that class will correspond to a different
service using that driver.</p>
<p>The following steps detail how to implement a polling datasource driver.</p>
<ol class="arabic simple">
<li>Create a new Python module <code class="docutils literal"><span class="pre">congress/datasources/new_driver.py</span></code></li>
<li>Create a subclass of :code: <code class="docutils literal"><span class="pre">PollingDataSourceDriver</span></code>.</li>
</ol>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">from</span> <span class="pre">congress.datasources.datasource_driver</span> <span class="pre">import</span> <span class="pre">PollingDataSourceDriver</span></code></p>
<p><code class="docutils literal"><span class="pre">class</span> <span class="pre">MyDriver(PollingDataSourceDriver)</span></code></p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Implement the constructor <code class="xref py py-func docutils literal"><span class="pre">MyDriver.__init__()</span></code></li>
</ol>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">def</span> <span class="pre">__init__(name,</span> <span class="pre">args)</span></code></p>
<p>You must call the DataSourceDriver&#8217;s constructor.</p>
<p><code class="docutils literal"><span class="pre">super(MyDriver,</span> <span class="pre">self).__init__(name,</span> <span class="pre">args)</span></code></p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li>Implement the function <code class="xref py py-func docutils literal"><span class="pre">MyDriver.update_from_datasource()</span></code></li>
</ol>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">def</span> <span class="pre">update_from_datasource(self)</span></code></p>
<p>This function is called to update <code class="docutils literal"><span class="pre">self.state</span></code> to reflect the new
state of the service.  <code class="docutils literal"><span class="pre">self.state</span></code> is a dictionary that maps a
tablename (as a string) to a set of tuples (to a collection of tables).
Each tuple element must be either a number or string.  This function
implements the polling logic for the service.</p>
</div></blockquote>
<p>5. By convention, it is useful for debugging purposes to include a
<code class="docutils literal"><span class="pre">main</span></code> that calls update_from_datasource, and prints out the raw
API results along with the tables that were generated.</p>
<p>To install and test the newly written driver, please follow the new driver
installation procedure mentioned in :ref: <cite>Driver installation &lt;driver-installation&gt;</cite>
section.</p>
</div>
<div class="section" id="converting-api-results-into-tables">
<h3>4.2 Converting API results into Tables<a class="headerlink" href="#converting-api-results-into-tables" title="Permalink to this headline">¶</a></h3>
<p>Since Congress requires the state of each dataservice to be represented as
tables, we must convert the results of each API call (which may be comprised
of dictionaries, lists, dictionaries embedded within lists, etc.) into tables.</p>
<div class="section" id="convenience-translators">
<h4>4.2.1 Convenience translators<a class="headerlink" href="#convenience-translators" title="Permalink to this headline">¶</a></h4>
<p>Congress provides a translation method to make the translation from API
results into tables convenient.  The translation method takes a description of
the API data structure, and converts objects of that structure into rows of
one or more tables (depending on the data structure).  For example, this is a
partial snippet from the Neutron driver:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">networks_translator</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;translation-type&#39;</span><span class="p">:</span> <span class="s1">&#39;HDICT&#39;</span><span class="p">,</span>
    <span class="s1">&#39;table-name&#39;</span><span class="p">:</span> <span class="s1">&#39;networks&#39;</span><span class="p">,</span>
    <span class="s1">&#39;selector-type&#39;</span><span class="p">:</span> <span class="s1">&#39;DICT_SELECTOR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field-translators&#39;</span><span class="p">:</span>
        <span class="p">({</span><span class="s1">&#39;fieldname&#39;</span><span class="p">:</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">:</span> <span class="n">value_trans</span><span class="p">},</span>
         <span class="p">{</span><span class="s1">&#39;fieldname&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">:</span> <span class="n">value_trans</span><span class="p">},</span>
         <span class="p">{</span><span class="s1">&#39;fieldname&#39;</span><span class="p">:</span> <span class="s1">&#39;tenant_id&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">:</span> <span class="n">value_trans</span><span class="p">},</span>
         <span class="p">{</span><span class="s1">&#39;fieldname&#39;</span><span class="p">:</span> <span class="s1">&#39;subnets&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">:</span> <span class="s1">&#39;subnet_group_id&#39;</span><span class="p">,</span>
          <span class="s1">&#39;translator&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;translation-type&#39;</span><span class="p">:</span> <span class="s1">&#39;LIST&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;table-name&#39;</span><span class="p">:</span> <span class="s1">&#39;networks.subnets&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;id-col&#39;</span><span class="p">:</span> <span class="s1">&#39;subnet_group_id&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;val-col&#39;</span><span class="p">:</span> <span class="s1">&#39;subnet&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;translator&#39;</span><span class="p">:</span> <span class="n">value_trans</span><span class="p">}})}</span>
</pre></div>
</div>
<p>This networks_translator describes a python dictionary data structure that
contains four keys: id, name, tenant_id, and subnets.  The value for the
subnets key is a list of subnet_group_ids each of which is a number.  For
example:</p>
<blockquote>
<div><dl class="docutils">
<dt>{ &#8220;id&#8221;: 1234,</dt>
<dd>&#8220;name&#8221;: &#8220;Network Foo&#8221;,
&#8220;tenant_id&#8221;: 5678,
&#8220;subnets&#8221;: [ 100, 101 ] }</dd>
</dl>
</div></blockquote>
<p>Given the networks_translator description, the translator creates two tables.
The first table is named &#8220;networks&#8221; with a column for name, subnets,
tenant_id, and id.  The second table will be named &#8220;networks.subnet&#8221; and will
contain two columns, one containing the subnet_group_id, and the second
containing an ID that associates the row in the network to the rows in the
networks.subnets table.</p>
<p>To use the translation methods, the driver defines a translator such as
networks_translator and then passes the API response objects to
translate_objs() which is defined in congress/datasources/datasource_driver.py
See congress/datasources/neutron_driver.py as an example.</p>
</div>
<div class="section" id="custom-data-conversion">
<h4>4.2.2 Custom data conversion<a class="headerlink" href="#custom-data-conversion" title="Permalink to this headline">¶</a></h4>
<p>The convenience translators may be insufficient in some cases, for example,
the data source may provide data in an unusual format, the convenience
translators may be inefficient, or the fixed translation method may result in
an unsuitable table schema.  In such cases, a driver may need to implement its
own translation.  In those cases, we have a few recommendations.</p>
<p><strong>Recommendation 1: Row = object.</strong> Typically an API call will return a
collection of objects (e.g. networks, virtual machines, disks).  Conceptually
it is convenient to represent each object with a row in a table.  The columns
of that row are the attributes of each object.  For example, a table of all
virtual machines will have columns for memory, disk, flavor, and image.</p>
<p>Table: virtual_machine</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="7%" />
<col width="4%" />
<col width="7%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ID</th>
<th class="head">Memory</th>
<th class="head">Disk</th>
<th class="head">Flavor</th>
<th class="head">Image</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>66dafde0-a49c-11e3-be40-425861b86ab6</td>
<td>256GB</td>
<td>1TB</td>
<td>1</td>
<td>83e31d4c-a49c-11e3-be40-425861b86ab6</td>
</tr>
<tr class="row-odd"><td>73e31d4c-a49c-11e3-be40-425861b86ab6</td>
<td>10GB</td>
<td>2TB</td>
<td>2</td>
<td>93e31d4c-a49c-11e3-be40-425861b86ab6</td>
</tr>
</tbody>
</table>
<p><strong>Recommendation 2. Avoid wide tables.</strong>  Wide tables (i.e. tables with many
columns) are hard to use for a policy-writer.  Breaking such tables up into
smaller ones is often a good idea.  In the above example, we could create 4
tables with 2 columns instead of 1 table with 5 columns.</p>
<p>Table: virtual_machine.memory</p>
<table border="1" class="docutils">
<colgroup>
<col width="86%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ID</th>
<th class="head">Memory</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>66dafde0-a49c-11e3-be40-425861b86ab6</td>
<td>256GB</td>
</tr>
<tr class="row-odd"><td>73e31d4c-a49c-11e3-be40-425861b86ab6</td>
<td>10GB</td>
</tr>
</tbody>
</table>
<p>Table: virtual_machine.disk</p>
<table border="1" class="docutils">
<colgroup>
<col width="86%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ID</th>
<th class="head">Disk</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>66dafde0-a49c-11e3-be40-425861b86ab6</td>
<td>1TB</td>
</tr>
<tr class="row-odd"><td>73e31d4c-a49c-11e3-be40-425861b86ab6</td>
<td>2TB</td>
</tr>
</tbody>
</table>
<p>Table: virtual_machine.flavor</p>
<table border="1" class="docutils">
<colgroup>
<col width="86%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ID</th>
<th class="head">Flavor</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>66dafde0-a49c-11e3-be40-425861b86ab6</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>73e31d4c-a49c-11e3-be40-425861b86ab6</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Table: virtual_machine.image</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ID</th>
<th class="head">Image</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>66dafde0-a49c-11e3-be40-425861b86ab6</td>
<td>83e31d4c-a49c-11e3-be40-425861b86ab6</td>
</tr>
<tr class="row-odd"><td>73e31d4c-a49c-11e3-be40-425861b86ab6</td>
<td>93e31d4c-a49c-11e3-be40-425861b86ab6</td>
</tr>
</tbody>
</table>
<p><strong>Recommendation 3. Try these design patterns.</strong> Below we give a few design
patterns.  Notice that when an object has an attribute whose value is a
structured object itself (e.g. a list of dictionaries), we must recursively
flatten that subobject into tables.</p>
<ul>
<li><p class="first">A List of dictionary converted to tuples</p>
<blockquote>
<div><p>Original data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:</span><span class="s1">&#39;value2&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value3&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:</span><span class="s1">&#39;value4&#39;</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;value3&#39;</span><span class="p">,</span> <span class="s1">&#39;value4&#39;</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">List of Dictionary with a nested List</p>
<blockquote>
<div><p>Original data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:[</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span><span class="s1">&#39;v2&#39;</span><span class="p">]},</span>
 <span class="p">{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value2&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:[</span><span class="s1">&#39;v3&#39;</span><span class="p">,</span><span class="s1">&#39;v4&#39;</span><span class="p">]}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid1&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid2&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid3&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid4&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="p">[(</span><span class="s1">&#39;uuid1&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;uuid2&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;uuid3&#39;</span><span class="p">,</span> <span class="s1">&#39;v3&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;uuid4&#39;</span><span class="p">,</span> <span class="s1">&#39;v4&#39;</span><span class="p">)</span>
<span class="p">]</span>
</pre></div>
</div>
<p><em>Note</em> : uuid* are congress generated uuids</p>
</div></blockquote>
</li>
<li><p class="first">List of Dictionary with a nested dictionary</p>
<blockquote>
<div><p>Original data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:{</span><span class="s1">&#39;k1&#39;</span><span class="p">:</span><span class="s1">&#39;v1&#39;</span><span class="p">}},</span>
 <span class="p">{</span><span class="s1">&#39;key1&#39;</span><span class="p">:</span><span class="s1">&#39;value2&#39;</span><span class="p">,</span><span class="s1">&#39;key2&#39;</span><span class="p">:{</span><span class="s1">&#39;k1&#39;</span><span class="p">:</span><span class="s1">&#39;v2&#39;</span><span class="p">}}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid1&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">,</span> <span class="s1">&#39;uuid2&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="p">[(</span><span class="s1">&#39;uuid1&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;uuid2&#39;</span><span class="p">,</span> <span class="s1">&#39;k1&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p><em>Note</em> : uuid* are congress generated uuids</p>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="writing-a-datasource-driver-test">
<h3>4.3 Writing a Datasource driver test<a class="headerlink" href="#writing-a-datasource-driver-test" title="Permalink to this headline">¶</a></h3>
<p>Once you&#8217;ve written a driver, you&#8217;ll want to add a unit test for it.  To help, this section describes how the unit test for the Glance driver works.  Here are the relevant files.</p>
<ul class="simple">
<li>Driver code: congress/datasources/glance_v2driver.py</li>
<li>Test code: congress/tests/datasources/test_glancev2_driver.py  (appearing in full at the end of this section)</li>
</ul>
<p>The test code has two methods: setUp() and test_update_from_datasource().</p>
<div class="section" id="glance-setup">
<h4>4.3.1 Glance setup<a class="headerlink" href="#glance-setup" title="Permalink to this headline">¶</a></h4>
<p>We begin our description with the setUp() method of the test.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
</div>
<p>First the test creates a fake (actually a mock) Keystone.  Most clients talk to Keystone, so having a fake one seems to be necessary to make the Glance client work properly.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">keystone_client_p</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
    <span class="s2">&quot;keystoneclient.v2_0.client.Client&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">keystone_client_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Next the test creates a fake Glance client.  Glance is an OpenStack service that stores (among other things) operating system Images that you can use to create a new VM.    The Glance datasource driver makes a call to &lt;glance-client&gt;.images.list() to retrieve the list of those images, and then turns that list of images into tables.  The test creates a fake Glance client so it can control the return value of &lt;glance-client&gt;.images.list().</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">glance_client_p</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;glanceclient.v2.client.Client&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">glance_client_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>Next the test instantiates the GlanceV2Driver class, which contains the code for the Glance driver.  Passing &#8216;poll_time&#8217; as 0 is probably unnecessary here, but it tells the driver not to poll automatically.  Passing &#8216;client&#8217; is important because it tells the GlanceV2Driver class to use a mocked version of the Glance client instead of creating its own.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">datasource_openstack_args</span><span class="p">()</span>
<span class="n">args</span><span class="p">[</span><span class="s1">&#39;poll_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">args</span><span class="p">[</span><span class="s1">&#39;client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">glancev2_driver</span><span class="o">.</span><span class="n">GlanceV2Driver</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Next the test defines which value it wants &lt;glance-client&gt;.images.list() to return.  The test itself will check if the Glance driver code properly translates this return value into tables.  So this is the actual input to the test.   Either you can write this by hand, or you can run the heat-client and print out the results.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">mock_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;9e486c3bf76219a6a37add392e425b36&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;container_format&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;bare&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:08Z’,</span>
     <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="glance-test">
<h4>4.3.2 Glance test<a class="headerlink" href="#glance-test" title="Permalink to this headline">¶</a></h4>
<p>test_update_from_datasource() is the actual test, where we have the datasource driver grab the list of Glance images and translate them to tables.  The test runs the update_from_datasource() method like normal except it ensures the return value of &lt;glance-client&gt;.images.list() is self.mock_images.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_update_from_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
</div>
<p>The first thing the method does is set the return value of self.driver.glance.images.list() to self.mock_images[‘images’].  Then it calls update_from_datasource() in the usual way, which translates self.mock_images[&#8216;images&#8217;] into tables and stores the result into the driver&#8217;s self.state dictionary.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">glance</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">img_list</span><span class="p">:</span>
    <span class="n">img_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mock_images</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">update_from_datasource</span><span class="p">()</span>
</pre></div>
</div>
<p>Next the test defines the tables that update_from_datasource() should construct.  Actually, the test defines the expected value of Glance’s self.state when update_from_datasource() finishes.  Remember that self.state is a dictionary mapping a table name to the set of tuples that belong to the table.  For Glance, there’s just one table: ‘images’, and so the expected self.state is a dictionary with one key ‘images’ and one value: a set of tuples.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span>
    <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;6934941f-3eef-43f7-9198-9b3c188e4aab&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;cirros-0.3.2-x86_64-uec&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:06Z&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:07Z&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;4dfdcf14a20940799d89c7a5e7345978&#39;</span><span class="p">,</span>
     <span class="s1">&#39;False&#39;</span><span class="p">,</span>
     <span class="mi">0</span><span class="p">,</span>
     <span class="mi">0</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;4eada48c2843d2a262c814ddc92ecf2c&#39;</span><span class="p">,</span>
     <span class="mi">25165824</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;/v2/images/6934941f-3eef-43f7-9198-9b3c188e4aab/file&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;15ed89b8-588d-47ad-8ee0-207ed8010569&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;c244d5c7-1c83-414c-a90d-af7cea1dd3b5&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;/v2/schemas/image&#39;</span><span class="p">,</span>
     <span class="sa">u</span><span class="s1">&#39;public&#39;</span><span class="p">),</span>
     <span class="o">...</span>
</pre></div>
</div>
<p>At this point in the test, update_from_datasource() has already been run, so all it does is check that the driver&#8217;s self.state has the expected value.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="glance-test-code-in-full">
<h4>4.3.3 Glance test code in full<a class="headerlink" href="#glance-test-code-in-full" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mock</span>

<span class="kn">from</span> <span class="nn">congress.datasources</span> <span class="kn">import</span> <span class="n">glancev2_driver</span>
<span class="kn">from</span> <span class="nn">congress.tests</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">congress.tests</span> <span class="kn">import</span> <span class="n">helper</span>


<span class="k">class</span> <span class="nc">TestGlanceV2Driver</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestGlanceV2Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client_p</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
            <span class="s2">&quot;keystoneclient.v2_0.client.Client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keystone_client_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glance_client_p</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;glanceclient.v2.client.Client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glance_client_p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">datasource_openstack_args</span><span class="p">()</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;poll_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;client&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">glancev2_driver</span><span class="o">.</span><span class="n">GlanceV2Driver</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mock_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;9e486c3bf76219a6a37add392e425b36&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;container_format&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;bare&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:08Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;disk_format&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;qcow2&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/v2/images/c42736e7-8b09-4906-abd2-d6dc8673c297/file&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;c42736e7-8b09-4906-abd2-d6dc8673c297&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;min_disk&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;min_ram&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;Fedora-x86_64-20-20140618-sda&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;4dfdcf14a20940799d89c7a5e7345978&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;protected&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/v2/schemas/image&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">209649664</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;type=xen2&#39;</span><span class="p">,</span> <span class="s1">&#39;type=xen&#39;</span><span class="p">],</span>
             <span class="sa">u</span><span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:09Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;visibility&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;public&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="sa">u</span><span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;4eada48c2843d2a262c814ddc92ecf2c&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;container_format&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:06Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;disk_format&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/v2/images/6934941f-3eef-43f7-9198-9b3c188e4aab/file&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;6934941f-3eef-43f7-9198-9b3c188e4aab&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;kernel_id&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;15ed89b8-588d-47ad-8ee0-207ed8010569&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;min_disk&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;min_ram&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;cirros-0.3.2-x86_64-uec&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;4dfdcf14a20940799d89c7a5e7345978&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;protected&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;ramdisk_id&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;c244d5c7-1c83-414c-a90d-af7cea1dd3b5&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;schema&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/v2/schemas/image&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">25165824</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[],</span>
             <span class="sa">u</span><span class="s1">&#39;updated_at&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:07Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;visibility&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;public&#39;</span><span class="p">}]}</span>

    <span class="k">def</span> <span class="nf">test_update_from_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">glance</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">img_list</span><span class="p">:</span>
            <span class="n">img_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mock_images</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">update_from_datasource</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;images&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span>
            <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;6934941f-3eef-43f7-9198-9b3c188e4aab&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;cirros-0.3.2-x86_64-uec&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:06Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:07Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;ami&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;4dfdcf14a20940799d89c7a5e7345978&#39;</span><span class="p">,</span>
             <span class="s1">&#39;False&#39;</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;4eada48c2843d2a262c814ddc92ecf2c&#39;</span><span class="p">,</span>
             <span class="mi">25165824</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;/v2/images/6934941f-3eef-43f7-9198-9b3c188e4aab/file&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;15ed89b8-588d-47ad-8ee0-207ed8010569&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;c244d5c7-1c83-414c-a90d-af7cea1dd3b5&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;/v2/schemas/image&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;public&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;c42736e7-8b09-4906-abd2-d6dc8673c297&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;Fedora-x86_64-20-20140618-sda&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;bare&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:08Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;2014-10-01T20:28:09Z&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;qcow2&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;4dfdcf14a20940799d89c7a5e7345978&#39;</span><span class="p">,</span>
             <span class="s1">&#39;False&#39;</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="mi">0</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;9e486c3bf76219a6a37add392e425b36&#39;</span><span class="p">,</span>
             <span class="mi">209649664</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;/v2/images/c42736e7-8b09-4906-abd2-d6dc8673c297/file&#39;</span><span class="p">,</span>
             <span class="s1">&#39;None&#39;</span><span class="p">,</span>
             <span class="s1">&#39;None&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;/v2/schemas/image&#39;</span><span class="p">,</span>
             <span class="sa">u</span><span class="s1">&#39;public&#39;</span><span class="p">)]),</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span>
                <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;c42736e7-8b09-4906-abd2-d6dc8673c297&#39;</span><span class="p">,</span> <span class="s1">&#39;type=xen&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;c42736e7-8b09-4906-abd2-d6dc8673c297&#39;</span><span class="p">,</span> <span class="s1">&#39;type=xen2&#39;</span><span class="p">)])}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Cloud Services</a><ul>
<li><a class="reference internal" href="#congress-works-with-all-services">1. Congress Works With All Services</a></li>
<li><a class="reference internal" href="#drivers">2. Drivers</a><ul>
<li><a class="reference internal" href="#driver-installation">2.1 Driver installation</a></li>
<li><a class="reference internal" href="#driver-configuration-deprecated-and-writing-policy">2.2 Driver configuration (DEPRECATED) and writing policy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#currently-supported-drivers">3. Currently Supported Drivers</a></li>
<li><a class="reference internal" href="#writing-a-datasource-driver">4. Writing a Datasource Driver</a><ul>
<li><a class="reference internal" href="#implementing-a-datasource-driver">4.1 Implementing a Datasource Driver</a></li>
<li><a class="reference internal" href="#converting-api-results-into-tables">4.2 Converting API results into Tables</a><ul>
<li><a class="reference internal" href="#convenience-translators">4.2.1 Convenience translators</a></li>
<li><a class="reference internal" href="#custom-data-conversion">4.2.2 Custom data conversion</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-a-datasource-driver-test">4.3 Writing a Datasource driver test</a><ul>
<li><a class="reference internal" href="#glance-setup">4.3.1 Glance setup</a></li>
<li><a class="reference internal" href="#glance-test">4.3.2 Glance test</a></li>
<li><a class="reference internal" href="#glance-test-code-in-full">4.3.3 Glance test code in full</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="architecture.html"
                                  title="previous chapter">Architecture</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="policy.html"
                                  title="next chapter">Policy</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/congress
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/cloudservices.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="policy.html" title="Policy"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="architecture.html" title="Architecture"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">congress 5.0.0.0rc2.dev7 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2013, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/congress");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>