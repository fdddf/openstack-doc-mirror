<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Scaling your environment</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="../../_static/css/bootstrap.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="../../_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="../../_static/css/font-awesome.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="../../_static/css/combined.css" rel="stylesheet">
<link href="../../_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="../../_static/sphinxmark.css" type="text/css" />
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/security/">Security</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/telecoms-and-nfv/">Telecoms and NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers & ISVs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/coa/">Get Certified</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//ask.openstack.org">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/analysts/">Analyst Reports</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
      <h2>Scaling your environment</h2>
    
  </div>
  <div class="docs-actions">
    
    <a href="backups.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Backups"></i></a>
    
    
    <a href="ansible-modules.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Running ad-hoc Ansible plays"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2017-02-14 17:57</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="../../index.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Scaling your environment</a><ul>
<li><a class="reference internal" href="#add-a-new-infrastructure-host">Add a new infrastructure host</a></li>
<li><a class="reference internal" href="#test-new-infra-nodes">Test new infra nodes</a></li>
<li><a class="reference internal" href="#add-a-compute-host">Add a compute host</a></li>
<li><a class="reference internal" href="#test-new-compute-nodes">Test new compute nodes</a></li>
<li><a class="reference internal" href="#remove-a-compute-host">Remove a compute host</a></li>
<li><a class="reference internal" href="#recover-a-compute-host-failure">Recover a compute host failure</a></li>
<li><a class="reference internal" href="#replacing-failed-hardware">Replacing failed hardware</a><ul>
<li><a class="reference internal" href="#shutting-down-the-compute-host">Shutting down the Compute host</a></li>
<li><a class="reference internal" href="#shutting-down-the-block-storage-host">Shutting down the Block Storage host</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="scaling-your-environment">
<h1>Scaling your environment<a class="headerlink" href="#scaling-your-environment" title="Permalink to this headline">¶</a></h1>
<p>This is a draft environment scaling page for the proposed OpenStack-Ansible
operations guide.</p>
<div class="section" id="add-a-new-infrastructure-host">
<h2>Add a new infrastructure host<a class="headerlink" href="#add-a-new-infrastructure-host" title="Permalink to this headline">¶</a></h2>
<p>While three infrastructure hosts are recommended, if further hosts are
needed in an environment, it is possible to create additional nodes.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure you back up your current OpenStack environment
before adding any new nodes. See <span class="xref std std-ref">backing-up</span> for more
information.</p>
</div>
<ol class="arabic">
<li><p class="first">Add the node to the <code class="docutils literal"><span class="pre">infra_hosts</span></code> stanza of the
<code class="docutils literal"><span class="pre">/etc/openstack_deploy/openstack_user_config.yml</span></code></p>
<div class="code console highlight-python"><div class="highlight"><pre><span></span>infra_hosts:
[...]
NEW_infra&lt;node-ID&gt;:
  ip: 10.17.136.32
NEW_infra&lt;node-ID&gt;:
  ip: 10.17.136.33
</pre></div>
</div>
</li>
<li><p class="first">Change to playbook folder on the deployment host.</p>
<div class="code console highlight-python"><div class="highlight"><pre><span></span><span class="c1"># cd /opt/openstack-ansible/playbooks</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the inventory to add new hosts. Make sure new rsyslog
container names are updated. Send the updated results to <code class="docutils literal"><span class="pre">dev/null</span></code>.</p>
<div class="code console highlight-python"><div class="highlight"><pre><span></span><span class="c1"># /opt/openstack-ansible/playbooks/inventory/dynamic_inventory.py &gt; /dev/null</span>
</pre></div>
</div>
</li>
<li><p class="first">Create the <code class="docutils literal"><span class="pre">/root/add_host.limit</span></code> file, which contains all new node
host names. Replace <code class="docutils literal"><span class="pre">&lt;NEW</span> <span class="pre">INFRA</span> <span class="pre">NODE&gt;</span></code> with the name of the new host.</p>
<div class="code console highlight-python"><div class="highlight"><pre><span></span># /opt/openstack-ansible/scripts/inventory-manage.py  \
  -l |awk &#39;/&lt;NEW INFRA NODE&gt;/ {print $2}&#39; |sort -u | tee /root/add_host.limit
#/opt/openstack-ansible/scripts/inventory-manage.py  \
  -l | grep &#39;horizon&#39; | head -1 | awk &#39;{print $2}&#39; &gt;&gt; /root/add_host.limit
</pre></div>
</div>
</li>
<li><p class="first">Run the <code class="docutils literal"><span class="pre">setup-everything.yml</span></code> playbook with the
<code class="docutils literal"><span class="pre">limit</span></code> argument.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do not run the <code class="docutils literal"><span class="pre">setup-everything.yml</span></code> playbook
without the <code class="docutils literal"><span class="pre">--limit</span></code> argument. Without <code class="docutils literal"><span class="pre">--limit</span></code>, the
playbook will restart all containers inside your environment.</p>
</div>
<div class="code console highlight-python"><div class="highlight"><pre><span></span><span class="c1"># openstack-ansible setup-everything.yml --limit @/root/add_host.limit</span>
<span class="c1"># openstack-ansible --tags=openstack-host-hostfile setup-hosts.yml</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="test-new-infra-nodes">
<h2>Test new infra nodes<a class="headerlink" href="#test-new-infra-nodes" title="Permalink to this headline">¶</a></h2>
<p>After creating a new infra node, test that the node runs correctly by
launching a new instance. Ensure that the new node can respond to
a networking connection test through the <strong class="command">ping</strong> command.
Log in to your monitoring system, and verify that the monitors
return a green signal for the new node.</p>
</div>
<div class="section" id="add-a-compute-host">
<span id="add-compute-host"></span><h2>Add a compute host<a class="headerlink" href="#add-a-compute-host" title="Permalink to this headline">¶</a></h2>
<p>Use the following procedure to add a compute host to an operational
cluster.</p>
<ol class="arabic">
<li><p class="first">Configure the host as a target host. See <a class="reference external" href="http://docs.openstack.org/project-deploy-guide/openstack-ansible/newton/targethosts.html">Prepare target hosts</a>
for more information.</p>
</li>
<li><p class="first">Edit the <code class="docutils literal"><span class="pre">/etc/openstack_deploy/openstack_user_config.yml</span></code> file and
add the host to the <code class="docutils literal"><span class="pre">compute_hosts</span></code> stanza.</p>
<p>If necessary, also modify the <code class="docutils literal"><span class="pre">used_ips</span></code> stanza.</p>
</li>
<li><p class="first">If the cluster is utilizing Telemetry/Metering (ceilometer),
edit the <code class="docutils literal"><span class="pre">/etc/openstack_deploy/conf.d/ceilometer.yml</span></code> file and add the
host to the <code class="docutils literal"><span class="pre">metering-compute_hosts</span></code> stanza.</p>
</li>
<li><p class="first">Run the following commands to add the host. Replace
<code class="docutils literal"><span class="pre">NEW_HOST_NAME</span></code> with the name of the new host.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/openstack-ansible/playbooks
<span class="gp">#</span> openstack-ansible setup-hosts.yml --limit NEW_HOST_NAME
<span class="gp">#</span> openstack-ansible setup-openstack.yml --skip-tags nova-key-distribute --limit NEW_HOST_NAME
<span class="gp">#</span> openstack-ansible setup-openstack.yml --tags nova-key --limit compute_hosts
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="test-new-compute-nodes">
<h2>Test new compute nodes<a class="headerlink" href="#test-new-compute-nodes" title="Permalink to this headline">¶</a></h2>
<p>After creating a new node, test that the node runs correctly by
launching an instance on the new node.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack server create --image IMAGE --flavor m1.tiny <span class="se">\</span>
--key-name KEY --availability-zone ZONE:HOST:NODE <span class="se">\</span>
--nic net-id<span class="o">=</span>UUID SERVER
</pre></div>
</div>
<p>Ensure that the new instance can respond to a networking connection
test through the <strong class="command">ping</strong> command. Log in to your monitoring
system, and verify that the monitors return a green signal for the
new node.</p>
</div>
<div class="section" id="remove-a-compute-host">
<h2>Remove a compute host<a class="headerlink" href="#remove-a-compute-host" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://git.openstack.org/cgit/openstack/openstack-ansible-ops">openstack-ansible-ops</a>
repository contains a playbook for removing a compute host from an
OpenStack-Ansible environment.
To remove a compute host, follow the below procedure.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This guide describes how to remove a compute node from an OpenStack-Ansible
environment completely. Perform these steps with caution, as the compute node will no
longer be in service after the steps have been completed. This guide assumes
that all data and instances have been properly migrated.</p>
</div>
<ol class="arabic">
<li><p class="first">Disable all OpenStack services running on the compute node.
This can include, but is not limited to, the <code class="docutils literal"><span class="pre">nova-compute</span></code> service
and the neutron agent service.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ensure this step is performed first</p>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> Run these commands on the compute node to be removed
<span class="gp">#</span> stop nova-compute
<span class="gp">#</span> stop neutron-linuxbridge-agent
</pre></div>
</div>
</li>
<li><p class="first">Clone the <code class="docutils literal"><span class="pre">openstack-ansible-ops</span></code> repository to your deployment host:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone https://git.openstack.org/openstack/openstack-ansible-ops <span class="se">\</span>
  /opt/openstack-ansible-ops
</pre></div>
</div>
</li>
<li><p class="first">Run the <code class="docutils literal"><span class="pre">remove_compute_node.yml</span></code> Ansible playbook with the
<code class="docutils literal"><span class="pre">node_to_be_removed</span></code> user variable set:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /opt/openstack-ansible-ops/ansible_tools/playbooks
<span class="go">openstack-ansible remove_compute_node.yml \</span>
<span class="go">-e node_to_be_removed=&quot;&lt;name-of-compute-host&gt;&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">After the playbook completes, remove the compute node from the
OpenStack-Ansible configuration file in
<code class="docutils literal"><span class="pre">/etc/openstack_deploy/openstack_user_config.yml</span></code>.</p>
</li>
</ol>
</div>
<div class="section" id="recover-a-compute-host-failure">
<h2>Recover a compute host failure<a class="headerlink" href="#recover-a-compute-host-failure" title="Permalink to this headline">¶</a></h2>
<p>The following procedure addresses Compute node failure if shared storage
is used.</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If shared storage is not used, data can be copied from the
<code class="docutils literal"><span class="pre">/var/lib/nova/instances</span></code> directory on the failed Compute node
<code class="docutils literal"><span class="pre">${FAILED_NODE}</span></code> to another node <code class="docutils literal"><span class="pre">${RECEIVING_NODE}</span></code>before
performing the following procedure. Please note this method is
not supported.</p>
</div>
</div></blockquote>
<ol class="arabic">
<li><p class="first">Re-launch all instances on the failed node.</p>
</li>
<li><p class="first">Invoke the MySQL command line tool</p>
</li>
<li><p class="first">Generate a list of instance UUIDs hosted on the failed node:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>mysql&gt; select uuid from instances where host = &#39;${FAILED_NODE}&#39; and deleted = 0;
</pre></div>
</div>
</li>
<li><p class="first">Set instances on the failed node to be hosted on a different node:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>mysql&gt; update instances set host =&#39;${RECEIVING_NODE}&#39; where host = &#39;${FAILED_NODE}&#39; \
and deleted = 0;
</pre></div>
</div>
</li>
<li><p class="first">Reboot each instance on the failed node listed in the previous query
to regenerate the XML files:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span><span class="c1"># nova reboot —hard $INSTANCE_UUID</span>
</pre></div>
</div>
</li>
<li><p class="first">Find the volumes to check the instance has successfully booted and is
at the login  :</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>mysql&gt; select nova.instances.uuid as instance_uuid, cinder.volumes.id \
as voume_uuid, cinder.volumes.status, cinder.volumes.attach_status, \
cinder.volumes.mountpoint, cinder.volumes,display_name from \
cinder.volumes inner join nova.instances on cinder.volumes.instance_uuid=nova.instances.uuid \
where nova.instances.host = &#39;${FAILED_NODE}&#39;;
</pre></div>
</div>
</li>
<li><p class="first">If rows are found, detach and re-attach the volumes using the values
listed in the previous query:</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span><span class="c1"># nova volume-detach $INSTANCE_UUID $VOLUME_UUID &amp;&amp; \</span>
<span class="c1"># nova volume-attach $INSTANCE_UUID $VOLUME_UUID $VOLUME_MOUNTPOINT</span>
</pre></div>
</div>
</li>
<li><p class="first">Rebuild or replace the failed node as described in <a class="reference internal" href="#add-compute-host">add-compute-host</a>.</p>
</li>
</ol>
</div>
<div class="section" id="replacing-failed-hardware">
<h2>Replacing failed hardware<a class="headerlink" href="#replacing-failed-hardware" title="Permalink to this headline">¶</a></h2>
<p>It is essential to plan and know how to replace failed hardware in your cluster
without compromising your cloud environment.</p>
<p>Consider the following to help establish a hardware replacement plan:</p>
<ul class="simple">
<li>What type of node am I replacing hardware on?</li>
<li>Can the hardware replacement be done without the host going down? For
example, a single disk in a RAID-10.</li>
<li>If the host DOES have to be brought down for the hardware replacement, how
should the resources on that host be handled?</li>
</ul>
<p>If you have a Compute (nova) host that has a disk failure on a
RAID-10, you can swap the failed disk without powering the host down. On the
other hand, if the RAM has failed, you would have to power the host down.
Having a plan in place for how you will manage these types of events is a vital
part of maintaining your OpenStack environment.</p>
<p>For a Compute host, shut down the instance on the host before
it goes down. For a Block Storage (cinder) host, shut down any instances with
volumes attached that require that mount point. Unmount the drive within
your operating system and re-mount the drive once the Block Storage
host is back online.</p>
<div class="section" id="shutting-down-the-compute-host">
<h3>Shutting down the Compute host<a class="headerlink" href="#shutting-down-the-compute-host" title="Permalink to this headline">¶</a></h3>
<p>If a Compute host needs to be shut down:</p>
<ol class="arabic">
<li><p class="first">Disable the <code class="docutils literal"><span class="pre">nova-compute</span></code> binary:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> nova service-disable --reason <span class="s2">&quot;Hardware replacement&quot;</span> HOSTNAME nova-compute
</pre></div>
</div>
</li>
<li><p class="first">List all running instances on the Compute host:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> nova list --all-t --host &lt;compute_name&gt; <span class="p">|</span> awk <span class="s1">&#39;/ACTIVE/ {print $2}&#39;</span> &gt; <span class="se">\</span>
/home/user/running_instances <span class="o">&amp;&amp;</span> <span class="k">for</span> i in <span class="sb">`</span>cat /home/user/running_instances<span class="sb">`</span><span class="p">;</span> <span class="k">do</span> nova stop <span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</pre></div>
</div>
</li>
<li><p class="first">Use SSH to connect to the Compute host.</p>
</li>
<li><p class="first">Confirm all instances are down:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> virsh list --all
</pre></div>
</div>
</li>
<li><p class="first">Shut down the Compute host:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> shutdown -h now
</pre></div>
</div>
</li>
<li><p class="first">Once the Compute host comes back online, confirm everything is in
working order and start the instances on the host. For example:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat /home/user/running_instances
<span class="gp">#</span> <span class="k">do</span> nova start <span class="nv">$instance</span>
<span class="go">  done</span>
</pre></div>
</div>
</li>
<li><p class="first">Enable the <code class="docutils literal"><span class="pre">nova-compute</span></code> service in the environment:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> nova service-enable HOSTNAME nova-compute
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="shutting-down-the-block-storage-host">
<h3>Shutting down the Block Storage host<a class="headerlink" href="#shutting-down-the-block-storage-host" title="Permalink to this headline">¶</a></h3>
<p>If a Block Storage host needs to be shut down:</p>
<ol class="arabic">
<li><p class="first">Disable the <code class="docutils literal"><span class="pre">cinder-volume</span></code> service:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cinder service-list --host CINDER SERVICE NAME INCLUDING @BACKEND
<span class="gp">#</span> cinder service-disable CINDER SERVICE NAME INCLUDING @BACKEND <span class="se">\</span>
cinder-volume --reason <span class="s1">&#39;RAM maintenance&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">List all instances with Block Storage volumes attached:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> mysql cinder -BNe <span class="s1">&#39;select instance_uuid from volumes where deleted=0 \</span>
<span class="s1">and host like &quot;%&lt;cinder host&gt;%&quot;&#39;</span> <span class="p">|</span> tee /home/user/running_instances
</pre></div>
</div>
</li>
<li><p class="first">Shut down the instances:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat /home/user/running_instances <span class="p">|</span> xargs -n1 nova stop
</pre></div>
</div>
</li>
<li><p class="first">Verify the instances are shutdown:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat /home/user/running_instances <span class="p">|</span> xargs -n1 nova show <span class="p">|</span> fgrep vm_state
</pre></div>
</div>
</li>
<li><p class="first">Shut down the Block Storage host:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> shutdown -h now
</pre></div>
</div>
</li>
<li><p class="first">Replace the failed hardware and validate the new hardware is functioning.</p>
</li>
<li><p class="first">Enable the <code class="docutils literal"><span class="pre">cinder-volume</span></code> service:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cinder service-enable CINDER SERVICE NAME INCLUDING @BACKEND cinder-volume
</pre></div>
</div>
</li>
<li><p class="first">Verify the services on the host are reconnected to the environment:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cinder service-list --host CINDER SERVICE NAME INCLUDING @BACKEND
</pre></div>
</div>
</li>
<li><p class="first">Start your instances and confirm all of the instances are started:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> cat /home/user/running_instances <span class="p">|</span> xargs -n1 nova start
<span class="gp">#</span> cat /home/user/running_instances <span class="p">|</span> xargs -n1 nova show <span class="p">|</span> fgrep vm_state
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="backups.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Backups"></i></a>
          
          
            <a href="ansible-modules.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Running ad-hoc Ansible plays"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2017-02-14 17:57</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="../../_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="../../index.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Operations guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../openstack-operations.html">OpenStack operations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../maintenance-tasks.html">Maintenance tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitor-environment.html">Monitoring your environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced-config.html">Advanced configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ref-info.html">Reference information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrade-guide/index.html">Upgrade Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-docs/index.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inventory/index.html">Inventory</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="../../_static/js/bootstrap.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="../../_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="../../_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="../../_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "draft-operations-guide/maintenance-tasks/scale-environment" + ".rst";
        gitURL = "Source: https://git.openstack.org/cgit/openstack/openstack-ansible/tree/doc/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 55cab808b67095e989137cf8816c323575fc43ad";
        var bugProject = "openstack-ansible";
        var bugTitle = "Documentation bug";
    var fieldTags = "docs";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 15.0.0.0rc2.dev43 on 2017-02-14 17:57";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>
</html>