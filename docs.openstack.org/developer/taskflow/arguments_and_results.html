<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Arguments and results &mdash; TaskFlow 2.9.1.dev5 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.9.1.dev5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="TaskFlow 2.9.1.dev5 documentation" href="index.html" />
    <link rel="next" title="Inputs and outputs" href="inputs_and_outputs.html" />
    <link rel="prev" title="Atoms, tasks and retries" href="atoms.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="arguments-and-results">
<h1>Arguments and results<a class="headerlink" href="#arguments-and-results" title="Permalink to this headline">¶</a></h1>
<p>In TaskFlow, all flow and task state goes to (potentially persistent) storage
(see <a class="reference internal" href="persistence.html"><em>persistence</em></a> for more details). That includes all the
information that <a class="reference internal" href="atoms.html"><em>atoms</em></a> (e.g. tasks, retry objects...) in the
workflow need when they are executed, and all the information task/retry
produces (via serializable results). A developer who implements tasks/retries
or flows can specify what arguments a task/retry accepts and what result it
returns in several ways. This document will help you understand what those ways
are and how to use those ways to accomplish your desired usage pattern.</p>
<dl class="glossary docutils">
<dt id="term-task-retry-arguments">Task/retry arguments</dt>
<dd>Set of names of task/retry arguments available as the <code class="docutils literal"><span class="pre">requires</span></code>
and/or <code class="docutils literal"><span class="pre">optional</span></code> property of the task/retry instance. When a task or
retry object is about to be executed values with these names are
retrieved from storage and passed to the <code class="docutils literal"><span class="pre">execute</span></code> method of the
task/retry.  If any names in the <code class="docutils literal"><span class="pre">requires</span></code> property cannot be
found in storage, an exception will be thrown.  Any names in the
<code class="docutils literal"><span class="pre">optional</span></code> property that cannot be found are ignored.</dd>
<dt id="term-task-retry-results">Task/retry results</dt>
<dd>Set of names of task/retry results (what task/retry provides) available
as <code class="docutils literal"><span class="pre">provides</span></code> property of task or retry instance. After a task/retry
finishes successfully, its result(s) (what the <code class="docutils literal"><span class="pre">execute</span></code> method
returns) are available by these names from storage (see examples
below).</dd>
</dl>
<div class="section" id="arguments-specification">
<h2>Arguments specification<a class="headerlink" href="#arguments-specification" title="Permalink to this headline">¶</a></h2>
<p>There are different ways to specify the task argument <code class="docutils literal"><span class="pre">requires</span></code> set.</p>
<div class="section" id="arguments-inference">
<h3>Arguments inference<a class="headerlink" href="#arguments-inference" title="Permalink to this headline">¶</a></h3>
<p>Task/retry arguments can be inferred from arguments of the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a>
method of a task (or the <a class="reference internal" href="atoms.html#taskflow.retry.Retry.execute" title="taskflow.retry.Retry.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> of a retry object).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spam</span><span class="p">,</span> <span class="n">eggs</span><span class="p">,</span> <span class="n">bacon</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">spam</span> <span class="o">+</span> <span class="n">eggs</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">MyTask</span><span class="p">()</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
<span class="go">[&#39;eggs&#39;, &#39;spam&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">MyTask</span><span class="p">()</span><span class="o">.</span><span class="n">optional</span><span class="p">)</span>
<span class="go">[&#39;bacon&#39;]</span>
</pre></div>
</div>
<p>Inference from the method signature is the &#8216;&#8217;simplest&#8217;&#8217; way to specify
arguments. Special arguments like <code class="docutils literal"><span class="pre">self</span></code>, <code class="docutils literal"><span class="pre">*args</span></code> and <code class="docutils literal"><span class="pre">**kwargs</span></code> are
ignored during inference (as these names have special meaning/usage in python).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">UniTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">UniTask</span><span class="p">()</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
<span class="go">[]</span>
</pre></div>
</div>
</div>
<div class="section" id="rebinding">
<h3>Rebinding<a class="headerlink" href="#rebinding" title="Permalink to this headline">¶</a></h3>
<p><strong>Why:</strong> There are cases when the value you want to pass to a task/retry is
stored with a name other than the corresponding arguments name. That&#8217;s when the
<code class="docutils literal"><span class="pre">rebind</span></code> constructor parameter comes in handy. Using it the flow author
can instruct the engine to fetch a value from storage by one name, but pass it
to a tasks/retries <code class="docutils literal"><span class="pre">execute</span></code> method with another name. There are two possible
ways of accomplishing this.</p>
<p>The first is to pass a dictionary that maps the argument name to the name
of a saved value.</p>
<p>For example, if you have task:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SpawnVMTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_name</span><span class="p">,</span> <span class="n">vm_image_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># TODO(imelnikov): use parameters to spawn vm</span>
</pre></div>
</div>
<p>and you saved <code class="docutils literal"><span class="pre">'vm_name'</span></code> with <code class="docutils literal"><span class="pre">'name'</span></code> key in storage, you can spawn a vm
with such <code class="docutils literal"><span class="pre">'name'</span></code> like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SpawnVMTask</span><span class="p">(</span><span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;vm_name&#39;</span><span class="p">:</span> <span class="s1">&#39;name&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>The second way is to pass a tuple/list/dict of argument names. The length of
the tuple/list/dict should not be less then number of required parameters.</p>
<p>For example, you can achieve the same effect as the previous example with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SpawnVMTask</span><span class="p">(</span><span class="n">rebind_args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;vm_image_id&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This is equivalent to a more elaborate:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SpawnVMTask</span><span class="p">(</span><span class="n">rebind</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">vm_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                        <span class="n">vm_image_id</span><span class="o">=</span><span class="s1">&#39;vm_image_id&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>In both cases, if your task (or retry) accepts arbitrary arguments
with the <code class="docutils literal"><span class="pre">**kwargs</span></code> construct, you can specify extra arguments.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SpawnVMTask</span><span class="p">(</span><span class="n">rebind</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;vm_image_id&#39;</span><span class="p">,</span> <span class="s1">&#39;admin_key_name&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>When such task is about to be executed, <code class="docutils literal"><span class="pre">name</span></code>, <code class="docutils literal"><span class="pre">vm_image_id</span></code> and
<code class="docutils literal"><span class="pre">admin_key_name</span></code> values are fetched from storage and value from <code class="docutils literal"><span class="pre">name</span></code> is
passed to <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method as <code class="docutils literal"><span class="pre">vm_name</span></code>, value from <code class="docutils literal"><span class="pre">vm_image_id</span></code> is
passed as <code class="docutils literal"><span class="pre">vm_image_id</span></code>, and value from <code class="docutils literal"><span class="pre">admin_key_name</span></code> is passed as
<code class="docutils literal"><span class="pre">admin_key_name</span></code> parameter in <code class="docutils literal"><span class="pre">kwargs</span></code>.</p>
</div>
<div class="section" id="manually-specifying-requirements">
<h3>Manually specifying requirements<a class="headerlink" href="#manually-specifying-requirements" title="Permalink to this headline">¶</a></h3>
<p><strong>Why:</strong> It is often useful to manually specify the requirements of a task,
either by a task author or by the flow author (allowing the flow author to
override the task requirements).</p>
<p>To accomplish this when creating your task use the constructor to specify
manual requirements.  Those manual requirements (if they are not functional
arguments) will appear in the <code class="docutils literal"><span class="pre">kwargs</span></code> of the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Cat</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="s1">&#39;requires&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
<span class="gp">... </span>            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;requires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;food&quot;</span><span class="p">,</span> <span class="s2">&quot;milk&quot;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="nb">super</span><span class="p">(</span><span class="n">Cat</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cat</span> <span class="o">=</span> <span class="n">Cat</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
<span class="go">[&#39;food&#39;, &#39;milk&#39;]</span>
</pre></div>
</div>
<p>When constructing a task instance the flow author can also add more
requirements if desired.  Those manual requirements (if they are not functional
arguments) will appear in the <code class="docutils literal"><span class="pre">kwargs</span></code> parameter of the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a>
method.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Dog</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dog</span> <span class="o">=</span> <span class="n">Dog</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="s2">&quot;grass&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">dog</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
<span class="go">[&#39;food&#39;, &#39;grass&#39;, &#39;water&#39;]</span>
</pre></div>
</div>
<p>If the flow author desires she can turn the argument inference off and override
requirements manually. Use this at your own <strong>risk</strong> as you must be careful to
avoid invalid argument mappings.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Bird</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bird</span> <span class="o">=</span> <span class="n">Bird</span><span class="p">(</span><span class="n">requires</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;food&quot;</span><span class="p">,</span> <span class="s2">&quot;water&quot;</span><span class="p">,</span> <span class="s2">&quot;grass&quot;</span><span class="p">),</span> <span class="n">auto_extract</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">bird</span><span class="o">.</span><span class="n">requires</span><span class="p">)</span>
<span class="go">[&#39;food&#39;, &#39;grass&#39;, &#39;water&#39;]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="results-specification">
<h2>Results specification<a class="headerlink" href="#results-specification" title="Permalink to this headline">¶</a></h2>
<p>In python, function results are not named, so we can not infer what a
task/retry returns. This is important since the complete result (what the
task <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> or retry <a class="reference internal" href="atoms.html#taskflow.retry.Retry.execute" title="taskflow.retry.Retry.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method returns) is saved
in (potentially persistent) storage, and it is typically (but not always)
desirable to make those results accessible to others. To accomplish this
the task/retry specifies names of those values via its <code class="docutils literal"><span class="pre">provides</span></code> constructor
parameter or by its default provides attribute.</p>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<div class="section" id="returning-one-value">
<h4>Returning one value<a class="headerlink" href="#returning-one-value" title="Permalink to this headline">¶</a></h4>
<p>If task returns just one value, <code class="docutils literal"><span class="pre">provides</span></code> should be string &#8211; the
name of the value.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">TheAnswerReturningTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="mi">42</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">TheAnswerReturningTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">&#39;the_answer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">provides</span><span class="p">)</span>
<span class="go">[&#39;the_answer&#39;]</span>
</pre></div>
</div>
</div>
<div class="section" id="returning-a-tuple">
<h4>Returning a tuple<a class="headerlink" href="#returning-a-tuple" title="Permalink to this headline">¶</a></h4>
<p>For a task that returns several values, one option (as usual in python) is to
return those values via a <code class="docutils literal"><span class="pre">tuple</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BitsAndPiecesTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;BITs&#39;</span><span class="p">,</span> <span class="s1">&#39;PIECEs&#39;</span>
</pre></div>
</div>
<p>Then, you can give the value individual names, by passing a tuple or list as
<code class="docutils literal"><span class="pre">provides</span></code> parameter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BitsAndPiecesTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">,</span> <span class="s1">&#39;pieces&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>After such task is executed, you (and the engine, which is useful for other
tasks) will be able to get those elements from storage by name:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">storage</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">)</span>
<span class="go">&#39;BITs&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">storage</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;pieces&#39;</span><span class="p">)</span>
<span class="go">&#39;PIECEs&#39;</span>
</pre></div>
</div>
<p>Provides argument can be shorter then the actual tuple returned by a task &#8211;
then extra values are ignored (but, as expected, <strong>all</strong> those values are saved
and passed to the task <a class="reference internal" href="atoms.html#taskflow.atom.Atom.revert" title="taskflow.atom.Atom.revert"><code class="xref py py-meth docutils literal"><span class="pre">revert()</span></code></a> or retry <a class="reference internal" href="atoms.html#taskflow.retry.Retry.revert" title="taskflow.retry.Retry.revert"><code class="xref py py-meth docutils literal"><span class="pre">revert()</span></code></a> method).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Provides arguments tuple can also be longer then the actual tuple returned
by task &#8211; when this happens the extra parameters are left undefined: a
warning is printed to logs and if use of such parameter is attempted a
<a class="reference internal" href="exceptions.html#taskflow.exceptions.NotFound" title="taskflow.exceptions.NotFound"><code class="xref py py-class docutils literal"><span class="pre">NotFound</span></code></a>  exception is raised.</p>
</div>
</div>
<div class="section" id="returning-a-dictionary">
<h4>Returning a dictionary<a class="headerlink" href="#returning-a-dictionary" title="Permalink to this headline">¶</a></h4>
<p>Another option is to return several values as a dictionary (aka a <code class="docutils literal"><span class="pre">dict</span></code>).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BitsAndPiecesTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bits&#39;</span><span class="p">:</span> <span class="s1">&#39;BITs&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pieces&#39;</span><span class="p">:</span> <span class="s1">&#39;PIECEs&#39;</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>TaskFlow expects that a dict will be returned if <code class="docutils literal"><span class="pre">provides</span></code> argument is a
<code class="docutils literal"><span class="pre">set</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BitsAndPiecesTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;bits&#39;</span><span class="p">,</span> <span class="s1">&#39;pieces&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>After such task executes, you (and the engine, which is useful for other tasks)
will be able to get elements from storage by name:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">storage</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">)</span>
<span class="go">&#39;BITs&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">storage</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;pieces&#39;</span><span class="p">)</span>
<span class="go">&#39;PIECEs&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If some items from the dict returned by the task are not present in the
provides arguments &#8211; then extra values are ignored (but, of course, saved
and passed to the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.revert" title="taskflow.atom.Atom.revert"><code class="xref py py-meth docutils literal"><span class="pre">revert()</span></code></a> method). If the provides argument has some
items not present in the actual dict returned by the task &#8211; then extra
parameters are left undefined: a warning is printed to logs and if use of
such parameter is attempted a <a class="reference internal" href="exceptions.html#taskflow.exceptions.NotFound" title="taskflow.exceptions.NotFound"><code class="xref py py-class docutils literal"><span class="pre">NotFound</span></code></a>
exception is raised.</p>
</div>
</div>
<div class="section" id="default-provides">
<h4>Default provides<a class="headerlink" href="#default-provides" title="Permalink to this headline">¶</a></h4>
<p>As mentioned above, the default base class provides nothing, which means
results are not accessible to other tasks/retries in the flow.</p>
<p>The author can override this and specify default value for provides using
the <code class="docutils literal"><span class="pre">default_provides</span></code> class/instance variable:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BitsAndPiecesTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">default_provides</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bits&#39;</span><span class="p">,</span> <span class="s1">&#39;pieces&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;BITs&#39;</span><span class="p">,</span> <span class="s1">&#39;PIECEs&#39;</span>
</pre></div>
</div>
<p>Of course, the flow author can override this to change names if needed:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BitsAndPiecesTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>or to change structure &#8211; e.g. this instance will make tuple accessible
to other tasks by name <code class="docutils literal"><span class="pre">'bnp'</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BitsAndPiecesTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">&#39;bnp&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or the flow author may want to return default behavior and hide the results of
the task from other tasks in the flow (e.g. to avoid naming conflicts):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BitsAndPiecesTask</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="revert-arguments">
<h2>Revert arguments<a class="headerlink" href="#revert-arguments" title="Permalink to this headline">¶</a></h2>
<p>To revert a task the <a class="reference internal" href="engines.html"><em>engine</em></a> calls the tasks
<a class="reference internal" href="atoms.html#taskflow.atom.Atom.revert" title="taskflow.atom.Atom.revert"><code class="xref py py-meth docutils literal"><span class="pre">revert()</span></code></a> method. This method should accept the same arguments
as the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method of the task and one more special keyword
argument, named <code class="docutils literal"><span class="pre">result</span></code>.</p>
<p>For <code class="docutils literal"><span class="pre">result</span></code> value, two cases are possible:</p>
<ul class="simple">
<li>If the task is being reverted because it failed (an exception was raised
from its <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method), the <code class="docutils literal"><span class="pre">result</span></code> value is an instance of a
<a class="reference internal" href="types.html#taskflow.types.failure.Failure" title="taskflow.types.failure.Failure"><code class="xref py py-class docutils literal"><span class="pre">Failure</span></code></a> object that holds the exception
information.</li>
<li>If the task is being reverted because some other task failed, and this task
finished successfully, <code class="docutils literal"><span class="pre">result</span></code> value is the result fetched from storage:
ie, what the <a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method returned.</li>
</ul>
<p>All other arguments are fetched from storage in the same way it is done for
<a class="reference internal" href="atoms.html#taskflow.atom.Atom.execute" title="taskflow.atom.Atom.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method.</p>
<p>To determine if a task failed you can check whether <code class="docutils literal"><span class="pre">result</span></code> is instance of
<a class="reference internal" href="types.html#taskflow.types.failure.Failure" title="taskflow.types.failure.Failure"><code class="xref py py-class docutils literal"><span class="pre">Failure</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">failure</span>

<span class="k">class</span> <span class="nc">RevertingTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spam</span><span class="p">,</span> <span class="n">eggs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">do_something</span><span class="p">(</span><span class="n">spam</span><span class="p">,</span> <span class="n">eggs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">spam</span><span class="p">,</span> <span class="n">eggs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;This task failed, exception: </span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">exception_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;do_something returned </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>If this task failed (ie <code class="docutils literal"><span class="pre">do_something</span></code> raised an exception) it will print
<code class="docutils literal"><span class="pre">&quot;This</span> <span class="pre">task</span> <span class="pre">failed,</span> <span class="pre">exception:&quot;</span></code> and a exception message on revert. If this
task finished successfully, it will print <code class="docutils literal"><span class="pre">&quot;do_something</span> <span class="pre">returned&quot;</span></code> and a
representation of the <code class="docutils literal"><span class="pre">do_something</span></code> result.</p>
</div>
<div class="section" id="retry-arguments">
<h2>Retry arguments<a class="headerlink" href="#retry-arguments" title="Permalink to this headline">¶</a></h2>
<p>A <a class="reference internal" href="atoms.html#taskflow.retry.Retry" title="taskflow.retry.Retry"><code class="xref py py-class docutils literal"><span class="pre">Retry</span></code></a> controller works with arguments in the same way as a <a class="reference internal" href="atoms.html#taskflow.task.Task" title="taskflow.task.Task"><code class="xref py py-class docutils literal"><span class="pre">Task</span></code></a>. But it
has an additional parameter <code class="docutils literal"><span class="pre">'history'</span></code> that is itself a
<a class="reference internal" href="atoms.html#taskflow.retry.History" title="taskflow.retry.History"><code class="xref py py-class docutils literal"><span class="pre">History</span></code></a> object that contains what failed over all
the engines attempts (aka the outcomes). The history object can be
viewed as a tuple that contains a result of the previous retries run and a
table/dict where each key is a failed atoms name and each value is
a <a class="reference internal" href="types.html#taskflow.types.failure.Failure" title="taskflow.types.failure.Failure"><code class="xref py py-class docutils literal"><span class="pre">Failure</span></code></a> object.</p>
<p>Consider the following implementation:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyRetry</span><span class="p">(</span><span class="n">retry</span><span class="o">.</span><span class="n">Retry</span><span class="p">):</span>

    <span class="n">default_provides</span> <span class="o">=</span> <span class="s1">&#39;value&#39;</span>

    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">history</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">RETRY</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">history</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">history</span><span class="p">))</span>
</pre></div>
</div>
<p>Imagine the above retry had returned a value <code class="docutils literal"><span class="pre">'5'</span></code> and then some task <code class="docutils literal"><span class="pre">'A'</span></code>
failed with some exception.  In this case <code class="docutils literal"><span class="pre">on_failure</span></code> method will receive
the following history (printed as a list):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">failure</span><span class="o">.</span><span class="n">Failure</span><span class="p">()})]</span>
</pre></div>
</div>
<p>At this point (since the implementation returned <code class="docutils literal"><span class="pre">RETRY</span></code>) the
<a class="reference internal" href="atoms.html#taskflow.retry.Retry.execute" title="taskflow.retry.Retry.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method will be called again and it will receive the same
history and it can then return a value that subsequent tasks can use to alter
their behavior.</p>
<p>If instead the <a class="reference internal" href="atoms.html#taskflow.retry.Retry.execute" title="taskflow.retry.Retry.execute"><code class="xref py py-meth docutils literal"><span class="pre">execute()</span></code></a> method itself raises an exception,
the <a class="reference internal" href="atoms.html#taskflow.retry.Retry.revert" title="taskflow.retry.Retry.revert"><code class="xref py py-meth docutils literal"><span class="pre">revert()</span></code></a> method of the implementation will be called and
a <a class="reference internal" href="types.html#taskflow.types.failure.Failure" title="taskflow.types.failure.Failure"><code class="xref py py-class docutils literal"><span class="pre">Failure</span></code></a> object will be present in the
history object instead of the typical result.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">After a <a class="reference internal" href="atoms.html#taskflow.retry.Retry" title="taskflow.retry.Retry"><code class="xref py py-class docutils literal"><span class="pre">Retry</span></code></a> has been reverted, the objects history will be cleaned.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Arguments and results</a><ul>
<li><a class="reference internal" href="#arguments-specification">Arguments specification</a><ul>
<li><a class="reference internal" href="#arguments-inference">Arguments inference</a></li>
<li><a class="reference internal" href="#rebinding">Rebinding</a></li>
<li><a class="reference internal" href="#manually-specifying-requirements">Manually specifying requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#results-specification">Results specification</a><ul>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#returning-one-value">Returning one value</a></li>
<li><a class="reference internal" href="#returning-a-tuple">Returning a tuple</a></li>
<li><a class="reference internal" href="#returning-a-dictionary">Returning a dictionary</a></li>
<li><a class="reference internal" href="#default-provides">Default provides</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#revert-arguments">Revert arguments</a></li>
<li><a class="reference internal" href="#retry-arguments">Retry arguments</a></li>
</ul>
</li>
</ul>

  <h3>Navigation</h3>
  <ul>

    <li><a href="index.html">Table Of Contents</a></li>


    <li><a href="inputs_and_outputs.html" title="next chapter">Next topic: Inputs and outputs</a></li>


    <li><a href="atoms.html" title="previous chapter">Previous topic: Atoms, tasks and retries</a></li>

  </ul>

            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/taskflow
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/arguments_and_results.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="inputs_and_outputs.html" title="Inputs and outputs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="atoms.html" title="Atoms, tasks and retries"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">TaskFlow 2.9.1.dev5 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, OpenStack Foundation.
      Last updated on &#39;Fri Feb 10 20:11:01 2017, commit b7e2fcd&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/TaskFlow");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>