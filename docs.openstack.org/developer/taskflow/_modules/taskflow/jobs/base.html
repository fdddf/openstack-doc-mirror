<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>taskflow.jobs.base &mdash; TaskFlow 2.9.1.dev9 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.9.1.dev9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="TaskFlow 2.9.1.dev9 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for taskflow.jobs.base</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1">#    Copyright (C) 2013 Rackspace Hosting Inc. All Rights Reserved.</span>
<span class="c1">#    Copyright (C) 2013 Yahoo! Inc. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c1">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c1">#    a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c1">#    License for the specific language governing permissions and limitations</span>
<span class="c1">#    under the License.</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">excp</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">notifier</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">iter_utils</span>


<div class="viewcode-block" id="JobPriority"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobPriority">[docs]</a><span class="k">class</span> <span class="nc">JobPriority</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enum of job priorities (modeled after hadoop job priorities).&quot;&quot;&quot;</span>

    <span class="c1">#: Extremely urgent job priority.</span>
    <span class="n">VERY_HIGH</span> <span class="o">=</span> <span class="s1">&#39;VERY_HIGH&#39;</span>

    <span class="c1">#: Mildly urgent job priority.</span>
    <span class="n">HIGH</span> <span class="o">=</span> <span class="s1">&#39;HIGH&#39;</span>

    <span class="c1">#: Default job priority.</span>
    <span class="n">NORMAL</span> <span class="o">=</span> <span class="s1">&#39;NORMAL&#39;</span>

    <span class="c1">#: Not needed anytime soon job priority.</span>
    <span class="n">LOW</span> <span class="o">=</span> <span class="s1">&#39;LOW&#39;</span>

    <span class="c1">#: Very much not needed anytime soon job priority.</span>
    <span class="n">VERY_LOW</span> <span class="o">=</span> <span class="s1">&#39;VERY_LOW&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">VERY_HIGH</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span>
                      <span class="bp">cls</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VERY_LOW</span><span class="p">]</span>
            <span class="n">valids</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">valids</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a valid priority, valid&quot;</span>
                             <span class="s2">&quot; priorities are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valids</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="JobPriority.reorder"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobPriority.reorder">[docs]</a>    <span class="k">def</span> <span class="nf">reorder</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reorders (priority, value) tuples -&gt; priority ordered values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one (priority, value) pair is&quot;</span>
                             <span class="s2">&quot; required&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Even though this isn&#39;t used, we do the conversion because</span>
            <span class="c1"># all the other branches in this function do it so we do it</span>
            <span class="c1"># to be consistent (this also will raise on bad values, which</span>
            <span class="c1"># we want to do)...</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Order very very much matters in this tuple...</span>
            <span class="n">priority_ordering</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">VERY_HIGH</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">HIGH</span><span class="p">,</span>
                                 <span class="bp">cls</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LOW</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VERY_LOW</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># It&#39;s common to use this in a 2 tuple situation, so</span>
                <span class="c1"># make it avoid all the needed complexity that is done</span>
                <span class="c1"># for greater than 2 tuples.</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p1_i</span> <span class="o">=</span> <span class="n">priority_ordering</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
                <span class="n">p2_i</span> <span class="o">=</span> <span class="n">priority_ordering</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p1_i</span> <span class="o">&lt;=</span> <span class="n">p2_i</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">buckets</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">buckets</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">priority_ordering</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">buckets</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div></div>


<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<div class="viewcode-block" id="Job"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.Job">[docs]</a><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A abstraction that represents a named and trackable unit of work.</span>

<span class="sd">    A job connects a logbook, a owner, a priority, last modified and created</span>
<span class="sd">    on dates and any associated state that the job has. Since it is a connected</span>
<span class="sd">    to a logbook, which are each associated with a set of factories that can</span>
<span class="sd">    create set of flows, it is the current top-level container for a piece of</span>
<span class="sd">    work that can be owned by an entity (typically that entity will read those</span>
<span class="sd">    logbooks and run any contained flows).</span>

<span class="sd">    Only one entity will be allowed to own and operate on the flows contained</span>
<span class="sd">    in a job at a given time (for the foreseeable future).</span>

<span class="sd">    NOTE(harlowja): It is the object that will be transferred to another</span>
<span class="sd">    entity on failure so that the contained flows ownership can be</span>
<span class="sd">    transferred to the secondary entity/owner for resumption, continuation,</span>
<span class="sd">    reverting...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                 <span class="n">uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">book</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">book_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">uuid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="n">uuid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span> <span class="o">=</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_details</span> <span class="o">=</span> <span class="n">details</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_board</span> <span class="o">=</span> <span class="n">board</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="o">=</span> <span class="n">book</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">book_data</span><span class="p">:</span>
            <span class="n">book_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_book_data</span> <span class="o">=</span> <span class="n">book_data</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The datetime the job was last modified.&quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">created_on</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The datetime the job was created on.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">board</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The board this job was posted on or was created from.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_board</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Access the current state of this job.&quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The :py:class:`~.JobPriority` of this job.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Job.wait"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.Job.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">delay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">delay_multiplier</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">max_delay</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
             <span class="n">sleep_func</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait for job to enter completion state.</span>

<span class="sd">        If the job has not completed in the given timeout, then return false,</span>
<span class="sd">        otherwise return true (a job failure exception may also be raised if</span>
<span class="sd">        the job information can not be read, for whatever reason). Periodic</span>
<span class="sd">        state checks will happen every ``delay`` seconds where ``delay`` will</span>
<span class="sd">        be multiplied by the given multipler after a state is found that is</span>
<span class="sd">        **not** complete.</span>

<span class="sd">        Note that if no timeout is given this is equivalent to blocking</span>
<span class="sd">        until the job has completed. Also note that if a jobboard backend</span>
<span class="sd">        can optimize this method then its implementation may not use</span>
<span class="sd">        delays (and backoffs) at all. In general though no matter what</span>
<span class="sd">        optimizations are applied implementations must **always** respect</span>
<span class="sd">        the given timeout value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">StopWatch</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">delay_gen</span> <span class="o">=</span> <span class="n">iter_utils</span><span class="o">.</span><span class="n">generate_delays</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">max_delay</span><span class="p">,</span>
                                               <span class="n">multiplier</span><span class="o">=</span><span class="n">delay_multiplier</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">expired</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">states</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">sleepy_secs</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">delay_gen</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">sleepy_secs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">leftover</span><span class="p">(),</span> <span class="n">sleepy_secs</span><span class="p">)</span>
            <span class="n">sleep_func</span><span class="p">(</span><span class="n">sleepy_secs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">book</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Logbook associated with this job.</span>

<span class="sd">        If no logbook is associated with this job, this property is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_book</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">book_uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;UUID of logbook associated with this job.</span>

<span class="sd">        If no logbook is associated with this job, this property is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">uuid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">book_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Name of logbook associated with this job.</span>

<span class="sd">        If no logbook is associated with this job, this property is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_book_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uuid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The uuid of this job.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uuid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A dictionary of any details associated with this job.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_details</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The non-uniquely identifying name of this job.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span> <span class="nf">_load_book</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">book_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">book_uuid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">book_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># TODO(harlowja): we are currently limited by assuming that the</span>
            <span class="c1"># job posted has the same backend as this loader (to start this</span>
            <span class="c1"># seems to be a ok assumption, and can be adjusted in the future</span>
            <span class="c1"># if we determine there is a use-case for multi-backend loaders,</span>
            <span class="c1"># aka a registry of loaders).</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_logbook</span><span class="p">(</span><span class="n">book_uuid</span><span class="p">)</span>
        <span class="c1"># No backend to fetch from or no uuid specified</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pretty formats the job into something *more* meaningful.&quot;&quot;&quot;</span>
        <span class="n">cls_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (priority=</span><span class="si">%s</span><span class="s2">, uuid=</span><span class="si">%s</span><span class="s2">, details=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">cls_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">)</span></div>


<div class="viewcode-block" id="JobBoardIterator"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoardIterator">[docs]</a><span class="k">class</span> <span class="nc">JobBoardIterator</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">Iterator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator over a jobboard that iterates over potential jobs.</span>

<span class="sd">    It provides the following attributes:</span>

<span class="sd">    * ``only_unclaimed``: boolean that indicates whether to only iterate</span>
<span class="sd">      over unclaimed jobs</span>
<span class="sd">    * ``ensure_fresh``: boolean that requests that during every fetch of a new</span>
<span class="sd">      set of jobs this will cause the iterator to force the backend to</span>
<span class="sd">      refresh (ensuring that the jobboard has the most recent job listings)</span>
<span class="sd">    * ``board``: the board this iterator was created from</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_UNCLAIMED_JOB_STATES</span> <span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">UNCLAIMED</span><span class="p">,)</span>
    <span class="n">_JOB_STATES</span> <span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">UNCLAIMED</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">states</span><span class="o">.</span><span class="n">CLAIMED</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">board</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span>
                 <span class="n">board_fetch_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">board_removal_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">only_unclaimed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ensure_fresh</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_board</span> <span class="o">=</span> <span class="n">board</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_board_removal_func</span> <span class="o">=</span> <span class="n">board_removal_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_board_fetch_func</span> <span class="o">=</span> <span class="n">board_fetch_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">only_unclaimed</span> <span class="o">=</span> <span class="n">only_unclaimed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_fresh</span> <span class="o">=</span> <span class="n">ensure_fresh</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">board</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The board this iterator was created from.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_board</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_next_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_unclaimed</span><span class="p">:</span>
            <span class="n">allowed_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNCLAIMED_JOB_STATES</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowed_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_JOB_STATES</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span> <span class="ow">and</span> <span class="n">job</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">maybe_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">maybe_job</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="n">allowed_states</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">maybe_job</span>
            <span class="k">except</span> <span class="n">excp</span><span class="o">.</span><span class="n">JobFailure</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed determining the state of&quot;</span>
                                  <span class="s2">&quot; job &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">maybe_job</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">excp</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="c1"># Attempt to clean this off the board now that we found</span>
                <span class="c1"># it wasn&#39;t really there (this **must** gracefully handle</span>
                <span class="c1"># removal already having happened).</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_board_removal_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_board_removal_func</span><span class="p">(</span><span class="n">maybe_job</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_board_fetch_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_board_fetch_func</span><span class="p">(</span>
                            <span class="n">ensure_fresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_fresh</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetched</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_job</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">job</span></div>


<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<div class="viewcode-block" id="JobBoard"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard">[docs]</a><span class="k">class</span> <span class="nc">JobBoard</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A place where jobs can be posted, reposted, claimed and transferred.</span>

<span class="sd">    There can be multiple implementations of this job board, depending on the</span>
<span class="sd">    desired semantics and capabilities of the underlying jobboard</span>
<span class="sd">    implementation.</span>

<span class="sd">    NOTE(harlowja): the name is meant to be an analogous to a board/posting</span>
<span class="sd">    system that is used in newspapers, or elsewhere to solicit jobs that</span>
<span class="sd">    people can interview and apply for (and then work on &amp; complete).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="n">conf</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.iterjobs"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.iterjobs">[docs]</a>    <span class="k">def</span> <span class="nf">iterjobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_unclaimed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ensure_fresh</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an iterator of jobs that are currently on this board.</span>

<span class="sd">        NOTE(harlowja): the ordering of this iteration should be by posting</span>
<span class="sd">        order (oldest to newest) with higher priority jobs</span>
<span class="sd">        being provided before lower priority jobs, but it is left up to the</span>
<span class="sd">        backing implementation to provide the order that best suits it..</span>

<span class="sd">        NOTE(harlowja): the iterator that is returned may support other</span>
<span class="sd">        attributes which can be used to further customize how iteration can</span>
<span class="sd">        be accomplished; check with the backends iterator object to determine</span>
<span class="sd">        what other attributes are supported.</span>

<span class="sd">        :param only_unclaimed: boolean that indicates whether to only iteration</span>
<span class="sd">            over unclaimed jobs.</span>
<span class="sd">        :param ensure_fresh: boolean that requests to only iterate over the</span>
<span class="sd">            most recent jobs available, where the definition of what is recent</span>
<span class="sd">            is backend specific. It is allowable that a backend may ignore this</span>
<span class="sd">            value if the backends internal semantics/capabilities can not</span>
<span class="sd">            support this argument.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.wait"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Waits a given amount of time for **any** jobs to be posted.</span>

<span class="sd">        When jobs are found then an iterator will be returned that can be used</span>
<span class="sd">        to iterate over those jobs.</span>

<span class="sd">        NOTE(harlowja): since a jobboard can be mutated on by multiple external</span>
<span class="sd">        entities at the **same** time the iterator that can be</span>
<span class="sd">        returned **may** still be empty due to other entities removing those</span>
<span class="sd">        jobs after the iterator has been created (be aware of this when</span>
<span class="sd">        using it).</span>

<span class="sd">        :param timeout: float that indicates how long to wait for a job to</span>
<span class="sd">            appear (if None then waits forever).</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">job_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns how many jobs are on this jobboard.</span>

<span class="sd">        NOTE(harlowja): this count may change as jobs appear or are removed so</span>
<span class="sd">        the accuracy of this count should not be used in a way that requires</span>
<span class="sd">        it to be exact &amp; absolute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.find_owner"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.find_owner">[docs]</a>    <span class="k">def</span> <span class="nf">find_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the owner of the job if one exists.&quot;&quot;&quot;</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The non-uniquely identifying name of this jobboard.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.consume"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.consume">[docs]</a>    <span class="k">def</span> <span class="nf">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Permanently (and atomically) removes a job from the jobboard.</span>

<span class="sd">        Consumption signals to the board (and any others examining the board)</span>
<span class="sd">        that this job has been completed by the entity that previously claimed</span>
<span class="sd">        that job.</span>

<span class="sd">        Only the entity that has claimed that job is able to consume the job.</span>

<span class="sd">        A job that has been consumed can not be reclaimed or reposted by</span>
<span class="sd">        another entity (job postings are immutable). Any entity consuming</span>
<span class="sd">        a unclaimed job (or a job they do not have a claim on) will cause an</span>
<span class="sd">        exception.</span>

<span class="sd">        :param job: a job on this jobboard that can be consumed (if it does</span>
<span class="sd">            not exist then a NotFound exception will be raised).</span>
<span class="sd">        :param who: string that names the entity performing the consumption,</span>
<span class="sd">            this must be the same name that was used for claiming this job.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.post"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Atomically creates and posts a job to the jobboard.</span>

<span class="sd">        This posting allowing others to attempt to claim that job (and</span>
<span class="sd">        subsequently work on that job). The contents of the provided logbook,</span>
<span class="sd">        details dictionary, or name (or a mix of these) must provide *enough*</span>
<span class="sd">        information for consumers to reference to construct and perform that</span>
<span class="sd">        jobs contained work (whatever it may be).</span>

<span class="sd">        Once a job has been posted it can only be removed by consuming that</span>
<span class="sd">        job (after that job is claimed). Any entity can post/propose jobs</span>
<span class="sd">        to the jobboard (in the future this may be restricted).</span>

<span class="sd">        Returns a job object representing the information that was posted.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.claim"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.claim">[docs]</a>    <span class="k">def</span> <span class="nf">claim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Atomically attempts to claim the provided job.</span>

<span class="sd">        If a job is claimed it is expected that the entity that claims that job</span>
<span class="sd">        will at sometime in the future work on that jobs contents and either</span>
<span class="sd">        fail at completing them (resulting in a reposting) or consume that job</span>
<span class="sd">        from the jobboard (signaling its completion). If claiming fails then</span>
<span class="sd">        a corresponding exception will be raised to signal this to the claim</span>
<span class="sd">        attempter.</span>

<span class="sd">        :param job: a job on this jobboard that can be claimed (if it does</span>
<span class="sd">            not exist then a NotFound exception will be raised).</span>
<span class="sd">        :param who: string that names the claiming entity.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.abandon"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.abandon">[docs]</a>    <span class="k">def</span> <span class="nf">abandon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Atomically attempts to abandon the provided job.</span>

<span class="sd">        This abandonment signals to others that the job may now be reclaimed.</span>
<span class="sd">        This would typically occur if the entity that has claimed the job has</span>
<span class="sd">        failed or is unable to complete the job or jobs it had previously</span>
<span class="sd">        claimed.</span>

<span class="sd">        Only the entity that has claimed that job can abandon a job. Any entity</span>
<span class="sd">        abandoning a unclaimed job (or a job they do not own) will cause an</span>
<span class="sd">        exception.</span>

<span class="sd">        :param job: a job on this jobboard that can be abandoned (if it does</span>
<span class="sd">            not exist then a NotFound exception will be raised).</span>
<span class="sd">        :param who: string that names the entity performing the abandoning,</span>
<span class="sd">            this must be the same name that was used for claiming this job.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.trash"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.trash">[docs]</a>    <span class="k">def</span> <span class="nf">trash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Trash the provided job.</span>

<span class="sd">        Trashing a job signals to others that the job is broken and should not</span>
<span class="sd">        be reclaimed. This is provided as an option for users to be able to</span>
<span class="sd">        remove jobs from the board externally.  The trashed job details should</span>
<span class="sd">        be kept around in an alternate location to be reviewed, if desired.</span>

<span class="sd">        Only the entity that has claimed that job can trash a job. Any entity</span>
<span class="sd">        trashing a unclaimed job (or a job they do not own) will cause an</span>
<span class="sd">        exception.</span>

<span class="sd">        :param job: a job on this jobboard that can be trashed (if it does</span>
<span class="sd">            not exist then a NotFound exception will be raised).</span>
<span class="sd">        :param who: string that names the entity performing the trashing,</span>
<span class="sd">            this must be the same name that was used for claiming this job.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.register_entity"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.register_entity">[docs]</a>    <span class="k">def</span> <span class="nf">register_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register an entity to the jobboard(&#39;s backend), e.g: a conductor.</span>

<span class="sd">        :param entity: entity to register as being associated with the</span>
<span class="sd">                       jobboard(&#39;s backend)</span>
<span class="sd">        :type entity: :py:class:`~taskflow.types.entity.Entity`</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns if this jobboard is connected.&quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.connect"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Opens the connection to any backend system.&quot;&quot;&quot;</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="JobBoard.close"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.JobBoard.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the connection to any backend system.</span>

<span class="sd">        Once closed the jobboard can no longer be used (unless reconnection</span>
<span class="sd">        occurs).</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<span class="c1"># Jobboard events</span>
<span class="n">POSTED</span> <span class="o">=</span> <span class="s1">&#39;POSTED&#39;</span>  <span class="c1"># new job is/has been posted</span>
<span class="n">REMOVAL</span> <span class="o">=</span> <span class="s1">&#39;REMOVAL&#39;</span>  <span class="c1"># existing job is/has been removed</span>


<div class="viewcode-block" id="NotifyingJobBoard"><a class="viewcode-back" href="../../../jobs.html#taskflow.jobs.base.NotifyingJobBoard">[docs]</a><span class="k">class</span> <span class="nc">NotifyingJobBoard</span><span class="p">(</span><span class="n">JobBoard</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A jobboard subclass that can notify others about board events.</span>

<span class="sd">    Implementers are expected to notify *at least* about jobs being posted</span>
<span class="sd">    and removed.</span>

<span class="sd">    NOTE(harlowja): notifications that are emitted *may* be emitted on a</span>
<span class="sd">    separate dedicated thread when they occur, so ensure that all callbacks</span>
<span class="sd">    registered are thread safe (and block for as little time as possible).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NotifyingJobBoard</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span> <span class="o">=</span> <span class="n">notifier</span><span class="o">.</span><span class="n">Notifier</span><span class="p">()</span></div>


<span class="c1"># Internal helpers for usage by board implementations...</span>

<span class="k">def</span> <span class="nf">check_who</span><span class="p">(</span><span class="n">meth</span><span class="p">):</span>

    <span class="nd">@six.wraps</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Job applicant must be a string type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">who</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Job applicant must be non-empty&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">who</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">format_posting</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">created_on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">last_modified</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">details</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">JobPriority</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">):</span>
    <span class="n">posting</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">created_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">posting</span><span class="p">[</span><span class="s1">&#39;created_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">created_on</span>
    <span class="k">if</span> <span class="n">last_modified</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">posting</span><span class="p">[</span><span class="s1">&#39;last_modified&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_modified</span>
    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">posting</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">posting</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">book</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">posting</span><span class="p">[</span><span class="s1">&#39;book&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">book</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">book</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">posting</span>
</pre></div>

          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
  <h3>Navigation</h3>
  <ul>

    <li><a href="../../../index.html">Table Of Contents</a></li>



  </ul>

            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/taskflow
"
                     rel="nofollow">Project Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">TaskFlow 2.9.1.dev9 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2017, OpenStack Foundation.
      Last updated on &#39;Fri Feb 10 20:11:17 2017, commit 643495f&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/TaskFlow");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>