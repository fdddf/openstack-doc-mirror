<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Alembic Migrations &mdash; neutron 10.0.0.0rc2.dev58 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '10.0.0.0rc2.dev58',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="neutron 10.0.0.0rc2.dev58 documentation" href="../index.html" />
    <link rel="up" title="Developer Guide" href="index.html" />
    <link rel="next" title="Services and agents" href="services_and_agents.html" />
    <link rel="prev" title="Client command extension support" href="client_command_extensions.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="alembic-migrations">
<span id="id1"></span><h1>Alembic Migrations<a class="headerlink" href="#alembic-migrations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The migrations in the alembic/versions contain the changes needed to migrate
from older Neutron releases to newer versions. A migration occurs by executing
a script that details the changes needed to upgrade the database. The migration
scripts are ordered so that multiple scripts can run sequentially to update the
database.</p>
</div>
<div class="section" id="the-migration-wrapper">
<h2>The Migration Wrapper<a class="headerlink" href="#the-migration-wrapper" title="Permalink to this headline">¶</a></h2>
<p>The scripts are executed by Neutron&#8217;s migration wrapper <code class="docutils literal"><span class="pre">neutron-db-manage</span></code>
which uses the Alembic library to manage the migration. Pass the <code class="docutils literal"><span class="pre">--help</span></code>
option to the wrapper for usage information.</p>
<p>The wrapper takes some options followed by some commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage &lt;options&gt; &lt;commands&gt;
</pre></div>
</div>
<p>The wrapper needs to be provided with the database connection string, which is
usually provided in the <code class="docutils literal"><span class="pre">neutron.conf</span></code> configuration file in an installation.
The wrapper automatically reads from <code class="docutils literal"><span class="pre">/etc/neutron/neutron.conf</span></code> if it is
present. If the configuration is in a different location:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage --config-file /path/to/neutron.conf &lt;commands&gt;
</pre></div>
</div>
<p>Multiple <code class="docutils literal"><span class="pre">--config-file</span></code> options can be passed if needed.</p>
<p>Instead of reading the DB connection from the configuration file(s) the
<code class="docutils literal"><span class="pre">--database-connection</span></code> option can be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage --database-connection mysql+pymysql://root:secret@127.0.0.1/neutron?charset=utf8 &lt;commands&gt;
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">branches</span></code>, <code class="docutils literal"><span class="pre">current</span></code>, and <code class="docutils literal"><span class="pre">history</span></code> commands all accept a
<code class="docutils literal"><span class="pre">--verbose</span></code> option, which, when passed, will instruct <code class="docutils literal"><span class="pre">neutron-db-manage</span></code>
to display more verbose output for the specified command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage current --verbose
</pre></div>
</div>
<p>For some commands the wrapper needs to know the entrypoint of the core plugin
for the installation. This can be read from the configuration file(s) or
specified using the <code class="docutils literal"><span class="pre">--core_plugin</span></code> option:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage --core_plugin neutron.plugins.ml2.plugin.Ml2Plugin &lt;commands&gt;
</pre></div>
</div>
<p>When giving examples below of using the wrapper the options will not be shown.
It is assumed you will use the options that you need for your environment.</p>
<p>For new deployments you will start with an empty database. You then upgrade
to the latest database version via:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade heads
</pre></div>
</div>
<p>For existing deployments the database will already be at some version. To
check the current database version:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage current
</pre></div>
</div>
<p>After installing a new version of Neutron server, upgrading the database is
the same command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade heads
</pre></div>
</div>
<p>To create a script to run the migration offline:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade heads --sql
</pre></div>
</div>
<p>To run the offline migration between specific migration versions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade &lt;start version&gt;:&lt;end version&gt; --sql
</pre></div>
</div>
<p>Upgrade the database incrementally:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade --delta &lt;# of revs&gt;
</pre></div>
</div>
<p><strong>NOTE:</strong> Database downgrade is not supported.</p>
</div>
<div class="section" id="migration-branches">
<h2>Migration Branches<a class="headerlink" href="#migration-branches" title="Permalink to this headline">¶</a></h2>
<p>Neutron makes use of alembic branches for two purposes.</p>
<div class="section" id="independent-sub-project-tables">
<h3>1. Independent Sub-Project Tables<a class="headerlink" href="#independent-sub-project-tables" title="Permalink to this headline">¶</a></h3>
<p>Various <a class="reference external" href="../stadium/sub_projects.html">sub-projects</a> can be installed with Neutron. Each
sub-project registers its own alembic branch which is responsible for migrating
the schemas of the tables owned by the sub-project.</p>
<p>The neutron-db-manage script detects which sub-projects have been installed by
enumerating the <code class="docutils literal"><span class="pre">neutron.db.alembic_migrations</span></code> entrypoints. For more details
see the <a class="reference external" href="contribute.html#entry-points">Entry Points section of Contributing extensions to Neutron</a>.</p>
<p>The neutron-db-manage script runs the given alembic command against all
installed sub-projects. (An exception is the <code class="docutils literal"><span class="pre">revision</span></code> command, which is
discussed in the <a class="reference internal" href="#developers">Developers</a> section below.)</p>
</div>
<div class="section" id="offline-online-migrations">
<h3>2. Offline/Online Migrations<a class="headerlink" href="#offline-online-migrations" title="Permalink to this headline">¶</a></h3>
<p>Since Liberty, Neutron maintains two parallel alembic migration branches.</p>
<p>The first one, called &#8216;expand&#8217;, is used to store expansion-only migration
rules. Those rules are strictly additive and can be applied while
neutron-server is running. Examples of additive database schema changes are:
creating a new table, adding a new table column, adding a new index, etc.</p>
<p>The second branch, called &#8216;contract&#8217;, is used to store those migration rules
that are not safe to apply while neutron-server is running. Those include:
column or table removal, moving data from one part of the database into another
(renaming a column, transforming single table into multiple, etc.), introducing
or modifying constraints, etc.</p>
<p>The intent of the split is to allow invoking those safe migrations from
&#8216;expand&#8217; branch while neutron-server is running, reducing downtime needed to
upgrade the service.</p>
<p>For more details, see the <a class="reference internal" href="#expand-and-contract-scripts">Expand and Contract Scripts</a> section below.</p>
</div>
</div>
<div class="section" id="developers">
<h2>Developers<a class="headerlink" href="#developers" title="Permalink to this headline">¶</a></h2>
<p>A database migration script is required when you submit a change to Neutron or
a sub-project that alters the database model definition. The migration script
is a special python file that includes code to upgrade the database to match
the changes in the model definition. Alembic will execute these scripts in
order to provide a linear migration path between revisions. The
neutron-db-manage command can be used to generate migration scripts for you to
complete. The operations in the template are those supported by the Alembic
migration library.</p>
<div class="section" id="running-neutron-db-manage-without-devstack">
<span id="neutron-db-manage-without-devstack"></span><h3>Running neutron-db-manage without devstack<a class="headerlink" href="#running-neutron-db-manage-without-devstack" title="Permalink to this headline">¶</a></h3>
<p>When, as a developer, you want to work with the Neutron DB schema and alembic
migrations only, it can be rather tedious to rely on devstack just to get an
up-to-date neutron-db-manage installed. This section describes how to work on
the schema and migration scripts with just the unit test virtualenv and
mysql. You can also operate on a separate test database so you don&#8217;t mess up
the installed Neutron database.</p>
<div class="section" id="setting-up-the-environment">
<h4>Setting up the environment<a class="headerlink" href="#setting-up-the-environment" title="Permalink to this headline">¶</a></h4>
<div class="section" id="install-mysql-service">
<h5>Install mysql service<a class="headerlink" href="#install-mysql-service" title="Permalink to this headline">¶</a></h5>
<p>This only needs to be done once since it is a system install. If you have run
devstack on your system before, then the mysql service is already installed and
you can skip this step.</p>
<p>Mysql must be configured as installed by devstack, and the following script
accomplishes this without actually running devstack:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>INSTALL_MYSQL_ONLY=True ./tools/configure_for_func_testing.sh ../devstack
</pre></div>
</div>
<p>Run this from the root of the neutron repo. It assumes an up-to-date clone of
the devstack repo is in <code class="docutils literal"><span class="pre">../devstack</span></code>.</p>
<p>Note that you must know the mysql root password. It is derived from (in order
of precedence):</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">$MYSQL_PASSWORD</span></code> in your environment</li>
<li><code class="docutils literal"><span class="pre">$MYSQL_PASSWORD</span></code> in <code class="docutils literal"><span class="pre">../devstack/local.conf</span></code></li>
<li><code class="docutils literal"><span class="pre">$MYSQL_PASSWORD</span></code> in <code class="docutils literal"><span class="pre">../devstack/localrc</span></code></li>
<li>default of &#8216;secretmysql&#8217; from <code class="docutils literal"><span class="pre">tools/configure_for_func_testing.sh</span></code></li>
</ul>
</div>
<div class="section" id="work-on-a-test-database">
<h5>Work on a test database<a class="headerlink" href="#work-on-a-test-database" title="Permalink to this headline">¶</a></h5>
<p>Rather than using the neutron database when working on schema and alembic
migration script changes, we can work on a test database. In the examples
below, we use a database named <code class="docutils literal"><span class="pre">testdb</span></code>.</p>
<p>To create the database:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mysql -e &quot;create database testdb;&quot;
</pre></div>
</div>
<p>You will often need to clear it to re-run operations from a blank database:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mysql -e &quot;drop database testdb; create database testdb;&quot;
</pre></div>
</div>
<p>To work on the test database instead of the neutron database, point to it with
the <code class="docutils literal"><span class="pre">--database-connection</span></code> option:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage --database-connection mysql+pymysql://root:secretmysql@127.0.0.1/testdb?charset=utf8 &lt;commands&gt;
</pre></div>
</div>
<p>You may find it convenient to set up an alias (in your .bashrc) for this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>alias test-db-manage=&#39;neutron-db-manage --database-connection mysql+pymysql://root:secretmysql@127.0.0.1/testdb?charset=utf8&#39;
</pre></div>
</div>
</div>
<div class="section" id="create-and-activate-the-virtualenv">
<h5>Create and activate the virtualenv<a class="headerlink" href="#create-and-activate-the-virtualenv" title="Permalink to this headline">¶</a></h5>
<p>From the root of the neutron (or sub-project) repo directory, run:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tox --notest -r -e py27
source .tox/py27/bin/activate
</pre></div>
</div>
<p>Now you can use the <code class="docutils literal"><span class="pre">test-db-manage</span></code> alias in place of <code class="docutils literal"><span class="pre">neutron-db-manage</span></code>
in the script auto-generation instructions below.</p>
<p>When you are done, exit the virtualenv:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">deactivate</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="script-auto-generation">
<h3>Script Auto-generation<a class="headerlink" href="#script-auto-generation" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to auto-generate an alembic migration script for a
model change. You may either use the system installed devstack environment, or
a virtualenv + testdb environment as described in
<a class="reference internal" href="#neutron-db-manage-without-devstack"><span>Running neutron-db-manage without devstack</span></a>.</p>
<p>Stop the neutron service. Work from the base directory of the neutron (or
sub-project) repo. Check out the master branch and do <code class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span></code> to
ensure it is fully up to date. Check out your development branch and rebase to
master.</p>
<p><strong>NOTE:</strong> Make sure you have not updated the <code class="docutils literal"><span class="pre">CONTRACT_HEAD</span></code> or
<code class="docutils literal"><span class="pre">EXPAND_HEAD</span></code> yet at this point.</p>
<p>Start with an empty database and upgrade to heads:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mysql -e &quot;drop database neutron; create database neutron;&quot;
neutron-db-manage upgrade heads
</pre></div>
</div>
<p>The database schema is now created without your model changes. The alembic
<code class="docutils literal"><span class="pre">revision</span> <span class="pre">--autogenerate</span></code> command will look for differences between the
schema generated by the upgrade command and the schema defined by the models,
including your model updates:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage revision -m &quot;description of revision&quot; --autogenerate
</pre></div>
</div>
<p>This generates a prepopulated template with the changes needed to match the
database state with the models.  You should inspect the autogenerated template
to ensure that the proper models have been altered.
When running the above command you will probably get the following error
message:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>Multiple heads are present; please specify the head revision on which the
new revision should be based, or perform a merge.
</pre></div>
</div>
<p>This is alembic telling you that it does not know which branch (contract or
expand) to generate the revision for. You must decide, based on whether you
are doing contracting or expanding changes to the schema, and provide either
the <code class="docutils literal"><span class="pre">--contract</span></code> or <code class="docutils literal"><span class="pre">--expand</span></code> option. If you have both types of changes,
you must run the command twice, once with each option, and then manually edit
the generated revision scripts to separate the migration operations.</p>
<p>In rare circumstances, you may want to start with an empty migration template
and manually author the changes necessary for an upgrade.  You can create a
blank file for a branch via:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage revision -m &quot;description of revision&quot; --expand
neutron-db-manage revision -m &quot;description of revision&quot; --contract
</pre></div>
</div>
<p><strong>NOTE:</strong> If you use above command you should check that migration is created
in a directory that is named as current release. If not, please raise the issue
with the development team (IRC, mailing list, launchpad bug).</p>
<p><strong>NOTE:</strong> The &#8220;description of revision&#8221; text should be a simple English
sentence. The first 30 characters of the description will be used in the file
name for the script, with underscores substituted for spaces. If the truncation
occurs at an awkward point in the description, you can modify the script file
name manually before committing.</p>
<p>The timeline on each alembic branch should remain linear and not interleave
with other branches, so that there is a clear path when upgrading. To verify
that alembic branches maintain linear timelines, you can run this command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage check_migration
</pre></div>
</div>
<p>If this command reports an error, you can troubleshoot by showing the migration
timelines using the <code class="docutils literal"><span class="pre">history</span></code> command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage history
</pre></div>
</div>
</div>
<div class="section" id="expand-and-contract-scripts">
<h3>Expand and Contract Scripts<a class="headerlink" href="#expand-and-contract-scripts" title="Permalink to this headline">¶</a></h3>
<p>The obsolete &#8220;branchless&#8221; design of a migration script included that it
indicates a specific &#8220;version&#8221; of the schema, and includes directives that
apply all necessary changes to the database at once.  If we look for example at
the script <code class="docutils literal"><span class="pre">2d2a8a565438_hierarchical_binding.py</span></code>, we will see:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># .../alembic_migrations/versions/2d2a8a565438_hierarchical_binding.py</span>

<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>

    <span class="c1"># .. inspection code ...</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;ml2_port_binding_levels&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;port_id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">36</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="c1"># ... more columns ...</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">port_binding_tables</span><span class="p">:</span>
        <span class="n">op</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span>
            <span class="s2">&quot;INSERT INTO ml2_port_binding_levels &quot;</span>
            <span class="s2">&quot;SELECT port_id, host, 0 AS level, driver, segment AS segment_id &quot;</span>
            <span class="s2">&quot;FROM </span><span class="si">%s</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;WHERE host &lt;&gt; &#39;&#39; &quot;</span>
            <span class="s2">&quot;AND driver &lt;&gt; &#39;&#39;;&quot;</span>
        <span class="p">)</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>

    <span class="n">op</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span><span class="n">fk_name_dvr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;foreignkey&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;cap_port_filter&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;segment&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">)</span>

    <span class="c1"># ... more DROP instructions ...</span>
</pre></div>
</div>
<p>The above script contains directives that are both under the &#8220;expand&#8221;
and &#8220;contract&#8221; categories, as well as some data migrations.  the <code class="docutils literal"><span class="pre">op.create_table</span></code>
directive is an &#8220;expand&#8221;; it may be run safely while the old version of the
application still runs, as the old code simply doesn&#8217;t look for this table.
The <code class="docutils literal"><span class="pre">op.drop_constraint</span></code> and <code class="docutils literal"><span class="pre">op.drop_column</span></code> directives are
&#8220;contract&#8221; directives (the drop column more so than the drop constraint); running
at least the <code class="docutils literal"><span class="pre">op.drop_column</span></code> directives means that the old version of the
application will fail, as it will attempt to access these columns which no longer
exist.</p>
<p>The data migrations in this script are adding new
rows to the newly added <code class="docutils literal"><span class="pre">ml2_port_binding_levels</span></code> table.</p>
<p>Under the new migration script directory structure, the above script would be
stated as two scripts; an &#8220;expand&#8221; and a &#8220;contract&#8221; script:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># expansion operations</span>
<span class="c1"># .../alembic_migrations/versions/liberty/expand/2bde560fc638_hierarchical_binding.py</span>

<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;ml2_port_binding_levels&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;port_id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">36</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="c1"># ... more columns ...</span>
    <span class="p">)</span>


<span class="c1"># contraction operations</span>
<span class="c1"># .../alembic_migrations/versions/liberty/contract/4405aedc050e_hierarchical_binding.py</span>

<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>

    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">port_binding_tables</span><span class="p">:</span>
        <span class="n">op</span><span class="o">.</span><span class="n">execute</span><span class="p">((</span>
            <span class="s2">&quot;INSERT INTO ml2_port_binding_levels &quot;</span>
            <span class="s2">&quot;SELECT port_id, host, 0 AS level, driver, segment AS segment_id &quot;</span>
            <span class="s2">&quot;FROM </span><span class="si">%s</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;WHERE host &lt;&gt; &#39;&#39; &quot;</span>
            <span class="s2">&quot;AND driver &lt;&gt; &#39;&#39;;&quot;</span>
        <span class="p">)</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>

    <span class="n">op</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span><span class="n">fk_name_dvr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;foreignkey&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;cap_port_filter&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;segment&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;ml2_dvr_port_bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;driver&#39;</span><span class="p">)</span>

    <span class="c1"># ... more DROP instructions ...</span>
</pre></div>
</div>
<p>The two scripts would be present in different subdirectories and also part of
entirely separate versioning streams.  The &#8220;expand&#8221; operations are in the
&#8220;expand&#8221; script, and the &#8220;contract&#8221; operations are in the &#8220;contract&#8221; script.</p>
<p>For the time being, data migration rules also belong to contract branch. There
is expectation that eventually live data migrations move into middleware that
will be aware about different database schema elements to converge on, but
Neutron is still not there.</p>
<p>Scripts that contain only expansion or contraction rules do not require a split
into two parts.</p>
<p>If a contraction script depends on a script from expansion stream, the
following directive should be added in the contraction script:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">depends_on</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;expansion-revision&gt;&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<div class="section" id="expand-and-contract-branch-exceptions">
<h3>Expand and Contract Branch Exceptions<a class="headerlink" href="#expand-and-contract-branch-exceptions" title="Permalink to this headline">¶</a></h3>
<p>In some cases, we have to have &#8220;expand&#8221; operations in contract migrations. For
example, table &#8216;networksegments&#8217; was renamed in contract migration, so all
operations with this table are required to be in contract branch as well.
For such cases, we use the <code class="docutils literal"><span class="pre">contract_creation_exceptions</span></code> that should be
implemented as part of such migrations. This is needed to get functional tests
pass.</p>
<p>Usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">contract_creation_exceptions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Docstring should explain why we allow such exception for contract</span>
<span class="sd">    branch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">sqlalchemy_obj_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="c1"># For example: sa.Column: [&#39;subnets.segment_id&#39;]</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="head-files-for-conflict-management">
<h3>HEAD files for conflict management<a class="headerlink" href="#head-files-for-conflict-management" title="Permalink to this headline">¶</a></h3>
<p>In directory <code class="docutils literal"><span class="pre">neutron/db/migration/alembic_migrations/versions</span></code> there are two
files, <code class="docutils literal"><span class="pre">CONTRACT_HEAD</span></code> and <code class="docutils literal"><span class="pre">EXPAND_HEAD</span></code>. These files contain the ID of the
head revision in each branch. The purpose of these files is to validate the
revision timelines and prevent non-linear changes from entering the merge queue.</p>
<p>When you create a new migration script by neutron-db-manage these files will be
updated automatically. But if another migration script is merged while your
change is under review, you will need to resolve the conflict manually by
changing the <code class="docutils literal"><span class="pre">down_revision</span></code> in your migration script.</p>
</div>
<div class="section" id="applying-database-migration-rules">
<h3>Applying database migration rules<a class="headerlink" href="#applying-database-migration-rules" title="Permalink to this headline">¶</a></h3>
<p>To apply just expansion rules, execute:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade --expand
</pre></div>
</div>
<p>After the first step is done, you can stop neutron-server, apply remaining
non-expansive migration rules, if any:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade --contract
</pre></div>
</div>
<p>and finally, start your neutron-server again.</p>
<p>If you have multiple neutron-server instances in your cloud, and there are
pending contract scripts not applied to the database, full shutdown of all
those services is required before &#8216;upgrade &#8211;contract&#8217; is executed. You can
determine whether there are any pending contract scripts by checking the
message returned from the following command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage has_offline_migrations
</pre></div>
</div>
<p>If you are not interested in applying safe migration rules while the service is
running, you can still upgrade database the old way, by stopping the service,
and then applying all available rules:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade head[s]
</pre></div>
</div>
<p>It will apply all the rules from both the expand and the contract branches, in
proper order.</p>
</div>
<div class="section" id="tagging-milestone-revisions">
<h3>Tagging milestone revisions<a class="headerlink" href="#tagging-milestone-revisions" title="Permalink to this headline">¶</a></h3>
<p>When named release (liberty, mitaka, etc.) is done for neutron or a
sub-project, the alembic revision scripts at the head of each branch for that
release must be tagged. This is referred to as a milestone revision tag.</p>
<p>For example, <a class="reference external" href="https://review.openstack.org/228272">here</a> is a patch that tags
the liberty milestone revisions for the neutron-fwaas sub-project. Note that
each branch (expand and contract) is tagged.</p>
<p>Tagging milestones allows neutron-db-manage to upgrade the schema to a
milestone release, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>neutron-db-manage upgrade liberty
</pre></div>
</div>
</div>
<div class="section" id="generation-of-comparable-metadata-with-current-database-schema">
<h3>Generation of comparable metadata with current database schema<a class="headerlink" href="#generation-of-comparable-metadata-with-current-database-schema" title="Permalink to this headline">¶</a></h3>
<p>Directory <code class="docutils literal"><span class="pre">neutron/db/migration/models</span></code> contains module <code class="docutils literal"><span class="pre">head.py</span></code>, which
provides all database models at current HEAD. Its purpose is to create
comparable metadata with the current database schema. The database schema is
generated by alembic migration scripts. The models must match, and this is
verified by a model-migration sync test in Neutron&#8217;s functional test suite.
That test requires all modules containing DB models to be imported by head.py
in order to make a complete comparison.</p>
<p>When adding new database models, developers must update this module, otherwise
the change will fail to merge.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Alembic Migrations</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#the-migration-wrapper">The Migration Wrapper</a></li>
<li><a class="reference internal" href="#migration-branches">Migration Branches</a><ul>
<li><a class="reference internal" href="#independent-sub-project-tables">1. Independent Sub-Project Tables</a></li>
<li><a class="reference internal" href="#offline-online-migrations">2. Offline/Online Migrations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#developers">Developers</a><ul>
<li><a class="reference internal" href="#running-neutron-db-manage-without-devstack">Running neutron-db-manage without devstack</a><ul>
<li><a class="reference internal" href="#setting-up-the-environment">Setting up the environment</a><ul>
<li><a class="reference internal" href="#install-mysql-service">Install mysql service</a></li>
<li><a class="reference internal" href="#work-on-a-test-database">Work on a test database</a></li>
<li><a class="reference internal" href="#create-and-activate-the-virtualenv">Create and activate the virtualenv</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#script-auto-generation">Script Auto-generation</a></li>
<li><a class="reference internal" href="#expand-and-contract-scripts">Expand and Contract Scripts</a></li>
<li><a class="reference internal" href="#expand-and-contract-branch-exceptions">Expand and Contract Branch Exceptions</a></li>
<li><a class="reference internal" href="#head-files-for-conflict-management">HEAD files for conflict management</a></li>
<li><a class="reference internal" href="#applying-database-migration-rules">Applying database migration rules</a></li>
<li><a class="reference internal" href="#tagging-milestone-revisions">Tagging milestone revisions</a></li>
<li><a class="reference internal" href="#generation-of-comparable-metadata-with-current-database-schema">Generation of comparable metadata with current database schema</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="client_command_extensions.html"
                                  title="previous chapter">Client command extension support</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="services_and_agents.html"
                                  title="next chapter">Services and agents</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/neutron
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/devref/alembic_migrations.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="services_and_agents.html" title="Services and agents"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="client_command_extensions.html" title="Client command extension support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">neutron 10.0.0.0rc2.dev58 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Developer Guide</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2011-present, OpenStack Foundation..
      Last updated on Feb 14, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/neutron");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>