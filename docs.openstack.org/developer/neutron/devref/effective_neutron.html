<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Effective Neutron: 100 specific ways to improve your Neutron contributions &mdash; neutron 10.0.0.0rc2.dev58 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '10.0.0.0rc2.dev58',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="neutron 10.0.0.0rc2.dev58 documentation" href="../index.html" />
    <link rel="up" title="Developer Guide" href="index.html" />
    <link rel="next" title="Setting Up a Development Environment" href="development.environment.html" />
    <link rel="prev" title="Developer Guide" href="index.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="effective-neutron-100-specific-ways-to-improve-your-neutron-contributions">
<h1>Effective Neutron: 100 specific ways to improve your Neutron contributions<a class="headerlink" href="#effective-neutron-100-specific-ways-to-improve-your-neutron-contributions" title="Permalink to this headline">¶</a></h1>
<p>There are a number of skills that make a great Neutron developer: writing good
code, reviewing effectively, listening to peer feedback, etc. The objective of
this document is to describe, by means of examples, the pitfalls, the good and
bad practices that &#8216;we&#8217; as project encounter on a daily basis and that make us
either go slower or accelerate while contributing to Neutron.</p>
<p>By reading and collaboratively contributing to such a knowledge base, your
development and review cycle becomes shorter, because you will learn (and teach
to others after you) what to watch out for, and how to be proactive in order
to prevent negative feedback, minimize programming errors, writing better
tests, and so on and so forth...in a nutshell, how to become an effective Neutron
developer.</p>
<p>The notes below are meant to be free-form and brief by design. They are not meant
to replace or duplicate <a class="reference external" href="http://docs.openstack.org">OpenStack documentation</a>,
or any project-wide documentation initiative like <a class="reference external" href="http://docs.openstack.org/infra/manual/developers.html#peer-review">peer-review notes</a>
or the <a class="reference external" href="http://docs.openstack.org/project-team-guide/">team guide</a>. For this
reason, references are acceptable and should be favored, if the shortcut is
deemed useful to expand on the distilled information.
We will try to keep these notes tidy by breaking them down into sections if it
makes sense. Feel free to add, adjust, remove as you see fit. Please do so,
taking into consideration yourself and other Neutron developers as readers.
Capture your experience during development and review and add any comment that
you believe will make your life and others&#8217; easier.</p>
<p>Happy hacking!</p>
<div class="section" id="developing-better-software">
<h2>Developing better software<a class="headerlink" href="#developing-better-software" title="Permalink to this headline">¶</a></h2>
<div class="section" id="plugin-development">
<h3>Plugin development<a class="headerlink" href="#plugin-development" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done during plugin development.</p>
<ul class="simple">
<li>Use mixin classes as last resort. They can be a powerful tool to add behavior
but their strength is also a weakness, as they can introduce <a class="reference external" href="https://review.openstack.org/#/c/121290/">unpredictable</a>
behavior to the <a class="reference external" href="https://www.python.org/download/releases/2.3/mro/">MRO</a>,
amongst other issues.</li>
<li>In lieu of mixins, if you need to add behavior that is relevant for ML2,
consider using the <a class="reference external" href="http://specs.openstack.org/openstack/neutron-specs/specs/juno/neutron-ml2-mechanismdriver-extensions.html">extension manager</a>.</li>
<li>If you make changes to the DB class methods, like calling methods that can
be inherited, think about what effect that may have to plugins that have
controller <a class="reference external" href="https://review.openstack.org/#/c/116924/">backends</a>.</li>
<li>If you make changes to the ML2 plugin or components used by the ML2 plugin,
think about the <a class="reference external" href="http://lists.openstack.org/pipermail/openstack-dev/2015-October/076134.html">effect</a>
that may have to other plugins.</li>
<li>When adding behavior to the L2 and L3 db base classes, do not assume that
there is an agent on the other side of the message broker that interacts
with the server. Plugins may not rely on <a class="reference external" href="https://review.openstack.org/#/c/174020/">agents</a> at all.</li>
<li>Be mindful of required capabilities when you develop plugin extensions. The
<a class="reference external" href="https://github.com/openstack/neutron/blob/b14c06b5/neutron/api/extensions.py#L122">Extension description</a> provides the ability to specify the list of required capabilities
for the extension you are developing. By declaring this list, the server will
not start up if the requirements are not met, thus avoiding leading the system
to experience undetermined behavior at runtime.</li>
</ul>
</div>
<div class="section" id="database-interaction">
<h3>Database interaction<a class="headerlink" href="#database-interaction" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done during database development.</p>
<ul>
<li><p class="first"><a class="reference external" href="http://docs.sqlalchemy.org/en/rel_1_0/orm/query.html#sqlalchemy.orm.query.Query.first">first()</a>
does not raise an exception.</p>
</li>
<li><p class="first">Do not use <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_1_0/orm/query.html#sqlalchemy.orm.query.Query.delete">delete()</a>
to remove objects. A delete query does not load the object so no sqlalchemy events
can be triggered that would do things like recalculate quotas or update revision
numbers of parent objects. For more details on all of the things that can go wrong
using bulk delete operations, see the &#8220;Warning&#8221; sections in the link above.</p>
</li>
<li><p class="first">For PostgreSQL if you&#8217;re using GROUP BY everything in the SELECT list must be
an aggregate SUM(...), COUNT(...), etc or used in the GROUP BY.</p>
<p>The incorrect variant:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Object</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>The correct variant:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Object</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Object</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Beware of the <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/faq/sessions.html#this-session-s-transaction-has-been-rolled-back-due-to-a-previous-exception-during-flush-or-similar">InvalidRequestError</a> exception.
There is even a <a class="reference external" href="https://bugs.launchpad.net/neutron/+bug/1409774">Neutron bug</a>
registered for it. Bear in mind that this error may also occur when nesting
transaction blocks, and the innermost block raises an error without proper
rollback. Consider if <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_1_0/orm/session_transaction.html#using-savepoint">savepoints</a>
can fit your use case.</p>
</li>
<li><p class="first">When designing data models that are related to each other, be careful to how
you model the relationships&#8217; loading <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/loading_relationships.html#using-loader-strategies-lazy-loading-eager-loading">strategy</a>. For instance a joined relationship can
be very efficient over others (some examples include <a class="reference external" href="https://review.openstack.org/#/c/88665/">router gateways</a>
or <a class="reference external" href="https://review.openstack.org/#/c/257086/">network availability zones</a>).</p>
</li>
<li><p class="first">If you add a relationship to a Neutron object that will be referenced in the
majority of cases where the object is retrieved, be sure to use the
lazy=&#8217;joined&#8217; parameter to the relationship so the related objects are loaded
as part of the same query. Otherwise, the default method is &#8216;select&#8217;, which
emits a new DB query to retrieve each related object adversely impacting
performance. For example, see <a class="reference external" href="https://review.openstack.org/#/c/88665/">patch 88665</a>
which resulted in a significant improvement since router retrieval functions
always include the gateway interface.</p>
</li>
<li><p class="first">Conversely, do not use lazy=&#8217;joined&#8217; if the relationship is only used in
corner cases because the JOIN statement comes at a cost that may be
significant if the relationship contains many objects. For example, see
<a class="reference external" href="https://review.openstack.org/#/c/168214/">patch 168214</a> which reduced a
subnet retrieval by ~90% by avoiding a join to the IP allocation table.</p>
</li>
<li><p class="first">When writing extensions to existing objects (e.g. Networks), ensure that
they are written in a way that the data on the object can be calculated
without additional DB lookup. If that&#8217;s not possible, ensure the DB lookup
is performed once in bulk during a list operation. Otherwise a list call
for a 1000 objects will change from a constant small number of DB queries
to 1000 DB queries. For example, see
<a class="reference external" href="https://review.openstack.org/#/c/257086/">patch 257086</a> which changed the
availability zone code from the incorrect style to a database friendly one.</p>
</li>
<li><p class="first">Sometimes in code we use the following structures:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create</span><span class="p">():</span>
   <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="n">create_something</span><span class="p">()</span>
       <span class="k">try</span><span class="p">:</span>
           <span class="n">_do_other_thing_with_created_object</span><span class="p">()</span>
       <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
           <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
               <span class="n">delete_something</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_do_other_thing_with_created_object</span><span class="p">():</span>
   <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">subtransactions</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
       <span class="o">....</span>
</pre></div>
</div>
<p>The problem is that when exception is raised in <code class="docutils literal"><span class="pre">_do_other_thing_with_created_object</span></code>
it is caught in except block, but the object cannot be deleted in except
section because internal transaction from <code class="docutils literal"><span class="pre">_do_other_thing_with_created_object</span></code>
has been rolled back. To avoid this nested transactions should be used.
For such cases help function <code class="docutils literal"><span class="pre">safe_creation</span></code> has been created in
<code class="docutils literal"><span class="pre">neutron/db/_utils.py</span></code>.
So, the example above should be replaced with:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">_safe_creation</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">create_something</span><span class="p">,</span> <span class="n">delete_something</span><span class="p">,</span>
               <span class="n">_do_other_thing_with_created_object</span><span class="p">)</span>
</pre></div>
</div>
<p>Where nested transaction is used in _do_other_thing_with_created_object
function.</p>
<p>The <code class="docutils literal"><span class="pre">_safe_creation</span> <span class="pre">function</span> <span class="pre">can</span> <span class="pre">also</span> <span class="pre">be</span> <span class="pre">passed</span> <span class="pre">the</span> <span class="pre">``transaction=False</span></code>
argument to prevent any transaction from being created just to leverage
the automatic deletion on exception logic.</p>
</li>
<li><p class="first">Beware of ResultProxy.inserted_primary_key which returns a list of last
inserted primary keys not the last inserted primary key:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">mymodel</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">))</span>
<span class="c1"># result.inserted_primary_key is a list even if we inserted a unique row!</span>
</pre></div>
</div>
</li>
<li><p class="first">Beware of pymysql which can silently unwrap a list with an element (and hide
a wrong use of ResultProxy.inserted_primary_key for example):</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table if not exists foo (bar integer)&quot;</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</pre></div>
</div>
<p>The 2nd insert should crash (list provided, integer expected). It crashes at
least with mysql and postgresql backends, but succeeds with pymysql because
it transforms them into:</p>
<div class="code sql highlight-python"><div class="highlight"><pre><span></span>INSERT INTO foo (bar) VALUES (1)
INSERT INTO foo (bar) VALUES ((2))
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="system-development">
<h3>System development<a class="headerlink" href="#system-development" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when invoking system commands
and interacting with linux utils.</p>
<ul class="simple">
<li>When a patch requires a new platform tool or a new feature in an existing
tool, check if common platforms ship packages with the aforementioned
feature. Also, tag such a patch with <code class="docutils literal"><span class="pre">UpgradeImpact</span></code> to raise its
visibility (as these patches are brought up to the attention of the core team
during team meetings). More details in <a class="reference external" href="http://docs.openstack.org/developer/neutron/policies/code-reviews.html#neutron-spec-review-practices">review guidelines</a>.</li>
</ul>
</div>
<div class="section" id="eventlet-concurrent-model">
<h3>Eventlet concurrent model<a class="headerlink" href="#eventlet-concurrent-model" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when using eventlet and monkey
patching.</p>
<ul class="simple">
<li>Do not use with_lockmode(&#8216;update&#8217;) on SQL queries without protecting the operation
with a lockutils semaphore. For some SQLAlchemy database drivers that operators may
choose (e.g. MySQLdb) it may result in a temporary deadlock by yielding to another
coroutine while holding the DB lock. The following wiki provides more details:
<a class="reference external" href="https://wiki.openstack.org/wiki/OpenStack_and_SQLAlchemy#MySQLdb_.2B_eventlet_.3D_sad">https://wiki.openstack.org/wiki/OpenStack_and_SQLAlchemy#MySQLdb_.2B_eventlet_.3D_sad</a></li>
</ul>
</div>
<div class="section" id="mocking-and-testing">
<h3>Mocking and testing<a class="headerlink" href="#mocking-and-testing" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when writing tests, any test.
For anything more elaborate, please visit the testing section.</p>
<ul>
<li><p class="first">Preferring low level testing versus full path testing (e.g. not testing database
via client calls). The former is to be favored in unit testing, whereas the latter
is to be favored in functional testing.</p>
</li>
<li><p class="first">Prefer specific assertions (assert(Not)In, assert(Not)IsInstance, assert(Not)IsNone,
etc) over generic ones (assertTrue/False, assertEqual) because they raise more
meaningful errors:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="c1"># raise meaningful error: &quot;MismatchError: 3 not in [1, 2]&quot;</span>

<span class="k">def</span> <span class="nf">test_generic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="mi">3</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="c1"># raise meaningless error: &quot;AssertionError: False is not true&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Use the pattern &#8220;self.assertEqual(expected, observed)&#8221; not the opposite, it helps
reviewers to understand which one is the expected/observed value in non-trivial
assertions. The expected and observed values are also labeled in the output when
the assertion fails.</p>
</li>
<li><p class="first">Prefer specific assertions (assertTrue, assertFalse) over assertEqual(True/False, observed).</p>
</li>
<li><p class="first">Don&#8217;t write tests that don&#8217;t test the intended code. This might seem silly but
it&#8217;s easy to do with a lot of mocks in place. Ensure that your tests break as
expected before your code change.</p>
</li>
<li><p class="first">Avoid heavy use of the mock library to test your code. If your code requires more
than one mock to ensure that it does the correct thing, it needs to be refactored
into smaller, testable units. Otherwise we depend on fullstack/tempest/api tests
to test all of the real behavior and we end up with code containing way too many
hidden dependencies and side effects.</p>
</li>
<li><p class="first">All behavior changes to fix bugs should include a test that prevents a
regression. If you made a change and it didn&#8217;t break a test, it means the
code was not adequately tested in the first place, it&#8217;s not an excuse to leave
it untested.</p>
</li>
<li><p class="first">Test the failure cases. Use a mock side effect to throw the necessary
exceptions to test your &#8216;except&#8217; clauses.</p>
</li>
<li><p class="first">Don&#8217;t mimic existing tests that violate these guidelines. We are attempting to
replace all of these so more tests like them create more work. If you need help
writing a test, reach out to the testing lieutenants and the team on IRC.</p>
</li>
<li><p class="first">Mocking open() is a dangerous practice because it can lead to unexpected
bugs like <a class="reference external" href="https://bugs.launchpad.net/neutron/+bug/1503847">bug 1503847</a>.
In fact, when the built-in open method is mocked during tests, some
utilities (like debtcollector) may still rely on the real thing, and may
end up using the mock rather what they are really looking for. If you must,
consider using <a class="reference external" href="https://review.openstack.org/#/c/232716/">OpenFixture</a>, but
it is better not to mock open() at all.</p>
</li>
</ul>
</div>
<div class="section" id="backward-compatibility">
<h3>Backward compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when extending the RPC Interfaces.</p>
<ul class="simple">
<li>Make yourself familiar with <a class="reference internal" href="upgrade.html#upgrade-review-guidelines"><span>Upgrade review guidelines</span></a>.</li>
</ul>
<div class="section" id="deprecation">
<h4>Deprecation<a class="headerlink" href="#deprecation" title="Permalink to this headline">¶</a></h4>
<p>Sometimes we want to refactor things in a non-backward compatible way. In most
cases you can use <a class="reference external" href="http://docs.openstack.org/developer/debtcollector">debtcollector</a> to mark things for
deprecation. Config items have <a class="reference external" href="http://docs.openstack.org/developer/oslo.config/opts.html">deprecation options supported by oslo.config</a>.</p>
<p>The deprecation process must follow the <a class="reference external" href="http://governance.openstack.org/reference/tags/assert_follows-standard-deprecation.html#requirements">standard deprecation requirements</a>.
In terms of neutron development, this means:</p>
<ul class="simple">
<li>A launchpad bug to track the deprecation.</li>
<li>A patch to mark the deprecated items. If the deprecation affects
users (config items, API changes) then a <a class="reference external" href="http://docs.openstack.org/developer/reno/usage.html">release note</a> must be
included.</li>
<li>Wait at least one cycle and at least three months linear time.</li>
<li>A patch that removes the deprecated items. Make sure to refer to the
original launchpad bug in the commit message of this patch.</li>
</ul>
</div>
</div>
<div class="section" id="scalability-issues">
<h3>Scalability issues<a class="headerlink" href="#scalability-issues" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when writing code that needs to process
a lot of data.</p>
</div>
<div class="section" id="translation-and-logging">
<h3>Translation and logging<a class="headerlink" href="#translation-and-logging" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when instrumenting your code.</p>
<ul class="simple">
<li>Make yourself familiar with <a class="reference external" href="http://specs.openstack.org/openstack/openstack-specs/specs/log-guidelines.html#definition-of-log-levels">OpenStack logging guidelines</a>
to avoid littering the logs with traces logged at inappropriate levels.</li>
<li>The logger should only be passed unicode values. For example, do not pass it
exceptions or other objects directly (LOG.error(exc), LOG.error(port), etc.).
See <a class="reference external" href="http://docs.openstack.org/developer/oslo.log/usage.html#no-more-implicit-conversion-to-unicode-str">http://docs.openstack.org/developer/oslo.log/usage.html#no-more-implicit-conversion-to-unicode-str</a>
for more details.</li>
<li>Don&#8217;t pass exceptions into LOG.exception: it is already implicitly included
in the log message by Python logging module.</li>
<li>Don&#8217;t use LOG.exception when there is no exception registered in current
thread context: Python 3.x versions before 3.5 are known to fail on it.</li>
</ul>
</div>
<div class="section" id="project-interfaces">
<h3>Project interfaces<a class="headerlink" href="#project-interfaces" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when writing code that is used
to interface with other projects, like Keystone or Nova.</p>
</div>
<div class="section" id="documenting-your-code">
<h3>Documenting your code<a class="headerlink" href="#documenting-your-code" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when writing docstrings.</p>
</div>
</div>
<div class="section" id="landing-patches-more-rapidly">
<h2>Landing patches more rapidly<a class="headerlink" href="#landing-patches-more-rapidly" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scoping-your-patch-appropriately">
<h3>Scoping your patch appropriately<a class="headerlink" href="#scoping-your-patch-appropriately" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Do not make multiple changes in one patch unless absolutely necessary.
Cleaning up nearby functions or fixing a small bug you noticed while working
on something else makes the patch very difficult to review. It also makes
cherry-picking and reverting very difficult.  Even apparently minor changes
such as reformatting whitespace around your change can burden reviewers and
cause merge conflicts.</li>
<li>If a fix or feature requires code refactoring, submit the refactoring as a
separate patch than the one that changes the logic. Otherwise
it&#8217;s difficult for a reviewer to tell the difference between mistakes
in the refactor and changes required for the fix/feature. If it&#8217;s a bug fix,
try to implement the fix before the refactor to avoid making cherry-picks to
stable branches difficult.</li>
<li>Consider your reviewers&#8217; time before submitting your patch. A patch that
requires many hours or days to review will sit in the &#8220;todo&#8221; list until
someone has many hours or days free (which may never happen.) If you can
deliver your patch in small but incrementally understandable and testable
pieces you will be more likely to attract reviewers.</li>
</ul>
</div>
<div class="section" id="nits-and-pedantic-comments">
<h3>Nits and pedantic comments<a class="headerlink" href="#nits-and-pedantic-comments" title="Permalink to this headline">¶</a></h3>
<p>Document common nits and pedantic comments to watch out for.</p>
<ul class="simple">
<li>Make sure you spell correctly, the best you can, no-one wants rebase generators at
the end of the release cycle!</li>
<li>The odd pep8 error may cause an entire CI run to be wasted. Consider running
validation (pep8 and/or tests) before submitting your patch. If you keep forgetting
consider installing a git <a class="reference external" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">hook</a>
so that Git will do it for you.</li>
<li>Sometimes, new contributors want to dip their toes with trivial patches, but we
at OpenStack <em>love</em> bike shedding and their patches may sometime stall. In
some extreme cases, the more trivial the patch, the higher the chances it fails
to merge. To ensure we as a team provide/have a frustration-free experience
new contributors should be redirected to fixing <a class="reference external" href="https://bugs.launchpad.net/neutron/+bugs?field.tag=low-hanging-fruit">low-hanging-fruit bugs</a>
that have a tangible positive impact to the codebase. Spelling mistakes, and
docstring are fine, but there is a lot more that is relatively easy to fix
and has a direct impact to Neutron users.</li>
</ul>
</div>
<div class="section" id="reviewer-comments">
<h3>Reviewer comments<a class="headerlink" href="#reviewer-comments" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Acknowledge them one by one by either clicking &#8216;Done&#8217; or by replying extensively.
If you do not, the reviewer won&#8217;t know whether you thought it was not important,
or you simply forgot. If the reply satisfies the reviewer, consider capturing the
input in the code/document itself so that it&#8217;s for reviewers of newer patchsets to
see (and other developers when the patch merges).</li>
<li>Watch for the feedback on your patches. Acknowledge it promptly and act on it
quickly, so that the reviewer remains engaged. If you disappear for a week after
you posted a patchset, it is very likely that the patch will end up being
neglected.</li>
<li>Do not take negative feedback personally. Neutron is a large project with lots
of contributors with different opinions on how things should be done. Many come
from widely varying cultures and languages so the English, text-only feedback
can unintentionally come across as harsh. Getting a -1 means reviewers are
trying to help get the patch into a state that can be merged, it doesn&#8217;t just
mean they are trying to block it. It&#8217;s very rare to get a patch merged on the
first iteration that makes everyone happy.</li>
</ul>
</div>
<div class="section" id="code-review">
<h3>Code Review<a class="headerlink" href="#code-review" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>You should visit <a class="reference external" href="https://wiki.openstack.org/wiki/How_To_Contribute#Reviewing">OpenStack How To Review wiki</a></li>
<li>Stay focussed and review what matters for the release. Please check out the Neutron
section for the <a class="reference external" href="http://status.openstack.org/reviews/">Gerrit dashboard</a>. The output
is generated by this <a class="reference external" href="https://github.com/openstack-infra/reviewday/blob/master/bin/neutron">tool</a>.</li>
</ul>
</div>
<div class="section" id="irc">
<h3>IRC<a class="headerlink" href="#irc" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>IRC is a place where you can speak with many of the Neutron developers and core
reviewers. For more information you should visit
<a class="reference external" href="http://wiki.openstack.org/wiki/IRC">OpenStack IRC wiki</a>
Neutron IRC channel is #openstack-neutron</li>
<li>There are weekly IRC meetings related to many different projects/teams
in Neutron.
A full list of these meetings and their date/time can be found in
<a class="reference external" href="http://eavesdrop.openstack.org">OpenStack IRC Meetings</a>.
It is important to attend these meetings in the area of your contribution
and possibly mention your work and patches.</li>
<li>When you have questions regarding an idea or a specific patch of yours, it
can be helpful to find a relevant person in IRC and speak with them about
it.
You can find a user&#8217;s IRC nickname in their launchpad account.</li>
<li>Being available on IRC is useful, since reviewers can contact
you directly to quickly clarify a review issue. This speeds
up the feedback loop.</li>
<li>Each area of Neutron or sub-project of Neutron has a specific lieutenant
in charge of it.
You can most likely find these lieutenants on IRC, it is advised however to try
and send public questions to the channel rather then to a specific person if possible.
(This increase the chances of getting faster answers to your questions).
A list of the areas and lieutenants nicknames can be found at
<a class="reference external" href="http://docs.openstack.org/developer/neutron/policies/neutron-teams.html">Core Reviewers</a>.</li>
</ul>
</div>
<div class="section" id="commit-messages">
<h3>Commit messages<a class="headerlink" href="#commit-messages" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when writing commit messages.
For more details see <a class="reference external" href="https://wiki.openstack.org/wiki/GitCommitMessages">Git commit message best practices</a>.
This is the TL;DR version with the important points for committing to Neutron.</p>
<ul class="simple">
<li>One liners are bad, unless the change is trivial.</li>
<li>Remember to use DocImpact, APIImpact, UpgradeImpact appropriately.</li>
<li>Make sure the commit message doesn&#8217;t have any spelling/grammar errors. This
is the first thing reviewers read and they can be distracting enough to
invite -1&#8217;s.</li>
<li>Describe what the change accomplishes. If it&#8217;s a bug fix, explain how this
code will fix the problem. If it&#8217;s part of a feature implementation, explain
what component of the feature the patch implements. Do not just describe the
bug, that&#8217;s what launchpad is for.</li>
<li>Use the &#8220;Closes-Bug: #BUG-NUMBER&#8221; tag if the patch addresses a bug. Submitting
a bugfix without a launchpad bug reference is unacceptable, even if it&#8217;s
trivial. Launchpad is how bugs are tracked so fixes without a launchpad bug are
a nightmare when users report the bug from an older version and the Neutron team
can&#8217;t tell if/why/how it&#8217;s been fixed. Launchpad is also how backports are
identified and tracked so patches without a bug report cannot be picked to stable
branches.</li>
<li>Use the &#8220;Implements: blueprint NAME-OF-BLUEPRINT&#8221; or &#8220;Partially-Implements:
blueprint NAME-OF-BLUEPRINT&#8221; for features so reviewers can determine if the
code matches the spec that was agreed upon. This also updates the blueprint
on launchpad so it&#8217;s easy to see all patches that are related to a feature.</li>
<li>If it&#8217;s not immediately obvious, explain what the previous code was doing
that was incorrect. (e.g. code assumed it would never get &#8216;None&#8217; from
a function call)</li>
<li>Be specific in your commit message about what the patch does and why it does
this. For example, &#8220;Fixes incorrect logic in security groups&#8221; is not helpful
because the code diff already shows that you are modifying security groups.
The message should be specific enough that a reviewer looking at the code can
tell if the patch does what the commit says in the most appropriate manner.
If the reviewer has to guess why you did something, lots of your time will be
wasted explaining why certain changes were made.</li>
</ul>
</div>
<div class="section" id="dealing-with-zuul">
<h3>Dealing with Zuul<a class="headerlink" href="#dealing-with-zuul" title="Permalink to this headline">¶</a></h3>
<p>Document common pitfalls as well as good practices done when dealing with OpenStack CI.</p>
<ul class="simple">
<li>When you submit a patch, consider checking its <a class="reference external" href="http://status.openstack.org/zuul/">status</a>
in the queue. If you see a job failures, you might as well save time and try to figure out
in advance why it is failing.</li>
<li>Excessive use of &#8216;recheck&#8217; to get test to pass is discouraged. Please examine the logs for
the failing test(s) and make sure your change has not tickled anything that might be causing
a new failure or race condition. Getting your change in could make it even harder to debug
what is actually broken later on.</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Effective Neutron: 100 specific ways to improve your Neutron contributions</a><ul>
<li><a class="reference internal" href="#developing-better-software">Developing better software</a><ul>
<li><a class="reference internal" href="#plugin-development">Plugin development</a></li>
<li><a class="reference internal" href="#database-interaction">Database interaction</a></li>
<li><a class="reference internal" href="#system-development">System development</a></li>
<li><a class="reference internal" href="#eventlet-concurrent-model">Eventlet concurrent model</a></li>
<li><a class="reference internal" href="#mocking-and-testing">Mocking and testing</a></li>
<li><a class="reference internal" href="#backward-compatibility">Backward compatibility</a><ul>
<li><a class="reference internal" href="#deprecation">Deprecation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scalability-issues">Scalability issues</a></li>
<li><a class="reference internal" href="#translation-and-logging">Translation and logging</a></li>
<li><a class="reference internal" href="#project-interfaces">Project interfaces</a></li>
<li><a class="reference internal" href="#documenting-your-code">Documenting your code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#landing-patches-more-rapidly">Landing patches more rapidly</a><ul>
<li><a class="reference internal" href="#scoping-your-patch-appropriately">Scoping your patch appropriately</a></li>
<li><a class="reference internal" href="#nits-and-pedantic-comments">Nits and pedantic comments</a></li>
<li><a class="reference internal" href="#reviewer-comments">Reviewer comments</a></li>
<li><a class="reference internal" href="#code-review">Code Review</a></li>
<li><a class="reference internal" href="#irc">IRC</a></li>
<li><a class="reference internal" href="#commit-messages">Commit messages</a></li>
<li><a class="reference internal" href="#dealing-with-zuul">Dealing with Zuul</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="index.html"
                                  title="previous chapter">Developer Guide</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="development.environment.html"
                                  title="next chapter">Setting Up a Development Environment</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/neutron
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/devref/effective_neutron.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="development.environment.html" title="Setting Up a Development Environment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Developer Guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">neutron 10.0.0.0rc2.dev58 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Developer Guide</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2011-present, OpenStack Foundation..
      Last updated on Feb 14, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/neutron");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>