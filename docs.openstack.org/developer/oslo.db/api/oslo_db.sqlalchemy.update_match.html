<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The oslo_db.sqlalchemy.update_match Module &mdash; oslo.db 4.17.1.dev11 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4.17.1.dev11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="oslo.db 4.17.1.dev11 documentation" href="../index.html" />
    <link rel="up" title="&lt;no title&gt;" href="autoindex.html" />
    <link rel="next" title="The oslo_db.sqlalchemy.utils Module" href="oslo_db.sqlalchemy.utils.html" />
    <link rel="prev" title="The oslo_db.sqlalchemy.types Module" href="oslo_db.sqlalchemy.types.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-oslo_db.sqlalchemy.update_match">
<span id="the-oslo-db-sqlalchemy-update-match-module"></span><h1>The <a class="reference internal" href="#module-oslo_db.sqlalchemy.update_match" title="oslo_db.sqlalchemy.update_match"><code class="xref py py-mod docutils literal"><span class="pre">oslo_db.sqlalchemy.update_match</span></code></a> Module<a class="headerlink" href="#module-oslo_db.sqlalchemy.update_match" title="Permalink to this headline">¶</a></h1>
<dl class="exception">
<dt id="oslo_db.sqlalchemy.update_match.CantUpdateException">
<em class="property">exception </em><code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">CantUpdateException</code><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.CantUpdateException" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal"><span class="pre">exceptions.Exception</span></code></p>
</dd></dl>

<dl class="exception">
<dt id="oslo_db.sqlalchemy.update_match.MultiRowsMatched">
<em class="property">exception </em><code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">MultiRowsMatched</code><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.MultiRowsMatched" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#oslo_db.sqlalchemy.update_match.CantUpdateException" title="oslo_db.sqlalchemy.update_match.CantUpdateException"><code class="xref py py-class docutils literal"><span class="pre">oslo_db.sqlalchemy.update_match.CantUpdateException</span></code></a></p>
</dd></dl>

<dl class="exception">
<dt id="oslo_db.sqlalchemy.update_match.NoRowsMatched">
<em class="property">exception </em><code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">NoRowsMatched</code><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.NoRowsMatched" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#oslo_db.sqlalchemy.update_match.CantUpdateException" title="oslo_db.sqlalchemy.update_match.CantUpdateException"><code class="xref py py-class docutils literal"><span class="pre">oslo_db.sqlalchemy.update_match.CantUpdateException</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="oslo_db.sqlalchemy.update_match.manufacture_criteria">
<code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">manufacture_criteria</code><span class="sig-paren">(</span><em>mapped</em>, <em>values</em><span class="sig-paren">)</span><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.manufacture_criteria" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a mapper/class and a namespace of values, produce a WHERE clause.</p>
<p>The class should be a mapped class and the entries in the dictionary
correspond to mapped attribute names on the class.</p>
<p>A value may also be a tuple in which case that particular attribute
will be compared to a tuple using IN.   The scalar value or
tuple can also contain None which translates to an IS NULL, that is
properly joined with OR against an IN expression if appropriate.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>cls</strong> &#8211; a mapped class, or actual <code class="xref py py-class docutils literal"><span class="pre">Mapper</span></code> object.</li>
<li><strong>values</strong> &#8211; dictionary of values.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="oslo_db.sqlalchemy.update_match.manufacture_entity_criteria">
<code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">manufacture_entity_criteria</code><span class="sig-paren">(</span><em>entity</em>, <em>include_only=None</em>, <em>exclude=None</em><span class="sig-paren">)</span><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.manufacture_entity_criteria" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a mapped instance, produce a WHERE clause.</p>
<p>The attributes set upon the instance will be combined to produce
a SQL expression using the mapped SQL expressions as the base
of comparison.</p>
<p>Values on the instance may be set as tuples in which case the
criteria will produce an IN clause.  None is also acceptable as a
scalar or tuple entry, which will produce IS NULL that is properly
joined with an OR against an IN expression if appropriate.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>entity</strong> &#8211; a mapped entity.</li>
<li><strong>include_only</strong> &#8211; optional sequence of keys to limit which
keys are included.</li>
<li><strong>exclude</strong> &#8211; sequence of keys to exclude</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="oslo_db.sqlalchemy.update_match.manufacture_persistent_object">
<code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">manufacture_persistent_object</code><span class="sig-paren">(</span><em>session</em>, <em>specimen</em>, <em>values=None</em>, <em>primary_key=None</em><span class="sig-paren">)</span><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.manufacture_persistent_object" title="Permalink to this definition">¶</a></dt>
<dd><p>Make an ORM-mapped object persistent in a Session without SQL.</p>
<p>The persistent object is returned.</p>
<p>If a matching object is already present in the given session, the specimen
is merged into it and the persistent object returned.  Otherwise, the
specimen itself is made persistent and is returned.</p>
<p>The object must contain a full primary key, or provide it via the values or
primary_key parameters.  The object is peristed to the Session in a &#8220;clean&#8221;
state with no pending changes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>session</strong> &#8211; A Session object.</li>
<li><strong>specimen</strong> &#8211; a mapped object which is typically transient.</li>
<li><strong>values</strong> &#8211; a dictionary of values to be applied to the specimen,
in addition to the state that&#8217;s already on it.  The attributes will be
set such that no history is created; the object remains clean.</li>
<li><strong>primary_key</strong> &#8211; optional tuple-based primary key.  This will also
be applied to the instance if present.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="oslo_db.sqlalchemy.update_match.update_on_match">
<code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">update_on_match</code><span class="sig-paren">(</span><em>query</em>, <em>specimen</em>, <em>surrogate_key</em>, <em>values=None</em>, <em>attempts=3</em>, <em>include_only=None</em>, <em>process_query=None</em>, <em>handle_failure=None</em><span class="sig-paren">)</span><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.update_on_match" title="Permalink to this definition">¶</a></dt>
<dd><p>Emit an UPDATE statement matching the given specimen.</p>
<p>E.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>with enginefacade.writer() as session:
    specimen = MyInstance(
        uuid=&#39;ccea54f&#39;,
        interface_id=&#39;ad33fea&#39;,
        vm_state=&#39;SOME_VM_STATE&#39;,
    )

    values = {
        &#39;vm_state&#39;: &#39;SOME_NEW_VM_STATE&#39;
    }

    base_query = model_query(
        context, models.Instance,
        project_only=True, session=session)

    hostname_query = model_query(
            context, models.Instance, session=session,
            read_deleted=&#39;no&#39;).
        filter(func.lower(models.Instance.hostname) == &#39;SOMEHOSTNAME&#39;)

    surrogate_key = (&#39;uuid&#39;, )

    def process_query(query):
        return query.where(~exists(hostname_query))

    def handle_failure(query):
        try:
            instance = base_query.one()
        except NoResultFound:
            raise exception.InstanceNotFound(instance_id=instance_uuid)

        if session.query(hostname_query.exists()).scalar():
            raise exception.InstanceExists(
                name=values[&#39;hostname&#39;].lower())

        # try again
        return False

    persistent_instance = base_query.update_on_match(
        specimen,
        surrogate_key,
        values=values,
        process_query=process_query,
        handle_failure=handle_failure
    )
</pre></div>
</div>
<p>The UPDATE statement is constructed against the given specimen
using those values which are present to construct a WHERE clause.
If the specimen contains additional values to be ignored, the
<code class="docutils literal"><span class="pre">include_only</span></code> parameter may be passed which indicates a sequence
of attributes to use when constructing the WHERE.</p>
<p>The UPDATE is performed against an ORM Query, which is created from
the given <code class="docutils literal"><span class="pre">Session</span></code>, or alternatively by passing the <code class="docutils literal"><span class="pre">`query</span></code>
parameter referring to an existing query.</p>
<p>Before the query is invoked, it is also passed through the callable
sent as <code class="docutils literal"><span class="pre">process_query</span></code>, if present.  This hook allows additional
criteria to be added to the query after it is created but before
invocation.</p>
<p>The function will then invoke the UPDATE statement and check for
&#8220;success&#8221; one or more times, up to a maximum of that passed as
<code class="docutils literal"><span class="pre">attempts</span></code>.</p>
<p>The initial check for &#8220;success&#8221; from the UPDATE statement is that the
number of rows returned matches 1.  If zero rows are matched, then
the UPDATE statement is assumed to have &#8220;failed&#8221;, and the failure handling
phase begins.</p>
<p>The failure handling phase involves invoking the given <code class="docutils literal"><span class="pre">handle_failure</span></code>
function, if any.  This handler can perform additional queries to attempt
to figure out why the UPDATE didn&#8217;t match any rows.  The handler,
upon detection of the exact failure condition, should throw an exception
to exit; if it doesn&#8217;t, it has the option of returning True or False,
where False means the error was not handled, and True means that there
was not in fact an error, and the function should return successfully.</p>
<p>If the failure handler is not present, or returns False after <code class="docutils literal"><span class="pre">attempts</span></code>
number of attempts, then the function overall raises CantUpdateException.
If the handler returns True, then the function returns with no error.</p>
<p>The return value of the function is a persistent version of the given
specimen; this may be the specimen itself, if no matching object were
already present in the session; otherwise, the existing object is
returned, with the state of the specimen merged into it.  The returned
persistent object will have the given values populated into the object.</p>
<p>The object is is returned as &#8220;persistent&#8221;, meaning that it is
associated with the given
Session and has an identity key (that is, a real primary key
value).</p>
<p>In order to produce this identity key, a strategy must be used to
determine it as efficiently and safely as possible:</p>
<ol class="arabic simple">
<li>If the given specimen already contained its primary key attributes
fully populated, then these attributes were used as criteria in the
UPDATE, so we have the primary key value; it is populated directly.</li>
<li>If the target backend supports RETURNING, then when the update() query
is performed with a RETURNING clause so that the matching primary key
is returned atomically.  This currently includes Postgresql, Oracle
and others (notably not MySQL or SQLite).</li>
<li>If the target backend is MySQL, and the given model uses a
single-column, AUTO_INCREMENT integer primary key value (as is
the case for Nova), MySQL&#8217;s recommended approach of making use
of <code class="docutils literal"><span class="pre">LAST_INSERT_ID(expr)</span></code> is used to atomically acquire the
matching primary key value within the scope of the UPDATE
statement, then it fetched immediately following by using
<code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">LAST_INSERT_ID()</span></code>.
<a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/information">http://dev.mysql.com/doc/refman/5.0/en/information</a>-       functions.html#function_last-insert-id</li>
<li>Otherwise, for composite keys on MySQL or other backends such
as SQLite, the row as UPDATED must be re-fetched in order to
acquire the primary key value.  The <code class="docutils literal"><span class="pre">surrogate_key</span></code>
parameter is used for this in order to re-fetch the row; this
is a column name with a known, unique value where
the object can be fetched.</li>
</ol>
</dd></dl>

<dl class="function">
<dt id="oslo_db.sqlalchemy.update_match.update_returning_pk">
<code class="descclassname">oslo_db.sqlalchemy.update_match.</code><code class="descname">update_returning_pk</code><span class="sig-paren">(</span><em>query</em>, <em>values</em>, <em>surrogate_key</em><span class="sig-paren">)</span><a class="headerlink" href="#oslo_db.sqlalchemy.update_match.update_returning_pk" title="Permalink to this definition">¶</a></dt>
<dd><p>Perform an UPDATE, returning the primary key of the matched row.</p>
<p>The primary key is returned using a selection of strategies:</p>
<ul class="simple">
<li>if the database supports RETURNING, RETURNING is used to retrieve
the primary key values inline.</li>
<li>If the database is MySQL and the entity is mapped to a single integer
primary key column, MySQL&#8217;s last_insert_id() function is used
inline within the UPDATE and then upon a second SELECT to get the
value.</li>
<li>Otherwise, a &#8220;refetch&#8221; strategy is used, where a given &#8220;surrogate&#8221;
key value (typically a UUID column on the entity) is used to run
a new SELECT against that UUID.   This UUID is also placed into
the UPDATE query to ensure the row matches.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>query</strong> &#8211; a Query object with existing criterion, against a single
entity.</li>
<li><strong>values</strong> &#8211; a dictionary of values to be updated on the row.</li>
<li><strong>surrogate_key</strong> &#8211; a tuple of (attrname, value), referring to a
UNIQUE attribute that will also match the row.  This attribute is used
to retrieve the row via a SELECT when no optimized strategy exists.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the primary key, returned as a tuple.
Is only returned if rows matched is one.  Otherwise, CantUpdateException
is raised.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h4>Previous topic</h4>
            <p class="topless"><a href="oslo_db.sqlalchemy.types.html"
                                  title="previous chapter">The <code class="docutils literal"><span class="pre">oslo_db.sqlalchemy.types</span></code> Module</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="oslo_db.sqlalchemy.utils.html"
                                  title="next chapter">The <code class="docutils literal"><span class="pre">oslo_db.sqlalchemy.utils</span></code> Module</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/oslo.db
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/api/oslo_db.sqlalchemy.update_match.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="oslo_db.sqlalchemy.utils.html" title="The oslo_db.sqlalchemy.utils Module"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="oslo_db.sqlalchemy.types.html" title="The oslo_db.sqlalchemy.types Module"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">oslo.db 4.17.1.dev11 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="autoindex.html" accesskey="U">&lt;no title&gt;</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/oslo.db");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>