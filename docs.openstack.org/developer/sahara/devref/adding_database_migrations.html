<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Adding Database Migrations &mdash; Sahara</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6.0.0.0rc2.dev34',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Sahara" href="../index.html" />
    <link rel="next" title="Sahara Testing" href="testing.html" />
    <link rel="prev" title="How to build Oozie" href="how_to_build_oozie.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="adding-database-migrations">
<h1>Adding Database Migrations<a class="headerlink" href="#adding-database-migrations" title="Permalink to this headline">¶</a></h1>
<p>The migrations in <code class="docutils literal"><span class="pre">sahara/db/migration/alembic_migrations/versions</span></code> contain
the changes needed to migrate between Sahara database revisions. A migration
occurs by executing a script that details the changes needed to upgrade or
downgrade the database. The migration scripts are ordered so that multiple
scripts can run sequentially. The scripts are executed by Sahara&#8217;s migration
wrapper which uses the Alembic library to manage the migration. Sahara supports
migration from Icehouse or later.</p>
<p>Any code modifications that change the structure of the database require a
migration script so that previously existing databases will continue to
function when the new code is released. This page gives a brief overview of how
to add the migration.</p>
<div class="section" id="generate-a-new-migration-script">
<h2>Generate a New Migration Script<a class="headerlink" href="#generate-a-new-migration-script" title="Permalink to this headline">¶</a></h2>
<p>New migration scripts can be generated using the <code class="docutils literal"><span class="pre">sahara-db-manage</span></code> command.</p>
<p>To generate a migration stub to be filled in by the developer:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf revision -m &quot;description of revision&quot;
</pre></div>
</div>
<p>To autogenerate a migration script that reflects the current structure of the
database:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf revision -m &quot;description of revision&quot; --autogenerate
</pre></div>
</div>
<p>Each of these commands will create a file of the form <code class="docutils literal"><span class="pre">revision_description</span></code>
where <code class="docutils literal"><span class="pre">revision</span></code> is a string generated by Alembic and <code class="docutils literal"><span class="pre">description</span></code> is
based on the text passed with the <code class="docutils literal"><span class="pre">-m</span></code> option.</p>
</div>
<div class="section" id="follow-the-sahara-naming-convention">
<h2>Follow the Sahara Naming Convention<a class="headerlink" href="#follow-the-sahara-naming-convention" title="Permalink to this headline">¶</a></h2>
<p>By convention Sahara uses 3-digit revision numbers, and this scheme differs
from the strings generated by Alembic.  Consequently, it&#8217;s necessary to rename
the generated script and modify the revision identifiers in the script.</p>
<p>Open the new script and look for the variable <code class="docutils literal"><span class="pre">down_revision</span></code>.  The value
should be a 3-digit numeric string, and it identifies the current revision
number of the database.  Set the <code class="docutils literal"><span class="pre">revision</span></code> value to the <code class="docutils literal"><span class="pre">down_revision</span></code>
value + 1.  For example, the lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;507eb70202af&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;006&#39;</span>
</pre></div>
</div>
<p>will become:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;007&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;006&#39;</span>
</pre></div>
</div>
<p>Modify any comments in the file to match the changes and rename the file to
match the new revision number:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ mv 507eb70202af_my_new_revision.py 007_my_new_revision.py
</pre></div>
</div>
</div>
<div class="section" id="add-alembic-operations-to-the-script">
<h2>Add Alembic Operations to the Script<a class="headerlink" href="#add-alembic-operations-to-the-script" title="Permalink to this headline">¶</a></h2>
<p>The migration script contains method <code class="docutils literal"><span class="pre">upgrade()</span></code>. Sahara has not supported
downgrades since the Kilo release. Fill in this method with the appropriate
Alembic operations to perform upgrades. In the above example, an upgrade will
move from revision &#8216;006&#8217; to revision &#8216;007&#8217;.</p>
</div>
<div class="section" id="command-summary-for-sahara-db-manage">
<h2>Command Summary for sahara-db-manage<a class="headerlink" href="#command-summary-for-sahara-db-manage" title="Permalink to this headline">¶</a></h2>
<p>You can upgrade to the latest database version via:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf upgrade head
</pre></div>
</div>
<p>To check the current database version:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf current
</pre></div>
</div>
<p>To create a script to run the migration offline:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf upgrade head --sql
</pre></div>
</div>
<p>To run the offline migration between specific migration versions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf upgrade &lt;start version&gt;:&lt;end version&gt; --sql
</pre></div>
</div>
<p>To upgrade the database incrementally:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf upgrade --delta &lt;# of revs&gt;
</pre></div>
</div>
<p>To create a new revision:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf revision -m &quot;description of revision&quot; --autogenerate
</pre></div>
</div>
<p>To create a blank file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf revision -m &quot;description of revision&quot;
</pre></div>
</div>
<p>This command does not perform any migrations, it only sets the revision.
Revision may be any existing revision. Use this command carefully:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf stamp &lt;revision&gt;
</pre></div>
</div>
<p>To verify that the timeline does branch, you can run this command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf check_migration
</pre></div>
</div>
<p>If the migration path does branch, you can find the branch point via:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sahara-db-manage --config-file /path/to/sahara.conf history
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Adding Database Migrations</a><ul>
<li><a class="reference internal" href="#generate-a-new-migration-script">Generate a New Migration Script</a></li>
<li><a class="reference internal" href="#follow-the-sahara-naming-convention">Follow the Sahara Naming Convention</a></li>
<li><a class="reference internal" href="#add-alembic-operations-to-the-script">Add Alembic Operations to the Script</a></li>
<li><a class="reference internal" href="#command-summary-for-sahara-db-manage">Command Summary for sahara-db-manage</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="how_to_build_oozie.html"
                                  title="previous chapter">How to build Oozie</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="testing.html"
                                  title="next chapter">Sahara Testing</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/sahara
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/devref/adding_database_migrations.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="testing.html" title="Sahara Testing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="how_to_build_oozie.html" title="How to build Oozie"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Sahara</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, OpenStack Foundation.
      Last updated on &#39;Mon Feb 13 17:36:11 2017, commit 23ee18f&#39;.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/sahara");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>