<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Versioned Objects &mdash; magnum 4.0.1.dev40 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.0.1.dev40',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="magnum 4.0.1.dev40 documentation" href="index.html" />
    <link rel="next" title="Guru Meditation Reports" href="gmr.html" />
    <link rel="prev" title="Heat Stack Templates" href="heat-templates.html" /> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="versioned-objects">
<h1>Versioned Objects<a class="headerlink" href="#versioned-objects" title="Permalink to this headline">¶</a></h1>
<p>Magnum uses the <a class="reference external" href="http://docs.openstack.org/developer/oslo.versionedobjects/index.html">oslo.versionedobjects library</a> to
construct an object model that can be communicated via RPC. These objects have
a version history and functionality to convert from one version to a previous
version. This allows for 2 different levels of the code to still pass objects
to each other, as in the case of rolling upgrades.</p>
<div class="section" id="object-version-testing">
<h2>Object Version Testing<a class="headerlink" href="#object-version-testing" title="Permalink to this headline">¶</a></h2>
<p>In order to ensure object versioning consistency is maintained,
oslo.versionedobjects has a fixture to aid in testing object versioning.
<a class="reference external" href="http://docs.openstack.org/developer/oslo.versionedobjects/api/fixture.html#oslo_versionedobjects.fixture.ObjectVersionChecker">oslo.versionedobjects.fixture.ObjectVersionChecker</a>
generates fingerprints of each object, which is a combination of the current
version number of the object, along with a hash of the RPC-critical parts of
the object (fields and remotable methods).</p>
<p>The tests hold a static mapping of the fingerprints of all objects. When an
object is changed, the hash generated in the test will differ from that held in
the static mapping. This will signal to the developer that the version of the
object needs to be increased. Following this version increase, the fingerprint
that is then generated by the test can be copied to the static mapping in the
tests. This symbolizes that if the code change is approved, this is the new
state of the object to compare against.</p>
<div class="section" id="object-change-example">
<h3>Object Change Example<a class="headerlink" href="#object-change-example" title="Permalink to this headline">¶</a></h3>
<p>The following example shows the unit test workflow when changing an object
(Cluster was updated to hold a new &#8216;foo&#8217; field):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>tox -e py27 magnum.tests.unit.objects.test_objects
</pre></div>
</div>
<p>This results in a unit test failure with the following output:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">testtools</span><span class="o">.</span><span class="n">matchers</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">MismatchError</span><span class="p">:</span> <span class="o">!=</span><span class="p">:</span>
<span class="n">reference</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-35edde13ad178e9419e7ea8b6d580bcd&#39;</span><span class="p">}</span>
<span class="n">actual</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-22b40e8eed0414561ca921906b189820&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">: Fields or remotable methods in some objects have changed. Make sure the versions of the objects has been bumped, and update the hashes in the static fingerprints tree (object_data). For more information, read http://docs.openstack.org/developer/magnum/objects.html.</span>
</pre></div>
</div>
</div></blockquote>
<p>This is an indication that me adding the &#8216;foo&#8217; field to Cluster means I need
to bump the version of Cluster, so I increase the version and add a comment
saying what I changed in the new version:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@base.MagnumObjectRegistry.register</span>
<span class="k">class</span> <span class="nc">Cluster</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">MagnumPersistentObject</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">MagnumObject</span><span class="p">,</span>
              <span class="n">base</span><span class="o">.</span><span class="n">MagnumObjectDictCompat</span><span class="p">):</span>
    <span class="c1"># Version 1.0: Initial version</span>
    <span class="c1"># Version 1.1: Added &#39;foo&#39; field</span>
    <span class="n">VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.1&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>Now that I have updated the version, I will run the tests again and let the
test tell me the fingerprint that I now need to put in the static tree:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">testtools</span><span class="o">.</span><span class="n">matchers</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">MismatchError</span><span class="p">:</span> <span class="o">!=</span><span class="p">:</span>
<span class="n">reference</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-35edde13ad178e9419e7ea8b6d580bcd&#39;</span><span class="p">}</span>
<span class="n">actual</span>    <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;1.1-22b40e8eed0414561ca921906b189820&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>I can now copy the new fingerprint needed
(1.1-22b40e8eed0414561ca921906b189820), to the object_data map within
magnum/tests/unit/objects/test_objects.py:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">object_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;1.1-22b40e8eed0414561ca921906b189820&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ClusterTemplate&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-06863f04ab4b98307e3d1b736d3137bf&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Certificate&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-69b579203c6d726be7878c606626e438&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MyObj&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-b43567e512438205e32f4e95ca616697&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X509KeyPair&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-fd008eba0fbc390e0e5da247bba4eedd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MagnumService&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0-d4b8c0f3a234aec35d273196e18f7ed1&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>Running the unit tests now shows no failure.</p>
<p>If I did not update the version, and rather just copied the new hash to the
object_data map, the review would show the hash (but not the version) was
updated in object_data. At that point, a reviewer should point this out, and
mention that the object version needs to be updated.</p>
<p>If a remotable method were added/changed, the same process is followed, because
this will also cause a hash change.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Versioned Objects</a><ul>
<li><a class="reference internal" href="#object-version-testing">Object Version Testing</a><ul>
<li><a class="reference internal" href="#object-change-example">Object Change Example</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="heat-templates.html"
                                  title="previous chapter">Heat Stack Templates</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="gmr.html"
                                  title="next chapter">Guru Meditation Reports</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/magnum
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/objects.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="gmr.html" title="Guru Meditation Reports"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="heat-templates.html" title="Heat Stack Templates"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">magnum 4.0.1.dev40 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2013, OpenStack Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/magnum");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>