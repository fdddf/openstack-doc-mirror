<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: API Microversions</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="../_static/css/bootstrap.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="../_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="../_static/css/font-awesome.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="../_static/css/combined.css" rel="stylesheet">
<link href="../_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/security/">Security</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/telecoms-and-nfv/">Telecoms and NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers & ISVs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/coa/">Get Certified</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//ask.openstack.org">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/analysts/">Analyst Reports</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
      <h2>API Microversions</h2>
    
  </div>
  <div class="docs-actions">
    
    <a href="api.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: API Endpoint"></i></a>
    
    
    <a href="api_microversion_history.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: REST API Version History"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 'Tue Feb 14 14:25:27 2017, commit 610baa2'</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="../index.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">API Microversions</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#when-do-i-need-a-new-microversion">When do I need a new Microversion?</a></li>
<li><a class="reference internal" href="#in-code">In Code</a><ul>
<li><a class="reference internal" href="#adding-a-new-api-method">Adding a new API method</a></li>
<li><a class="reference internal" href="#removing-an-api-method">Removing an API method</a></li>
<li><a class="reference internal" href="#changing-a-method-s-behaviour">Changing a method&#8217;s behaviour</a></li>
<li><a class="reference internal" href="#a-method-with-only-small-changes-between-versions">A method with only small changes between versions</a></li>
<li><a class="reference internal" href="#a-change-in-schema-only">A change in schema only</a></li>
<li><a class="reference internal" href="#when-not-using-decorators">When not using decorators</a></li>
</ul>
</li>
<li><a class="reference internal" href="#other-necessary-changes">Other necessary changes</a></li>
<li><a class="reference internal" href="#allocating-a-microversion">Allocating a microversion</a></li>
<li><a class="reference internal" href="#testing-microversioned-api-methods">Testing Microversioned API Methods</a></li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="api-microversions">
<h1>API Microversions<a class="headerlink" href="#api-microversions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>Manila uses a framework we called &#8216;API Microversions&#8217; for allowing changes
to the API while preserving backward compatibility. The basic idea is
that a user has to explicitly ask for their request to be treated with
a particular version of the API. So breaking changes can be added to
the API without breaking users who don&#8217;t specifically ask for it. This
is done with an HTTP header <code class="docutils literal"><span class="pre">X-OpenStack-Manila-API-Version</span></code> which
is a monotonically increasing semantic version number starting from
<code class="docutils literal"><span class="pre">1.0</span></code>.</p>
<p>If a user makes a request without specifying a version, they will get
the <code class="docutils literal"><span class="pre">DEFAULT_API_VERSION</span></code> as defined in
<code class="docutils literal"><span class="pre">manila/api/openstack/api_version_request.py</span></code>. This value is currently <code class="docutils literal"><span class="pre">2.0</span></code>
and is expected to remain so for quite a long time.</p>
<p>The Nova project was the first to implement microversions. For full
details please read Nova&#8217;s <a class="reference external" href="http://git.openstack.org/cgit/openstack/nova-specs/tree/specs/kilo/implemented/api-microversions.rst">Kilo spec for microversions</a></p>
</div>
<div class="section" id="when-do-i-need-a-new-microversion">
<h2>When do I need a new Microversion?<a class="headerlink" href="#when-do-i-need-a-new-microversion" title="Permalink to this headline">¶</a></h2>
<p>A microversion is needed when the contract to the user is
changed. The user contract covers many kinds of information such as:</p>
<ul>
<li><p class="first">the Request</p>
<ul>
<li><p class="first">the list of resource urls which exist on the server</p>
<p>Example: adding a new shares/{ID}/foo which didn&#8217;t exist in a
previous version of the code</p>
</li>
<li><p class="first">the list of query parameters that are valid on urls</p>
<p>Example: adding a new parameter <code class="docutils literal"><span class="pre">is_yellow</span></code> servers/{ID}?is_yellow=True</p>
</li>
<li><p class="first">the list of query parameter values for non free form fields</p>
<p>Example: parameter filter_by takes a small set of constants/enums &#8220;A&#8221;,
&#8220;B&#8221;, &#8220;C&#8221;. Adding support for new enum &#8220;D&#8221;.</p>
</li>
<li><p class="first">new headers accepted on a request</p>
</li>
</ul>
</li>
<li><p class="first">the Response</p>
<ul>
<li><p class="first">the list of attributes and data structures returned</p>
<p>Example: adding a new attribute &#8216;locked&#8217;: True/False to the output
of shares/{ID}</p>
</li>
<li><p class="first">the allowed values of non free form fields</p>
<p>Example: adding a new allowed <code class="docutils literal"><span class="pre">status</span></code> to shares/{ID}</p>
</li>
<li><p class="first">the list of status codes allowed for a particular request</p>
<p>Example: an API previously could return 200, 400, 403, 404 and the
change would make the API now also be allowed to return 409.</p>
</li>
<li><p class="first">changing a status code on a particular response</p>
<p>Example: changing the return code of an API from 501 to 400.</p>
</li>
<li><p class="first">new headers returned on a response</p>
</li>
</ul>
</li>
</ul>
<p>The following flow chart attempts to walk through the process of &#8220;do
we need a microversion&#8221;.</p>
<p class="graphviz">
<img src="../_images/graphviz-040a6e9b98db8d35d1f5e75ca2ca9ad8c005e867.png" alt="digraph states {

 label=&quot;Do I need a microversion?&quot;

 silent_fail[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Did we silently
fail to do what is asked?&quot;];
 ret_500[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Did we return a 500
before?&quot;];
 new_error[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Are we changing what
 status code is returned?&quot;];
 new_attr[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Did we add or remove an
 attribute to a payload?&quot;];
 new_param[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Did we add or remove
 an accepted query string parameter or value?&quot;];
 new_resource[shape=&quot;diamond&quot;, style=&quot;&quot;, label=&quot;Did we add or remove a
resource url?&quot;];


no[shape=&quot;box&quot;, style=rounded, label=&quot;No microversion needed&quot;];
yes[shape=&quot;box&quot;, style=rounded, label=&quot;Yes, you need a microversion&quot;];
no2[shape=&quot;box&quot;, style=rounded, label=&quot;No microversion needed, it's
a bug&quot;];

silent_fail -&gt; ret_500[label=&quot;no&quot;];
silent_fail -&gt; no2[label=&quot;yes&quot;];

 ret_500 -&gt; no2[label=&quot;yes [1]&quot;];
 ret_500 -&gt; new_error[label=&quot;no&quot;];

 new_error -&gt; new_attr[label=&quot;no&quot;];
 new_error -&gt; yes[label=&quot;yes&quot;];

 new_attr -&gt; new_param[label=&quot;no&quot;];
 new_attr -&gt; yes[label=&quot;yes&quot;];

 new_param -&gt; new_resource[label=&quot;no&quot;];
 new_param -&gt; yes[label=&quot;yes&quot;];

 new_resource -&gt; no[label=&quot;no&quot;];
 new_resource -&gt; yes[label=&quot;yes&quot;];

{rank=same; yes new_attr}
{rank=same; no2 ret_500}
{rank=min; silent_fail}
}" />
</p>
<p><strong>Footnotes</strong></p>
<p>[1] - When fixing 500 errors that previously caused stack traces, try
to map the new error into the existing set of errors that API call
could previously return (400 if nothing else is appropriate). Changing
the set of allowed status codes from a request is changing the
contract, and should be part of a microversion.</p>
<p>The reason why we are so strict on contract is that we&#8217;d like
application writers to be able to know, for sure, what the contract is
at every microversion in manila. If they do not, they will need to write
conditional code in their application to handle ambiguities.</p>
<p>When in doubt, consider application authors. If it would work with no
client side changes on both manila versions, you probably don&#8217;t need a
microversion. If, on the other hand, there is any ambiguity, a
microversion is probably needed.</p>
</div>
<div class="section" id="in-code">
<h2>In Code<a class="headerlink" href="#in-code" title="Permalink to this headline">¶</a></h2>
<p>In <code class="docutils literal"><span class="pre">manila/api/openstack/wsgi.py</span></code> we define an <code class="docutils literal"><span class="pre">&#64;api_version</span></code> decorator
which is intended to be used on top-level Controller methods. It is
not appropriate for lower-level methods. Some examples:</p>
<div class="section" id="adding-a-new-api-method">
<h3>Adding a new API method<a class="headerlink" href="#adding-a-new-api-method" title="Permalink to this headline">¶</a></h3>
<p>In the controller class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@wsgi.Controller.api_version</span><span class="p">(</span><span class="s2">&quot;2.4&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_api_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>This method would only be available if the caller had specified an
<code class="docutils literal"><span class="pre">X-OpenStack-Manila-API-Version</span></code> of &gt;= <code class="docutils literal"><span class="pre">2.4</span></code>. If they had specified a
lower version (or not specified it and received the default of <code class="docutils literal"><span class="pre">2.1</span></code>)
the server would respond with <code class="docutils literal"><span class="pre">HTTP/404</span></code>.</p>
</div>
<div class="section" id="removing-an-api-method">
<h3>Removing an API method<a class="headerlink" href="#removing-an-api-method" title="Permalink to this headline">¶</a></h3>
<p>In the controller class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@wsgi.Controller.api_version</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">,</span> <span class="s2">&quot;2.4&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_api_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>This method would only be available if the caller had specified an
<code class="docutils literal"><span class="pre">X-OpenStack-Manila-API-Version</span></code> of &lt;= <code class="docutils literal"><span class="pre">2.4</span></code>. If <code class="docutils literal"><span class="pre">2.5</span></code> or later
is specified the server will respond with <code class="docutils literal"><span class="pre">HTTP/404</span></code>.</p>
</div>
<div class="section" id="changing-a-method-s-behaviour">
<h3>Changing a method&#8217;s behaviour<a class="headerlink" href="#changing-a-method-s-behaviour" title="Permalink to this headline">¶</a></h3>
<p>In the controller class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@wsgi.Controller.api_version</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">,</span> <span class="s2">&quot;2.3&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_api_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="o">....</span> <span class="n">method_1</span> <span class="o">...</span>

<span class="nd">@wsgi.Controller.api_version</span><span class="p">(</span><span class="s2">&quot;2.4&quot;</span><span class="p">)</span>  <span class="c1"># noqa</span>
<span class="k">def</span> <span class="nf">my_api_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="o">....</span> <span class="n">method_2</span> <span class="o">...</span>
</pre></div>
</div>
<p>If a caller specified <code class="docutils literal"><span class="pre">2.1</span></code>, <code class="docutils literal"><span class="pre">2.2</span></code> or <code class="docutils literal"><span class="pre">2.3</span></code> (or received the
default of <code class="docutils literal"><span class="pre">2.1</span></code>) they would see the result from <code class="docutils literal"><span class="pre">method_1</span></code>,
<code class="docutils literal"><span class="pre">2.4</span></code> or later <code class="docutils literal"><span class="pre">method_2</span></code>.</p>
<p>It is vital that the two methods have the same name, so the second of
them will need <code class="docutils literal"><span class="pre">#</span> <span class="pre">noqa</span></code> to avoid failing flake8&#8217;s <code class="docutils literal"><span class="pre">F811</span></code> rule. The
two methods may be different in any kind of semantics (schema
validation, return values, response codes, etc)</p>
</div>
<div class="section" id="a-method-with-only-small-changes-between-versions">
<h3>A method with only small changes between versions<a class="headerlink" href="#a-method-with-only-small-changes-between-versions" title="Permalink to this headline">¶</a></h3>
<p>A method may have only small changes between microversions, in which
case you can decorate a private method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@api_version</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">,</span> <span class="s2">&quot;2.4&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_version_specific_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">arg1</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@api_version</span><span class="p">(</span><span class="n">min_version</span><span class="o">=</span><span class="s2">&quot;2.5&quot;</span><span class="p">)</span>  <span class="c1"># noqa</span>
<span class="k">def</span> <span class="nf">_version_specific_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">arg1</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="o">....</span> <span class="n">common</span> <span class="n">stuff</span> <span class="o">....</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_version_specific_func</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">)</span>
    <span class="o">....</span> <span class="n">common</span> <span class="n">stuff</span> <span class="o">....</span>
</pre></div>
</div>
</div>
<div class="section" id="a-change-in-schema-only">
<h3>A change in schema only<a class="headerlink" href="#a-change-in-schema-only" title="Permalink to this headline">¶</a></h3>
<p>If there is no change to the method, only to the schema that is used for
validation, you can add a version range to the <code class="docutils literal"><span class="pre">validation.schema</span></code>
decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@wsgi.Controller.api_version</span><span class="p">(</span><span class="s2">&quot;2.1&quot;</span><span class="p">)</span>
<span class="nd">@validation.schema</span><span class="p">(</span><span class="n">dummy_schema</span><span class="o">.</span><span class="n">dummy</span><span class="p">,</span> <span class="s2">&quot;2.3&quot;</span><span class="p">,</span> <span class="s2">&quot;2.8&quot;</span><span class="p">)</span>
<span class="nd">@validation.schema</span><span class="p">(</span><span class="n">dummy_schema</span><span class="o">.</span><span class="n">dummy2</span><span class="p">,</span> <span class="s2">&quot;2.9&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="o">....</span>
</pre></div>
</div>
<p>This method will be available from version <code class="docutils literal"><span class="pre">2.1</span></code>, validated according to
<code class="docutils literal"><span class="pre">dummy_schema.dummy</span></code> from <code class="docutils literal"><span class="pre">2.3</span></code> to <code class="docutils literal"><span class="pre">2.8</span></code>, and validated according to
<code class="docutils literal"><span class="pre">dummy_schema.dummy2</span></code> from <code class="docutils literal"><span class="pre">2.9</span></code> onward.</p>
</div>
<div class="section" id="when-not-using-decorators">
<h3>When not using decorators<a class="headerlink" href="#when-not-using-decorators" title="Permalink to this headline">¶</a></h3>
<p>When you don&#8217;t want to use the <code class="docutils literal"><span class="pre">&#64;api_version</span></code> decorator on a method
or you want to change behaviour within a method (say it leads to
simpler or simply a lot less code) you can directly test for the
requested version with a method as long as you have access to the api
request object (commonly called <code class="docutils literal"><span class="pre">req</span></code>). Every API method has an
api_version_request object attached to the req object and that can be
used to modify behaviour based on its value:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>def index(self, req):
    &lt;common code&gt;

    req_version = req.api_version_request
    if req_version.matches(&quot;2.1&quot;, &quot;2.5&quot;):
        ....stuff....
    elif req_version.matches(&quot;2.6&quot;, &quot;2.10&quot;):
        ....other stuff....
    elif req_version &gt; api_version_request.APIVersionRequest(&quot;2.10&quot;):
        ....more stuff.....

    &lt;common code&gt;
</pre></div>
</div>
<p>The first argument to the matches method is the minimum acceptable version
and the second is maximum acceptable version. A specified version can be null:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">null_version</span> <span class="o">=</span> <span class="n">APIVersionRequest</span><span class="p">()</span>
</pre></div>
</div>
<p>If the minimum version specified is null then there is no restriction on
the minimum version, and likewise if the maximum version is null there
is no restriction the maximum version. Alternatively a one sided comparison
can be used as in the example above.</p>
</div>
</div>
<div class="section" id="other-necessary-changes">
<h2>Other necessary changes<a class="headerlink" href="#other-necessary-changes" title="Permalink to this headline">¶</a></h2>
<p>If you are adding a patch which adds a new microversion, it is
necessary to add changes to other places which describe your change:</p>
<ul class="simple">
<li>Update <code class="docutils literal"><span class="pre">REST_API_VERSION_HISTORY</span></code> in
<code class="docutils literal"><span class="pre">manila/api/openstack/api_version_request.py</span></code></li>
<li>Update <code class="docutils literal"><span class="pre">_MAX_API_VERSION</span></code> in
<code class="docutils literal"><span class="pre">manila/api/openstack/api_version_request.py</span></code></li>
<li>Add a verbose description to
<code class="docutils literal"><span class="pre">manila/api/openstack/rest_api_version_history.rst</span></code>.  There should
be enough information that it could be used by the docs team for
release notes.</li>
<li>Update the expected versions in affected tests.</li>
</ul>
</div>
<div class="section" id="allocating-a-microversion">
<h2>Allocating a microversion<a class="headerlink" href="#allocating-a-microversion" title="Permalink to this headline">¶</a></h2>
<p>If you are adding a patch which adds a new microversion, it is
necessary to allocate the next microversion number. Except under
extremely unusual circumstances and this would have been mentioned in
the blueprint for the change, the minor number of <code class="docutils literal"><span class="pre">_MAX_API_VERSION</span></code>
will be incremented. This will also be the new microversion number for
the API change.</p>
<p>It is possible that multiple microversion patches would be proposed in
parallel and the microversions would conflict between patches.  This
will cause a merge conflict. We don&#8217;t reserve a microversion for each
patch in advance as we don&#8217;t know the final merge order. Developers
may need over time to rebase their patch calculating a new version
number as above based on the updated value of <code class="docutils literal"><span class="pre">_MAX_API_VERSION</span></code>.</p>
</div>
<div class="section" id="testing-microversioned-api-methods">
<h2>Testing Microversioned API Methods<a class="headerlink" href="#testing-microversioned-api-methods" title="Permalink to this headline">¶</a></h2>
<p>Testing a microversioned API method is very similar to a normal controller
method test, you just need to add the <code class="docutils literal"><span class="pre">X-OpenStack-Manila-API-Version</span></code>
header, for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">req</span> <span class="o">=</span> <span class="n">fakes</span><span class="o">.</span><span class="n">HTTPRequest</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="s1">&#39;/testable/url/endpoint&#39;</span><span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;X-OpenStack-Manila-API-Version&#39;</span><span class="p">:</span> <span class="s1">&#39;2.2&#39;</span><span class="p">}</span>
<span class="n">req</span><span class="o">.</span><span class="n">api_version_request</span> <span class="o">=</span> <span class="n">api_version</span><span class="o">.</span><span class="n">APIVersionRequest</span><span class="p">(</span><span class="s1">&#39;2.6&#39;</span><span class="p">)</span>

<span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">TestableController</span><span class="p">()</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="o">...</span> <span class="n">assertions</span> <span class="n">about</span> <span class="n">the</span> <span class="n">response</span> <span class="o">...</span>
</pre></div>
</div>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="api.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: API Endpoint"></i></a>
          
          
            <a href="api_microversion_history.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: REST API Version History"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 'Tue Feb 14 14:25:27 2017, commit 610baa2'</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="../_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="../index.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#programming-howtos-and-tutorials">Programming HowTos and Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#background-concepts-for-manila">Background Concepts for manila</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#other-resources">Other Resources</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#api-reference">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#module-reference">Module Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#capabilities-and-extra-specs">Capabilities and Extra-Specs</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#share-backends-feature-support-mapping">Share backends feature support mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#share-backends">Share backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../man/index.html">Command-Line Utilities</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../adminref/index.html">Admin Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="../_static/js/jquery-1.12.4.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="../_static/js/bootstrap.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="../_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="../_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="../_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "devref/api_microversion_dev" + ".rst";
        gitURL = "Source: http://git.openstack.org/cgit/openstack/manila/tree/doc/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 610baa2fdb702fa4cc2c12eb5c61599bdcad21ce";
        var bugProject = "manila";
        var bugTitle = "API Microversions in manila";
    var fieldTags = "docs";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 4.0.0.0rc2.dev25 on 'Tue Feb 14 14:25:27 2017, commit 610baa2'";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>
</html>