<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Charm Anatomy &mdash; OpenStack Charms Guide 0.0.1.dev33 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1.dev33',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack Charms Guide 0.0.1.dev33 documentation" href="index.html" />
    <link rel="up" title="Create A Charm" href="creating-charms.html" />
    <link rel="next" title="New SDN Charm" href="new-sdn-charm.html" />
    <link rel="prev" title="Create A Charm" href="creating-charms.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="charm-anatomy">
<span id="id1"></span><h1>Charm Anatomy<a class="headerlink" href="#charm-anatomy" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The new OpenStack charms (charms written in 2016 onwards) are written using the
<a class="reference external" href="https://pythonhosted.org/charms.reactive">reactive framework</a> in Python.
An introduction on the reactive framework and building charms from layers can
be found in the <a class="reference external" href="https://jujucharms.com/docs/devel/authors-charm-building">Authors Charm Building Guide</a> .
This guide covers only the new reactive charms.</p>
</div>
<div class="section" id="configuration-files">
<h2>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h2>
<div class="section" id="layers-yaml">
<span id="id2"></span><h3>layers.yaml<a class="headerlink" href="#layers-yaml" title="Permalink to this headline">¶</a></h3>
<p>The <strong>src/layers.yaml</strong> file defines what layers and interfaces will be imported
and included in the charm when the charm is built. See the <a class="reference internal" href="#openstack-layers">OpenStack Layers</a>
section and <a class="reference internal" href="#openstack-interfaces">OpenStack Interfaces</a> section below.  If additional interfaces or
layers add them to the <strong>includes</strong> list within <strong>src/layers.yaml</strong>.</p>
<p>Below is an example of the layers.yaml for an OpenStack API charm which has a
relation with MongoDB:</p>
<div class="code yaml highlight-python"><div class="highlight"><pre><span></span>includes: [&#39;layer:openstack-api&#39;, &#39;interface:mongodb&#39;]
options:
  basic:
    use_venv: True
    include_system_packages: True
</pre></div>
</div>
<p>When the charm is built the openstack-api layer and mongodb interface will
be included in the built charm. The charm will run in a virtual env with
system packages exposed in that virtual env.  See the <em>Layer Configuration</em>
section in <a class="reference external" href="https://github.com/juju-solutions/layer-basic">Basic Layer README</a>
for more details of the configurable options in a <strong>layers.yaml</strong></p>
</div>
<div class="section" id="config-yaml">
<h3>config.yaml<a class="headerlink" href="#config-yaml" title="Permalink to this headline">¶</a></h3>
<p>The charm authors guide contains a section on the <a class="reference external" href="https://jujucharms.com/docs/2.0/authors-charm-config">config.yaml</a>
and is a good place to start.  The config.yaml of the built charm is
constructed from each layer that contains a config.yaml.</p>
</div>
<div class="section" id="metadata-yaml">
<h3>metadata.yaml<a class="headerlink" href="#metadata-yaml" title="Permalink to this headline">¶</a></h3>
<p>The charm
<a class="reference external" href="https://jujucharms.com/docs/2.0/authors-charm-metadata">metadata.yaml</a>
describes the charm and how it relates to other charms. This is also
constructed from each layer that defines a metadata.yaml</p>
</div>
</div>
<div class="section" id="openstack-layers">
<span id="id3"></span><h2>OpenStack Layers<a class="headerlink" href="#openstack-layers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="basic-layer">
<h3>Basic Layer<a class="headerlink" href="#basic-layer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/juju-solutions/layer-basic">Basic Layer</a> is the
base layer for all charms built using layers. It provides all of the standard
Juju hooks and runs the charms.reactive.main loop for them. It also bootstraps
the charm-helpers and charms.reactive libraries and all of their dependencies
for use by the charm.</p>
</div>
<div class="section" id="openstack-layer">
<span id="id4"></span><h3>OpenStack Layer<a class="headerlink" href="#openstack-layer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/openstack/charm-layer-openstack">Openstack Layer</a>
provides the base OpenStack configuration options, templates, template
fragments and dependencies for authoring OpenStack Charms. Typically this layer
is used for subordinate charms. The openstack-api or openstack-principle layers
are probably more appropriate for principle charms and both of those layers
inherit this one.</p>
<p>This layer includes a wheelhouse to pull in <a class="reference external" href="https://github.com/openstack/charms.openstack">charms.openstack</a>
. See <a class="reference internal" href="#charms-openstack">charms.openstack</a>  for more details.</p>
</div>
<div class="section" id="openstack-principle-layer">
<h3>Openstack Principle Layer<a class="headerlink" href="#openstack-principle-layer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/openstack/charm-layer-openstack-principle">Openstack Principle Layer</a>
provides the base layer for OpenStack charms that are intended for
use as principle (rather than subordinate)</p>
</div>
<div class="section" id="openstack-api-layer">
<h3>Openstack API Layer<a class="headerlink" href="#openstack-api-layer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/openstack/charm-layer-openstack-api">Openstack API Layer</a>
provides the base layer for OpenStack charms that are will deploy API services,
and provides all of the core functionality for:</p>
<ul class="simple">
<li>HA (using the hacluster charm)</li>
<li>SSL (using configuration options or keystone for certificates)</li>
<li>Juju 2.0 network space support for API endpoints</li>
<li>Configuration based network binding of API endpoints</li>
</ul>
<p>It also pulls in interfaces mysql-shared, rabbitmq and keystone which are
common to API charms.</p>
</div>
</div>
<div class="section" id="openstack-interfaces">
<span id="id5"></span><h2>OpenStack Interfaces<a class="headerlink" href="#openstack-interfaces" title="Permalink to this headline">¶</a></h2>
<p>Interfaces define the data exchange between each of the charms. A list of all
available interfaces is available <a class="reference external" href="http://interfaces.juju.solutions">here</a>.
A list of OpenStack specific interfaces can be found <a class="reference external" href="https://github.com/openstack?query=charm-interface">here</a></p>
<p>The interfaces a charm needs are defines in the <a class="reference internal" href="#layers-yaml">layers.yaml</a>. Below is a list
of the typical interfaces needed by different OpenStack charm types:</p>
<p><strong>API Charm</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/openstack/charm-interface-mysql-shared">mysql-shared</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-rabbitmq">rabbitmq</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-keystone">keystone</a></li>
</ul>
<p><strong>Neutron SDN Plugin</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/openstack/charm-interface-neutron-plugin">neutron-plugin</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-service-control">service-control</a></li>
</ul>
<p><strong>Neutron ODL Based SDN Plugin</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/openstack/charm-interface-neutron-plugin">neutron-plugin</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-service-control">service-control</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-ovsdb-manager">ovsdb-manager</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-odl-controller-api">odl-controller-api</a></li>
</ul>
<p><strong>Neutron API Plugin</strong></p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/openstack/charm-interface-neutron-plugin-api-subordinate">neutron-plugin-api-subordinate</a></li>
<li><a class="reference external" href="https://github.com/openstack/charm-interface-service-control">service-control</a></li>
</ul>
</div>
<div class="section" id="charms-openstack">
<span id="id6"></span><h2>charms.openstack<a class="headerlink" href="#charms-openstack" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/openstack/charms.openstack">charms.openstack</a> python
module provides helpers for building layered, reactive OpenStack charms. It is
installed by the <a class="reference internal" href="#openstack-layer">OpenStack Layer</a> .</p>
</div>
<div class="section" id="defining-the-charm">
<h2>Defining the Charm<a class="headerlink" href="#defining-the-charm" title="Permalink to this headline">¶</a></h2>
<p>The charm is defined be extending the OpenStackCharm or OpenStackCharmAPI base
classes in <strong>src/lib/charm/openstack/new_charm_name.py</strong> and overriding the
class attributes as needed.</p>
<p>For example to define a charm for a service called &#8216;new-service&#8217;:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">charms_openstack.charm</span>

<span class="k">class</span> <span class="nc">NewServiceCharm</span><span class="p">(</span><span class="n">charms_openstack</span><span class="o">.</span><span class="n">charm</span><span class="o">.</span><span class="n">OpenStackCharm</span><span class="p">):</span>

    <span class="c1"># The name of the charm (for printing, etc.)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;new-service&#39;</span>

    <span class="c1"># List of packages to install</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;glance-common&#39;</span><span class="p">]</span>

    <span class="c1"># The list of required services that are checked for assess_status</span>
    <span class="c1"># e.g. required_relations = [&#39;identity-service&#39;, &#39;shared-db&#39;]</span>
    <span class="n">required_relations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;keystone&#39;</span><span class="p">]</span>

    <span class="c1"># A dictionary of:</span>
    <span class="c1"># {</span>
    <span class="c1">#    &#39;config.file&#39;: [&#39;list&#39;, &#39;of&#39;, &#39;services&#39;, &#39;to&#39;, &#39;restart&#39;],</span>
    <span class="c1">#    &#39;config2.file&#39;: [&#39;more&#39;, &#39;services&#39;],</span>
    <span class="c1"># }</span>
    <span class="c1"># The files that for the keys of the dict are monitored and if the file</span>
    <span class="c1"># changes the corresponding services are restarted</span>
    <span class="n">restart_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;/etc/new-svc/new-svc.conf&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;new-charm-svc&#39;</span><span class="p">]}</span>

    <span class="c1"># first_release = this is the first release in which this charm works</span>
    <span class="n">release</span> <span class="o">=</span> <span class="s1">&#39;icehouse&#39;</span>

    <span class="k">def</span> <span class="nf">configure_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The charm definition above can also define methods, like configure_foo, that
the charm handlers can call to run charm specific code.</p>
</div>
<div class="section" id="reacting-to-events">
<h2>Reacting to Events<a class="headerlink" href="#reacting-to-events" title="Permalink to this headline">¶</a></h2>
<p>Reactive charms react to events. These events could be raised by interfaces or
by other handlers. A number of event handlers are added by default by the
<a class="reference internal" href="#charms-openstack">charms.openstack</a> module. For example, an install handler runs by default and
will install the packages which were listed in NewServiceCharm.packages. Once
complete the &#8216;charm.installed&#8217; state is raised.  The charms handlers specific
to the new charm are defined in
<strong>src/reactive/new_charm_name_handlers.py</strong></p>
<p>For example, once the packages are installed it is likely that additional
configuration is needed e.g. rendering config, configuring bridges or updating
remote services via their interfaces. To perform an action once the initial
package installation has been done a handler needs to be added to listen for
the <strong>charm.installed</strong> event. To do this edit
<strong>src/reactive/new_charm_name_handlers.py</strong> and add the reactive handler:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;charm.installed&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">configure_foo</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">charm</span><span class="o">.</span><span class="n">provide_charm_instance</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_charm</span><span class="p">:</span>
        <span class="n">new_charm</span><span class="o">.</span><span class="n">configure_foo</span><span class="p">()</span>
</pre></div>
</div>
<p>If configure_foo() should only be run once then the handler can emit a new
state and the running of configure_foo gated on the state not being present
e.g.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@reactive.when_not</span><span class="p">(</span><span class="s1">&#39;foo.configured&#39;</span><span class="p">)</span>
<span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;charm.installed&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">configure_foo</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">charm</span><span class="o">.</span><span class="n">provide_charm_instance</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_charm</span><span class="p">:</span>
        <span class="n">new_charm</span><span class="o">.</span><span class="n">configure_foo</span><span class="p">()</span>
    <span class="n">reactive</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s1">&#39;foo.configured&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="file-templates">
<h2>File Templates<a class="headerlink" href="#file-templates" title="Permalink to this headline">¶</a></h2>
<p>Most charms need to write a configuration file from a template. The templates
are stored in <strong>src/templates</strong> see <a class="reference internal" href="#templates-directory">Templates Directory</a> for more details. The
context used to populate the template has a number of namespaces which are
populated from different sources. Below outlines those namespaces.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Hypens are always automatically converted to underscores in the template
context.</p>
</div>
<div class="section" id="template-properties-from-interfaces">
<h3>Template properties from Interfaces<a class="headerlink" href="#template-properties-from-interfaces" title="Permalink to this headline">¶</a></h3>
<p>By default some interfaces are automatically allocated a namespace within the
template context. Those namespaces are also automatically populated with some
options directly from the interface. For example if a charm is related to
Keystone&#8217;s <a class="reference external" href="https://github.com/openstack/charm-interface-keystone">keystone interface</a>
then a number of <strong>service_</strong> variables are set in the
identity_service namespace. So, charm template could contain the following to
access those variables:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span>[keystone_authtoken]
auth_uri = {{ identity_service.service_protocol }}://{{ identity_service.service_host }}:{{ identity_service.service_port }}
auth_url = {{ identity_service.auth_protocol }}://{{ identity_service.auth_host }}:{{ identity_service.auth_port }}
</pre></div>
</div>
<p>See the <strong>auto_accessors</strong> list in <a class="reference external" href="https://github.com/openstack/charm-interface-keystone/blob/master/requires.py">charm-interface-keystone</a>
for a complete list</p>
<p>However, most interface data is accessed via Adapters...</p>
</div>
<div class="section" id="template-properties-from-adapters">
<h3>Template properties from Adapters<a class="headerlink" href="#template-properties-from-adapters" title="Permalink to this headline">¶</a></h3>
<p>Adapters are used to take the data from an interface and create new variables
in the template context. For example the <strong>RabbitMQRelationAdapter</strong> (which can
be found in the <a class="reference external" href="https://github.com/openstack/charms.openstack/blob/master/charms_openstack/adapters.py">adapters.py</a>
from charms.openstack.) adds an <strong>ssl_ca_file</strong> variable to the amqp
namespace. This setting is really independent of the interface with rabbit but
should be consistent across the OpenStack deployment. This variable can then
be accessed in the same way as the rest of the amqp setting <tt class="docutils literal"><span class="pre">{{amqp.ssl_ca_file</span> <span class="pre">}}</span></tt></p>
</div>
<div class="section" id="template-properties-from-user-config">
<h3>Template properties from user config<a class="headerlink" href="#template-properties-from-user-config" title="Permalink to this headline">¶</a></h3>
<p>The settings exposed to the user via the config.yaml are added to the
<strong>options</strong> namespace.  The value the user has set for option  <strong>foo</strong> can be
retrieved inside a template by including <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">options.foo</span> <span class="pre">}}</span></tt></p>
</div>
<div class="section" id="template-properties-added-to-user-config">
<h3>Template properties added to user config<a class="headerlink" href="#template-properties-added-to-user-config" title="Permalink to this headline">¶</a></h3>
<p>It is useful to be able to set a property based on examining multiple config
options or examining other aspects of the runtime system. The
<strong>charms_openstack.adapters.config_property</strong> decorator can be used to achieve
this. In the example below if the user has set the boolean config option
<strong>angry</strong> to <strong>True</strong> and set the <strong>radiation</strong> string config option to
<strong>gamma</strong> then the <strong>hulk_mode</strong> property is set to True.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@charms_openstack.adapters.config_property</span>
<span class="k">def</span> <span class="nf">hulk_mode</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">angry</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">radiation</span> <span class="o">==</span><span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
<p>This can be accessed in the templates with <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">options.hulk_mode</span> <span class="pre">}}</span></tt></p>
</div>
<div class="section" id="template-properties-added-to-an-adapter">
<h3>Template properties added to an Adapter<a class="headerlink" href="#template-properties-added-to-an-adapter" title="Permalink to this headline">¶</a></h3>
<p>To be able to set a property based on the settings retrieved from an interface.
In the example below the charm sets a pipeline based on the Keystone API
version advertised by the keystone interface,</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@charms_openstack.adapters.adapter_property</span><span class="p">(</span><span class="s1">&#39;identity_service&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">charm_pipeline</span><span class="p">(</span><span class="n">keystone</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;cors keystone_authtoken context apiapp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;cors keystone_v3_authtoken context apiapp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="s2">&quot;cors unauthenticated-context apiapp&quot;</span>
    <span class="p">}[</span><span class="n">keystone</span><span class="o">.</span><span class="n">api_version</span><span class="p">]</span>
</pre></div>
</div>
<p>This can be accessed in the templates with <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">identity_service.charm_pipeline</span> <span class="pre">}}</span></tt></p>
</div>
<div class="section" id="templates-directory">
<span id="id7"></span><h3>Templates Directory<a class="headerlink" href="#templates-directory" title="Permalink to this headline">¶</a></h3>
<p>Template are loaded from several places in the following order:</p>
<ul class="simple">
<li>From the most recent OS release-specific template dir (if one exists)</li>
<li>Working back through the template directories for each earlier OpenStack Release</li>
<li>The base templates_dir</li>
</ul>
<p>For the example above, &#8216;templates&#8217; contains the following structure:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">templates</span><span class="o">/</span><span class="n">nova</span><span class="o">.</span><span class="n">conf</span>
<span class="n">templates</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>
<span class="n">templates</span><span class="o">/</span><span class="n">kilo</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>
<span class="n">templates</span><span class="o">/</span><span class="n">newton</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">paste</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>If the charm is deploying the Newton release, it first searches
the newton directory for nova.conf, then the templates dir. So
<strong>templates/nova.conf</strong> will be used.</p>
<p>When writing api-paste.ini, it will find the template in the newton
directory.</p>
<p>However if Liberty was being installed then the charm would fall back to the
kilo template for api-paste.ini since there is no Liberty specific version.</p>
</div>
<div class="section" id="rendering-a-template">
<h3>Rendering a Template<a class="headerlink" href="#rendering-a-template" title="Permalink to this headline">¶</a></h3>
<p>Rendering the templates does not usually make sense until all the interfaces
that are going to supply the template context with data are ready and
available. The <tt class="docutils literal"><span class="pre">&#64;reactive.when</span></tt> decorator not only ensures that the wrapped
method is not run until the interface is ready, it also passes an instance of
the interface to the method it is wrapping. These interfaces can then be passed
to the render_with_interfaces class which looks after finding the templates
and rendering them. render_with_interfaces decides which files need rendering
by examining the keys of the restart_map dict which was specified as part of
the charm class. Taking all this together results in a handler like this:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;shared-db.available&#39;</span><span class="p">)</span>
<span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;identity-service.available&#39;</span><span class="p">)</span>
<span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;amqp.available&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">render_config</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">charm</span><span class="o">.</span><span class="n">provide_charm_instance</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_charm</span><span class="p">:</span>
        <span class="n">new_charm</span><span class="o">.</span><span class="n">render_with_interfaces</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">new_charm</span><span class="o">.</span><span class="n">assess_status</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sending-data-via-an-interface">
<h2>Sending data via an Interface<a class="headerlink" href="#sending-data-via-an-interface" title="Permalink to this headline">¶</a></h2>
<p>Some interfaces are used to send as well as receive data. The interface will
expose a method for sending data to a remote application if it is supported.
For example the <a class="reference external" href="https://github.com/openstack/charm-interface-neutron-plugin">neutron-plugin interface</a>
can be used to send configuration to the principle charm.</p>
<p>The handler below waits for the neutron-plugin relation with the principle to
be complete at which point the <strong>neutron-plugin.connected</strong> state will be set
which will fire this trigger. An instance of the interface is passed by the
decorator to the <strong>configure_neutron_plugin</strong> method. This is in turn passed to
the <strong>configure_neutron_plugin</strong> method in the charm class.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="nd">@reactive.when</span><span class="p">(</span><span class="s1">&#39;neutron-plugin.connected&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">configure_neutron_plugin</span><span class="p">(</span><span class="n">neutron_plugin</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">charm</span><span class="o">.</span><span class="n">provide_charm_instance</span><span class="p">()</span> <span class="k">as</span> <span class="n">new_charm</span><span class="p">:</span>
        <span class="n">new_charm</span><span class="o">.</span><span class="n">configure_neutron_plugin</span><span class="p">(</span><span class="n">neutron_plugin</span><span class="p">)</span>
</pre></div>
</div>
<p>In the charm class the instance of the interface is used to update the
principle</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configure_neutron_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neutron_plugin</span><span class="p">):</span>
    <span class="n">neutron_plugin</span><span class="o">.</span><span class="n">configure_plugin</span><span class="p">(</span>
        <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;mysdn&#39;</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;nova-compute&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;/etc/nova/nova.conf&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">(</span><span class="s1">&#39;firewall_driver&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;nova.virt.firewall.&#39;</span>
                             <span class="s1">&#39;NoopFirewallDriver&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;libvirt_vif_driver&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;nova.virt.libvirt.vif.&#39;</span>
                             <span class="s1">&#39;LibvirtGenericVIFDriver&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;security_group_api&#39;</span><span class="p">,</span> <span class="s1">&#39;neutron&#39;</span><span class="p">),</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">})</span>
</pre></div>
</div>
<p>On receiving this data from the neutron_plugin relation the principle will add
the requested config into <strong>/etc/nova/nova.conf</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The amqp, shared-db and identity-service interfaces are automatically
updated so there is no need to add code for them unless a bespoke
configuration is needed.</p>
</div>
</div>
<div class="section" id="displaying-charm-status">
<h2>Displaying Charm Status<a class="headerlink" href="#displaying-charm-status" title="Permalink to this headline">¶</a></h2>
<p>The charm can declare what state it is in and this status is displayed to the
user via <em>juju status</em>. By default the charm code will look for the
<tt class="docutils literal"><span class="pre">required_relations</span></tt> attribute of the charm class. <tt class="docutils literal"><span class="pre">required_relations</span></tt> is
a list of interfaces. e.g. for an API charm ...</p>
<div class="code python highlight-python"><div class="highlight"><pre><span></span><span class="n">required_relations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shared-db&#39;</span><span class="p">,</span> <span class="s1">&#39;amqp&#39;</span><span class="p">,</span> <span class="s1">&#39;identity-service&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>The in built <tt class="docutils literal"><span class="pre">assess_status()</span></tt> method will check that each interface has
raised the <cite>{relation}.available</cite> state. If the relation is missing altogether
or if the relation has yet to raise the <cite>{relation}.available</cite> state then a
message is returned via <tt class="docutils literal"><span class="pre">juju</span> <span class="pre">status</span></tt></p>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Charm Anatomy</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#configuration-files">Configuration Files</a><ul>
<li><a class="reference internal" href="#layers-yaml">layers.yaml</a></li>
<li><a class="reference internal" href="#config-yaml">config.yaml</a></li>
<li><a class="reference internal" href="#metadata-yaml">metadata.yaml</a></li>
</ul>
</li>
<li><a class="reference internal" href="#openstack-layers">OpenStack Layers</a><ul>
<li><a class="reference internal" href="#basic-layer">Basic Layer</a></li>
<li><a class="reference internal" href="#openstack-layer">OpenStack Layer</a></li>
<li><a class="reference internal" href="#openstack-principle-layer">Openstack Principle Layer</a></li>
<li><a class="reference internal" href="#openstack-api-layer">Openstack API Layer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#openstack-interfaces">OpenStack Interfaces</a></li>
<li><a class="reference internal" href="#charms-openstack">charms.openstack</a></li>
<li><a class="reference internal" href="#defining-the-charm">Defining the Charm</a></li>
<li><a class="reference internal" href="#reacting-to-events">Reacting to Events</a></li>
<li><a class="reference internal" href="#file-templates">File Templates</a><ul>
<li><a class="reference internal" href="#template-properties-from-interfaces">Template properties from Interfaces</a></li>
<li><a class="reference internal" href="#template-properties-from-adapters">Template properties from Adapters</a></li>
<li><a class="reference internal" href="#template-properties-from-user-config">Template properties from user config</a></li>
<li><a class="reference internal" href="#template-properties-added-to-user-config">Template properties added to user config</a></li>
<li><a class="reference internal" href="#template-properties-added-to-an-adapter">Template properties added to an Adapter</a></li>
<li><a class="reference internal" href="#templates-directory">Templates Directory</a></li>
<li><a class="reference internal" href="#rendering-a-template">Rendering a Template</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sending-data-via-an-interface">Sending data via an Interface</a></li>
<li><a class="reference internal" href="#displaying-charm-status">Displaying Charm Status</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="creating-charms.html"
                                  title="previous chapter">Create A Charm</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="new-sdn-charm.html"
                                  title="next chapter">New SDN Charm</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/charm-guide
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/charm-anatomy.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="new-sdn-charm.html" title="New SDN Charm"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="creating-charms.html" title="Create A Charm"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack Charms Guide 0.0.1.dev33 documentation</a> &raquo;</li>
          <li><a href="creating-charms.html" accesskey="U">Create A Charm</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2017, OpenStack Contributors - use the <a href="https://git.openstack.org/cgit/openstack/openstack-charms-guide">openstack-charms-guide git repo</a> to propose changes.
      Last updated on Wed Feb 8 11:51:57 2017, commit d150c32.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/OpenStack Charms Guide");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>