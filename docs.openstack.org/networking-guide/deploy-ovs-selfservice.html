<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Open vSwitch: Self-service networks</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="_static/css/font-awesome.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">
<link href="_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="_static/sphinxmark.css" type="text/css" />
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/security/">Security</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/telecoms-and-nfv/">Telecoms and NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers & ISVs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/coa/">Get Certified</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//ask.openstack.org">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/analysts/">Analyst Reports</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
      <h2>Open vSwitch: Self-service networks</h2>
    
  </div>
  <div class="docs-actions">
    
    <a href="deploy-ovs-provider.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Open vSwitch: Provider networks"></i></a>
    
    
    <a href="deploy-ovs-ha-vrrp.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Open vSwitch: High availability using VRRP"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2017-02-14 13:48</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="index.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Open vSwitch: Self-service networks</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li><a class="reference internal" href="#architecture">Architecture</a></li>
<li><a class="reference internal" href="#example-configuration">Example configuration</a><ul>
<li><a class="reference internal" href="#controller-node">Controller node</a></li>
<li><a class="reference internal" href="#network-node">Network node</a></li>
<li><a class="reference internal" href="#compute-nodes">Compute nodes</a></li>
<li><a class="reference internal" href="#verify-service-operation">Verify service operation</a></li>
<li><a class="reference internal" href="#create-initial-networks">Create initial networks</a></li>
<li><a class="reference internal" href="#verify-network-operation">Verify network operation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#network-traffic-flow">Network traffic flow</a><ul>
<li><a class="reference internal" href="#north-south-scenario-1-instance-with-a-fixed-ip-address">North-south scenario 1: Instance with a fixed IP address</a></li>
<li><a class="reference internal" href="#north-south-scenario-2-instance-with-a-floating-ipv4-address">North-south scenario 2: Instance with a floating IPv4 address</a></li>
<li><a class="reference internal" href="#east-west-scenario-1-instances-on-the-same-network">East-west scenario 1: Instances on the same network</a></li>
<li><a class="reference internal" href="#east-west-scenario-2-instances-on-different-networks">East-west scenario 2: Instances on different networks</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="open-vswitch-self-service-networks">
<span id="deploy-ovs-selfservice"></span><h1>Open vSwitch: Self-service networks<a class="headerlink" href="#open-vswitch-self-service-networks" title="Permalink to this headline">¶</a></h1>
<p>This architecture example augments <a class="reference internal" href="deploy-ovs-provider.html#deploy-ovs-provider"><span>Open vSwitch: Provider networks</span></a> to support
a nearly limitless quantity of entirely virtual networks. Although the
Networking service supports VLAN self-service networks, this example
focuses on VXLAN self-service networks. For more information on
self-service networks, see <a class="reference internal" href="intro-os-networking.html#intro-os-networking-selfservice"><span>Self-service networks</span></a>.</p>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>Add one network node with the following components:</p>
<ul class="simple">
<li>Three network interfaces: management, provider, and overlay.</li>
<li>OpenStack Networking Open vSwitch (OVS) layer-2 agent, layer-3 agent, and
any including OVS.</li>
</ul>
<p>Modify the compute nodes with the following components:</p>
<ul class="simple">
<li>Add one network interface: overlay.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can keep the DHCP and metadata agents on each compute node or
move them to the network node.</p>
</div>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<img alt="Self-service networks using OVS - overview" src="_images/deploy-ovs-selfservice-overview.png" />
<p>The following figure shows components and connectivity for one self-service
network and one untagged (flat) provider network. In this particular case, the
instance resides on the same compute node as the DHCP agent for the network.
If the DHCP agent resides on another compute node, the latter only contains
a DHCP namespace and with a port on the OVS integration bridge.</p>
<img alt="Self-service networks using OVS - components and connectivity - one network" src="_images/deploy-ovs-selfservice-compconn1.png" />
</div>
<div class="section" id="example-configuration">
<h2>Example configuration<a class="headerlink" href="#example-configuration" title="Permalink to this headline">¶</a></h2>
<p>Use the following example configuration as a template to add support for
self-service networks to an existing operational environment that supports
provider networks.</p>
<div class="section" id="controller-node">
<h3>Controller node<a class="headerlink" href="#controller-node" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">In the <code class="docutils literal"><span class="pre">neutron.conf</span></code> file:</p>
<ul>
<li><p class="first">Enable routing and allow overlapping IP address ranges.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[DEFAULT]</span>
<span class="na">service_plugins</span> <span class="o">=</span> <span class="s">router</span>
<span class="na">allow_overlapping_ips</span> <span class="o">=</span> <span class="s">True</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">In the <code class="docutils literal"><span class="pre">ml2_conf.ini</span></code> file:</p>
<ul>
<li><p class="first">Add <code class="docutils literal"><span class="pre">vxlan</span></code> to type drivers and project network types.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ml2]</span>
<span class="na">type_drivers</span> <span class="o">=</span> <span class="s">flat,vlan,vxlan</span>
<span class="na">tenant_network_types</span> <span class="o">=</span> <span class="s">vxlan</span>
</pre></div>
</div>
</li>
<li><p class="first">Enable the layer-2 population mechanism driver.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ml2]</span>
<span class="na">mechanism_drivers</span> <span class="o">=</span> <span class="s">linuxbridge,l2population</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the VXLAN network ID (VNI) range.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ml2_type_vxlan]</span>
<span class="na">vni_ranges</span> <span class="o">=</span> <span class="s">VNI_START:VNI_END</span>
</pre></div>
</div>
<p>Replace <code class="docutils literal"><span class="pre">VNI_START</span></code> and <code class="docutils literal"><span class="pre">VNI_END</span></code> with appropriate numerical
values.</p>
</li>
</ul>
</li>
<li><p class="first">Restart the following services:</p>
<ul class="simple">
<li>Server</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="network-node">
<h3>Network node<a class="headerlink" href="#network-node" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Install the Networking service OVS layer-2 agent and layer-3 agent.</p>
</li>
<li><p class="first">Install OVS.</p>
</li>
<li><p class="first">In the <code class="docutils literal"><span class="pre">neutron.conf</span></code> file, configure common options:</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[DEFAULT]</span>
<span class="na">core_plugin</span> <span class="o">=</span> <span class="s">ml2</span>
<span class="na">auth_strategy</span> <span class="o">=</span> <span class="s">keystone</span>

<span class="k">[database]</span>
<span class="na">...</span>

<span class="k">[keystone_authtoken]</span>
<span class="na">...</span>

<span class="k">[nova]</span>
<span class="na">...</span>

<span class="k">[agent]</span>
<span class="na">...</span>
</pre></div>
</div>
<p>See the <a class="reference external" href="http://docs.openstack.org">Installation Tutorials and Guides</a> and
<a class="reference external" href="http://docs.openstack.org">Configuration Reference</a> for your OpenStack
release to obtain the appropriate additional configuration for the
<code class="docutils literal"><span class="pre">[DEFAULT]</span></code>, <code class="docutils literal"><span class="pre">[database]</span></code>, <code class="docutils literal"><span class="pre">[keystone_authtoken]</span></code>, <code class="docutils literal"><span class="pre">[nova]</span></code>, and
<code class="docutils literal"><span class="pre">[agent]</span></code> sections.</p>
</li>
<li><p class="first">Start the following services:</p>
<ul class="simple">
<li>OVS</li>
</ul>
</li>
<li><p class="first">Create the OVS provider bridge <code class="docutils literal"><span class="pre">br-provider</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ovs-vsctl add-br br-provider
</pre></div>
</div>
</li>
<li><p class="first">In the <code class="docutils literal"><span class="pre">openvswitch_agent.ini</span></code> file, configure the layer-2 agent.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ovs]</span>
<span class="na">bridge_mappings</span> <span class="o">=</span> <span class="s">provider:br-provider</span>
<span class="na">local_ip</span> <span class="o">=</span> <span class="s">OVERLAY_INTERFACE_IP_ADDRESS</span>

<span class="k">[agent]</span>
<span class="na">tunnel_types</span> <span class="o">=</span> <span class="s">vxlan</span>
<span class="na">l2_population</span> <span class="o">=</span> <span class="s">True</span>

<span class="k">[securitygroup]</span>
<span class="na">firewall_driver</span> <span class="o">=</span> <span class="s">iptables_hybrid</span>
</pre></div>
</div>
<p>Replace <code class="docutils literal"><span class="pre">OVERLAY_INTERFACE_IP_ADDRESS</span></code> with the IP address of the
interface that handles VXLAN overlays for self-service networks.</p>
</li>
<li><p class="first">In the <code class="docutils literal"><span class="pre">l3_agent.ini</span></code> file, configure the layer-3 agent.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[DEFAULT]</span>
<span class="na">interface_driver</span> <span class="o">=</span> <span class="s">openvswitch</span>
<span class="na">external_network_bridge</span> <span class="o">=</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">external_network_bridge</span></code> option intentionally contains
no value.</p>
</div>
</li>
<li><p class="first">Start the following services:</p>
<ul class="simple">
<li>Open vSwitch agent</li>
<li>Layer-3 agent</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="compute-nodes">
<h3>Compute nodes<a class="headerlink" href="#compute-nodes" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">In the <code class="docutils literal"><span class="pre">openvswitch_agent.ini</span></code> file, enable VXLAN support including
layer-2 population.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[ovs]</span>
<span class="na">local_ip</span> <span class="o">=</span> <span class="s">OVERLAY_INTERFACE_IP_ADDRESS</span>

<span class="k">[agent]</span>
<span class="na">tunnel_types</span> <span class="o">=</span> <span class="s">vxlan</span>
<span class="na">l2_population</span> <span class="o">=</span> <span class="s">True</span>
</pre></div>
</div>
<p>Replace <code class="docutils literal"><span class="pre">OVERLAY_INTERFACE_IP_ADDRESS</span></code> with the IP address of the
interface that handles VXLAN overlays for self-service networks.</p>
</li>
<li><p class="first">Restart the following services:</p>
<ul class="simple">
<li>Open vSwitch agent</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="verify-service-operation">
<h3>Verify service operation<a class="headerlink" href="#verify-service-operation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Source the administrative project credentials.</p>
</li>
<li><p class="first">Verify presence and operation of the agents.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack network agent list
<span class="go">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span>
<span class="go">| ID                                   | Agent Type         | Host     | Availability Zone | Alive | State | Binary                    |</span>
<span class="go">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span>
<span class="go">| 1236bbcb-e0ba-48a9-80fc-81202ca4fa51 | Metadata agent     | compute2 |                   | True  | UP    | neutron-metadata-agent    |</span>
<span class="go">| 457d6898-b373-4bb3-b41f-59345dcfb5c5 | Open vSwitch agent | compute2 |                   | True  | UP    | neutron-openvswitch-agent |</span>
<span class="go">| 71f15e84-bc47-4c2a-b9fb-317840b2d753 | DHCP agent         | compute2 | nova              | True  | UP    | neutron-dhcp-agent        |</span>
<span class="go">| 8805b962-de95-4e40-bdc2-7a0add7521e8 | L3 agent           | network1 | nova              | True  | UP    | neutron-l3-agent          |</span>
<span class="go">| a33cac5a-0266-48f6-9cac-4cef4f8b0358 | Open vSwitch agent | network1 |                   | True  | UP    | neutron-openvswitch-agent |</span>
<span class="go">| a6c69690-e7f7-4e56-9831-1282753e5007 | Metadata agent     | compute1 |                   | True  | UP    | neutron-metadata-agent    |</span>
<span class="go">| af11f22f-a9f4-404f-9fd8-cd7ad55c0f68 | DHCP agent         | compute1 | nova              | True  | UP    | neutron-dhcp-agent        |</span>
<span class="go">| bcfc977b-ec0e-4ba9-be62-9489b4b0e6f1 | Open vSwitch agent | compute1 |                   | True  | UP    | neutron-openvswitch-agent |</span>
<span class="go">+--------------------------------------+--------------------+----------+-------------------+-------+-------+---------------------------+</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="create-initial-networks">
<h3>Create initial networks<a class="headerlink" href="#create-initial-networks" title="Permalink to this headline">¶</a></h3>
<p>The configuration supports multiple VXLAN self-service networks. For
simplicity, the following procedure creates one self-service network and
a router with a gateway on the flat provider network. The router uses
NAT for IPv4 network traffic and directly routes IPv6 network traffic.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">IPv6 connectivity with self-service networks often requires addition of
static routes to nodes and physical network infrastructure.</p>
</div>
<ol class="arabic">
<li><p class="first">Source the administrative project credentials.</p>
</li>
<li><p class="first">Update the provider network to support external connectivity for
self-service networks.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack network <span class="nb">set</span> --external provider1
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This command provides no output.</p>
</div>
</li>
<li><p class="first">Source a regular (non-administrative) project credentials.</p>
</li>
<li><p class="first">Create a self-service network.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack network create selfservice1
<span class="go">+-------------------------+--------------+</span>
<span class="go">| Field                   | Value        |</span>
<span class="go">+-------------------------+--------------+</span>
<span class="go">| admin_state_up          | UP           |</span>
<span class="go">| mtu                     | 1450         |</span>
<span class="go">| name                    | selfservice1 |</span>
<span class="go">| port_security_enabled   | True         |</span>
<span class="go">| router:external         | Internal     |</span>
<span class="go">| shared                  | False        |</span>
<span class="go">| status                  | ACTIVE       |</span>
<span class="go">+-------------------------+--------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a IPv4 subnet on the self-service network.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack subnet create --subnet-range <span class="m">192</span>.168.1.0/24 <span class="se">\</span>
  --network selfservice1 --dns-nameserver <span class="m">8</span>.8.4.4 selfservice1-v4
<span class="go">+-------------------+---------------------------+</span>
<span class="go">| Field             | Value                     |</span>
<span class="go">+-------------------+---------------------------+</span>
<span class="go">| allocation_pools  | 192.168.1.2-192.168.1.254 |</span>
<span class="go">| cidr              | 192.168.1.0/24            |</span>
<span class="go">| dns_nameservers   | 8.8.4.4                   |</span>
<span class="go">| enable_dhcp       | True                      |</span>
<span class="go">| gateway_ip        | 192.168.1.1               |</span>
<span class="go">| ip_version        | 4                         |</span>
<span class="go">| name              | selfservice1-v4           |</span>
<span class="go">+-------------------+---------------------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a IPv6 subnet on the self-service network.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack subnet create --subnet-range fd00:192:168:1::/64 --ip-version <span class="m">6</span> <span class="se">\</span>
  --ipv6-ra-mode slaac --ipv6-address-mode slaac --network selfservice1 <span class="se">\</span>
  --dns-nameserver <span class="m">2001</span>:4860:4860::8844 selfservice1-v6
<span class="go">+-------------------+------------------------------------------------------+</span>
<span class="go">| Field             | Value                                                |</span>
<span class="go">+-------------------+------------------------------------------------------+</span>
<span class="go">| allocation_pools  | fd00:192:168:1::2-fd00:192:168:1:ffff:ffff:ffff:ffff |</span>
<span class="go">| cidr              | fd00:192:168:1::/64                                  |</span>
<span class="go">| dns_nameservers   | 2001:4860:4860::8844                                 |</span>
<span class="go">| enable_dhcp       | True                                                 |</span>
<span class="go">| gateway_ip        | fd00:192:168:1::1                                    |</span>
<span class="go">| ip_version        | 6                                                    |</span>
<span class="go">| ipv6_address_mode | slaac                                                |</span>
<span class="go">| ipv6_ra_mode      | slaac                                                |</span>
<span class="go">| name              | selfservice1-v6                                      |</span>
<span class="go">+-------------------+------------------------------------------------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a router.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack router create router1
<span class="go">+-----------------------+---------+</span>
<span class="go">| Field                 | Value   |</span>
<span class="go">+-----------------------+---------+</span>
<span class="go">| admin_state_up        | UP      |</span>
<span class="go">| name                  | router1 |</span>
<span class="go">| status                | ACTIVE  |</span>
<span class="go">+-----------------------+---------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the IPv4 and IPv6 subnets as interfaces on the router.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack router add subnet router1 selfservice1-v4
<span class="gp">$</span> openstack router add subnet router1 selfservice1-v6
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These commands provide no output.</p>
</div>
</li>
<li><p class="first">Add the provider network as the gateway on the router.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> neutron router-gateway-set router1 provider1
<span class="go">Set gateway for router router1</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="verify-network-operation">
<h3>Verify network operation<a class="headerlink" href="#verify-network-operation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">On each compute node, verify creation of a second <code class="docutils literal"><span class="pre">qdhcp</span></code> namespace.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip netns
<span class="go">qdhcp-8b868082-e312-4110-8627-298109d4401c</span>
<span class="go">qdhcp-8fbc13ca-cfe0-4b8a-993b-e33f37ba66d1</span>
</pre></div>
</div>
</li>
<li><p class="first">On the network node, verify creation of the <code class="docutils literal"><span class="pre">qrouter</span></code> namespace.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> ip netns
<span class="go">qrouter-17db2a15-e024-46d0-9250-4cd4d336a2cc</span>
</pre></div>
</div>
</li>
<li><p class="first">Source a regular (non-administrative) project credentials.</p>
</li>
<li><p class="first">Create the appropriate security group rules to allow <code class="docutils literal"><span class="pre">ping</span></code> and SSH
access instances using the network.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack security group rule create --proto icmp default
<span class="go">+------------------+-----------+</span>
<span class="go">| Field            | Value     |</span>
<span class="go">+------------------+-----------+</span>
<span class="go">| direction        | ingress   |</span>
<span class="go">| ethertype        | IPv4      |</span>
<span class="go">| protocol         | icmp      |</span>
<span class="go">| remote_ip_prefix | 0.0.0.0/0 |</span>
<span class="go">+------------------+-----------+</span>

<span class="gp">$</span> openstack security group rule create --ethertype IPv6 --proto ipv6-icmp default
<span class="go">+-----------+-----------+</span>
<span class="go">| Field     | Value     |</span>
<span class="go">+-----------+-----------+</span>
<span class="go">| direction | ingress   |</span>
<span class="go">| ethertype | IPv6      |</span>
<span class="go">| protocol  | ipv6-icmp |</span>
<span class="go">+-----------+-----------+</span>

<span class="gp">$</span> openstack security group rule create --proto tcp --dst-port <span class="m">22</span> default
<span class="go">+------------------+-----------+</span>
<span class="go">| Field            | Value     |</span>
<span class="go">+------------------+-----------+</span>
<span class="go">| direction        | ingress   |</span>
<span class="go">| ethertype        | IPv4      |</span>
<span class="go">| port_range_max   | 22        |</span>
<span class="go">| port_range_min   | 22        |</span>
<span class="go">| protocol         | tcp       |</span>
<span class="go">| remote_ip_prefix | 0.0.0.0/0 |</span>
<span class="go">+------------------+-----------+</span>

<span class="gp">$</span> openstack security group rule create --ethertype IPv6 --proto tcp --dst-port <span class="m">22</span> default
<span class="go">+------------------+-----------+</span>
<span class="go">| Field            | Value     |</span>
<span class="go">+------------------+-----------+</span>
<span class="go">| direction        | ingress   |</span>
<span class="go">| ethertype        | IPv6      |</span>
<span class="go">| port_range_max   | 22        |</span>
<span class="go">| port_range_min   | 22        |</span>
<span class="go">| protocol         | tcp       |</span>
<span class="go">+------------------+-----------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Launch an instance with an interface on the self-service network. For
example, a CirrOS image using flavor ID 1.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack server create --flavor <span class="m">1</span> --image cirros --nic net-id<span class="o">=</span>NETWORK_ID selfservice-instance1
</pre></div>
</div>
<p>Replace <code class="docutils literal"><span class="pre">NETWORK_ID</span></code> with the ID of the self-service network.</p>
</li>
<li><p class="first">Determine the IPv4 and IPv6 addresses of the instance.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack server list
<span class="go">+--------------------------------------+-----------------------+--------+--------------------------------------------------------------+</span>
<span class="go">| ID                                   | Name                  | Status | Networks                                                     |</span>
<span class="go">+--------------------------------------+-----------------------+--------+--------------------------------------------------------------+</span>
<span class="go">| c055cdb0-ebb4-4d65-957c-35cbdbd59306 | selfservice-instance1 | ACTIVE | selfservice1=192.168.1.4, fd00:192:168:1:f816:3eff:fe30:9cb0 |</span>
<span class="go">+--------------------------------------+-----------------------+--------+--------------------------------------------------------------+</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The IPv4 address resides in a private IP address range (RFC1918). Thus,
the Networking service performs source network address translation (SNAT)
for the instance to access external networks such as the Internet. Access
from external networks such as the Internet to the instance requires a
floating IPv4 address. The Networking service performs destination
network address translation (DNAT) from the floating IPv4 address to the
instance IPv4 address on the self-service network. On the other hand,
the Networking service architecture for IPv6 lacks support for NAT due
to the significantly larger address space and complexity of NAT. Thus,
floating IP addresses do not exist for IPv6 and the Networking service
only performs routing for IPv6 subnets on self-service networks. In
other words, you cannot rely on NAT to &#8220;hide&#8221; instances with IPv4 and
IPv6 addresses or only IPv6 addresses and must properly implement
security groups to restrict access.</p>
</div>
</li>
<li><p class="first">On the controller node or any host with access to the provider network,
<code class="docutils literal"><span class="pre">ping</span></code> the IPv6 address of the instance.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ping6 -c <span class="m">4</span> fd00:192:168:1:f816:3eff:fe30:9cb0
<span class="go">PING fd00:192:168:1:f816:3eff:fe30:9cb0(fd00:192:168:1:f816:3eff:fe30:9cb0) 56 data bytes</span>
<span class="go">64 bytes from fd00:192:168:1:f816:3eff:fe30:9cb0: icmp_seq=1 ttl=63 time=2.08 ms</span>
<span class="go">64 bytes from fd00:192:168:1:f816:3eff:fe30:9cb0: icmp_seq=2 ttl=63 time=1.88 ms</span>
<span class="go">64 bytes from fd00:192:168:1:f816:3eff:fe30:9cb0: icmp_seq=3 ttl=63 time=1.55 ms</span>
<span class="go">64 bytes from fd00:192:168:1:f816:3eff:fe30:9cb0: icmp_seq=4 ttl=63 time=1.62 ms</span>

<span class="go">--- fd00:192:168:1:f816:3eff:fe30:9cb0 ping statistics ---</span>
<span class="go">4 packets transmitted, 4 received, 0% packet loss, time 3004ms</span>
<span class="go">rtt min/avg/max/mdev = 1.557/1.788/2.085/0.217 ms</span>
</pre></div>
</div>
</li>
<li><p class="first">Optionally, enable IPv4 access from external networks such as the
Internet to the instance.</p>
<ol class="arabic">
<li><p class="first">Create a floating IPv4 address on the provider network.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack floating ip create provider1
<span class="go">+-------------+--------------------------------------+</span>
<span class="go">| Field       | Value                                |</span>
<span class="go">+-------------+--------------------------------------+</span>
<span class="go">| fixed_ip    | None                                 |</span>
<span class="go">| id          | 22a1b088-5c9b-43b4-97f3-970ce5df77f2 |</span>
<span class="go">| instance_id | None                                 |</span>
<span class="go">| ip          | 203.0.113.16                         |</span>
<span class="go">| pool        | provider1                            |</span>
<span class="go">+-------------+--------------------------------------+</span>
</pre></div>
</div>
</li>
<li><p class="first">Associate the floating IPv4 address with the instance.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack server add floating ip selfservice-instance1 <span class="m">203</span>.0.113.16
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This command provides no output.</p>
</div>
</li>
<li><p class="first">On the controller node or any host with access to the provider network,
<code class="docutils literal"><span class="pre">ping</span></code> the floating IPv4 address of the instance.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ping -c <span class="m">4</span> <span class="m">203</span>.0.113.16
<span class="go">PING 203.0.113.16 (203.0.113.16) 56(84) bytes of data.</span>
<span class="go">64 bytes from 203.0.113.16: icmp_seq=1 ttl=63 time=3.41 ms</span>
<span class="go">64 bytes from 203.0.113.16: icmp_seq=2 ttl=63 time=1.67 ms</span>
<span class="go">64 bytes from 203.0.113.16: icmp_seq=3 ttl=63 time=1.47 ms</span>
<span class="go">64 bytes from 203.0.113.16: icmp_seq=4 ttl=63 time=1.59 ms</span>

<span class="go">--- 203.0.113.16 ping statistics ---</span>
<span class="go">4 packets transmitted, 4 received, 0% packet loss, time 3005ms</span>
<span class="go">rtt min/avg/max/mdev = 1.473/2.040/3.414/0.798 ms</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Obtain access to the instance.</p>
</li>
<li><p class="first">Test IPv4 and IPv6 connectivity to the Internet or other external network.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="network-traffic-flow">
<span id="deploy-ovs-selfservice-networktrafficflow"></span><h2>Network traffic flow<a class="headerlink" href="#network-traffic-flow" title="Permalink to this headline">¶</a></h2>
<p>The following sections describe the flow of network traffic in several
common scenarios. <em>North-south</em> network traffic travels between an instance
and external network such as the Internet. <em>East-west</em> network traffic
travels between instances on the same or different networks. In all scenarios,
the physical network infrastructure handles switching and routing among
provider networks and external networks such as the Internet. Each case
references one or more of the following components:</p>
<ul class="simple">
<li>Provider network (VLAN)<ul>
<li>VLAN ID 101 (tagged)</li>
</ul>
</li>
<li>Self-service network 1 (VXLAN)<ul>
<li>VXLAN ID (VNI) 101</li>
</ul>
</li>
<li>Self-service network 2 (VXLAN)<ul>
<li>VXLAN ID (VNI) 102</li>
</ul>
</li>
<li>Self-service router<ul>
<li>Gateway on the provider network</li>
<li>Interface on self-service network 1</li>
<li>Interface on self-service network 2</li>
</ul>
</li>
<li>Instance 1</li>
<li>Instance 2</li>
</ul>
<div class="section" id="north-south-scenario-1-instance-with-a-fixed-ip-address">
<span id="deploy-ovs-selfservice-networktrafficflow-ns1"></span><h3>North-south scenario 1: Instance with a fixed IP address<a class="headerlink" href="#north-south-scenario-1-instance-with-a-fixed-ip-address" title="Permalink to this headline">¶</a></h3>
<p>For instances with a fixed IPv4 address, the network node performs SNAT
on north-south traffic passing from self-service to external networks
such as the Internet. For instances with a fixed IPv6 address, the network
node performs conventional routing of traffic between self-service and
external networks.</p>
<ul class="simple">
<li>The instance resides on compute node 1 and uses self-service network 1.</li>
<li>The instance sends a packet to a host on the Internet.</li>
</ul>
<p>The following steps involve compute node 1:</p>
<ol class="arabic simple">
<li>The instance interface (1) forwards the packet to the security group
bridge instance port (2) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (3) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge OVS port (4) forwards the packet to the OVS
integration bridge security group port (5) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>The OVS integration bridge adds an internal VLAN tag to the packet.</li>
<li>The OVS integration bridge exchanges the internal VLAN tag for an internal
tunnel ID.</li>
<li>The OVS integration bridge patch port (6) forwards the packet to the
OVS tunnel bridge patch port (7).</li>
<li>The OVS tunnel bridge (8) wraps the packet using VNI 101.</li>
<li>The underlying physical interface (9) for overlay networks forwards
the packet to the network node via the overlay network (10).</li>
</ol>
<p>The following steps involve the network node:</p>
<ol class="arabic simple">
<li>The underlying physical interface (11) for overlay networks forwards
the packet to the OVS tunnel bridge (12).</li>
<li>The OVS tunnel bridge unwraps the packet and adds an internal tunnel ID
to it.</li>
<li>The OVS tunnel bridge exchanges the internal tunnel ID for an internal
VLAN tag.</li>
<li>The OVS tunnel bridge patch port (13) forwards the packet to the OVS
integration bridge patch port (14).</li>
<li>The OVS integration bridge port for the self-service network (15)
removes the internal VLAN tag and forwards the packet to the self-service
network interface (16) in the router namespace.<ul>
<li>For IPv4, the router performs SNAT on the packet which changes the
source IP address to the router IP address on the provider network
and sends it to the gateway IP address on the provider network via
the gateway interface on the provider network (17).</li>
<li>For IPv6, the router sends the packet to the next-hop IP address,
typically the gateway IP address on the provider network, via the
provider gateway interface (17).</li>
</ul>
</li>
<li>The router forwards the packet to the OVS integration bridge port for
the provider network (18).</li>
<li>The OVS integration bridge adds the internal VLAN tag to the packet.</li>
<li>The OVS integration bridge <code class="docutils literal"><span class="pre">int-br-provider</span></code> patch port (19) forwards
the packet to the OVS provider bridge <code class="docutils literal"><span class="pre">phy-br-provider</span></code> patch port (20).</li>
<li>The OVS provider bridge swaps the internal VLAN tag with actual VLAN tag
101.</li>
<li>The OVS provider bridge provider network port (21) forwards the packet to
the physical network interface (22).</li>
<li>The physical network interface forwards the packet to the Internet via
physical network infrastructure (23).</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Return traffic follows similar steps in reverse. However, without a
floating IPv4 address, hosts on the provider or external networks cannot
originate connections to instances on the self-service network.</p>
</div>
<img alt="Self-service networks using Open vSwitch - network traffic flow - north/south scenario 1" src="_images/deploy-ovs-selfservice-flowns1.png" />
</div>
<div class="section" id="north-south-scenario-2-instance-with-a-floating-ipv4-address">
<h3>North-south scenario 2: Instance with a floating IPv4 address<a class="headerlink" href="#north-south-scenario-2-instance-with-a-floating-ipv4-address" title="Permalink to this headline">¶</a></h3>
<p>For instances with a floating IPv4 address, the network node performs SNAT
on north-south traffic passing from the instance to external networks
such as the Internet and DNAT on north-south traffic passing from external
networks to the instance. Floating IP addresses and NAT do not apply to IPv6.
Thus, the network node routes IPv6 traffic in this scenario.</p>
<ul class="simple">
<li>The instance resides on compute node 1 and uses self-service network 1.</li>
<li>A host on the Internet sends a packet to the instance.</li>
</ul>
<p>The following steps involve the network node:</p>
<ol class="arabic simple">
<li>The physical network infrastructure (1) forwards the packet to the
provider physical network interface (2).</li>
<li>The provider physical network interface forwards the packet to the
OVS provider bridge provider network port (3).</li>
<li>The OVS provider bridge swaps actual VLAN tag 101 with the internal
VLAN tag.</li>
<li>The OVS provider bridge <code class="docutils literal"><span class="pre">phy-br-provider</span></code> port (4) forwards the
packet to the OVS integration bridge <code class="docutils literal"><span class="pre">int-br-provider</span></code> port (5).</li>
<li>The OVS integration bridge port for the provider network (6) removes
the internal VLAN tag and forwards the packet to the provider network
interface (6) in the router namespace.<ul>
<li>For IPv4, the router performs DNAT on the packet which changes the
destination IP address to the instance IP address on the self-service
network and sends it to the gateway IP address on the self-service
network via the self-service interface (7).</li>
<li>For IPv6, the router sends the packet to the next-hop IP address,
typically the gateway IP address on the self-service network, via
the self-service interface (8).</li>
</ul>
</li>
<li>The router forwards the packet to the OVS integration bridge port for
the self-service network (9).</li>
<li>The OVS integration bridge adds an internal VLAN tag to the packet.</li>
<li>The OVS integration bridge exchanges the internal VLAN tag for an internal
tunnel ID.</li>
<li>The OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (10) forwards the
packet to the OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (11).</li>
<li>The OVS tunnel bridge (12) wraps the packet using VNI 101.</li>
<li>The underlying physical interface (13) for overlay networks forwards
the packet to the network node via the overlay network (14).</li>
</ol>
<p>The following steps involve the compute node:</p>
<ol class="arabic simple">
<li>The underlying physical interface (15) for overlay networks forwards
the packet to the OVS tunnel bridge (16).</li>
<li>The OVS tunnel bridge unwraps the packet and adds an internal tunnel ID
to it.</li>
<li>The OVS tunnel bridge exchanges the internal tunnel ID for an internal
VLAN tag.</li>
<li>The OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (17) forwards the packet
to the OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (18).</li>
<li>The OVS integration bridge removes the internal VLAN tag from the packet.</li>
<li>The OVS integration bridge security group port (19) forwards the packet
to the security group bridge OVS port (20) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (21) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge instance port (22) forwards the packet to the
instance interface (23) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
</ol>
<img alt="Self-service networks using Open vSwitch - network traffic flow - north/south scenario 2" src="_images/deploy-ovs-selfservice-flowns2.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Egress instance traffic flows similar to north-south scenario 1, except SNAT
changes the source IP address of the packet to the floating IPv4 address
rather than the router IP address on the provider network.</p>
</div>
</div>
<div class="section" id="east-west-scenario-1-instances-on-the-same-network">
<h3>East-west scenario 1: Instances on the same network<a class="headerlink" href="#east-west-scenario-1-instances-on-the-same-network" title="Permalink to this headline">¶</a></h3>
<p>Instances with a fixed IPv4/IPv6 address or floating IPv4 address on the
same network communicate directly between compute nodes containing those
instances.</p>
<p>By default, the VXLAN protocol lacks knowledge of target location
and uses multicast to discover it. After discovery, it stores the
location in the local forwarding database. In large deployments,
the discovery process can generate a significant amount of network
that all nodes must process. To eliminate the latter and generally
increase efficiency, the Networking service includes the layer-2
population mechanism driver that automatically populates the
forwarding database for VXLAN interfaces. The example configuration
enables this driver. For more information, see <a class="reference internal" href="config-ml2.html#config-plugin-ml2"><span>ML2 plug-in</span></a>.</p>
<ul class="simple">
<li>Instance 1 resides on compute node 1 and uses self-service network 1.</li>
<li>Instance 2 resides on compute node 2 and uses self-service network 1.</li>
<li>Instance 1 sends a packet to instance 2.</li>
</ul>
<p>The following steps involve compute node 1:</p>
<ol class="arabic simple">
<li>The instance 1 interface (1) forwards the packet to the security group
bridge instance port (2) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (3) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge OVS port (4) forwards the packet to the OVS
integration bridge security group port (5) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>The OVS integration bridge adds an internal VLAN tag to the packet.</li>
<li>The OVS integration bridge exchanges the internal VLAN tag for an internal
tunnel ID.</li>
<li>The OVS integration bridge patch port (6) forwards the packet to the
OVS tunnel bridge patch port (7).</li>
<li>The OVS tunnel bridge (8) wraps the packet using VNI 101.</li>
<li>The underlying physical interface (9) for overlay networks forwards
the packet to compute node 2 via the overlay network (10).</li>
</ol>
<p>The following steps involve compute node 2:</p>
<ol class="arabic simple">
<li>The underlying physical interface (11) for overlay networks forwards
the packet to the OVS tunnel bridge (12).</li>
<li>The OVS tunnel bridge unwraps the packet and adds an internal tunnel ID
to it.</li>
<li>The OVS tunnel bridge exchanges the internal tunnel ID for an internal
VLAN tag.</li>
<li>The OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (13) forwards the packet
to the OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (14).</li>
<li>The OVS integration bridge removes the internal VLAN tag from the packet.</li>
<li>The OVS integration bridge security group port (15) forwards the packet
to the security group bridge OVS port (16) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (17) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge instance port (18) forwards the packet to the
instance 2 interface (19) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
</ol>
<img alt="Self-service networks using Open vSwitch - network traffic flow - east/west scenario 1" src="_images/deploy-ovs-selfservice-flowew1.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Return traffic follows similar steps in reverse.</p>
</div>
</div>
<div class="section" id="east-west-scenario-2-instances-on-different-networks">
<h3>East-west scenario 2: Instances on different networks<a class="headerlink" href="#east-west-scenario-2-instances-on-different-networks" title="Permalink to this headline">¶</a></h3>
<p>Instances using a fixed IPv4/IPv6 address or floating IPv4 address communicate
via router on the network node. The self-service networks must reside on the
same router.</p>
<ul class="simple">
<li>Instance 1 resides on compute node 1 and uses self-service network 1.</li>
<li>Instance 2 resides on compute node 1 and uses self-service network 2.</li>
<li>Instance 1 sends a packet to instance 2.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both instances reside on the same compute node to illustrate how VXLAN
enables multiple overlays to use the same layer-3 network.</p>
</div>
<p>The following steps involve the compute node:</p>
<ol class="arabic simple">
<li>The instance interface (1) forwards the packet to the security group
bridge instance port (2) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (3) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge OVS port (4) forwards the packet to the OVS
integration bridge security group port (5) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>The OVS integration bridge adds an internal VLAN tag to the packet.</li>
<li>The OVS integration bridge exchanges the internal VLAN tag for an internal
tunnel ID.</li>
<li>The OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (6) forwards the
packet to the OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (7).</li>
<li>The OVS tunnel bridge (8) wraps the packet using VNI 101.</li>
<li>The underlying physical interface (9) for overlay networks forwards
the packet to the network node via the overlay network (10).</li>
</ol>
<p>The following steps involve the network node:</p>
<ol class="arabic simple">
<li>The underlying physical interface (11) for overlay networks forwards
the packet to the OVS tunnel bridge (12).</li>
<li>The OVS tunnel bridge unwraps the packet and adds an internal tunnel ID
to it.</li>
<li>The OVS tunnel bridge exchanges the internal tunnel ID for an internal
VLAN tag.</li>
<li>The OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (13) forwards the packet to
the OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (14).</li>
<li>The OVS integration bridge port for self-service network 1 (15)
removes the internal VLAN tag and forwards the packet to the self-service
network 1 interface (16) in the router namespace.</li>
<li>The router sends the packet to the next-hop IP address, typically the
gateway IP address on self-service network 2, via the self-service
network 2 interface (17).</li>
<li>The router forwards the packet to the OVS integration bridge port for
self-service network 2 (18).</li>
<li>The OVS integration bridge adds the internal VLAN tag to the packet.</li>
<li>The OVS integration bridge exchanges the internal VLAN tag for an internal
tunnel ID.</li>
<li>The OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (19) forwards the
packet to the OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (20).</li>
<li>The OVS tunnel bridge (21) wraps the packet using VNI 102.</li>
<li>The underlying physical interface (22) for overlay networks forwards
the packet to the compute node via the overlay network (23).</li>
</ol>
<p>The following steps involve the compute node:</p>
<ol class="arabic simple">
<li>The underlying physical interface (24) for overlay networks forwards
the packet to the OVS tunnel bridge (25).</li>
<li>The OVS tunnel bridge unwraps the packet and adds an internal tunnel
ID to it.</li>
<li>The OVS tunnel bridge exchanges the internal tunnel ID for an internal
VLAN tag.</li>
<li>The OVS tunnel bridge <code class="docutils literal"><span class="pre">patch-int</span></code> patch port (26) forwards the packet
to the OVS integration bridge <code class="docutils literal"><span class="pre">patch-tun</span></code> patch port (27).</li>
<li>The OVS integration bridge removes the internal VLAN tag from the packet.</li>
<li>The OVS integration bridge security group port (28) forwards the packet
to the security group bridge OVS port (29) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
<li>Security group rules (30) on the security group bridge handle firewalling
and connection tracking for the packet.</li>
<li>The security group bridge instance port (31) forwards the packet to the
instance interface (32) via <code class="docutils literal"><span class="pre">veth</span></code> pair.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Return traffic follows similar steps in reverse.</p>
</div>
<img alt="Self-service networks using Open vSwitch - network traffic flow - east/west scenario 2" src="_images/deploy-ovs-selfservice-flowew2.png" />
</div>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="deploy-ovs-provider.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Open vSwitch: Provider networks"></i></a>
          
          
            <a href="deploy-ovs-ha-vrrp.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Open vSwitch: High availability using VRRP"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2017-02-14 13:48</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="common/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="deploy.html">Deployment examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="deploy.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="deploy.html#mechanism-drivers">Mechanism drivers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ops.html">Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/app-support.html">Community support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-1.12.4.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "deploy-ovs-selfservice" + ".rst";
        gitURL = "Source: http://git.openstack.org/cgit/openstack/openstack-manuals/tree/doc/networking-guide/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: b8fd8c76e4ec1d07c2970cbd5770a38196b5b343";
        var bugProject = "openstack-manuals";
        var bugTitle = "Open vSwitch: Self-service networks in Networking Guide";
    var fieldTags = "networking-guide";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.9 on 2017-02-14 13:48";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>
</html>