<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>

    <title>OpenStack Docs: Recover from a failed compute node</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link href="_static/css/bootstrap.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="_static/css/native.css" rel="stylesheet">

<!-- Fonts -->
<link href="_static/css/font-awesome.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

<!-- Custom CSS -->
<link href="_static/css/combined.css" rel="stylesheet">
<link href="_static/css/styles.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
  


<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

  </head>
  <body>
<nav class="navbar navbar-default inner" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <div class="brand-wrapper">
        <a class="navbar-brand" href="/"></a>
      </div>
      <div class="search-icon show"><i class="fa fa-search"></i> Search</div></div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <div class="search-container tiny">
        <div id="gcse">
          <script type="text/javascript">
(function() {
  var cx = '000108871792296872333:noj9nikm74i';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
      '//www.google.com/cse/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
          </script>
          <gcse:search gname="standard"></gcse:search>
        </div>
        <i class="fa fa-times close-search"></i>
      </div>
      <ul class="nav navbar-nav navbar-main show">
        <li>
          <div id="gcse-mobile">
            <gcse:search gname="mobile"></gcse:search>
          </div>
        </li>
        <li>
          <a href="http://www.openstack.org/software/" class="drop" id="dropdownMenuSoftware">Software <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuSoftware">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/project-navigator/">Project Navigator</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sample-configs/">Sample Configs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/software/security/">Security</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/start/">Get Started</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/roadmap/">Roadmap</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/latest-release/">Latest Release</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/software/sourcecode/">Source Code</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/user-stories/" class="drop" id="dropdownMenuUsers">Users <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuUsers">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/user-stories/">Overview</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/telecoms-and-nfv/">Telecoms and NFV</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/enterprise/">OpenStack in the Enterprise</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/appdev/">Application Developers & ISVs</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://superuser.openstack.org/">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/surveys/landing">User Survey</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/community/" class="drop" id="dropdownMenuCommunity">Community <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuCommunity">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/">Welcome! Start Here</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/">OpenStack Foundation</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://wiki.openstack.org">OpenStack Wiki</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://groups.openstack.org">User Groups</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/speakers/">Speakers Bureau</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/foundation/companies/">Supporting Companies</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/jobs/">Jobs</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/join/">Join The Community</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/marketplace/">Marketplace</a>
        </li>
        <li>
          <a href="http://www.openstack.org/events/" class="drop" id="dropdownMenuEvents">Events <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">Overview</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/summit/">The OpenStack Summit</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//www.openstack.org/community/events/">More OpenStack Events</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/community/events/#openstack_days">OpenStack Days</a></li>
          </ul>
        </li>
        <li>
          <a href="http://www.openstack.org/learn/" class="drop" id="dropdownMenuLearn">Learn <i class="fa fa-caret-down"></i></a>
          <ul class="dropdown-menu dropdown-hover" role="menu" aria-labelledby="dropdownMenuEvents">
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/marketplace/training/">Training</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/marketplace/coa/">Get Certified</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//ask.openstack.org">Ask a Technical Question</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="//superuser.openstack.org">Superuser Magazine</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/videos/">Summit Videos</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="https://www.openstack.org/analysts/">Analyst Reports</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/news/">News</a></li>
            <li role="presentation"><a role="menuitem" tabindex="-1" href="http://www.openstack.org/blog/">Blog</a></li>
          </ul>
        </li>
        <li>
          <a href="http://docs.openstack.org/">Docs</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row">
  <div class="col-lg-8">
      <h2>Recover from a failed compute node</h2>
    
  </div>
  <div class="docs-actions">
    
    <a href="compute-security.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Security hardening"></i></a>
    
    
    <a href="compute-adv-config.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Advanced configuration"></i></a>
    
    <a id="logABugLink1" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
  </div>
</div>
          <div class="row docs-byline">
            <div class="docs-updated">updated: 2017-02-14 13:52</div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-top-contents">

<h5><a href="index.html">Contents</a></h5>
<ul>
<li><a class="reference internal" href="#">Recover from a failed compute node</a><ul>
<li><a class="reference internal" href="#evacuate-instances">Evacuate instances</a></li>
<li><a class="reference internal" href="#manual-recovery">Manual recovery</a></li>
<li><a class="reference internal" href="#recover-from-a-uid-gid-mismatch">Recover from a UID/GID mismatch</a></li>
<li><a class="reference internal" href="#recover-cloud-after-disaster">Recover cloud after disaster</a></li>
</ul>
</li>
</ul>

              </div>
              <div class="docs-body">

  <div class="section" id="recover-from-a-failed-compute-node">
<span id="section-nova-compute-node-down"></span><h1>Recover from a failed compute node<a class="headerlink" href="#recover-from-a-failed-compute-node" title="Permalink to this headline">¶</a></h1>
<p>If you deploy Compute with a shared file system, you can use several methods
to quickly recover from a node failure. This section discusses manual
recovery.</p>
<div class="section" id="evacuate-instances">
<h2>Evacuate instances<a class="headerlink" href="#evacuate-instances" title="Permalink to this headline">¶</a></h2>
<p>If a hardware malfunction or other error causes the cloud compute node to
fail, you can use the <strong class="command">nova evacuate</strong> command to evacuate instances.
See the <a class="reference external" href="https://docs.openstack.org/admin-guide/cli-nova-evacuate.html">OpenStack Administrator Guide</a>.</p>
</div>
<div class="section" id="manual-recovery">
<span id="nova-compute-node-down-manual-recovery"></span><h2>Manual recovery<a class="headerlink" href="#manual-recovery" title="Permalink to this headline">¶</a></h2>
<p>To manually recover a failed compute node:</p>
<ol class="arabic">
<li><p class="first">Identify the VMs on the affected hosts by using a combination of
the <strong class="command">openstack server list</strong> and <strong class="command">openstack server show</strong>
commands or the <strong class="command">euca-describe-instances</strong> command.</p>
<p>For example, this command displays information about the i-000015b9
instance that runs on the np-rcc54 node:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> euca-describe-instances
<span class="go">i-000015b9 at3-ui02 running nectarkey (376, np-rcc54) 0 m1.xxlarge 2012-06-19T00:48:11.000Z 115.146.93.60</span>
</pre></div>
</div>
</li>
<li><p class="first">Query the Compute database for the status of the host. This example
converts an EC2 API instance ID to an OpenStack ID. If you use the
<strong class="command">nova</strong> commands, you can substitute the ID directly. This example
output is truncated:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>mysql&gt; SELECT * FROM instances WHERE id = CONV(&#39;15b9&#39;, 16, 10) \G;
*************************** 1. row ***************************
created_at: 2012-06-19 00:48:11
updated_at: 2012-07-03 00:35:11
deleted_at: NULL
...
id: 5561
...
power_state: 5
vm_state: shutoff
...
hostname: at3-ui02
host: np-rcc54
...
uuid: 3f57699a-e773-4650-a443-b4b37eed5a06
...
task_state: NULL
...
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Find the credentials for your database in <code class="docutils literal"><span class="pre">/etc/nova.conf</span></code> file.</p>
</div>
</li>
<li><p class="first">Decide to which compute host to move the affected VM. Run this database
command to move the VM to that host:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">UPDATE</span> <span class="n">instances</span> <span class="kt">SET</span> <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;np-rcc46&#39;</span> <span class="k">WHERE</span> <span class="n">uuid</span> <span class="o">=</span> <span class="s1">&#39;3f57699a-e773-4650-a443-b4b37eed5a06&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">If you use a hypervisor that relies on libvirt, such as KVM, update the
<code class="docutils literal"><span class="pre">libvirt.xml</span></code> file in <code class="docutils literal"><span class="pre">/var/lib/nova/instances/[instance</span> <span class="pre">ID]</span></code> with
these changes:</p>
<ul class="simple">
<li>Change the <code class="docutils literal"><span class="pre">DHCPSERVER</span></code> value to the host IP address of the new
compute host.</li>
<li>Update the VNC IP to <code class="docutils literal"><span class="pre">0.0.0.0</span></code>.</li>
</ul>
</li>
<li><p class="first">Reboot the VM:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> openstack server reboot 3f57699a-e773-4650-a443-b4b37eed5a06
</pre></div>
</div>
</li>
</ol>
<p>Typically, the database update and <strong class="command">openstack server reboot</strong> command
recover a VM from a failed host. However, if problems persist, try one of
these actions:</p>
<ul class="simple">
<li>Use <strong class="command">virsh</strong> to recreate the network filter configuration.</li>
<li>Restart Compute services.</li>
<li>Update the <code class="docutils literal"><span class="pre">vm_state</span></code> and <code class="docutils literal"><span class="pre">power_state</span></code> fields in the Compute database.</li>
</ul>
</div>
<div class="section" id="recover-from-a-uid-gid-mismatch">
<span id="section-nova-uid-mismatch"></span><h2>Recover from a UID/GID mismatch<a class="headerlink" href="#recover-from-a-uid-gid-mismatch" title="Permalink to this headline">¶</a></h2>
<p>Sometimes when you run Compute with a shared file system or an automated
configuration tool, files on your compute node might use the wrong UID or GID.
This UID or GID mismatch can prevent you from running live migrations or
starting virtual machines.</p>
<p>This procedure runs on <code class="docutils literal"><span class="pre">nova-compute</span></code> hosts, based on the KVM hypervisor:</p>
<ol class="arabic">
<li><p class="first">Set the nova UID to the same number in <code class="docutils literal"><span class="pre">/etc/passwd</span></code> on all hosts. For
example, set the UID to <code class="docutils literal"><span class="pre">112</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Choose UIDs or GIDs that are not in use for other users or groups.</p>
</div>
</li>
<li><p class="first">Set the <code class="docutils literal"><span class="pre">libvirt-qemu</span></code> UID to the same number in the <code class="docutils literal"><span class="pre">/etc/passwd</span></code> file
on all hosts. For example, set the UID to <code class="docutils literal"><span class="pre">119</span></code>.</p>
</li>
<li><p class="first">Set the <code class="docutils literal"><span class="pre">nova</span></code> group to the same number in the <code class="docutils literal"><span class="pre">/etc/group</span></code> file on all
hosts. For example, set the group to <code class="docutils literal"><span class="pre">120</span></code>.</p>
</li>
<li><p class="first">Set the <code class="docutils literal"><span class="pre">libvirtd</span></code> group to the same number in the <code class="docutils literal"><span class="pre">/etc/group</span></code> file on
all hosts. For example, set the group to <code class="docutils literal"><span class="pre">119</span></code>.</p>
</li>
<li><p class="first">Stop the services on the compute node.</p>
</li>
<li><p class="first">Change all files that the nova user or group owns. For example:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> find / -uid <span class="m">108</span> -exec chown nova <span class="o">{}</span> <span class="se">\;</span>
<span class="gp">#</span> note the <span class="m">108</span> here is the old nova UID before the change
<span class="gp">#</span> find / -gid <span class="m">120</span> -exec chgrp nova <span class="o">{}</span> <span class="se">\;</span>
</pre></div>
</div>
</li>
<li><p class="first">Repeat all steps for the <code class="docutils literal"><span class="pre">libvirt-qemu</span></code> files, if required.</p>
</li>
<li><p class="first">Restart the services.</p>
</li>
<li><p class="first">To verify that all files use the correct IDs, run the <strong class="command">find</strong>
command.</p>
</li>
</ol>
</div>
<div class="section" id="recover-cloud-after-disaster">
<span id="section-nova-disaster-recovery-process"></span><h2>Recover cloud after disaster<a class="headerlink" href="#recover-cloud-after-disaster" title="Permalink to this headline">¶</a></h2>
<p>This section describes how to manage your cloud after a disaster and back up
persistent storage volumes. Backups are mandatory, even outside of disaster
scenarios.</p>
<p>For a definition of a disaster recovery plan (DRP), see
<a class="reference external" href="https://en.wikipedia.org/wiki/Disaster_Recovery_Plan">https://en.wikipedia.org/wiki/Disaster_Recovery_Plan</a>.</p>
<p>A disk crash, network loss, or power failure can affect several components in
your cloud architecture. The worst disaster for a cloud is a power loss. A
power loss affects these components:</p>
<ul class="simple">
<li>A cloud controller (<code class="docutils literal"><span class="pre">nova-api</span></code>, <code class="docutils literal"><span class="pre">nova-objectstore</span></code>, <code class="docutils literal"><span class="pre">nova-network</span></code>)</li>
<li>A compute node (<code class="docutils literal"><span class="pre">nova-compute</span></code>)</li>
<li>A storage area network (SAN) used by OpenStack Block Storage
(<code class="docutils literal"><span class="pre">cinder-volumes</span></code>)</li>
</ul>
<p>Before a power loss:</p>
<ul class="simple">
<li>Create an active iSCSI session from the SAN to the cloud controller
(used for the <code class="docutils literal"><span class="pre">cinder-volumes</span></code> LVM&#8217;s VG).</li>
<li>Create an active iSCSI session from the cloud controller to the compute
node (managed by <code class="docutils literal"><span class="pre">cinder-volume</span></code>).</li>
<li>Create an iSCSI session for every volume (so 14 EBS volumes requires 14
iSCSI sessions).</li>
<li>Create <code class="docutils literal"><span class="pre">iptables</span></code> or <code class="docutils literal"><span class="pre">ebtables</span></code> rules from the cloud controller to the
compute node. This allows access from the cloud controller to the
running instance.</li>
<li>Save the current state of the database, the current state of the running
instances, and the attached volumes (mount point, volume ID, volume
status, etc), at least from the cloud controller to the compute node.</li>
</ul>
<p>After power resumes and all hardware components restart:</p>
<ul>
<li><p class="first">The iSCSI session from the SAN to the cloud no longer exists.</p>
</li>
<li><p class="first">The iSCSI session from the cloud controller to the compute node no
longer exists.</p>
</li>
<li><p class="first">nova-network reapplies configurations on boot and, as a result, recreates
the iptables and ebtables from the cloud controller to the compute node.</p>
</li>
<li><p class="first">Instances stop running.</p>
<p>Instances are not lost because neither <code class="docutils literal"><span class="pre">destroy</span></code> nor <code class="docutils literal"><span class="pre">terminate</span></code> ran.
The files for the instances remain on the compute node.</p>
</li>
<li><p class="first">The database does not update.</p>
</li>
</ul>
<p><strong>Begin recovery</strong></p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do not add any steps or change the order of steps in this procedure.</p>
</div>
<ol class="arabic">
<li><p class="first">Check the current relationship between the volume and its instance, so
that you can recreate the attachment.</p>
<p>Use the <strong class="command">openstack volume list</strong> command to get this information.
Note that the <strong class="command">openstack</strong> client can get volume information
from OpenStack Block Storage.</p>
</li>
<li><p class="first">Update the database to clean the stalled state. Do this for every
volume by using these queries:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">cinder</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">volumes</span> <span class="kt">set</span> <span class="n">mountpoint</span><span class="o">=</span><span class="no">NULL</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">volumes</span> <span class="kt">set</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;available&quot;</span> <span class="k">where</span> <span class="n">status</span> <span class="o">&lt;&gt;</span><span class="s2">&quot;error_deleting&quot;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">volumes</span> <span class="kt">set</span> <span class="n">attach_status</span><span class="o">=</span><span class="s2">&quot;detached&quot;</span><span class="p">;</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">volumes</span> <span class="kt">set</span> <span class="n">instance_id</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>Use <strong class="command">openstack volume list</strong> command to list all volumes.</p>
</li>
<li><p class="first">Restart the instances by using the
<strong class="command">openstack server reboot INSTANCE</strong> command.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>Some instances completely reboot and become reachable, while some might
stop at the plymouth stage. This is expected behavior. DO NOT reboot a
second time.</p>
<p class="last">Instance state at this stage depends on whether you added an
<cite>/etc/fstab</cite> entry for that volume. Images built with the cloud-init
package remain in a <code class="docutils literal"><span class="pre">pending</span></code> state, while others skip the missing
volume and start. You perform this step to ask Compute to reboot every
instance so that the stored state is preserved. It does not matter if
not all instances come up successfully. For more information about
cloud-init, see
<a class="reference external" href="https://help.ubuntu.com/community/CloudInit/">help.ubuntu.com/community/CloudInit/</a>.</p>
</div>
</li>
<li><p class="first">If required, run the <strong class="command">openstack server add volume</strong> command to
reattach the volumes to their respective instances. This example uses
a file of listed volumes to reattach them:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
    <span class="nv">volume</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> <span class="nv">$CUT</span> -f <span class="m">1</span> -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
    <span class="nv">instance</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> <span class="nv">$CUT</span> -f <span class="m">2</span> -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
    <span class="nv">mount_point</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> <span class="nv">$CUT</span> -f <span class="m">3</span> -d <span class="s2">&quot; &quot;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;ATTACHING VOLUME FOR INSTANCE - </span><span class="nv">$instance</span><span class="s2">&quot;</span>
    openstack server add volume <span class="nv">$instance</span> <span class="nv">$volume</span> <span class="nv">$mount_point</span>
    sleep <span class="m">2</span>
<span class="k">done</span> &lt; <span class="nv">$volumes_tmp_file</span>
</pre></div>
</div>
<p>Instances that were stopped at the plymouth stage now automatically
continue booting and start normally. Instances that previously started
successfully can now see the volume.</p>
</li>
<li><p class="first">Log in to the instances with SSH and reboot them.</p>
<p>If some services depend on the volume or if a volume has an entry in fstab,
you can now restart the instance. Restart directly from the instance itself
and not through <strong class="command">nova</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> shutdown -r now
</pre></div>
</div>
<p>When you plan for and complete a disaster recovery, follow these tips:</p>
</li>
</ol>
<ul>
<li><p class="first">Use the <code class="docutils literal"><span class="pre">errors=remount</span></code> option in the <code class="docutils literal"><span class="pre">fstab</span></code> file to prevent
data corruption.</p>
<p>In the event of an I/O error, this option prevents writes to the disk. Add
this configuration option into the cinder-volume server that performs the
iSCSI connection to the SAN and into the instances&#8217; <code class="docutils literal"><span class="pre">fstab</span></code> files.</p>
</li>
<li><p class="first">Do not add the entry for the SAN&#8217;s disks to the cinder-volume&#8217;s
<code class="docutils literal"><span class="pre">fstab</span></code> file.</p>
<p>Some systems hang on that step, which means you could lose access to
your cloud-controller. To re-run the session manually, run this
command before performing the mount:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> iscsiadm -m discovery -t st -p <span class="nv">$SAN_IP</span> $ iscsiadm -m node --target-name <span class="nv">$IQN</span> -p <span class="nv">$SAN_IP</span> -l
</pre></div>
</div>
</li>
<li><p class="first">On your instances, if you have the whole <code class="docutils literal"><span class="pre">/home/</span></code> directory on the
disk, leave a user&#8217;s directory with the user&#8217;s bash files and the
<code class="docutils literal"><span class="pre">authorized_keys</span></code> file instead of emptying the <code class="docutils literal"><span class="pre">/home/</span></code> directory
and mapping the disk on it.</p>
<p>This action enables you to connect to the instance without the volume
attached, if you allow only connections through public keys.</p>
</li>
</ul>
<p>To script the disaster recovery plan (DRP), use the
<a class="reference external" href="https://github.com/Razique/BashStuff/blob/master/SYSTEMS/OpenStack/SCR_5006_V00_NUAC-OPENSTACK-DRP-OpenStack.sh">https://github.com/Razique</a> bash script.</p>
<p>This script completes these steps:</p>
<ol class="arabic simple">
<li>Creates an array for instances and their attached volumes.</li>
<li>Updates the MySQL database.</li>
<li>Restarts all instances with euca2ools.</li>
<li>Reattaches the volumes.</li>
<li>Uses Compute credentials to make an SSH connection into every instance.</li>
</ol>
<p>The script includes a <code class="docutils literal"><span class="pre">test</span> <span class="pre">mode</span></code>, which enables you to perform the sequence
for only one instance.</p>
<p>To reproduce the power loss, connect to the compute node that runs that
instance and close the iSCSI session. Do not detach the volume by using the
<strong class="command">openstack server remove volume</strong> command. You must manually close the
iSCSI session. This example closes an iSCSI session with the number <code class="docutils literal"><span class="pre">15</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> iscsiadm -m session -u -r <span class="m">15</span>
</pre></div>
</div>
<p>Do not forget the <code class="docutils literal"><span class="pre">-r</span></code> option. Otherwise, all sessions close.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is potential for data loss while running instances during
this procedure. If you are using Liberty or earlier, ensure you have the
correct patch and set the options appropriately.</p>
</div>
</div>
</div>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="compute-security.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Security hardening"></i></a>
          
          
            <a href="compute-adv-config.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Advanced configuration"></i></a>
          
            <a id="logABugLink3" href="" target="_blank" title="Found an error? Report a bug against this page"><i class="fa fa-bug" data-toggle="tooltip" data-placement="top" title="Report a Bug"></i></a>
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">updated: 2017-02-14 13:52</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">
<a href="https://creativecommons.org/licenses/by/3.0/">
 <img src="_static/images/docs/license.png" alt="Creative Commons Attribution 3.0 License"/>
</a>
<p>
 Except where otherwise noted, this document is licensed under
 <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons
 Attribution 3.0 License</a>. See all <a href="http://www.openstack.org/legal">
 OpenStack Legal Documents</a>.
</p>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the document -->
              <a href="#" id="logABugLink2" class="docs-footer-actions"><i class="fa fa-bug"></i> found an error? report a bug</a>
              <a href="http://ask.openstack.org" class="docs-footer-actions"><i class="fa fa-question-circle"></i> questions?</a>
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="search-icon show">
    <i class="fa fa-search"></i> Search
  </div>
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" data-toggle="dropdown" class="btn docs-sidebar-release-select">OpenStack Documentation<i class="fa fa-caret-down"></i></button>
    <ul class="dropdown-menu docs-sidebar-dropdown" role="menu" aria-labelledby="dLabel">
      <li role="presentation" class="dropdown-header">Guides</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#install-guides">Install Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#user-guides">User Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#configuration-guides">Configuration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#ops-and-admin-guides">Operations and Administration Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#api-guides">API Guides</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/index.html#contributor-guides">Contributor Guides</a></li>
      <li role="presentation" class="dropdown-header">Languages</li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ja/">日本語 (Japanese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/de/">Deutsch (German)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/fr/">Français (French)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/pt_BR/">Português (Portuguese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/zh_CN/">简体中文 (Simplified Chinese)</a></li>
      <li role="presentation"><a role="menuitem" tabindex="-1" href="http://docs.openstack.org/ko_KR/">한국어 (Korean)</a></li>
    </ul>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="index.html" class="docs-sidebar-section-title"><h4>Contents</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="common/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/get-started-with-openstack.html">Get started with OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="identity-management.html">Identity management</a></li>
<li class="toctree-l1"><a class="reference internal" href="dashboard.html">Dashboard</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="compute.html">Compute</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="compute-arch.html">System architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="compute-images-instances.html">Images and instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="compute-networking-nova.html">Networking with nova-network</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="compute-system-admin.html">System administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="support-compute.html">Troubleshoot Compute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="objectstorage.html">Object Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="blockstorage.html">Block Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="shared-file-systems.html">Shared File Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="telemetry.html">Telemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="baremetal.html">Bare Metal</a></li>
<li class="toctree-l1"><a class="reference internal" href="orchestration.html">Orchestration</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">OpenStack command-line clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross-project.html">Cross-project features</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="firewalls-default-ports.html">Firewalls and default ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="common/app-support.html">Community support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common/glossary.html">Glossary</a></li>
</ul>

    </div>
  </div>
</div>
      </div>
    </div>
<footer>
  <div class="container">
    <div class="row footer-links">
      <div class="col-lg-2 col-sm-2">
        <h3>OpenStack</h3>
        <ul>
          <li><a href="http://openstack.org/projects/">Projects</a></li>
          <li><a href="http://openstack.org/projects/openstack-security/">OpenStack Security</a></li>
          <li><a href="http://openstack.org/projects/openstack-faq/">Common Questions</a></li>
          <li><a href="http://openstack.org/blog/">Blog</a></li>
          <li><a href="http://openstack.org/news/">News</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Community</h3>
        <ul>
          <li><a href="http://openstack.org/community/">User Groups</a></li>
          <li><a href="http://openstack.org/community/events/">Events</a></li>
          <li><a href="http://openstack.org/community/jobs/">Jobs</a></li>
          <li><a href="http://openstack.org/foundation/companies/">Companies</a></li>
          <li><a href="http://docs.openstack.org/infra/manual/developers.html">Contribute</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Documentation</h3>
        <ul>
          <li><a href="http://docs.openstack.org">OpenStack Manuals</a></li>
          <li><a href="http://openstack.org/software/start/">Getting Started</a></li>
          <li><a href="http://developer.openstack.org">API Documentation</a></li>
          <li><a href="https://wiki.openstack.org">Wiki</a></li>
        </ul>
      </div>
      <div class="col-lg-2 col-sm-2">
        <h3>Branding & Legal</h3>
        <ul>
          <li><a href="http://openstack.org/brand/">Logos & Guidelines</a></li>
          <li><a href="http://openstack.org/brand/openstack-trademark-policy/">Trademark Policy</a></li>
          <li><a href="http://openstack.org/privacy/">Privacy Policy</a></li>
          <li><a href="https://wiki.openstack.org/wiki/How_To_Contribute#Contributor_License_Agreement">OpenStack CLA</a></li>
        </ul>
      </div>
      <div class="col-lg-4 col-sm-4">
        <h3>Stay In Touch</h3>
        <a href="https://twitter.com/OpenStack" target="_blank" class="social-icons footer-twitter"></a>
        <a href="https://www.facebook.com/openstack" target="_blank" class="social-icons footer-facebook"></a>
        <a href="https://www.linkedin.com/company/openstack" target="_blank" class="social-icons footer-linkedin"></a>
        <a href="https://www.youtube.com/user/OpenStackFoundation" target="_blank" class="social-icons footer-youtube"></a>
        <p class="fine-print">
          The OpenStack project is provided under the
          <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. Openstack.org is powered by
          <a href="http://rackspace.com" target="_blank">Rackspace Cloud Computing</a>.
        </p>
      </div>
    </div>
  </div>
</footer>
<!-- jQuery -->
<script type="text/javascript" src="_static/js/jquery-1.12.4.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="_static/js/bootstrap.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="_static/js/docs.js"></script>

<!-- Popovers -->
<script type="text/javascript" src="_static/js/webui-popover.js"></script>

<!-- Javascript for page -->
<script language="JavaScript">
/* build a description of this page including SHA, source location on git repo,
   build time and the project's launchpad bug tag. Set the HREF of the bug
   buttons */

    var lineFeed = "%0A";
    var gitURL = "Source: Can't derive source file URL";

    /* there have been cases where "pagename" wasn't set; better check for it */
        /* The URL of the source file on Git is based on the giturl variable
           in conf.py, which must be manually initialized to the source file
           URL in Git.
           "pagename" is a standard sphinx parameter containing the name of
           the source file, without extension.                             */

        var sourceFile = "compute-node-down" + ".rst";
        gitURL = "Source: https://git.openstack.org/cgit/openstack/openstack-manuals/tree/doc/admin-guide/source" + "/" + sourceFile;

    /* gitsha, project and bug_tag rely on variables in conf.py */
    var gitSha = "SHA: 3993c81360ea23a2e599faf5f3de0d288b10c20a";
        var bugProject = "openstack-manuals";
        var bugTitle = "Recover from a failed compute node in Administrator Guide";
    var fieldTags = "admin-guide";

    /* "last_updated" is the build date and time. It relies on the
       conf.py variable "html_last_updated_fmt", which should include
       year/month/day as well as hours and minutes                   */
    var buildstring = "Release: 0.9 on 2017-02-14 13:52";

    var fieldComment = encodeURI(buildstring) +
                       lineFeed + encodeURI(gitSha) +
                       lineFeed + encodeURI(gitURL) ;

    logABug(bugTitle, bugProject, fieldComment, fieldTags);
</script>

<!-- Javascript for search boxes (both sidebar and top nav) -->
<script type="text/javascript">
(function() {
var cx = '000108871792296872333:noj9nikm74i';
var gcse = document.createElement('script');
gcse.type = 'text/javascript';
gcse.async = true;
gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
'//www.google.com/cse/cse.js?cx=' + cx;
var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(gcse, s);
})();
</script>

  </body>
</html>