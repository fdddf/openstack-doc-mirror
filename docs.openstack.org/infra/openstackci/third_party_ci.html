
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>OpenStack Third-Party CI &mdash; OpenStack CI Puppet Module 0.0.1.dev143 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1.dev143',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack CI Puppet Module 0.0.1.dev143 documentation" href="index.html" />
    <link rel="prev" title="Welcome to OpenStack CI Puppet Module’s documentation!" href="index.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="openstack-third-party-ci">
<h1>OpenStack Third-Party CI<a class="headerlink" href="#openstack-third-party-ci" title="Permalink to this headline">¶</a></h1>
<p>These instructions provide a <strong>Third Party Testing</strong> solution using the
same tools and scripts used by the OpenStack Infrastructure &#8216;Jenkins&#8217; CI
system.</p>
<p>If you are setting up a similar system for use outside of OpenStack,
many of these steps are still valid, while others can be skipped. These
will be mentioned within each step.</p>
<p>If you are creating a third-party CI system for use within OpenStack,
you&#8217;ll need to familiarize yourself with the contents of the <a class="reference external" href="http://docs.openstack.org/infra/system-config/third_party.html">third
party
manual</a>,
and in particular you&#8217;ll need to [create a service account]
(<a class="reference external" href="http://docs.openstack.org/infra/system-config/third_party.html#creating-a-service-account">http://docs.openstack.org/infra/system-config/third_party.html#creating-a-service-account</a>).</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This CI solution uses a few open-source tools:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.openstack.org/infra/system-config/jenkins.html">Jenkins</a>
- an open-source continuous integration server.</li>
<li><a class="reference external" href="http://docs.openstack.org/infra/system-config/zuul.html">Zuul</a> -
a project gating system</li>
<li><a class="reference external" href="http://docs.openstack.org/infra/system-config/nodepool.html">Nodepool</a>-
a node management system for testing</li>
<li><a class="reference external" href="http://docs.openstack.org/infra/system-config/jjb.html">Jenkins Job
Builder</a> -
a tool to manage jenkins job definitions</li>
<li><a class="reference external" href="http://git.openstack.org/cgit/openstack-infra/os-loganalyze/">os-loganalyze</a>
- a tool to facilitate browsing, sharing, and filtering log files by
log level.</li>
</ul>
<p>The following steps will help you integrate and deploy the first 4 tools
on a single node. An initial system with 8GB RAM, 4CPUs, 80GB HD should
be sufficient, running Ubuntu 14.04.</p>
<p>A second node will be used to store the log files and create a public
log server to host the static log files generated by jenkins jobs. This
log server node is an Apache server serving log files stored on disk or
on a Swift service. It is hosted on a separate node because it usually
needs to be publicly accessible to share job results whereas the rest of
the CI system can be located behind a firewall or within a VPN. At the
end of a Jenkins Job, <tt class="docutils literal"><span class="pre">publishers</span></tt> will scp log files from the jenkins
slave to the log server node or upload to the Swift Service.</p>
<p>The system requires two external resources:</p>
<ul class="simple">
<li>A source for Nodepool nodes. This is a service that implements the
OpenStack Nova API to provide virtual machines or bare metal nodes.
Nodepool will use this service to manage a pool of Jenkins slaves
that will run the actual CI jobs. You can use a public or private
OpenStack cloud, or even run your own
<a class="reference external" href="https://git.openstack.org/cgit/openstack-dev/devstack/">devstack</a>
to get started.</li>
<li>A Gerrit server (for OpenStack users, this is provided to you at
review.openstack.org) Zuul will listen to the Gerrit event stream to
decide which jobs to run when it receives a desired event. Zuul will
also post a comment with results to this Gerrit server with the job
results along with a link to the related log files.</li>
</ul>
<p>These instructions are for a &#8216;masterless&#8217; puppet setup, which is the
simplest version to set up for those not familiar with puppet.</p>
</div>
<div class="section" id="install-and-configure-puppet">
<h2>Install and Configure Puppet<a class="headerlink" href="#install-and-configure-puppet" title="Permalink to this headline">¶</a></h2>
<p>On each node, you will need to install and configure puppet. These
scripts assume a dedicated &#8216;clean&#8217; node built with a base <a class="reference external" href="http://www.ubuntu.com/download/server">ubuntu 14.04
server image</a>.</p>
<div class="section" id="install-puppet">
<h3>Install Puppet<a class="headerlink" href="#install-puppet" title="Permalink to this headline">¶</a></h3>
<p>Puppet is a tool to automate the installation of servers by defining the
desired end state. You can quickly install puppet along with basic tools
(such as pip and git) using this script:</p>
<div class="highlight-python"><pre>sudo su -
wget https://git.openstack.org/cgit/openstack-infra/system-config/plain/install_puppet.sh
bash install_puppet.sh
exit</pre>
</div>
</div>
<div class="section" id="install-puppet-modules">
<h3>Install Puppet Modules<a class="headerlink" href="#install-puppet-modules" title="Permalink to this headline">¶</a></h3>
<p>You can get the latest version of the puppet modules needed using this
script.</p>
<div class="highlight-python"><pre>sudo su -
git clone https://git.openstack.org/openstack-infra/system-config
cd system-config
./install_modules.sh
exit</pre>
</div>
<p>This script will install all the puppet modules used by upstream to
<tt class="docutils literal"><span class="pre">/etc/puppet/modules</span></tt>. In many cases, these are git cloned, and
running the <tt class="docutils literal"><span class="pre">install_modules.sh</span></tt> script again will update them to the
latest version. This script uses <tt class="docutils literal"><span class="pre">modules.env</span></tt> as its configuration
input.</p>
</div>
<div class="section" id="configure-masterless-puppet">
<h3>Configure Masterless Puppet<a class="headerlink" href="#configure-masterless-puppet" title="Permalink to this headline">¶</a></h3>
<p>The instructions in this section apply to both the single-node CI server
node as well as the log server node.</p>
<p>It is useful to save the history, so set up a git repo as root user:</p>
<div class="highlight-python"><pre>sudo su -
cd /etc/puppet
git init
echo "modules/" &gt;&gt; .gitignore
git add .
git config --global user.email "you@example.com"
git config --global user.name "Your Name"
git commit -m "initial files"
exit</pre>
</div>
<p>You will be configuring 3 puppet files. The first is <tt class="docutils literal"><span class="pre">site.pp</span></tt> which
is the top level entry point for puppet to start managing the node. The
second is a <tt class="docutils literal"><span class="pre">hiera.yaml</span></tt> which configures Puppet Hiera to store local
configurations and secrets such as passwords and private keys, and
finally some <tt class="docutils literal"><span class="pre">yaml</span></tt> files which store the actual configurations and
secrets.</p>
<p>Set up these 3 files by starting with the samples provided. For each
node, select the corresponding <tt class="docutils literal"><span class="pre">single_node_ci*</span></tt> or <tt class="docutils literal"><span class="pre">log_server*</span></tt>
files.</p>
<p>Configure Puppet <tt class="docutils literal"><span class="pre">hiera.yaml</span></tt> so that puppet knows where to look for the
<tt class="docutils literal"><span class="pre">common.yaml</span></tt> file you&#8217;ll create in the next step.</p>
<div class="highlight-python"><pre>sudo su -
cp /etc/puppet/modules/openstackci/contrib/hiera.yaml /etc/puppet
exit</pre>
</div>
<p>If setting up the <tt class="docutils literal"><span class="pre">single</span> <span class="pre">node</span> <span class="pre">ci</span></tt> node:</p>
<div class="highlight-python"><pre>sudo su -
cp /etc/puppet/modules/openstackci/contrib/single_node_ci_site.pp /etc/puppet/manifests/site.pp
cp /etc/puppet/modules/openstackci/contrib/single_node_ci_data.yaml /etc/puppet/environments/common.yaml
exit</pre>
</div>
<p>If setting up the <tt class="docutils literal"><span class="pre">log</span> <span class="pre">server</span></tt> node:</p>
<div class="highlight-python"><pre>sudo su -
cp /etc/puppet/modules/openstackci/contrib/log_server_site.pp /etc/puppet/manifests/site.pp
cp /etc/puppet/modules/openstackci/contrib/log_server_data.yaml /etc/puppet/environments/common.yaml
exit</pre>
</div>
<p>Modify <tt class="docutils literal"><span class="pre">/etc/puppet/environments/common.yaml</span></tt> as you need using
the parameter documentation described in
<a class="reference external" href="http://git.openstack.org/cgit/openstack-infra/puppet-openstackci/tree/manifests/single_node_ci.pp">single_node_ci.pp</a>
or
<a class="reference external" href="http://git.openstack.org/cgit/openstack-infra/puppet-openstackci/tree/manifests/logserver.pp">logserver.pp</a>.
These are the top level puppet class that is used in <tt class="docutils literal"><span class="pre">site.pp</span></tt>.</p>
<p>One parameter called <tt class="docutils literal"><span class="pre">project_config_repo</span></tt> is necessary to be set
into <tt class="docutils literal"><span class="pre">/etc/puppet/environments/common.yaml</span></tt>.</p>
<p>You need to configure this parameter with the URL of the &#8216;project-config&#8217;
repository which you will create in the step
<a class="reference internal" href="#create-an-initial-project-config-repository">Create an Initial &#8216;project-config&#8217; Repository</a> below.</p>
<p>Once completed, you should commit these 3 files to the <tt class="docutils literal"><span class="pre">/etc/puppet</span></tt>
git repo. Your git workflow may vary a bit, but here is an example:</p>
<div class="highlight-python"><pre>sudo su -
cd /etc/puppet
git checkout -b setup
git add environments/common.yaml
# repeat for other modified files
git commit -a -m 'initial setup'
exit</pre>
</div>
</div>
</div>
</div>
<div class="section" id="set-up-the-log-server">
<h1>Set up the log server<a class="headerlink" href="#set-up-the-log-server" title="Permalink to this headline">¶</a></h1>
<p>Set up the log server node first as it is simpler to configure. Besides,
its FQDN (or IP address) is needed to set up the CI server node.</p>
<p>While setting up jenkins_ssh_public_key in <tt class="docutils literal"><span class="pre">common.yaml</span></tt> it is
important that the same ssh key pair is used when setting up the CI
server node in the next step. This is the ssh key that Jenkins will use
to scp files.</p>
<p>At this point you are ready to invoke Puppet for the first time. Puppet
needs to be run as root.</p>
<div class="highlight-python"><pre>sudo puppet apply --verbose /etc/puppet/manifests/site.pp</pre>
</div>
<p>You can simulate a jenkins file upload using:</p>
<div class="highlight-python"><pre>scp -i $JENKINS_SSH_PRIVATE_KEY_FILE -o StrictHostKeyChecking=no $your-log-file jenkins@&lt;fqdn_or_ip&gt;:/srv/static/logs/</pre>
</div>
<p>You should now be able to see the file you uploaded at
<tt class="docutils literal"><span class="pre">http://&lt;fqnd_or_ip&gt;/$your-log-file</span></tt></p>
</div>
<div class="section" id="set-up-the-ci-server">
<h1>Set up the CI server<a class="headerlink" href="#set-up-the-ci-server" title="Permalink to this headline">¶</a></h1>
<p>Follow the steps above to install and configure puppet on the CI server
node.</p>
<div class="section" id="create-an-initial-project-config-repository">
<h2>Create an Initial &#8216;project-config&#8217; Repository<a class="headerlink" href="#create-an-initial-project-config-repository" title="Permalink to this headline">¶</a></h2>
<p>Setting up a CI system consists of two major operational aspects. The
first is system configuration, which focuses on the installation and
deployment of the services, including any ssh keys, credentials,
databases, etc., and ensure all system components are able to interact
together. This portion is performed by a System Administrator.</p>
<p>The second is project configuration, which includes the configuration
files that the services use to perform the desired project-specific
operations.</p>
<p>The instructions provided here are mainly focused on the system
configuration aspect. However, system configuration requires an initial
set of project configurations in order to work. These project
configurations are provided via a git URL to a <tt class="docutils literal"><span class="pre">project-config</span></tt>
repository. Before moving on, create an initial <tt class="docutils literal"><span class="pre">project-config</span></tt>
repository. You can start with this
<a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config-example/">project-config-example</a>
following the instructions provided in its README.md. While tailored for
OpenStack users, the instructions provided will help non-OpenStack users
also start with this repository. After your system is deployed, you can
make further changes to the <tt class="docutils literal"><span class="pre">project-config</span></tt> repository to
continuously tailor it to your needs.</p>
</div>
<div class="section" id="add-jenkins-to-your-host-name">
<h2>Add &#8216;jenkins&#8217; to your host name<a class="headerlink" href="#add-jenkins-to-your-host-name" title="Permalink to this headline">¶</a></h2>
<p>Add &#8216;jenkins&#8217; to your /etc/hosts file so that Apache (which will be
installed by the puppet scripts) is happy. This is needed because the
scripts will install multiple services on a single node. For example:</p>
<div class="highlight-python"><pre>head -n 1 /etc/hosts
127.0.0.1 localhost jenkins</pre>
</div>
</div>
<div class="section" id="run-masterless-puppet">
<h2>Run masterless Puppet<a class="headerlink" href="#run-masterless-puppet" title="Permalink to this headline">¶</a></h2>
<p>At this point you are ready to invoke Puppet for the first time. Puppet
needs to be run as root.</p>
<div class="highlight-python"><pre>sudo puppet apply --verbose /etc/puppet/manifests/site.pp</pre>
</div>
<p>Puppet will install nodepool, jenkins, zuul, jenkins jobs builder, etc.</p>
<p>Your <tt class="docutils literal"><span class="pre">project-config</span></tt> repository will be cloned to
/etc/project-config, and the puppet scripts will use these configuration
files located in this folder. Do not update these files directly.
Instead, you should update them from a clone on a dev host, merge the
changes to master, and push them to the same git remote location. Puppet
will always pull down the latest version of master from the git remote
and use that to update services.</p>
<p>If you get the following error, manually run the failed
<tt class="docutils literal"><span class="pre">jenkins-jobs</span> <span class="pre">update</span></tt> command with the arguments specified in the
error message as root. This is caused by a bug in the puppet scripts
where Jenkins is not yet running when Jenkins Job Builder attempts to
load the Jenkins jobs.</p>
<div class="highlight-python"><pre>Notice: /Stage[main]/Jenkins::Job_builder/Exec[jenkins_jobs_update]/returns: jenkins.JenkinsException: Error in request: [Errno 111] Connection refused
Notice: /Stage[main]/Jenkins::Job_builder/Exec[jenkins_jobs_update]/returns: INFO:jenkins_jobs.builder:Cache saved
Error: /Stage[main]/Jenkins::Job_builder/Exec[jenkins_jobs_update]: Failed to call refresh: jenkins-jobs update --delete-old /etc/jenkins_jobs/config returned 1 instead of one of [0]
Error: /Stage[main]/Jenkins::Job_builder/Exec[jenkins_jobs_update]: jenkins-jobs update --delete-old /etc/jenkins_jobs/config returned 1 instead of one of [0]</pre>
</div>
</div>
<div class="section" id="restart-apache-if-necessary">
<h2>Restart apache if necessary<a class="headerlink" href="#restart-apache-if-necessary" title="Permalink to this headline">¶</a></h2>
<p>There are some known issues with Puppet automation. If you get the
following error:</p>
<div class="highlight-python"><pre>AH00526: Syntax error on line 21 of /etc/apache2/sites-enabled/50-&lt;fqdn/ip&gt;.conf:
Invalid command 'RewriteEngine', perhaps misspelled or defined by a module not included in the server configuration</pre>
</div>
<p>A simple restart works around the issue:</p>
<div class="highlight-python"><pre>sudo service apache2 restart</pre>
</div>
</div>
<div class="section" id="start-zuul">
<h2>Start zuul<a class="headerlink" href="#start-zuul" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll start zuul first:</p>
<div class="highlight-python"><pre>sudo service zuul start
sudo service zuul-merger start</pre>
</div>
<p>You should see 2 zuul-server processes and 1 zuul-merger process</p>
<div class="highlight-python"><pre>ps -ef | grep zuul
zuul      5722     1  2 18:13 ?        00:00:00 /usr/bin/python /usr/local/bin/zuul-server
zuul      5725  5722  0 18:13 ?        00:00:00 /usr/bin/python /usr/local/bin/zuul-server
zuul      5741     1  2 18:13 ?        00:00:00 /usr/bin/python /usr/local/bin/zuul-merger</pre>
</div>
<p>You can view the log files for any errors:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">view</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">zuul</span><span class="o">/</span><span class="n">zuul</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Most zuul files are located in either of the following directories. They
should not need to be modified directly, but are useful to help identify
root causes:</p>
<div class="highlight-python"><pre>/var/lib/zuul
/etc/zuul</pre>
</div>
</div>
<div class="section" id="start-nodepool">
<h2>Start nodepool<a class="headerlink" href="#start-nodepool" title="Permalink to this headline">¶</a></h2>
<p>The first time starting nodepool, it&#8217;s recommended to manually build the
image to aid in debugging any issues. To do that, first, initiate the
nodepool-builder service:</p>
<div class="highlight-python"><pre>sudo service nodepool-builder start</pre>
</div>
<p>The nodepool-builder service is responsible for receiving image building
requests and calling Disk Image Builder to carry on the image creation.
You can see its logs by typing:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">view</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nodepool</span><span class="o">/</span><span class="n">nodepool</span><span class="o">-</span><span class="n">builder</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Next, log into the nodepool user to issue manually the image building:</p>
<div class="highlight-python"><pre>sudo su - nodepool

# Ensure the NODEPOOL_SSH_KEY variable is in the environment
# Otherwise nodepool won't be able to ssh into nodes based
# on the image built manually using these instructions
source /etc/default/nodepool

# In the command below &lt;image-name&gt; references one of the
# images defined in your project-config/nodepool/nodepool.yaml
# file as the 'name' field in the section 'diskimages'.
nodepool image-build &lt;image-name&gt;</pre>
</div>
<p>You can follow the image creation process by seeing the image creation
log:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nodepool</span><span class="o">/</span><span class="n">image</span><span class="o">/</span><span class="n">image</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>If you run into issues building the image, the <a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/nodepool/elements/README.rst">documentation provided
here can help you
debug</a></p>
<p>After you have successfully built an image, manually upload it to the
provider to ensure provider authentication and image uploading work:</p>
<div class="highlight-python"><pre>nodepool image-upload all &lt;image-name&gt;</pre>
</div>
<p>Once successful, you can start nodepool. (Note that if you don&#8217;t yet
have an image, this is one of the first actions nodepool will do when it
starts, before creating any nodes):</p>
<div class="highlight-python"><pre>sudo service nodepool start</pre>
</div>
<p>You should see at least one process running. In particular:</p>
<div class="highlight-python"><pre>ps -ef | grep nodepool
nodepool  5786     1 28 18:14 ?        00:00:01 /usr/bin/python /usr/local/bin/nodepoold -c /etc/nodepool/nodepool.yaml -l /etc/nodepool/logging.conf</pre>
</div>
<p>After building and uploading the images to the providers, nodepool will
start to build nodes on those providers based on the image and will
register those nodes as jenkins slaves.</p>
<p>If that does not happen, the nodepool log files will help identify the
causes.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">view</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nodepool</span><span class="o">/</span><span class="n">nodepool</span><span class="o">.</span><span class="n">log</span>
<span class="n">view</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nodepool</span><span class="o">/</span><span class="n">debug</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Most nodepool configuration files are located in either of the following
directories. They should never to be modified directly as puppet will
overwrite any changes, but are useful to help identify root causes:</p>
<div class="highlight-python"><pre>/etc/nodepool
/home/nodepool/.config/openstack/clouds.yaml</pre>
</div>
</div>
<div class="section" id="setup-jenkins">
<h2>Setup Jenkins<a class="headerlink" href="#setup-jenkins" title="Permalink to this headline">¶</a></h2>
<p>First Restart Jenkins so that plugins will be fully installed:</p>
<div class="highlight-python"><pre>sudo service jenkins restart</pre>
</div>
<p>Then open the Jenkins UI to finish manual configuration steps.</p>
<p>Enable Gearman, which is the Jenkins plugin zuul uses to queue jobs:</p>
<div class="highlight-python"><pre>http://&lt;host fqdn/ip&gt;:8080/
Manage Jenkins --&gt; Configure System
For "Gearman Server Port" use port number 4730
Under "Gearman Plugin Config" Check the box "Enable Gearman"
Click "Test Connection" It should return success if zuul is running.</pre>
</div>
<p>The zuul process is running a gearman server on port 4730. To check the status
of gearman: on your zuul node telnet to 127.0.0.1 port 4730, and issue the
command <tt class="docutils literal"><span class="pre">status</span></tt> to get status information about the jobs registered in
gearman.</p>
<div class="highlight-python"><pre>echo 'status' | nc 127.0.0.1 4730 -w 1</pre>
</div>
<p>The output of the <tt class="docutils literal"><span class="pre">status</span></tt> command contains tab separated columns with the
following information.</p>
<ol class="arabic simple">
<li>Name: The name of the job.</li>
</ol>
<p>2. Number in queue: The total number of jobs in the queue including the
currently running ones (next column).
3. Number of jobs running: The total number of jobs currently running.
4. Number of capable workers: A maximum possible count of workers that can run
this job. This number being zero is one reason zuul reports &#8220;NOT Registered&#8221;.</p>
<div class="highlight-python"><pre>build:noop-check-communication    1    0    1
build:dsvm-tempest-full           2    1    1</pre>
</div>
<p>Enable ZMQ Event Publisher, which is how nodepool is notified of Jenkin
slaves status events:</p>
<div class="highlight-python"><pre>http://&lt;host fqdn/ip&gt;:8080/
Manage Jenkins --&gt; Configure System
Under "ZMQ Event Publisher"
Check the box "Enable on all Jobs"</pre>
</div>
</div>
<div class="section" id="securing-jenkins-optional">
<h2>Securing Jenkins (optional)<a class="headerlink" href="#securing-jenkins-optional" title="Permalink to this headline">¶</a></h2>
<p>By default, Jenkins is installed with security disabled. While this is
fine for development environments where external access to Jenkins UI is
restricted, you are strongly encouraged to enable it. You can skip this
step and do it at a later time if you wish:</p>
<p>Create a jenkins &#8216;credentials&#8217;:</p>
<div class="highlight-python"><pre>http://&lt;host fqdn/ip&gt;:8080/
Manage Jenkins --&gt; Add Credentials --&gt; SSH Username with private key
Username 'jenkins'
Private key --&gt; From a file  on Jenkins master
"/var/lib/jenkins/.ssh/id_rsa"
--&gt; Save</pre>
</div>
<p>Save the credential uuid in your hiera data:</p>
<div class="highlight-python"><pre>sudo su jenkins
cat /var/lib/jenkins/credentials.xml | grep "&lt;id&gt;"
Copy the id to the 'jenkins_credentials_id' value in  /etc/puppet/environments/common.yaml</pre>
</div>
<p>Enable basic Jenkins security:</p>
<div class="highlight-python"><pre>http://&lt;host fqdn/ip&gt;:8080/
Manage Jenkins --&gt; Configure Global Security
Check "Enable Security"
Under "Security Realm"
Select Jenkin's own user database
Uncheck allow users to sign up
Under "Authorization" select "logged-in users can do anything"

Create a user 'jenkins'
Choose a password.
check 'Sign up'
Save the password to the 'jenkins_password' value in /etc/puppet/environments/common.yaml</pre>
</div>
<p>Get the new &#8216;jenkins&#8217; user API token:</p>
<div class="highlight-python"><pre>http://&lt;host fqdn/ip&gt;:8080/
Manage Jenkins --&gt; People --&gt; Select user 'jenkins' --&gt; configure --&gt; Show API Token
Save this token to the 'jenkins_api_key' value in /etc/puppet/environments/common.yaml</pre>
</div>
<p>Reconfigure your system to use Jenkins security settings stored in
<tt class="docutils literal"><span class="pre">/etc/puppet/environments/common.yaml</span></tt></p>
<div class="highlight-python"><pre>sudo puppet apply --verbose /etc/puppet/manifests/site.pp</pre>
</div>
</div>
</div>
<div class="section" id="updating-your-masterless-puppet-hosts">
<h1>Updating your masterless puppet hosts<a class="headerlink" href="#updating-your-masterless-puppet-hosts" title="Permalink to this headline">¶</a></h1>
<p>Any time you check-in changes to your <tt class="docutils literal"><span class="pre">project-config</span></tt> repo, make
changes to the hiera data (<tt class="docutils literal"><span class="pre">/etc/puppet/environments/common.yaml</span></tt>), or
update the puppet files (in /etc/puppet/modules, either manually or via
the <tt class="docutils literal"><span class="pre">install_modules.sh</span></tt> script), run the same puppet command to
update the host.</p>
<div class="highlight-python"><pre>sudo puppet apply --verbose /etc/puppet/manifests/site.pp</pre>
</div>
<p>If you need to change the git url in your <tt class="docutils literal"><span class="pre">project-config</span></tt> or any
other git urls in your <tt class="docutils literal"><span class="pre">common.yaml</span></tt>, delete the respective
repository, e.g. <tt class="docutils literal"><span class="pre">/etc/project-config</span></tt>, and puppet will reclone it
from the new location when the above <tt class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span></tt> command is
reinvoked.</p>
<p>Note that it is safe, and expected, to rerun the above <tt class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span></tt>
command. Puppet will update the configuration of the host as described
in the puppet classes. This means that if you delete or modify any files
managed by puppet, rerunning the <tt class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span></tt> command will restore
those settings back to the specified state (and remove your local
changes for better or worse). You could even run the <tt class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span></tt>
command as a cron job to enable continuous deployment in your CI system.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">OpenStack Third-Party CI</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#install-and-configure-puppet">Install and Configure Puppet</a><ul>
<li><a class="reference internal" href="#install-puppet">Install Puppet</a></li>
<li><a class="reference internal" href="#install-puppet-modules">Install Puppet Modules</a></li>
<li><a class="reference internal" href="#configure-masterless-puppet">Configure Masterless Puppet</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#set-up-the-log-server">Set up the log server</a></li>
<li><a class="reference internal" href="#set-up-the-ci-server">Set up the CI server</a><ul>
<li><a class="reference internal" href="#create-an-initial-project-config-repository">Create an Initial &#8216;project-config&#8217; Repository</a></li>
<li><a class="reference internal" href="#add-jenkins-to-your-host-name">Add &#8216;jenkins&#8217; to your host name</a></li>
<li><a class="reference internal" href="#run-masterless-puppet">Run masterless Puppet</a></li>
<li><a class="reference internal" href="#restart-apache-if-necessary">Restart apache if necessary</a></li>
<li><a class="reference internal" href="#start-zuul">Start zuul</a></li>
<li><a class="reference internal" href="#start-nodepool">Start nodepool</a></li>
<li><a class="reference internal" href="#setup-jenkins">Setup Jenkins</a></li>
<li><a class="reference internal" href="#securing-jenkins-optional">Securing Jenkins (optional)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updating-your-masterless-puppet-hosts">Updating your masterless puppet hosts</a></li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="index.html"
                                  title="previous chapter">Welcome to OpenStack CI Puppet Module&#8217;s documentation!</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/third_party_ci.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="index.html" title="Welcome to OpenStack CI Puppet Module’s documentation!"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack CI Puppet Module 0.0.1.dev143 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, OpenStack Infrastructure Team.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>