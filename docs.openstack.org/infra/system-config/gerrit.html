
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Gerrit &mdash; OpenStack Project Infrastructure 0.0.1.dev12076 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1.dev12076',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack Project Infrastructure 0.0.1.dev12076 documentation" href="index.html" />
    <link rel="up" title="Major Systems" href="systems.html" />
    <link rel="next" title="Grafana" href="grafana.html" />
    <link rel="prev" title="Cacti" href="cacti.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
<li><a href="index.html" title="Go to the Home page" class="link">Home</a></li>
<li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
<li><a href="http://review.openstack.org/" title="Go to the OpenStack Gerrit server">Gerrit</a></li>
<li><a href="http://jenkins.openstack.org/" title="Go to the OpenStack Jenkins server">Jenkins</a></li>
<li><a href="http://logstash.openstack.org/" title="Go to the OpenStack Logstash server">Logstash</a></li>
<li><a href="http://etherpad.openstack.org/" title="Go to the OpenStack Etherpad server">Etherpad</a></li>
<li><a href="http://paste.openstack.org/" title="Go to the OpenStack Paste server">Paste</a></li>
<li><a href="http://planet.openstack.org/" title="Go to the OpenStack Planet server">Planet</a></li>
<li><a href="http://lists.openstack.org/" title="Go to the OpenStack Mailman server">Mailman</a></li>

    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="gerrit">
<span id="id1"></span><h1>Gerrit<a class="headerlink" href="#gerrit" title="Permalink to this headline">¶</a></h1>
<p>Gerrit is the code review system used by the OpenStack project.  For a
full description of how the system fits into the OpenStack workflow,
see <a class="reference external" href="http://docs.openstack.org/infra/manual/developers.html#development-workflow">the development workflow guide</a>.</p>
<p>This section describes how Gerrit is configured for use in the
OpenStack project and the tools used to manage that configuration.</p>
<div class="section" id="at-a-glance">
<h2>At a Glance<a class="headerlink" href="#at-a-glance" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Hosts:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://review.openstack.org">http://review.openstack.org</a></li>
<li><a class="reference external" href="http://review-dev.openstack.org">http://review-dev.openstack.org</a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Puppet:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/puppet-gerrit/tree/">https://git.openstack.org/cgit/openstack-infra/puppet-gerrit/tree/</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/manifests/review.pp">system-config: modules/openstack_project/manifests/review.pp</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/manifests/review_dev.pp">system-config: modules/openstack_project/manifests/review_dev.pp</a></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Configuration:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/templates/review.projects.ini.erb">system-config: modules/openstack_project/templates/review.projects.ini.erb</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/gerrit/projects.yaml">project-config: gerrit/projects.yaml</a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Projects:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://code.google.com/p/gerrit/">http://code.google.com/p/gerrit/</a></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Bugs:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://storyboard.openstack.org/#!/project/715">https://storyboard.openstack.org/#!/project/715</a></li>
<li><a class="reference external" href="http://code.google.com/p/gerrit/issues/list">http://code.google.com/p/gerrit/issues/list</a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Resources:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="https://review.openstack.org/Documentation/index.html">Gerrit Documentation</a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Gerrit is installed and configured by Puppet, including specifying the
exact Java WAR file that is used.  See <a class="reference internal" href="sysadmin.html#sysadmin"><em>System Administration</em></a> for how Puppet
is used to manage OpenStack infrastructure systems.</p>
<div class="section" id="cinder-volumes">
<h3>Cinder Volumes<a class="headerlink" href="#cinder-volumes" title="Permalink to this headline">¶</a></h3>
<p>The Gerrit installation at /home/gerrit2 is located on a Cinder
volume.  See <a class="reference internal" href="sysadmin.html#cinder"><em>Cinder Volume Management</em></a> for details on volume management.  Note
that SSD volumes are used (and they have a minimum size of 100G).</p>
</div>
<div class="section" id="gerrit-configuration">
<h3>Gerrit Configuration<a class="headerlink" href="#gerrit-configuration" title="Permalink to this headline">¶</a></h3>
<p>Most of Gerrit&#8217;s configuration is in configuration files or Git
repositories (and in our case, managed by Puppet), but a few items
must be configured in the database.  The following is a record of
these changes:</p>
<p>Add information about the CLA:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span>
<span class="n">mysql</span>
<span class="k">use</span> <span class="n">reviewdb</span><span class="p">;</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">contributor_agreements</span> <span class="k">values</span> <span class="p">(</span>
<span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;ICLA&#39;</span><span class="p">,</span>
<span class="s1">&#39;OpenStack Individual Contributor License Agreement&#39;</span><span class="p">,</span>
<span class="s1">&#39;static/cla.html&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="groups">
<h3>Groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h3>
<p>A number of system-wide groups are configured in Gerrit (rather than
via Puppet).  When installing a new Gerrit, you should create these by
hand (and capture their UUID - you will need them to setup the ACLs
later).</p>
<p>The <cite>Project Bootstrappers</cite> group grants all the permissions needed to
set up a new project.  Normally, the OpenStack Project Creater account
is the only member of this group, but members of the <cite>Administrators</cite>
group may temporarily add themselves in order to correct problems with
automatic project creation.</p>
<p>The <cite>Third-Party CI</cite> group is used to grant +/-1 Verified
access to external testing tools on a sandbox project.</p>
<p>The <cite>Voting Third-Party CI</cite> group is used to grant +/-1 Verified
access to external testing tools for all projects.</p>
<p>The <cite>Continuous Integration Tools</cite> group contains Jenkins and any
other CI tools that get +2/-2 access on reviews.</p>
<p>The <cite>Release Managers</cite> group is used for release managers.</p>
</div>
<div class="section" id="users">
<h3>Users<a class="headerlink" href="#users" title="Permalink to this headline">¶</a></h3>
<p>The first user to log in becomes an administrator. Be sure to set an
account name and add ssh keys - you&#8217;ll need those.</p>
<p>Once you&#8217;ve created your groups you should create the
<tt class="docutils literal"><span class="pre">openstack-project-creator</span></tt> account by hand (the account name is
referenced from
<a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/templates/review.projects.ini.erb">system-config: modules/openstack_project/templates/review.projects.ini.erb</a>)
using:</p>
<div class="highlight-python"><pre>cat $pubkey | ssh -p 29418 $USER@$HOST gerrit create-account \
  --group "'Project Bootstrappers'" \
  --group Administrators \
  --full-name "'Project Creator'" \
  --email openstack-infra@lists.openstack.org \
  --ssh-key - openstack-project-creator</pre>
</div>
</div>
</div>
<div class="section" id="github-integration">
<h2>GitHub Integration<a class="headerlink" href="#github-integration" title="Permalink to this headline">¶</a></h2>
<p>Gerrit replicates to GitHub by pushing to a standard Git remote.  The
GitHub projects are configured to allow only the Gerrit user to push.</p>
<p>Pull requests can not be disabled for a project in Github, so instead
we have a script that runs from cron to close any open pull requests
with instructions to use Gerrit.</p>
<p>These are both handled automatically by <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a>.</p>
<p>Note that the user running Gerrit will need to accept the GitHub host
keys. e.g.:</p>
<div class="highlight-python"><pre>sudo su - gerrit2
ssh github.com</pre>
</div>
<div class="section" id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
<p>When creating a new project, there can be times where the <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a>
automation to create the GitHub project can fail, and leave the project
improperly configured.
This can cause replication to GitHub to fail. The project in GitHub will
be created, but will appear empty. When trying replication from Gerrit,
it will show a <cite>Permission denied</cite> error when trying to push content.
To solve that, following steps are needed:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Login into github.com, using openstack-project-creator user.</li>
</ol>
<p>#. Navigate to the failed repository, and enter on Settings &gt; Collaborators
&amp; teams option.</p>
<ol class="arabic simple">
<li>Add Gerrit as Team member to that project.</li>
</ol>
</div></blockquote>
<p>After the team has been added, project will start replicating successfully
to GitHub.</p>
</div>
</div>
<div class="section" id="auto-review-expiry">
<h2>Auto Review Expiry<a class="headerlink" href="#auto-review-expiry" title="Permalink to this headline">¶</a></h2>
<p>Puppet automatically installs a daily cron job called <tt class="docutils literal"><span class="pre">expire-old-reviews</span></tt>
onto the Gerrit servers.  This script follows two rules:</p>
<blockquote>
<div><ol class="arabic simple">
<li>If the review hasn&#8217;t been touched in 2 weeks, mark as abandoned.</li>
<li>If there is a negative review and it hasn&#8217;t been touched in 1 week, mark as
abandoned.</li>
</ol>
</div></blockquote>
<p>If your review gets touched by either of these rules, it is possible to
unabandon a review on the Gerrit web interface.</p>
<p>This process is managed by the <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a> openstack-infra project.</p>
</div>
<div class="section" id="gerrit-irc-bot">
<h2>Gerrit IRC Bot<a class="headerlink" href="#gerrit-irc-bot" title="Permalink to this headline">¶</a></h2>
<p>Gerritbot consumes the Gerrit event stream and announces relevant
events on IRC.  <a class="reference internal" href="irc.html#gerritbot"><em>Gerritbot</em></a> is an openstack-infra project and is
also available on Pypi.</p>
</div>
<div class="section" id="launchpad-bug-integration">
<h2>Launchpad Bug Integration<a class="headerlink" href="#launchpad-bug-integration" title="Permalink to this headline">¶</a></h2>
<p>In addition to the hyperlinks provided by the regex in gerrit.config,
we use a Gerrit hook to update Launchpad bugs when changes referencing
them are applied.  This is managed by the <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a>
openstack-infra project.</p>
</div>
<div class="section" id="storyboard-integration">
<h2>Storyboard Integration<a class="headerlink" href="#storyboard-integration" title="Permalink to this headline">¶</a></h2>
<p>We use the Gerrit <a class="reference external" href="https://review.openstack.org/plugins/its-storyboard/Documentation/index.html">its-storyboard</a> plugin to update <a class="reference internal" href="storyboard.html#storyboard"><em>StoryBoard</em></a>
stories and tasks when changes referencing them are applied.</p>
</div>
<div class="section" id="new-project-creation">
<h2>New Project Creation<a class="headerlink" href="#new-project-creation" title="Permalink to this headline">¶</a></h2>
<p>Gerrit project creation is now managed through changes to the
openstack-infra/project-config repository.  <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a> handles
automatically creating any new projects defined in the configuration
files.</p>
</div>
<div class="section" id="local-git-replica">
<h2>Local Git Replica<a class="headerlink" href="#local-git-replica" title="Permalink to this headline">¶</a></h2>
<p>Gerrit replicates all repos to a local directory so that Apache can
serve the anonymous http requests out directly.  This is automatically
configured by <a class="reference internal" href="jeepyb.html#jeepyb"><em>Jeepyb</em></a>.</p>
</div>
<div class="section" id="access-controls">
<span id="acl"></span><h2>Access Controls<a class="headerlink" href="#access-controls" title="Permalink to this headline">¶</a></h2>
<p>High level goals:</p>
<ol class="arabic simple">
<li>Anonymous users can read all projects.</li>
<li>All registered users can perform informational code review (+/-1)
on any project.</li>
<li>Jenkins can perform verification (blocking or approving: +/-1).</li>
<li>All registered users can create changes.</li>
<li>The OpenStack Release Manager and Jenkins can tag releases (push
annotated tags).</li>
<li>Members of $PROJECT-core group can perform full code review
(blocking or approving: +/- 2), and submit changes to be merged.</li>
<li>Members of Release Managers (Release Manager and delegates), and
$PROJECT-milestone (PTL and release minded people) exclusively can
perform full code review (blocking or approving: +/- 2), and submit
changes to be merged on pre-release stable/* branches.</li>
<li>Full code review (+/- 2) of API projects (documentation of the API,
not implementation of the API) should be available to the -core
group of the corresponding implementation project as well as to the
OpenStack Documentation Coordinators.</li>
<li>Full code review of stable branches should be available to the
-stable-maint group of the project.</li>
<li>Drivers (PTL and delegates) of client library projects should be
able to add tags (which are automatically used to trigger
releases).</li>
</ol>
<p>To manage API project permissions collectively across projects, API
projects are reparented to the &#8220;API-Projects&#8221; meta-project instead of
&#8220;All-Projects&#8221;.  This causes them to inherit permissions from the
API-Projects project (which, in turn, inherits from All-Projects).</p>
<p>The global Gerrit permissions set out the high level goals (and
manage-projects can then override this on a per project basis as
needed). To setup the global permissions, first create the groups
covered above under Groups.</p>
<p>You need to grant yourself enough access to replace the ACLs over ssh (we use
SSH because it&#8217;s fast, and it gets syntax checked).</p>
<ol class="arabic simple">
<li>Visit <tt class="docutils literal"><span class="pre">https://$HOST/#/admin/projects/All-Projects,access</span></tt> and click on Edit.</li>
<li>Look for the reference to &#8216;refs/meta/config&#8217;, click on the drop-box
for &#8216;add permission&#8217; and choose &#8216;PUSH&#8217;.</li>
<li>Type in Administrators as the group name</li>
<li>Click on Add</li>
<li>Click on Save Changes</li>
</ol>
<p>Then... we need to fetch the All-Projects ACLs, update them, then push the
updates back into Gerrit:</p>
<div class="highlight-python"><pre>export USER=$your_gerrit_user
export HOST=$your_gerrit_host
cd $anywhereyoulike
mkdir All-Projects-ACLs
cd All-Projects-ACLs
git init
git remote add gerrit ssh://$USER@$HOST:29418/All-Projects.git
git fetch gerrit +refs/meta/*:refs/remotes/gerrit-meta/*
git checkout -b config remotes/gerrit-meta/config</pre>
</div>
<p>There will be two interesting files, <cite>groups</cite> and <cite>project.config</cite>.
<cite>groups</cite> contains UUIDs and names of groups that will be referenced
in <cite>project.config</cite>. UUIDs can be found on the group page in Gerrit.
Next, edit <cite>project.config</cite> to look like:</p>
<div class="highlight-python"><pre>[access "refs/*"]
create = group Project Bootstrappers
create = group Release Managers
forgeAuthor = group Registered Users
forgeCommitter = group Project Bootstrappers
push = +force group Project Bootstrappers
pushMerge = group Project Bootstrappers
pushSignedTag = group Project Bootstrappers
pushTag = group Continuous Integration Tools
pushTag = group Project Bootstrappers
pushTag = group Release Managers
read = group Anonymous Users
editTopicName = group Registered Users

[access "refs/drafts/*"]
push = block group Registered Users

[access "refs/for/refs/*"]
push = group Registered Users

[access "refs/for/refs/zuul/*"]
pushMerge = group Continuous Integration Tools

[access "refs/heads/*"]
label-Code-Review = -2..+2 group Project Bootstrappers
label-Code-Review = -1..+1 group Registered Users
label-Verified = -2..+2 group Continuous Integration Tools
label-Verified = -2..+2 group Project Bootstrappers
label-Verified = -1..+1 group Voting Third-Party CI
label-Workflow = -1..+0 group Change Owner
label-Workflow = -1..+1 group Project Bootstrappers
rebase = group Registered Users
submit = group Continuous Integration Tools
submit = group Project Bootstrappers

[access "refs/meta/config"]
read = group Project Owners

[access "refs/meta/openstack/*"]
create = group Continuous Integration Tools
push = group Continuous Integration Tools
read = group Continuous Integration Tools

[access "refs/zuul/*"]
create = group Continuous Integration Tools
push = +force group Continuous Integration Tools
pushMerge = group Continuous Integration Tools

[capability]
accessDatabase = group Administrators
administrateServer = group Administrators
createProject = group Project Bootstrappers
emailReviewers = deny group Third-Party CI
priority = batch group Non-Interactive Users
runAs = group Project Bootstrappers
streamEvents = group Registered Users

[contributor-agreement "ICLA"]
accepted = group CLA Accepted - ICLA
agreementUrl = static/cla.html
autoVerify = group CLA Accepted - ICLA
description = OpenStack Individual Contributor License Agreement
requireContactInformation = true

[contributor-agreement "System CLA"]
accepted = group System CLA
agreementUrl = static/system-cla.html
description = DON'T SIGN THIS: System CLA (externally managed)

[contributor-agreement "USG CLA"]
accepted = group USG CLA
agreementUrl = static/usg-cla.html
description = DON'T SIGN THIS: U.S. Government CLA (externally managed)

[label "Code-Review"]
abbreviation = R
copyAllScoresOnTrivialRebase = true
copyMinScore = true
function = MaxWithBlock
value = -2 Do not merge
value = -1 This patch needs further work before it can be merged
value = 0 No score
value = +1 Looks good to me, but someone else must approve
value = +2 Looks good to me (core reviewer)

[label "Verified"]
function = MaxWithBlock
value = -2 Fails
value = -1 Doesn't seem to work
value = 0 No score
value = +1 Works for me
value = +2 Verified

[label "Workflow"]
function = MaxWithBlock
value = -1 Work in progress
value = 0 Ready for reviews
value = +1 Approved

[plugin "its-storyboard"]
enabled = true

[project]
description = Rights inherited by all other projects</pre>
</div>
<p>Now edit the groups file. The format is:</p>
<div class="highlight-python"><pre>#UUID  Group Name
1234567890123456789012345678901234567890  group-foo</pre>
</div>
<p>Each of the groups listed above under &#8216;Groups&#8217; should have an entry as well as
the built in groups such as &#8216;Non-Interactive Users&#8217; which may or may not be
present in the initial groups file. You can find the UUID values by navigating
to Admin -&gt; Groups -&gt; Group Name -&gt; General in the Web UI.</p>
<p>Finally, commit the changes and push the config back up to Gerrit:</p>
<div class="highlight-python"><pre>git commit -am "Initial All-Projects config"
git push gerrit HEAD:refs/meta/config</pre>
</div>
</div>
<div class="section" id="manual-administrative-tasks">
<h2>Manual Administrative Tasks<a class="headerlink" href="#manual-administrative-tasks" title="Permalink to this headline">¶</a></h2>
<p>The following sections describe tasks that individuals with root
access may need to perform on rare occasions.</p>
<div class="section" id="renaming-a-project">
<h3>Renaming a Project<a class="headerlink" href="#renaming-a-project" title="Permalink to this headline">¶</a></h3>
<p>Renaming a project is not automated and is disruptive to developers,
so it should be avoided. Allow for an hour of downtime for the
project in question, and about 10 minutes of downtime for all of
Gerrit. All Gerrit changes, merged and open, will carry over, so
in-progress changes do not need to be merged before the move.</p>
<p>To rename a project:</p>
<ol class="arabic">
<li><p class="first">Prepare a change to the project-config repo to update things like
projects.yaml/ACLs, jenkins-job-builder and gerritbot for the new
name. Also add changes to update projects.txt in all branches of
the requirements repo, devstack-vm-gate-wrap.sh in the
devstack-gate repo, reference/projects.yaml in the
openstack/governance repo, and .gitmodules in the
openstack/openstack repo if necessary.</p>
</li>
<li><p class="first">Prepare a yaml file called repos.yaml that has a single dictionary called
<cite>repos</cite> with a list of dictionaries each having an old and new entry.
Optionally also add a <cite>gerrit_groups</cite> dict of the same form:</p>
<div class="highlight-python"><pre>repos:
- old: stackforge/awesome-repo
  new: openstack/awesome-repo
- old: openstack/foo
  new: openstack/bar
gerrit_groups:
- old: old-core-group
  new: new-core-group</pre>
</div>
</li>
<li><p class="first">An hour in advance of the maintenance (if possible), stop puppet
runs on the puppetmaster to prevent early application of
configuration changes:</p>
<div class="highlight-python"><pre>sudo crontab -u root -e</pre>
</div>
<p>Comment out the crontab entries.  Use ps to make sure that a run is
not currently in progress.  When it finishes, make sure the entry
has not been added back to the crontab.</p>
</li>
<li><p class="first">Export and stop Zuul on zuul.openstack.org:</p>
<div class="highlight-python"><pre>python /opt/zuul/tools/zuul-changes.py http://zuul.openstack.org gate &gt;gate.sh
python /opt/zuul/tools/zuul-changes.py http://zuul.openstack.org check &gt;check.sh
sudo invoke-rc.d zuul stop
sudo rm -f /var/run/zuul/zuul.pid /var/run/zuul/zuul.listedock</pre>
</div>
</li>
<li><p class="first">Run the ansible rename repos playbook, passing in the path to your yaml
file:</p>
<div class="highlight-python"><pre>sudo ansible-playbook -f 10 /opt/system-config/production/playbooks/rename_repos.yaml -e repolist=ABSOLUTE_PATH_TO_VARS_FILE</pre>
</div>
</li>
<li><p class="first">Start Zuul on zuul.openstack.org:</p>
<div class="highlight-python"><pre>sudo invoke-rc.d zuul start
sudo bash gate.sh
sudo bash check.sh</pre>
</div>
</li>
<li><p class="first">Merge the prepared Puppet configuration changes.</p>
</li>
<li><p class="first">Rename the project or transfer ownership in GitHub</p>
</li>
<li><p class="first">Re-enable puppet runs on the puppetmaster:</p>
<div class="highlight-python"><pre>sudo crontab -u root -e</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Wait for the <tt class="docutils literal"><span class="pre">project-config</span></tt> changes to merge before
re-enabling cron, else duplicate projects can appear that have
to be manually removed.</p>
</div>
</li>
<li><p class="first">Submit a change that updates .gitreview with the new location of the
project.</p>
</li>
</ol>
<p>Developers will either need to re-clone a new copy of the repository,
or manually update their remotes with something like:</p>
<div class="highlight-python"><pre>git remote set-url origin https://git.openstack.org/$ORG/$PROJECT</pre>
</div>
</div>
<div class="section" id="third-party-testing-access">
<h3>Third-Party Testing Access<a class="headerlink" href="#third-party-testing-access" title="Permalink to this headline">¶</a></h3>
<p>The command to add an account for an automated system which gets -1/+1
code verify voting rights (as outlined in <a class="reference internal" href="third_party.html#third-party-testing"><em>Third Party Testing</em></a>)
looks like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh -p <span class="m">29418</span> review.openstack.org <span class="s2">&quot;gerrit create-account \</span>
<span class="s2">    --group &#39;Third-Party CI&#39; \</span>
<span class="s2">    --full-name &#39;Some CI Bot&#39; \</span>
<span class="s2">    --email ci-bot@third-party.org \</span>
<span class="s2">    --ssh-key &#39;ssh-rsa AAAAB3Nz...zaUCse1P ci-bot@third-party.org&#39; \</span>
<span class="s2">    some-ci-bot&quot;</span>
</pre></div>
</div>
<p>Details on the <a class="reference external" href="https://review.openstack.org/Documentation/cmd-create-account.html">create-account</a> command can be found in the Gerrit
API documentation.</p>
</div>
<div class="section" id="resetting-a-username-in-gerrit">
<h3>Resetting a Username in Gerrit<a class="headerlink" href="#resetting-a-username-in-gerrit" title="Permalink to this headline">¶</a></h3>
<p>Initially if a Gerrit username (which is used to associate SSH
connections to an account) has not yet been set, the user can type
it into the Gerrit WebUI... but there is no supported way for the
user to alter or correct it once entered. Further, if a defunct
account has the desired username, a different one will have to be
entered.</p>
<p>Because of this, often due to the user ending up with <a class="reference internal" href="#duplicate-accounts-in-gerrit">Duplicate
Accounts in Gerrit</a>, it may be requested to change the SSH username
of an account. Confirm the account_id number for the account in
question and remove the existing username external_id for that (it
may also be necessary to remove any lingering external_id with the
desired username if confirmed there is a defunct account associated
with it):</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">delete</span> <span class="k">from</span> <span class="n">account_external_ids</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">NNNN</span> <span class="k">and</span> <span class="n">external_id</span> <span class="k">like</span> <span class="s1">&#39;username:%&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>After this, the user should be able to re-add their username through
the Gerrit WebUI.</p>
</div>
<div class="section" id="duplicate-accounts-in-gerrit">
<h3>Duplicate Accounts in Gerrit<a class="headerlink" href="#duplicate-accounts-in-gerrit" title="Permalink to this headline">¶</a></h3>
<p>From time to time, outside events affecting SSO authentication or
identity changes can result in multiple Gerrit accounts for the same
user. This frequently causes duplication of preferred E-mail
addresses, which also renders the accounts unselectable in some
parts of the WebUI (notably when trying to add reviewers to a change
or members in a group). Gerrit does not provide a supported
mechanism for <a class="reference internal" href="#combining-gerrit-accounts">Combining Gerrit Accounts</a>, and doing so manually is
both time-consuming and error prone. As a result, the OpenStack
infrastructure team does not combine duplicate accounts for users
but can clean up these E-mail address issues upon request. To find
the offending duplicates:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">account_id</span> <span class="k">from</span> <span class="n">accounts</span> <span class="k">where</span> <span class="n">preferred_email</span><span class="o">=</span><span class="s1">&#39;user@example.com&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Find out from the user which account_id is the one they&#8217;re currently
using, and then null out the others with:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">update</span> <span class="n">accounts</span> <span class="kt">set</span> <span class="n">preferred_email</span><span class="o">=</span><span class="no">NULL</span><span class="p">,</span> <span class="n">registered_on</span><span class="o">=</span><span class="n">registered_on</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
</pre></div>
</div>
<p>Then flush Gerrit&#8217;s caches so any immediate account lookups will hit
the current DB contents:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh review.openstack.org -p29418 gerrit flush-caches --all
</pre></div>
</div>
</div>
<div class="section" id="combining-gerrit-accounts">
<h3>Combining Gerrit Accounts<a class="headerlink" href="#combining-gerrit-accounts" title="Permalink to this headline">¶</a></h3>
<p>While not supported by Gerrit, a fairly thorough account merge is
documented here (mostly as a demonstration of its unfortunate
complexity). Please note that the OpenStack infrastructure team does
not combine duplicate accounts for users upon request, but this
would be the process to follow if it becomes necessary under some
extraordinary circumstance.</p>
<p>Collect as much information as possible about all affected accounts,
and then go poking around in the tables listed below for additional
ones to determine the account_id number for the current account and
any former accounts which should be merged into it. Then for each
old account_id, perform these update and delete queries:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">delete</span> <span class="k">from</span> <span class="n">account_agreements</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_diff_preferences</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_external_ids</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_group_members</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_group_members_audit</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_project_watches</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">account_ssh_keys</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">accounts</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">account_patch_reviews</span> <span class="kt">set</span> <span class="n">account_id</span><span class="o">=</span><span class="n">NEW</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">starred_changes</span> <span class="kt">set</span> <span class="n">account_id</span><span class="o">=</span><span class="n">NEW</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">change_messages</span> <span class="kt">set</span> <span class="n">author_id</span><span class="o">=</span><span class="n">NEW</span><span class="p">,</span> <span class="n">written_on</span><span class="o">=</span><span class="n">written_on</span> <span class="k">where</span> <span class="n">author_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">changes</span> <span class="kt">set</span> <span class="n">owner_account_id</span><span class="o">=</span><span class="n">NEW</span><span class="p">,</span> <span class="n">created_on</span><span class="o">=</span><span class="n">created_on</span> <span class="k">where</span> <span class="n">owner_account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">patch_comments</span> <span class="kt">set</span> <span class="n">author_id</span><span class="o">=</span><span class="n">NEW</span><span class="p">,</span> <span class="n">written_on</span><span class="o">=</span><span class="n">written_on</span> <span class="k">where</span> <span class="n">author_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">patch_sets</span> <span class="kt">set</span> <span class="n">uploader_account_id</span><span class="o">=</span><span class="n">NEW</span><span class="p">,</span> <span class="n">created_on</span><span class="o">=</span><span class="n">created_on</span> <span class="k">where</span> <span class="n">uploader_account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">update</span> <span class="n">patch_set_approvals</span> <span class="kt">set</span> <span class="n">account_id</span><span class="o">=</span><span class="n">NEW</span><span class="p">,</span> <span class="n">granted</span><span class="o">=</span><span class="n">granted</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
</pre></div>
</div>
<p>If that last update query results in a collision with an error
like:</p>
<div class="highlight-python"><pre>ERROR 1062 (23000): Duplicate entry 'XXX-YY-NEW' for key 'PRIMARY'</pre>
</div>
<p>Then you can manually delete the old approval:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">delete</span> <span class="k">from</span> <span class="n">patch_set_approvals</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span> <span class="k">and</span> <span class="n">change_id</span><span class="o">=</span><span class="n">XXX</span> <span class="k">and</span> <span class="n">patch_set_id</span><span class="o">=</span><span class="n">YY</span><span class="p">;</span>
</pre></div>
</div>
<p>And repeat until the update query runs to completion.</p>
<p>After all the described deletes and updates have been applied, flush
Gerrit&#8217;s caches so things like authentication will be rechecked
against the current DB contents:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ssh review.openstack.org -p29418 gerrit flush-caches --all
</pre></div>
</div>
<p>Make the user aware that these steps have also removed any group
memberships, preferences, SSH keys, contact information, CLA
signatures, and so on associated with the old account so some of
these may still need to be added to the new one via the Gerrit WebUI
if they haven&#8217;t been already. With a careful inspection of all
accounts involved it is possible to merge some information from the
old accounts into new ones by performing update queries similar to
the deletes above, but since this varies on a case-by-case basis
it&#8217;s left as an exercise for the reader.</p>
</div>
<div class="section" id="deleting-a-user-from-gerrit">
<h3>Deleting a User from Gerrit<a class="headerlink" href="#deleting-a-user-from-gerrit" title="Permalink to this headline">¶</a></h3>
<p>This isn&#8217;t normally necessary, but if you find that you need to
completely delete an account from Gerrit, perform the same delete
queries mentioned in <a class="reference internal" href="#combining-gerrit-accounts">Combining Gerrit Accounts</a> and replace the
update queries for account_patch_reviews and starred_changes with:</p>
<div class="highlight-mysql"><div class="highlight"><pre><span></span><span class="k">delete</span> <span class="k">from</span> <span class="n">account_patch_reviews</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
<span class="k">delete</span> <span class="k">from</span> <span class="n">starred_changes</span> <span class="k">where</span> <span class="n">account_id</span><span class="o">=</span><span class="n">OLD</span><span class="p">;</span>
</pre></div>
</div>
<p>The other update queries can be ignored, since deleting them in many
cases would result in loss of legitimate review history.</p>
</div>
<div class="section" id="refreshing-html-and-css-configuration">
<h3>Refreshing HTML and CSS configuration<a class="headerlink" href="#refreshing-html-and-css-configuration" title="Permalink to this headline">¶</a></h3>
<p>When there is a change in HTML headers, or CSS, this can be applied
without the need of restarting Gerrit. To do that, ssh in the Gerrit
instance, and touch GerritSiteHeader.html and/or GerritSite.css,
under /home/gerrit2/review_site/etc directory.</p>
</div>
<div class="section" id="deactivating-a-gerrit-account">
<h3>Deactivating a Gerrit account<a class="headerlink" href="#deactivating-a-gerrit-account" title="Permalink to this headline">¶</a></h3>
<p>To deactivate a Gerrit account (use case can be a failing Third Party CI), you
must follow that steps:</p>
<ol class="arabic">
<li><p class="first">Identify the account ID of the Third Party CI you need to deactivate. Third-Party CI
members can be found on: <a class="reference external" href="https://review.openstack.org/#/admin/groups/270,members">https://review.openstack.org/#/admin/groups/270,members</a></p>
<p>That will give you the name and email of all members. Then you can get the matching
numerical account ID with the help of REST API:
curl -i -H &#8220;Accept: application/json&#8221; &#8211;digest &#8211;user &lt;&lt;gerrit_user&gt;&gt;:&lt;&lt;http_pass&gt;&gt; -X GET <a class="reference external" href="https://review.openstack.org/a/accounts">https://review.openstack.org/a/accounts</a>/{email}</p>
<p>This will return a JSON dictionary, that will contain _account_id field.</p>
</li>
<li><p class="first">Mark the account as inactive using gerrit ssh api, with:
ssh -p 29418 review.openstack.org gerrit set-account &#8211;inactive {account-id}</p>
<p>Alternatively you can use REST API, sending a DELETE for:
curl -i -H &#8220;Accept: application/json&#8221; &#8211;digest &#8211;user &lt;&lt;gerrit_user&gt;&gt;:&lt;&lt;http_pass&gt;&gt; -X DELETE <a class="reference external" href="https://review.openstack.org/a/accounts">https://review.openstack.org/a/accounts</a>/{account-id}/active</p>
</li>
<li><p class="first">Check if there are active gerrit ssh connections:
ssh -p 29418 review.openstack.org gerrit show-connections -n | grep {account-id}</p>
<p>And kill all of them with subsequent:
ssh -p 29418 review.openstack.org gerrit close-connection {connection-id}</p>
</li>
<li><p class="first">You can check if the account is properly marked as inactive using REST API,
sending a GET for:</p>
<p>curl -i -H &#8220;Accept: application/json&#8221; &#8211;digest &#8211;user &lt;&lt;gerrit_user&gt;&gt;:&lt;&lt;http_pass&gt;&gt; -X GET <a class="reference external" href="https://review.openstack.org/a/accounts">https://review.openstack.org/a/accounts</a>/{account-id}/active</p>
<p>A 200 return code means the account is active, and 204 means account inactive.</p>
</li>
</ol>
<ol class="arabic simple" start="4">
<li>In the case of a failing Third Party CI, if the account caused a loop of comments in
a change, you can delete them with following query:
delete from change_messages where author_id={account-id} and change_id={change-id};</li>
</ol>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Gerrit</a><ul>
<li><a class="reference internal" href="#at-a-glance">At a Glance</a></li>
<li><a class="reference internal" href="#installation">Installation</a><ul>
<li><a class="reference internal" href="#cinder-volumes">Cinder Volumes</a></li>
<li><a class="reference internal" href="#gerrit-configuration">Gerrit Configuration</a></li>
<li><a class="reference internal" href="#groups">Groups</a></li>
<li><a class="reference internal" href="#users">Users</a></li>
</ul>
</li>
<li><a class="reference internal" href="#github-integration">GitHub Integration</a><ul>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#auto-review-expiry">Auto Review Expiry</a></li>
<li><a class="reference internal" href="#gerrit-irc-bot">Gerrit IRC Bot</a></li>
<li><a class="reference internal" href="#launchpad-bug-integration">Launchpad Bug Integration</a></li>
<li><a class="reference internal" href="#storyboard-integration">Storyboard Integration</a></li>
<li><a class="reference internal" href="#new-project-creation">New Project Creation</a></li>
<li><a class="reference internal" href="#local-git-replica">Local Git Replica</a></li>
<li><a class="reference internal" href="#access-controls">Access Controls</a></li>
<li><a class="reference internal" href="#manual-administrative-tasks">Manual Administrative Tasks</a><ul>
<li><a class="reference internal" href="#renaming-a-project">Renaming a Project</a></li>
<li><a class="reference internal" href="#third-party-testing-access">Third-Party Testing Access</a></li>
<li><a class="reference internal" href="#resetting-a-username-in-gerrit">Resetting a Username in Gerrit</a></li>
<li><a class="reference internal" href="#duplicate-accounts-in-gerrit">Duplicate Accounts in Gerrit</a></li>
<li><a class="reference internal" href="#combining-gerrit-accounts">Combining Gerrit Accounts</a></li>
<li><a class="reference internal" href="#deleting-a-user-from-gerrit">Deleting a User from Gerrit</a></li>
<li><a class="reference internal" href="#refreshing-html-and-css-configuration">Refreshing HTML and CSS configuration</a></li>
<li><a class="reference internal" href="#deactivating-a-gerrit-account">Deactivating a Gerrit account</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="cacti.html"
                                  title="previous chapter">Cacti</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="grafana.html"
                                  title="next chapter">Grafana</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack-infra/system-config
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/gerrit.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="grafana.html" title="Grafana"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cacti.html" title="Cacti"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack Project Infrastructure 0.0.1.dev12076 documentation</a> &raquo;</li>
          <li><a href="systems.html" accesskey="U">Major Systems</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, OpenStack Infastructure Team - see the <a href="https://git.openstack.org/cgit/openstack-infra/system-config/">system-config git repo</a> for details.
      Last updated on Mon Feb 13 23:40:08 2017, commit 91bca8d.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/OpenStack Project Infrastructure");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>