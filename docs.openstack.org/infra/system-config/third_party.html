
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Third Party Testing &mdash; OpenStack Project Infrastructure 0.0.1.dev12076 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1.dev12076',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack Project Infrastructure 0.0.1.dev12076 documentation" href="index.html" />
    <link rel="next" title="Contributing Cloud Test Resources" href="contribute-cloud.html" />
    <link rel="prev" title="StackForge" href="stackforge.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
<li><a href="index.html" title="Go to the Home page" class="link">Home</a></li>
<li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
<li><a href="http://review.openstack.org/" title="Go to the OpenStack Gerrit server">Gerrit</a></li>
<li><a href="http://jenkins.openstack.org/" title="Go to the OpenStack Jenkins server">Jenkins</a></li>
<li><a href="http://logstash.openstack.org/" title="Go to the OpenStack Logstash server">Logstash</a></li>
<li><a href="http://etherpad.openstack.org/" title="Go to the OpenStack Etherpad server">Etherpad</a></li>
<li><a href="http://paste.openstack.org/" title="Go to the OpenStack Paste server">Paste</a></li>
<li><a href="http://planet.openstack.org/" title="Go to the OpenStack Planet server">Planet</a></li>
<li><a href="http://lists.openstack.org/" title="Go to the OpenStack Mailman server">Mailman</a></li>

    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="third-party-testing">
<span id="id1"></span><h1>Third Party Testing<a class="headerlink" href="#third-party-testing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Gerrit has an event stream which can be subscribed to. Using this event stream,
it is possible to test commits against testing systems beyond those supplied by
OpenStack&#8217;s Jenkins setup.  It is also possible for these systems to feed
information back into Gerrit and they can also leave non-gating votes on Gerrit
review requests.</p>
<p>There are several examples of systems that read the Gerrit event stream
and run their own tests on the commits
<a class="reference external" href="https://wiki.openstack.org/wiki/ThirdPartySystems">on this page</a>.
For each patch set the third party system tests, the system adds a comment
in Gerrit with a summary of the test result and links to the test artifacts.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Before posting a comment to any patch, a third party testing system must
contact the project they wish to test and get approval to post comments
on their patches. This can be done by attending the project&#8217;s <a class="reference external" href="https://wiki.openstack.org/wiki/Meetings">meeting</a>.</p>
</li>
<li><p class="first">Until a third party testing system operates in a stable fashion, third
party tests can comment on patches but not vote on them.</p>
<ul class="simple">
<li>A system can also be set up to only do &#8216;+1&#8217; reviews and leave all the
&#8216;-1&#8217;s to be manually confirmed.</li>
</ul>
</li>
<li><p class="first">A third-party system may only leave one comment per patch set
(unless it is retriggered).</p>
</li>
<li><p class="first">The maintainers are responsible for re-triggering tests when their third
party testing system breaks.</p>
</li>
<li><p class="first">Support recheck to request re-running a test.</p>
<ul class="simple">
<li>Support the following syntaxes: <tt class="docutils literal"><span class="pre">recheck</span></tt>.</li>
<li>Recheck means recheck everything. A single recheck comment should
re-trigger all testing systems.</li>
</ul>
</li>
<li><p class="first">Publish contact information for the maintainers.</p>
<ul class="simple">
<li>All accounts must have a wikipage entry. Follow the instructions on
the <a class="reference external" href="https://wiki.openstack.org/wiki/ThirdPartySystems">ThirdPartySystems wiki page</a> to add your
system.  When complete, there should be a page dedicated to your
system with a URL like:
<tt class="docutils literal"><span class="pre">https://wiki.openstack.org/wiki/ThirdPartySystems/Example</span></tt>.</li>
<li>All comments from your CI system must contain a link to the wiki
page for your CI system.</li>
<li>Maintainers are encouraged to be in IRC regularly to make it
faster to contact them.</li>
</ul>
</li>
<li><p class="first">Include a public link to all test artifacts to make debugging failed tests
easier (using a dns name over a hardcoded ip is recommended).
This should include:</p>
<ul class="simple">
<li>Environment details<ul>
<li>This must include a utc timestamp of the test run</li>
</ul>
</li>
<li>Test configuration<ul>
<li>Skipped tests</li>
<li>logs should include a trace of the commands used</li>
</ul>
</li>
<li>OpenStack logs</li>
<li>Tempest logs (including <tt class="docutils literal"><span class="pre">testr_results.html.gz</span></tt>)<ul>
<li>logs must be browsable; logs requiring download, installation or login
to access are not acceptable</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All test artifacts must be retained for one month.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="reading-the-event-stream">
<h2>Reading the Event Stream<a class="headerlink" href="#reading-the-event-stream" title="Permalink to this headline">¶</a></h2>
<p>It is possible to use ssh to connect to <tt class="docutils literal"><span class="pre">review.openstack.org</span></tt> on port 29418
with your ssh key if you have a normal reviewer account in Gerrit.</p>
<p>This will give you a real-time JSON stream of events happening inside Gerrit.
For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ssh -p <span class="m">29418</span> USERNAME@review.openstack.org gerrit stream-events
</pre></div>
</div>
<p>Will give a stream with an output like this (line breaks and
indentation added in this document for readability, the real JSON will
be all one line per event):</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;comment-added&quot;</span><span class="p">,</span><span class="s2">&quot;change&quot;</span><span class="o">:</span>
  <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="o">:</span><span class="s2">&quot;openstack/keystone&quot;</span><span class="p">,</span><span class="s2">&quot;branch&quot;</span><span class="o">:</span><span class="s2">&quot;stable/essex&quot;</span><span class="p">,</span><span class="s2">&quot;topic&quot;</span><span class="o">:</span><span class="s2">&quot;bug/969088&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;I18ae38af62b4c2b2423e20e436611fc30f844ae1&quot;</span><span class="p">,</span><span class="s2">&quot;number&quot;</span><span class="o">:</span><span class="s2">&quot;7385&quot;</span><span class="p">,</span><span class="s2">&quot;subject&quot;</span><span class="o">:</span><span class="s2">&quot;Make import_nova_auth only create roles which don\u0027t already exist&quot;</span><span class="p">,</span><span class="s2">&quot;owner&quot;</span><span class="o">:</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Chuck Short&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;chuck.short@canonical.com&quot;</span><span class="p">,</span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="s2">&quot;zulcss&quot;</span><span class="p">},</span><span class="s2">&quot;url&quot;</span><span class="o">:</span><span class="s2">&quot;https://review.openstack.org/7385&quot;</span><span class="p">},</span>
  <span class="s2">&quot;patchSet&quot;</span><span class="o">:</span>
    <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="o">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="s2">&quot;revision&quot;</span><span class="o">:</span><span class="s2">&quot;aff45d69a73033241531f5e3542a8d1782ddd859&quot;</span><span class="p">,</span><span class="s2">&quot;ref&quot;</span><span class="o">:</span><span class="s2">&quot;refs/changes/85/7385/1&quot;</span><span class="p">,</span><span class="s2">&quot;uploader&quot;</span><span class="o">:</span>
      <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Chuck Short&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;chuck.short@canonical.com&quot;</span><span class="p">,</span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="s2">&quot;zulcss&quot;</span><span class="p">},</span>
    <span class="s2">&quot;createdOn&quot;</span><span class="o">:</span><span class="mi">1337002189</span><span class="p">},</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Mark McLoughlin&quot;</span><span class="p">,</span><span class="s2">&quot;email&quot;</span><span class="o">:</span><span class="s2">&quot;markmc@redhat.com&quot;</span><span class="p">,</span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="s2">&quot;markmc&quot;</span><span class="p">},</span>
  <span class="s2">&quot;approvals&quot;</span><span class="o">:</span>
    <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;CRVW&quot;</span><span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="s2">&quot;Code Review&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;2&quot;</span><span class="p">},{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;APRV&quot;</span><span class="p">,</span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="s2">&quot;Approved&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;0&quot;</span><span class="p">}],</span>
<span class="s2">&quot;comment&quot;</span><span class="o">:</span><span class="s2">&quot;Hmm, I actually thought this was in Essex already.\n\nIt\u0027s a pretty annoying little issue for folks migrating for nova auth. Fix is small and pretty safe. Good choice for backporting&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>For most purposes you will want to trigger on <tt class="docutils literal"><span class="pre">patchset-created</span></tt> for when a
new patchset has been uploaded.</p>
<p>Further documentation on how to use the events stream can be found in <a class="reference external" href="https://review.openstack.org/Documentation/cmd-stream-events.html">Gerrit&#8217;s stream event documentation page</a>.</p>
</div>
<div class="section" id="posting-result-to-gerrit">
<h2>Posting Result To Gerrit<a class="headerlink" href="#posting-result-to-gerrit" title="Permalink to this headline">¶</a></h2>
<p>External testing systems can give non-gating votes to Gerrit by means
of a -1/+1 verify vote.  OpenStack Jenkins has extra permissions to
give a +2/-2 verify vote which is gating.  Comments should also be
provided to explain what kind of test failed.  We do also ask that the
comments contain public links to the failure so that the developer can
see what caused the failure.</p>
<p>An example of how to post this is as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ssh -p <span class="m">29418</span> USERNAME@review.openstack.org gerrit review -m <span class="s1">&#39;&quot;Test failed on MegaTestSystem &lt;http://megatestsystem.org/tests/1234&gt;&quot;&#39;</span> --verified<span class="o">=</span>-1 c0ff33
</pre></div>
</div>
<p>In this example <tt class="docutils literal"><span class="pre">c0ff33</span></tt> is the commit ID for the review.  You can
set the verified to either <cite>-1</cite> or <cite>+1</cite> depending on whether or not it
passed the tests.</p>
<p>Further documentation on the <cite>review</cite> command in Gerrit can be found in the <a class="reference external" href="https://review.openstack.org/Documentation/cmd-review.html">Gerrit review documentation page</a>.</p>
<p>We do suggest cautious testing of these systems and have a development Gerrit
setup to test on if required.  In SmokeStack&#8217;s case all failures are manually
reviewed before getting pushed to OpenStack, while this may not scale it is
advisable during the initial testing of the setup.</p>
<p>There are several triggers that gerrit will match to alter the
formatting of comments.  The raw regular expressions can be seen in
<a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/manifests/gerrit.pp">gerrit.pp</a>.
For example, to have your test results formatted in the same manner as
the upstream Jenkins results, use a template for each result matching:</p>
<div class="highlight-python"><pre>* test-name-no-spaces http://link.to/result : [SUCCESS|FAILURE] some comment about the test</pre>
</div>
</div>
<div class="section" id="creating-a-service-account">
<span id="request-account-label"></span><h2>Creating a Service Account<a class="headerlink" href="#creating-a-service-account" title="Permalink to this headline">¶</a></h2>
<p>In order to post comments as a Third Party CI System and eventually verify
your build status on Gerrit patches, you will need a dedicated Gerrit
CI account. You will need to create this account in our OpenID provider
<a class="reference external" href="https://launchpad.net">Launchpad</a>. You may already have an existing
personal account in Launchpad, but you should create a new and entirely
separate account for this purpose. This new CI service account needs to use
a different email address than any existing accounts you have, because
Gerrit assumes email addresses are unique across all accounts.</p>
<p>Once you have created this account with the OpenID provider you can log
into Gerrit with that new account as you would with your normal user
account. Once logged in you will need to do several things:</p>
<blockquote>
<div><p>1. Set an SSH username at <a class="reference external" href="https://review.openstack.org/#/settings/">https://review.openstack.org/#/settings/</a> if
it isn&#8217;t already set. This is the username your CI system will use to
SSH to Gerrit in order to read the event stream.</p>
<p>2. Set the account&#8217;s fullname at <a class="reference external" href="https://review.openstack.org/#/settings/contact">https://review.openstack.org/#/settings/contact</a>
This name should follow a few rules in order to make it clear in Gerrit
comments what this CI system exists to test. The name should have three
pieces <tt class="docutils literal"><span class="pre">Organization</span></tt> <tt class="docutils literal"><span class="pre">Product/technology</span></tt> <tt class="docutils literal"><span class="pre">CI</span> <span class="pre">designator</span></tt>. The
organization value should be your company name or other organization
affiliation. Product/technology should describe the product or technology
you are testing in conjunction with OpenStack. This should be the name of
a component which cannot be tested in the official OpenStack
infrastructure (requires particular physical hardware, proprietary
software, some hypervisor feature not available in public clouds,
et cetera). Note this should not be the name of an OpenStack project but
rather the thing you are testing with OpenStack projects. And finally
the CI designator is used to denote this is a CI system so that automatic
Gerrit comment parsers can filter these comments out. This value should
be <tt class="docutils literal"><span class="pre">CI</span></tt> for most CI systems but can be <tt class="docutils literal"><span class="pre">Bot</span></tt> if you are not
performing continuous integration. An example of a proper name would be
something like <tt class="docutils literal"><span class="pre">IBM</span> <span class="pre">DB2</span> <span class="pre">CI</span></tt>.</p>
<p>3. Add the SSH public key you will be using to the Gerrit account at
<a class="reference external" href="https://review.openstack.org/#/settings/ssh-keys">https://review.openstack.org/#/settings/ssh-keys</a> You can generate an
ssh key using <tt class="docutils literal"><span class="pre">ssh-keygen</span></tt>. You want to give Gerrit the contents of
the generated id_rsa.pub file.</p>
</div></blockquote>
<p>Note you should also subscribe to the <a class="reference external" href="http://lists.openstack.org/cgi-bin/mailman/listinfo/third-party-announce">third-party-announce</a>
list to keep on top of announcements there which can include account
disablement notices.</p>
<p>In addition, if you use the openstack-infra CI tooling (such as zuul, or
nodepool), you should subscribe to the
<a class="reference external" href="http://lists.openstack.org/cgi-bin/mailman/listinfo/openstack-infra">OpenStack-Infra</a>
list to keep on top of announcements there.</p>
<p>It would also be a good idea to contact the <a class="reference external" href="https://review.openstack.org/#/admin/groups/440">Third Party Coordinators</a> asking to add your account
to the <a class="reference external" href="https://review.openstack.org/#/admin/groups/270">Third Party CI mail filter list</a>. This is necessary to keep
Gerrit from sending email messages every time an account comments on a patch.</p>
<p>Once you have done this you will have everything you need to comment on
Gerrit changes from our CI system but you will not be able to vote +/-1
Verified on changes. To get voting rights you will need to get the release
group of the project you are testing to add you to their project specific
&lt;project&gt;-ci group. Please contact the project in question when you are
ready to start voting and they can add you to this group.</p>
</div>
<div class="section" id="the-jenkins-gerrit-trigger-plugin-way">
<h2>The Jenkins Gerrit Trigger Plugin Way<a class="headerlink" href="#the-jenkins-gerrit-trigger-plugin-way" title="Permalink to this headline">¶</a></h2>
<p>There is a Gerrit Trigger plugin for Jenkins which automates all of the
processes described in this document.  So if your testing system is Jenkins
based you can use it to simplify things.  You will still need an account to do
this as described in the <a class="reference internal" href="#request-account-label"><em>Creating a Service Account</em></a> section above.</p>
<p>The Gerrit Trigger plugin for Jenkins can be found on <a class="reference external" href="http://repo.jenkins-ci.org/repo/com/sonyericsson/hudson/plugins/gerrit/gerrit-trigger/">the Jenkins
repository</a>.  You can install it using the Advanced tab in the
Jenkins Plugin Manager.</p>
<p>Once installed Jenkins will have a new <cite>Gerrit Trigger</cite> option in the <cite>Manage
Jenkins</cite> menu.  This should be given the following options:</p>
<div class="highlight-python"><pre>Hostname: review.openstack.org
Frontend URL: https://review.openstack.org/
SSH Port: 29418
Username: (the Gerrit user)
SSH Key File: (path to the user SSH key)

Verify
------
Started: 0
Successful: 1
Failed: -1
Unstable: 0

Code Review
-----------
Started: 0
Successful: 0
Failed: 0
Unstable: 0

(under Advanced Button):

Stated: (blank)
Successful: gerrit approve &lt;CHANGE&gt;,&lt;PATCHSET&gt; --message 'Build Successful &lt;BUILDS_STATS&gt;' --verified &lt;VERIFIED&gt; --code-review &lt;CODE_REVIEW&gt;
Failed: gerrit approve &lt;CHANGE&gt;,&lt;PATCHSET&gt; --message 'Build Failed &lt;BUILDS_STATS&gt;' --verified &lt;VERIFIED&gt; --code-review &lt;CODE_REVIEW&gt;
Unstable: gerrit approve &lt;CHANGE&gt;,&lt;PATCHSET&gt; --message 'Build Unstable &lt;BUILDS_STATS&gt;' --verified &lt;VERIFIED&gt; --code-review &lt;CODE_REVIEW&gt;</pre>
</div>
<p>Note that it is useful to include something in the messages about what testing
system is supplying these messages.</p>
<p>When creating jobs in Jenkins you will have the option to add triggers.  You
should configure as follows:</p>
<div class="highlight-python"><pre>Trigger on Patchset Uploaded: ticked
(the rest unticked)

Type: Plain
Pattern: openstack/project-name (where project-name is the name of the project)
Branches:
  Type: Path
  Pattern: **</pre>
</div>
<p>To format the result&#8217;s message in a way that works with the current OpenStack
Gerrit GUI parser, configure the <tt class="docutils literal"><span class="pre">URL</span> <span class="pre">to</span> <span class="pre">post</span></tt> parameter (under the
<tt class="docutils literal"><span class="pre">Gerrit</span> <span class="pre">Reporting</span> <span class="pre">Values</span></tt> section) for each job. The correct value for this
paramater is:</p>
<blockquote>
<div>* $JOB_NAME $BUILD_URL</div></blockquote>
<p>The two <tt class="docutils literal"><span class="pre">$ENV_VAR</span></tt> will be replaced dynamically when the <tt class="docutils literal"><span class="pre">&lt;BUILDS_STATS&gt;</span></tt>
parameter will be evaluated.</p>
<p>This job will now automatically trigger when a new patchset is
uploaded and will report the results to Gerrit automatically.</p>
</div>
<div class="section" id="the-zuul-gerrit-trigger-way">
<h2>The Zuul Gerrit Trigger Way<a class="headerlink" href="#the-zuul-gerrit-trigger-way" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://docs.openstack.org/infra/system-config/zuul.html">Zuul</a> is a tool that determines what jobs are run when.
Zuul listens to the Gerrit event stream, and first tries to match each event to one or more pipelines.
Zuul’s pipelines are configured in a single file called layout.yaml.
Here’s a snippet from that file that constructs the <tt class="docutils literal"><span class="pre">check</span></tt> pipeline taken from this
<a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/zuul/tree/etc/layout.yaml-sample">Zuul sample layout.yaml file</a></p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">pipelines</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">check</span>
    <span class="l l-Scalar l-Scalar-Plain">manager</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">IndependentPipelineManager</span>
    <span class="l l-Scalar l-Scalar-Plain">trigger</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">gerrit</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">event</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">patchset-created</span>
    <span class="l l-Scalar l-Scalar-Plain">success</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">gerrit</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">verified</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">failure</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">gerrit</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">verified</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-1</span>
    <span class="l l-Scalar l-Scalar-Plain">merge-failure</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">smtp</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">third_party_ci@example.com</span>
        <span class="l l-Scalar l-Scalar-Plain">from</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">zuul@example.com</span>
        <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Upstream change {change} has a merge failure</span>
</pre></div>
</div>
<p>This pipeline is configured to trigger on any Gerrit event that represents a new
patch set created. The matching event will invoke the configured Jenkins job(s)
(discussed next). If all the Jenkins jobs are successful, Zuul will add a comment
to Gerrit with a <tt class="docutils literal"><span class="pre">verified</span> <span class="pre">+1</span></tt> vote, and if any one fails, with a <tt class="docutils literal"><span class="pre">verified</span> <span class="pre">-1</span></tt>.
In case of merge failure Third Party CI should not comment, but check merger-debug.log
and recheck the patch manually if needed.
Email will be sent to notify the owner about the issue.</p>
<p>The sample includes other possible configurations, or you can configure your own by
following the <a class="reference external" href="http://docs.openstack.org/infra/zuul/zuul.html#layout-yaml">Zuul layout documentation</a></p>
<p>After a Gerrit event matches a pipeline, Zuul will look at the project identified
in that Gerrit event and invoke the Jenkins jobs specified in the <tt class="docutils literal"><span class="pre">projects</span></tt> section
(for the matching pipeline) using the <a class="reference external" href="https://wiki.jenkins-ci.org/display/JENKINS/Gearman+Plugin">Jenkins Gearman Plugin</a>.</p>
<p>For example:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">projects</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openstack-dev/ci-sandbox</span>
    <span class="l l-Scalar l-Scalar-Plain">check</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my-sandbox-check</span>
    <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my-sandbox-test</span>
</pre></div>
</div>
<p>In this case, any Gerrit event generated from the <tt class="docutils literal"><span class="pre">openstack-dev/ci-sandbox</span></tt> project, that matched
the <tt class="docutils literal"><span class="pre">check</span></tt> pipeline would run the <tt class="docutils literal"><span class="pre">my-sandbox-check</span></tt> job in Jenkins. If the
Gerrit event also matched the <tt class="docutils literal"><span class="pre">test</span></tt> pipeline, Zuul would also invoke the <tt class="docutils literal"><span class="pre">my-sandbox-test</span></tt>
Jenkins job.</p>
<p>The <a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/zuul/layout.yaml">layout.yaml</a>
used by OpenStack is a good reference for real world pipeline definitions,
and project-pipeline-job definitions.</p>
<p>The following documentation explains how to setup a 3rd party CI system using this approach.
<a class="reference external" href="http://docs.openstack.org/infra/openstackci/">OpenStack Third-Party CI</a></p>
</div>
<div class="section" id="managing-jenkins-jobs">
<h2>Managing Jenkins Jobs<a class="headerlink" href="#managing-jenkins-jobs" title="Permalink to this headline">¶</a></h2>
<p>When code is pushed to Gerrit, a series of jobs are triggered that run a series
of tests against the proposed code. Jenkins
is the server that executes and
manages these jobs. It is a Java application with an extensible architecture
that supports plugins that add functionality to the base server.</p>
<p>Each job in Jenkins is configured separately. Behind the scenes, Jenkins stores
this configuration information in an XML file in its data directory.
You may manually edit a Jenkins job as an administrator in Jenkins. However,
in a testing platform as large as the upstream OpenStack CI system,
doing so manually would be virtually impossible and fraught with errors.
Luckily, there is a helper tool called <a class="reference external" href="http://docs.openstack.org/infra/jenkins-job-builder/">Jenkins Job Builder (JJB)</a> that
constructs and manages these XML configuration files after reading a
set of YAML files and job templating rules. These references provide more details:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.openstack.org/infra/system-config/jjb.html">A basic overview of using JJB to define projects, templates, and jobs in yaml
format is available here.</a></li>
<li><a class="reference external" href="http://docs.openstack.org/infra/jenkins-job-builder/definition.html">The official documentation to define Jenkins jobs using JJB is here.</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/jenkins/jobs">The JJB description of all jobs used by OpenStack are defined in this folder.</a>
(The projects.yaml file is a good starting point)</li>
</ul>
</div>
<div class="section" id="testing-your-ci-setup">
<h2>Testing your CI setup<a class="headerlink" href="#testing-your-ci-setup" title="Permalink to this headline">¶</a></h2>
<p>You can use the <tt class="docutils literal"><span class="pre">openstack-dev/ci-sandbox</span></tt> project to test your external CI
infrastructure with OpenStack&#8217;s Gerrit. By using the sandbox project you
can test your CI system without affecting regular OpenStack reviews.</p>
<p>Once you confirm your CI system works as you expect, change your
configuration of the gerrit trigger plugin or zuul to subscribe to gerrit
events from your target project.</p>
</div>
<div class="section" id="permissions-on-your-third-party-system">
<h2>Permissions on your Third Party System<a class="headerlink" href="#permissions-on-your-third-party-system" title="Permalink to this headline">¶</a></h2>
<p>When you create your CI account it will have no special permissions.
This means it can comment on changes but generally not vote +/-1
Verified on any changes. The exception to this is on the
<tt class="docutils literal"><span class="pre">openstack-dev/ci-sandbox</span></tt> project. Any account is able to vote +/-1
Verified on that account and it provides a way to test your CI&#8217;s voting
abilities before you vote on other projects.</p>
<p>The OpenStack Infrastructure team disables mis-behaving third-party ci
accounts at its discretion. This documentation endeavours to outline specific
circumstances that may lead to an account being disabled. There have been
times when third-party ci systems behave in ways we didn&#8217;t envision
and therefore were unable to document prior to the event. If your
third-party ci system has been disabled, check the archives of the
<a class="reference external" href="http://lists.openstack.org/cgi-bin/mailman/listinfo/third-party-announce">third-party-announce</a>
mailing list to which you hopefully are subscribed. The email that notifies
this list that your account has been disabled will include instructions for
getting your system re-enabled. You are also welcome to join us in the
#openstack-infra irc channel on freenode to discuss your situation.</p>
<p>In order to get your Third Pary CI account to have voting permissions on
repos in gerrit in addition to <tt class="docutils literal"><span class="pre">openstack-dev/ci-sandbox</span></tt> you have a greater
chance of success if you follow these steps:</p>
<ul>
<li><p class="first">Set up your system and test it according to &#8220;Testing your CI setup&#8221; outlined
above (this will create a history of activity associated with your account
which will be evaluated when you apply for voting permissions).</p>
</li>
<li><p class="first">Post comments, that adhere to the &#8220;Requirements&#8221; listed above, that
demonstrate the format for your system communication to the repos
you want your system to test.</p>
</li>
<li><p class="first">Once your Third Party Account has a history on gerrit so that others
can evaluate your format for comments, and the stability of your
voting pattern (in the sandbox repo):</p>
<ul>
<li><p class="first">send an email to the openstack-dev mailing list nominating your
system for voting permissions</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="mailto:openstack-dev&#37;&#52;&#48;lists&#46;openstack&#46;org">openstack-dev<span>&#64;</span>lists<span>&#46;</span>openstack<span>&#46;</span>org</a></li>
<li>use tags [Infra][Nova] for the Nova program, please replace
[Nova] with [Program], where [Program] is the name of the
program your CI account will test</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">present your account history</p>
</li>
<li><p class="first">address any questions and concerns with your system</p>
</li>
</ul>
</li>
<li><p class="first">If the members of the program you want voting permissions from agree
your system should be able to vote, the release group for that program
or project can add you to the &lt;project&gt;-ci group specific to that
program/project.</p>
</li>
</ul>
</div>
<div class="section" id="faq-frequently-asked-questions">
<h2>FAQ (Frequently Asked Questions)<a class="headerlink" href="#faq-frequently-asked-questions" title="Permalink to this headline">¶</a></h2>
<ul>
<li><dl class="first docutils">
<dt>Q: How do you serve the content of compressed logs so they are rendered within</dt>
<dd><p class="first last">the browser, rather than presenting a download prompt to the user?</p>
</dd>
</dl>
<p>A: Add the following lines to your web server conf file:</p>
<div class="highlight-python"><pre>RewriteEngine On
RewriteCond   %{HTTP:Accept-Encoding} gzip
RewriteCond   %{LA-U:REQUEST_FILENAME}.gz -f
RewriteRule   ^(.+)$ $1.gz [L]
&lt;FilesMatch ".*\.gz$"&gt;
  ForceType text/html
  AddDefaultCharset UTF-8
  AddEncoding x-gzip gz
&lt;/FilesMatch&gt;</pre>
</div>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Third Party Testing</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#reading-the-event-stream">Reading the Event Stream</a></li>
<li><a class="reference internal" href="#posting-result-to-gerrit">Posting Result To Gerrit</a></li>
<li><a class="reference internal" href="#creating-a-service-account">Creating a Service Account</a></li>
<li><a class="reference internal" href="#the-jenkins-gerrit-trigger-plugin-way">The Jenkins Gerrit Trigger Plugin Way</a></li>
<li><a class="reference internal" href="#the-zuul-gerrit-trigger-way">The Zuul Gerrit Trigger Way</a></li>
<li><a class="reference internal" href="#managing-jenkins-jobs">Managing Jenkins Jobs</a></li>
<li><a class="reference internal" href="#testing-your-ci-setup">Testing your CI setup</a></li>
<li><a class="reference internal" href="#permissions-on-your-third-party-system">Permissions on your Third Party System</a></li>
<li><a class="reference internal" href="#faq-frequently-asked-questions">FAQ (Frequently Asked Questions)</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="stackforge.html"
                                  title="previous chapter">StackForge</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="contribute-cloud.html"
                                  title="next chapter">Contributing Cloud Test Resources</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack-infra/system-config
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/third_party.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="contribute-cloud.html" title="Contributing Cloud Test Resources"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="stackforge.html" title="StackForge"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack Project Infrastructure 0.0.1.dev12076 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, OpenStack Infastructure Team - see the <a href="https://git.openstack.org/cgit/openstack-infra/system-config/">system-config git repo</a> for details.
      Last updated on Mon Feb 13 23:40:08 2017, commit 91bca8d.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/OpenStack Project Infrastructure");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>