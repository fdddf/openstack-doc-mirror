
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nodepool &mdash; OpenStack Project Infrastructure 0.0.1.dev12076 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1.dev12076',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack Project Infrastructure 0.0.1.dev12076 documentation" href="index.html" />
    <link rel="up" title="Major Systems" href="systems.html" />
    <link rel="next" title="Jeepyb" href="jeepyb.html" />
    <link rel="prev" title="Devstack Gate" href="devstack-gate.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
<li><a href="index.html" title="Go to the Home page" class="link">Home</a></li>
<li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
<li><a href="http://review.openstack.org/" title="Go to the OpenStack Gerrit server">Gerrit</a></li>
<li><a href="http://jenkins.openstack.org/" title="Go to the OpenStack Jenkins server">Jenkins</a></li>
<li><a href="http://logstash.openstack.org/" title="Go to the OpenStack Logstash server">Logstash</a></li>
<li><a href="http://etherpad.openstack.org/" title="Go to the OpenStack Etherpad server">Etherpad</a></li>
<li><a href="http://paste.openstack.org/" title="Go to the OpenStack Paste server">Paste</a></li>
<li><a href="http://planet.openstack.org/" title="Go to the OpenStack Planet server">Planet</a></li>
<li><a href="http://lists.openstack.org/" title="Go to the OpenStack Mailman server">Mailman</a></li>

    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="nodepool">
<span id="id1"></span><h1>Nodepool<a class="headerlink" href="#nodepool" title="Permalink to this headline">¶</a></h1>
<p>Nodepool is a service used by the OpenStack CI team to deploy and manage a pool
of devstack images on a cloud server for use in OpenStack project testing.</p>
<div class="section" id="at-a-glance">
<h2>At a Glance<a class="headerlink" href="#at-a-glance" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Hosts:</th><td class="field-body"><ul class="first simple">
<li>nodepool.openstack.org</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Puppet:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/puppet-openstackci/tree/manifests/nodepool.pp">https://git.openstack.org/cgit/openstack-infra/puppet-openstackci/tree/manifests/nodepool.pp</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/manifests/single_use_slave.pp">system-config: modules/openstack_project/manifests/single_use_slave.pp</a></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Configuration:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/nodepool/nodepool.yaml">project-config: nodepool/nodepool.yaml</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/nodepool/scripts/">project-config: nodepool/scripts/</a></li>
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/project-config/tree/nodepool/elements/">project-config: nodepool/elements/</a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Projects:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/nodepool">https://git.openstack.org/cgit/openstack-infra/nodepool</a></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Bugs:</th><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="https://storyboard.openstack.org/#!/project/668">https://storyboard.openstack.org/#!/project/668</a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Resources:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://docs.openstack.org/infra/nodepool">Nodepool Reference Manual</a></li>
<li><a class="reference external" href="https://zookeeper.apache.org/doc/trunk/zookeeperProgrammers.html">ZooKeeper Programmer&#8217;s Guide</a></li>
<li><a class="reference external" href="https://zookeeper.apache.org/doc/trunk/zookeeperAdmin.html">ZooKeeper Administrator&#8217;s Guide</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/zk_shell/">zk_shell</a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Once per day, for every image type (and provider) configured by
nodepool, a new image with cached data is built for use by devstack.
Nodepool spins up new instances and tears down old as tests are queued
up and completed, always maintaining a consistent number of available
instances for tests up to the set limits of the CI infrastructure.</p>
</div>
<div class="section" id="zookeeper">
<h2>Zookeeper<a class="headerlink" href="#zookeeper" title="Permalink to this headline">¶</a></h2>
<p>Nodepool stores image metadata in ZooKeeper.  We have a one-node
ZooKeeper &#8220;cluster&#8221; running on nodepool.openstack.org.</p>
<p>The Nodepool CLI should be sufficient to examine and alter any of the
information stored in ZooKeeper.  However, in case advanced debugging
is needed, use of zk-shell (&#8220;pip install zk_shell&#8221; into a virtualenv
and run &#8220;zk-shell&#8221;) is recommended as an easy way to inspect and/or
change data in ZooKeeper.</p>
</div>
<div class="section" id="bad-images">
<h2>Bad Images<a class="headerlink" href="#bad-images" title="Permalink to this headline">¶</a></h2>
<p>Since nodepool takes a while to build images, and generally only does
it once per day, occasionally the images it produces may have
significant behavior changes from the previous versions.  For
instance, a provider&#8217;s base image or operating system package may
update, or some of the scripts or system configuration that we apply
to the images may change.  If this occurs, it is easy to revert to the
last good image.</p>
<p>Nodepool periodically deletes old images, however, it never deletes
the current or next most recent image in the <tt class="docutils literal"><span class="pre">ready</span></tt> state for any
image-provider combination.  So if you find that the
<tt class="docutils literal"><span class="pre">ubuntu-precise</span></tt> image is problematic, you can run:</p>
<div class="highlight-python"><pre>$ sudo nodepool dib-image-list

+---------------------------+----------------+---------+-----------+----------+-------------+
| ID                        | Image          | Builder | Formats   | State    | Age         |
+---------------------------+----------------+---------+-----------+----------+-------------+
| ubuntu-precise-0000000001 | ubuntu-precise | nb01    | qcow2,vhd | ready    | 02:00:57:33 |
| ubuntu-precise-0000000002 | ubuntu-precise | nb01    | qcow2,vhd | ready    | 01:00:57:33 |
+---------------------------+----------------+---------+-----------+----------+-------------+</pre>
</div>
<p>Image ubuntu-precise-0000000001 is the previous image and
ubuntu-precise-0000000002 is the current image (they are both marked
as <tt class="docutils literal"><span class="pre">ready</span></tt> and the current image is simply the image with the
shortest age.</p>
<p>Nodepool aggressively attempts to build and upload missing images, so
if the problem with the image will not be solved with an immediate
rebuild, image builds must first be disabled for that image.  To do
so, add <tt class="docutils literal"><span class="pre">paused:</span> <span class="pre">True</span></tt> to the <tt class="docutils literal"><span class="pre">diskimage</span></tt> section for
<tt class="docutils literal"><span class="pre">ubuntu-precise</span></tt> in nodepool.yaml.</p>
<p>Then delete the problematic image with:</p>
<div class="highlight-python"><pre>$ sudo nodepool dib-image-delete ubuntu-precise-0000000002</pre>
</div>
<p>All uploads corresponding to that image build will be deleted from providers
before the image DIB files are deleted. The previous image will become the
current image and nodepool will use it when creating new nodes. When nodepool
next creates an image, it will still retain build #1 since it will still be
considered the next-most-recent image.</p>
</div>
<div class="section" id="vhd-util">
<h2>vhd-util<a class="headerlink" href="#vhd-util" title="Permalink to this headline">¶</a></h2>
<p>Creating images for Rackspace requires a patched version of vhd-util to convert
the images into the appropriate VHD format. A package is manaually managed
at <cite>ppa:openstack-ci-core/vhd-util</cite> and is based on a git repo at
<a class="reference external" href="https://github.com/emonty/vhd-util">https://github.com/emonty/vhd-util</a></p>
<div class="section" id="updating-vhd-util">
<h3>Updating vhd-util<a class="headerlink" href="#updating-vhd-util" title="Permalink to this headline">¶</a></h3>
<p>Should it become required to update vhd-util before Infra has a proper
packaging repo or solution in place, one should clone from the git repo:</p>
<div class="highlight-python"><pre>$ git clone git://github.com/emonty/vhd-util
$ cd vhd-util</pre>
</div>
<p>Then perform whatever updates and packaging work are needed. The repo is
formatted as a git-buildpackage repo with <cite>&#8211;pristine-tar</cite>. When you&#8217;re ready
to upload a new verion, commit, create a source package and a tag:</p>
<div class="highlight-python"><pre>$ git-buildpackage --git-tag --git-sign-tags -S</pre>
</div>
<p>This will make a source package in the parent directory. Upload it to
launchpad:</p>
<div class="highlight-python"><pre>$ cd ..
$ dput ppa:openstack-ci-core/vhd-util vhd-util_$version_source.changes</pre>
</div>
<p>Then probably pushing the repo to github and submitting a pull request so that
we can keep up with the change is not a terrible idea.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Nodepool</a><ul>
<li><a class="reference internal" href="#at-a-glance">At a Glance</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#zookeeper">Zookeeper</a></li>
<li><a class="reference internal" href="#bad-images">Bad Images</a></li>
<li><a class="reference internal" href="#vhd-util">vhd-util</a><ul>
<li><a class="reference internal" href="#updating-vhd-util">Updating vhd-util</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="devstack-gate.html"
                                  title="previous chapter">Devstack Gate</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="jeepyb.html"
                                  title="next chapter">Jeepyb</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack-infra/system-config
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/nodepool.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="jeepyb.html" title="Jeepyb"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="devstack-gate.html" title="Devstack Gate"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack Project Infrastructure 0.0.1.dev12076 documentation</a> &raquo;</li>
          <li><a href="systems.html" accesskey="U">Major Systems</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, OpenStack Infastructure Team - see the <a href="https://git.openstack.org/cgit/openstack-infra/system-config/">system-config git repo</a> for details.
      Last updated on Mon Feb 13 23:40:08 2017, commit 91bca8d.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/OpenStack Project Infrastructure");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>