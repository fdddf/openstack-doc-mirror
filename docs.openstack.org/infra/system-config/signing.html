
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Signing System &mdash; OpenStack Project Infrastructure 0.0.1.dev12076 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/tweaks.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1.dev12076',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="OpenStack Project Infrastructure 0.0.1.dev12076 documentation" href="index.html" />
    <link rel="up" title="Major Systems" href="systems.html" />
    <link rel="next" title="Firehose" href="firehose.html" />
    <link rel="prev" title="Code Search" href="codesearch.html" /> 
  </head>
  <body>
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
<li><a href="index.html" title="Go to the Home page" class="link">Home</a></li>
<li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
<li><a href="http://review.openstack.org/" title="Go to the OpenStack Gerrit server">Gerrit</a></li>
<li><a href="http://jenkins.openstack.org/" title="Go to the OpenStack Jenkins server">Jenkins</a></li>
<li><a href="http://logstash.openstack.org/" title="Go to the OpenStack Logstash server">Logstash</a></li>
<li><a href="http://etherpad.openstack.org/" title="Go to the OpenStack Etherpad server">Etherpad</a></li>
<li><a href="http://paste.openstack.org/" title="Go to the OpenStack Paste server">Paste</a></li>
<li><a href="http://planet.openstack.org/" title="Go to the OpenStack Planet server">Planet</a></li>
<li><a href="http://lists.openstack.org/" title="Go to the OpenStack Mailman server">Mailman</a></li>

    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="signing-system">
<span id="signing"></span><h1>Signing System<a class="headerlink" href="#signing-system" title="Permalink to this headline">¶</a></h1>
<p>This machine corresponds to the <tt class="docutils literal"><span class="pre">signing</span></tt> node label in job
configuration, holding an unencrypted copy of the OpenPGP signing
subkey for <tt class="docutils literal"><span class="pre">OpenStack</span> <span class="pre">Infra</span> <span class="pre">(Some</span> <span class="pre">Cycle)</span>
<span class="pre">&lt;infra-root&#64;openstack.org&gt;</span></tt> used to create detached signatures for
release artifacts (tarballs, wheels, et cetera) and to sign and push
Git tags as part of our managed release automation. It only runs CI
jobs for tasks which require access to this key, using only vetted
tools and scripts reviewed by the Infra team.</p>
<div class="section" id="at-a-glance">
<h2>At a Glance<a class="headerlink" href="#at-a-glance" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Hosts:</th><td class="field-body"><ul class="first simple">
<li>signing*.ci.openstack.org</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Puppet:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="https://git.openstack.org/cgit/openstack-infra/system-config/tree/modules/openstack_project/manifests/signing_node.pp">system-config: modules/openstack_project/manifests/signing_node.pp</a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="key-management-overview">
<h2>Key Management Overview<a class="headerlink" href="#key-management-overview" title="Permalink to this headline">¶</a></h2>
<p>The signing server is a fairly typical long-lived job node,
distinguished primarily by having the signing subkey pair installed
by Puppet into the job runner account&#8217;s home directory from binary
blobs in hiera. These blobs correspond to the
<tt class="docutils literal"><span class="pre">~/.gnupg/pubring.gpg</span></tt> and <tt class="docutils literal"><span class="pre">~/.gnupg/secring.gpg</span></tt> files of a
freshly initialized gpg config after importing a minimal unencrypted
export on the management bastion of only the desired signing subkey
from the <tt class="docutils literal"><span class="pre">/root/signing.gunpg</span></tt> directory.</p>
<div class="section" id="storage">
<h3>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">¶</a></h3>
<p>While the signing subkey is present unencrypted on this system, the
corresponding master key is kept symmetrically encrypted in the root
home directory of the Infra systems management bastion instead. At
the time of key creation a revocation certificate is also generated,
for which Infra root sysadmins are encouraged to retrieve and keep
local copies in case control over or access to the original master
key is lost. In the future, the master key and revocation
certificate may be distributed across our root team rather than kept
in one place (for example using Shamir&#8217;s secret sharing scheme
similar to what <cite>the Debian Project does for its archive keys
&lt;https://ftp-master.debian.org/keys.html&gt;</cite>).</p>
</div>
<div class="section" id="rotation">
<h3>Rotation<a class="headerlink" href="#rotation" title="Permalink to this headline">¶</a></h3>
<p>The master key is rotated at the start of each development cycle,
signed by a majority of Infra root sysadmins before being put into
service, and has an expiration date set for shortly after the end of
the targeted development cycle. As each new key is created and
brought into rotation, an announcement should be signed by both the
old and new keys and sent to the
<a class="reference external" href="mailto:openstack-announce&#37;&#52;&#48;lists&#46;openstack&#46;org">openstack-announce<span>&#64;</span>lists<span>&#46;</span>openstack<span>&#46;</span>org</a> mailing list. The new key
should also be signed by the old, and this signature pushed to the
public keyserver network. New key fingerprints are also submitted to
the openstack/releases repository, for publication on the
releases.openstack.org Web site.</p>
</div>
<div class="section" id="revocation">
<h3>Revocation<a class="headerlink" href="#revocation" title="Permalink to this headline">¶</a></h3>
<p>Under normal circumstances, keys should be allowed to expire
gracefully. If the key is compromised but still accessible, a
revocation certificate can be generated and published to the key
network at that time. If access to the private key is lost
completely, the revocation certificate generated at key creation
time should be used as a last resort.</p>
</div>
</div>
<div class="section" id="key-management-process">
<h2>Key Management Process<a class="headerlink" href="#key-management-process" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>This is the content of the <tt class="docutils literal"><span class="pre">/root/signing.gnupg/gpg.conf</span></tt> file on
our management bastion host:</p>
<div class="highlight-python"><pre># A basic gpg.conf using secure keyserver transport and some more
# verbose display options. This configuration assumes you have
# installed both the gnupg and gnupg-curl packages. Set your umask
# to 077, create a /root/signing.gnupg directory and place this
# configuration file in it.
#
# Retrieve and validate the HKPS key for the SKS keyservers this way:
#
#     wget -P ~/signing.gnupg/ \
#         https://sks-keyservers.net/sks-keyservers.netCA.pem{,.asc}
#     gpg --homedir signing.gnupg --recv-key \
#         0x94CBAFDD30345109561835AA0B7F8B60E3EDFAE3
#     gpg --homedir signing.gnupg --verify \
#         ~/signing.gnupg/sks-keyservers.netCA.pem{.asc,}

# Receive, send and search for keys in the SKS keyservers pool using
# HKPS (OpenPGP HTTP Keyserver Protocol via TLS/SSL).
keyserver hkps://hkps.pool.sks-keyservers.net

# Set the path to the public certificate for the
# sks-keyservers.net CA used to verify connections to servers in
# the pool above.
keyserver-options ca-cert-file=/root/signing.gnupg/sks-keyservers.netCA.pem

# Ignore keyserver URLs specified in retrieved/refreshed keys
# so they don't direct you to update from non-HKPS sources.
keyserver-options no-honor-keyserver-url

# Display key IDs in a more accurate 16-digit hexidecimal format
# and add 0x at the beginning for clarity.
keyid-format 0xlong

# Display the calculated validity of user IDs when listing keys or
# showing signatures.
list-options show-uid-validity
verify-options show-uid-validity</pre>
</div>
</div>
<div class="section" id="generation">
<h3>Generation<a class="headerlink" href="#generation" title="Permalink to this headline">¶</a></h3>
<p>Key generation should happen reasonably far in advance of expiration
of the old key (at least a month), so as to provide ample time for a
majority of our root sysadmins to attest to the key and provide
warning to the rest of the community of the upcoming transition. Of
course, if this is being done to replace a revoked key, this
timeline should be accelerated as much as possible to provide
continuity of service so use your best judgement on a balance of
sufficient attestation and warning (same-day turnaround is
preferred).</p>
<p>Make sure we start with a restrictive umask so that files and
directories we write from this point forward are only accessible by
the root user:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> <span class="nb">umask</span> <span class="m">077</span>
</pre></div>
</div>
<p>Now create a master key for the coming development cycle, taking
mostly the GnuPG recommended default values. Set a validity period
sufficient to last through the release process at the conclusion of
the cycle. Use a sufficiently long, randomly-generated passphrase
string (it&#8217;s fine to reuse the one stored in our passwords list for
earlier keys unless we know it to have been compromised):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir signing.gnupg --gen-key
<span class="go">gpg (GnuPG) 1.4.16; Copyright (C) 2013 Free Software Foundation, Inc.</span>
<span class="go">This is free software: you are free to change and redistribute it.</span>
<span class="go">There is NO WARRANTY, to the extent permitted by law.</span>

<span class="go">Please select what kind of key you want:</span>
<span class="go">   (1) RSA and RSA (default)</span>
<span class="go">   (2) DSA and Elgamal</span>
<span class="go">   (3) DSA (sign only)</span>
<span class="go">   (4) RSA (sign only)</span>
<span class="go">Your selection?</span>
<span class="go">RSA keys may be between 1024 and 4096 bits long.</span>
<span class="go">What keysize do you want? (2048)</span>
<span class="go">Requested keysize is 2048 bits</span>
<span class="go">Please specify how long the key should be valid.</span>
<span class="go">         0 = key does not expire</span>
<span class="go">      &lt;n&gt;  = key expires in n days</span>
<span class="go">      &lt;n&gt;w = key expires in n weeks</span>
<span class="go">      &lt;n&gt;m = key expires in n months</span>
<span class="go">      &lt;n&gt;y = key expires in n years</span>
<span class="go">Key is valid for? (0) 7m</span>
<span class="go">Key expires at Thu 02 Feb 2017 08:41:39 PM UTC</span>
<span class="go">Is this correct? (y/N) y</span>

<span class="go">You need a user ID to identify your key; the software constructs the user ID</span>
<span class="go">from the Real Name, Comment and Email Address in this form:</span>
<span class="go">    &quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;</span>

<span class="go">Real name: OpenStack Infra</span>
<span class="go">Email address: infra-root@openstack.org</span>
<span class="go">Comment: Some Cycle</span>
<span class="go">You selected this USER-ID:</span>
<span class="go">    &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot;</span>

<span class="go">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o</span>
<span class="go">You need a Passphrase to protect your secret key.</span>

<span class="go">Enter passphrase: ********************************</span>
<span class="go">Repeat passphrase: ********************************</span>

<span class="go">We need to generate a lot of random bytes. It is a good idea to perform</span>
<span class="go">some other action (type on the keyboard, move the mouse, utilize the</span>
<span class="go">disks) during the prime generation; this gives the random number</span>
<span class="go">generator a better chance to gain enough entropy.</span>
<span class="go">.+++++</span>
<span class="go">......+++++</span>
<span class="go">We need to generate a lot of random bytes. It is a good idea to perform</span>
<span class="go">some other action (type on the keyboard, move the mouse, utilize the</span>
<span class="go">disks) during the prime generation; this gives the random number</span>
<span class="go">generator a better chance to gain enough entropy.</span>
<span class="go">.+++++</span>
<span class="go">+++++</span>
<span class="go">gpg: key 0x120D3C23C6D5584D marked as ultimately trusted</span>
<span class="go">public and secret key created and signed.</span>

<span class="go">gpg: checking the trustdb</span>
<span class="go">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</span>
<span class="go">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</span>
<span class="go">gpg: next trustdb check due at 2017-02-02</span>
<span class="go">pub   2048R/0x120D3C23C6D5584D 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">      Key fingerprint = 7222 E5A0 5730 B767 0F93  035A 120D 3C23 C6D5 584D</span>
<span class="go">uid                 [ultimate] OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>
<span class="go">sub   2048R/0x1F215B56867C5D9A 2016-07-07 [expires: 2017-02-02]</span>
</pre></div>
</div>
<p>Create a revocation certificate for the master key, for use in the
case extreme case that this master key itself becomes inaccessible,
for example because the decryption passphrase is lost (under any
other circumstances, a revocation certificate with a more detailed
description can be generated using the master key on an as-needed
basis):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir signing.gnupg --output <span class="se">\</span>
&gt; signing.gnupg/revoke.asc --gen-revoke 0x120D3C23C6D5584D
<span class="go">sec  2048R/0x120D3C23C6D5584D 2016-07-07 OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>

<span class="go">Create a revocation certificate for this key? (y/N) y</span>
<span class="go">Please select the reason for the revocation:</span>
<span class="go">  0 = No reason specified</span>
<span class="go">  1 = Key has been compromised</span>
<span class="go">  2 = Key is superseded</span>
<span class="go">  3 = Key is no longer used</span>
<span class="go">  Q = Cancel</span>
<span class="go">(Probably you want to select 1 here)</span>
<span class="go">Your decision? 1</span>
<span class="go">Enter an optional description; end it with an empty line:</span>
<span class="gp">&gt;</span> This revocation is to be used in the event the key cannot be recovered.
<span class="gp">&gt;</span>
<span class="go">Reason for revocation: Key has been compromised</span>
<span class="go">This revocation is to be used in the event the key cannot be recovered.</span>
<span class="go">Is this okay? (y/N) y</span>

<span class="go">You need a passphrase to unlock the secret key for</span>
<span class="go">user: &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot;</span>
<span class="go">2048-bit RSA key, ID 0x120D3C23C6D5584D, created 2016-07-07</span>

<span class="go">Enter passphrase: ********************************</span>

<span class="go">ASCII armored output forced.</span>
<span class="go">Revocation certificate created.</span>

<span class="go">Please move it to a medium which you can hide away; if Mallory gets</span>
<span class="go">access to this certificate he can use it to make your key unusable.</span>
<span class="go">It is smart to print this certificate and store it away, just in case</span>
<span class="go">your media become unreadable.  But have some caution:  The print system of</span>
<span class="go">your machine might store the data and make it available to others!</span>
</pre></div>
</div>
<p>Use the interactive key editor to add a subkey constrained to
signing purposes only. It does not need an expiration since it will
be valid only for as long as its associated master key is valid:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir signing.gnupg --edit-key 0x120D3C23C6D5584D
<span class="go">gpg (GnuPG) 1.4.16; Copyright (C) 2013 Free Software Foundation, Inc.</span>
<span class="go">This is free software: you are free to change and redistribute it.</span>
<span class="go">There is NO WARRANTY, to the extent permitted by law.</span>

<span class="go">Secret key is available.</span>

<span class="go">pub  2048R/0x120D3C23C6D5584D  created: 2016-07-07  expires: 2017-02-02  usage: SC</span>
<span class="go">                               trust: ultimate      validity: ultimate</span>
<span class="go">sub  2048R/0x1F215B56867C5D9A  created: 2016-07-07  expires: 2017-02-02  usage: E</span>
<span class="go">[ultimate] (1). OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>

<span class="go">gpg&gt; addkey</span>
<span class="go">Key is protected.</span>

<span class="go">You need a passphrase to unlock the secret key for</span>
<span class="go">user: &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot;</span>
<span class="go">2048-bit RSA key, ID 0x120D3C23C6D5584D, created 2016-07-07</span>

<span class="go">Enter passphrase: ********************************</span>

<span class="go">Please select what kind of key you want:</span>
<span class="go">   (3) DSA (sign only)</span>
<span class="go">   (4) RSA (sign only)</span>
<span class="go">   (5) Elgamal (encrypt only)</span>
<span class="go">   (6) RSA (encrypt only)</span>
<span class="go">Your selection? 4</span>
<span class="go">RSA keys may be between 1024 and 4096 bits long.</span>
<span class="go">What keysize do you want? (2048)</span>
<span class="go">Requested keysize is 2048 bits</span>
<span class="go">Please specify how long the key should be valid.</span>
<span class="go">         0 = key does not expire</span>
<span class="go">      &lt;n&gt;  = key expires in n days</span>
<span class="go">      &lt;n&gt;w = key expires in n weeks</span>
<span class="go">      &lt;n&gt;m = key expires in n months</span>
<span class="go">      &lt;n&gt;y = key expires in n years</span>
<span class="go">Key is valid for? (0)</span>
<span class="go">Key does not expire at all</span>
<span class="go">Is this correct? (y/N) y</span>
<span class="go">Really create? (y/N) y</span>
<span class="go">We need to generate a lot of random bytes. It is a good idea to perform</span>
<span class="go">some other action (type on the keyboard, move the mouse, utilize the</span>
<span class="go">disks) during the prime generation; this gives the random number</span>
<span class="go">generator a better chance to gain enough entropy.</span>
<span class="go">+++++</span>
<span class="go">........+++++</span>

<span class="go">pub  2048R/0x120D3C23C6D5584D  created: 2016-07-07  expires: 2017-02-02  usage: SC</span>
<span class="go">                           trust: ultimate      validity: ultimate</span>
<span class="go">sub  2048R/0x1F215B56867C5D9A  created: 2016-07-07  expires: 2017-02-02  usage: E</span>
<span class="go">sub  2048R/0xC0224DB5F541FB68  created: 2016-07-07  expires: never       usage: S</span>
<span class="go">[ultimate] (1). OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>

<span class="go">gpg&gt; save</span>
</pre></div>
</div>
<p>Now send the master key to the keyserver network. The subkeys are
all submitted along with it, so do not need to be specified
separately:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir signing.gnupg --send-keys 0x120D3C23C6D5584D
<span class="go">sending key 0x120D3C23C6D5584D to hkps server hkps.pool.sks-keyservers.net</span>
</pre></div>
</div>
<p>The rest of this process shouldn&#8217;t happen until we&#8217;re ready for the
signing system to transition to our new key. In a typical,
non-emergency rotation this should not happen until release
activities for the previous cycle have concluded so that we don&#8217;t
inadvertently sign their artifacts with the new key.</p>
<p>Create a new GnuPG keychain by exporting a copy of just the signing
subkey to a file and then importing that (and only that) in a new
GnuPG directory:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> <span class="nb">umask</span> <span class="m">077</span>
<span class="gp">root@puppetmaster:~#</span> mkdir temporary.gnupg
<span class="gp">root@puppetmaster:~#</span> gpg --homedir signing.gnupg --output <span class="se">\</span>
&gt; temporary.gnupg/secret-subkeys --export-secret-subkeys 0xC0224DB5F541FB68<span class="se">\!</span>
<span class="gp">root@puppetmaster:~#</span> gpg --homedir temporary.gnupg --import <span class="se">\</span>
&gt; temporary.gnupg/secret-subkeys
<span class="go">gpg: keyring `temporary.gnupg/secring.gpg&#39; created</span>
<span class="go">gpg: keyring `temporary.gnupg/pubring.gpg&#39; created</span>
<span class="go">gpg: key C6D5584D: secret key imported</span>
<span class="go">gpg: temporary.gnupg/trustdb.gpg: trustdb created</span>
<span class="go">gpg: key C6D5584D: public key &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot; imported</span>
<span class="go">gpg: Total number processed: 1</span>
<span class="go">gpg:               imported: 1  (RSA: 1)</span>
<span class="go">gpg:       secret keys read: 1</span>
<span class="go">gpg:   secret keys imported: 1</span>
</pre></div>
</div>
<p>Check that the exported version does not contain a usable primary
secret key by listing all secret keys and looking for a <cite>sec#</cite> in
front of it instead of just <cite>sec</cite>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir temporary.gnupg --list-secret-keys
<span class="go">temporary.gnupg/secring.gpg</span>
<span class="go">---------------------------</span>
<span class="go">sec#  2048R/C6D5584D 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">uid                  OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>
<span class="go">ssb   2048R/F541FB68 2016-07-07</span>
</pre></div>
</div>
<p>So that our CI jobs will be able to make use of this subkey without
interactively supplying a passphrase, the old passphrase (exported
from the master key) must be reset to an empty string in the new
temporary copy. This is again done using an interactive key editor
session:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> gpg --homedir temporary.gnupg --edit-key 0xC0224DB5F541FB68
<span class="go">gpg (GnuPG) 1.4.16; Copyright (C) 2013 Free Software Foundation, Inc.</span>
<span class="go">This is free software: you are free to change and redistribute it.</span>
<span class="go">There is NO WARRANTY, to the extent permitted by law.</span>

<span class="go">Secret key is available.</span>

<span class="go">pub  2048R/C6D5584D  created: 2016-07-07  expires: 2017-02-02  usage: SC</span>
<span class="go">                 trust: unknown       validity: unknown</span>
<span class="go">sub  2048R/F541FB68  created: 2016-07-07  expires: never       usage: S</span>
<span class="go">[ unknown] (1). OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>

<span class="go">gpg&gt; passwd</span>
<span class="go">Secret parts of primary key are not available.</span>

<span class="go">You need a passphrase to unlock the secret key for</span>
<span class="go">user: &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot;</span>
<span class="go">2048-bit RSA key, ID F541FB68, created 2016-07-07</span>

<span class="go">Enter passphrase: ********************************</span>

<span class="go">Enter the new passphrase for this secret key.</span>

<span class="go">Enter passphrase:</span>
<span class="go">Repeat passphrase:</span>

<span class="go">You don&#39;t want a passphrase - this is probably a *bad* idea!</span>

<span class="go">Do you really want to do this? (y/N) y</span>

<span class="go">gpg&gt; save</span>
</pre></div>
</div>
<p>This leaves us with a temporary keyring containing only an
unencrypted copy of the signing subkey. Push this into private hiera
so that it will be installed onto the signing system by our
configuration management:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> /opt/system-config/production/tools/hieraedit.py --yaml <span class="se">\</span>
&gt; /etc/puppet/hieradata/production/group/signing.yaml -f <span class="se">\</span>
&gt; temporary.gnupg/pubring.gpg pubring
<span class="gp">root@puppetmaster:~#</span> /opt/system-config/production/tools/hieraedit.py --yaml <span class="se">\</span>
&gt; /etc/puppet/hieradata/production/group/signing.yaml -f <span class="se">\</span>
&gt; temporary.gnupg/secring.gpg secring
</pre></div>
</div>
<p>Safely clean up, doing your best to securely remove the temporary
copy of the unencrypted signing subkey and any associated files:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> shred temporary.gnupg/*
<span class="gp">root@puppetmaster:~#</span> rm -rf temporary.gnupg
</pre></div>
</div>
<p>Finally, commit the hiera alterations:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> <span class="nb">echo</span> -e <span class="s2">&quot;Updated signing key to Some cycle\n-me&quot;</span> <span class="p">|</span> git <span class="se">\</span>
&gt; --git-dir /etc/puppet/hieradata/.git --work-tree /etc/puppet/hieradata <span class="se">\</span>
&gt; commit -F - production/group/signing.yaml
</pre></div>
</div>
<p>Once the key updates on signing01.ci.openstack.org, as the jenkins
user inspect the result. You should see the new cycle name and the
<cite>sec#</cite> here again indicating the primary secret key is unusable, and
if you try to sign some random data you shouldn&#8217;t be prompted for a
passphrase to use the signing subkey:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">jenkins@signing01:~$</span> gpg --homedir temporary.gnupg --list-secret-keys
<span class="go">temporary.gnupg/secring.gpg</span>
<span class="go">---------------------------</span>
<span class="go">sec#  2048R/C6D5584D 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">uid                  OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>
<span class="go">ssb   2048R/F541FB68 2016-07-07</span>

<span class="gp">jenkins@signing01:~$</span> <span class="nb">echo</span> foo <span class="p">|</span> gpg --sign --armor
<span class="go">-----BEGIN PGP MESSAGE-----</span>
<span class="go">Version: GnuPG v1</span>

<span class="go">owEBOgHF/pANAwACAbkGmxM1cAzcAcsKYgBYM654Zm9vCokBHAQAAQIABgUCWDOu</span>
<span class="go">eAAKCRC5BpsTNXAM3CC0CAC4Lc4DkTCvQpK0EXDZvYBbktYFslYyqbUcgSLqWFIC</span>
<span class="go">JxP5Zdz5G1gRABZ3NIfuerJczuy+Nd0ZBFrFEgw3JCzGYBydEyhlLJa1St64/JJy</span>
<span class="go">uOJY3IAKI5i9jBlt53+0FyKyNqifpk+Grmrqi8W+74bHpoNMnnfPWL2Llb2fz4bK</span>
<span class="go">DBlsATrCMj7IvgKpwNX2/IxFN5vqENd54v+J3jn/7Bxnf5UFLzowqOWjj1xaX3e0</span>
<span class="go">E2m4r6PMJoGQwFLyiPW0cjZJa22wSU2u2MjFjMMukpA+axgxGqLzDLYa1tmtJ6p3</span>
<span class="go">CMUalOq1Bxy5M4rU9VrffzNP9dSC38iYDm0BExxv3otM</span>
<span class="go">=i1wq</span>
<span class="go">-----END PGP MESSAGE-----</span>
</pre></div>
</div>
<p>To document this transition, export a minimal text version of the
public master key:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">root@puppetmaster:~#</span> <span class="o">(</span> gpg --fingerprint <span class="se">\</span>
&gt; 0x120d3c23c6d5584d6fc2464664dbb05acc5e7c28
<span class="gp">&gt;</span> gpg --armor --export-options export-clean,export-minimal <span class="se">\</span>
&gt; --export 0x120d3c23c6d5584d6fc2464664dbb05acc5e7c28 <span class="o">)</span> &gt; <span class="se">\</span>
&gt; 0x120d3c23c6d5584d6fc2464664dbb05acc5e7c28.txt
</pre></div>
</div>
<p>Add the file to a change for the <cite>openstack/releases</cite> repo placing
it in the <cite>doc/source/static</cite> directory, and then link it similarly
to other exported public keys are linked in the <cite>Cryptographic
Signatures
&lt;https://releases.openstack.org/#cryptographic-signatures&gt;</cite> section
of <cite>doc/source/index.rst</cite> (noting the appropriate end date for use of
the prior key as the start date for the new one).</p>
</div>
<div class="section" id="attestation">
<h3>Attestation<a class="headerlink" href="#attestation" title="Permalink to this headline">¶</a></h3>
<p>We need a majority (if not all) of our current root sysadmins to
verify and attest to the authenticity of our artifact signing key,
because it represents a system maintained by our team rather than
representing some particular individual and so anyone else attesting
to this key can really only do so transitively through us. This
should be done soon after a new key is minted (preferably the same
week) so that others in the community who wish to extend the web of
trust around the key based on our attestations (for example, release
managers or team leads) have an opportunity to do so before it&#8217;s put
into production.</p>
<p>Start by logging into the management bastion and examining the
fingerprint of the key as it exists on disk:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">me@puppetmaster:~$</span> sudo gpg --homedir /root/signing.gnupg --fingerprint <span class="se">\</span>
&gt; --list-keys <span class="s2">&quot;OpenStack Infra (Some Cycle)&quot;</span>
<span class="go">pub   2048R/0x120D3C23C6D5584D 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">      Key fingerprint = 120D 3C23 C6D5 584D 6FC2  4646 64DB B05A CC5E 7C28</span>
<span class="go">uid                 [ultimate] OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>
<span class="go">sub   2048R/0x1F215B56867C5D9A 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">sub   2048R/0xC0224DB5F541FB68 2016-07-07</span>
</pre></div>
</div>
<p>Now on your own system where your OpenPGP key resides, retrieve the
key, compare the fingerprint from above, and if they match, sign it
and push the signature back to the keyserver network:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span></span><span class="gp">me@home:~$</span> gpg2 --recv-keys 0x120D3C23C6D5584D
<span class="go">gpg: requesting key 0x120D3C23C6D5584D from hkps server hkps.pool.sks-keyservers.net</span>
<span class="go">gpg: key 0x120D3C23C6D5584D: public key &quot;OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;&quot; imported</span>
<span class="go">gpg: 3 marginal(s) needed, 1 complete(s) needed, classic trust model</span>
<span class="go">gpg: depth: 0  valid:   3  signed:  31  trust: 0-, 0q, 0n, 0m, 0f, 3u</span>
<span class="go">gpg: depth: 1  valid:  31  signed:  46  trust: 30-, 0q, 0n, 0m, 1f, 0u</span>
<span class="go">gpg: next trustdb check due at 2016-11-30</span>
<span class="go">gpg: Total number processed: 1</span>
<span class="go">gpg:               imported: 1  (RSA: 1)</span>
<span class="gp">me@home:~$</span> gpg2 --fingerprint 0x120D3C23C6D5584D
<span class="go">pub   2048R/0x120D3C23C6D5584D 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">      Key fingerprint = 120D 3C23 C6D5 584D 6FC2  4646 64DB B05A CC5E 7C28</span>
<span class="go">uid                 [  full  ] OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>
<span class="go">sub   2048R/0x1F215B56867C5D9A 2016-07-07 [expires: 2017-02-02]</span>
<span class="go">sub   2048R/0xC0224DB5F541FB68 2016-07-07</span>
<span class="gp">me@home:~$</span> gpg2 --sign-key 0x120D3C23C6D5584D

<span class="go">pub  2048R/0x120D3C23C6D5584D  created: 2016-07-07  expires: 2017-02-02  usage: SC</span>
<span class="go">                               trust: unknown       validity: full</span>
<span class="go">sub  2048R/0x1F215B56867C5D9A  created: 2016-07-07  expires: 2017-02-02  usage: E</span>
<span class="go">sub  2048R/0xC0224DB5F541FB68  created: 2016-07-07  expires: never       usage: S</span>
<span class="go">[  full  ] (1). OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>


<span class="go">pub  2048R/0x120D3C23C6D5584D  created: 2016-07-07  expires: 2017-02-02  usage: SC</span>
<span class="go">                               trust: unknown       validity: full</span>
<span class="go"> Primary key fingerprint: 120D 3C23 C6D5 584D 6FC2  4646 64DB B05A CC5E 7C28</span>

<span class="go">     OpenStack Infra (Some Cycle) &lt;infra-root@openstack.org&gt;</span>

<span class="go">This key is due to expire on 2017-02-02.</span>
<span class="go">Are you sure that you want to sign this key with your</span>
<span class="go">key &quot;My Name &lt;me@example.org&gt;&quot; (0xAB54A98CEB1F0AD2)</span>

<span class="go">Really sign? (y/N) y</span>

<span class="go">   +-----------------------------------------------------------------------+</span>
<span class="go">   | Please enter the passphrase to unlock the secret key for the OpenPGP  |</span>
<span class="go">   | certificate:                                                          |</span>
<span class="go">   | &quot;My Name &lt;me@example.org&gt;&quot;                                            |</span>
<span class="go">   | 2048-bit RSA key, ID 0xAB54A98CEB1F0AD2,                              |</span>
<span class="go">   | created 2008-09-10.                                                   |</span>
<span class="go">   |                                                                       |</span>
<span class="go">   |                                                                       |</span>
<span class="go">   | Passphrase **********************____________________________________ |</span>
<span class="go">   |                                                                       |</span>
<span class="go">   |          &lt;OK&gt;                                         &lt;Cancel&gt;        |</span>
<span class="go">   +-----------------------------------------------------------------------+</span>

<span class="gp">me@home:~$</span> gpg2 --send-keys 0x120D3C23C6D5584D
<span class="go">gpg: sending key 0x120D3C23C6D5584D to hkps server hkps.pool.sks-keyservers.net</span>
</pre></div>
</div>
<p>Also, please retrieve a copy of the
<tt class="docutils literal"><span class="pre">/root/signing.gnupg/revoke.asc</span></tt> fallback revocation certificate
from the management bastion and keep it stashed somewhere secure,
for emergency use in the (hopefully very unlikely) event that our
OpenPGP master private key is completely lost to us (for example, if
we lose the file containing its decryption passphrase and all
backups thereof).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Signing System</a><ul>
<li><a class="reference internal" href="#at-a-glance">At a Glance</a></li>
<li><a class="reference internal" href="#key-management-overview">Key Management Overview</a><ul>
<li><a class="reference internal" href="#storage">Storage</a></li>
<li><a class="reference internal" href="#rotation">Rotation</a></li>
<li><a class="reference internal" href="#revocation">Revocation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-management-process">Key Management Process</a><ul>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#generation">Generation</a></li>
<li><a class="reference internal" href="#attestation">Attestation</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="codesearch.html"
                                  title="previous chapter">Code Search</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="firehose.html"
                                  title="next chapter">Firehose</a></p>
            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack-infra/system-config
"
                     rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/signing.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="firehose.html" title="Firehose"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="codesearch.html" title="Code Search"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">OpenStack Project Infrastructure 0.0.1.dev12076 documentation</a> &raquo;</li>
          <li><a href="systems.html" accesskey="U">Major Systems</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2012-2014, OpenStack Infastructure Team - see the <a href="https://git.openstack.org/cgit/openstack-infra/system-config/">system-config git repo</a> for details.
      Last updated on Mon Feb 13 23:40:08 2017, commit 91bca8d.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/OpenStack Project Infrastructure");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>